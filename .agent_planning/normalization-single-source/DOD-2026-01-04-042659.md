# Definition of Done: Radically Simplify Default Source Normalization
**Generated**: 2026-01-04-042659
**Plan**: PLAN-2026-01-04-042659.md
**Topic**: normalization-single-source

---

## Acceptance Criteria

### P0: DELETE Duplicate Normalization Systems
- [ ] File `src/editor/compiler/passes/pass0-materialize.ts` does not exist (deleted)
- [ ] File `src/editor/defaultSources/constProviders.ts` does not exist (deleted)
- [ ] File `src/editor/compiler/ir/defaultSources.ts` does not exist (deleted)
- [ ] `src/editor/compiler/compile.ts` does not import pass0Materialize
- [ ] `src/editor/compiler/compile.ts` does not call pass0Materialize()
- [ ] `src/editor/compiler/passes/pass1-normalize.ts` does not create DefaultSourceAttachment[]
- [ ] `src/editor/compiler/passes/pass1-normalize.ts` does not create constPool
- [ ] NormalizedPatch interface does not have `defaults` or `constPool` properties
- [ ] `src/editor/stores/DefaultSourceStore.ts` does not have `createDefaultAttachmentForSlot()` method
- [ ] `src/editor/stores/DefaultSourceStore.ts` does not have `createAttachmentWithProvider()` method
- [ ] `src/editor/stores/DefaultSourceStore.ts` does not have `rebuildAttachmentsFromBlocks()` method
- [ ] `src/editor/stores/DefaultSourceStore.ts` does not have `attachmentsByTarget` property
- [ ] `src/editor/defaultSources/allowlist.ts` does not import from constProviders.ts
- [ ] No compiler errors after deletions
- [ ] No broken imports (grep for deleted file names returns zero results)

### P1: COMPLETE GraphNormalizer Provider Mappings
- [ ] GraphNormalizer.selectProviderType() has mapping for `signal:bool` (if DSConstSignalBool block exists)
- [ ] GraphNormalizer.selectProviderType() has mapping for `signal:vec3` (if DSConstSignalVec3 block exists)
- [ ] GraphNormalizer.selectProviderType() has mapping for `scalar:bool` (if DSConstScalarBool block exists)
- [ ] GraphNormalizer.selectProviderType() has mapping for `scalar:color` (if DSConstScalarColor block exists)
- [ ] GraphNormalizer.selectProviderType() has mapping for `scalar:vec2` (if DSConstScalarVec2 block exists)
- [ ] All mappings from deleted pass0-materialize.ts are present in GraphNormalizer
- [ ] No type combination incorrectly falls back to DSConstSignalFloat
- [ ] Fallback logic verified as safe for unknown types

### P2: VERIFY Compiler Integration
- [ ] `compile.ts` receives normalized graph (not raw Patch) or correctly uses normalized graph
- [ ] `compile.ts` does not call any materialization passes (pass0 deleted)
- [ ] `pass1-normalize.ts` (or pass1-canonicalize.ts) has no defaultSource logic
- [ ] `pass1-normalize.ts` has no constPool logic
- [ ] PatchStore.getNormalizedGraph() correctly filters structural blocks
- [ ] No duplicate structural blocks created (verified via test)
- [ ] All unit tests pass (`just test`)
- [ ] All type checks pass (`just typecheck`)
- [ ] All lints pass (`just lint-fix`)
- [ ] E2E test: Create block with unwired input → exactly ONE provider block created
- [ ] E2E test: Provider block has correct type for world:domain combination
- [ ] E2E test: UI can still edit default values (DefaultSourceStore values work)

---

## Sprint Scope

**This sprint delivers**:
1. GraphNormalizer as SINGLE SOURCE OF TRUTH for structural block creation
2. Complete provider type mappings in GraphNormalizer
3. Clean compiler integration (no duplicate normalization)

**Deferred**:
- Rename pass1-normalize.ts → pass1-canonicalize.ts (P3/Low, cosmetic)
- Migration for old structural blocks with `ds_` prefix (P2/Medium, only if users report issues)
- Performance optimization of GraphNormalizer caching (P3/Low, optimize after correctness)

---

## Verification Commands

Run these to verify sprint completion:

```bash
# Files deleted
test ! -f src/editor/compiler/passes/pass0-materialize.ts && echo "✓ pass0-materialize deleted"
test ! -f src/editor/defaultSources/constProviders.ts && echo "✓ constProviders deleted"
test ! -f src/editor/compiler/ir/defaultSources.ts && echo "✓ ir/defaultSources deleted"

# No broken imports
! grep -r "pass0-materialize" src/ && echo "✓ No pass0-materialize imports"
! grep -r "constProviders" src/ && echo "✓ No constProviders imports"

# Full check passes
just check && echo "✓ All checks pass"

# No duplicate providers (manual E2E test in browser)
# 1. Create Circle block
# 2. Leave radius input unwired
# 3. Inspect normalized graph → should have exactly ONE DSConstSignalFloat provider
```

---

**End of Definition of Done**
