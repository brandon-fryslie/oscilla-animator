# Definition of Done: Default Source Normalization Simplification

**Generated**: 2026-01-04-042951
**Plan**: PLAN-2026-01-04-042951.md
**Topic**: normalization-single-source

---

## Sprint Scope

This sprint delivers:
1. **DELETE duplicate normalization systems** (3 files deleted, 2 files stripped)
2. **COMPLETE GraphNormalizer provider mappings** (all type combinations covered)
3. **VERIFY compiler integration** (compile.ts uses GraphNormalizer output directly)

Deferred: P3 items (rename pass1, comprehensive tests, documentation) - quality improvements for future sprint.

---

## Acceptance Criteria

### Deliverable 1: DELETE Duplicate Normalization Systems

#### P0-1: Delete pass0-materialize.ts
- [ ] File `src/editor/compiler/passes/pass0-materialize.ts` deleted from filesystem
- [ ] Import removed from `src/editor/compiler/compile.ts` (Line 30)
- [ ] Call `pass0Materialize(patch)` removed from compile.ts (Line 118)
- [ ] compile.ts passes patch directly to pass1 (Line 125)
- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] E2E test: Create Circle with unwired radius input → exactly ONE provider block created
- [ ] E2E test: Provider block ID follows format `${blockId}_default_${slotId}`

#### P0-2: Delete constProviders.ts
- [ ] File `src/editor/defaultSources/constProviders.ts` deleted from filesystem
- [ ] Grep confirms no imports of `CONST_PROVIDER_MAPPING` anywhere in codebase
- [ ] Grep confirms no imports of `DEFAULT_CONST_PROVIDER_BLOCKS` anywhere in codebase
- [ ] `just typecheck` passes
- [ ] `just test` passes

#### P0-3: Delete compiler/ir/defaultSources.ts
- [ ] File `src/editor/compiler/ir/defaultSources.ts` deleted from filesystem
- [ ] Grep confirms no imports of `DefaultSourceIR`, `DefaultSourceTable`, etc.
- [ ] `just typecheck` passes
- [ ] `just test` passes

#### P0-4: Simplify pass1-normalize.ts
- [ ] Lines 90-115 (defaultSource scanning loop) deleted
- [ ] `NormalizedPatch.defaults` property removed from interface
- [ ] `NormalizedPatch.constPool` property removed from interface
- [ ] Block ID freezing logic still present (Lines 76-82 retained)
- [ ] Edge canonicalization logic still present
- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] E2E test: Structural blocks come from GraphNormalizer, NOT pass1

#### P0-5: Strip DefaultSourceStore to Value Storage Only
- [ ] Method `createDefaultAttachmentForSlot()` deleted
- [ ] Method `createAttachmentWithProvider()` deleted
- [ ] Method `rebuildAttachmentsFromBlocks()` deleted
- [ ] Method `getAttachmentForInput()` deleted
- [ ] Method `setAttachmentForInput()` deleted
- [ ] Method `removeAttachmentForInput()` deleted
- [ ] Property `attachmentsByTarget: Map<string, DefaultSourceAttachment>` deleted
- [ ] No dependency on `CONST_PROVIDER_MAPPING` (grep confirms)
- [ ] Property `sources: Map<string, DefaultSourceState>` RETAINED
- [ ] Method `ensureDefaultSource()` RETAINED
- [ ] Method `setDefaultValue()` RETAINED
- [ ] Method `getDefaultSource()` RETAINED
- [ ] Method `getDefaultSourceForInput()` RETAINED
- [ ] Method `setDefaultValueForInput()` RETAINED
- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] E2E test: UI can edit default values via DefaultSourceStore
- [ ] E2E test: Edited values update GraphNormalizer's provider block params

---

### Deliverable 2: COMPLETE GraphNormalizer Provider Mappings

#### P1-1: Add Missing Provider Type Mappings
- [ ] Check `src/editor/blocks/default-source-providers.ts` for all DSConst* block types
- [ ] Add mapping for `signal:bool` if DSConstSignalBool exists
- [ ] Add mapping for `signal:vec3` if DSConstSignalVec3 exists
- [ ] Add mapping for `scalar:bool` if DSConstScalarBool exists
- [ ] Add mapping for `scalar:color` if DSConstScalarColor exists
- [ ] Add mapping for `scalar:vec2` if DSConstScalarVec2 exists
- [ ] Add mapping for `scalar:vec3` if DSConstScalarVec3 exists
- [ ] Add mapping for `scalar:cameraRef` if DSConstScalarCameraRef exists
- [ ] Grep confirms all world:domain combinations from pass0-materialize covered
- [ ] Unit test confirms all type combinations map to correct providers
- [ ] Unit test confirms no fallback to default provider for known types
- [ ] `just test` passes
- [ ] E2E test: All type combinations create correct provider blocks

#### P1-2: Verify GraphNormalizer ID Format is Canonical
- [ ] Grep confirms no usage of `ds_${blockId}_${inputId}` format in codebase
- [ ] JSDoc comment on `generateProviderId()` documents format as canonical
- [ ] Unit test confirms IDs are deterministic
- [ ] Unit test confirms IDs match format `${blockId}_default_${slotId}`
- [ ] `just test` passes
- [ ] E2E test: Provider IDs follow canonical format

#### P1-3: Update allowlist.ts
- [ ] Import of `DEFAULT_CONST_PROVIDER_BLOCKS` from constProviders.ts removed
- [ ] Const provider block types inlined directly in allowlist.ts
- [ ] Uses world:domain format (not string format like "Signal<float>")
- [ ] `just typecheck` passes
- [ ] `just test` passes

---

### Deliverable 3: VERIFY Compiler Integration

#### P2-1: Update compile.ts Integration
- [ ] Function signature: `compile(normalizedGraph: NormalizedGraph)` (not Patch)
- [ ] No import of `pass0-materialize` (grep confirms)
- [ ] No call to `pass0Materialize()` (grep confirms)
- [ ] Passes normalizedGraph directly to pass1 (no intermediate steps)
- [ ] Caller (PatchStore) passes result of `getNormalizedGraph()` to compile()
- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] E2E test: Compilation uses GraphNormalizer output directly

#### P2-2: Add PatchStore Migration (Delete Old Structural Blocks)
- [ ] Migration logic added to PatchStore (runs on load)
- [ ] Deletes blocks with `role.kind === 'structural'` from loaded patches
- [ ] Deletes edges with `role.kind === 'default'` from loaded patches
- [ ] GraphNormalizer recreates structural blocks after migration
- [ ] Unit test confirms old structural blocks removed on load
- [ ] Unit test confirms GraphNormalizer recreates blocks correctly
- [ ] E2E test: Load old patch with structural blocks → blocks deleted then recreated
- [ ] E2E test: No duplicate providers after migration
- [ ] `just test` passes

---

## Overall Success Criteria

### Zero Duplication
- [ ] GraphNormalizer is the ONLY system creating structural blocks+edges (grep confirms)
- [ ] No code path creates provider blocks except GraphNormalizer.normalize()
- [ ] No code path creates default source edges except GraphNormalizer.normalize()

### Type Safety
- [ ] All world:domain combinations have explicit provider mappings
- [ ] No type mismatches between provider output and input slot types
- [ ] Fallback provider only used for truly unknown types (none expected)

### Tests Pass
- [ ] `just typecheck` succeeds (zero TypeScript errors)
- [ ] `just test` succeeds (all unit tests pass)
- [ ] `just check` succeeds (typecheck + lint + test)
- [ ] All E2E scenarios verified via Chrome DevTools MCP (per CLAUDE.md Rule 3)

### Behavioral Verification
- [ ] E2E: Create patch with unwired inputs → providers created exactly once
- [ ] E2E: Edit default value in UI → value persists, provider block param updates
- [ ] E2E: Compile patch → structural blocks from GraphNormalizer, not duplicated
- [ ] E2E: Load old patch → old structural blocks deleted, new ones created
- [ ] E2E: Scrub timeline → default values stable (no re-randomization)

### Code Cleanliness
- [ ] Exactly 3 files deleted: pass0-materialize.ts, constProviders.ts, ir/defaultSources.ts
- [ ] Exactly 5 files modified: pass1-normalize.ts, DefaultSourceStore.ts, allowlist.ts, compile.ts, GraphNormalizer.ts
- [ ] Zero TODO comments added (per CLAUDE.md: "documented limitation is not a fix")
- [ ] Zero silent failures (per CLAUDE.md: "fail fast with actionable errors")

---

## Deferred Work

The following P3 items are deferred to future sprint (quality improvements, not blocking):

### P3-1: Rename pass1-normalize.ts to pass1-canonicalize.ts
- **Reason**: Cosmetic change, doesn't affect functionality
- **Priority**: P3 (Low)
- **Spec reference**: N/A

### P3-2: Add GraphNormalizer Unit Tests
- **Reason**: Time-constrained sprint, basic tests exist
- **Priority**: P3 (Low)
- **Spec reference**: N/A

### P3-3: Document GraphNormalizer as Canonical
- **Reason**: Code is self-documenting after deletions
- **Priority**: P3 (Low)
- **Spec reference**: N/A

---

## Verification Checklist

Before marking sprint complete:

### Static Verification
- [ ] Run `just typecheck` → zero errors
- [ ] Run `just test` → all pass
- [ ] Run `just lint-fix` → zero warnings
- [ ] Run `just check` → all pass
- [ ] Grep for `pass0Materialize` → zero results
- [ ] Grep for `CONST_PROVIDER_MAPPING` → zero results
- [ ] Grep for `DefaultSourceIR` → zero results
- [ ] Grep for structural block creation outside GraphNormalizer → zero results

### Dynamic Verification (via Chrome DevTools MCP)
1. Create new patch
2. Add Circle block (unwired radius input with defaultSource)
3. Verify exactly ONE provider block created
4. Verify provider block ID format: `circle_1_default_radius`
5. Verify provider block type: `DSConstSignalFloat` (for Signal<float>)
6. Edit default value in UI → verify provider block param updates
7. Scrub timeline → verify value stable
8. Save and reload patch → verify provider blocks recreated correctly
9. Load old patch with structural blocks → verify migration deletes then recreates
10. Compile patch → verify no duplicate providers in IR

### Regression Prevention
- [ ] All existing tests still pass
- [ ] No new TypeScript errors
- [ ] No new console warnings
- [ ] No behavioral changes except duplicate provider fix

---

**End of Definition of Done**
