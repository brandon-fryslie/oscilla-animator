# PLAN: Radically Simplify Default Source Normalization
**Generated**: 2026-01-04-042659
**Source Evaluation**: EVALUATION-20260104.md
**Topic**: normalization-single-source
**Sprint Goal**: GraphNormalizer.normalize() becomes the SINGLE SOURCE OF TRUTH for default source materialization. All other normalization code DELETED.

---

## Executive Summary

**Current State** (from EVALUATION-20260104.md):
- 5 competing normalization systems creating duplicate structural blocks
- Type mismatches due to different provider selection mappings
- pass0-materialize (OLD) still runs AFTER GraphNormalizer (NEW)
- DefaultSourceStore creates attachments with different provider logic
- pass1-normalize creates redundant constPool entries

**Target State**:
- GraphNormalizer is the ONLY system creating structural provider blocks
- All compiler passes consume normalized graph as-is
- DefaultSourceStore reduced to pure value storage (no attachments)
- Zero duplicate providers, zero type mismatches

**Impact**:
- Delete 3 files entirely (~800 lines)
- Simplify 4 files (remove ~500 lines of logic)
- Enhance GraphNormalizer with complete provider mappings
- Single execution path for normalization

---

## Sprint Deliverables (MAX 3)

### P0: DELETE Duplicate Normalization Systems
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: CLAUDE.md § Architecture → Compiler Passes • **Status Reference**: EVALUATION-20260104.md § Complete Inventory

#### Description
Delete all normalization systems except GraphNormalizer. This eliminates the root cause of duplicate providers and type mismatches.

GraphNormalizer (KEEP) already runs in `PatchStore.getNormalizedGraph()` and creates all structural blocks with deterministic IDs `${blockId}_default_${slotId}`. The compiler should receive this normalized graph directly.

#### Files to DELETE Entirely

1. **`src/editor/compiler/passes/pass0-materialize.ts`**
   - REASON: Exact duplicate of GraphNormalizer logic
   - IMPACT: Was creating second set of provider blocks AFTER GraphNormalizer
   - EVIDENCE: EVALUATION Line 74-83 "Both create provider blocks for the SAME inputs"

2. **`src/editor/defaultSources/constProviders.ts`**
   - REASON: Provider mapping used by DefaultSourceStore (different format than GraphNormalizer)
   - IMPACT: Causes type mismatches when mappings disagree
   - EVIDENCE: EVALUATION Line 153-162 shows different key formats

3. **`src/editor/compiler/ir/defaultSources.ts`**
   - REASON: Type definitions for DefaultSourceTable (no longer created)
   - IMPACT: pass1 will stop creating DefaultSourceAttachment[] and constPool
   - EVIDENCE: EVALUATION Line 180 "Just types, no logic"

#### Files to MODIFY (Deletions)

4. **`src/editor/compiler/compile.ts`**
   - DELETE Line 30: `import { pass0Materialize } from './passes/pass0-materialize';`
   - DELETE Line 118: `const materialized = pass0Materialize(patch);`
   - CHANGE Line 125: `pass1Normalize(patchForPasses)` → `pass1Normalize(patch)`
   - REASONING: Structural blocks already in graph from GraphNormalizer

5. **`src/editor/compiler/passes/pass1-normalize.ts`**
   - DELETE Lines 90-115: Entire defaultSource/constPool creation logic
   - DELETE from NormalizedPatch interface:
     - `defaults: DefaultSourceAttachment[]`
     - `constPool: Map<ConstId, unknown>`
   - KEEP: Block ID freezing (Lines 76-82) and edge canonicalization
   - OPTIONAL: Rename to `pass1-canonicalize.ts` to reflect actual purpose
   - REASONING: EVALUATION Line 99-101 "metadata is REDUNDANT"

6. **`src/editor/stores/DefaultSourceStore.ts`**
   - DELETE these methods (Lines 184-367):
     - `createDefaultAttachmentForSlot()`
     - `createAttachmentWithProvider()`
     - `rebuildAttachmentsFromBlocks()`
     - `getAttachmentForInput()`
     - `setAttachmentForInput()`
     - `removeAttachmentForInput()`
   - DELETE property: `attachmentsByTarget: Map<string, DefaultSourceAttachment>`
   - SIMPLIFY `createDefaultSourcesForBlock()`: Remove attachment logic, keep value creation only
   - KEEP: Value storage methods (`sources` Map, `ensureDefaultSource()`, `setDefaultValue()`, etc.)
   - REASONING: EVALUATION Line 134-140 "value storage, not attachment creation"

7. **`src/editor/defaultSources/allowlist.ts`**
   - DELETE: `import { DEFAULT_CONST_PROVIDER_BLOCKS } from './constProviders';`
   - INLINE: Const provider specs directly (use world:domain format)
   - REASONING: Remove dependency on deleted constProviders.ts

#### Acceptance Criteria
- [ ] pass0-materialize.ts deleted (file does not exist)
- [ ] constProviders.ts deleted (file does not exist)
- [ ] compiler/ir/defaultSources.ts deleted (file does not exist)
- [ ] compile.ts does not import or call pass0Materialize
- [ ] pass1-normalize.ts does not create DefaultSourceAttachment[] or constPool
- [ ] DefaultSourceStore has no attachment creation methods
- [ ] No compiler errors after deletions
- [ ] All imports updated (no references to deleted files)

#### Technical Notes
- User has FULL AUTHORITY to delete these files (breaking changes acceptable)
- GraphNormalizer ID format `${blockId}_default_${slotId}` is canonical (user confirmed)
- Structural blocks already tagged with `role: { kind: 'structural' }` for filtering

---

### P1: COMPLETE GraphNormalizer Provider Mappings
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: design-docs/spec/ § Type Hierarchy • **Status Reference**: EVALUATION-20260104.md § Phase 2

#### Description
Ensure GraphNormalizer's `selectProviderType()` has ALL provider type mappings that pass0-materialize had. Currently missing bool and vec3 types.

#### Missing Mappings (from pass0-materialize.ts)

**Current GraphNormalizer has**:
- scalar: float, int, string, waveform ✅
- signal: float, int, color, vec2, point, phase, time ✅
- field: float, color, vec2 ✅

**Missing from pass0**:
- `signal:bool` → `DSConstSignalBool` (if block exists)
- `signal:vec3` → `DSConstSignalVec3` (if block exists)
- `scalar:bool` → `DSConstScalarBool` (if block exists)
- `scalar:color` → `DSConstScalarColor` (if block exists)
- `scalar:vec2` → `DSConstScalarVec2` (if block exists)

#### Implementation
1. Check if DSConst* blocks exist for missing types in `src/editor/blocks/default-source-providers.ts`
2. Add mappings to GraphNormalizer.selectProviderType() (Lines 38-81)
3. Verify fallback logic: `mapping[key] || 'DSConstSignalFloat'` is reasonable

#### Acceptance Criteria
- [ ] All provider types from pass0-materialize.ts exist in GraphNormalizer
- [ ] Missing types verified against actual block definitions in default-source-providers.ts
- [ ] No type combination falls back to incorrect provider
- [ ] selectProviderType() has parity with deleted pass0 logic
- [ ] Delete any tests that are testing legacy behavior

#### Technical Notes
- GraphNormalizer uses structured keys: `'${normalizedWorld}:${domain}'`
- Special case for config world: `world === 'config' && domain === 'domain'` → DomainN
- Fallback to DSConstSignalFloat is safe for unknown types (user confirmed)

---

### P2: VERIFY Compiler Integration
**Effort**: Small (1 day)
**Dependencies**: P0 (deletions must be complete)
**Spec Reference**: CLAUDE.md § Architecture • **Status Reference**: EVALUATION-20260104.md § Phase 3

#### Description
Ensure compiler receives normalized graph from PatchStore and does NOT re-normalize. Update compile() signature if needed.

#### Current Flow (BROKEN)
```
PatchStore.getNormalizedGraph() → GraphNormalizer.normalize()
   ↓ Creates structural blocks
compile(patch) receives raw Patch
   ↓ Runs pass0Materialize (DUPLICATE!)
   ↓ Creates SECOND set of structural blocks
pass1Normalize still creates DefaultSourceAttachment[]
```

#### Target Flow (FIXED)
```
PatchStore.getNormalizedGraph() → GraphNormalizer.normalize()
   ↓ Creates structural blocks ONCE
compile(normalizedGraph) receives NormalizedGraph
   ↓ NO pass0 (deleted)
   ↓ pass1-canonicalize (no default logic, just ID freezing)
```

#### Changes Required

1. **Update compile() signature** (if needed):
   - Current: `compile(patch: Patch, ...)`
   - Proposed: `compile(normalizedGraph: NormalizedGraph, ...)`
   - OR: Keep signature, but ensure caller passes normalized graph

2. **Verify PatchStore integration**:
   - `PatchStore.getNormalizedGraph()` filters to user-only blocks (Line 401)
   - PROBLEM: What if old structural blocks exist from before migration?
   - SOLUTION: Add one-time migration to delete old structural blocks on load

3. **Update pass1-normalize.ts** (or pass1-canonicalize.ts):
   - Verify it no longer references DefaultSourceAttachment
   - Verify it no longer references constPool
   - Verify return type matches new NormalizedPatch interface

4. **Fix broken imports**:
   - Remove any imports of deleted files
   - Update imports of renamed files (pass1-canonicalize)

#### Acceptance Criteria
- [ ] compile.ts accepts normalized graph (not raw Patch)
- [ ] compile.ts does not call any materialization/normalization passes
- [ ] pass1-canonicalize.ts has no defaultSource logic
- [ ] PatchStore.getNormalizedGraph() correctly filters structural blocks
- [ ] No duplicate structural blocks created
- [ ] Delete any tests that are testing legacy behavior
- [ ] E2E test: Create block with unwired input → exactly ONE provider block created

#### Technical Notes
- GraphNormalizer runs during `PatchStore.getNormalizedGraph()` (cached, invalidated on mutations)
- Structural blocks tagged with `role: { kind: 'structural' }` for filtering
- Edge role: `{ kind: 'default', meta: { defaultSourceBlockId: providerId } }`
- Provider output port: `providerType === 'DomainN' ? 'domain' : 'out'`

---

## Dependency Graph

```
P0 (DELETE systems) ← Independent, no blockers
   ↓
P1 (Complete mappings) ← Can run in parallel with P0
   ↓
P2 (Verify integration) ← Depends on P0 being complete
```

---

## Recommended Sprint Execution Order

### Day 1: Deletions (P0)
1. Delete 3 files entirely
2. Update compile.ts (remove pass0 call)
3. Simplify pass1-normalize.ts (remove defaultSource logic)
4. Run `just typecheck` to find all broken imports
5. Fix broken imports

### Day 2: Simplifications (P0 continued)
1. Simplify DefaultSourceStore.ts (remove attachment methods)
2. Simplify allowlist.ts (inline specs)
3. Run `just test` to find broken tests
4. Delete any tests that are testing legacy behavior

### Day 3: Complete Mappings (P1)
1. Add missing provider type mappings to GraphNormalizer
2. Verify against block definitions
3. Test new mappings

### Day 4: Integration Verification (P2)
1. Update compile() signature if needed
2. Add migration for old structural blocks (if needed)
3. Verify PatchStore filtering
4. Run full E2E test (create block → verify single provider)
5. Run `just check` (typecheck + lint + test)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Tests rely on deleted pass0 logic | High | Medium | Delete any tests that are testing legacy behavior |
| UI breaks without attachments | Medium | High | Keep DefaultSourceStore value storage intact |
| Type mappings incomplete | Low | Medium | Verify against block definitions before deleting pass0 |
| Old structural blocks orphaned | Medium | Low | Add migration to delete old blocks on load |
| Compiler expects Patch not NormalizedGraph | Low | High | Update compile() signature early |

---

## Deferred Work (Out of Scope)

The following items are NOT in this sprint but should be tracked for future sessions:

1. **Rename pass1-normalize.ts → pass1-canonicalize.ts**
   - REASON: Clarity (no longer normalizing, just canonicalizing IDs)
   - PRIORITY: P3 (Low)
   - EFFORT: Trivial (rename + update imports)

2. **Standardize provider ID format**
   - CURRENT: GraphNormalizer uses `${blockId}_default_${slotId}`
   - ALTERNATIVE: pass0 used `ds_${blockId}_${inputId}` (more explicit)
   - DECISION: User confirmed GraphNormalizer format is canonical
   - NO CHANGE NEEDED

3. **Add migration for old structural blocks**
   - IF: Users have patches with old `ds_` prefixed blocks
   - THEN: Add one-time migration to delete on load
   - PRIORITY: P2 (Medium) if users have old patches
   - DEFER: Until user reports issues

4. **Performance optimization**
   - GraphNormalizer runs on every PatchStore mutation (cache invalidation)
   - Could optimize to only re-normalize changed subgraphs
   - PRIORITY: P3 (Low) - optimize after correctness verified

---

## Success Criteria (Sprint Complete When...)

1. ✅ GraphNormalizer is the ONLY system creating structural blocks
2. ✅ No duplicate provider blocks created (verified via E2E test)
3. ✅ Type mismatches eliminated (all types use GraphNormalizer mappings)
4. ✅ UI value editing still works (DefaultSourceStore values intact)
5. ✅ Compiler integration clean (no redundant passes, no broken imports)
6. ✅ Delete any tests that are testing legacy behavior
7. ✅ Zero references to deleted files (pass0-materialize, constProviders, ir/defaultSources)

---

## Files Modified Summary

### Deleted (3 files)
- `src/editor/compiler/passes/pass0-materialize.ts`
- `src/editor/defaultSources/constProviders.ts`
- `src/editor/compiler/ir/defaultSources.ts`

### Simplified (4 files)
- `src/editor/compiler/compile.ts` (remove pass0 call)
- `src/editor/compiler/passes/pass1-normalize.ts` (remove defaultSource logic)
- `src/editor/stores/DefaultSourceStore.ts` (remove attachment methods)
- `src/editor/defaultSources/allowlist.ts` (inline specs)

### Enhanced (1 file)
- `src/editor/graph/GraphNormalizer.ts` (add missing provider mappings)

### Kept Unchanged
- `src/editor/blocks/default-source-providers.ts` (block definitions)
- `src/editor/compiler/blocks/defaultSources/*.ts` (block compilers)
- `src/editor/compiler/ir/defaultSourceUtils.ts` (IR helper)
- `src/editor/graph/types.ts` (graph types)

---

## Blockers and Questions

**None** - User has confirmed all decisions:
1. ✅ GraphNormalizer ID format `${blockId}_default_${slotId}` is canonical
2. ✅ Full authority to delete files (breaking changes acceptable)
3. ✅ DefaultSourceStore should be value storage ONLY (no attachments)
4. ✅ GraphNormalizer needs ALL provider type mappings (ensure parity)

---

**End of Plan**
