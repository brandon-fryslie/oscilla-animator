# Plan: Radical Default Source Normalization Simplification

**Generated**: 2026-01-04-042951
**Source**: EVALUATION-20260104.md
**Topic**: normalization-single-source

---

## Executive Summary

**Current State**: 5 competing normalization systems creating duplicate provider blocks with inconsistent type selection, causing type mismatches and architectural chaos.

**Target State**: GraphNormalizer.normalize() is the SINGLE SOURCE OF TRUTH for default source materialization. All other normalization deleted.

**Total Gap**: 3 files to delete entirely, 5 files to simplify, 1 file to enhance.

**Strategy**: Radical deletion. User has granted FULL AUTHORITY to delete code and accept breaking changes.

---

## Sprint Goal

GraphNormalizer becomes the canonical, exclusive system for default source normalization. Zero duplication.

---

## Backlog by Priority

### P0 (Critical) - Delete Duplicate Normalization Systems

---

## P0-1: Delete pass0-materialize.ts Entirely

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: 04-compilation.md • **Status Reference**: EVALUATION-20260104.md Lines 60-84

### Description
Delete `src/editor/compiler/passes/pass0-materialize.ts` completely. This file is a 100% duplicate of GraphNormalizer's functionality, creating provider blocks during compilation AFTER GraphNormalizer already created them in PatchStore. This causes duplicate providers for the same inputs.

### Acceptance Criteria
- [ ] File `src/editor/compiler/passes/pass0-materialize.ts` deleted
- [ ] Import in `src/editor/compiler/compile.ts` Line 30 removed
- [ ] Call to `pass0Materialize(patch)` in compile.ts Line 118 removed
- [ ] compile.ts passes patch directly to pass1 (Line 125 updated)
- [ ] Delete any tests that are testing legacy behavior
- [ ] E2E test confirms providers created exactly once per input

### Technical Notes
- GraphNormalizer runs in PatchStore.getNormalizedGraph() BEFORE compilation
- pass0 was running DURING compilation, creating duplicates
- Deletion is safe because GraphNormalizer already does this work

---

## P0-2: Delete constProviders.ts Entirely

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: 01-type-system.md • **Status Reference**: EVALUATION-20260104.md Lines 144-165

### Description
Delete `src/editor/defaultSources/constProviders.ts`. This file exports `CONST_PROVIDER_MAPPING` with string-based keys (e.g., "Signal<float>") that conflict with GraphNormalizer's structured world:domain format (e.g., "signal:float"). This is the ROOT CAUSE of type mismatches.

### Acceptance Criteria
- [ ] File `src/editor/defaultSources/constProviders.ts` deleted
- [ ] No remaining imports of `CONST_PROVIDER_MAPPING` anywhere
- [ ] `allowlist.ts` updated to inline provider specs (see P1-3)
- [ ] Delete any tests that are testing legacy behavior
- [ ] E2E test confirms provider types match GraphNormalizer's selection

### Technical Notes
- GraphNormalizer uses world:domain structured keys ("signal:float")
- constProviders.ts used string keys ("Signal<float>")
- Different key formats caused different provider types to be selected
- GraphNormalizer's mapping is the source of truth

---

## P0-3: Delete compiler/ir/defaultSources.ts

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: P0-4 (pass1 no longer creates DefaultSourceTable)
**Spec Reference**: 04-compilation.md • **Status Reference**: EVALUATION-20260104.md Lines 177-181

### Description
Delete `src/editor/compiler/ir/defaultSources.ts`. This file defines types for `DefaultSourceIR` table that pass1 no longer creates. With pass1 simplified to just canonicalization, these types are unused.

### Acceptance Criteria
- [ ] File `src/editor/compiler/ir/defaultSources.ts` deleted
- [ ] No remaining imports of `DefaultSourceIR`, `DefaultSourceTable`, etc.
- [ ] TypeScript compilation succeeds
- [ ] Delete any tests that are testing legacy behavior

### Technical Notes
- This file only contains type definitions, no logic
- Only used by pass1-normalize which we're simplifying
- Safe to delete once pass1 stops creating DefaultSourceTable

---

## P0-4: Simplify pass1-normalize.ts (Remove Default Source Logic)

**Status**: Not Started
**Effort**: Medium (3 days)
**Dependencies**: None
**Spec Reference**: 04-compilation.md • **Status Reference**: EVALUATION-20260104.md Lines 87-107

### Description
Remove ALL default source and constPool logic from `src/editor/compiler/passes/pass1-normalize.ts`. This pass should ONLY do block ID freezing and edge canonicalization. GraphNormalizer already created the structural blocks, so pass1 doesn't need to scan for defaults.

Delete Lines 90-115 (entire defaultSource scanning loop). Remove `defaults` and `constPool` from `NormalizedPatch` return type.

Optional: Rename to `pass1-canonicalize.ts` to reflect actual purpose.

### Acceptance Criteria
- [ ] Lines 90-115 deleted (defaultSource scanning loop)
- [ ] `NormalizedPatch.defaults` removed from return type
- [ ] `NormalizedPatch.constPool` removed from return type
- [ ] Pass still performs block ID freezing (Lines 76-82)
- [ ] Pass still canonicalizes edges
- [ ] Delete any tests that are testing legacy behavior
- [ ] E2E test confirms structural blocks come from GraphNormalizer only

### Technical Notes
- Block ID freezing maps block IDs to BlockIndex for IR
- Edge canonicalization deduplicates edges
- These are legitimate pass1 responsibilities
- Default source handling is NOT

---

## P0-5: Strip DefaultSourceStore to Value Storage Only

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None
**Spec Reference**: N/A (store implementation) • **Status Reference**: EVALUATION-20260104.md Lines 110-141

### Description
Remove ALL attachment creation logic from `src/editor/stores/DefaultSourceStore.ts`. GraphNormalizer creates structural blocks+edges. DefaultSourceStore should ONLY store editable values for the UI.

Delete methods: `createDefaultAttachmentForSlot()`, `createAttachmentWithProvider()`, `rebuildAttachmentsFromBlocks()`, `getAttachmentForInput()`, `setAttachmentForInput()`, `removeAttachmentForInput()`.

Delete property: `attachmentsByTarget: Map<string, DefaultSourceAttachment>`.

Keep: `sources` Map, `ensureDefaultSource()`, `setDefaultValue()`, `getDefaultSource()`, value getters/setters.

### Acceptance Criteria
- [ ] All attachment creation methods deleted (6 methods)
- [ ] `attachmentsByTarget` Map deleted
- [ ] No dependency on `CONST_PROVIDER_MAPPING`
- [ ] `sources` Map kept for value storage
- [ ] Value getters/setters still work
- [ ] UI can still edit default values
- [ ] Delete any tests that are testing legacy behavior
- [ ] E2E test confirms UI edits update GraphNormalizer's provider block params

### Technical Notes
- UI needs to edit default values, but not create structure
- GraphNormalizer creates blocks, DefaultSourceStore stores their param values
- Separation of concerns: structure (GraphNormalizer) vs. values (DefaultSourceStore)

---

### P1 (High) - Complete GraphNormalizer

---

## P1-1: Add Missing Provider Type Mappings

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: 01-type-system.md • **Status Reference**: EVALUATION-20260104.md Lines 336-348

### Description
GraphNormalizer's `selectProviderType()` is missing some type combinations that pass0-materialize had. Add ALL missing provider types to ensure parity.

Current mappings cover: scalar (float, int, string, waveform), signal (float, int, color, vec2, point, phase, time), field (float, color, vec2).

Missing: signal:bool, signal:vec3, scalar:bool, scalar:color, scalar:vec2, scalar:vec3, scalar:cameraRef.

Verify corresponding DSConst* block types exist before adding.

### Acceptance Criteria
- [ ] signal:bool mapping added (if DSConstSignalBool exists)
- [ ] signal:vec3 mapping added (if DSConstSignalVec3 exists)
- [ ] scalar:bool mapping added (if DSConstScalarBool exists)
- [ ] scalar:color mapping added (if DSConstScalarColor exists)
- [ ] scalar:vec2 mapping added (if DSConstScalarVec2 exists)
- [ ] All type combinations from pass0-materialize covered
- [ ] Unit test confirms all type combinations map to correct providers
- [ ] E2E test confirms no fallback to default provider

### Technical Notes
- Check `src/editor/blocks/default-source-providers.ts` for available block types
- If block type doesn't exist, document as limitation (don't add mapping)
- Fallback to 'DSConstSignalFloat' should be rare, ideally never

---

## P1-2: Verify GraphNormalizer ID Format is Canonical

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: N/A (implementation detail) • **Status Reference**: EVALUATION-20260104.md Lines 350-370

### Description
User has confirmed GraphNormalizer's ID format is canonical: `${blockId}_default_${slotId}`. Verify no other code uses pass0's format (`ds_${blockId}_${inputId}`). Document as authoritative.

### Acceptance Criteria
- [ ] Grep confirms no usage of `ds_${blockId}_${inputId}` format
- [ ] GraphNormalizer's `generateProviderId()` format documented as canonical
- [ ] Unit test confirms IDs are deterministic and match format
- [ ] E2E test confirms provider IDs follow canonical format

### Technical Notes
- GraphNormalizer uses: `${blockId}_default_${slotId}`
- pass0 used: `ds_${blockId}_${inputId}`
- User confirmed GraphNormalizer's format is correct

---

## P1-3: Update allowlist.ts (Remove constProviders Dependency)

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P0-2 (constProviders.ts deleted)
**Spec Reference**: N/A • **Status Reference**: EVALUATION-20260104.md Lines 195-199

### Description
Update `src/editor/defaultSources/allowlist.ts` to remove import of `DEFAULT_CONST_PROVIDER_BLOCKS` from constProviders.ts. Inline the const provider block types directly, using world:domain format instead of string format.

### Acceptance Criteria
- [ ] Import of `DEFAULT_CONST_PROVIDER_BLOCKS` removed
- [ ] Const provider block types inlined in allowlist.ts
- [ ] Uses world:domain format (not string format)
- [ ] Delete any tests that are testing legacy behavior
- [ ] No TypeScript errors

### Technical Notes
- allowlist.ts defines which blocks can be default source providers
- Currently imports from constProviders.ts (being deleted)
- Need to inline the list of DSConst* block types

---

### P2 (Medium) - Compiler Integration

---

## P2-1: Update compile.ts Integration

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P0-1 (pass0 deleted), P0-4 (pass1 simplified)
**Spec Reference**: 04-compilation.md • **Status Reference**: EVALUATION-20260104.md Lines 248-260, 413-425

### Description
Update `src/editor/compiler/compile.ts` to receive NormalizedGraph from PatchStore instead of raw Patch. Remove all references to pass0-materialize. Ensure compilation uses GraphNormalizer's output directly.

### Acceptance Criteria
- [ ] compile() accepts NormalizedGraph parameter (not Patch)
- [ ] No import of pass0-materialize
- [ ] No call to pass0Materialize()
- [ ] Passes normalized graph directly to pass1
- [ ] All tests pass
- [ ] E2E test confirms compilation uses GraphNormalizer output

### Technical Notes
- PatchStore.getNormalizedGraph() returns NormalizedGraph
- Compiler should receive this directly, not re-normalize
- Structural blocks already in the graph

---

## P2-2: Add PatchStore Migration (Delete Old Structural Blocks)

**Status**: Not Started
**Effort**: Small (2 days)
**Dependencies**: P2-1
**Spec Reference**: N/A • **Status Reference**: EVALUATION-20260104.md Lines 396-412

### Description
Add migration logic to PatchStore to DELETE old structural blocks on load. Old patches may have structural blocks created by pass0 or DefaultSourceStore. These need to be removed so GraphNormalizer can recreate them correctly.

Current code filters to user-only blocks (Line 401), but old structural blocks might remain in storage.

### Acceptance Criteria
- [ ] Migration deletes blocks with `role.kind === 'structural'` on load
- [ ] Migration deletes edges with `role.kind === 'default'` on load
- [ ] GraphNormalizer recreates structural blocks correctly
- [ ] Unit test confirms old structural blocks removed
- [ ] E2E test confirms patches load correctly after migration
- [ ] No duplicate providers after migration

### Technical Notes
- Old patches may have structural blocks from pass0/DefaultSourceStore
- GraphNormalizer needs clean slate to recreate correctly
- Migration should run once on load, not every frame

---

### P3 (Low) - Cleanup and Documentation

---

## P3-1: Rename pass1-normalize.ts to pass1-canonicalize.ts

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: P0-4 (pass1 simplified)
**Spec Reference**: N/A • **Status Reference**: EVALUATION-20260104.md Line 106

### Description
Optional: Rename `pass1-normalize.ts` to `pass1-canonicalize.ts` to reflect its actual purpose (block ID freezing and edge canonicalization, NOT normalization). Update all imports.

### Acceptance Criteria
- [ ] File renamed to pass1-canonicalize.ts
- [ ] All imports updated
- [ ] Export name changed to `pass1Canonicalize`
- [ ] All tests pass
- [ ] No broken references

### Technical Notes
- This is purely cosmetic
- Improves code clarity
- Can be deferred if time-constrained

---

## P3-2: Add GraphNormalizer Unit Tests

**Status**: Not Started
**Effort**: Medium (3 days)
**Dependencies**: P1-1 (complete mappings)
**Spec Reference**: N/A • **Status Reference**: N/A

### Description
Add comprehensive unit tests for GraphNormalizer to ensure correctness and prevent regressions. Test all provider type mappings, ID generation, edge creation, and edge cases (missing defaults, invalid types, etc.).

### Acceptance Criteria
- [ ] Test all provider type mappings
- [ ] Test ID generation determinism
- [ ] Test edge creation correctness
- [ ] Test edge cases (no defaults, invalid types)
- [ ] Test structural role tagging
- [ ] 100% coverage of selectProviderType()
- [ ] 100% coverage of normalize()

### Technical Notes
- GraphNormalizer is pure function, easy to test
- Tests should cover all world:domain combinations
- Tests should verify Edge schema correctness

---

## P3-3: Document GraphNormalizer as Canonical

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: All P0/P1 items complete
**Spec Reference**: N/A • **Status Reference**: N/A

### Description
Add documentation to GraphNormalizer explaining it is the SINGLE SOURCE OF TRUTH for default source normalization. Document ID format, provider selection logic, and integration points.

### Acceptance Criteria
- [ ] JSDoc comment on normalize() function
- [ ] JSDoc comment on selectProviderType() function
- [ ] Comment explaining ID format
- [ ] Comment explaining integration with PatchStore
- [ ] Comment explaining why other systems were deleted

### Technical Notes
- Prevents future developers from re-creating duplicate systems
- Explains architectural decision
- Low effort, high value

---

## Dependency Graph

```
P0-1 (delete pass0) ──┬──> P2-1 (compile.ts)
P0-2 (delete constProviders) ──> P1-3 (allowlist.ts)
P0-3 (delete ir/defaultSources) requires P0-4
P0-4 (simplify pass1) ──┬──> P2-1 (compile.ts)
                        └──> P3-1 (rename pass1)
P0-5 (simplify DefaultSourceStore) ──> independent

P1-1 (add mappings) ──> P3-2 (tests)
P1-2 (verify ID format) ──> independent
P1-3 (allowlist.ts) ──> independent

P2-1 (compile.ts) ──> P2-2 (migration)
P2-2 (migration) ──> independent

P3-1 (rename) ──> independent
P3-2 (tests) ──> independent
P3-3 (docs) ──> independent
```

---

## Recommended Sprint Planning

### Sprint 1: Delete Redundant Systems (P0)
- P0-1: Delete pass0-materialize.ts
- P0-2: Delete constProviders.ts
- P0-3: Delete ir/defaultSources.ts
- P0-4: Simplify pass1-normalize.ts
- P0-5: Simplify DefaultSourceStore.ts

**Goal**: Zero duplication. GraphNormalizer is sole source.

### Sprint 2: Complete GraphNormalizer (P1)
- P1-1: Add missing provider type mappings
- P1-2: Verify ID format canonical
- P1-3: Update allowlist.ts

**Goal**: GraphNormalizer feature-complete.

### Sprint 3: Integration (P2)
- P2-1: Update compile.ts integration
- P2-2: Add PatchStore migration

**Goal**: Clean compiler integration.

### Sprint 4: Cleanup (P3) - Optional
- P3-1: Rename pass1 to pass1-canonicalize
- P3-2: Add GraphNormalizer unit tests
- P3-3: Document GraphNormalizer as canonical

**Goal**: Code quality and maintainability.

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Missing provider type mappings cause fallback to wrong types | Medium | High | P1-1 adds all missing mappings, tests verify |
| Old structural blocks remain in storage | Low | Medium | P2-2 migration deletes them on load |
| UI value editing breaks after DefaultSourceStore simplification | Low | High | P0-5 keeps value storage intact, tests verify |
| Tests pass but behavior wrong | Medium | High | E2E tests + Chrome DevTools verification per CLAUDE.md |
| Breaking changes affect existing patches | High | Low | User accepted breaking changes |

---

## Success Criteria

After all P0/P1 items complete:

1. GraphNormalizer is the ONLY system creating structural blocks+edges
2. No duplicate provider blocks created
3. Type mismatches eliminated (all tests pass)
4. UI value editing still works
5. Compiler integration clean (no redundant passes)
6. Exactly 3 files deleted, 5 files simplified

---

## Files Summary

### DELETE (3 files)
1. `src/editor/compiler/passes/pass0-materialize.ts`
2. `src/editor/defaultSources/constProviders.ts`
3. `src/editor/compiler/ir/defaultSources.ts`

### MODIFY (5 files)
1. `src/editor/compiler/passes/pass1-normalize.ts` (remove defaults/constPool)
2. `src/editor/stores/DefaultSourceStore.ts` (remove attachments)
3. `src/editor/defaultSources/allowlist.ts` (inline providers)
4. `src/editor/compiler/compile.ts` (remove pass0 calls)
5. `src/editor/graph/GraphNormalizer.ts` (add mappings)

### KEEP (6 files)
1. `src/editor/blocks/default-source-providers.ts` (block definitions)
2. `src/editor/compiler/blocks/defaultSources/*.ts` (block compilers)
3. `src/editor/compiler/ir/defaultSourceUtils.ts` (IR helper)
4. `src/editor/graph/types.ts` (graph types)
5. `src/editor/transforms/normalize.ts` (transform normalization)
6. All test files (will update as needed)

---

**End of Plan**
