# Definition of Done: IR Compiler Migration - Phase 1 Complete

**Generated:** 2025-12-24-222311 (Revised)
**Plan:** PLAN-2025-12-24-222311.md
**Scope:** Phase 0, Topics 1-4 - Complete IR type foundation

---

## Sprint Scope

This sprint delivers **4 topics, 8 deliverables**:

| Topic | Deliverables |
|-------|--------------|
| 1. type-unification | TypeDesc.ts, typeConversion.ts, tests |
| 2. dense-id-system | Indices.ts, DebugIndex.ts, tests |
| 3. ir-core-types | CompiledProgramIR.ts, tests |
| 4. timemodel-ir | TimeDerivation.ts, tests |

---

## Topic 1: Type Unification

### Deliverable 1.1: IR Type System Foundation

- [ ] **AC1.1:** `src/editor/ir/types/TypeDesc.ts` exports TypeWorld, TypeDomain, TypeDesc, TypeCategory
- [ ] **AC1.2:** Exports `typeEquals(a: TypeDesc, b: TypeDesc): boolean`
- [ ] **AC1.3:** Exports `isCompatible(from: TypeDesc, to: TypeDesc): boolean`
- [ ] **AC1.4:** Exports `isBusEligible(type: TypeDesc): boolean`
- [ ] **AC1.5:** Exports `getTypeCategory(type: TypeDesc): TypeCategory`
- [ ] **AC1.6:** `src/editor/ir/types/typeConversion.ts` exports `valueKindToTypeDesc()`
- [ ] **AC1.7:** Exports `slotTypeToTypeDesc()`
- [ ] **AC1.8:** Exports `domainFromString()`
- [ ] **AC1.9:** Domain names match current code (phase, time, trigger - NOT phase01, timeMs)
- [ ] **AC1.10:** All interfaces are readonly/immutable

### Deliverable 1.2: Type System Tests

- [ ] **AC1.11:** `TypeDesc.test.ts` covers typeEquals, isCompatible, isBusEligible, getTypeCategory
- [ ] **AC1.12:** `typeConversion.test.ts` covers all conversion functions (20+ cases)
- [ ] **AC1.13:** Edge cases covered (semantics, unknown types, null handling)
- [ ] **AC1.14:** All tests pass

---

## Topic 2: Dense ID System

### Deliverable 2.1: Branded Index Types

- [ ] **AC2.1:** `Indices.ts` exports NodeIndex, PortIndex, BusIndex, ValueSlot, StepIndex
- [ ] **AC2.2:** Exports NodeId, BusId, StepId, ExprId, StateId
- [ ] **AC2.3:** Exports factory functions (nodeIndex, busIndex, valueSlot, nodeId, busId, etc.)
- [ ] **AC2.4:** Branded types have no runtime cost (compile-time only)

### Deliverable 2.2: Debug Index Builder

- [ ] **AC2.5:** `DebugIndex.ts` exports DebugIndex interface
- [ ] **AC2.6:** Exports DebugIndexBuilder class with internNode, internBus, internPort, build methods
- [ ] **AC2.7:** Interning is idempotent (same ID → same index)
- [ ] **AC2.8:** Round-trip lookup works (index → id → index)

### Deliverable 2.3: Index Tests

- [ ] **AC2.9:** Tests branded type factories
- [ ] **AC2.10:** Tests DebugIndexBuilder sequential index assignment
- [ ] **AC2.11:** Tests idempotent interning
- [ ] **AC2.12:** Tests round-trip id↔index lookup

---

## Topic 3: IR Core Types

### Deliverable 3.1: CompiledProgramIR Schema

- [ ] **AC3.1:** `CompiledProgramIR.ts` exports CompiledProgramIR interface with all tables
- [ ] **AC3.2:** Exports NodeIR with id, index, capability, op, inputs, outputs
- [ ] **AC3.3:** Exports InputSourceIR discriminated union (slot, bus, const, defaultSource, rail, external)
- [ ] **AC3.4:** Exports InputPortIR, OutputPortIR interfaces
- [ ] **AC3.5:** Exports BusIR with publishers, listeners, combineMode
- [ ] **AC3.6:** Exports ScheduleIR with step types (TimeDeriveStepIR, NodeEvalStepIR, BusEvalStepIR, etc.)
- [ ] **AC3.7:** Exports PhasePartitionIR (timeDerive, preBus, bus, postBus, materializeRender, renderAssemble)
- [ ] **AC3.8:** Exports OpCode discriminated union (time, math, vec, state, render, field ops)
- [ ] **AC3.9:** Exports TimeModelIR variants (FiniteTimeModelIR, CyclicTimeModelIR, InfiniteTimeModelIR)
- [ ] **AC3.10:** Exports ConstPool, DefaultSourceTable, TransformTable
- [ ] **AC3.11:** Exports ProgramMeta, NodeMeta, CompileWarningIR
- [ ] **AC3.12:** All interfaces are readonly/immutable

### Deliverable 3.2: IR Schema Tests

- [ ] **AC3.13:** Tests constructing minimal valid CompiledProgramIR
- [ ] **AC3.14:** Tests NodeIR with various OpCodes
- [ ] **AC3.15:** Tests BusIR with publishers and listeners
- [ ] **AC3.16:** Tests ScheduleIR with step variants
- [ ] **AC3.17:** Type-level tests pass (tsc compiles without errors)

---

## Topic 4: TimeModel IR

### Deliverable 4.1: TimeModel Types

- [ ] **AC4.1:** `TimeDerivation.ts` exports CanonicalTimeSignals interface
- [ ] **AC4.2:** Exports CanonicalTimeSignalSpec interface
- [ ] **AC4.3:** Exports `deriveTimeSignals(model: TimeModelIR): CanonicalTimeSignalSpec`
- [ ] **AC4.4:** Exports ValidationResult interface
- [ ] **AC4.5:** Exports `validateTimeModel(model: TimeModelIR): ValidationResult`
- [ ] **AC4.6:** Exports TimeDerivedValues interface
- [ ] **AC4.7:** Exports `calculateTimeDerivedValues(model, tAbsMs, prevTAbsMs): TimeDerivedValues`

### Deliverable 4.2: TimeDerivation Tests

- [ ] **AC4.8:** Tests deriveTimeSignals returns correct signals per model kind
- [ ] **AC4.9:** Tests validateTimeModel catches invalid configs (zero period, negative duration, etc.)
- [ ] **AC4.10:** Tests calculateTimeDerivedValues for cyclic (phase calc, wrap detection)
- [ ] **AC4.11:** Tests calculateTimeDerivedValues for finite (progress calc, end detection)
- [ ] **AC4.12:** Tests calculateTimeDerivedValues for infinite (passthrough)

---

## Build & Test Validation

- [ ] **AC5.1:** `just typecheck` passes with zero errors
- [ ] **AC5.2:** `just lint` passes with zero warnings
- [ ] **AC5.3:** `just test` passes with all tests green
- [ ] **AC5.4:** `just build` succeeds
- [ ] **AC5.5:** `just check` (full check) passes completely

---

## Runtime Validation

- [ ] **AC6.1:** `just dev` starts dev server without errors
- [ ] **AC6.2:** Browser console shows zero new errors/warnings
- [ ] **AC6.3:** Existing functionality unchanged
- [ ] **AC6.4:** No performance degradation

---

## Code Quality

- [ ] **AC7.1:** All exported functions have JSDoc comments
- [ ] **AC7.2:** All interfaces use `readonly` keyword
- [ ] **AC7.3:** No `any` types used
- [ ] **AC7.4:** No type assertions except in tests
- [ ] **AC7.5:** Code follows existing style conventions

---

## File Structure

- [ ] **AC8.1:** `src/editor/ir/types/TypeDesc.ts` exists
- [ ] **AC8.2:** `src/editor/ir/types/typeConversion.ts` exists
- [ ] **AC8.3:** `src/editor/ir/types/Indices.ts` exists
- [ ] **AC8.4:** `src/editor/ir/types/DebugIndex.ts` exists
- [ ] **AC8.5:** `src/editor/ir/types/__tests__/TypeDesc.test.ts` exists
- [ ] **AC8.6:** `src/editor/ir/types/__tests__/typeConversion.test.ts` exists
- [ ] **AC8.7:** `src/editor/ir/types/__tests__/Indices.test.ts` exists
- [ ] **AC8.8:** `src/editor/ir/schema/CompiledProgramIR.ts` exists
- [ ] **AC8.9:** `src/editor/ir/schema/__tests__/CompiledProgramIR.test.ts` exists
- [ ] **AC8.10:** `src/editor/ir/time/TimeDerivation.ts` exists
- [ ] **AC8.11:** `src/editor/ir/time/__tests__/TimeDerivation.test.ts` exists
- [ ] **AC8.12:** `src/editor/ir/index.ts` exists and re-exports public API

---

## Sprint Completion Checklist

**This sprint is COMPLETE when ALL of the following are true:**

1. ✅ All 4 topics implemented (type-unification, dense-id-system, ir-core-types, timemodel-ir)
2. ✅ All 8 deliverables complete with tests
3. ✅ `just check` passes completely
4. ✅ `just dev` runs without errors
5. ✅ Zero modifications to existing files
6. ✅ All new files in `src/editor/ir/` namespace
7. ✅ Domain names match current code (phase, time, trigger)
8. ✅ All IR types are readonly/immutable
9. ✅ Comprehensive test coverage

---

## Verification Commands

```bash
# Full check (all of the above)
just check

# Dev server (should start without errors)
just dev

# Build (production build)
just build
```

---

**END OF DEFINITION OF DONE**
