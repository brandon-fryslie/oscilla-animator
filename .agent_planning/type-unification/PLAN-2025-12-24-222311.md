# Sprint Plan: IR Compiler Migration - Phase 1 Complete

**Generated:** 2025-12-24-222311 (Revised)
**Source STATUS:** STATUS-20251224.md
**Git Commit:** b0ef07c
**Scope:** Phase 0, Topics 1-4 - Complete IR type foundation

---

## Executive Summary

**Goal:** Implement the complete Phase 1 foundation for the IR Compiler Migration: unified types, dense indices, core IR schema, and time model. This establishes all type contracts for the data-driven IR architecture.

**Core Insight:** The "program" becomes data, not JavaScript functions. This enables determinism, debuggability, hot-swap without jank, and future Rust/WASM runtime.

**Sprint Scope:**
- 4 topics, 8 deliverables
- Estimated complexity: MEDIUM-HIGH
- Risk: LOW (isolated type definitions, no runtime changes)

---

## Critical Decisions (Already Made)

### Decision 1: Domain Naming Convention
**Use CURRENT code domain names, NOT HANDOFF spec names.**

| HANDOFF Name | Current Name | Resolution |
|--------------|--------------|------------|
| `phase01` | `phase` | ✅ Use `phase` |
| `unit01` | `number` + semantics | ✅ Use `number` with `semantics: 'unit(0..1)'` |
| `timeMs` | `time` | ✅ Use `time` with `unit: 'ms'` |

### Decision 2: Event World
**Keep events as `world: 'signal', domain: 'trigger'` (NOT separate 'event' world).**

### Decision 3: SlotType Conversion
**Use lookup table approach with fallback parser for unknown types.**

---

## Topic 1: Type Unification

### Deliverable 1.1: IR Type System Foundation

**Priority:** P0 (Critical - blocks all other topics)
**Effort:** Medium (4-5 hours)
**Dependencies:** None

**File Structure:**
```
src/editor/ir/
├── types/
│   ├── TypeDesc.ts           # Unified type definitions + helpers
│   ├── typeConversion.ts     # ValueKind/SlotType → TypeDesc bridges
│   └── __tests__/
│       ├── TypeDesc.test.ts
│       └── typeConversion.test.ts
└── index.ts                  # Public API exports
```

**Acceptance Criteria:**

- [ ] **AC1.1:** `src/editor/ir/types/TypeDesc.ts` exports:
  - `TypeWorld` union type (signal | field | scalar | config)
  - `TypeDomain` union type (all CoreDomain + InternalDomain values)
  - `TypeDesc` interface with readonly `world`, `domain`, `category`, `busEligible`, `semantics?`, `unit?`
  - `TypeCategory` type ('core' | 'internal')
  - `typeEquals(a: TypeDesc, b: TypeDesc): boolean`
  - `isCompatible(from: TypeDesc, to: TypeDesc): boolean`
  - `isBusEligible(type: TypeDesc): boolean`
  - `getTypeCategory(type: TypeDesc): TypeCategory`

- [ ] **AC1.2:** `src/editor/ir/types/typeConversion.ts` exports:
  - `valueKindToTypeDesc(kind: ValueKind): TypeDesc`
  - `slotTypeToTypeDesc(slot: SlotType): TypeDesc`
  - `domainFromString(s: string): TypeDomain`

- [ ] **AC1.3:** Domain names match current code (phase, time, trigger - NOT phase01, timeMs)

- [ ] **AC1.4:** All TypeDesc interfaces are readonly/immutable

### Deliverable 1.2: Type System Tests

**Priority:** P0
**Effort:** Medium (3-4 hours)
**Dependencies:** Deliverable 1.1

**Acceptance Criteria:**

- [ ] **AC1.5:** `TypeDesc.test.ts` covers typeEquals, isCompatible, isBusEligible, getTypeCategory

- [ ] **AC1.6:** `typeConversion.test.ts` covers all conversion functions with 20+ representative cases

- [ ] **AC1.7:** Edge cases covered (semantics differences, unknown types, null handling)

- [ ] **AC1.8:** All tests pass with `just test`

---

## Topic 2: Dense ID System

### Deliverable 2.1: Branded Index Types

**Priority:** P0
**Effort:** Low (1-2 hours)
**Dependencies:** None (can parallel with Topic 1)

**File:** `src/editor/ir/types/Indices.ts`

**Acceptance Criteria:**

- [ ] **AC2.1:** Exports branded index types:
  - `NodeIndex = number & { readonly __brand: 'NodeIndex' }`
  - `PortIndex = number & { readonly __brand: 'PortIndex' }`
  - `BusIndex = number & { readonly __brand: 'BusIndex' }`
  - `ValueSlot = number & { readonly __brand: 'ValueSlot' }`
  - `StepIndex = number & { readonly __brand: 'StepIndex' }`

- [ ] **AC2.2:** Exports branded ID types:
  - `NodeId = string & { readonly __brand: 'NodeId' }`
  - `BusId = string & { readonly __brand: 'BusId' }`
  - `StepId = string & { readonly __brand: 'StepId' }`
  - `ExprId = string & { readonly __brand: 'ExprId' }`
  - `StateId = string & { readonly __brand: 'StateId' }`

- [ ] **AC2.3:** Exports factory functions (compile-time only, no runtime cost):
  - `nodeIndex(n: number): NodeIndex`
  - `portIndex(n: number): PortIndex`
  - `busIndex(n: number): BusIndex`
  - `valueSlot(n: number): ValueSlot`
  - `stepIndex(n: number): StepIndex`
  - `nodeId(s: string): NodeId`
  - `busId(s: string): BusId`
  - `stepId(s: string): StepId`
  - `exprId(s: string): ExprId`
  - `stateId(s: string): StateId`

### Deliverable 2.2: Debug Index Builder

**Priority:** P0
**Effort:** Medium (2-3 hours)
**Dependencies:** Deliverable 2.1

**File:** `src/editor/ir/types/DebugIndex.ts`

**Acceptance Criteria:**

- [ ] **AC2.4:** Exports `DebugIndex` interface with:
  - `compileId: string`
  - `patchRevision: number`
  - `nodeIdToIndex: ReadonlyMap<NodeId, NodeIndex>`
  - `nodeIndexToId: readonly NodeId[]`
  - `busIdToIndex: ReadonlyMap<BusId, BusIndex>`
  - `busIndexToId: readonly BusId[]`
  - `portKeyToSlot: ReadonlyMap<string, ValueSlot>`
  - `slotToPortKey: readonly string[]`
  - `nodeIdToBlockId: ReadonlyMap<NodeId, string>`

- [ ] **AC2.5:** Exports `DebugIndexBuilder` class with methods:
  - `constructor(compileId: string, patchRevision: number)`
  - `internNode(id: NodeId, blockId?: string): NodeIndex`
  - `internBus(id: BusId): BusIndex`
  - `internPort(nodeId: NodeId, portName: string): ValueSlot`
  - `build(): DebugIndex`

- [ ] **AC2.6:** Interning is idempotent (same ID returns same index)

- [ ] **AC2.7:** Round-trip lookup works (index → id → index)

### Deliverable 2.3: Index Tests

**Priority:** P0
**Effort:** Low (1-2 hours)
**Dependencies:** Deliverables 2.1, 2.2

**File:** `src/editor/ir/types/__tests__/Indices.test.ts`

**Acceptance Criteria:**

- [ ] **AC2.8:** Tests branded type factories work correctly

- [ ] **AC2.9:** Tests DebugIndexBuilder assigns sequential indices

- [ ] **AC2.10:** Tests interning is idempotent (same ID → same index)

- [ ] **AC2.11:** Tests round-trip id↔index lookup

---

## Topic 3: IR Core Types

### Deliverable 3.1: CompiledProgramIR Schema

**Priority:** P0
**Effort:** High (4-5 hours)
**Dependencies:** Topics 1 and 2

**File:** `src/editor/ir/schema/CompiledProgramIR.ts`

**Acceptance Criteria:**

- [ ] **AC3.1:** Exports `CompiledProgramIR` interface with:
  - `irVersion: 1`
  - `patchId: string`
  - `patchRevision: number`
  - `compileId: string`
  - `seed: number`
  - `timeModel: TimeModelIR`
  - `types: TypeTable`
  - `nodes: NodeTable`
  - `buses: BusTable`
  - `constPool: ConstPool`
  - `defaultSources: DefaultSourceTable`
  - `transforms: TransformTable`
  - `schedule: ScheduleIR`
  - `outputs: readonly OutputSpec[]`
  - `debugIndex: DebugIndex`
  - `meta: ProgramMeta`

- [ ] **AC3.2:** Exports `NodeIR` interface with:
  - `id: NodeId`
  - `index: NodeIndex`
  - `capability: NodeCapability`
  - `op: OpCode`
  - `inputs: readonly InputPortIR[]`
  - `outputs: readonly OutputPortIR[]`
  - `consts?: ConstPoolRef`
  - `state?: readonly StateBindingIR[]`
  - `meta?: NodeMeta`

- [ ] **AC3.3:** Exports `InputSourceIR` discriminated union:
  - `{ kind: 'slot'; slot: ValueSlot }`
  - `{ kind: 'bus'; busIndex: BusIndex }`
  - `{ kind: 'const'; constId: string }`
  - `{ kind: 'defaultSource'; defaultId: string }`
  - `{ kind: 'rail'; railId: string }`
  - `{ kind: 'external'; externalId: string }`

- [ ] **AC3.4:** Exports `BusIR` interface with all fields from HANDOFF

- [ ] **AC3.5:** Exports `ScheduleIR` with step types and `PhasePartitionIR`

- [ ] **AC3.6:** Exports `OpCode` discriminated union covering all operation categories:
  - Time ops (time.absMs, time.modelMs, time.phase01, time.wrapEvent)
  - Math ops (math.add, math.mul, math.sin, math.lerp, etc.)
  - Vector ops (vec.add, vec.sub, vec.scale, etc.)
  - State ops (state.integrate, state.delay, state.slew)
  - Render ops (render.instances2d, render.group, render.filter)
  - Field ops (field.broadcast, field.reduce, field.map)
  - Special (noop, custom)

- [ ] **AC3.7:** All interfaces are readonly/immutable

### Deliverable 3.2: IR Schema Tests

**Priority:** P0
**Effort:** Medium (2-3 hours)
**Dependencies:** Deliverable 3.1

**File:** `src/editor/ir/schema/__tests__/CompiledProgramIR.test.ts`

**Acceptance Criteria:**

- [ ] **AC3.8:** Tests constructing a minimal valid CompiledProgramIR

- [ ] **AC3.9:** Tests NodeIR with various OpCodes compiles correctly

- [ ] **AC3.10:** Tests BusIR with publishers and listeners

- [ ] **AC3.11:** Tests ScheduleIR with step variants

- [ ] **AC3.12:** Type-level tests pass (tsc compiles without errors)

---

## Topic 4: TimeModel IR

### Deliverable 4.1: TimeModel Types

**Priority:** P0
**Effort:** Low (1-2 hours)
**Dependencies:** Topic 3 (uses CompiledProgramIR types)

**Note:** TimeModelIR is already defined in CompiledProgramIR.ts. This deliverable adds the TimeDerivation module.

**File:** `src/editor/ir/time/TimeDerivation.ts`

**Acceptance Criteria:**

- [ ] **AC4.1:** Exports `CanonicalTimeSignals` interface with:
  - `tAbsMs: ValueSlot` (absolute monotonic time)
  - `tModelMs: ValueSlot` (model-local time)
  - `phase01?: ValueSlot` (cyclic/finite only)
  - `wrapEvent?: ValueSlot` (cyclic only)
  - `progress?: ValueSlot` (finite only)
  - `endEvent?: ValueSlot` (finite only)

- [ ] **AC4.2:** Exports `CanonicalTimeSignalSpec` interface (boolean flags for available signals)

- [ ] **AC4.3:** Exports `deriveTimeSignals(model: TimeModelIR): CanonicalTimeSignalSpec`
  - Cyclic: tAbsMs, tModelMs, phase01, wrapEvent
  - Finite: tAbsMs, tModelMs, phase01, progress, endEvent
  - Infinite: tAbsMs, tModelMs only

- [ ] **AC4.4:** Exports `ValidationResult` interface with `valid: boolean`, `errors: readonly string[]`

- [ ] **AC4.5:** Exports `validateTimeModel(model: TimeModelIR): ValidationResult`
  - Rejects cyclic with periodMs <= 0
  - Rejects finite with durationMs <= 0
  - Rejects infinite with windowMs <= 0
  - Validates cue points are within duration

- [ ] **AC4.6:** Exports `TimeDerivedValues` interface

- [ ] **AC4.7:** Exports `calculateTimeDerivedValues(model: TimeModelIR, tAbsMs: number, prevTAbsMs: number): TimeDerivedValues`
  - Cyclic: calculates phase, detects wrap event
  - Finite: calculates progress, detects end event
  - Infinite: passes through time values

### Deliverable 4.2: TimeDerivation Tests

**Priority:** P0
**Effort:** Medium (2-3 hours)
**Dependencies:** Deliverable 4.1

**File:** `src/editor/ir/time/__tests__/TimeDerivation.test.ts`

**Acceptance Criteria:**

- [ ] **AC4.8:** Tests `deriveTimeSignals()` returns correct signals per model kind

- [ ] **AC4.9:** Tests `validateTimeModel()` catches invalid configurations:
  - Cyclic with zero/negative period
  - Finite with zero/negative duration
  - Cue points outside duration
  - Infinite with zero/negative window

- [ ] **AC4.10:** Tests `calculateTimeDerivedValues()` for cyclic:
  - Phase calculation correct (e.g., t=1000, period=4000 → phase=0.25)
  - Wrap event detection (phase decreased from previous frame)

- [ ] **AC4.11:** Tests `calculateTimeDerivedValues()` for finite:
  - Progress calculation correct
  - End event detection (crossed 100% progress)
  - Time clamped at duration

- [ ] **AC4.12:** Tests `calculateTimeDerivedValues()` for infinite:
  - tAbsMs and tModelMs both equal input

---

## File Structure Summary

```
src/editor/ir/
├── types/
│   ├── TypeDesc.ts           # Topic 1: Unified type descriptors
│   ├── typeConversion.ts     # Topic 1: Legacy type bridges
│   ├── Indices.ts            # Topic 2: Dense numeric indices
│   ├── DebugIndex.ts         # Topic 2: String↔index mapping
│   └── __tests__/
│       ├── TypeDesc.test.ts
│       ├── typeConversion.test.ts
│       └── Indices.test.ts
├── schema/
│   ├── CompiledProgramIR.ts  # Topic 3: Main IR schema
│   └── __tests__/
│       └── CompiledProgramIR.test.ts
├── time/
│   ├── TimeDerivation.ts     # Topic 4: Time signal derivation
│   └── __tests__/
│       └── TimeDerivation.test.ts
└── index.ts                  # Public exports
```

---

## Dependency Graph

```
Topic 1 (type-unification)     Topic 2 (dense-id-system)
        │                              │
        ├──────────┬───────────────────┤
                   ▼
        Topic 3 (ir-core-types)
                   │
                   ▼
        Topic 4 (timemodel-ir)
```

Topics 1 and 2 can be implemented in parallel. Topics 3 and 4 depend on both.

---

## Sprint Acceptance Criteria Summary

**This sprint is COMPLETE when:**

1. ✅ All 4 topics implemented with 8 deliverables
2. ✅ `src/editor/ir/` directory structure complete
3. ✅ All helper functions and conversion utilities implemented
4. ✅ Complete test suite with comprehensive coverage
5. ✅ `just check` passes (typecheck + lint + test)
6. ✅ `just dev` runs without errors (zero runtime impact)
7. ✅ Domain names match current code (phase, time, trigger)
8. ✅ All IR types are readonly/immutable
9. ✅ No modifications to existing files

---

## Risk Assessment

**Overall Risk Level:** LOW

- All changes are additive (new files only)
- Pure type definitions with no runtime code
- No modifications to existing editor/compiler
- Comprehensive test coverage validates correctness

---

## Recommended Implementation Order

1. **Topic 1 + Topic 2 in parallel** (can be done simultaneously)
   - TypeDesc.ts, typeConversion.ts, Indices.ts, DebugIndex.ts
   - Tests for all

2. **Topic 3** (depends on 1 + 2)
   - CompiledProgramIR.ts with all tables and types
   - Schema tests

3. **Topic 4** (depends on 3)
   - TimeDerivation.ts
   - Time derivation tests

4. **Final validation**
   - `just check` passes
   - `just dev` runs

---

**END OF PLAN**
