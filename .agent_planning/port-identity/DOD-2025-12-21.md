# Definition of Done: Port Identity Fix

**Date**: 2025-12-21
**Priority**: CRITICAL (root of a thousand paper cuts)
**Spec Reference**: design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md

---

## Objective

Replace string-based port names with canonical `PortRef` pattern across all endpoint references, establishing ONE addressing scheme for ports system-wide.

---

## Success Criteria

### Must Have

1. **BindingEndpoint uses slotId + dir**
   - [ ] `BindingEndpoint.port: string` → `BindingEndpoint.slotId: string` + `BindingEndpoint.dir: 'input' | 'output'`
   - [ ] All Publisher/Listener types updated to use new BindingEndpoint

2. **CompositeConnection uses slotId**
   - [ ] `CompositeConnection.from.port` → `from.slotId`
   - [ ] `CompositeConnection.to.port` → `to.slotId`

3. **All usages updated**
   - [ ] `src/editor/stores/BusStore.ts` - Publisher/Listener creation and queries
   - [ ] `src/editor/compiler/compileBusAware.ts` - Bus routing compilation
   - [ ] `src/editor/compiler/compile.ts` - Wire validation
   - [ ] `src/editor/compiler/integration.ts` - Composite expansion
   - [ ] `src/editor/Inspector.tsx` - UI rendering
   - [ ] `src/editor/BusChannel.tsx` - Publisher labels
   - [ ] `src/editor/BusInspector.tsx` - Publisher/Listener display
   - [ ] `src/editor/BusPicker.tsx` - Listener matching
   - [ ] `src/editor/PublishMenu.tsx` - Publisher matching
   - [ ] All test files updated

4. **Type safety**
   - [ ] TypeScript compilation succeeds with no errors
   - [ ] All existing tests pass (738+)

### Should Have

5. **Direction enforcement**
   - [ ] Publishers must have `dir: 'output'` (publishing from output ports)
   - [ ] Listeners must have `dir: 'input'` (listening on input ports)
   - [ ] Runtime validation on creation

### Won't Have (this PR)

- Composite port mapping enforcement (separate issue #4)
- SemanticGraph/kernel (separate issue #5)
- Op system/transactions (separate issue #6)

---

## Verification

### Automated
```bash
just typecheck  # Must pass
just test       # All 738+ tests must pass
```

### Manual
1. Create a patch with a composite block
2. Add bus publisher from composite output
3. Add bus listener to composite input
4. Verify bus binding survives and works

---

## Files to Modify

### Type Definitions
- `src/editor/types.ts:164-170` - BindingEndpoint interface
- `src/editor/types.ts:490-505` - CompositeConnection interface

### Stores
- `src/editor/stores/BusStore.ts` - addPublisher, addListener, queries
- `src/editor/stores/CompositeStore.ts` - connection handling
- `src/editor/stores/PatchStore.ts` - replaceBlock, connection tracking

### Compiler
- `src/editor/compiler/compile.ts` - wire validation
- `src/editor/compiler/compileBusAware.ts` - bus routing
- `src/editor/compiler/integration.ts` - composite expansion
- `src/editor/compiler/error-decorations.ts` - error location

### UI Components
- `src/editor/Inspector.tsx` - port display
- `src/editor/BusChannel.tsx` - publisher display
- `src/editor/BusInspector.tsx` - publisher/listener cards
- `src/editor/BusPicker.tsx` - listener matching
- `src/editor/PublishMenu.tsx` - publisher matching
- `src/editor/ContextMenu.tsx` - port actions

### Utilities
- `src/editor/autowire.ts` - connection creation
- `src/editor/replaceUtils.ts` - block replacement
- `src/editor/portUtils.ts` - port utilities

### Tests
- `src/editor/__tests__/bus-compilation.test.ts`
- `src/editor/__tests__/field-bus-compilation.test.ts`
- `src/editor/__tests__/composite.expansion.test.ts`
- `src/editor/stores/__tests__/PatchStore.events.test.ts`
- `src/editor/compiler/__tests__/bus-diagnostics.test.ts`
- `src/editor/diagnostics/__tests__/ActionExecutor.test.ts`
- `src/editor/compiler/unified/__tests__/*.test.ts`

---

## Risks

1. **Breaking existing patches**: If patches are persisted with `port` key, need migration
   - Mitigation: Add backward compat adapter in deserialization (if persistence exists)

2. **High touch count**: ~20+ files need changes
   - Mitigation: TypeScript will catch all misses at compile time

3. **Direction inference**: Some code may not have direction context
   - Mitigation: Add helper function `inferDirection(block, slotId): 'input' | 'output'`

---

## Estimated Complexity

- Type changes: Low
- Store changes: Medium
- Compiler changes: Medium
- UI changes: Low
- Test updates: Medium

**Overall: Medium complexity, high impact**
