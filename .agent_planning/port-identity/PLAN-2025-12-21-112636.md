# Port Identity Quick Fix - Implementation Plan

**Generated**: 2025-12-21-112636
**Source**: STATUS-2025-12-21-investigation.md
**Topic**: Port Identity - Fix Macro UpstreamError
**Sprint Goal**: Restore buildable state and fix macro compilation errors

---

## Executive Summary

**Current State**: Build is broken with 70+ TypeScript errors due to incomplete `BindingEndpoint` interface migration. Additionally, macros fail with `UpstreamError` because they reference `phase` but `CycleTimeRoot` outputs `phaseA`.

**User Decisions**:
1. Fix approach: 2A - Rename `CycleTimeRoot` output from `phaseA` to `phase` (aligns with spec)
2. Production patches: None exist - safe to rename freely
3. Priority: Quick fix now, architectural refactor deferred

**Sprint Deliverables**:
1. ✅ Build compiles without errors
2. ✅ Macros expand and compile successfully
3. ✅ Port validation added to bus-aware compiler

**Out of Scope** (deferred to future sprints):
- Full type-based port matching system
- Stable slotId system with versioning
- Composite boundary enforcement
- Port map definitions for composites

---

## Work Items

### P0 (Critical): Build Fix - Complete BindingEndpoint Migration

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: None
**Spec Reference**: design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md (section 2) • **Status Reference**: STATUS-2025-12-21-investigation.md (lines 12-60)

#### Description

The `BindingEndpoint` interface was changed from `{ blockId, port }` to `{ blockId, slotId, dir }` but 70+ usages across the codebase were not updated. This causes TypeScript compilation to fail before tests can run.

**Affected areas**:
- Test files (bus-compilation.test.ts, field-bus-compilation.test.ts, etc.)
- UI components (BusChannel.tsx, BusInspector.tsx, BusPicker.tsx, PublishMenu.tsx)
- Compiler (integration.ts, compileBusAware.ts)
- Stores (PatchStore.ts, CompositeStore.ts, ModulationTableStore.ts)

#### Acceptance Criteria

- [ ] All TypeScript compilation errors related to `BindingEndpoint.port` are resolved
- [ ] All files using `BindingEndpoint` updated to use `{ blockId, slotId, dir }` format
- [ ] `just typecheck` passes without errors
- [ ] All affected test files updated with correct binding endpoint structure
- [ ] No runtime regressions in bus publisher/listener functionality

#### Technical Notes

**Mechanical replacement pattern**:
```typescript
// Before (OLD - causes error)
{ from: { blockId: 'block-1', port: 'out' } }

// After (NEW - correct format)
{ from: { blockId: 'block-1', slotId: 'out', dir: 'output' } }
```

**Direction inference rules**:
- Bus publishers: `dir: 'output'` (blocks publish outputs to buses)
- Bus listeners: `dir: 'input'` (blocks receive bus values via inputs)
- Wire connections: Infer from position (`from` = output, `to` = input)

**Files to update** (from grep results):
1. `src/editor/__tests__/bus-compilation.test.ts`
2. `src/editor/__tests__/field-bus-compilation.test.ts`
3. `src/editor/stores/__tests__/BusStore.events.test.ts`
4. `src/editor/diagnostics/__tests__/ActionExecutor.test.ts`
5. `src/editor/diagnostics/ActionExecutor.ts`
6. `src/editor/compiler/unified/__tests__/RuntimeAdapter.test.ts`
7. `src/editor/compiler/unified/__tests__/UnifiedCompiler.test.ts`

**Verification strategy**:
1. Run `just typecheck` to verify no TS errors remain
2. Run `just test` to ensure all tests pass
3. Manually test bus publish/listen in UI (if accessible)

---

### P0 (Critical): Port Rename - CycleTimeRoot phaseA → phase

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0 Build Fix (must be able to compile)
**Spec Reference**: design-docs/10-Refactor-for-UI-prep/3.5-PhaseClock-Fix.md • design-docs/3-Synthesized/02-Time-Architecture.md • **Status Reference**: STATUS-2025-12-21-investigation.md (lines 62-158)

#### Description

`CycleTimeRoot` block currently outputs `phaseA` but macros reference `phase`. The spec clearly states TimeRoot should output canonical `phase` (not `phaseA`). Renaming the output to match spec fixes macro compilation errors and aligns implementation with design documents.

**Root cause**: Macros use `fromSlot: 'phase'` (24 occurrences) but block definition and compiler both output `phaseA`, causing string-based port lookup to fail with `UpstreamError: Missing upstream artifact for block-88:phase`.

#### Acceptance Criteria

- [ ] `CycleTimeRoot` block definition output renamed from `phaseA` to `phase`
- [ ] `CycleTimeRootBlock` compiler output renamed from `phaseA` to `phase`
- [ ] All macro templates continue using `fromSlot: 'phase'` (no changes needed)
- [ ] Test patches with `CycleTimeRoot` compile successfully
- [ ] Macro expansion and compilation succeeds without `UpstreamError`
- [ ] No references to `phaseA` remain in TimeRoot-related code

#### Technical Notes

**Files to modify**:

1. **Block definition** (`src/editor/blocks/time-root.ts:66`):
```typescript
// Before
output('phaseA', 'Phase A', 'Signal<phase>'),

// After
output('phase', 'Phase', 'Signal<phase>'),
```

2. **Compiler** (`src/editor/compiler/blocks/domain/TimeRoot.ts:63`):
```typescript
// Before
{ name: 'phaseA', type: { kind: 'Signal:phase' } },

// After
{ name: 'phase', type: { kind: 'Signal:phase' } },
```

3. **Return statement** (`src/editor/compiler/blocks/domain/TimeRoot.ts:90-92`):
```typescript
// Before
return {
  systemTime: { kind: 'Signal:Time', value: systemTime },
  phaseA: { kind: 'Signal:phase', value: phaseA },
};

// After
return {
  systemTime: { kind: 'Signal:Time', value: systemTime },
  phase: { kind: 'Signal:phase', value: phase },
};
```

**Migration considerations**:
- No production patches exist (per user confirmation)
- Safe to rename without backward compatibility shim
- Internal variable names (like `phaseA` function) can optionally be renamed to `phase` for consistency, but not required

**Spec justification** (from 3.5-PhaseClock-Fix.md):
> TimeRoot outputs:
> • Signal:TimeMs (monotonic or local, depends on mode)
> • Signal:phase (0..1) — the canonical replacement for PhaseClock output
> • Event:pulse (optional, but you'll want it soon)

The spec clearly names it `phase`, not `phaseA`.

---

### P1 (High): Port Validation - Add Missing Checks to compileBusAware

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0 Build Fix
**Spec Reference**: design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md (section 11) • **Status Reference**: STATUS-2025-12-21-investigation.md (lines 273-298)

#### Description

`compileBusAware.ts` does not validate that referenced ports exist on blocks before attempting to wire them. This causes cryptic runtime errors (`UpstreamError: Missing upstream artifact`) instead of clear compile-time errors with diagnostic messages.

The standard block compiler (`compile.ts:241-259`) has proper port validation that emits `PortMissing` errors. The bus-aware compiler should have equivalent validation.

#### Acceptance Criteria

- [ ] Port existence validation added to `compileBusAware.ts` for all block outputs
- [ ] Missing port references emit `PortMissing` diagnostic error
- [ ] Error message includes: block ID, port/slotId name, and context (publisher/listener/wire)
- [ ] Test case added verifying port validation catches missing ports
- [ ] Test case verifying descriptive error message format
- [ ] Validation happens before graph building (fail fast)

#### Technical Notes

**Reference implementation** from `compile.ts:241-259`:
```typescript
// Validate outputs and store
for (const outDef of compiler.outputs) {
  const produced = outs[outDef.name];
  if (!produced) {
    errors.push({
      code: 'PortMissing',
      message: `Compiler did not produce required output port ${blockId}.${outDef.name}`,
      where: { blockId, port: outDef.name },
    });
  }
}
```

**Apply to compileBusAware.ts**:

1. **After block compilation** (before adding to graph):
   - Validate all referenced outputs exist in compiled block
   - For each publisher: Check `from.slotId` exists in block outputs
   - For each wire source: Check `from.slotId` exists in block outputs

2. **Error format**:
```typescript
errors.push({
  code: 'PortMissing',
  message: `Block ${blockId} does not have output port '${slotId}' (referenced by ${context})`,
  where: { blockId, port: slotId, dir: 'output' },
});
```

3. **Contexts to check**:
   - Bus publishers (`from` endpoint)
   - Wire connections (`from` endpoint)
   - Note: Bus listeners (`to` endpoint) reference ports that may not exist yet (dependency ordering)

**Test coverage**:
```typescript
it('emits PortMissing error for nonexistent publisher port', () => {
  // Block has output 'foo', publisher references 'bar'
  // Expect: PortMissing error with clear message
});

it('emits PortMissing error for nonexistent wire source port', () => {
  // Wire from block-1.baz, but block-1 only has outputs [foo, bar]
  // Expect: PortMissing error
});
```

---

## Dependency Graph

```
P0 Build Fix (BindingEndpoint migration)
  ↓
  ├─→ P0 Port Rename (phaseA → phase)
  └─→ P1 Port Validation (compileBusAware.ts)
```

**Execution order**:
1. Fix build errors first (enables testing)
2. Rename port (fixes macro errors)
3. Add validation (prevents future port mismatch bugs)

---

## Recommended Sprint Planning

### Sprint Execution Phases

**Phase 1: Restore Build** (4-6 hours)
- Complete P0 Build Fix
- Verify `just typecheck` passes
- Verify `just test` runs (tests may fail, but must execute)

**Phase 2: Fix Macros** (1-2 hours)
- Complete P0 Port Rename
- Verify macro expansion succeeds
- Test macro compilation end-to-end

**Phase 3: Add Validation** (1-2 hours)
- Complete P1 Port Validation
- Add test coverage for validation
- Verify clear error messages

**Total estimated effort**: 6-10 hours

### Testing Strategy

**After Phase 1**:
- `just typecheck` must pass
- `just test` must run (even if some tests fail)

**After Phase 2**:
- All macro templates must expand without errors
- Patches using `CycleTimeRoot` must compile
- No `UpstreamError` for phase port references

**After Phase 3**:
- Intentionally broken patches emit `PortMissing` errors
- Error messages are clear and actionable

---

## Risk Assessment

### Low Risk Items
- **P0 Build Fix**: Mechanical search/replace, TypeScript catches errors
- **P0 Port Rename**: Only 3 file changes, no production patches affected
- **P1 Port Validation**: Additive change, doesn't modify existing logic

### Medium Risk Items
- None identified for this sprint

### High Risk Items (Deferred)
- **Type-based port resolution**: Changes core compiler graph building logic
- **Composite port maps**: Requires new composite definition format
- **SlotId stability enforcement**: Needs versioning/migration system

### Mitigation Strategies

1. **Incremental verification**: Run `just typecheck` after each file modified
2. **Test-driven validation**: Write failing test first, then implement fix
3. **Rollback plan**: Git commits after each completed work item
4. **Scope discipline**: Do NOT expand scope to include type-based matching or composite fixes

---

## Blockers and Questions

### Pre-Sprint Blockers
- None (user has confirmed all decisions)

### Potential In-Sprint Blockers
- **Unknown port references**: If codebase has hard-coded references to `phaseA` outside TimeRoot, they'll break
  - **Mitigation**: Search entire codebase for `phaseA` string literal before renaming
- **Test failures unrelated to port changes**: Build fix may expose existing test failures
  - **Mitigation**: Document pre-existing failures, only fix regressions introduced by this sprint

### Open Questions (Deferred)
- **Q1**: Should we add `wrap` Event output to `CycleTimeRoot` (per spec)?
  - **Decision**: Defer to separate sprint (not blocking macros)
- **Q2**: Should internal variable names (`phaseA` function) be renamed to `phase`?
  - **Decision**: Rename only if trivial, don't spend time on it
- **Q3**: Should we add backward compatibility for `phaseA` references?
  - **Decision**: No (no production patches exist)

---

## Evidence & References

### Spec Documents
- `design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md` - Port identity system
- `design-docs/10-Refactor-for-UI-prep/3.5-PhaseClock-Fix.md` - TimeRoot spec (outputs `phase`)
- `design-docs/3-Synthesized/02-Time-Architecture.md` - Time system architecture

### Source Files
- `src/editor/types.ts:164-170` - `BindingEndpoint` interface definition
- `src/editor/blocks/time-root.ts:66` - `CycleTimeRoot` block definition
- `src/editor/compiler/blocks/domain/TimeRoot.ts:63` - `CycleTimeRoot` compiler
- `src/editor/macros.ts` - 24 references to `fromSlot: 'phase'`
- `src/editor/compiler/compileBusAware.ts` - Missing port validation
- `src/editor/compiler/compile.ts:241-259` - Reference port validation implementation

### Grep Results
- **BindingEndpoint errors**: 70+ occurrences across 7+ files
- **Macro phase references**: 24 occurrences in macros.ts
- **Port validation pattern**: Found in compile.ts, missing in compileBusAware.ts

---

## Success Criteria (Sprint Acceptance)

### Must Have (Sprint Cannot Close Without These)
1. ✅ Zero TypeScript compilation errors (`just typecheck` passes)
2. ✅ All tests execute without TypeScript errors (`just test` runs)
3. ✅ Macros expand and compile successfully (no `UpstreamError` on phase ports)
4. ✅ Port validation emits `PortMissing` errors for nonexistent ports

### Should Have (Desired but Not Blocking)
1. ✅ All existing tests pass (no new test failures introduced)
2. ✅ Error messages are clear and actionable
3. ✅ No hard-coded `phaseA` references remain in codebase

### Nice to Have (Bonus)
1. Internal variable consistency (rename `phaseA` variables to `phase`)
2. Additional test coverage for port validation edge cases
3. Documentation updates explaining port naming conventions

---

**Plan End**
