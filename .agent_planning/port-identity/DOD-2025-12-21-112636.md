# Definition of Done: Port Identity Quick Fix

**Generated**: 2025-12-21-112636
**Plan**: PLAN-2025-12-21-112636.md
**Topic**: Port Identity - Fix Macro UpstreamError
**Sprint Goal**: Restore buildable state and fix macro compilation errors

---

## Acceptance Criteria

### P0: Build Fix - Complete BindingEndpoint Migration

**Build Compilation**
- [ ] Zero TypeScript compilation errors related to `BindingEndpoint.port`
- [ ] `just typecheck` command passes without errors
- [ ] All files using `BindingEndpoint` updated to `{ blockId, slotId, dir }` format

**File Updates**
- [ ] `src/editor/__tests__/bus-compilation.test.ts` - All binding endpoints updated
- [ ] `src/editor/__tests__/field-bus-compilation.test.ts` - All binding endpoints updated
- [ ] `src/editor/stores/__tests__/BusStore.events.test.ts` - All binding endpoints updated
- [ ] `src/editor/diagnostics/__tests__/ActionExecutor.test.ts` - All binding endpoints updated
- [ ] `src/editor/diagnostics/ActionExecutor.ts` - All binding endpoints updated
- [ ] `src/editor/compiler/unified/__tests__/RuntimeAdapter.test.ts` - All binding endpoints updated
- [ ] `src/editor/compiler/unified/__tests__/UnifiedCompiler.test.ts` - All binding endpoints updated

**Functional Verification**
- [ ] `just test` executes (tests run, even if some fail)
- [ ] No runtime regressions in bus publisher/listener functionality
- [ ] Bus Inspector UI shows correct port references (if testable)

---

### P0: Port Rename - CycleTimeRoot phaseA → phase

**Block Definition Changes**
- [ ] `src/editor/blocks/time-root.ts:66` - Output renamed from `phaseA` to `phase`
- [ ] Label updated to `'Phase'` (remove " A" suffix)
- [ ] Output type remains `'Signal<phase>'` (unchanged)

**Compiler Changes**
- [ ] `src/editor/compiler/blocks/domain/TimeRoot.ts:63` - Output renamed from `phaseA` to `phase`
- [ ] Return statement key renamed from `phaseA` to `phase` (line 90-92)
- [ ] Internal function variable `phaseA` optionally renamed to `phase` (not required)

**Macro Compatibility**
- [ ] All macro templates continue using `fromSlot: 'phase'` (no changes needed)
- [ ] Macro expansion succeeds without errors
- [ ] Macro compilation completes without `UpstreamError`

**Verification**
- [ ] Test patch with `CycleTimeRoot` compiles successfully
- [ ] Phase signal propagates through macro-expanded blocks
- [ ] No references to `phaseA` remain in TimeRoot block or compiler code
- [ ] Codebase search for `'phaseA'` returns zero results in relevant files

---

### P1: Port Validation - Add Missing Checks to compileBusAware

**Validation Implementation**
- [ ] Port existence check added to `src/editor/compiler/compileBusAware.ts`
- [ ] Validation runs before graph building (fail fast)
- [ ] Publisher `from.slotId` existence verified against block outputs
- [ ] Wire connection `from.slotId` existence verified against block outputs

**Error Handling**
- [ ] Missing port references emit `PortMissing` diagnostic error
- [ ] Error message includes: block ID, port/slotId name, and context
- [ ] Error format matches compile.ts pattern: `{ code, message, where }`
- [ ] `where` field includes `{ blockId, port, dir }` for traceability

**Test Coverage**
- [ ] Test case: Nonexistent publisher port emits `PortMissing` error
- [ ] Test case: Nonexistent wire source port emits `PortMissing` error
- [ ] Test case: Error message is clear and actionable
- [ ] Test case: Valid port references do not trigger false positives

**Integration**
- [ ] Validation integrated into existing compileBusAware flow
- [ ] No breaking changes to existing valid patches
- [ ] Error collection follows existing diagnostic pattern

---

## Sprint Scope

### This Sprint Delivers

**Build Restoration**
- TypeScript compilation succeeds
- Test suite executes without compilation errors

**Macro Functionality**
- Macros expand without port mismatch errors
- `CycleTimeRoot` output aligns with spec (`phase` not `phaseA`)

**Error Quality**
- Port validation prevents cryptic `UpstreamError` messages
- Clear diagnostic errors guide developers to fix port issues

### Deferred to Future Sprints

**Type-Based Port Resolution**
- Match ports by type compatibility (not just string names)
- Resolve ports through composite boundaries
- Type-based fallback when slotId not found

**Stable SlotId System**
- SlotId versioning and migration
- Deprecation warnings for removed ports
- Compile errors for deprecated slotId references

**Composite Boundary Enforcement**
- `portMap` in composite definitions
- External-to-internal port mapping
- Bus listener addressability after composite expansion

---

## Verification Checklist

### Manual Testing

**Build Health**
- [ ] Run `just typecheck` - passes with zero errors
- [ ] Run `just test` - executes without TypeScript errors
- [ ] Run `just build` - production build succeeds

**Macro Expansion**
- [ ] Open editor, add macro block (any macro using TimeRoot)
- [ ] Verify macro expands into visible blocks
- [ ] Verify no console errors related to port resolution
- [ ] Verify compiled output includes phase signal

**Port Validation**
- [ ] Manually create invalid patch (reference nonexistent port)
- [ ] Verify compilation fails with `PortMissing` error
- [ ] Verify error message clearly identifies missing port
- [ ] Verify error location points to correct block/port

### Automated Testing

**Test Suite**
- [ ] All existing tests pass (no new failures introduced)
- [ ] New validation tests pass (port existence checks)
- [ ] Regression tests pass (build fix didn't break functionality)

**Type Safety**
- [ ] No `@ts-ignore` or `@ts-expect-error` added
- [ ] No type assertions (`as`) used to bypass errors
- [ ] All BindingEndpoint usages properly typed

---

## Rollback Criteria

**If any of these occur, STOP and rollback:**

1. **Build fails after changes**: TypeScript errors not related to incomplete migration
2. **Test failures increase**: Existing passing tests start failing
3. **Runtime errors in UI**: Editor crashes or becomes unusable
4. **Scope creep detected**: Attempting type-based resolution or composite fixes

**Rollback procedure**:
1. Revert all changes to last stable commit
2. Document blocker in planning file
3. Escalate to user for clarification

---

## Definition of Done Summary

**Sprint is complete when:**

✅ Build compiles (`just typecheck` passes)
✅ Tests execute (`just test` runs)
✅ Macros work (no `UpstreamError` on phase port)
✅ Port validation implemented (clear `PortMissing` errors)
✅ All acceptance criteria above are checked
✅ No scope creep (deferred items remain deferred)

**Files modified (expected)**:
- 7+ files for BindingEndpoint migration
- 2 files for port rename (block + compiler)
- 1 file for port validation (compileBusAware.ts)
- 3+ test files for validation coverage

**Ready for**: `/dev-loop:implement` or manual implementation following this plan

---

**DOD End**
