# Implementation Plan: Port Identity Fix

**Date**: 2025-12-21
**DOD**: .agent_planning/port-identity/DOD-2025-12-21.md
**Spec**: design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md

---

## Phase 1: Type Definitions

### Step 1.1: Update BindingEndpoint

**File**: `src/editor/types.ts:164-170`

**Current**:
```typescript
export interface BindingEndpoint {
  readonly blockId: BlockId;
  readonly port: string;
}
```

**Target**:
```typescript
export interface BindingEndpoint {
  readonly blockId: BlockId;
  readonly slotId: string;
  readonly dir: 'input' | 'output';
}
```

### Step 1.2: Update CompositeConnection

**File**: `src/editor/types.ts:490-505`

**Current**:
```typescript
export interface CompositeConnection {
  readonly id: string;
  readonly from: {
    readonly blockId: BlockId;
    readonly port: string;
  };
  readonly to: {
    readonly blockId: BlockId;
    readonly port: string;
  };
}
```

**Target**:
```typescript
export interface CompositeConnection {
  readonly id: string;
  readonly from: {
    readonly blockId: BlockId;
    readonly slotId: string;
  };
  readonly to: {
    readonly blockId: BlockId;
    readonly slotId: string;
  };
}
```

---

## Phase 2: Store Updates

### Step 2.1: BusStore.ts

**Changes needed**:
1. `addPublisher()` - change `port` param to `slotId`, add `dir: 'output'`
2. `addListener()` - change `port` param to `slotId`, add `dir: 'input'`
3. All queries using `.from.port` → `.from.slotId`
4. All queries using `.to.port` → `.to.slotId`

### Step 2.2: CompositeStore.ts

**Changes needed**:
1. Connection creation: `conn.from.port` → `conn.from.slotId`
2. Connection creation: `conn.to.port` → `conn.to.slotId`

### Step 2.3: PatchStore.ts

**Changes needed**:
1. `replaceBlock()` - update publisher/listener port references
2. Connection filtering - already uses slotId (good!)

---

## Phase 3: Compiler Updates

### Step 3.1: compile.ts

**Changes needed**:
1. Wire validation: `c.from.port` → `c.from.slotId` (already correct!)
2. Error messages: update port references in diagnostic `where` objects

### Step 3.2: compileBusAware.ts

**Changes needed**:
1. Publisher resolution: `pub.from.port` → `pub.from.slotId`
2. Listener resolution: `listener.to.port` → `listener.to.slotId`
3. `keyOf()` calls using port → slotId

### Step 3.3: integration.ts

**Changes needed**:
1. Composite expansion rewriting
2. Port mapping resolution
3. Error reporting

### Step 3.4: error-decorations.ts

**Changes needed**:
1. `addPort()` calls: use slotId
2. Wire matching logic

---

## Phase 4: UI Component Updates

### Step 4.1: Inspector.tsx

Already uses `slotId` for connections - verify consistency with bus bindings

### Step 4.2: BusChannel.tsx

**Changes needed**:
1. Publisher label: `pub.from.port` → `pub.from.slotId`
2. Title attribute updates

### Step 4.3: BusInspector.tsx

**Changes needed**:
1. Publisher display: `publisher.from.port` → `publisher.from.slotId`
2. Listener display: `listener.to.port` → `listener.to.slotId`

### Step 4.4: BusPicker.tsx / PublishMenu.tsx

**Changes needed**:
1. Matching logic: `.port` → `.slotId`

---

## Phase 5: Test Updates

### Step 5.1: Update test fixtures

All test files creating publishers/listeners need:
- `from: { blockId, port }` → `from: { blockId, slotId, dir: 'output' }`
- `to: { blockId, port }` → `to: { blockId, slotId, dir: 'input' }`

### Step 5.2: Update assertions

Assertions checking `.from.port` → `.from.slotId`
Assertions checking `.to.port` → `.to.slotId`

---

## Execution Order

1. **types.ts** - Change interfaces (will cause compile errors everywhere)
2. **BusStore.ts** - Fix store methods
3. **compileBusAware.ts** - Fix compiler bus handling
4. **compile.ts** - Fix wire validation
5. **integration.ts** - Fix composite expansion
6. **error-decorations.ts** - Fix error decoration
7. **CompositeStore.ts** - Fix composite connections
8. **PatchStore.ts** - Fix replace logic
9. **UI components** - Fix displays
10. **Utilities** - Fix helpers
11. **Tests** - Fix all test fixtures
12. **Run full test suite**

---

## Helper Functions to Add

```typescript
// src/editor/portUtils.ts

/**
 * Infer direction from block and slotId.
 * Returns 'input' if slotId is in block's inputs, 'output' if in outputs.
 */
export function inferPortDirection(
  block: Block,
  slotId: string
): 'input' | 'output' {
  if (block.inputs.some(s => s.id === slotId)) return 'input';
  if (block.outputs.some(s => s.id === slotId)) return 'output';
  throw new Error(`Slot ${slotId} not found on block ${block.id}`);
}

/**
 * Create BindingEndpoint with direction inference.
 */
export function createEndpoint(
  block: Block,
  slotId: string
): BindingEndpoint {
  return {
    blockId: block.id,
    slotId,
    dir: inferPortDirection(block, slotId),
  };
}
```

---

## Commit Strategy

Single atomic commit:
```
feat(types): Use slotId + dir for port identity

- Replace BindingEndpoint.port with slotId + dir
- Update Publisher/Listener to use canonical port refs
- Update CompositeConnection to use slotId
- Fix all compiler, store, and UI usages
- Update all tests

This establishes ONE canonical addressing scheme for ports,
fixing "bus listeners don't work through composites" class of bugs.

Spec: design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md
```
