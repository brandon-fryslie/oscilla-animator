# Implementation Plan: Console Clear on Macro Load

**Generated**: 2025-12-20-135216
**Source**: STATUS-20251220.md
**Topic**: console-clear-on-macro
**Complexity**: TRIVIAL

---

## Executive Summary

**Current State**: LogStore has `autoClearOnMacro` setting and `clear()` method. UI checkbox exists. Macro expansion hook is missing.

**Gap**: 3-line integration to call `logStore.clear()` when `autoClearOnMacro` is enabled during macro expansion.

**Recommended Approach**: Use existing singleton pattern (no RootStore integration needed). Add conditional clear after `clearPatch()` in `PatchStore.expandMacro()`.

---

## Work Items

### [P0] Add Log Clear Hook to Macro Expansion

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: None
**Spec Reference**: N/A (UX enhancement) • **Status Reference**: STATUS-20251220.md lines 49-67, 185-193

#### Description
Add 3-line hook in `PatchStore.expandMacro()` to clear logs when `autoClearOnMacro` setting is enabled. Uses existing singleton `logStore` (no RootStore changes needed).

#### Acceptance Criteria
- [ ] Import `logStore` singleton at top of `src/editor/stores/PatchStore.ts`
- [ ] Add conditional clear immediately after `this.root.clearPatch()` call (line 231)
- [ ] Implementation checks `logStore.autoClearOnMacro` before calling `logStore.clear()`
- [ ] TypeScript compilation succeeds (`just typecheck`)

#### Technical Notes
**Location**: `src/editor/stores/PatchStore.ts` line 231
**Pattern**:
```typescript
// Add import at top
import { logStore } from '../logStore';

// In expandMacro method, after clearPatch() call
expandMacro(expansion: MacroExpansion): BlockId {
  this.root.clearPatch();

  // Clear logs if auto-clear enabled
  if (logStore.autoClearOnMacro) {
    logStore.clear();
  }

  // ... rest of expansion
}
```

**Rationale**: Clearing logs after `clearPatch()` ensures patch-clearing logs are also removed, giving fresh state for new macro.

---

### [P1] Add Test Coverage for Auto-Clear Behavior

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P0 (implementation must exist to test)
**Spec Reference**: N/A • **Status Reference**: STATUS-20251220.md lines 149-159, 195-200

#### Description
Create test file to verify log clearing behavior during macro expansion, covering both enabled and disabled auto-clear states.

#### Acceptance Criteria
- [ ] Create test file `src/editor/__tests__/macro-log-clear.test.ts`
- [ ] Test case: Logs cleared when `autoClearOnMacro = true` during macro expansion
- [ ] Test case: Logs preserved when `autoClearOnMacro = false` during macro expansion
- [ ] Test case: Setting toggle persists across multiple macro expansions
- [ ] All tests pass (`just test`)

#### Technical Notes
**Test Structure**:
```typescript
describe('Macro expansion log clearing', () => {
  it('clears logs when autoClearOnMacro is enabled', () => {
    // Setup: create logs, set autoClearOnMacro = true
    // Action: expand macro
    // Assert: logStore.entries.length === 0
  });

  it('preserves logs when autoClearOnMacro is disabled', () => {
    // Setup: create logs, set autoClearOnMacro = false
    // Action: expand macro
    // Assert: logStore.entries.length > 0
  });
});
```

---

### [P2] Manual Smoke Test

**Status**: Not Started
**Effort**: Small (5 minutes)
**Dependencies**: P0 (implementation), P1 (tests)
**Spec Reference**: N/A • **Status Reference**: STATUS-20251220.md lines 211-218

#### Description
Manual verification of UX behavior to ensure feature works as expected in real usage.

#### Acceptance Criteria
- [ ] Open app, add multiple log entries manually
- [ ] Load a macro from preset library (e.g., "Breathing Constellation")
- [ ] Verify logs are cleared when auto-clear is enabled (default)
- [ ] Disable "Auto-clear" checkbox in LogWindow
- [ ] Load macro again, verify logs are preserved
- [ ] Re-enable "Auto-clear", load macro, verify logs cleared again

#### Technical Notes
Use existing macros from `src/editor/macros.ts` for testing (e.g., `macro:breathingConstellation`).

---

## Dependency Graph

```
P0: Add Log Clear Hook (REQUIRED)
  ↓
P1: Add Test Coverage (tests the hook)
  ↓
P2: Manual Smoke Test (validates UX)
```

**Critical Path**: P0 → P1 → P2 (linear, no parallelization)

---

## Recommended Sprint Planning

### Sprint 1: Complete Implementation (1 hour total)
- **Deliverables**: P0 (hook), P1 (tests), P2 (smoke test)
- **Goal**: Feature complete and validated

**Work order**:
1. P0: Add 3-line hook (15 min)
2. P1: Write tests (30 min)
3. P2: Manual verification (5 min)

---

## Risk Assessment

### Risk: LogStore Singleton vs. RootStore Pattern
- **Likelihood**: N/A (decision made)
- **Impact**: None
- **Mitigation**: Use existing singleton pattern (STATUS recommends this, lines 177-179)
- **Status**: RESOLVED

### Risk: Side Effects of Clearing Logs
- **Likelihood**: Low
- **Impact**: User might lose debugging info
- **Mitigation**: Feature is user-configurable via `autoClearOnMacro` setting (default: enabled, can be toggled off)
- **Status**: MITIGATED

### Risk: Timing - Clear Before or After Expansion
- **Likelihood**: N/A (order defined)
- **Impact**: None
- **Mitigation**: Clear after `clearPatch()` but before block creation (STATUS lines 138-148)
- **Status**: RESOLVED

---

## Out of Scope

The following are explicitly NOT part of this sprint:
- [ ] Integrating LogStore into RootStore (singleton pattern is sufficient)
- [ ] Adding undo/redo for log clearing (not requested)
- [ ] Persisting auto-clear setting across sessions (not requested)
- [ ] Adding log export/save functionality (separate feature)

---

## Success Metrics

**Definition of Done**:
1. Macro expansion clears logs when `autoClearOnMacro = true`
2. Logs preserved when `autoClearOnMacro = false`
3. Tests pass (`just test`)
4. Type checking passes (`just typecheck`)
5. Manual smoke test successful

**Total Complexity**: TRIVIAL (1 hour)
**Total Risk**: NONE
**Blockers**: NONE
