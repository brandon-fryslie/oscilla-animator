# Definition of Done: Compiler IR-Only Blockers - Sprint 0

**Generated:** 2025-12-28-165200
**Plan:** PLAN-2025-12-28-165200.md
**Source:** STATUS-2025-12-28-154700.md

---

## Sprint Scope

This sprint delivers **2 critical blockers only:**
1. Block registry capability propagation fix
2. IR compilation made mandatory (no fallback)

**Deferred:** All other red flags (TimeModel, bus lowering, block lowering, type conversions, etc.)

---

## Acceptance Criteria

### Deliverable 1: Block Registry Capability Propagation

**Goal:** Make all test files loadable

- [ ] `createBlock()` factory in `src/editor/blocks/factory.ts` automatically sets `capability` field based on KERNEL_PRIMITIVES lookup
- [ ] All 21 blocks with capability mismatch (DomainN, GridDomain, SVGSampleDomain, RenderInstances2D, RenderPaths2D, Render2dCanvas, IntegrateBlock, HistoryBlock, TriggerOnWrap, PulseDivider, EnvelopeAD, and 10 pure blocks) now validate correctly
- [ ] All 27 test files that previously failed at import with registry validation errors now load successfully
- [ ] `just typecheck` passes with no TypeScript errors
- [ ] `just test` runs all test files (tests may fail, but files MUST load)
- [ ] Test baseline documented showing pass/fail counts after registry fix

**Success Condition:** Block registry validation passes, all test files load.

**Verification:**
```bash
just typecheck  # Must pass
just test       # Must load all 127 test files
```

---

### Deliverable 2: IR Compilation Made Mandatory

**Goal:** Eliminate silent fallback to legacy closure-based execution

- [ ] `compileBusAware.ts` has NO conditional IR emission logic (no `if (!emitIR)` early return)
- [ ] IR build failures throw fatal errors instead of warnings
- [ ] Attempting to compile with IR disabled results in compilation error
- [ ] Feature flag `useUnifiedCompiler` documentation clarifies IR is always emitted when unified compiler is active
- [ ] Trivial patch (FiniteTimeRoot → Render2dCanvas) compiles and executes in IR-only mode without fallback
- [ ] Tests verify compilation throws hard errors when encountering unlowered blocks or IR generation failures

**Success Condition:** IR-only mode is enforced; no silent legacy fallback exists.

**Verification:**
```bash
# Create trivial test patch
# Verify CompiledProgramIR is populated
# Verify no closure fallback occurs
# Test with unlowered block → must throw error
```

---

## Known Limitations After Sprint 0

**These are EXPECTED and do NOT block sprint completion:**

- Most patches will fail compilation due to missing Pass 6 block lowering
- TimeModel is still hardcoded to infinite (finite/cyclic patches fail)
- Bus evaluation steps not emitted (bus-driven patches fail)
- Default sources not lowered (required inputs with defaults fail)
- Event buses not lowered (event-driven logic fails)
- Type conversions not implemented (implicit conversions fail)

**This is CORRECT BEHAVIOR** - we want visible failures, not silent legacy fallback.

---

## Definition of NOT Done

**The following are explicitly OUT OF SCOPE for Sprint 0:**

- TimeModel threading from Pass 3 to schedule
- Pass 6 block lowering implementation
- Default source lowering implementation
- Bus evaluation step implementation
- timeDerive tAbsMs slot write
- Event bus lowering
- Type conversion paths
- ColorLFO HSL→RGB kernel
- SVGSampleDomain initialization fix
- DebugDisplay block decision
- Transform chain implementation
- Type system unification
- Feature flag parsing bug fix

---

## Test Baseline Requirements

**After completing both deliverables:**

1. **Document test results:**
   - Total test files: 127
   - Files that load: 127 (was 100 before fix)
   - Tests that pass: X
   - Tests that fail: Y
   - Expected failures documented (due to missing IR features)

2. **Categorize failures:**
   - Registry validation failures: 0 (was 27)
   - IR compilation failures: X (expected due to missing lowering)
   - Runtime failures: Y (expected due to incomplete IR)
   - Regression failures: 0 (any regressions are blockers)

3. **Create smoke test:**
   - Minimal patch that SHOULD work: FiniteTimeRoot → Render2dCanvas
   - Verify IR compilation succeeds
   - Verify schedule generation succeeds
   - Document any failures for Sprint 1

---

## Files Modified (Complete List)

**ONLY these files should be modified in Sprint 0:**

1. `/Users/bmf/code/oscilla-animator_codex/src/editor/blocks/factory.ts`
   - Enhanced `createBlock()` function

2. `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/compileBusAware.ts`
   - Removed conditional IR emission
   - Made IR failures fatal

**Possibly:**
3. Test files that expect warnings instead of errors (update assertions)

**That's all.** Any other file modifications are out of scope.

---

## Success Criteria Summary

**Sprint 0 is DONE when:**

✅ All 27 previously-failing test files load
✅ Block registry validation passes for all blocks
✅ IR compilation is mandatory with no silent fallback
✅ Test baseline established and documented
✅ Clear path to Sprint 1 documented

**Sprint 0 is NOT done if:**

❌ Any test files still fail at import due to registry validation
❌ IR compilation can silently fall back to legacy
❌ Changes made to files outside the approved list above
❌ Test baseline not documented

---

## Post-Sprint Deliverables

**Documentation to create:**

1. Test baseline report:
   - Pass/fail counts
   - Categorized failures
   - Comparison to pre-fix state

2. Sprint 1 plan outline:
   - TimeModel threading (2 days)
   - timeDerive tAbsMs (1 day)
   - Default sources (3 days)
   - Feature flag fix (1 hour)

3. Updated STATUS file confirming:
   - Registry fix complete
   - IR mandatory complete
   - Sprint 0 done, Sprint 1 ready

---

## Timeline

**Estimated:** 8-12 hours total (1-1.5 days)

**Breakdown:**
- Deliverable 1: 4-6 hours
- Deliverable 2: 2-4 hours
- Testing and baseline: 2 hours

---

## Risk Mitigation

**Medium Risk: IR Mandatory exposes many failures**

**Mitigation:**
- Document expected failures clearly
- Create helpful error messages for missing lowering
- Baseline results to distinguish regression from expected
- Communicate that failures are CORRECT BEHAVIOR (not bugs)

**Low Risk: Registry fix is mechanical**

**Mitigation:** None needed - straightforward fix.

---

## Next Action After Sprint 0

**Immediate:**
Start Sprint 1 planning with focus on:
1. TimeModel threading
2. timeDerive tAbsMs write
3. Default source lowering
4. Feature flag parsing

**Reference:** STATUS-2025-12-28-154700.md § "Sprint 1: Core IR Execution"
