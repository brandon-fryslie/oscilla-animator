# Sprint 0: Unblock Test Infrastructure

**Generated:** 2025-12-28-154800
**Source STATUS:** STATUS-2025-12-28.md
**Topic:** compiler-audit-redflag

---

## Sprint Goal

Restore test infrastructure by fixing block registry capability propagation so all 27 failing test files can load and run.

---

## Scope

### In Scope (Sprint 0 - 1 Day)

1. Fix block registry capability mismatch (21 blocks)
2. Verify all test files load without registry errors
3. Baseline test suite state (document which tests pass/fail and why)

### Out of Scope (Future Sprints)

- IR compiler red flags (43 issues documented)
- Block lowering implementation (Pass 6 placeholders)
- Bus evaluation implementation
- TimeModel threading
- Type conversion paths
- All other Critical/High/Medium issues

**Rationale:** The test infrastructure blocker prevents runtime verification of any compiler fixes. Must unblock testing before addressing deeper IR issues.

---

## Work Items

### P0-1: Fix Block Registry Capability Propagation

**Status:** Not Started
**Effort:** Small (4-6 hours)
**Dependencies:** None
**Spec Reference:** N/A (infrastructure fix)
**Status Reference:** STATUS-2025-12-28.md lines 23-100

#### Description

The block registry validation fails at module load because BlockDefinition objects created by `registerBlockType()` in `/src/editor/compiler/blocks/` do not have their `capability` field set, despite the registration calls specifying capabilities. This causes 21 blocks to fail validation against `KERNEL_PRIMITIVES` allowlist.

**Root Cause:**
- `KERNEL_PRIMITIVES` (src/editor/blocks/kernel-primitives.ts:21-67) defines capabilities for 21 blocks
- Block compilers call `registerBlockType()` with `capability: 'identity'|'render'|'state'` etc.
- BlockDefinition interface may not be receiving or storing this capability value
- Registry validation (src/editor/blocks/registry-validation.ts:122) runs at module load and expects exact match

**Affected Blocks (21 total):**
- Identity (3): DomainN, GridDomain, SVGSampleDomain
- Render (3): RenderInstances2D, RenderPaths2D, Render2dCanvas
- State (5): IntegrateBlock, HistoryBlock, TriggerOnWrap, PulseDivider, EnvelopeAD
- Pure (10): JitterFieldVec2, FieldFromSignalBroadcast, FieldZipSignal, BroadcastSignalColor, PathConst, and 5 others

#### Acceptance Criteria

- [ ] All 21 blocks with capability mismatches have BlockDefinition.capability field correctly populated
- [ ] Registry validation passes at module load (no capability mismatch errors)
- [ ] All 27 previously failing test files can be imported without registry errors
- [ ] `registerBlockType()` function correctly propagates capability parameter to BlockDefinition object
- [ ] Zero test files fail at module load due to registry validation

#### Technical Notes

**Investigation Steps:**
1. Check BlockDefinition interface definition for capability field
2. Trace `registerBlockType()` implementation to see if capability is stored
3. Verify block compiler calls are passing capability correctly

**Likely Fix Locations:**
- `src/editor/blocks/registry.ts` - `registerBlockType()` implementation
- `src/editor/compiler/blocks/*/` - Block registration calls (verify correct format)
- `src/editor/blocks/registry-validation.ts` - Validation logic (ensure capability is read correctly)

**Fix Strategy:**
- Option A: Update `registerBlockType()` to propagate capability to BlockDefinition
- Option B: Update each block compiler registration call to set capability differently
- Option C: Fix BlockDefinition interface to include capability field

Recommend Option A (fix registration system once) over Option B (fix 21 callsites).

---

### P0-2: Verify Test Suite Baseline

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** P0-1 (registry fix must complete first)
**Spec Reference:** N/A (verification task)
**Status Reference:** STATUS-2025-12-28.md lines 14-18

#### Description

After fixing the registry issue, run the full test suite and document baseline state. The STATUS report indicates 99/127 files pass (1855 tests), but this is misleading because 27 files fail at import. We need to know:

- How many tests actually run when all files can load
- Which tests fail and why (existing bugs vs IR issues)
- Baseline for measuring future progress

This creates the foundation for evaluating IR compiler fixes.

#### Acceptance Criteria

- [ ] Full test suite runs with `just test` without module load failures
- [ ] Document total test count (files and individual tests)
- [ ] Document pass/fail breakdown with categories (e.g., "IR not implemented", "legacy bugs", "flaky")
- [ ] Create baseline report saved to `.agent_planning/compiler-audit-redflag/TEST-BASELINE-2025-12-28.md`
- [ ] Identify any NEW failures introduced by registry fix (should be zero)

#### Technical Notes

**Baseline Report Format:**
```markdown
# Test Baseline - Post Registry Fix
**Date:** 2025-12-28
**Context:** After fixing block capability propagation

## Summary
- Total test files: X
- Passing files: Y
- Failing files: Z
- Total tests: N
- Passing tests: M
- Failing tests: P

## Failure Categories
- IR not implemented: [list tests]
- Known bugs: [list tests]
- Flaky/timing: [list tests]
- Unknown: [list tests]
```

**Commands:**
```bash
just test 2>&1 | tee test-output.log
# Analyze output for patterns
```

---

### P0-3: Document Sprint 1 Entry Criteria

**Status:** Not Started
**Effort:** Small (1 hour)
**Dependencies:** P0-2 (baseline must exist)
**Spec Reference:** N/A (planning artifact)
**Status Reference:** STATUS-2025-12-28.md lines 332-363

#### Description

Create clear entry criteria for Sprint 1 (Core IR Execution) based on the test baseline. This ensures we don't start IR work until the testing foundation is solid.

The STATUS report recommends Sprint 1 focus on making IR mode mandatory and functional for simple patches. We need to define exactly what "functional test infrastructure" means before beginning that work.

#### Acceptance Criteria

- [ ] Document created at `.agent_planning/compiler-audit-redflag/SPRINT-1-ENTRY.md`
- [ ] Entry criteria include minimum test pass rate (e.g., "90% of compiler tests pass")
- [ ] Entry criteria include specific test categories that must work (e.g., "all store tests pass")
- [ ] Document identifies any remaining test infrastructure risks
- [ ] Document approved by running test suite and verifying all criteria met

#### Technical Notes

**Suggested Entry Criteria:**
- Block registry validation passes (zero capability mismatches)
- All test files load successfully (zero module import failures)
- Core compiler tests pass (BusStore, PatchStore, RootStore integration tests)
- Baseline documentation exists and is current

**Format:**
```markdown
# Sprint 1 Entry Criteria

## Must Have (Blocking)
- [ ] Criterion 1 (how to verify)
- [ ] Criterion 2 (how to verify)

## Should Have (Recommended)
- [ ] Criterion 3 (how to verify)

## Risks
- Known issue X may affect Y

## Verification
$ just test
# Expected: X/Y tests pass
```

---

## Dependency Graph

```
P0-1: Fix Registry
  ↓
  → All tests can import modules
  ↓
P0-2: Baseline Test Suite
  ↓
  → Know current state
  ↓
P0-3: Define Sprint 1 Entry Criteria
  ↓
  → Ready for IR compiler work
```

All items are sequential - each depends on previous completion.

---

## Recommended Execution Order

1. **P0-1** (4-6 hours) - Fix capability propagation
   - Investigate `registerBlockType()` implementation
   - Fix capability propagation bug
   - Verify registry validation passes
   - Confirm all test files import

2. **P0-2** (2-3 hours) - Run and document baseline
   - Execute `just test`
   - Categorize failures
   - Write baseline report

3. **P0-3** (1 hour) - Document Sprint 1 criteria
   - Define entry conditions
   - Verify against baseline
   - Mark ready for next sprint

**Total Effort:** 7-10 hours (1 day)

---

## Risk Assessment

### Low Risk
- **Registry fix is mechanical** - Once root cause is found, fix is straightforward (add capability field propagation)
- **No design decisions needed** - Pure bug fix, no architectural choices
- **Clear verification** - Tests either load or don't (binary pass/fail)

### Medium Risk
- **Unknown test failures** - Once all tests load, may discover new failure modes
  - **Mitigation:** Document baseline state, defer fixes to Sprint 1+
- **Registry validation side effects** - Fix may expose other validation issues
  - **Mitigation:** Fix reveals problems, which is good. Document and triage.

### Zero High Risk
- No high-risk items in this sprint (infrastructure only)

---

## Success Criteria (Sprint Complete When)

- [ ] Zero test files fail at module load
- [ ] Block registry validation passes for all 21 capability-declaring blocks
- [ ] Test baseline documented and saved
- [ ] Sprint 1 entry criteria defined and verified
- [ ] Ready to begin IR compiler work (Sprint 1)

---

## Deferred to Future Sprints

**Critical IR Issues (Sprint 1+):**
- IR build is optional and non-fatal (compileBusAware.ts:777)
- TimeModel hardcoded to infinite (IRBuilderImpl.ts:605)
- Pass 6 emits placeholder IR (pass6-block-lowering.ts:117)
- Default sources not lowered (pass8-link-resolution.ts:258)
- Bus evaluation absent from schedule (buildSchedule.ts:337)
- timeDerive doesn't write tAbsMs (executeTimeDerive.ts:36)
- Event buses not lowered (pass7-bus-lowering.ts:231)

**Total Deferred Issues:** 43 red flags (16 Critical, 17 High, 10 Medium)

**See:** STATUS-2025-12-28.md lines 120-278 for full catalog

---

## Questions / Ambiguities

None for Sprint 0 (pure infrastructure fix).

**For Sprint 1+, user decisions needed on:**
1. Block lowering migration strategy (incremental vs all-at-once)
2. Event bus IR representation design
3. DebugDisplay block fate (remove/rework/keep legacy)
4. Type system unification priority

**See:** STATUS-2025-12-28.md lines 426-494

---

## Files to Modify (Expected)

**Likely Changes:**
- `src/editor/blocks/registry.ts` - Fix `registerBlockType()`
- Possibly `src/editor/blocks/types.ts` - Update BlockDefinition interface

**Files to Read:**
- `src/editor/blocks/kernel-primitives.ts` - Understand expected capabilities
- `src/editor/blocks/registry-validation.ts` - Understand validation logic
- `src/editor/compiler/blocks/**/*.ts` - See registration patterns

**Files to Create:**
- `.agent_planning/compiler-audit-redflag/TEST-BASELINE-2025-12-28.md`
- `.agent_planning/compiler-audit-redflag/SPRINT-1-ENTRY.md`

---

## Validation Checklist

**Before starting:**
- [ ] STATUS-2025-12-28.md reviewed
- [ ] Test failure error messages understood
- [ ] Block registry code locations identified

**During work:**
- [ ] Registry validation error message changes (should disappear)
- [ ] Test import errors resolve
- [ ] No new errors introduced

**Sprint complete when:**
- [ ] All P0 acceptance criteria met
- [ ] Test baseline documented
- [ ] Sprint 1 entry criteria defined
- [ ] Zero blocking issues for IR work

---

## Next Steps (After Sprint 0)

**Sprint 1: Core IR Execution (1 week)**
- Make IR compilation mandatory (no fallback)
- Thread TimeModel from Pass 3 to schedule
- Fix timeDerive tAbsMs write
- Fix feature flag parsing bug

**See:** STATUS-2025-12-28.md lines 346-363 for full Sprint 1 plan
