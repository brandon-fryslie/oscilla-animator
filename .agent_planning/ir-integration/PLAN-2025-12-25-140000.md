# Sprint Plan: Phase 2 IR Data Structures Integration
Generated: 2025-12-25-140000
Source: STATUS-2025-12-25-140000.md

## Sprint Goal

Integrate missing Phase 2 IR schemas (SignalExprIR, OpCode registry, TransformChainIR, DefaultSourceTable) from the worktree into the main branch, enabling the "Program as Data" architecture.

## Scope

**In scope (this sprint):**
1. Integrate SignalExprIR and OpCode registry schemas
2. Integrate TransformChainIR and DefaultSourceTable schemas
3. Update CompiledProgramIR to use new schemas

**Explicitly out of scope (future sprints):**
- FieldExprIR full implementation (placeholder exists)
- Runtime executor updates to use new schemas
- Schema validation functions
- Tests migration from worktree

---

## Work Items

### P0: Integrate SignalExprIR and OpCode Registry

**Files to create:**
- `src/editor/compiler/ir/signalExpr.ts` - SignalExprIR, SignalExprTable, StatefulSignalOp
- `src/editor/compiler/ir/opcodes.ts` - OpCode enum, OPCODE_REGISTRY, OpCodeMeta

**Acceptance Criteria:**
- [ ] `signalExpr.ts` contains all 12 SignalExprIR variants from HANDOFF.md
- [ ] `opcodes.ts` contains OpCode enum with 50+ opcodes organized by category
- [ ] OPCODE_REGISTRY provides metadata for all opcodes
- [ ] Types use current branch TypeDesc structure (world, domain, semantics?, unit?)
- [ ] All imports resolve correctly
- [ ] `just typecheck` passes with no new errors

**Technical Notes:**
- Adapt worktree TypeDesc usage (`category`, `busEligible`) to current structure (`semantics`, `unit`)
- CombineSpec/CombineMode already exist in schedule.ts - import from there
- Import ValueSlot, BusIndex, StateId from types.ts

---

### P1: Integrate TransformChainIR and DefaultSourceTable

**Files to create:**
- `src/editor/compiler/ir/transforms.ts` - TransformTable, TransformChainIR, TransformStepIR, PureFnRef
- `src/editor/compiler/ir/defaultSources.ts` - DefaultSourceTable, DefaultSourceIR, UIControlHint

**Acceptance Criteria:**
- [ ] `transforms.ts` contains TransformTable with TransformChainIR entries
- [ ] TransformStepIR includes all step kinds: cast, map, scaleBias, normalize, quantize, ease, slew
- [ ] CastOp defines all type conversion operations
- [ ] `defaultSources.ts` contains DefaultSourceTable and DefaultSourceIR
- [ ] UIControlHint defines all editor control types
- [ ] All imports resolve correctly
- [ ] `just typecheck` passes with no new errors

**Technical Notes:**
- PureFnRef should reference OpCode from opcodes.ts
- TransformChainId type should be added to types.ts

---

### P2: Update Exports and CompiledProgramIR

**Files to modify:**
- `src/editor/compiler/ir/index.ts` - Add exports for new modules
- `src/editor/compiler/ir/types.ts` - Add missing index types (SigExprId, FieldExprId, TransformChainId)
- `src/editor/compiler/ir/program.ts` - Update placeholders to use real types

**Acceptance Criteria:**
- [ ] `index.ts` exports all new types
- [ ] `types.ts` includes SigExprId, FieldExprId, TransformChainId
- [ ] CompiledProgramIR references SignalExprTable (not placeholder)
- [ ] `just typecheck` passes
- [ ] `just test` passes (no regressions)

**Technical Notes:**
- FieldExprTable stays as placeholder for now
- LensTable and AdapterTable stay as placeholders

---

## Dependencies

- TypeDesc structure from `types.ts` must remain stable
- CombineSpec from `schedule.ts` is already correct

## Risks

| Risk | Mitigation |
|------|------------|
| Type conflicts between worktree and branch | Adapt worktree types to current TypeDesc |
| Breaking existing code | Run typecheck after each file |
| Import path issues | Use consistent relative imports |

## Success Metrics

- All new files compile without errors
- `just check` passes
- No changes needed to existing runtime code
