# Definition of Done: 3D Camera Configuration UI (FINAL)
**Generated:** 2025-12-27-101500
**Plan:** PLAN-2025-12-27-101500-FINAL.md

---

## Architecture Principles (Non-Negotiable)

1. **Camera outputs CameraRef** - resource reference (not signal/field), routes to sinks
2. **Explicit selection** - `program.defaultCameraId` always present, never null
3. **Epsilon validation** - Float comparisons use ε ≈ 1e-6
4. **Angle semantics explicit** - TypeDesc includes `semantics: 'angleDeg'` or `'angleRad'`

---

## Acceptance Criteria

### P0-1: Vec3 Default Source Editor

- [ ] Three inputs (X, Y, Z) render when `uiHint.kind === 'vec3'`
- [ ] Inputs parse/update single `{ x, y, z }` object
- [ ] Changing X preserves Y and Z
- [ ] Disabled when port is driven
- [ ] Paste JSON `{"x":1,"y":2,"z":3}` works
- [ ] Paste comma-separated `1, 2, 3` works

---

### P0-2: Camera Block with CameraRef Output

- [ ] Block type: `'Camera'`, category: `'Scene'`
- [ ] Block has ONE output: `camera` with type `{ world: 'special', domain: 'cameraRef' }`
- [ ] Inputs:
  - `position` (Signal<vec3>, default: {0,0,100})
  - `target` (Signal<vec3>, default: {0,0,0})
  - `up` (Signal<vec3>, default: {0,1,0})
  - `projectionKind` (Scalar<string>, select: perspective/orthographic)
  - `fovYDeg` (Signal<number>, semantics: angleDeg, slider 10-120)
  - `orthoHeight` (Signal<number>)
  - `near` (Signal<number>, default: 0.1)
  - `far` (Signal<number>, default: 1000)
- [ ] Vec3 editor renders for position/target/up
- [ ] Block registered in registry

---

### P0-3: CameraIR Schema (Locked)

- [ ] All convention fields use literal types: `'right'`, `'-Z'`, `'+Y'`
- [ ] `projection.fovYRad` is radians with `semantics: 'angleRad'`
- [ ] `pose.up` included (with default)
- [ ] `viewportPolicy: 'useRuntimeViewport'`
- [ ] `sourceBlockId` for error attribution
- [ ] `DEFAULT_CAMERA_IR` constant exported

**Angle Semantics (explicit):**
- Input port `fovYDeg`: `semantics: 'angleDeg'`
- IR field `fovYRad`: `semantics: 'angleRad'`
- Lowering converts deg → rad

---

### P1-1: Camera Compiler/Lowering

- [ ] `Camera.ts` in `compiler/blocks/scene/`
- [ ] `ctx.builder.addCamera(cameraIR)` API exists
- [ ] fovYDeg → fovYRad (× π/180)
- [ ] up defaults to (0,1,0) when not connected
- [ ] Output emits `{ kind: 'cameraRef', cameraId }`
- [ ] Camera ID = `camera-${blockId}`

---

### P1-2: Validation with Epsilon

**CAMERA_EPSILON = 1e-6**

- [ ] `CAMERA_INVALID_NEAR`: near ≤ 0
- [ ] `CAMERA_INVALID_FAR`: far ≤ near
- [ ] `CAMERA_DEGENERATE_LOOKAT`: `distance(position, target) < ε`
- [ ] `CAMERA_DEGENERATE_UP`: `|cross(viewDir, up)| < ε`
- [ ] `CAMERA_INVALID_FOV`: fovYDeg ≤ 1 or ≥ 179
- [ ] `CAMERA_INVALID_PROJECTION`: kind not in valid set
- [ ] All errors include `{ blockId, port }`
- [ ] Validation runs AFTER defaulting up

---

### P1-3: Explicit Camera Selection

- [ ] `program.defaultCameraId: CameraId` (never null)
- [ ] 0 cameras → inject `DEFAULT_CAMERA_IR` with id `'__default__'`
- [ ] 1 camera → that camera's ID is default
- [ ] N cameras → first by creation order is default (deterministic)
- [ ] **N > 1 cameras → emit warning:** `WARN_MULTIPLE_CAMERAS_USING_DEFAULT { defaultCameraId, cameraIds[] }`
- [ ] Warning surfaces in compile diagnostics (not silent)
- [ ] Implicit camera has `sourceBlockId: '__implicit__'`
- [ ] Render sinks can override with `cameraId?` (future-ready)

---

## Validation Checklist

### DevTools Verification

```javascript
const program = window.__DEBUG_PROGRAM__;

// Always present
console.assert(program.defaultCameraId !== null);
console.assert(program.defaultCameraId !== undefined);

// With 1 camera block
console.assert(program.cameras.length === 1);
console.assert(program.defaultCameraId === program.cameras[0].id);

// With 0 camera blocks
console.assert(program.cameras.length === 1);  // Implicit camera injected
console.assert(program.cameras[0].id === '__default__');
console.assert(program.defaultCameraId === '__default__');
```

### Error Testing

- [ ] Set near = 0 → `CAMERA_INVALID_NEAR`
- [ ] Set far = near → `CAMERA_INVALID_FAR`
- [ ] Set position = target = (0,0,0) → `CAMERA_DEGENERATE_LOOKAT`
- [ ] Set up = (0,0,-1) with target at (0,0,0), position at (0,0,100) → `CAMERA_DEGENERATE_UP`
- [ ] Set fovYDeg = 0 → `CAMERA_INVALID_FOV`

---

## Success Criteria

**Must Have:**
- Camera block with CameraRef output (not signal/field)
- `program.defaultCameraId` always present
- Epsilon-based validation
- DEFAULT_CAMERA_IR for 0-camera case

**Should Have:**
- All 6 validation rules
- Paste support in Vec3 editor

**Won't Have:**
- RenderInstances3D wiring
- Multi-camera picker UI
- Frustum preview
