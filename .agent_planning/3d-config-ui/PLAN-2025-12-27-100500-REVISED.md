# Sprint Plan: 3D Camera Configuration UI (REVISED)
**Generated:** 2025-12-27-100500
**Revision:** Addresses architecture missteps and adds required specifications

## Sprint Goal

Deliver camera configuration UI with correct resource-table architecture, locked IR contract, and compile-time validation.

---

## Architecture Corrections Applied

### Correction 1: Camera is a Resource, Not a Wire Output

**Wrong:** Camera block outputs a value that wires to render sinks.
**Correct:** Camera block contributes a `CameraIR` entry to `program.cameras` table. Render sinks reference `cameraId` (or `cameraIndex`) directly, not via graph edges.

This avoids forcing cameras through ValueSlots/adapters and keeps scheduling clean.

### Correction 2: No Lane Assumptions

Use `category: 'Scene'` in block registry. UI decides placement. No lane-specific code.

---

## Scope

**In scope (this sprint):**
1. Vec3 Default Source editor
2. Camera Block (resource contributor)
3. CameraIR schema + compile rules + diagnostics

**Explicitly out of scope:**
- RenderInstances3D block (future sprint)
- Mesh block definition (future sprint)
- Quaternion editor (using lookAt pattern)
- Camera frustum preview widget
- Multi-camera render target assignment

---

## Work Items

### P0-1: Vec3 Default Source Editor

**Goal:** Three numeric inputs (X/Y/Z) that bind to a single `vec3` value.

**File:** `src/editor/Inspector.tsx` or `src/editor/components/DefaultSourceControl.tsx`

**Requirements:**
- Renders three labeled inputs (X, Y, Z) when `uiHint.kind === 'vec3'`
- Parses `defaultSource.value` as `{ x: number, y: number, z: number }`
- On change, updates the entire vec3 object (preserves untouched fields)
- Disabled when driven (wired or bus-bound)
- Supports copy/paste of JSON `{"x":1,"y":2,"z":3}` or comma-separated `1,2,3`
- Styling matches existing `.param-xy` pattern (add `.param-xyz` class)

**Type Model (IMPORTANT):**
- The type remains `vec3` - do NOT degrade to three separate `number` types
- UI is a presentation layer over a single typed value

**Acceptance Criteria:**
- [ ] Three inputs render for any `vec3` uiHint
- [ ] Changing X preserves Y and Z values
- [ ] Inputs disabled when port is driven
- [ ] Paste `{"x":0,"y":5,"z":10}` populates all three fields
- [ ] Paste `0, 5, 10` also works (comma-separated)

---

### P0-2: Camera Block (Resource Contributor)

**Goal:** Block that contributes a camera to `program.cameras` table (NOT a wire output).

**Files:**
- `src/editor/blocks/camera.ts` (new - block definition)
- Block registry update

**Block Definition:**

```typescript
{
  type: 'Camera',
  category: 'Scene',  // NOT lane - category for UI grouping

  inputs: {
    // Position and target (lookAt)
    position: { type: 'Signal<vec3>', defaultSource: { x: 0, y: 0, z: 100 }, uiHint: { kind: 'vec3' } },
    target: { type: 'Signal<vec3>', defaultSource: { x: 0, y: 0, z: 0 }, uiHint: { kind: 'vec3' } },
    up: { type: 'Signal<vec3>', defaultSource: { x: 0, y: 1, z: 0 }, uiHint: { kind: 'vec3' }, optional: true },

    // Projection
    projectionKind: {
      type: 'Scalar<string>',
      defaultSource: 'perspective',
      uiHint: { kind: 'select', options: ['perspective', 'orthographic'] }
    },

    // Perspective params
    fovYDeg: { type: 'Signal<number>', defaultSource: 60, uiHint: { kind: 'slider', min: 10, max: 120 } },

    // Orthographic params
    orthoHeight: { type: 'Signal<number>', defaultSource: 10, uiHint: { kind: 'number' } },

    // Clip planes
    near: { type: 'Signal<number>', defaultSource: 0.1, uiHint: { kind: 'number', min: 0.001 } },
    far: { type: 'Signal<number>', defaultSource: 1000, uiHint: { kind: 'number' } },
  },

  outputs: {
    // NO OUTPUTS - camera is a resource, not a wire value
  },

  // Resource contribution marker
  contributes: 'camera',
}
```

**Critical: No Outputs**
Camera does NOT output a value slot. It contributes to a resource table.

**Acceptance Criteria:**
- [ ] Camera block appears in block library under Scene category
- [ ] Block has NO output ports (verify visually)
- [ ] Inspector shows all inputs with correct controls
- [ ] Vec3 editor appears for position/target/up
- [ ] Dropdown for projection kind
- [ ] Slider for FOV (10-120 range)
- [ ] Number inputs for orthoHeight, near, far

---

### P0-3: CameraIR Schema (Locked Contract)

**Goal:** Define authoritative CameraIR schema with conventions locked.

**File:** `src/editor/compiler/ir/types3d.ts` (update existing)

**Canonical CameraIR:**

```typescript
export interface CameraIR {
  /** Unique ID: `camera-${blockId}` */
  id: CameraId;

  /** Coordinate conventions (LOCKED - do not change) */
  handedness: 'right';      // Right-handed coordinate system
  forwardAxis: '-Z';        // Camera looks down -Z
  upAxis: '+Y';             // +Y is up

  /** Projection type */
  projection: {
    kind: 'perspective' | 'orthographic';
    near: number;           // > 0, in world units
    far: number;            // > near, in world units

    // Perspective (ignored for ortho)
    fovYRad: number;        // Vertical FOV in RADIANS (0, π)

    // Orthographic (ignored for perspective)
    orthoHeight: number;    // World units visible vertically
  };

  /** LookAt-based pose */
  pose: {
    position: { x: number; y: number; z: number };
    target: { x: number; y: number; z: number };
    up: { x: number; y: number; z: number };
  };

  /** Viewport policy */
  viewportPolicy: 'useRuntimeViewport';  // Always use current canvas size

  /** Source block for error reporting */
  sourceBlockId: BlockId;
}
```

**Unit Conventions (LOCKED):**
- Angles: RADIANS (fovYRad) - UI shows degrees, compiler converts
- Distances: World units (no assumed scale)
- Handedness: Right-handed
- Up axis: +Y
- Forward axis: -Z (camera looks down negative Z)

**Acceptance Criteria:**
- [ ] CameraIR interface updated in types3d.ts
- [ ] All convention fields have literal types (not string)
- [ ] fovYRad is radians (conversion from degrees in lowering)
- [ ] sourceBlockId included for error attribution

---

### P1-1: Camera Compiler/Lowering

**Goal:** Lower Camera blocks to CameraIR entries in program.cameras table.

**Files:**
- `src/editor/compiler/blocks/scene/Camera.ts` (new)
- `src/editor/compiler/ir/IRBuilderImpl.ts` (add camera table support)

**Lowering Logic:**

```typescript
export function lowerCamera(block: BlockIR, ctx: LoweringContext): void {
  // Extract input values
  const position = ctx.resolveVec3Input('position');
  const target = ctx.resolveVec3Input('target');
  const up = ctx.resolveVec3Input('up', { x: 0, y: 1, z: 0 });

  const kind = ctx.resolveScalarString('projectionKind');
  const fovYDeg = ctx.resolveNumberInput('fovYDeg');
  const orthoHeight = ctx.resolveNumberInput('orthoHeight');
  const near = ctx.resolveNumberInput('near');
  const far = ctx.resolveNumberInput('far');

  // Build CameraIR
  const cameraIR: CameraIR = {
    id: `camera-${block.id}`,
    handedness: 'right',
    forwardAxis: '-Z',
    upAxis: '+Y',
    projection: {
      kind,
      near,
      far,
      fovYRad: fovYDeg * (Math.PI / 180),  // Convert degrees to radians
      orthoHeight,
    },
    pose: { position, target, up },
    viewportPolicy: 'useRuntimeViewport',
    sourceBlockId: block.id,
  };

  // Add to program cameras table
  ctx.builder.addCamera(cameraIR);
}
```

**Acceptance Criteria:**
- [ ] Camera.ts created in compiler/blocks/scene/
- [ ] Registered in block type registry
- [ ] `ctx.builder.addCamera()` method exists
- [ ] `program.cameras` populated after compilation
- [ ] CameraIR.id matches `camera-${blockId}` pattern
- [ ] fovYRad is in radians (UI degrees converted)

---

### P1-2: Camera Validation & Diagnostics

**Goal:** Compile-time errors for degenerate camera configurations.

**File:** `src/editor/compiler/blocks/scene/Camera.ts`

**Validation Rules:**

| Condition | Error Code | Message |
|-----------|------------|---------|
| `near <= 0` | `CAMERA_INVALID_NEAR` | "Camera near plane must be > 0" |
| `far <= near` | `CAMERA_INVALID_FAR` | "Camera far plane must be > near plane" |
| `position === target` | `CAMERA_DEGENERATE_LOOKAT` | "Camera position and target cannot be the same" |
| `up parallel to view` | `CAMERA_DEGENERATE_UP` | "Camera up vector cannot be parallel to view direction" |
| `fovY <= 1° or >= 179°` | `CAMERA_INVALID_FOV` | "Camera FOV must be between 1° and 179°" |
| `projectionKind not in ['perspective', 'orthographic']` | `CAMERA_INVALID_PROJECTION` | "Invalid projection kind" |

**Diagnostic Format:**
```typescript
{
  code: 'CAMERA_INVALID_NEAR',
  severity: 'error',
  message: 'Camera near plane must be > 0',
  where: { blockId: block.id, port: 'near' },
}
```

**Acceptance Criteria:**
- [ ] All 6 validation rules implemented
- [ ] Errors emitted via `ctx.emitError()` or similar
- [ ] Error location includes blockId and port name
- [ ] Creating camera with near=0 shows compile error
- [ ] Creating camera with position=target shows compile error

---

### P1-3: Camera Selection Semantics

**Goal:** Deterministic behavior for 0, 1, or many cameras.

**Rules:**

| Camera Count | Behavior |
|--------------|----------|
| 0 cameras | Default implicit camera created at runtime (position: 0,0,100, target: 0,0,0, perspective 60°) |
| 1 camera | That camera is the active camera |
| N cameras | First camera (by block creation order / stable ID sort) is active. Others available by ID for future multi-camera support |

**Implementation:**
- Add `program.activeCameraId: CameraId | null` to CompiledProgramIR
- Set to first camera ID or null if no cameras
- Runtime falls back to default camera if null

**Future Extension Point:**
Render sinks can later specify `cameraId` to use a specific camera. For now, all sinks use `activeCameraId`.

**Acceptance Criteria:**
- [ ] `program.activeCameraId` field added to CompiledProgramIR
- [ ] Populated during compilation (first camera or null)
- [ ] Runtime creates default camera when activeCameraId is null
- [ ] Multiple cameras: deterministic selection (first by stable order)

---

## Dependencies

**Internal:**
- P0-2 depends on P0-1 (Camera block needs Vec3 editor)
- P1-1 depends on P0-2, P0-3 (Lowering needs block and schema)
- P1-2 depends on P1-1 (Validation in lowering)
- P1-3 depends on P1-1 (Selection needs cameras table)

**External:** None

---

## Risks

| Risk | Mitigation |
|------|------------|
| Vec3 type not fully supported in type system | Check existing vec3Type in types.ts - already exists from Phase 1 |
| Signal<vec3> wiring complex | Use defaultSource for now; wiring can be added later |
| Validation helper functions don't exist | Add to compiler/diagnostics.ts or inline |

---

## Deferred (Future Sprints)

- RenderInstances3D block with camera reference
- Mesh block definition
- Multi-camera UI (render sink camera picker)
- Camera frustum preview widget
- Quaternion rotation mode
- Camera animation/keyframes
