# Definition of Done: IR Compiler to Rendering Wireup

**Generated**: 2026-01-04-010206
**Plan**: PLAN-2026-01-04-010206.md
**Topic**: ir-render-wireup

---

## Sprint Scope

This sprint delivers:
1. **P0**: Wire compileBusAware.ts to pass pipeline (CRITICAL BLOCKER)
2. **P1**: End-to-end integration test for compilation pipeline
3. **P1**: Verify CompilerService.getProgram() integration

**Deferred**:
- Missing block compilers (P2 - trigger if integration test reveals gaps)
- Hot swap verification (P3 - separate sprint)

---

## Acceptance Criteria

### Deliverable 1: Wire compileBusAware.ts to Pass Pipeline (P0)

#### Code Implementation
- [ ] `compileBusAwarePatch()` invokes all 7 passes sequentially (pass1, pass2, pass3, pass4, pass5, pass6, pass8)
- [ ] Each pass result is validated before proceeding to next pass
- [ ] Errors from any pass are propagated via `CompileResult.errors` array
- [ ] `buildCompiledProgram()` is called with correct arguments (builderIR, patchId, patchRevision, seed)
- [ ] `IRRuntimeAdapter.createProgram()` returns a `Program<RenderTree>` compatible with Player
- [ ] CompileResult includes both `program` and `timeModel` fields on success

#### Quality Checks
- [ ] TypeScript compilation succeeds (`just typecheck` passes with 0 errors)
- [ ] No regression in existing tests (`just test` passes all tests)
- [ ] Empty patch handling works correctly (EmptyPatch error propagates to integration layer)
- [ ] No silent failures or suppressed errors (fail fast with clear messages)

#### Edge Cases Handled
- [ ] Legacy compiler path (`emitIR: false`) returns clear error "Legacy compiler removed"
- [ ] Missing TimeRoot triggers TR-001 error from Pass 3
- [ ] Multiple TimeRoots trigger TR-002 error from Pass 3
- [ ] Illegal feedback loops trigger FB-301/302/303 errors from Pass 5
- [ ] Missing block compiler (if any) triggers clear error from Pass 6

---

### Deliverable 2: End-to-End Integration Test (P1)

#### Test Coverage
- [ ] Test file created at `src/editor/compiler/__tests__/ir-pipeline-integration.test.ts`
- [ ] Test case 1: Minimal valid patch (TimeRoot + Domain + Render) compiles successfully
- [ ] Test case 2: Patch without TimeRoot fails with TR-001 error code
- [ ] Test case 3: Patch with multiple TimeRoots fails with TR-002 error code
- [ ] Successful compilation produces non-null `program` and `timeModel`
- [ ] Program.run() executes without throwing and produces RenderTree

#### Test Quality
- [ ] All tests pass (`just test` or `just test-file <path>`)
- [ ] Test runs in <5 seconds (no browser automation needed)
- [ ] Test fixtures use minimal patches (3-5 blocks max)
- [ ] Fixed seeds used for reproducibility

---

### Deliverable 3: Verify CompilerService Integration (P1)

#### Static Analysis
- [ ] CompileResult type shape matches CompiledProgram interface
- [ ] IRRuntimeAdapter.createProgram() return type is Program<RenderTree>
- [ ] CompilerService.getProgram() correctly extracts program and timeModel from CompileResult

#### Manual Verification (Browser Test)
- [ ] Editor loads without TypeScript errors at `http://localhost:5173`
- [ ] Simple patch (TimeRoot + Domain + RenderInstances2D) compiles successfully
- [ ] No compilation errors in browser console
- [ ] Canvas shows rendered output (not blank or error state)
- [ ] Player.preview receives valid program from CompilerService.getProgram()

#### Documentation
- [ ] Findings documented in SUMMARY-planner file or work log
- [ ] If code changes needed, clear fix identified and added to P0 scope
- [ ] If working as-is, success documented and item closed

---

## Sprint Complete Checklist

### Code Quality
- [ ] All P0 and P1 acceptance criteria met
- [ ] TypeScript compilation succeeds (`just typecheck`)
- [ ] All existing tests pass (`just test`)
- [ ] New integration test passes
- [ ] No compiler warnings or errors

### Functional Verification
- [ ] Simple patch renders visible output in browser
- [ ] Compilation pipeline executes end-to-end (Patch → IR → Schedule → Render)
- [ ] Error cases fail gracefully with clear messages
- [ ] No silent failures or undefined behavior

### Documentation & Handoff
- [ ] PLAN and DOD files finalized in `.agent_planning/ir-render-wireup/`
- [ ] Deferred work captured (missing block compilers if discovered)
- [ ] Known blockers or questions resolved or documented
- [ ] Ready for `/do:it` implementation

---

## Out of Scope (Deferred)

### Missing Block Compilers (P2)
- **Reason**: Will emerge naturally during integration testing if present
- **Trigger**: Integration test failures in Pass 6
- **Effort**: 1-3 hours (depends on count)

### Hot Swap Verification (P3)
- **Reason**: Not critical for initial wireup
- **Effort**: 2-3 hours
- **Scope**: Test state preservation, flicker-free swaps, Class A/B/C changes

### Performance Profiling
- **Reason**: Functional correctness first, optimization second
- **Scope**: Measure compilation time for real patches, identify bottlenecks

### Canvas Renderer
- **Reason**: SVG path sufficient for initial validation
- **Scope**: Wire up canvasProgram path in CompileResult

---

## Acceptance Process

**Sprint is DONE when**:
1. All P0 and P1 acceptance criteria checkboxes are checked
2. TypeScript compiles cleanly
3. Tests pass (existing + new integration test)
4. Simple patch renders visible output in browser
5. No critical blockers remain

**Sprint is BLOCKED if**:
- Pass pipeline fails on minimal test patches
- IRRuntimeAdapter incompatible with Player interface
- Missing block compilers prevent compilation (escalate to P0 if discovered)

**Ready for Next Sprint**:
- Hot swap testing
- Performance optimization
- Error message quality improvements
- Canvas renderer integration
