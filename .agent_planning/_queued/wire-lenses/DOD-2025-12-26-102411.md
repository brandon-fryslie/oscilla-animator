# Definition of Done: Wire Lens Support
**Generated**: 2025-12-26-102411
**Plan**: PLAN-2025-12-26-102411.md
**Topic**: wire-lenses

---

## Sprint Scope

This sprint delivers:
1. **Type System**: Connection interface extended with lensStack/adapterChain fields
2. **Store Operations**: PatchStore methods for lens/adapter management on wires
3. **Compiler Integration**: Lens/adapter application during wire resolution
4. **UI**: Lens section in WireConnectionView with add/remove/enable controls
5. **Testing**: Comprehensive test coverage for wire lens functionality

**Deferred**:
- LensChainEditor component (shared across all connection types)
- Advanced lens parameter binding UI

---

## Acceptance Criteria

### P0-1: Type System Extension

- [ ] Connection interface includes `readonly lensStack?: LensInstance[]` field
- [ ] Connection interface includes `readonly adapterChain?: AdapterStep[]` field
- [ ] Fields are optional (backward compatible with existing patches)
- [ ] TypeScript compilation succeeds with no errors
- [ ] Existing connection creation code compiles without modification

**File**: `src/editor/types.ts:551-560`

---

### P0-2: PatchStore Methods

- [ ] `updateConnection(connectionId, updates)` method accepts `lensStack` and `adapterChain` in updates parameter
- [ ] `addLensToConnection(connectionId, lensDefinition, index?)` method adds lens to wire's lensStack
- [ ] `removeLensFromConnection(connectionId, index)` method removes lens from wire's lensStack
- [ ] `updateConnectionLens(connectionId, index, updates)` method updates lens params/enabled state
- [ ] All methods trigger MobX reactivity and emit 'graphCommitted' event
- [ ] Unit tests verify lens operations maintain stack order and enabled state

**File**: `src/editor/stores/PatchStore.ts`

---

### P0-3: Compiler Integration

- [ ] Wire resolution applies `applyAdapterChain()` when `wireConn.adapterChain` exists
- [ ] Wire resolution applies `applyLensStack()` when `wireConn.lensStack` exists
- [ ] Disabled lenses (enabled: false) are skipped during application
- [ ] Lens errors are captured in CompileErrors with clear port references
- [ ] Unit test: Wire with scale lens (factor=2.0) produces scaled artifact value
- [ ] Unit test: Wire with disabled lens passes artifact unchanged
- [ ] Unit test: Wire with multiple lenses applies them in sortKey order

**File**: `src/editor/compiler/compileBusAware.ts` lines 596-608

---

### P1-4: UI Integration

- [ ] WireConnectionView shows "Lenses" section when connection has lensStack
- [ ] Badge displays lens count (e.g., "2 lenses") with preview of lens names
- [ ] "Add Lens" button opens lens picker (reuse existing lens picker component)
- [ ] Each lens has enable/disable toggle (calls PatchStore.updateConnectionLens)
- [ ] Each lens has remove button (calls PatchStore.removeLensFromConnection)
- [ ] Manual test: Add scale lens to wire, verify badge updates
- [ ] Manual test: Disable lens, verify preview shows "disabled" state

**File**: `src/editor/components/panels/ConnectionInspector.tsx` lines 121-183

---

### P2-5: Testing Infrastructure

- [ ] Unit test: Wire with single lens (scale) correctly transforms artifact value
- [ ] Unit test: Wire with multiple lenses applies them in sortKey order
- [ ] Unit test: Wire with disabled lens skips transformation
- [ ] Unit test: Wire lens with invalid param type produces compile error
- [ ] Integration test: Patch with lensed wire compiles and renders correctly
- [ ] Integration test: Lens param bound to defaultSource resolves correctly
- [ ] E2E test (manual/automated): Add lens via ConnectionInspector updates compilation

**Test Files**: `src/editor/__tests__/wire-lenses.test.ts` (new), extend `compileBusAware.test.ts`

---

## Verification Checklist

### Before Merge
- [ ] All P0 acceptance criteria met (P0-1, P0-2, P0-3)
- [ ] P1 UI integration acceptance criteria met (P1-4)
- [ ] P2 testing acceptance criteria met (P2-5)
- [ ] Existing test suite passes (no regressions)
- [ ] TypeScript compilation clean (no new errors)
- [ ] Manual test: Add scale lens to wire via UI, verify transformed output in compiled result
- [ ] Manual test: Disable lens, verify original output restored
- [ ] Manual test: Save/reload patch with lensed wire, verify lens preserved in serialization
- [ ] Manual test: Wire with multiple lenses applies transformations in correct order

### Integration Tests
- [ ] Wire lens application produces correct artifact values in compiler
- [ ] Wire lens errors surface in CompileErrors with clear diagnostics
- [ ] Lens params bound to defaultSource resolve correctly
- [ ] Backward compatibility: Patches without lens fields load without errors

### Performance
- [ ] No measurable compilation time regression for patches without wire lenses

---

## Success Criteria

### Functional Completeness
- Type system supports lensStack/adapterChain
- Compiler applies transformations during wire resolution
- UI provides lens management controls
- Test coverage validates correctness

### User Experience
- Users can apply transformations (scale, clamp, ease, etc.) to wire connections
- UI is discoverable (lens section appears in ConnectionInspector for wires)
- Disabled lenses are clearly indicated and skipped

### Technical Quality
- Code reuses existing lens infrastructure (no duplication)
- Backward compatible with existing patches
- MobX reactivity works correctly (lens changes trigger recompilation)
- Clear error messages for lens type mismatches

---

## Out of Scope (Documented for Future)

- LensChainEditor component (drag-to-reorder, inline params)
- Advanced lens parameter binding (wire/bus sources)
- Semantic validation for lens type compatibility
- Lens presets

---

**Ready for**: Implementation via /dev-loop:implement or manual execution
