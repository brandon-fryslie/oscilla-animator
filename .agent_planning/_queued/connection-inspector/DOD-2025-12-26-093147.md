# Definition of Done: Connection Inspector

**Generated**: 2025-12-26-093147
**Plan**: PLAN-2025-12-26-093147.md
**Source**: STATUS-2025-12-26-103000.md
**Topic**: connection-inspector

---

## Sprint Scope

**This sprint delivers**:
1. Core Connection Inspector with embedded lens editing (P0)
2. Entry points from port inspector and ModulationTable (P1)
3. Back navigation with context tracking (P1)

**Deferred to future sprint**:
- Color coding and visual polish (P2-1)
- Enhanced swap UX (P2-2)
- PatchBay wire click entry point

---

## Acceptance Criteria

### Deliverable 1: Core Connection Inspector (P0)

#### P0-1: Connection Selection State

- [ ] UIStateStore has `selectedConnection` field in observable `uiState`
  - [ ] Type is `{ type: 'wire' | 'publisher' | 'listener'; id: string } | null`
- [ ] `selectConnection(type, id)` action exists and is decorated with `@action`
  - [ ] Sets `selectedConnection` to `{ type, id }`
  - [ ] Clears `selectedBlockId` when connection selected
  - [ ] Clears `selectedBusId` when connection selected
  - [ ] Clears `selectedPort` when connection selected
- [ ] `deselectConnection()` action exists
  - [ ] Sets `selectedConnection` to `null`
- [ ] Selecting block/bus/port automatically clears `selectedConnection`
  - [ ] `selectBlock()` clears `selectedConnection`
  - [ ] `selectBus()` clears `selectedConnection`
  - [ ] `setSelectedPort()` clears `selectedConnection`
- [ ] Unit test verifies mutual exclusion behavior
  - [ ] Test: `selectConnection` → `selectBlock` → verify `selectedConnection` is null
  - [ ] Test: `selectBlock` → `selectConnection` → verify `selectedBlockId` is null
  - [ ] Test: `selectConnection` → `deselectConnection` → verify null

#### P0-2: ConnectionInspector Component

- [ ] Component file created at `src/editor/ConnectionInspector.tsx`
- [ ] Component is wrapped with `observer` from mobx-react-lite
- [ ] Component renders only when `uiState.selectedConnection` is set
- [ ] Component uses `InspectorContainer` for header/styling
- [ ] Component displays connection endpoints
  - [ ] Wire: Shows source block/port → target block/port
  - [ ] Publisher: Shows source block/port → target bus name
  - [ ] Listener: Shows source bus name → target block/port
  - [ ] Port names include type badges (reuse existing type display logic)
- [ ] Back button clears `selectedConnection`
  - [ ] Calls `uiStore.deselectConnection()`
- [ ] Disconnect button removes connection
  - [ ] Wire: Calls `patchStore.removeConnection(connectionId)`
  - [ ] Publisher: Calls `busStore.removePublisher(publisherId)`
  - [ ] Listener: Calls `busStore.removeListener(listenerId)`
  - [ ] Clears `selectedConnection` after removal
- [ ] Swap button initiates re-targeting flow
  - [ ] Button exists and is clickable
  - [ ] Basic implementation (full UX in P2-2)
- [ ] Lens section only appears for publisher/listener connections
  - [ ] Wire connections: No lens section rendered
  - [ ] Publisher connections: Lens section rendered with embedded editor
  - [ ] Listener connections: Lens section rendered with embedded editor
- [ ] Component has CSS file with consistent styling
- [ ] E2E test: Select wire connection → inspect → disconnect → verify removed
- [ ] E2E test: Select publisher → inspect → verify lens section shown
- [ ] E2E test: Select wire → inspect → verify no lens section

#### P0-3: Embedded LensChainEditor Variant

- [ ] LensChainEditor accepts optional `embedded: boolean` prop
  - [ ] Prop added to `LensChainEditorProps` interface
  - [ ] Default value is `false` (preserves existing behavior)
- [ ] When `embedded=true`, "Done" button is hidden
  - [ ] Conditional rendering: `{!embedded && <button>Done</button>}`
- [ ] When `embedded=true`, component renders as block element
  - [ ] No absolute positioning (remove popover styles)
  - [ ] No backdrop/overlay
  - [ ] Uses normal document flow
- [ ] "Add Lens" panel collapsed by default
  - [ ] Existing behavior preserved
- [ ] Changes apply immediately via `onChange` callback
  - [ ] Existing behavior preserved (no changes needed)
  - [ ] Verify `onChange` called on every lens modification
- [ ] Lens chain editor fits within inspector panel width (~300px)
  - [ ] Manual test: Inspector panel at 300px width
  - [ ] Manual test: Long lens chain (5+ lenses) renders without overflow
  - [ ] Responsive layout tested
- [ ] E2E test: Edit lens in embedded mode → verify `onChange` called
- [ ] E2E test: Embedded mode shows no "Done" button

### Deliverable 2: Primary Entry Points (P1)

#### P1-1: Port Inspector Connection List Entry Point

- [ ] PortWiringPanel modified to support connection inspection
  - [ ] Connection list items have onClick handler
  - [ ] Handler calls `uiStore.selectConnection('wire', connection.id)`
- [ ] Clicking a connection in PortWiringPanel selects it
  - [ ] `selectedConnection` is set with correct type and id
  - [ ] ConnectionInspector renders after click
- [ ] Disconnect button in connection list still works
  - [ ] Removes connection via `patchStore.removeConnection`
  - [ ] Does not navigate to ConnectionInspector
- [ ] Double-click navigation removed
  - [ ] Remove `onDoubleClick` handler that navigates to connected block
- [ ] E2E test: Select block → click port → click connection → verify ConnectionInspector shows
- [ ] E2E test: Connection in list shows correct source/target

#### P1-2: ModulationTable Cell Click Entry Point

- [ ] `handleCellClick` in ModulationTable modified
  - [ ] Checks if cell is bound (`cell.status === 'bound'`)
  - [ ] For bound cells, calls `uiStore.selectConnection`
  - [ ] Determines connection type based on column side (left=listener, right=publisher)
- [ ] Single-clicking a bound publisher cell opens ConnectionInspector
  - [ ] `selectedConnection.type === 'publisher'`
  - [ ] `selectedConnection.id` matches publisher.id
- [ ] Single-clicking a bound listener cell opens ConnectionInspector
  - [ ] `selectedConnection.type === 'listener'`
  - [ ] `selectedConnection.id` matches listener.id
- [ ] Single-clicking an unbound cell only sets focus
  - [ ] No ConnectionInspector rendered
  - [ ] Focus behavior unchanged
- [ ] Double-click bind/unbind behavior unchanged
  - [ ] `handleCellDoubleClick` unchanged
  - [ ] Bind/unbind still works
- [ ] Right-click context menu behavior unchanged
  - [ ] Context menu still appears
  - [ ] "Edit Lenses..." option still works
- [ ] E2E test: Click bound publisher cell → verify ConnectionInspector shows publisher
- [ ] E2E test: Click bound listener cell → verify ConnectionInspector shows listener
- [ ] E2E test: Click unbound cell → verify no ConnectionInspector (focus only)
- [ ] E2E test: Double-click bound cell → verify bind/unbind still works

### Deliverable 3: Navigation Polish (P1)

#### P1-3: Back Navigation Context Tracking

- [ ] UIStateStore has `inspectorHistory` stack
  - [ ] Type: `Array<{ type: 'block' | 'bus' | 'port' | 'cell'; id: string | null; ... }>`
  - [ ] Observable field
  - [ ] Limited to 10 entries max
- [ ] `pushInspectorHistory()` action exists
  - [ ] Called before navigating to ConnectionInspector
  - [ ] Captures current selection state (block/bus/port/cell)
- [ ] `popInspectorHistory()` action exists
  - [ ] Returns previous state entry
  - [ ] Removes entry from stack
- [ ] Navigating to ConnectionInspector pushes current state to history
  - [ ] From port inspector: Pushes block + port selection
  - [ ] From ModulationTable: Pushes cell focus
  - [ ] From bus inspector: Pushes bus selection
- [ ] Back button in ConnectionInspector pops history and restores state
  - [ ] Calls `popInspectorHistory()`
  - [ ] Restores selection based on history entry type
  - [ ] Clears `selectedConnection`
- [ ] From port inspector: Back restores block + port selection
  - [ ] `selectedBlockId` restored
  - [ ] `selectedPort` restored
  - [ ] PortWiringPanel visible again
- [ ] From ModulationTable: Back restores cell focus
  - [ ] Cell focus restored (if ModulationTableStore tracks focus)
  - [ ] Or: No inspector shown (returns to table view)
- [ ] From bus inspector: Back restores bus selection
  - [ ] `selectedBusId` restored
  - [ ] BusInspector visible again
- [ ] E2E test: Port inspector → connection → back → verify port inspector restored
- [ ] E2E test: ModulationTable → connection → back → verify cell focus restored
- [ ] E2E test: Bus inspector → connection → back → verify bus inspector restored
- [ ] Unit test: History stack limited to 10 entries
- [ ] Unit test: Selecting new block/bus clears history (prevents confusing chains)

---

## Testing Requirements

### Unit Tests

- [ ] UIStateStore connection selection state transitions
  - [ ] All mutual exclusion scenarios
  - [ ] History stack push/pop
  - [ ] History limit enforcement
- [ ] Connection type detection and data extraction
  - [ ] Wire connection data retrieval
  - [ ] Publisher connection data retrieval
  - [ ] Listener connection data retrieval
- [ ] Embedded lens editor prop handling
  - [ ] `embedded=true` hides "Done" button
  - [ ] `embedded=false` shows "Done" button (default)

### E2E Tests

- [ ] Port inspector connection click flow
  - [ ] Click connection → ConnectionInspector renders
  - [ ] Edit lens (if publisher/listener) → changes apply
  - [ ] Disconnect → connection removed
  - [ ] Back → port inspector restored
- [ ] ModulationTable cell click flow
  - [ ] Click bound publisher → ConnectionInspector renders (publisher)
  - [ ] Click bound listener → ConnectionInspector renders (listener)
  - [ ] Edit lens → changes apply immediately
  - [ ] Back → cell focus restored
- [ ] Connection inspect → edit lenses → disconnect
  - [ ] Select publisher/listener via any entry point
  - [ ] Modify lens chain (add/remove/reorder)
  - [ ] Verify changes saved to store
  - [ ] Disconnect
  - [ ] Verify connection removed
- [ ] Back navigation from each entry point
  - [ ] Test all three entry points (port inspector, ModulationTable left, ModulationTable right)
  - [ ] Verify correct state restoration

### Manual Verification (Chrome DevTools MCP)

- [ ] Lens changes apply immediately (no "Done" button needed)
  - [ ] Add lens → verify `onChange` called → verify publisher/listener updated
- [ ] Inspector panel layout at various widths
  - [ ] Test at 250px, 300px, 350px
  - [ ] Verify no horizontal overflow
  - [ ] Verify all controls accessible
- [ ] Long lens chains render correctly
  - [ ] Test with 5+ lenses
  - [ ] Verify scrolling if needed
  - [ ] Verify no layout breakage
- [ ] All connection types display correctly
  - [ ] Wire: Source/target blocks/ports shown
  - [ ] Publisher: Source block/port, target bus shown
  - [ ] Listener: Source bus, target block/port shown

---

## Code Quality Requirements

- [ ] All new code has TypeScript types (no `any`)
- [ ] All MobX observables/actions properly decorated
- [ ] All components use `observer` wrapper
- [ ] All files follow existing code style (ESLint passing)
- [ ] All new files have header comments explaining purpose
- [ ] CSS follows existing naming conventions (BEM-like)
- [ ] No console.log statements in production code
- [ ] Error handling for missing connections (graceful degradation)

---

## Documentation Requirements

- [ ] PLAN-2025-12-26-093147.md accurately reflects implementation
- [ ] Code comments explain non-obvious logic
  - [ ] Connection type discrimination
  - [ ] History stack behavior
  - [ ] Mutual exclusion rules
- [ ] Update claude_memory/ if inspector patterns change
  - [ ] Add ConnectionInspector to memory files if it becomes canonical

---

## Performance Requirements

- [ ] ConnectionInspector renders in <50ms
  - [ ] No unnecessary re-renders (use MobX computed where appropriate)
- [ ] Lens editing does not block UI
  - [ ] `onChange` callback is fast (<10ms)
- [ ] History stack does not leak memory
  - [ ] Limited to 10 entries
  - [ ] Cleared on direct block/bus selection

---

## Definition of Done Summary

**Sprint is complete when**:

1. All 3 deliverables complete (P0, P1-1/P1-2, P1-3)
2. All acceptance criteria checkboxes checked
3. All unit tests passing
4. All E2E tests passing
5. Manual verification complete (Chrome DevTools MCP)
6. Code quality requirements met (ESLint, TypeScript, no console.log)
7. `just check` passes (typecheck + lint + test)
8. Feature demo'd to user showing:
   - Port inspector → connection click → inspect → edit lens → back
   - ModulationTable → cell click → inspect → disconnect
   - All three connection types (wire, publisher, listener)

**Ready for**: Production deployment, user acceptance testing, future sprint work (P2 polish)
