# Status Report: Connection Inspector
Timestamp: 2025-12-26-103000
Scope: feature/connection-inspector
Confidence: FRESH
Git Branch: compiler_rewrite

## Executive Summary

**Feature Status: NOT_STARTED**

The Connection Inspector feature does not exist. This is a greenfield implementation requiring new component(s), new state management, and modifications to existing entry points.

**Completion: 0%** | **Dependencies: SATISFIED** | **Ambiguities: 5 NEED CLARIFICATION**

---

## What Exists (Reusable Foundation)

### 1. Inspector System Architecture [FRESH]

**Location**: `src/editor/Inspector.tsx`, `src/editor/BusInspector.tsx`

The current inspector architecture is well-structured with:

| Component | Purpose | Status |
|-----------|---------|--------|
| `InspectorContainer` | Shared container with header/back button/color coding | COMPLETE |
| `Inspector` | Block inspector with port display, wiring panel | COMPLETE |
| `BusInspector` | Bus detail view with publishers/listeners | COMPLETE |
| `PortWiringPanel` | Port connection management (inside Inspector) | COMPLETE |

**Key Pattern**: Inspectors use `InspectorContainer` for consistent styling. Each inspector type is a separate component that renders conditionally based on UI state.

**Selection State Management** (`src/editor/stores/UIStore.ts` via `useStore()`):
- `selectedBlock` - currently selected block
- `selectedPort` - currently selected port (shows PortWiringPanel)
- `selectedBus` - shows BusInspector

### 2. Lens Editing Components [FRESH]

**Locations**:
- `src/editor/components/LensSelector.tsx` - Single lens selection (preset/custom modes)
- `src/editor/modulation-table/LensChainEditor.tsx` - Full lens chain editing

| Feature | LensSelector | LensChainEditor |
|---------|--------------|-----------------|
| Single lens | YES | YES (per item) |
| Lens chains | NO | YES |
| Reordering | NO | YES (up/down buttons) |
| Enable/disable | NO | YES (per lens toggle) |
| Curve preview | NO | YES (animated SVG) |
| Preset selection | YES | YES |
| Custom params | YES | YES |
| Recent lenses | NO | YES (localStorage) |

**Critical Finding - "Done" Button Workflow**:
```tsx
// LensChainEditor.tsx:1123-1129
<div className="lens-chain-actions">
  <button className="lens-chain-clear" onClick={() => onChange([])}>
    Clear All
  </button>
  <button className="lens-chain-done" onClick={onClose}>
    Done
  </button>
</div>
```

The `LensChainEditor` has a "Done" button but changes are applied **immediately** via `onChange()`. The "Done" button only **closes the editor** - it does NOT commit changes. This is the correct behavior for the user's requirement of "immediate effect."

**However**: The current pattern uses a popover (`LensChainEditorPopover`) that appears at click position and has an overlay backdrop. User requests **embedded** lens editing, not popup.

### 3. Connection Data Structures [FRESH]

**Wire Connections** (`src/editor/types.ts:551-560`):
```typescript
export interface Connection {
  readonly id: string;
  readonly from: PortRef;  // { blockId, slotId, direction }
  readonly to: PortRef;
}
```

**Bus Publishers** (`src/editor/types.ts:194-218`):
```typescript
export interface Publisher {
  readonly id: string;
  readonly busId: string;
  readonly from: PortRef;
  readonly adapterChain?: AdapterStep[];
  readonly lensStack?: LensInstance[];
  enabled: boolean;
  sortKey: number;
}
```

**Bus Listeners** (`src/editor/types.ts:220-241`):
```typescript
export interface Listener {
  readonly id: string;
  readonly busId: string;
  readonly to: PortRef;
  readonly adapterChain?: AdapterStep[];
  enabled: boolean;
  readonly lensStack?: LensInstance[];
}
```

### 4. ModulationTable Cell Click Handling [FRESH]

**Location**: `src/editor/modulation-table/ModulationTable.tsx`

Current cell interaction:
- **Single click**: `handleCellClick` - sets focused cell in store
- **Double click**: `handleCellDoubleClick` - toggles bind/unbind
- **Right click**: Opens context menu with "Bind", "Unbind", "Edit Lenses..."

Context menu "Edit Lenses..." flow:
1. If cell not bound, binds it first
2. Opens `LensChainEditorPopover` at click position

**Gap**: No path to a "Connection Inspector" - clicking opens lens editor directly, doesn't navigate to a connection detail view.

### 5. Entry Points in Port/Block Inspector [FRESH]

**Current Port Inspector** (`PortWiringPanel` in `Inspector.tsx:46-479`):
- Shows existing connections with disconnect button
- Double-click on connection navigates to the OTHER block
- No path to view/edit the connection itself as a first-class entity

**Current Block Inspector**:
- Shows ports with connection indicators (wire/bus icons)
- Bus connections section shows bus tags with click/right-click
- `BusTag` component allows inspecting bus on click

**Gap**: No "click connection to inspect it" - clicking port shows wiring panel, clicking connected block navigates to that block.

---

## What's Missing

### 1. Connection Inspector Component [NOT_STARTED]

A new component that displays:
- Connection endpoints (source block/port, target block/port or bus)
- Connection type (wire vs. bus publisher vs. bus listener)
- Disconnect action
- Swap/replace connection
- **Embedded lens chain editor** (not popup)

### 2. Connection Selection State [NOT_STARTED]

Need to add to UI state:
```typescript
selectedConnection?: {
  type: 'wire' | 'publisher' | 'listener';
  id: string;
} | null;
```

### 3. Entry Point Modifications [NOT_STARTED]

| Entry Point | Current Behavior | Required Behavior |
|-------------|------------------|-------------------|
| Port inspector connection list | Double-click navigates to connected block | Click opens Connection Inspector |
| ModulationTable cell click | Sets focus, context menu for lenses | Click opens Connection Inspector |
| PatchBay wire click | Not implemented | Opens Connection Inspector |

### 4. Embedded Lens Editor Variant [NOT_STARTED]

Current `LensChainEditor` is designed for popover use. Need either:
- A new `EmbeddedLensChainEditor` component
- Or refactor `LensChainEditor` to support embedded mode (no "Done" button, no header)

---

## Data Flow Verification

| Flow | Entry | Selection | Display | Edit | Commit | Status |
|------|-------|-----------|---------|------|--------|--------|
| Wire connection | N/A | N/A | N/A | N/A | N/A | NOT_STARTED |
| Bus publisher | N/A | N/A | N/A | N/A | N/A | NOT_STARTED |
| Bus listener | N/A | N/A | N/A | N/A | N/A | NOT_STARTED |

---

## Ambiguities Found - NEEDS CLARIFICATION

### 1. Connection Types in Scope

**Question**: Should the Connection Inspector handle all three connection types?

| Type | Description | Has Lenses |
|------|-------------|------------|
| Wire (block->block) | Direct connection between blocks | NO |
| Publisher (block->bus) | Block output publishes to bus | YES (`lensStack`) |
| Listener (bus->block) | Block input listens to bus | YES (`lensStack`) |

**Impact**: Wire connections have no lens editing - the inspector would be very simple (view/disconnect/swap). Publishers and listeners have lens stacks.

**Recommendation**: All three types, but wire inspector is simpler (no lens section).

### 2. "Swap" Connection Meaning

**Question**: What does "swap" mean for a connection?

Options:
- **A**: Change target (keep source, pick new destination)
- **B**: Change source (keep destination, pick new source)
- **C**: Both - depends on connection direction
- **D**: Replace with different bus (for bus connections only)

**Impact**: UI complexity differs significantly.

### 3. Entry Points Priority

**Question**: Which entry points are required for v1?

| Entry Point | Complexity | User Value |
|-------------|------------|------------|
| Port inspector connection list | LOW | HIGH |
| ModulationTable cell | MEDIUM | HIGH |
| PatchBay wire visual click | HIGH | MEDIUM |

**Recommendation**: Port inspector and ModulationTable for v1, PatchBay can be v2.

### 4. Embedded vs. Collapsible Lens Editor

**Question**: "Inline lens editing with collapsible add lens menu" - clarify:

Options:
- **A**: Lens editor always visible, "Add Lens" section is collapsible
- **B**: Lens editor section is collapsible, opens inline when expanded
- **C**: Current lens chain shown as chips, click to expand full editor

**Current LensChainEditor already has**:
- Collapsible "Add Lens" panel (click button to show)
- Collapsible individual lens items (expand/collapse params)

### 5. Navigation Flow

**Question**: When viewing Connection Inspector, what does "back" navigate to?

Options:
- **A**: Return to previously viewed inspector (block, port, bus)
- **B**: Always return to the source block inspector
- **C**: Always return to the destination (if applicable)
- **D**: Context-dependent (came from ModulationTable? Stay there)

**Impact**: Affects state management and history tracking.

---

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| InspectorContainer | SATISFIED | Ready to use |
| LensChainEditor | PARTIAL | Works, but needs embedded mode |
| UIStore selection state | NEEDS_EXTENSION | Add `selectedConnection` |
| BusStore | SATISFIED | Full CRUD for publishers/listeners |
| PatchStore | SATISFIED | Full CRUD for connections |

---

## Implementation Risks

### 1. State Complexity
Adding `selectedConnection` means four possible selection states:
- Block selected
- Port selected
- Bus selected
- Connection selected

Need clear mutual exclusion rules.

### 2. Lens Editor Refactor
Current popover design may not fit well in inspector panel width. May need responsive layout work.

### 3. ModulationTable Integration
The ModulationTable already has complex click handling. Adding "click to inspect connection" needs to coexist with:
- Cell focus
- Double-click bind/unbind
- Right-click context menu

---

## Recommendations

### Phased Approach

**Phase 1: Core Connection Inspector**
1. Add `ConnectionInspector` component
2. Add `selectedConnection` to UI state
3. Handle wire connections (simplest case)
4. Entry point: Port inspector connection list click

**Phase 2: Bus Connection Support**
1. Extend for publisher/listener connections
2. Embed lens editor (inline, not popover)
3. Entry point: BusInspector publisher/listener click

**Phase 3: ModulationTable Integration**
1. Add cell click -> Connection Inspector navigation
2. Preserve existing double-click and right-click behavior

**Phase 4: Optional PatchBay Wire Click**
1. Add click handlers to wire SVG elements
2. This is more complex and lower priority

---

## Workflow Recommendation

- [X] PAUSE - Ambiguities need clarification before proceeding

### Questions for User

1. **Connection types**: All three (wire, publisher, listener) or subset?
2. **Swap behavior**: What exactly should "swap" do?
3. **Entry points for v1**: Which are must-have vs. nice-to-have?
4. **Embedded lens layout**: Always visible or collapsible section?
5. **Back navigation**: Where should "back" go from connection inspector?
