# Connection Inspector - Sprint Plan

**Generated**: 2025-12-26-093147
**Source**: STATUS-2025-12-26-103000.md
**Topic**: connection-inspector
**Branch**: compiler_rewrite

---

## Executive Summary

**Current State**: The Connection Inspector feature does not exist. This is a greenfield implementation.

**Completion**: 0% (NOT_STARTED)

**Dependencies**: SATISFIED
- InspectorContainer - COMPLETE
- LensChainEditor - COMPLETE (needs embedded variant)
- UIStateStore - COMPLETE (needs `selectedConnection` field)
- BusStore/PatchStore - COMPLETE (full CRUD operations)

**Scope**: This sprint delivers the core Connection Inspector component with embedded lens editing and two primary entry points (port inspector connection list and ModulationTable cell click). PatchBay wire click is deferred to future work.

**Total Work Items**: 8 (P0: 3, P1: 3, P2: 2)

---

## Gap Analysis

### Architecture Components

| Component | Current State | Target State | Gap |
|-----------|---------------|--------------|-----|
| Connection selection state | Does not exist | `selectedConnection` in UIStateStore | NEW FIELD REQUIRED |
| ConnectionInspector component | Does not exist | Full inspector with lens editing | NEW COMPONENT REQUIRED |
| Port inspector entry point | Double-click navigates to block | Click opens ConnectionInspector | BEHAVIOR CHANGE |
| ModulationTable entry point | Context menu opens lens popover | Click opens ConnectionInspector | BEHAVIOR CHANGE |
| Embedded lens editor | LensChainEditor in popover mode | Inline variant without "Done" button | VARIANT REQUIRED |

### Data Structures

All connection data structures exist and are complete:
- `Connection` (wire) - STATUS-2025-12-26-103000.md Â§3
- `Publisher` (blockâ†’bus) - STATUS-2025-12-26-103000.md Â§3
- `Listener` (busâ†’block) - STATUS-2025-12-26-103000.md Â§3

### Missing Capabilities

1. **Connection as first-class UI entity**: No way to select/view/edit a connection independently
2. **Embedded lens editing**: Current LensChainEditor is popover-only (overlay + backdrop)
3. **Navigation context**: No back-navigation history tracking for inspector transitions
4. **Connection type polymorphism**: Need unified interface for wire/publisher/listener

---

## Sprint Backlog

### P0 (Critical) - Core Connection Inspector

These items are the foundation - the inspector cannot function without them.

---

#### P0-1: Add Connection Selection State

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§2 (Inspector System Architecture)

##### Description

Extend `UIStateStore` to support connection selection alongside existing block/bus/port selection. This creates a fourth selection mode that is mutually exclusive with the other three.

**Implementation**:
1. Add `selectedConnection` field to `uiState` observable:
   ```typescript
   selectedConnection: {
     type: 'wire' | 'publisher' | 'listener';
     id: string;
   } | null
   ```
2. Add actions: `selectConnection(type, id)`, `deselectConnection()`
3. Implement mutual exclusion: selecting connection clears block/bus/port selection
4. Add computed getter: `hasSelection` that returns true if any selection exists

##### Acceptance Criteria

- [ ] UIStateStore has `selectedConnection` field in observable `uiState`
- [ ] `selectConnection(type, id)` action sets `selectedConnection` and clears other selections
- [ ] `deselectConnection()` action clears `selectedConnection`
- [ ] Selecting block/bus/port automatically clears `selectedConnection`
- [ ] Unit test verifies mutual exclusion behavior

##### Technical Notes

Follow the existing pattern from `selectBlock`/`selectBus` (see UIStateStore.ts:99-119). The `selectedConnection` field is nullable - `null` means no connection selected.

---

#### P0-2: Create ConnectionInspector Component

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: P0-1 (Connection Selection State)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§1 (What's Missing)

##### Description

Build the main ConnectionInspector component that displays connection details and allows editing. This component renders in the right panel (inspector area) when a connection is selected, replacing the block/bus inspector.

**Component Structure**:
```tsx
ConnectionInspector
â”œâ”€â”€ InspectorContainer (header with "Connection" title, back button, type color)
â”œâ”€â”€ Connection Endpoints Section
â”‚   â”œâ”€â”€ Source display (block name, port name, type badge)
â”‚   â”œâ”€â”€ Connection type indicator (wire/publisher/listener)
â”‚   â””â”€â”€ Target display (block/bus name, port/bus name, type badge)
â”œâ”€â”€ Actions Section
â”‚   â”œâ”€â”€ Disconnect button
â”‚   â””â”€â”€ Swap button (context-dependent behavior)
â””â”€â”€ Lens Editor Section (bus connections only)
    â””â”€â”€ Embedded LensChainEditor (collapsible "Add Lens" panel)
```

**Connection Type Handling**:
- **Wire**: Show source block/port â†’ target block/port, no lens section
- **Publisher**: Show source block/port â†’ bus, show lens section
- **Listener**: Show bus â†’ target block/port, show lens section

**UI Behavior**:
- Back button navigates to previous inspector state (see P1-3)
- Disconnect removes the connection via store CRUD methods
- Swap button behavior:
  - Wire: Opens port wiring panel to change target
  - Publisher: Opens bus selection to change target bus
  - Listener: Opens bus selection to change source bus
- Lens section uses embedded LensChainEditor (see P0-3)

##### Acceptance Criteria

- [ ] Component renders in inspector area when `selectedConnection` is set
- [ ] Displays correct source/target for all three connection types (wire/publisher/listener)
- [ ] Back button clears `selectedConnection` (basic navigation, enhanced in P1-3)
- [ ] Disconnect button removes connection and clears selection
- [ ] Swap button initiates re-targeting flow (basic implementation, full UX in P2)
- [ ] Lens section only appears for publisher/listener connections
- [ ] Component styled with InspectorContainer for consistency
- [ ] E2E test: Select connection â†’ inspect â†’ disconnect â†’ verify removed

##### Technical Notes

Use `InspectorContainer` from `src/editor/components/InspectorContainer.tsx` for consistent header/styling. Reference `Inspector.tsx` and `BusInspector.tsx` for patterns. Connection data is read-only - modifications go through BusStore/PatchStore actions.

Color coding by connection type:
- Wire: blue (block-to-block)
- Publisher: green (block-to-bus)
- Listener: purple (bus-to-block)

---

#### P0-3: Embedded LensChainEditor Variant

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None (can be developed in parallel with P0-2)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§2 (Lens Editing Components)

##### Description

Create an inline variant of LensChainEditor that embeds directly in the ConnectionInspector without popover overlay. The current LensChainEditor is designed for popover use (backdrop + "Done" button) but the inspector needs a persistent, embedded editor.

**Key Differences from Current LensChainEditor**:
- No "Done" button - lens changes apply immediately via `onChange`
- No popover positioning - renders as block element in parent
- No backdrop/overlay - inline content
- "Add Lens" panel collapsed by default (as requested)
- Full width of inspector panel instead of fixed popover width

**Options**:
1. **Refactor existing**: Add `embedded` prop to LensChainEditor, conditionally hide "Done" button and backdrop
2. **New component**: Create `EmbeddedLensChainEditor` wrapping the core lens editing logic

**Recommendation**: Option 1 (refactor) is preferred - the core logic is identical, only the chrome differs.

##### Acceptance Criteria

- [ ] LensChainEditor accepts optional `embedded: boolean` prop
- [ ] When `embedded=true`, "Done" button is hidden
- [ ] When `embedded=true`, component renders as block element (no absolute positioning)
- [ ] "Add Lens" panel collapsed by default (existing behavior preserved)
- [ ] Changes apply immediately via `onChange` callback (existing behavior preserved)
- [ ] Lens chain editor fits within inspector panel width (~300px)
- [ ] E2E test: Edit lens in embedded mode â†’ verify onChange called â†’ verify no "Done" button

##### Technical Notes

The current LensChainEditor already applies changes immediately (STATUS-2025-12-26-103000.md Â§2 lines 58-70). The "Done" button only closes the popover. In embedded mode, there's no popover to close, so the button is unnecessary.

Responsive layout: Inspector panel is ~300px wide. Lens parameter inputs may need tighter spacing. Test with long lens chains (5+ lenses).

---

### P1 (High) - Entry Points and Navigation

These items enable users to access the Connection Inspector from existing UI surfaces.

---

#### P1-1: Port Inspector Connection List Entry Point

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P0-1, P0-2 (Connection selection state, ConnectionInspector component)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§5 (Entry Points in Port/Block Inspector)

##### Description

Modify the PortWiringPanel connection list so that clicking a connection opens the ConnectionInspector instead of navigating to the connected block.

**Current Behavior** (PortWiringPanel in Inspector.tsx:46-479):
- Shows list of existing connections with disconnect button
- Double-click on connection navigates to the OTHER block

**Target Behavior**:
- **Single click** on connection row: Open ConnectionInspector for that connection
- **Disconnect button**: Remains unchanged (removes connection directly)
- **Double-click**: Remove this behavior (replaced by single-click inspect)

**Implementation**:
1. Find connection list rendering in PortWiringPanel
2. Add onClick handler to connection row
3. Handler calls `uiStore.selectConnection(type, connectionId)`
4. Remove double-click navigation handler

##### Acceptance Criteria

- [ ] Clicking a connection in PortWiringPanel selects it (sets `selectedConnection`)
- [ ] ConnectionInspector renders when connection clicked
- [ ] Disconnect button in connection list still works (removes connection)
- [ ] Double-click navigation removed (no longer navigates to connected block)
- [ ] E2E test: Select block â†’ click port â†’ click connection in list â†’ verify ConnectionInspector shows

##### Technical Notes

The PortWiringPanel is embedded in the main Inspector component. Connections are retrieved via `getConnectionsForPort` utility. Wire connections have `.from` and `.to` PortRefs. The connection type is always 'wire' for port inspector connections.

---

#### P1-2: ModulationTable Cell Click Entry Point

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P0-1, P0-2 (Connection selection state, ConnectionInspector component)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§4 (ModulationTable Cell Click Handling)

##### Description

Modify ModulationTable cell click behavior to open ConnectionInspector for bound cells, while preserving existing double-click (bind/unbind) and right-click (context menu) behaviors.

**Current Behavior** (ModulationTable.tsx):
- Single click: Sets focused cell in store
- Double-click: Toggles bind/unbind
- Right-click: Opens context menu with "Bind", "Unbind", "Edit Lenses..."

**Target Behavior**:
- **Single click on bound cell**: Open ConnectionInspector
  - Publisher cell (right side): `selectedConnection = { type: 'publisher', id: publisher.id }`
  - Listener cell (left side): `selectedConnection = { type: 'listener', id: listener.id }`
- **Single click on unbound cell**: No change (sets focus only)
- **Double-click**: Preserve existing bind/unbind behavior
- **Right-click**: Preserve existing context menu

**Implementation**:
1. Modify `handleCellClick` in ModulationTable
2. Check if cell is bound (`cell.status === 'bound'`)
3. If bound, find publisher/listener ID and call `uiStore.selectConnection`
4. Preserve focus behavior for unbound cells
5. Ensure double-click and right-click handlers unchanged

##### Acceptance Criteria

- [ ] Single-clicking a bound cell opens ConnectionInspector
- [ ] ConnectionInspector shows correct publisher/listener connection
- [ ] Single-clicking an unbound cell only sets focus (no inspector)
- [ ] Double-click bind/unbind behavior unchanged
- [ ] Right-click context menu behavior unchanged
- [ ] E2E test: Click bound publisher cell â†’ verify ConnectionInspector shows publisher
- [ ] E2E test: Click bound listener cell â†’ verify ConnectionInspector shows listener

##### Technical Notes

ModulationTable cells track `cell.status` ('bound', 'convertible', 'incompatible'). The cell data includes the connection ID for bound cells. The table distinguishes left side (listeners) vs. right side (publishers) via column layout.

Avoid breaking existing workflows - lens editing via context menu should still work for users who prefer that flow.

---

#### P1-3: Back Navigation Context Tracking

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P0-2, P1-1, P1-2 (ConnectionInspector and entry points)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§1, Ambiguities Â§5

##### Description

Implement back-navigation history so that clicking "back" in ConnectionInspector returns to the previous inspector state (block, port, bus, or ModulationTable focus).

**User Requirement** (clarification answer 5): "Context-dependent - return to previous inspector state"

**Navigation Contexts**:
1. **From Port Inspector**: Back â†’ restore block selection + port selection
2. **From ModulationTable**: Back â†’ restore cell focus (no inspector change)
3. **From Bus Inspector**: Back â†’ restore bus selection
4. **Direct selection**: Back â†’ clear selection (no prior context)

**Implementation**:
1. Add `inspectorHistory` stack to UIStateStore:
   ```typescript
   inspectorHistory: Array<{
     type: 'block' | 'bus' | 'port' | 'cell';
     id: string | null;
     portRef?: PortRef;
     cellRef?: { rowKey: RowKey; busId: string };
   }>
   ```
2. Push to history when navigating to ConnectionInspector
3. Pop from history when clicking back
4. Restore previous selection state from history entry

##### Acceptance Criteria

- [ ] UIStateStore has `inspectorHistory` stack
- [ ] Navigating to ConnectionInspector pushes current state to history
- [ ] Back button in ConnectionInspector pops history and restores state
- [ ] From port inspector: Back restores block + port selection
- [ ] From ModulationTable: Back restores cell focus
- [ ] From bus inspector: Back restores bus selection
- [ ] E2E test: Port inspector â†’ connection â†’ back â†’ verify port inspector restored

##### Technical Notes

History should be limited to 10 entries to prevent memory leaks. When selecting a new block/bus directly (not via back), clear history. This prevents confusing navigation chains.

Alternative approach: Single-level "previous state" instead of stack. This is simpler and covers 90% of use cases.

---

### P2 (Medium) - Polish and Enhancements

These items improve the user experience but are not required for v1 functionality.

---

#### P2-1: Connection Type Indicator and Color Coding

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P0-2 (ConnectionInspector component)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§1

##### Description

Add visual distinction for connection types using color coding, icons, and InspectorContainer header colors.

**Visual Design**:
- **Wire** (blockâ†’block): Blue header, wire icon (âš¡)
- **Publisher** (blockâ†’bus): Green header, broadcast icon (ðŸ“¡)
- **Listener** (busâ†’block): Purple header, receive icon (ðŸ“»)

**Implementation**:
1. Pass connection type as color prop to InspectorContainer
2. Add connection type badge/icon to header
3. Use consistent colors across app (port inspector, ModulationTable, bus inspector)

##### Acceptance Criteria

- [ ] InspectorContainer header color matches connection type
- [ ] Connection type icon displayed in header
- [ ] Colors consistent with existing bus/block color scheme
- [ ] Visual design reviewed and approved
- [ ] E2E test: Open each connection type â†’ verify correct color/icon

##### Technical Notes

InspectorContainer already supports color variants (see block inspector). Reuse existing design system tokens for consistency. Icons should be Unicode or inline SVG for simplicity (avoid icon library dependency).

---

#### P2-2: Swap Connection Enhanced UX

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P0-2 (ConnectionInspector component)
**Spec Reference**: N/A (new feature) â€¢ **Status Reference**: STATUS-2025-12-26-103000.md Â§1, Ambiguities Â§2

##### Description

Enhance the "Swap" button to provide inline re-targeting UI instead of navigating away.

**User Requirement** (clarification answer 2): "Context-dependent swapping of source/target"

**Behavior by Connection Type**:
- **Wire**: Dropdown of compatible blocks/ports, inline replacement
- **Publisher**: Dropdown of buses matching target type, inline replacement
- **Listener**: Dropdown of buses matching source type, inline replacement

**Implementation**:
1. Add "swap mode" state to ConnectionInspector
2. When swap clicked, render dropdown/selector instead of readonly display
3. On selection, update connection via BusStore/PatchStore
4. Exit swap mode, refresh inspector

##### Acceptance Criteria

- [ ] Swap button toggles inline editing mode
- [ ] Wire swap shows compatible target blocks/ports
- [ ] Publisher swap shows compatible buses
- [ ] Listener swap shows compatible buses
- [ ] Selecting new target updates connection immediately
- [ ] Cancel button exits swap mode without changes
- [ ] E2E test: Swap wire connection â†’ select new target â†’ verify connection updated

##### Technical Notes

Reuse compatibility logic from PortWiringPanel (`findCompatiblePorts`). For bus swapping, filter buses by type compatibility with port. Keep UI compact - dropdowns should not exceed inspector panel width.

---

## Dependency Graph

```
P0-1 (Selection State)
â”œâ”€â”€ P0-2 (ConnectionInspector)
â”‚   â”œâ”€â”€ P1-1 (Port Inspector Entry)
â”‚   â”œâ”€â”€ P1-2 (ModulationTable Entry)
â”‚   â”œâ”€â”€ P1-3 (Back Navigation)
â”‚   â”œâ”€â”€ P2-1 (Color Coding)
â”‚   â””â”€â”€ P2-2 (Swap UX)
â””â”€â”€ P0-3 (Embedded Lens Editor)
    â””â”€â”€ (used by P0-2)
```

**Critical Path**: P0-1 â†’ P0-2 â†’ P1-1/P1-2 â†’ P1-3

**Parallel Tracks**:
- P0-3 can be developed alongside P0-1/P0-2
- P2-1/P2-2 can be developed after P0-2 is functional

---

## Recommended Sprint Execution

**Sprint Scope**: 2-3 deliverables (as requested)

### Deliverable 1: Core Connection Inspector (P0)
- P0-1: Connection Selection State
- P0-2: ConnectionInspector Component
- P0-3: Embedded LensChainEditor Variant

**Why**: This establishes the foundation - the inspector can be tested manually by programmatically setting `selectedConnection`.

### Deliverable 2: Primary Entry Points (P1)
- P1-1: Port Inspector Entry Point
- P1-2: ModulationTable Entry Point

**Why**: Makes the feature accessible to users. The inspector is now fully functional for the primary workflows.

### Deliverable 3: Navigation Polish (P1)
- P1-3: Back Navigation Context Tracking

**Why**: Completes the UX - users can navigate in and out of the inspector smoothly.

**Deferred to Future Sprint**:
- P2-1: Color Coding (polish)
- P2-2: Swap UX (enhancement)
- PatchBay wire click entry point (not in v1 scope)

---

## Risk Assessment

### High-Risk Items

1. **Embedded Lens Editor Layout** (P0-3)
   - Risk: LensChainEditor may not fit inspector panel width
   - Mitigation: Test with multiple lenses, implement responsive parameter inputs
   - Fallback: Keep popover mode, add "Edit Lenses" button in inspector

2. **ModulationTable Click Conflicts** (P1-2)
   - Risk: Single-click interferes with existing focus/drag behaviors
   - Mitigation: Extensive E2E testing, preserve all existing handlers
   - Fallback: Use right-click "Inspect Connection" context menu option

3. **State Complexity** (P0-1, P1-3)
   - Risk: Four selection modes + history may cause bugs
   - Mitigation: Unit tests for all state transitions, clear mutual exclusion
   - Fallback: Simplify to single-level "previous state" instead of history stack

### Medium-Risk Items

1. **Connection Type Polymorphism** (P0-2)
   - Risk: Wire/publisher/listener have different data shapes
   - Mitigation: Type guards, adapter pattern for uniform interface
   - Complexity: Medium - already handled in BusStore/PatchStore

2. **Swap Button UX** (P2-2)
   - Risk: Inline re-targeting UI may be cramped in inspector panel
   - Mitigation: Prototype early, consider modal if inline doesn't work
   - Complexity: Medium - reuses existing compatibility logic

---

## Success Criteria

**Sprint Complete When**:
1. User can click connection in port inspector â†’ see ConnectionInspector
2. User can click bound cell in ModulationTable â†’ see ConnectionInspector
3. ConnectionInspector displays correct source/target for all connection types
4. User can edit lenses inline (embedded editor) for bus connections
5. User can disconnect from ConnectionInspector
6. User can navigate back to previous inspector state
7. All P0 and P1 acceptance criteria met
8. E2E tests passing for all entry points

**Definition of Done** (see separate DOD-2025-12-26-093147.md file for checklist)

---

## Technical Notes

### File Locations

| Component | File Path |
|-----------|-----------|
| UIStateStore | `src/editor/stores/UIStateStore.ts` |
| ConnectionInspector | `src/editor/ConnectionInspector.tsx` (new) |
| LensChainEditor | `src/editor/modulation-table/LensChainEditor.tsx` |
| PortWiringPanel | `src/editor/Inspector.tsx` (lines 46-479) |
| ModulationTable | `src/editor/modulation-table/ModulationTable.tsx` |
| InspectorContainer | `src/editor/components/InspectorContainer.tsx` |

### Testing Strategy

1. **Unit Tests**:
   - UIStateStore selection state transitions
   - Connection type detection and data extraction
   - Lens editor embedded mode rendering

2. **E2E Tests**:
   - Port inspector connection click flow
   - ModulationTable cell click flow
   - Connection inspect â†’ edit lenses â†’ disconnect
   - Back navigation from each entry point

3. **Manual Verification** (Chrome DevTools MCP):
   - Lens changes apply immediately (no "Done" button needed)
   - Inspector panel layout at various widths
   - Long lens chains (5+ lenses) render correctly
   - Color coding and icons match design

### MobX Patterns

Follow existing patterns from Inspector.tsx and BusInspector.tsx:
- Use `observer` wrapper for component
- Access stores via `useStore()` hook
- Read connection data from `patchStore.connections` / `busStore.publishers` / `busStore.listeners`
- Mutations only via store actions (never modify data directly)

### Type Safety

Connection type discrimination:
```typescript
type SelectedConnection =
  | { type: 'wire'; id: string }
  | { type: 'publisher'; id: string }
  | { type: 'listener'; id: string };

function getConnection(selection: SelectedConnection) {
  switch (selection.type) {
    case 'wire': return patchStore.connections.find(c => c.id === selection.id);
    case 'publisher': return busStore.getPublisher(selection.id);
    case 'listener': return busStore.getListener(selection.id);
  }
}
```

---

## Questions Resolved

All 5 clarification questions from STATUS-2025-12-26-103000.md have been answered:

1. **Connection types in scope**: All three (wire, publisher, listener)
2. **Swap meaning**: Context-dependent (wire: change target, publisher/listener: change bus)
3. **Entry points for v1**: Port inspector + ModulationTable (PatchBay deferred)
4. **Embedded lens layout**: Lens section visible for bus connections, "Add Lens" collapsed by default
5. **Back navigation**: Context-dependent (restore previous inspector state)

These decisions are reflected in the acceptance criteria and technical notes above.
