# Sprint Plan: UI Prep Refactor - Foundation Sprint
Generated: 2025-12-27-030440
Source: STATUS-2025-12-27-030500.md
Topic: UI Prep Refactor (design-docs/10-Refactor-for-UI-prep/)

---

## Executive Summary

**Current State:** 35-40% complete across 19 design documents. The IR compiler migration (ROADMAP Phase 6) has absorbed development focus, leaving the semantic kernel and validation layer incomplete. 79 test failures and 826 lint errors indicate accumulating technical debt.

**This Sprint Focus:** Establish a stable foundation by fixing the broken test suite, completing the kernel Op system, and making the transaction architecture operational. This sprint delivers 3 critical deliverables that unblock all future work.

**Sprint Scope:** 3 deliverables maximum
- **Deliverable 1:** Stabilize test suite (79 failures → 0)
- **Deliverable 2:** Complete kernel Op application layer
- **Deliverable 3:** Wire PatchStore to use kernel transactions

**Deferred to Future Sprints:**
- TimeRoot auto-publish to canonical buses
- Layout separation (lanes → ViewState)
- Validator integration with UI
- Query API (TxView surface)
- State preservation / hot-swap
- Undo/redo with history tree
- Performance tracking

**Risk Assessment:** Medium. The Op system implementation may reveal architectural issues with the current kernel design. Test stabilization may uncover deeper bugs requiring spec changes.

---

## Backlog by Priority

### P0 (Critical) - Deliverable 1: Stabilize Test Suite

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None
**Spec Reference**: All specs • **Status Reference**: STATUS-2025-12-27-030500.md §"Runtime Check Results"

#### Description
Fix all 79 test failures to restore confidence in the codebase. The STATUS report shows failures across 15 test files in TimeRoot, Debug, Inspector, and Renderer areas. Many failures are trivial (lint issues, unused vars), but some indicate real bugs (TimeRoot period handling). Without a passing test suite, we cannot safely build on top of existing work.

**Current Evidence from STATUS:**
- `just test` shows 79 failures, 1873 passed
- Failures span multiple subsystems
- Some failures are lint-related, others are behavioral bugs

#### Acceptance Criteria
- [ ] All 79 test failures resolved (0 failures, maintain 1873+ passing)
- [ ] No new test skips added - failures must be fixed, not hidden
- [ ] Identified bugs have corresponding issue numbers or inline TODOs with spec references
- [ ] `just test` passes cleanly in CI
- [ ] Test output shows clear summary of coverage by subsystem

#### Technical Notes
- Start with lint-related failures (quick wins)
- Group behavioral failures by subsystem (TimeRoot, Debug, Inspector, Renderer)
- TimeRoot period handling likely needs spec verification
- May need to update test expectations if behavior changed during IR migration
- Run `just test` after each batch of fixes to track progress

---

### P0 (Critical) - Deliverable 2: Complete Kernel Op Application

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: None
**Spec Reference**: PatchOpsCompleteSet.md, PatchSemantics.md • **Status Reference**: STATUS-2025-12-27-030500.md §8, §7

#### Description
Implement the complete `applyOp()` function for all 26 Op types defined in `src/editor/kernel/ops.ts`. Currently, the Op types exist but application logic is minimal stubs. This is the foundational layer that all transaction semantics depend on.

**Current Evidence from STATUS:**
- All 26 Op types defined (BlockAdd, WireAdd, BusUpdate, etc.)
- `applyOp()` implementation is minimal stub
- PatchKernel interface exists but implementation is incomplete
- Ops are serializable plain objects (good foundation)

**Op Types to Implement:**
1. **Block Ops** (5): BlockAdd, BlockRemove, BlockRetype, BlockSetLabel, BlockPatchParams
2. **Wire Ops** (3): WireAdd, WireRemove, WireRetarget
3. **Bus Ops** (3): BusAdd, BusRemove, BusUpdate
4. **Binding Ops** (6): PublisherAdd/Remove/Update, ListenerAdd/Remove/Update
5. **Composite Ops** (4): CompositeDefAdd/Remove/Update/ReplaceGraph
6. **Time Ops** (1): TimeRootSet
7. **Settings Ops** (1): PatchSettingsUpdate
8. **Asset Ops** (3): AssetAdd/Remove/Update

#### Acceptance Criteria
- [ ] `applyOp()` implementation handles all 26 Op types with full logic (no stubs)
- [ ] Each Op validates preconditions (e.g., WireAdd checks port compatibility)
- [ ] Invalid Ops return descriptive error results, not throw exceptions
- [ ] Unit tests for each Op type verify both success and failure paths
- [ ] Inverse Op generation works for all reversible Ops (undo support)
- [ ] Documentation shows which Ops are idempotent vs. state-dependent
- [ ] Integration test: Create block → Wire → Publish → Undo chain works end-to-end

#### Technical Notes
- Reference `src/editor/semantic/graph.ts` for validation logic
- Use PortRef (STATUS §2) for all port references
- WireAdd/Remove must update SemanticGraph wire index
- BusUpdate must validate name uniqueness
- CompositeDefUpdate requires deep equality checks on graph structure
- TimeRootSet is special - only one TimeRoot allowed per patch
- Consider transaction isolation - Ops should not have side effects on other Ops
- May need to extend PatchDocument type during implementation

---

### P0 (Critical) - Deliverable 3: Wire PatchStore to Kernel Transactions

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: Deliverable 2 (Complete Op Application)
**Spec Reference**: PatchSemantics.md, TransactionBuilderContract.md • **Status Reference**: STATUS-2025-12-27-030500.md §7, §9

#### Description
Migrate PatchStore from direct mutation to using kernel transactions. Currently PatchStore mutates the patch directly, bypassing the kernel architecture. This refactor makes the transaction system operational and enables future undo/redo.

**Current Evidence from STATUS:**
- PatchStore exists and manages lanes as semantic data
- Kernel types defined, but not integrated with stores
- TransactionBuilder interface exists (30% complete)
- No history tree or undo/redo yet

**Migration Strategy:**
1. Add `kernel: PatchKernel` to PatchStore
2. Replace direct mutations with `kernel.beginTx()` → `builder.addBlock()` → `builder.commit()`
3. Update all UI actions to use transaction API
4. Maintain observable state for MobX reactivity

#### Acceptance Criteria
- [ ] PatchStore uses kernel.beginTx() for all mutations (no direct patch edits)
- [ ] All UI actions (addBlock, addWire, updateBus, etc.) go through transaction builder
- [ ] MobX observables still react correctly to kernel-driven state changes
- [ ] Transaction rollback on validation failure (e.g., invalid wire) works correctly
- [ ] Existing UI functionality preserved (manual smoke test: create patch, add blocks, wire, run)
- [ ] Unit tests verify transaction isolation - failed Tx doesn't corrupt patch state
- [ ] Integration test: UI → TxBuilder → applyOp → SemanticGraph update → UI reaction chain works

#### Technical Notes
- Keep PatchStore observable for MobX - kernel commits trigger MobX reactions
- Use runInAction for batch updates
- Handle async operations carefully (transaction lifetime)
- May need to add transaction preview/dry-run capability
- DefaultSourceStore will also need kernel integration (phase 2 work)
- BusStore integration is separate (future sprint)

---

## P1 (High) - Deferred to Sprint 2

These are critical but blocked by foundation work:

### TimeRoot Auto-Publish to Canonical Buses
**Effort**: Medium (3-5 days)
**Dependencies**: Deliverable 3 (Kernel integration)
**Spec**: PhaseClock-Fix.md §"Auto-Publishing"

CycleTimeRoot should auto-create publishers: `phase → phaseA`, `wrap → pulse`. Currently manual.

### Layout Separation (Lanes → ViewState)
**Effort**: Large (1-2 weeks)
**Dependencies**: Deliverable 3 (Store refactor foundation)
**Spec**: Layout-As-Projection.md

Move lanes out of PatchDocument into separate ViewState store. Enables multi-UI.

### Validator Integration with UI
**Effort**: Medium (3-5 days)
**Dependencies**: Deliverable 3 (Transaction system operational)
**Spec**: DivergentTypes.md §"Preflight Validation"

Wire SemanticGraph validator to preflight UI mutations before transaction commit.

---

## P2 (Medium) - Deferred to Sprint 3+

### Query API Surface (TxView)
**Effort**: Large (1-2 weeks)
**Spec**: TxView-Query-Surface.md

Implement ActionsAPI (canWire, canListen), DiagnosticsAPI, PortInfo badges, PlannedTransaction previews.

### State Preservation / Hot-Swap
**Effort**: Large (1-2 weeks)
**Spec**: StatePreservationContract.md

Layout-hash matching, cache discard policy for runtime state preservation on edits.

### Undo/Redo with History Tree
**Effort**: XL (2+ weeks)
**Dependencies**: Deliverable 3, Inverse Op generation
**Spec**: TransactionBuilderContract.md §"History Tree"

Branching undo/redo with persistent history tree.

---

## P3 (Low) - Future Optimization

### Performance Tracking
**Effort**: Medium (3-5 days)
**Spec**: Performance.md

Explicit performance budgets and tracking (currently implicit/unmonitored).

### Lens & Adapter Completion
**Effort**: Large (1-2 weeks)
**Specs**: CanonicalLenses.md, AdaptersCanonical-n-Impl.md

Comprehensive lens catalog, auto-adapter selection algorithm.

---

## Dependency Graph

```
[Foundation Sprint - THIS SPRINT]

Deliverable 1: Stabilize Tests (79→0)
    ↓
    [Confidence Restored]
    ↓
Deliverable 2: Complete applyOp() [26 Ops]
    ↓
Deliverable 3: Wire PatchStore → Kernel Tx
    ↓
    [Foundation Complete]

[Sprint 2 - Blocked by Foundation]

TimeRoot Auto-Publish
    ↓
Layout Separation (Lanes → ViewState)
    ↓
Validator Integration
    ↓
    [Edit-Time Correctness]

[Sprint 3+ - Advanced Features]

Query API (TxView)
State Preservation
Undo/Redo History Tree
Performance Tracking
Lens/Adapter Completion
```

---

## Recommended Sprint Planning

### Sprint 1 (THIS SPRINT) - Foundation
**Duration**: 2-3 weeks
**Goal**: Stable test suite + operational kernel transaction system

**Week 1:**
- Days 1-2: Fix trivial test failures (lint, unused vars)
- Days 3-5: Fix behavioral test failures (TimeRoot, Debug)

**Week 2:**
- Days 1-3: Implement applyOp() for Block/Wire/Bus Ops
- Days 4-5: Implement applyOp() for Binding/Composite Ops

**Week 3:**
- Days 1-3: Wire PatchStore to kernel transactions
- Days 4-5: Integration testing, smoke testing

**Success Criteria:**
- All tests pass
- UI uses kernel transactions exclusively
- No regression in existing functionality

### Sprint 2 - Semantic Correctness
**Duration**: 2-3 weeks
**Focus**: TimeRoot auto-publish, Layout separation, Validator integration

### Sprint 3 - Advanced Features
**Duration**: 3-4 weeks
**Focus**: Query API, State preservation, Undo/redo

---

## Risk Assessment

### High-Risk Items Requiring Investigation

**Risk 1: Op Implementation Complexity**
- **Issue**: The 26 Ops may have interdependencies not captured in current design
- **Impact**: Implementation may require kernel architecture changes
- **Mitigation**: Start with simple Ops (BlockAdd, WireAdd), defer complex (CompositeDefUpdate)
- **Investigation needed**: How do Composite Ops interact with nested TimeRoots?

**Risk 2: MobX Integration with Kernel**
- **Issue**: Kernel mutations may not trigger MobX reactions correctly
- **Impact**: UI may desync from patch state
- **Mitigation**: Use runInAction, ensure kernel commits are observable events
- **Investigation needed**: Test MobX reaction chains early in Deliverable 3

**Risk 3: Test Failures Hide Spec Changes**
- **Issue**: Some test failures may indicate IR migration changed semantics
- **Impact**: Fixing tests may contradict spec requirements
- **Mitigation**: Cross-reference failing tests with spec documents before fixing
- **Investigation needed**: TimeRoot period handling (STATUS mentions this specifically)

---

## Blockers and Questions

**No blocking ambiguities** - The STATUS report confirms all gaps are clear implementation work.

**Non-blocking questions for future sprints:**
1. How should layout triggers work after separation? (Block add/remove only?)
2. Which type conversions should auto-adapt, and what's the cost model?
3. Should transactions support optimistic locking for multi-user scenarios?

These can be resolved during implementation.

---

## Success Metrics

**Sprint Completion Criteria:**
- [ ] `just test` passes (0 failures)
- [ ] `just typecheck` passes (already passing)
- [ ] All 26 Op types fully implemented with tests
- [ ] PatchStore exclusively uses kernel transactions
- [ ] Existing UI functionality preserved (manual smoke test)
- [ ] No new lint errors introduced (ideally reduce from 826)

**Long-term Progress Indicators:**
- Foundation Sprint → 50-55% overall completion (from 35-40%)
- Sprint 2 → 70-75% completion
- Sprint 3 → 90%+ completion

---

## Notes for Implementation

### Deliverable 1: Test Stabilization
- Run tests in watch mode: `just test -- --watch`
- Group failures by category (lint vs. behavioral)
- Create GitHub issues for bugs that need spec clarification
- Update test snapshots if IR migration changed expected output

### Deliverable 2: Op Implementation
- Reference existing validation in `src/editor/semantic/validator.ts`
- Use TypeScript discriminated unions for Op result types
- Write tests BEFORE implementing each Op (TDD)
- Document idempotency guarantees for each Op type

### Deliverable 3: Store Integration
- Create feature branch for PatchStore refactor
- Add kernel instance to RootStore first
- Migrate one action at a time (addBlock, then addWire, etc.)
- Keep old mutation code commented for 1-2 commits (safety)
- Use Chrome DevTools MCP to verify UI still works after each migration

---

## File Management Hygiene

This plan follows the topic directory structure:
- **Location**: `.agent_planning/ui-prep-refactor/`
- **Generated Files**: `PLAN-2025-12-27-030440.md`, `DOD-2025-12-27-030440.md`
- **Source**: `STATUS-2025-12-27-030500.md` (authoritative input)

After this plan, maintain max 4 files per prefix (PLAN, DOD, SPRINT). Archive older files to `archive/` subdirectory.

---

## Next Steps

After this sprint completes:
1. Run project-evaluator again to generate new STATUS snapshot
2. Plan Sprint 2 focusing on TimeRoot auto-publish, layout separation, validator integration
3. Re-evaluate remaining 7 incomplete issues from Overview.md

**Ready for**: `/dev-loop:implement` or manual implementation following this plan.
