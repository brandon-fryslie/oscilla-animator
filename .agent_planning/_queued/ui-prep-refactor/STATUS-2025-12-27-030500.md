# Status Report: UI Prep Refactor
Timestamp: 2025-12-27-030500
Scope: project/full (design-docs/10-Refactor-for-UI-prep/)
Confidence: FRESH

## Executive Summary

**Overall Completion: ~35-40%**
- 2 of 9 original issues DONE (Port Identity, Time Authority)
- Semantic Kernel: ~60% infrastructure built, not integrated
- Op System: Types defined, transaction builder stub only
- Remaining 5 issues: 0-15% each

**Critical Gaps:** 79 failing tests, 826 lint errors. The IR compiler migration (ROADMAP Phase 6) has been the focus, leaving spec compliance incomplete.

**Workflow Recommendation: CONTINUE** - Issues are clear; no blocking ambiguities require clarification.

---

## Spec-by-Spec Analysis

### 1. Overview.md - Master Issue List
**Status:** PARTIAL - Framework document, lists 9 issues
**Evidence:** HANDOFF shows 2/9 complete

| Issue | Status | Notes |
|-------|--------|-------|
| 1. Two time systems | DONE | Player time monotonic |
| 2. Layout as semantic | NOT STARTED | Lanes still in Patch |
| 3. Invariants at compile-time only | PARTIAL | Semantic validator exists, not integrated with UI |
| 4. Macro/Composite boundary | NOT STARTED | Composites still expand unsafely |
| 5. Bus semantics split | PARTIAL | BusSemantics module exists |
| 6. Port identity ambiguity | DONE | PortRef uses slotId+direction |
| 7. Settings grab-bag | NOT STARTED | Settings not partitioned |
| 8. Persistence missing | NOT STARTED | No serialization discipline |
| 9. No incremental compile | PARTIAL | IR compiler bridge, but not incremental |

---

### 2. PortIdentity.md - Canonical Port Identity
**Status: DONE**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/types.ts:190-194`: PortRef interface with `blockId`, `slotId`, `direction`
- `src/editor/semantic/types.ts:72-76`: PortKey mirrors this
- Kernel ops use PortRef throughout

**Spec Compliance:**
- [x] Canonical PortRef = {blockId, slotId, dir}
- [x] All connections/bindings store PortRef
- [x] Deterministic string serialization (portKeyToString)
- [x] Used in kernel ops (ops.ts lines 61-75)

**Remaining Gap:** The old `BindingEndpoint` name is still referenced in compiler error types (pass4-depgraph.ts line 44) but the actual type is gone.

---

### 3. Time.md - TimeRoot as Sole Authority
**Status: DONE**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/runtime/player.ts:80-82`: "TimeModel from compiler (Phase 3: TimeRoot)"
- `src/editor/runtime/player.ts:270-274`: applyTimeModel() - Player obeys, doesn't define
- Player time is monotonic; no wrapping in Player.tick()
- TimeRoot blocks exist (FiniteTimeRoot, InfiniteTimeRoot)

**Spec Compliance:**
- [x] Player time monotonic
- [x] TimeModel from compiler, not player
- [x] Player obeys topology, doesn't define it

**Note:** Commit `1857bb8` made time monotonic per HANDOFF.

---

### 3.5. PhaseClock-Fix.md - PhaseClock Demotion
**Status: PARTIAL (70%)**
**Confidence: RECENT**

**Implementation Evidence:**
- PhaseClock exists as operator block, not authority
- TimeRoot outputs phase
- `phaseA` bus auto-publishing: NOT VERIFIED

**Gap:** HANDOFF lists "TimeRoot doesn't auto-publish to canonical buses" as remaining work. The spec requires:


---

### 4. Layout-As-Projection.md - Lanes as View, Not Semantic
**Status: NOT STARTED (0%)**
**Confidence: FRESH**

**Current State:**
- `src/editor/types.ts` still has `Lane` in Patch structure
- `src/editor/stores/PatchStore.ts` manages lanes as semantic data
- No ViewState/GraphLayout separation exists

**Spec Requirements Not Met:**
- [ ] PatchDocument must be UI-agnostic
- [ ] Layout in ViewState, not Patch
- [ ] Deterministic auto-layout
- [ ] Multi-UI support

---

### 5. DivergentTypes.md - Shared Validation Layer
**Status: PARTIAL (60%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/semantic/` directory exists with 6 files
- `SemanticGraph` class fully implemented (graph.ts, 511 lines)
- `ValidationResult` type defined (types.ts)
- `validator.ts` exists with some rules

**What Works:**
- Graph construction from PatchDocument
- Cycle detection (Tarjan's SCC)
- Port type lookup

**Gaps:**
- [ ] Validator not integrated with UI mutations
- [ ] No preflight validation on edits
- [ ] UI still allows invalid states
- [ ] Compiler still has separate validation logic

---

### 6. DivergentTypesPrevious.md - Historical Context
**Status: N/A** - Reference document only

---

### 7. PatchSemantics.md - Semantic Kernel Architecture
**Status: PARTIAL (50%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/kernel/` directory with 7 files
- `PatchKernel` interface defined (types.ts:144-158)
- `TxBuilder` interface defined (types.ts:98-138)
- `SemanticGraph` exists in separate `semantic/` module

**What Exists:**
- All Op types defined (ops.ts, 231 lines)
- Kernel types match spec closely
- Basic structure for transactions

**Gaps:**
- [ ] PatchKernel implementation is stub (`PatchKernel.ts` exists but minimal)
- [ ] TransactionBuilder partially implemented
- [ ] No history tree
- [ ] Not integrated with stores (PatchStore still mutates directly)

---

### 8. PatchOpsCompleteSet.md - Transaction Operations
**Status: DONE (Types Only)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/kernel/ops.ts` defines all 26 Op types:
  - Block: BlockAdd, BlockRemove, BlockRetype, BlockSetLabel, BlockPatchParams
  - Wire: WireAdd, WireRemove, WireRetarget
  - Bus: BusAdd, BusRemove, BusUpdate
  - Composite: CompositeDefAdd/Remove/Update/ReplaceGraph
  - Time: TimeRootSet
  - Settings: PatchSettingsUpdate
  - Asset: AssetAdd/Remove/Update

**Spec Compliance:**
- [x] All ops from spec defined
- [x] Ops are serializable (plain objects)
- [x] Union type Op covers all cases

**Gap:** Ops exist as types but `applyOp()` implementation is minimal.

---

### 9. TransactionBuilderContract.md - Transaction API
**Status: PARTIAL (30%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/kernel/types.ts:98-138`: TxBuilder interface matches spec
- `src/editor/kernel/TransactionBuilder.ts` exists

**What's Missing:**
- [ ] Actual transaction application
- [ ] Inverse op generation
- [ ] History tree persistence
- [ ] Undo/redo with branching
- [ ] Integration with stores

---

### 10. TxView-Query-Surface.md - Query API
**Status: STUB (10%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `TxView` interface exists (types.ts:92-96)
- Only `doc` and `graph` properties defined

**Spec Requirements Not Met:**
- [ ] ActionsAPI (canWire, canListen, etc.)
- [ ] DiagnosticsAPI
- [ ] PortInfo with badges
- [ ] PlannedTransaction for previews

---

### 11. DiffSummary.md - Semantic Diff Detection
**Status: PARTIAL (40%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/kernel/diff.ts` exists
- `DiffSummary` type defined (types.ts:38-45)
- `EntityDiff` with created/removed/updated

**Missing:**
- [ ] Semantic diff computation
- [ ] Runtime impact analysis
- [ ] Affected region computation

---

### 12. StatePreservationContract.md - Hot-Swap
**Status: NOT STARTED (0%)**
**Confidence: FRESH**

**Current State:**
- No state preservation on patch edits
- No layout-hash matching
- No cache discard policy

---

### 13. DefaultSources.md - Inputs Always Have Sources
**Status: PARTIAL (60%)**
**Confidence: FRESH**

**Implementation Evidence:**
- `src/editor/stores/DefaultSourceStore.ts` (220+ lines)
- `DefaultSourceState` type defined
- Block creation creates default sources for inputs
- Value editing works

**What Works:**
- Default sources created for block inputs
- Values editable
- Cleanup on block removal

**Gaps:**
- [ ] Implicit binding to `phaseA` for phase inputs
- [ ] Source replacement rule not fully enforced
- [ ] UI doesn't always show "Default" badge

---

### 14. RemoveParams.md - Parameters Become Inputs
**Status: PARTIAL (50%)**
**Confidence: FRESH**

**Evidence:** DefaultSourceStore exists and is used, but:
- Some blocks still have `params` in old style
- Not all inputs converted to default source pattern

---

### 15. Performance.md - Performance Constraints
**Status: IMPLICIT (0%)**
**Confidence: FRESH**

No explicit performance tracking or budget enforcement.

---

### 16. AdapterVsLens.md - Adapter vs Lens Distinction
**Status: PARTIAL (40%)**
**Confidence: FRESH**

**Implementation Evidence:**
- Types separated in `types.ts`

**Gaps:**
- [ ] Lenses not fully type-preserving enforced
- [ ] No visual distinction in UI

---

### 17. CanonicalLenses.md - Lens Catalog
**Status: PARTIAL (30%)**
**Confidence: FRESH**

**Evidence:**
- Some lens types defined
- LensEditorPanel component exists

**Gap:** No comprehensive catalog per spec.

---

### 18. LensDefaultSources-n-Impl.md - Lens Parameter Bindings
**Status: PARTIAL (40%)**
**Confidence: FRESH**

**Evidence:**
- Lens instances have parameters
- DefaultSourceStore handles lens params

---

### 19. AdaptersCanonical-n-Impl.md - Auto-Adapter Algorithm
**Status: PARTIAL (30%)**
**Confidence: FRESH**

**Evidence:**
- Some adapters in compiler
- No auto-adapter selection algorithm

---

## Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| `just typecheck` | FAIL | 0 errors (passes) |
| `just lint` | FAIL | 826 errors, 100 warnings |
| `just test` | FAIL | 79 failures, 1873 passed |

### Test Failure Summary
- 15 test files failing
- Many failures in TimeRoot, Debug, Inspector, Renderer areas
- Some failures are lint-related (unused vars, any types)

---

## Data Flow Verification

| Flow | Input | Validate | Store | Retrieve | Display |
|------|-------|----------|-------|----------|---------|
| Block Add | OK | PARTIAL | OK | OK | OK |
| Wire Add | OK | PARTIAL | OK | OK | OK |
| Bus Publish | OK | PARTIAL | OK | OK | OK |
| Transaction | STUB | STUB | STUB | N/A | N/A |

---

## Ambiguities Found

| Area | Question | Impact |
|------|----------|--------|
| Kernel Integration | How to migrate stores to use kernel transactions? | HIGH - fundamental architecture change |
| Layout Separation | What triggers re-layout? Block add/remove only? | MEDIUM - affects UX |
| Auto-Adapter | Which types auto-convert? What's the cost model? | MEDIUM - affects type compat |

These are implementation decisions, not blocking ambiguities - they can be resolved during implementation.

---

## Dependencies Between Work Items

```
Port Identity (DONE)
    |
    v
Semantic Graph (60%) ---> Validator Integration (0%)
    |                           |
    v                           v
Kernel Types (DONE) -------> Kernel Implementation (30%)
    |                           |
    v                           v
Op Types (DONE) -----------> applyOp (10%)
                                |
                                v
                          Transaction Builder (30%)
                                |
                                v
                          Store Integration (0%)
                                |
                                +---> Undo/Redo (0%)
                                |
                                +---> History Tree (0%)

Time Authority (DONE)
    |
    v
TimeRoot auto-publish (0%) ---> Implicit phaseA binding (0%)

Layout Projection (0%) <--- blocked by Store Integration
```

---

## Recommendations (Priority Order)

### 1. Fix Test Failures (IMMEDIATE)
- 79 failing tests block confidence
- Many are trivial (lint issues, unused vars)
- Some are real bugs (TimeRoot period handling)

### 2. Complete Kernel Implementation
- `applyOp()` for all op types
- Inverse op generation
- Wire stores to use kernel transactions

### 3. TimeRoot Auto-Publish

- Implicit phase binding for unconnected phase inputs

### 4. Layout Separation
- Move lanes out of Patch
- Create ViewState store
- This unblocks multi-UI

### 5. Validator Integration
- Wire SemanticGraph.validator to UI mutations
- Preflight checks before edits

---

## IR Compiler Migration Context

The ROADMAP shows extensive IR compiler work (Phases 1-6) that parallels but doesn't directly address the UI prep refactor specs. Key observations:

- **Phase 1-2 (DONE):** IR types and data structures
- **Phase 3 (DONE):** Bridge compiler with dual-emit
- **Phase 4-5 (DONE):** SignalExpr/FieldExpr evaluators
- **Phase 6 (IN PROGRESS):** Scheduled runtime

**Tension:** The IR migration work has consumed focus, leaving the semantic kernel and validation layer incomplete. These are complementary but separate concerns:
- IR = runtime execution model
- Semantic Kernel = edit-time correctness model

---

## Verdict

**Status:** 35-40% complete across 19 specs
**Workflow:** CONTINUE - all gaps are clear, no blocking ambiguities
**Risk:** Test failures and lint errors indicate technical debt accumulating

**Next Actions:**
1. Stabilize tests (fix 79 failures)
2. Complete kernel applyOp implementation
3. Implement TimeRoot auto-publish to phaseA
4. Wire stores to kernel transactions
