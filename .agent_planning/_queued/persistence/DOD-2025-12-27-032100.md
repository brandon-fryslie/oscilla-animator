# Definition of Done: Patch Persistence (Save/Load)

**Generated**: 2025-12-27-032100
**Plan**: PLAN-2025-12-27-032100.md
**Topic**: persistence

---

## Sprint 1: Core Save/Load Functionality

**Sprint Goal**: Users can save and load patches via UI buttons with keyboard shortcuts and error handling.

**Deliverables**: Save to File (P0.1), Load from File (P0.2), Keyboard Shortcuts (P1.1), Error Messages (P1.2)

---

## Acceptance Criteria

### Deliverable 1: Save to File (P0.1)

- [ ] Save button is enabled in SettingsToolbar (not disabled)
- [ ] Clicking Save button triggers file download with current patch data
- [ ] Downloaded file is valid JSON matching Patch type schema (version: 2)
- [ ] Filename format is `patch-YYYY-MM-DD-HHmmss.oscilla.json` (ISO timestamp format)
- [ ] JSON is pretty-printed with indentation (`JSON.stringify(patch, null, 2)`) for human readability
- [ ] Download works in Chrome, Firefox, and Safari
- [ ] Error handling: If `RootStore.toJSON()` throws exception, user sees clear error message
- [ ] Object URL is properly cleaned up after download (`URL.revokeObjectURL()`)
- [ ] Button tooltip updated (removed "Phase 6" message)

---

### Deliverable 2: Load from File (P0.2)

- [ ] Load button is enabled in SettingsToolbar (not disabled)
- [ ] Clicking Load button opens native browser file picker dialog
- [ ] File picker accepts `.json` and `.oscilla.json` file extensions
- [ ] On file selection, confirmation dialog appears with message: "Load this patch? Current patch will be replaced. Unsaved changes will be lost."
- [ ] On confirm, patch is loaded via `RootStore.loadPatch()` and all state is restored:
  - [ ] Blocks are restored with correct IDs, types, params, inputs, outputs
  - [ ] Connections are restored with correct source/target blocks and pins
  - [ ] Lanes are restored with correct blockIds and collapse state
  - [ ] Buses are restored with correct types and combine modes
  - [ ] DefaultSources are restored with correct pin/bus mappings
  - [ ] Settings are restored (seed, speed, currentLayoutId, compiler mode)
- [ ] On cancel in confirmation dialog, file picker closes and current patch remains unchanged
- [ ] Error handling: Invalid JSON syntax shows clear error message "Invalid JSON file. Please check the file format."
- [ ] Error handling: Missing required fields (blocks, connections, version) shows clear error message listing missing fields
- [ ] File input element is reset after successful load (allows reloading same file)
- [ ] Button tooltip updated (removed "Phase 6" message)
- [ ] Round-trip test passes: Save a patch → Load the saved file → All state matches exactly

---

### Deliverable 3: Keyboard Shortcuts (P1.1)

- [ ] Cmd+S (macOS) or Ctrl+S (Windows/Linux) triggers save operation (same behavior as clicking Save button)
- [ ] Cmd+O (macOS) or Ctrl+O (Windows/Linux) triggers load operation (same behavior as clicking Load button)
- [ ] Keyboard shortcuts do NOT trigger when user is typing in input fields, textareas, or contenteditable elements
- [ ] Save button tooltip includes keyboard shortcut: "Save patch (Cmd+S)" or "Save patch (Ctrl+S)" depending on OS
- [ ] Load button tooltip includes keyboard shortcut: "Load patch (Cmd+O)" or "Load patch (Ctrl+O)" depending on OS
- [ ] Shortcuts work consistently across Chrome, Firefox, and Safari
- [ ] Shortcuts are properly removed/disabled when component unmounts (no memory leaks)

---

### Deliverable 4: Error Messages (P1.2)

- [ ] File read errors (FileReader failure) show message: "Failed to read file. Please try again."
- [ ] JSON parse errors (malformed JSON) show message: "Invalid JSON file. Please check the file format."
- [ ] Validation errors (missing fields) show message: "Invalid patch file. Missing required fields: [list of fields]"
- [ ] Unknown version number shows message: "Unsupported patch version: X. This file may have been created by a newer version."
- [ ] Serialization errors (toJSON failure) show message: "Failed to save patch. Please check the console for details."
- [ ] All errors are logged to browser console with full error details for debugging
- [ ] Error messages are displayed in visible UI element (not just console)
- [ ] Error messages auto-dismiss after 5 seconds
- [ ] Error messages have a close button for manual dismissal
- [ ] Error messages do not block further user interaction (non-modal)

---

## Sprint Completion Checklist

### Functional Requirements
- [ ] All acceptance criteria above are met
- [ ] Manual testing confirms save/load workflow works end-to-end
- [ ] Round-trip test: Create patch with blocks → Save → Clear patch → Load → State restored correctly
- [ ] Cross-browser testing (Chrome, Firefox, Safari) passes

### Code Quality
- [ ] No TypeScript errors (`just typecheck`)
- [ ] No linting errors (`just lint-fix`)
- [ ] Code follows existing patterns from PathManagerModal.tsx and pathLibrary/storage.ts
- [ ] Error handling uses try/catch blocks around all file operations
- [ ] Console logs are appropriate (errors only, no debug logs in production)

### Documentation
- [ ] Code comments explain non-obvious logic (especially error handling)
- [ ] Button tooltips are updated with keyboard shortcuts
- [ ] Filename convention is documented in code comments

### Out of Scope (Deferred)
- localStorage auto-save/recovery → Sprint 2
- Automated unit tests → Sprint 3
- E2E tests → Sprint 3
- Export button (animation export) → Future sprint
- Cloud storage → Future sprint
- Custom modal dialogs (using native `window.confirm()` for MVP) → Future sprint

---

## Success Criteria (Sprint 1 Complete)

**Must achieve ALL of the following**:

1. **User can save patches**:
   - Click Save button → JSON file downloads to disk
   - File is valid JSON and can be opened in text editor
   - File contains all patch state (blocks, connections, etc.)

2. **User can load patches**:
   - Click Load button → File picker opens
   - Select JSON file → Confirmation dialog appears
   - Confirm → Patch is loaded and editor updates

3. **User can use keyboard shortcuts**:
   - Cmd/Ctrl+S saves patch
   - Cmd/Ctrl+O loads patch
   - Shortcuts don't interfere with typing

4. **Errors are handled gracefully**:
   - Invalid files show clear error messages
   - Errors don't crash the app
   - User can continue working after error

5. **Round-trip integrity**:
   - Save → Load → All state matches exactly
   - No data loss in serialization/deserialization
   - Tested with complex patches (multiple blocks, connections, buses)

---

## Testing Checklist (Manual Verification)

### Save Functionality
- [ ] Save empty patch → File downloads
- [ ] Save patch with 1 block → File contains block data
- [ ] Save patch with blocks + connections → File contains all data
- [ ] Open saved file in text editor → JSON is readable and properly formatted
- [ ] Check filename → Matches `patch-YYYY-MM-DD-HHmmss.oscilla.json` format

### Load Functionality
- [ ] Load valid patch file → Patch is restored correctly
- [ ] Load file, cancel confirmation → Current patch unchanged
- [ ] Load file, confirm → Blocks appear in editor
- [ ] Load file with connections → Connections are visible
- [ ] Load file with settings → Settings (seed, speed) are restored
- [ ] Load invalid JSON file → Error message appears
- [ ] Load file missing required fields → Error message appears

### Keyboard Shortcuts
- [ ] Cmd/Ctrl+S → Save dialog/download appears
- [ ] Cmd/Ctrl+O → File picker opens
- [ ] Type in input field, press Cmd/Ctrl+S → No save (shortcut blocked)
- [ ] Type in textarea, press Cmd/Ctrl+O → No load (shortcut blocked)

### Error Handling
- [ ] Load corrupted file → Error message appears and auto-dismisses after 5s
- [ ] Load file with wrong format → Error message has close button
- [ ] Error appears → Click close button → Error disappears
- [ ] Error appears → Wait 5s → Error auto-dismisses

### Round-Trip
- [ ] Create patch: Add TimeRoot (Cycle), Draw block, connection
- [ ] Save patch
- [ ] Click "Clear All" to empty editor
- [ ] Load saved patch
- [ ] Verify: TimeRoot block present with correct params
- [ ] Verify: Draw block present with correct params
- [ ] Verify: Connection present and correct
- [ ] Verify: Settings (seed, speed) match original

---

## Demo Script (for User Acceptance)

**Goal**: Show that save/load works end-to-end

1. **Setup**: Open Oscilla editor in browser
2. **Create patch**:
   - Add a Cycle TimeRoot block (duration: 2s)
   - Add a Circle Draw block
   - Connect TimeRoot.phase → Circle.radius
   - Verify animation plays (circle pulses)
3. **Save patch**:
   - Click "Save" button (or Cmd/Ctrl+S)
   - Verify file downloads to disk
   - Open file in text editor → See JSON with blocks/connections
4. **Clear patch**:
   - Click "Clear All" button
   - Verify editor is empty
5. **Load patch**:
   - Click "Load" button (or Cmd/Ctrl+O)
   - Select saved file
   - Confirm in dialog
   - Verify patch is restored
   - Verify animation plays again (circle pulses)
6. **Error handling**:
   - Click "Load"
   - Select a non-JSON file (e.g., image)
   - Verify error message appears
   - Close error or wait for auto-dismiss

**Success**: User can confidently save/load work without data loss.

---

## Notes for Implementer

- **Reference files**:
  - `PathManagerModal.tsx:295-308` for file download pattern
  - `PathManagerModal.tsx:83-106` for file upload pattern
  - `pathLibrary/storage.ts` for localStorage patterns (Sprint 2)

- **Filename timestamp format**:
  ```typescript
  const now = new Date();
  const timestamp = now.toISOString()
    .replace(/[:.]/g, '-')
    .replace('T', '-')
    .slice(0, 19);
  const filename = `patch-${timestamp}.oscilla.json`;
  ```

- **Validation**:
  - Check `typeof patch === 'object'`
  - Check `typeof patch.version === 'number'`
  - Check `Array.isArray(patch.blocks)`
  - Check `Array.isArray(patch.connections)`
  - More detailed validation handled by `loadPatch()`

- **Error UI**:
  - Use simple DOM element for MVP (toast notification or inline message)
  - Auto-dismiss with `setTimeout(() => setError(null), 5000)`
  - Add close button with `onClick={() => setError(null)}`
  - Future: Replace with proper toast notification library

- **Keyboard shortcuts**:
  - Check `event.target` to detect input/textarea focus
  - Use `event.preventDefault()` to stop browser default behavior
