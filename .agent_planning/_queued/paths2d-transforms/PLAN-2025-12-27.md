# Plan: Paths2D Milestone 2 - Path Transform Operations

## Overview
Implement path transform operations that allow per-element path manipulation with signal-driven animation.

## Current State
- Milestone 1 complete: PathConst and RenderPaths2D blocks work with const paths
- Field<path> type added to SlotType
- executeMaterializePath supports `const` and `busCombine` field expressions
- Error messages in place for unsupported operations (map, zip, transform)

## Implementation Plan

### Phase 1: Field Operation Infrastructure

**Step 1.1: Add Path Operations to FieldOp Enum**
File: `src/editor/runtime/field/types.ts`
- Add PathTranslate, PathScale, PathRotate to FieldOp const
- These are already stubbed but need proper implementation

**Step 1.2: Implement Path Transform Functions**
File: `src/editor/runtime/executor/steps/executeMaterializePath.ts`

For each transform operation, implement:
```typescript
function applyPathTranslate(path: PathExpr, dx: number, dy: number): PathExpr
function applyPathScale(path: PathExpr, sx: number, sy: number): PathExpr
function applyPathRotate(path: PathExpr, angle: number): PathExpr
```

Each function creates a new PathExpr with transformed coordinates.

### Phase 2: Field Expression Evaluation

**Step 2.1: Handle Map Operations in executeMaterializePath**
Update `resolvePathExprFromField` to handle `map` field nodes:
- Read the source field expression
- Get the operation opcode (PathTranslate, PathScale, PathRotate)
- Read signal parameters from runtime slots
- Apply transform to each path in the source

**Step 2.2: Signal Parameter Resolution**
- Map operations need signal values for transform parameters
- Read from runtime.values using slot references in field node
- Evaluate signals once per frame, apply to all elements

### Phase 3: UI Block

**Step 3.1: PathTransform2D Block Definition**
File: `src/editor/blocks/domain.ts`
```typescript
export const PathTransform2D = createBlock({
  type: 'PathTransform2D',
  inputs: [
    input('path', 'Path', 'Field<path>'),
    input('fn', 'Transform', 'Signal<string>'),  // translate/scale/rotate
    input('dx', 'Offset X', 'Signal<number>'),
    input('dy', 'Offset Y', 'Signal<number>'),
    input('sx', 'Scale X', 'Signal<number>'),
    input('sy', 'Scale Y', 'Signal<number>'),
    input('angle', 'Angle', 'Signal<number>'),
  ],
  outputs: [
    output('out', 'Path', 'Field<path>'),
  ],
});
```

### Phase 4: Compiler Support

**Step 4.1: PathTransform2D Compiler Block**
File: `src/editor/compiler/blocks/domain/PathTransform2D.ts`
- IR lowering: emit `field.map(pathExpr, opcode, params)`
- Map opcode to PathTranslate/Scale/Rotate based on config
- Store signal slots for dx, dy, sx, sy, angle params

**Step 4.2: Schedule Builder Support**
File: `src/editor/compiler/ir/buildSchedule.ts`
- Ensure path field map operations emit correct step ordering
- Signal parameters must be evaluated before path materialization

### Phase 5: Integration

**Step 5.1: Wire Everything Together**
- Export PathTransform2D from block registry
- Test with PathConst → PathTransform2D → RenderPaths2D

**Step 5.2: Signal Animation Test**
- Connect Oscillator → PathTransform2D dx input
- Verify paths animate smoothly

## Files to Modify/Create

**Modify:**
- `src/editor/runtime/field/types.ts` - FieldOp enum already has stubs
- `src/editor/runtime/executor/steps/executeMaterializePath.ts` - Add map handling
- `src/editor/blocks/domain.ts` - Add PathTransform2D block
- `src/editor/compiler/blocks/domain/index.ts` - Export new compiler
- `src/editor/compiler/blocks/index.ts` - Register new compiler

**Create:**
- `src/editor/compiler/blocks/domain/PathTransform2D.ts` - Compiler block

## Dependencies
- Milestone 1 must be complete (verified ✓)
- Field<path> type support (verified ✓)

## Risk Areas
- Signal parameter resolution in path materialization context
- Ensuring transforms apply correctly to all command types (M, L, Q, C, Z)
- Performance with large path counts

## Testing Strategy
- Manual validation via Chrome DevTools MCP
- Create test patch, verify rendered output
- Animate transform params, verify smooth updates
