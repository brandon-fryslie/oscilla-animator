# Status Report - Primitives & Kernel Architecture
**Timestamp**: 2025-12-27-030200
**Scope**: primitives/kernel-architecture
**Confidence**: FRESH
**Git Commit**: abb894c

## Executive Summary

**Overall Implementation**: ~25% complete
**Critical Gaps**: 8
**Test Suite**: 1873 passing, 79 failing (15 test files with failures)
**Verdict**: CONTINUE - Implementation gaps are well-defined, no blocking ambiguities

The design docs in `design-docs/7-Primitives/` specify a comprehensive **closed primitive set** with capability-based enforcement. The current codebase has **none of the enforcement mechanisms** in place - blocks exist but lack capability metadata, validation is absent, and CI checks do not exist.

---

## What Exists vs. Design Spec

### 1. Kernel Capabilities (Spec: 5 capabilities)

| Capability | Spec | Implementation Status |
|------------|------|----------------------|
| `time` | FiniteTimeRoot, InfiniteTimeRoot | EXISTS - blocks in `src/editor/blocks/time-root.ts` |
| `identity` | DomainN, SVGSampleDomain | EXISTS - blocks in `src/editor/blocks/domain.ts` |
| `state` | IntegrateBlock, HistoryBlock | PARTIAL - classes exist in `src/editor/compiler/unified/blocks/` but NOT in block registry |
| `render` | RenderInstances, RenderStrokes*, RenderProgramStack* | PARTIAL - RenderInstances2D exists, others are future slots |
| `io` | TextSource*, ImageSource* | NOT STARTED - future slots only |

### 2. BlockDefinition Schema (Spec vs Current)

**Spec requires** (from `3-Registry-Gating.md`):
```typescript
interface BlockDefinition {
  capability: 'time' | 'identity' | 'state' | 'render' | 'io' | 'pure';
  kernelId?: KernelId;  // Required if capability !== 'pure'
  form: BlockForm;
  // ...
}
```

**Current implementation** (`src/editor/blocks/types.ts:27-102`):
```typescript
interface BlockDefinition {
  type: string;
  label: string;
  // NO capability field
  // NO kernelId field
  // form is DERIVED via getBlockForm()
  // ...
}
```

**GAP**: The `capability` and `kernelId` fields are **completely missing** from BlockDefinition.

### 3. KERNEL_PRIMITIVES Allowlist

**Spec requires** (`3-Registry-Gating.md:112-146`):
- File: `src/editor/blocks/kernel-primitives.ts`
- Exhaustive list of all kernel primitives with their capabilities
- Frozen, locked, single source of truth

**Current**: **FILE DOES NOT EXIST**

Search result: `Grep KERNEL_PRIMITIVES -> No files found`

### 4. Registration Validation

**Spec requires** (`3-Registry-Gating.md:150-204`):
- `validateBlockDefinition()` - runs on every block registration
- Rejects blocks claiming non-pure capability not in KERNEL_PRIMITIVES
- Enforces capability/form consistency (composites must be pure)

**Current**: **VALIDATION DOES NOT EXIST**

Search result: `Grep validateBlockDefinition -> No files found`

The registry (`src/editor/blocks/registry.ts`) simply collects blocks with no validation:
```typescript
const ALL_INDIVIDUAL_BLOCKS: BlockDefinition[] = [
  ...Object.values(DomainBlocks),
  // ... just concatenation, no validation
];
```

### 5. Pure Block Constraints

**Spec requires** (`3-Registry-Gating.md:206-355`):
- Pure blocks compile to restricted AST (SignalExpr, FieldExpr)
- `validatePureBlockOutput()` enforces constraints
- Pure blocks cannot emit RenderTree, Domain, State

**Current**: **VALIDATION DOES NOT EXIST**

Search result: `Grep validatePureBlockOutput -> No files found`

### 6. CI Enforcement

**Spec requires** (`3-Registry-Gating.md:370-436`):
- Pre-commit hook: `.husky/pre-commit`
- CI script: `scripts/check-kernel-primitives.ts`
- GitHub Actions workflow: `.github/workflows/check-primitives.yml`

**Current**:
- `.husky/` directory: **DOES NOT EXIST**
- `scripts/check-kernel-primitives.ts`: **DOES NOT EXIST**
- `.github/workflows/check-primitives.yml`: **DOES NOT EXIST**
- Only workflow: `.github/workflows/deploy.yml` (unrelated)

### 7. Type System - 3D-Safe Types

**Spec requires** (`2-Type-System-3D-Safe.md`):
```typescript
// Add to TypeDesc['domain']:
| 'vec3'
| 'quat'
| 'mat4'
| 'camera'
| 'light'
| 'mesh'
| 'material'
```

**Current** (`src/editor/types.ts:31-39`):
```typescript
export type CoreDomain =
  | 'number'
  | 'vec2'     // 2D only
  | 'color'
  | 'boolean'
  | 'time'
  | 'phase'
  | 'rate'
  | 'trigger';
```

**GAP**: No vec3, mat4, quat, camera, light, mesh, or material types.

Search result: `Grep vec3|mat4|quat in types.ts -> No matches found`

### 8. RenderNode Structure

**Spec requires** (`2-Type-System-3D-Safe.md:164-306`):
```typescript
type RenderNodeKind = 'group' | 'instances' | 'path' | 'mesh' | 'camera' | 'light' | 'effect';
interface RenderNodeBase { id: NodeId; kind: RenderNodeKind; tags?: readonly string[]; }
// ... typed node variants
```

**Current**: Unknown structure - would need to examine render-related code.

---

## State Primitives Status

IntegrateBlock and HistoryBlock exist as **compiler-internal classes** but are **NOT exposed in the block registry**:

**Files exist**:
- `src/editor/compiler/unified/blocks/IntegrateBlock.ts`
- `src/editor/compiler/unified/blocks/HistoryBlock.ts`

**But NOT in**:
- `src/editor/blocks/domain.ts` (not exported)
- `src/editor/blocks/registry.ts` (not imported)
- Block palette (users cannot place them)

These are runtime state management classes, not user-placeable blocks. The spec requires both:
1. User-facing block definitions (for the UI)
2. Runtime state management (for execution)

Currently only #2 exists.

---

## Test Suite Health

```
Test Files: 15 failed | 87 passed | 1 skipped (103)
Tests: 79 failed | 1873 passed | 4 skipped | 3 todo (1959)
```

Key failing areas:
- TimeRoot tests expect blocks to have no inputs (design changed)
- ColorLFO tests producing invalid color format
- Various compiler block tests

**Assessment**: Tests are failing due to implementation evolution, not fundamental issues. The primitive closure work would require test updates regardless.

---

## What Needs to Change

### Phase 1: Foundation (HIGH PRIORITY)

1. **Add capability to BlockDefinition** (`src/editor/blocks/types.ts`)
   - Add `capability: Capability` field
   - Add `kernelId?: KernelId` field (required if capability !== 'pure')
   - Update all existing block definitions

2. **Create KERNEL_PRIMITIVES allowlist** (`src/editor/blocks/kernel-primitives.ts`)
   - Define `KernelCapability` and `KernelId` types
   - Create frozen `KERNEL_PRIMITIVES` record
   - Export for use in validation

3. **Add registration validation** (`src/editor/blocks/registry-validation.ts`)
   - Implement `validateBlockDefinition()`
   - Integrate into registry loading
   - Reject unauthorized capability claims

### Phase 2: State Blocks (MEDIUM PRIORITY)

4. **Expose IntegrateBlock to UI**
   - Create BlockDefinition in `src/editor/blocks/`
   - Connect to existing runtime implementation
   - Add to registry

5. **Expose HistoryBlock to UI**
   - Same pattern as IntegrateBlock

### Phase 3: Pure Block Enforcement (MEDIUM PRIORITY)

6. **Add pure block validation** (`src/editor/compiler/pure-block-validator.ts`)
   - Implement `validatePureBlockOutput()`
   - Integrate into block compilation
   - Enforce AST-only outputs for operator blocks

### Phase 4: CI/Automation (LOWER PRIORITY)

7. **Add CI enforcement**
   - Create `scripts/check-kernel-primitives.ts`
   - Add GitHub Actions workflow
   - Optionally add pre-commit hook

### Phase 5: 3D Types (FUTURE)

8. **Add 3D-safe types**
   - Add vec3, mat4, quat to CoreDomain
   - Add Camera, Light, Mesh, Material to InternalDomain
   - Update RenderNode structure

---

## Dependencies & Risks

### Dependencies

| Change | Depends On |
|--------|------------|
| Registration validation | capability field exists |
| Pure block validation | KERNEL_PRIMITIVES exists |
| CI checks | validation functions exist |
| State block exposure | IntegrateBlock/HistoryBlock already implemented |

### Risks

1. **Breaking Change Risk**: Adding `capability` to BlockDefinition is a breaking schema change. All existing block definitions need updating.

2. **Test Breakage**: Many tests don't expect capability field. Batch update required.

3. **Composite Validation**: Current composites don't have explicit `capability: 'pure'`. Need to ensure getBlockForm() + capability validation align.

4. **GridDomain Classification**: GridDomain is currently a primitive but spec says it should be a composite. This is an architectural decision.

---

## Ambiguities Found

| Area | Question | Current Guess | Impact |
|------|----------|---------------|--------|
| GridDomain | Is GridDomain a primitive or composite? | Treated as primitive | LOW - Spec says composite, code says primitive |
| State blocks | Should IntegrateBlock/HistoryBlock have block definitions AND runtime classes? | Only runtime exists | MEDIUM - Need both for users to use them |
| RenderInstances naming | Spec says `RenderInstances`, code says `RenderInstances2D` | Using 2D suffix | LOW - Rename or alias needed |

**These are not blocking** - the spec is clear on intent, implementation just needs to align.

---

## Recommendations

### Immediate (This Sprint)

1. **Add `capability` field to BlockDefinition** - Foundation for everything else
2. **Create `kernel-primitives.ts`** - Single source of truth
3. **Add `validateBlockDefinition()`** - Runtime enforcement

### Next Sprint

4. Create user-facing IntegrateBlock/HistoryBlock definitions
5. Add pure block validation
6. Add CI checks

### Future

7. 3D type additions (when 3D rendering is needed)
8. RenderNode structure update

---

## Verdict

**CONTINUE** - The implementation gaps are clearly defined. The spec provides complete guidance. No ambiguities require user clarification.

**Specific Next Action**: Start with Phase 1 - add `capability` field to BlockDefinition and create KERNEL_PRIMITIVES allowlist. This unblocks all other enforcement work.
