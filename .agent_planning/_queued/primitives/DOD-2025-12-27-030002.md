# Definition of Done: Primitive Capability Enforcement Foundation

**Generated**: 2025-12-27-030002
**Plan**: PLAN-2025-12-27-030002.md
**Topic**: Primitives & Kernel Architecture

---

## Sprint Scope

This sprint delivers **foundational enforcement mechanisms** for the closed primitive set:

1. Capability metadata in BlockDefinition (type system foundation)
2. KERNEL_PRIMITIVES allowlist and registration validation (runtime gating)
3. Pure block compilation enforcement (compile-time constraints)

**Deferred**: State block UI exposure, CI enforcement, 3D types

---

## Acceptance Criteria

### Deliverable 1: Add Capability Metadata to BlockDefinition

**File Changes**: `src/editor/types.ts`, `src/editor/blocks/types.ts`, all block definition files

- [ ] `KernelCapability`, `Capability`, `KernelId`, and `PureCompileKind` types exist in `src/editor/types.ts`
- [ ] BlockDefinition is a discriminated union (KernelBlockDefinition | PureBlockDefinition) in `src/editor/blocks/types.ts`
- [ ] All TimeRoot blocks have `capability: 'time'` and correct kernelId
- [ ] All Domain blocks have `capability: 'identity'` and correct kernelId
- [ ] RenderInstances2D has `capability: 'render'` and `kernelId: 'RenderInstances'`
- [ ] All operator and composite blocks have `capability: 'pure'` and appropriate compileKind
- [ ] TypeScript compilation succeeds with no errors
- [ ] Existing tests pass or are updated to accommodate new fields

---

### Deliverable 2: Create KERNEL_PRIMITIVES Allowlist and Validation

**New Files**: `src/editor/blocks/kernel-primitives.ts`, `src/editor/blocks/registry-validation.ts`
**Modified Files**: `src/editor/blocks/registry.ts`

- [ ] `src/editor/blocks/kernel-primitives.ts` exists with frozen KERNEL_PRIMITIVES constant
- [ ] KERNEL_PRIMITIVES contains exactly 11 entries (3 time, 2 identity, 2 state, 3 render, 2 io)
- [ ] `src/editor/blocks/registry-validation.ts` exists with validateBlockDefinition()
- [ ] validateBlockDefinition() throws error if block claims non-pure capability not in KERNEL_PRIMITIVES
- [ ] validateBlockDefinition() throws error if capability doesn't match KERNEL_PRIMITIVES entry
- [ ] validateBlockDefinition() throws error if composite/macro claims non-pure capability
- [ ] Registry calls validateBlockDefinition() for every block on load
- [ ] Application starts successfully with current block set (no violations)
- [ ] Test: Adding a fake block with `capability: 'time'` and type not in KERNEL_PRIMITIVES throws error

---

### Deliverable 3: Add Pure Block Compilation Enforcement

**New Files**: `src/editor/compiler/pure-operator-ast.ts`, `src/editor/compiler/pure-block-validator.ts`
**Modified Files**: Block compilation integration point (TBD during implementation)

- [ ] `src/editor/compiler/pure-operator-ast.ts` exists with SignalExpr and FieldExpr type definitions
- [ ] `src/editor/compiler/pure-block-validator.ts` exists with validatePureBlockOutput()
- [ ] validatePureBlockOutput() rejects RenderTree/Domain/State/ExternalAsset artifacts from pure blocks
- [ ] validatePureBlockOutput() enforces AST-only outputs for compileKind:'operator' blocks
- [ ] Validation is called during block compilation (integration point identified and implemented)
- [ ] All existing pure blocks pass validation (no violations in current codebase)
- [ ] Test: Pure block attempting to emit RenderTree throws compile error
- [ ] Test: Pure operator block producing raw closure (not AST) throws compile error

---

## Sprint-Level Success Criteria

- [ ] All 3 deliverables have their acceptance criteria met
- [ ] TypeScript compiles with no errors
- [ ] Application starts successfully with no validation errors
- [ ] Existing test suite status is no worse than baseline (79 failing is acceptable, >79 is not)
- [ ] Manual verification: Adding a test block with unauthorized capability throws error
- [ ] Documentation: KERNEL_PRIMITIVES is the authoritative list, frozen and locked

---

## Test Verification Points

### Unit Tests Required

1. **validateBlockDefinition() tests**:
   - Valid kernel block (in KERNEL_PRIMITIVES) → passes
   - Invalid kernel block (not in list) → throws
   - Capability mismatch → throws
   - Composite claiming non-pure → throws
   - Macro claiming non-pure → throws

2. **validatePureBlockOutput() tests**:
   - Pure block emitting RenderTree → throws
   - Pure block emitting Domain → throws
   - Pure block emitting State → throws
   - Pure operator producing closure (not AST) → throws
   - Pure operator producing valid AST → passes

### Integration Tests Required

3. **Registry loading**:
   - All existing blocks load successfully
   - Validation runs on every block
   - Invalid block in registry → app fails to start with clear error

### Manual Tests Required

4. **Runtime validation**:
   - Add test block claiming `capability: 'time'` with type 'FakeTimeRoot' → error on startup
   - Verify error message is actionable and lists valid options

---

## Deferred Items (Not DoD for This Sprint)

- State block UI exposure (IntegrateBlock/HistoryBlock BlockDefinitions)
- Pre-commit hooks
- CI scripts (check-kernel-primitives.ts)
- GitHub Actions workflow
- 3D type additions (vec3, mat4, quat, etc.)
- RenderNode structure updates

These items are tracked in STATUS-2025-12-27-030200.md Phase 2-5 and will be addressed in future sprints.
