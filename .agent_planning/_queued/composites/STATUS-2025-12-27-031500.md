# Composite Library + UI for Building Custom Composites - Status Report

**Timestamp:** 2025-12-27-031500
**Scope:** composites/full
**Confidence:** FRESH
**Git Commit:** abb894c

---

## Executive Summary

**Overall Status: PARTIAL**

| Area | Status | Notes |
|------|--------|-------|
| Composite Definition System | COMPLETE | Well-designed, validates graphs, supports bus bindings |
| Pre-built Composite Library | COMPLETE (23 composites) | Exceeds original spec of 17 |
| Composite Compilation | COMPLETE | Compiles through new IR system |
| Custom Composite UI | NOT STARTED | No UI for users to create their own composites |
| Macro System | PARTIAL | Macros defined but expansion relies on MACRO_REGISTRY, separate from composites |

**Key Finding:** The **runtime system** for composites is complete and well-tested. What's missing is a **UI for users to build and save their own composites**. The CompositeStore exists but has no frontend.

---

## 1. What Exists (FRESH)

### 1.1 Composite Definition System

**Location:** `src/editor/composites.ts`

A complete programmatic composite definition system:

```typescript
interface CompositeDefinition {
  id: string;
  label: string;
  graph: {
    nodes: Record<string, { type: string; params?: Record<string, unknown> }>;
    edges: readonly { from: string; to: string }[];
    inputMap: Record<string, string>;
    outputMap: Record<string, string>;
    busSubscriptions?: Record<string, string>;  // Auto-wire to buses
    busPublications?: Record<string, string>;   // Auto-publish to buses
  };
  exposedInputs: ExposedPort[];
  exposedOutputs: ExposedPort[];
}
```

**Capabilities:**
- [x] Register composites programmatically
- [x] Validate port maps (inputs/outputs)
- [x] Bus subscription/publication declarations
- [x] Parameter forwarding (`{ __fromParam: 'paramName' }`)

### 1.2 Pre-built Composite Library (23 composites)

**Locations:**
- `src/editor/domain-composites.ts` (10 composites)
- `src/editor/signal-composites.ts` (8 composites)
- `src/editor/golden-patch-composites.ts` (5 composites)

| Category | Composites | Purpose |
|----------|------------|---------|
| Domain/Arrangement | GridPoints, CirclePoints, LinePoints, SVGSamplePoints | Layout patterns |
| Field Generation | PerElementRandom, PerElementPhaseOffset, SizeScatter, RotationScatter | Per-element variation |
| Motion | OrbitMotion, WaveDisplace, JitterMotion | Animation patterns |
| Signal Processing | BreathingScale, PaletteDrift, PulseToEnvelope, PhaseWrapPulse | Bus-driven effects |
| Color | PerElementColorScatter | Color variation |
| Render | DotsRenderer, GlyphRenderer | Complete render pipelines |
| Golden Patch | BreathEnergy, PulseAccentEnergy, SlowPaletteDrift, BreathingDotsRenderer, AmbientLoopRoot | Validated patterns |

**Comparison to Design Spec (11-starter-composites.md):**

| Spec Composite | Status | Implementation |
|----------------|--------|----------------|
| Grid Points | COMPLETE | GridPoints |
| Circle Points | COMPLETE | CirclePoints |
| Line Points | COMPLETE | LinePoints |
| SVG Sample Points | COMPLETE | SVGSamplePoints |
| Per-Element Random | COMPLETE | PerElementRandom |
| Per-Element Phase Offset | COMPLETE | PerElementPhaseOffset |
| Size Scatter | COMPLETE | SizeScatter |
| Rotation Scatter | COMPLETE | RotationScatter |
| Orbit Motion | COMPLETE | OrbitMotion |
| Wave Displace | COMPLETE | WaveDisplace |
| Breathing Scale | COMPLETE | BreathingScale |
| Palette Drift | COMPLETE | PaletteDrift |
| Per-Element Color Scatter | COMPLETE | PerElementColorScatter |
| Dots Renderer | COMPLETE | DotsRenderer |
| Glyph Renderer | COMPLETE | GlyphRenderer |
| Pulse to Envelope | COMPLETE | PulseToEnvelope |
| Phase Wrap Pulse | COMPLETE | PhaseWrapPulse |

**100% of spec-defined composites are implemented.**

### 1.3 Composite Bridge (Integration Layer)

**Location:** `src/editor/composite-bridge.ts`

Provides integration between composites and the block/compiler systems:

- `compositeToBlockDefinition()` - Convert composite to BlockDefinition
- `compositeToPrimitiveGraph()` - Convert composite graph to compiler format
- `createCompositeCompiler()` - Create block compiler for composite
- `getCompositeBlockDefinitions()` - Get all composites as BlockDefinitions

### 1.4 CompositeStore (User Composites)

**Location:** `src/editor/stores/CompositeStore.ts`

MobX store for managing user-created composites:

```typescript
class CompositeStore {
  composites: Composite[] = [];

  saveComposite(composite: Composite): void;  // With validation
  deleteComposite(id: string): void;
  instantiateComposite(compositeId: string, laneId: LaneId, position: {x, y}): void;
}
```

**Validation includes:**
- No TimeRoot blocks allowed in composites (TimeRoot defines patch-level time topology)

### 1.5 Macro System

**Location:** `src/editor/blocks/macros.ts`, `src/editor/macros.ts`

Macros are **different from composites**:
- **Composites:** Single block in UI, expand at compile time
- **Macros:** Expand immediately into visible blocks on add

**22 macros defined** in `blocks/macros.ts`:
- Quick Start: SimpleGrid, AnimatedCircleRing, LineWave, RainbowGrid, PulsingGrid, DriftingCircle, MultiRing, BreathingLine, ColorPulse, RhythmicDots, FullShowcase
- Slice Demos: BreathingWave, RhythmicPulse, ColorDrift, StableGrid, PhaseSpread, DriftingDots, StyledElements, ResponsiveGrid, GoldenPatch, BreathingDots
- Test: TestIR
- Tutorial: Tutorial

**Macro Expansion via MACRO_REGISTRY** in `src/editor/macros.ts`:
- Each macro has a graph with blocks, connections, publishers, listeners
- Expansion creates actual blocks and wires them together

### 1.6 Test Coverage

**40 tests passing** in `src/editor/__tests__/composite-library.test.ts`:

| Test Suite | Tests | Status |
|------------|-------|--------|
| Composite Registration | 5 | PASS |
| Composite Graph Validation | 6 | PASS |
| Bus-Aware Composites | 8 | PASS |
| Domain Composites | 5 | PASS |
| Signal Composites | 4 | PASS |
| Macro Registry | 6 | PASS |
| Macro Expansion Integration | 3 | PASS |
| Composite Compilation | 3 | PASS |
| Expected Composite Count | 2 | PASS |

---

## 2. What's Missing (Gap Analysis)

### 2.1 Custom Composite UI (CRITICAL GAP)

**No UI exists for users to:**
1. Select blocks and "save as composite"
2. Name and describe their composite
3. Choose which ports to expose
4. Edit existing custom composites
5. Browse/manage their composite library

**Evidence:**
```typescript
// BlockLibrary.tsx line 11-12
// import { listCompositeDefinitions } from './composites'; // TODO: Refactor composites
const listCompositeDefinitions = () => [];  // HARDCODED EMPTY!
```

The BlockLibrary **does not display composites** despite the infrastructure being complete.

### 2.2 Composite-to-Macro Migration

The CLAUDE.md says:
> **CRITICAL: Adding new blocks is strictly NOT ALLOWED unless the user explicitly asks and confirms. Use existing blocks, composites, defaultSource, and adapters instead.**

However, the current system has:
- 23 composites (hidden from UI)
- 22 macros (visible in UI)

This creates confusion about which system to use.

### 2.3 Missing Composite Features

From the design doc that could enhance composites:

| Feature | Status | Impact |
|---------|--------|--------|
| Lens presets on composites | NOT IMPLEMENTED | Bus listeners could have default lens transforms |
| Default parameter values | PARTIAL | Some composites have defaults, not all |
| Preview thumbnails | NOT IMPLEMENTED | Would help users identify composites visually |

---

## 3. What Needs Changes

### 3.1 BlockLibrary.tsx - Enable Composite Display

**Current (line 11-12):**
```typescript
// import { listCompositeDefinitions } from './composites'; // TODO: Refactor composites
const listCompositeDefinitions = () => [];
```

**Required change:** Uncomment the import and remove the stub. This alone would make all 23 composites visible in the block palette.

### 3.2 CompositeStore - Connect to UI

The store exists but has no UI bindings. Need:
- "Save as Composite" context menu/action
- Composite library panel
- Edit composite dialog

### 3.3 Macro vs Composite Clarification

Consider:
1. Migrate macros to composites (if single-block behavior is preferred)
2. Or keep both but clarify in UI which is which

---

## 4. Dependencies and Risks

### 4.1 Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| IR Compiler (Phases 1-6) | COMPLETE | Composites compile through new IR system |
| Type Unification | COMPLETE | Composite port types work correctly |
| Block Registry | COMPLETE | Composites register as blocks |
| Bus System | COMPLETE | Bus subscriptions/publications work |
| Render System | COMPLETE | Composite renderers work |

### 4.2 Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Composite expansion breaks with IR changes | LOW | MEDIUM | 40 tests validate expansion |
| User composites conflict with built-in IDs | MEDIUM | LOW | Namespace user composites (e.g., `user:MyComposite`) |
| Complex composites slow to expand | LOW | LOW | Expansion is compile-time, not runtime |
| CompositeStore has no persistence | MEDIUM | HIGH | User composites lost on refresh |

### 4.3 Persistence Gap

**CompositeStore is in-memory only.** User-created composites are not saved to:
- localStorage
- File system
- Project file

This is a significant gap for custom composite support.

---

## 5. Ambiguities

### 5.1 Macro vs Composite Architecture Decision

| Question | Impact |
|----------|--------|
| Should macros remain as immediate-expansion? | UI behavior differs |
| Should users be able to "unpack" a composite into visible blocks? | Educational feature |
| When user edits a composite instance, should it unlink from definition? | Edit behavior |

**Recommendation:** Clarify with user before implementing custom composite UI.

### 5.2 Composite Parameter Editing

Composites can forward parameters (`__fromParam`), but:
- How should the Inspector UI handle composite parameters?
- Should users see internal block parameters or only exposed ones?

### 5.3 Composite Nesting

Can a composite contain another composite?
- Current code: No explicit prevention
- Tests: Not tested
- Risk: Infinite expansion loops possible

---

## 6. Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| `pnpm exec vitest run src/editor/__tests__/composite-library.test.ts` | PASS | 40/40 tests pass |
| `pnpm exec tsc --noEmit` | PASS (with deps) | TypeScript compiles |

### Missing Checks (Implementer Should Create)

1. **Composite instantiation from UI** - No e2e test for drag-drop composite from palette
2. **Composite persistence** - No test for save/load user composites
3. **Composite parameter forwarding** - No test for `__fromParam` at runtime

---

## 7. Integration with IR Compiler (Phases 1-6)

### 7.1 Current Integration (WORKING)

Composites compile through the IR system:

1. **Block Registry:** `getBlockDefinitions(true)` includes composites
2. **Type System:** Composite ports use standard `SlotType`
3. **IR Builder:** Composites expand to primitive blocks, then lower to IR
4. **Buses:** `busSubscriptions`/`busPublications` create real bus listeners/publishers

### 7.2 Test Evidence

From `composite-library.test.ts`:

```typescript
it('GridPoints composite compiles successfully', () => {
  const store = new RootStore();

  const gridId = store.patchStore.addBlock('composite:GridPoints', {...});
  // ... connects and compiles
  expect(result.ok).toBe(true);
  expect(result.program).toBeDefined();
});
```

**All 3 composite compilation tests pass.**

---

## 8. Data Flow Verification

### 8.1 Composite Definition Flow

```
CompositeDefinition (composites.ts)
         ↓
registerComposite() validates
         ↓
composite-bridge.ts converts to BlockDefinition
         ↓
blocks/registry.ts includes in getBlockDefinitions(true)
         ↓
[Currently blocked: BlockLibrary.tsx returns empty array]
         ↓
[Would flow to: Block palette → User adds → PatchStore → Compiler]
```

### 8.2 Composite Expansion Flow

```
PatchStore.addBlock('composite:GridPoints', params)
         ↓
Compiler encounters composite block
         ↓
expandComposites() pass
         ↓
Creates internal nodes: DomainN, PositionMapGrid
         ↓
Wires internal edges
         ↓
Continues with normal block lowering
```

**Status:** Working, tested by 3 compilation tests.

---

## 9. Recommendations

### 9.1 Immediate (Low Effort, High Impact)

1. **Enable composites in BlockLibrary** - Uncomment line 11-12 of BlockLibrary.tsx
   - Effort: 5 minutes
   - Impact: 23 composites become visible to users

### 9.2 Short-Term (Custom Composite MVP)

2. **Add "Save as Composite" action**
   - Right-click selection of blocks
   - Dialog: name, description, expose ports
   - Save to CompositeStore

3. **Add composite persistence**
   - Serialize to localStorage or project file
   - Load on app start

### 9.3 Medium-Term (Full Custom Composite Support)

4. **Composite editor UI**
   - Visual editor for composite graphs
   - Parameter forwarding configuration
   - Bus binding configuration

5. **Composite library panel**
   - Browse, search, filter
   - Delete, rename, duplicate
   - Import/export

---

## 10. Verdict

**Status:** CONTINUE

**Rationale:**
- Core infrastructure is complete and tested
- All spec-defined composites are implemented
- Integration with IR compiler is working
- Only missing piece is UI, which is well-scoped

**Blocking Issues:** None

**Next Steps:**
1. Enable composites in BlockLibrary (trivial fix)
2. Design custom composite UI (needs user input on UX)
3. Add persistence layer (needs architectural decision)

---

## Appendix: File Inventory

| File | Purpose | Lines | Last Modified |
|------|---------|-------|---------------|
| `src/editor/composites.ts` | Core definition system | 100 | Recent |
| `src/editor/composite-bridge.ts` | Block/compiler integration | 212 | Recent |
| `src/editor/domain-composites.ts` | 10 domain composites | 683 | Recent |
| `src/editor/signal-composites.ts` | 8 signal composites | 527 | Recent |
| `src/editor/golden-patch-composites.ts` | 5 golden patch composites | 427 | Recent |
| `src/editor/blocks/macros.ts` | 22 macro definitions | 241 | Recent |
| `src/editor/macros.ts` | Macro expansion registry | ~1000 | Recent |
| `src/editor/stores/CompositeStore.ts` | User composite store | 146 | Recent |
| `src/editor/__tests__/composite-library.test.ts` | 40 tests | 689 | Recent |
