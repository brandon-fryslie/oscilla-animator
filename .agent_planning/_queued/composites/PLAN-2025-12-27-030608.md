# Sprint Plan: Composite Library + Custom Composite Creation

**Generated:** 2025-12-27-030608
**Source:** STATUS-2025-12-27-031500.md
**Topic:** composites
**Sprint Scope:** Enable users to see, use, and create custom composites (MVP)

---

## Executive Summary

### Current State
The composite infrastructure is **100% complete** with 23 pre-built composites, full IR compilation support, and a validated MobX store for user composites. However, composites are **invisible to users** because `BlockLibrary.tsx` has them hardcoded to an empty array (lines 11-12).

### Total Gap
Three deliverables separate users from full composite functionality:
1. **Quick Win (2 hours):** Uncomment `listCompositeDefinitions` import to expose 23 built-in composites
2. **Core Feature (2-3 days):** UI for creating custom composites from selected blocks
3. **Persistence (1 day):** Save/load user composites to project file

### Sprint Focus
This sprint delivers an **MVP custom composite system** that gets composites into users' hands immediately while enabling them to build their own reusable patterns. We'll defer advanced features (visual editor, nesting, macro migration) to future sprints.

### Risk Assessment
- **LOW RISK:** All runtime code exists and is tested (40 passing tests)
- **MEDIUM RISK:** Persistence layer needs architectural decision (localStorage vs project file)
- **LOW UNCERTAINTY:** UI patterns are well-established in the editor

---

## Backlog by Priority

---

## [P0] Enable Built-in Composite Display

**Status:** Not Started
**Effort:** Small (1-2 hours)
**Dependencies:** None
**Spec Reference:** 10-Blocks.md Â§ Composite Library â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 2.1

### Description
Uncomment the import of `listCompositeDefinitions` in `BlockLibrary.tsx` (lines 11-12) to expose all 23 pre-built composites in the block palette. This is a trivial code change that immediately unlocks significant user value.

**Current code (lines 11-12):**
```typescript
// import { listCompositeDefinitions } from './composites'; // TODO: Refactor composites
const listCompositeDefinitions = () => [];
```

**Required change:**
```typescript
import { listCompositeDefinitions } from './composites';
```

This single change makes the following composites visible:
- **Domain/Arrangement (4):** GridPoints, CirclePoints, LinePoints, SVGSamplePoints
- **Field Generation (4):** PerElementRandom, PerElementPhaseOffset, SizeScatter, RotationScatter
- **Motion (3):** OrbitMotion, WaveDisplace, JitterMotion
- **Signal Processing (4):** BreathingScale, PaletteDrift, PulseToEnvelope, PhaseWrapPulse
- **Color (1):** PerElementColorScatter
- **Render (2):** DotsRenderer, GlyphRenderer
- **Golden Patch (5):** BreathEnergy, PulseAccentEnergy, SlowPaletteDrift, BreathingDotsRenderer, AmbientLoopRoot

### Acceptance Criteria
- [ ] `listCompositeDefinitions` import is uncommented in `BlockLibrary.tsx`
- [ ] All 23 composites appear in the "Composites" section of the block palette
- [ ] Composites are grouped correctly by subcategory (Domain, Signal, Render, etc.)
- [ ] Dragging a composite from the palette creates a single composite block in the patch
- [ ] Double-clicking a composite from the palette adds it to the active lane
- [ ] Composite blocks compile successfully through the IR system (verified via `just dev` and manual testing in Chrome DevTools MCP)
- [ ] Composite parameter editing works in Inspector panel (e.g., GridPoints rows/cols)

### Technical Notes
- The `BlockLibrary` already handles composites via the `getBlockForm()` function which recognizes `composite:*` block types
- Composites are already registered via `composite-bridge.ts` â†’ `getCompositeBlockDefinitions()`
- No additional UI changes needed - the existing palette infrastructure handles composites automatically

---

## [P0] Custom Composite Creation UI (Core Feature)

**Status:** Not Started
**Effort:** Medium (2-3 days)
**Dependencies:** None (can be developed in parallel with P0)
**Spec Reference:** 10-Blocks.md Â§ Composites â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 2.1

### Description
Build a UI workflow that allows users to select blocks on the canvas, right-click, and "Save as Composite". This creates a reusable composite definition that appears in the block palette alongside built-in composites.

**Workflow:**
1. User selects multiple blocks on canvas (Shift+Click or drag-select)
2. Right-click â†’ "Save as Composite"
3. Dialog opens with:
   - Composite name (text input, required)
   - Description (textarea, optional)
   - Exposed inputs/outputs (auto-detected from selection boundary, with checkboxes to enable/disable)
   - Subcategory dropdown (Domain, Signal, Field, Render, Other)
4. Click "Save" â†’ validates composite â†’ saves to `CompositeStore` â†’ appears in palette
5. User can now drag the custom composite from palette like any built-in composite

**Auto-detection logic for ports:**
- **Exposed Inputs:** Any input port on a selected block that is NOT connected to another selected block
- **Exposed Outputs:** Any output port on a selected block that is NOT connected to another selected block
- **Internal Wiring:** Connections between selected blocks become the composite's internal graph

### Acceptance Criteria
- [ ] Multi-select works on canvas (Shift+Click or drag-select box)
- [ ] Right-click context menu on selection shows "Save as Composite" option
- [ ] Dialog opens with form fields (name, description, subcategory)
- [ ] Exposed ports are auto-detected correctly (boundary analysis of selection)
- [ ] User can toggle which ports to expose via checkboxes
- [ ] Validation prevents empty names and duplicate IDs (auto-generate ID from name)
- [ ] Validation prevents composites containing TimeRoot blocks (enforced by `validateCompositeDefinition`)
- [ ] Clicking "Save" stores composite in `CompositeStore.composites` array
- [ ] New composite appears in block palette under user-defined subcategory
- [ ] Custom composite instantiates correctly when dragged from palette (creates internal blocks + wiring)
- [ ] Unit test verifies custom composite creation flow (mock store, validate graph structure)
- [ ] E2E test (via Chrome DevTools MCP) verifies drag-from-palette â†’ instantiate â†’ compile â†’ render

### Technical Notes
- Use the existing `CompositeStore.saveComposite()` method - validation is already implemented
- Composite ID format: `user:<sanitized-name>` to avoid conflicts with built-in composites (e.g., `user:MyCustomGrid`)
- Leverage `composite-bridge.ts` helper functions:
  - `compositeToBlockDefinition()` - converts to BlockDefinition for palette
  - `compositeToPrimitiveGraph()` - converts to compiler format
- Port mapping logic similar to built-in composites (see `domain-composites.ts` for examples)
- Inspector integration: composite parameters should use `__fromParam` forwarding pattern

**UI Component Structure:**
```tsx
// New components needed:
<SaveCompositeDialog
  blocks={selectedBlocks}
  connections={relevantConnections}
  onSave={(composite) => store.compositeStore.saveComposite(composite)}
  onCancel={() => setDialogOpen(false)}
/>
```

---

## [P0] User Composite Persistence

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** P0 Custom Composite Creation UI (must exist first)
**Spec Reference:** None (architectural gap) â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 4.3

### Description
Implement persistence for user-created composites so they survive page refresh. Currently `CompositeStore` is in-memory only, meaning all custom composites are lost when the user closes the browser.

**Architectural Decision Required:**
Two options for persistence:
1. **Project File (Recommended):** Serialize `CompositeStore.composites` to the project's `.osc` file format
2. **LocalStorage:** Store composites in browser localStorage (simpler but less portable)

**Recommendation:** Use project file persistence to align with Oscilla's file-based workflow. This makes composites portable across machines and shareable with collaborators.

### Acceptance Criteria
- [ ] User composites are serialized when project is saved (via "Save Project" or auto-save)
- [ ] User composites are deserialized when project is loaded
- [ ] Composite definitions include all necessary metadata (id, name, description, graph, ports)
- [ ] Loading validates composite definitions (via `validateCompositeDefinition`)
- [ ] Invalid composites are logged as warnings but don't crash the app
- [ ] Unit test verifies serialize/deserialize round-trip preserves composite graph structure
- [ ] E2E test verifies save â†’ reload â†’ custom composite still appears in palette

### Technical Notes
- Extend the project file schema to include `composites` field:
  ```typescript
  interface ProjectFile {
    version: string;
    patch: { blocks: Block[]; connections: Connection[] };
    composites?: Composite[];  // NEW
    view?: ViewState;
  }
  ```
- Add serialization in `RootStore.serialize()` (or equivalent save function)
- Add deserialization in `RootStore.deserialize()` (or equivalent load function)
- Namespacing: User composites use `user:*` prefix, built-in composites use `composite:*` prefix
- If localStorage is chosen instead: use key `oscilla-user-composites-${projectId}` to avoid cross-project pollution

**Migration Path:**
- Default to empty array if `composites` field is missing in older project files (backward compatible)
- Future: Add export/import for sharing composite libraries between projects

---

## [P1] Composite Management UI

**Status:** Not Started
**Effort:** Small (1 day)
**Dependencies:** P0 Custom Composite Creation UI, P0 Persistence
**Spec Reference:** None (UX enhancement) â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 2.1

### Description
Add UI for managing user-created composites: rename, delete, duplicate, and view details. This completes the custom composite lifecycle and prevents the palette from becoming cluttered with unmaintained composites.

**Features:**
1. **Composite Library Panel** - Browse all user composites with search/filter
2. **Context Menu** - Right-click composite in palette â†’ Rename / Delete / Duplicate / View Graph
3. **Composite Details Dialog** - Show composite graph structure, ports, and description

### Acceptance Criteria
- [ ] Right-click on user composite in palette shows management options (Rename, Delete, Duplicate)
- [ ] "Rename" opens dialog, updates composite name and ID (with validation)
- [ ] "Delete" prompts for confirmation, removes composite from store and palette
- [ ] "Duplicate" creates a copy with incremented name (e.g., "MyGrid" â†’ "MyGrid (2)")
- [ ] "View Graph" opens dialog showing composite's internal block structure (read-only visualization)
- [ ] Search/filter works in block palette for composites (existing palette search applies)
- [ ] Deleting a composite does NOT delete instances already in the patch (they become "detached")
- [ ] Unit test verifies delete/rename operations update store correctly
- [ ] E2E test verifies delete â†’ composite disappears from palette but instances remain functional

### Technical Notes
- Use existing `CompositeStore.deleteComposite(id)` method
- Add `CompositeStore.renameComposite(id, newName)` method
- Add `CompositeStore.duplicateComposite(id)` method
- "View Graph" dialog can reuse block rendering logic (mini read-only canvas)
- Detached instances: When composite is deleted, instances in the patch should still compile (they expand to primitives at compile time, so deletion only affects new instances)

**UI Component Structure:**
```tsx
<CompositeContextMenu
  composite={composite}
  onRename={() => openRenameDialog()}
  onDelete={() => confirmDelete()}
  onDuplicate={() => store.compositeStore.duplicateComposite(composite.id)}
  onViewGraph={() => openGraphDialog()}
/>
```

---

## [P2] Composite Parameter Forwarding UI

**Status:** Not Started
**Effort:** Medium (1-2 days)
**Dependencies:** P0 Custom Composite Creation UI
**Spec Reference:** composites.ts Â§ Parameter Forwarding (`__fromParam`) â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 5.2

### Description
Extend the custom composite creation dialog to allow users to expose internal block parameters as composite-level parameters. This enables composites to be configurable without editing the internal graph.

**Example:**
- User creates a composite with a `GridDomain` block inside
- They want to expose the grid's `rows` and `cols` parameters
- In the creation dialog, they map internal `GridDomain.rows` â†’ composite parameter `rows`
- When the composite is instantiated, changing `composite.rows` updates the internal `GridDomain.rows`

**Current Limitation:**
Built-in composites use `__fromParam` syntax (see `domain-composites.ts`), but there's no UI for users to configure this mapping.

### Acceptance Criteria
- [ ] Composite creation dialog has "Parameters" tab (in addition to Ports tab)
- [ ] Tab lists all parameters of internal blocks with checkboxes
- [ ] User can select which parameters to expose and provide display names
- [ ] Saved composite includes `exposedParams` metadata with mappings
- [ ] Inspector shows composite-level parameters when composite instance is selected
- [ ] Changing composite parameter updates internal block parameter (via `__fromParam` mechanism)
- [ ] Unit test verifies parameter forwarding during composite expansion
- [ ] E2E test verifies Inspector shows forwarded params and they affect rendering

### Technical Notes
- Extend `CompositeDefinition` interface to include:
  ```typescript
  interface CompositeDefinition {
    // ... existing fields
    exposedParams?: Array<{
      name: string;           // Composite-level param name
      targetBlock: string;    // Internal block ID
      targetParam: string;    // Internal param name
      defaultValue?: unknown; // Optional default
    }>;
  }
  ```
- During composite expansion, replace internal param values with `{ __fromParam: 'compositeLevelParamName' }`
- Inspector integration: when composite is selected, show `exposedParams` in addition to normal inputs/outputs

---

## [P3] Composite Preview Thumbnails

**Status:** Not Started
**Effort:** Small (1 day)
**Dependencies:** P0 Enable Built-in Composite Display
**Spec Reference:** None (UX enhancement) â€¢ **Status Reference:** STATUS-2025-12-27-031500.md Â§ 2.3

### Description
Generate preview thumbnails for composites to help users visually identify them in the palette. This is especially useful for composites that produce visual patterns (e.g., GridPoints, CirclePoints, DotsRenderer).

**Approach:**
1. Offline pre-render for built-in composites (static images in `assets/composite-previews/`)
2. Auto-generate for user composites on creation (render composite in hidden canvas â†’ capture as data URL)

### Acceptance Criteria
- [ ] Built-in composites have preview thumbnails (64x64 px) in the palette
- [ ] User composites auto-generate thumbnails on creation (if they include a RenderInstances2D output)
- [ ] Thumbnails appear next to composite name in block palette
- [ ] Hovering over thumbnail shows larger preview (256x256 px)
- [ ] Non-renderable composites (e.g., pure signal processing) show a default icon

### Technical Notes
- Use hidden canvas to render composite with default parameters
- Capture canvas.toDataURL() after 1 second of simulation
- Store thumbnail as base64 in composite metadata (or as separate file in project)
- For built-in composites, manually create thumbnails once and commit to repo

---

## Dependency Graph

```
P0: Enable Built-in Composite Display
  â†“ (parallel)
  â”œâ”€â†’ P0: Custom Composite Creation UI
  â”‚     â†“
  â”‚   P0: User Composite Persistence
  â”‚     â†“
  â”‚   P1: Composite Management UI
  â”‚     â†“
  â”‚   P2: Composite Parameter Forwarding UI
  â”‚
  â””â”€â†’ P3: Composite Preview Thumbnails (parallel, no dependencies)
```

---

## Recommended Sprint Planning

### Sprint 1: Quick Win + Core Feature (3-4 days)
**Goal:** Get composites into users' hands immediately, enable custom creation

**Deliverables:**
1. P0: Enable Built-in Composite Display (2 hours)
2. P0: Custom Composite Creation UI (2-3 days)
3. P0: User Composite Persistence (1 day)

**Success Metrics:**
- Users can drag 23 built-in composites from palette
- Users can select blocks and "Save as Composite"
- Custom composites persist across sessions

**Testing Strategy:**
- Unit tests for composite creation flow
- E2E tests (Chrome DevTools MCP) for drag-drop, compile, render
- Manual testing of all 23 built-in composites in `just dev`

---

### Sprint 2: Management + Polish (2-3 days)
**Goal:** Complete the composite lifecycle, improve UX

**Deliverables:**
1. P1: Composite Management UI (1 day)
2. P2: Composite Parameter Forwarding UI (1-2 days)
3. P3: Composite Preview Thumbnails (1 day, optional)

**Success Metrics:**
- Users can rename/delete/duplicate custom composites
- Users can expose internal block parameters as composite parameters
- (Optional) Composites have visual thumbnails in palette

**Deferred to Future Sprints:**
- Macro-to-Composite migration (needs design decision)
- Composite nesting (needs infinite loop prevention)
- Visual composite graph editor (larger effort)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| User composites conflict with built-in IDs | MEDIUM | LOW | Use `user:*` namespace prefix for all custom composites |
| CompositeStore lacks persistence, users lose work | HIGH | HIGH | P0 priority for persistence (project file) |
| Complex composites slow to expand | LOW | LOW | Expansion is compile-time (not runtime), tested up to 40 composites |
| Parameter forwarding breaks with nested composites | LOW | MEDIUM | Defer composite nesting to future sprint, document limitation |
| Inspector doesn't show composite parameters | MEDIUM | MEDIUM | Leverage existing `__fromParam` mechanism, add Inspector integration |
| Macro vs Composite confusion | MEDIUM | LOW | Add documentation, consider future migration path |

---

## Blockers and Questions

### Clarifications Needed (Before Sprint Start)
1. **Persistence Strategy:** Project file vs localStorage? (Recommendation: project file for portability)
2. **Macro Migration:** Should macros be migrated to composites? (Recommendation: defer to separate sprint)
3. **Composite Nesting:** Allow composites to contain other composites? (Recommendation: block initially, add in future with cycle detection)

### No Blocking Issues
All core infrastructure is complete and tested. The only missing piece is UI, which is well-scoped and low-risk.

---

## Appendix: Test Coverage

### Existing Tests (40 passing)
- `src/editor/__tests__/composite-library.test.ts`
  - Composite registration (5 tests)
  - Graph validation (6 tests)
  - Bus-aware composites (8 tests)
  - Domain composites (5 tests)
  - Signal composites (4 tests)
  - Macro registry (6 tests)
  - Macro expansion (3 tests)
  - Composite compilation (3 tests)

### New Tests Required
1. **Custom Composite Creation:**
   - Port auto-detection from selection boundary
   - Validation prevents TimeRoot blocks
   - Composite ID uniqueness
2. **Persistence:**
   - Serialize/deserialize round-trip
   - Backward compatibility with old project files
3. **Management:**
   - Delete/rename/duplicate operations
   - Detached instances still compile after deletion
4. **Parameter Forwarding:**
   - `__fromParam` expansion during compile
   - Inspector shows forwarded parameters

---

## Success Criteria for Sprint Completion

âœ… **Sprint is complete when:**
1. All 23 built-in composites are visible and usable in the block palette
2. Users can create custom composites from selected blocks
3. Custom composites persist across browser sessions
4. Custom composites compile and render correctly (validated via Chrome DevTools MCP)
5. All new unit tests pass (`just test`)
6. TypeScript compiles without errors (`just typecheck`)
7. No regressions in existing 40 composite tests

ðŸŽ¯ **Stretch Goals (if time permits):**
- Composite management UI (rename/delete/duplicate)
- Parameter forwarding UI
- Preview thumbnails for composites

---

## References

**Design Docs:**
- `design-docs/3-Synthesized-v2/topics/10-Blocks.md` - Block categories and composite library
- `design-docs/3-Synthesized-v2/topics/08-UI-Spec.md` - UI patterns and conventions

**Implementation:**
- `src/editor/composites.ts` - Core composite definition system
- `src/editor/composite-bridge.ts` - Block/compiler integration
- `src/editor/domain-composites.ts` - 10 domain composites
- `src/editor/signal-composites.ts` - 8 signal composites
- `src/editor/golden-patch-composites.ts` - 5 golden patch composites
- `src/editor/stores/CompositeStore.ts` - User composite store
- `src/editor/BlockLibrary.tsx` - Block palette UI (needs uncomment at line 11-12)

**Tests:**
- `src/editor/__tests__/composite-library.test.ts` - 40 passing tests
