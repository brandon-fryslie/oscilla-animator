# Definition of Done: 3D Configuration UI
**Generated:** 2025-12-27-095558
**Plan:** PLAN-2025-12-27-095558.md
**Topic:** 3d-config-ui

---

## Sprint Scope

This sprint delivers **camera configuration UI** for 3D scenes:
- Vec3 Editor Control
- Camera Block Definition
- Camera Compiler/Lowering

**Deferred:**
- RenderInstances3D block (needs camera working first)
- Mesh block definition (lower priority)
- Quaternion editor (using lookAt instead)
- Preview widgets (frustum, wireframe)

---

## Acceptance Criteria

### P0-1: Vec3 Editor Control

**File:** `src/editor/Inspector.tsx`

- [ ] DefaultSourceControl renders three number inputs labeled "X", "Y", "Z" when `uiHint.kind === 'vec3'`
- [ ] Inputs correctly parse `ds.value` as `{ x: number, y: number, z: number }`
- [ ] Changing any input calls `onChange` with updated object preserving other two values
- [ ] Control respects `isDriven` prop (disables inputs when driven by wire/bus)
- [ ] Styling matches existing `param-xy` pattern (uses `.param-xyz` class or similar)

**Validation Steps:**
1. Create a Camera block (after P0-2)
2. Select the block in the patch bay
3. Inspector shows three inputs for position X, Y, Z
4. Changing values updates the position object
5. Connecting a wire to position disables the inputs

---

### P0-2: Camera Block Definition

**File:** `src/editor/blocks/camera.ts` (new file)

- [ ] Camera block defined with type `'Camera'`
- [ ] Block has primary inputs: position (Signal<vec3>), lookAt (Signal<vec3>), projectionKind (Scalar:string)
- [ ] Block has secondary inputs: fovY (Signal<number>), near (Signal<number>), far (Signal<number>)
- [ ] All inputs have sensible defaultSource values (position: {0,0,100}, lookAt: {0,0,0}, fovY: 60, near: 0.1, far: 1000)
- [ ] Position/lookAt use `uiHint: { kind: 'vec3' }` to trigger Vec3 editor
- [ ] projectionKind uses `uiHint: { kind: 'select', options: [...] }` with perspective/orthographic options
- [ ] Block registered in block registry with `laneKind: 'Scene'` and appropriate color
- [ ] Block outputs a special `camera` type (similar to Domain output)

**Validation Steps:**
1. Camera block appears in block library
2. Dragging to patch bay creates block instance
3. Selecting block shows Inspector with all inputs
4. Vec3 controls appear for position/lookAt
5. Dropdown appears for projection type with "Perspective" and "Orthographic" options
6. Sliders appear for FOV/near/far with correct ranges

---

### P1-1: Camera Compiler/Lowering

**Files:** `src/editor/compiler/blocks/domain/Camera.ts` (new), `src/editor/compiler/ir/IRBuilder.ts`, `src/editor/compiler/ir/program.ts`

- [ ] File `src/editor/compiler/blocks/domain/Camera.ts` created with `lowerCamera` function
- [ ] Camera block registered in `src/editor/compiler/ir/lowerTypes.ts` with `capability: 'camera'`
- [ ] Lowering extracts position, lookAt, projection inputs as value slots
- [ ] Lowering generates CameraIR with id = `camera-${blockId}`
- [ ] CameraIR added to program via `ctx.b.addCamera(cameraIR)` or similar API
- [ ] Lowering validates that position/lookAt are Signal<vec3> (not Field)
- [ ] Lowering validates that projectionKind is Scalar:string with value 'perspective' or 'orthographic'
- [ ] Camera block outputs a reference (special type) that can be consumed by future 3D render blocks

**Validation Steps:**
1. Create a Camera block in a patch
2. Compile the patch (trigger via play/scrub)
3. Inspect program IR in debugger: `program.cameras` map contains one entry
4. Camera ID is `camera-${blockId}` (matches block instance ID)
5. CameraIR has position/lookAt/projection slots pointing to valid value slots
6. No compilation errors or warnings
7. Console shows no runtime errors during camera evaluation

---

## Sprint Success Criteria

**Must Have (P0):**
- Users can drag a Camera block into a patch
- Inspector shows intuitive controls for camera position and orientation
- Vec3 inputs work correctly (three number fields, preserve values)
- Camera compiles without errors

**Should Have (P1):**
- CameraIR appears in program IR output
- CameraTable populated correctly
- Camera outputs a reference that can be wired to future 3D blocks

**Won't Have (Deferred):**
- RenderInstances3D block consuming camera
- Mesh block definition
- Quaternion rotation controls
- Visual preview of camera frustum

---

## Testing Checklist

### Manual Testing (Required)

**Vec3 Control:**
- [ ] Three inputs render for camera position
- [ ] Typing in X updates only X coordinate
- [ ] Typing in Y updates only Y coordinate
- [ ] Typing in Z updates only Z coordinate
- [ ] Inputs disabled when position is driven by wire
- [ ] Inputs work for lookAt as well

**Camera Block:**
- [ ] Block draggable from library
- [ ] Block appears in patch bay on drop
- [ ] Selecting block shows Inspector
- [ ] All 6 inputs visible (position, lookAt, projection, fov, near, far)
- [ ] Projection dropdown has two options
- [ ] FOV slider range 10-120
- [ ] Near/far inputs accept numeric values

**Compiler:**
- [ ] Creating camera block does not crash compiler
- [ ] Playing patch compiles successfully
- [ ] Console shows no errors related to camera lowering
- [ ] Browser DevTools: program.cameras map is populated

### Chrome DevTools Verification (Required)

**Inspector â†’ Application State:**
1. Open DevTools
2. Select Camera block
3. Check `rootStore.patchStore.selectedBlock.inputs`
4. Verify defaultSource values match expected defaults

**Compiled Program IR:**
1. Play the patch (triggers compilation)
2. In DevTools console: `window.__DEBUG_PROGRAM__`
3. Check `.cameras` map has entry for the camera
4. Verify CameraIR structure matches spec

---

## Known Limitations / TODOs

1. **Aspect Ratio:** Hardcoded to 16:9 - needs viewport integration later
2. **Multiple Cameras:** No UI to select active camera - deferred
3. **Orthographic:** fovY included but unused for ortho projection - consumer ignores
4. **Signal<vec3> Type:** May need type system extension or fallback to three separate Signal<number> inputs
5. **No Preview:** No visual feedback of camera frustum - deferred to future sprint

---

## Documentation Requirements

- [ ] Add inline JSDoc comments to Camera block definition
- [ ] Add inline comments to `lowerCamera` explaining CameraIR structure
- [ ] Update CLAUDE.md or memory files if new patterns introduced (unlikely for this sprint)
- [ ] Update this DOD with any discovered edge cases or gotchas

---

## Dependencies

**External Dependencies:** None (all work is within editor codebase)

**Internal Dependencies:**
- P0-2 depends on P0-1 (Camera block needs Vec3 control)
- P1-1 depends on P0-2 (Compiler needs Camera block definition)

**Blockers:** None identified

---

## Rollback Plan

If critical issues discovered during implementation:

1. **Vec3 Control Issue:** Revert `Inspector.tsx` changes, use three separate number inputs temporarily
2. **Type System Issue:** Use `Signal<number>` for posX/posY/posZ instead of `Signal<vec3>`
3. **Compiler Issue:** Remove Camera block registration, keep block definition for future sprint

All changes are additive - no removal of existing functionality required.
