# Definition of Done: 3D Camera Configuration UI (REVISED)
**Generated:** 2025-12-27-100500
**Plan:** PLAN-2025-12-27-100500-REVISED.md

---

## Architecture Principles (Non-Negotiable)

1. **Camera is a resource, not a wire output.** Camera blocks contribute to `program.cameras` table. No output ports.
2. **No lane assumptions.** Use `category: 'Scene'` for UI grouping.
3. **Vec3 is the type.** UI renders 3 inputs, but type model is `vec3`, not three separate numbers.
4. **Conventions are locked.** Right-handed, +Y up, -Z forward, angles in radians (UI shows degrees).

---

## Sprint Deliverables

### P0-1: Vec3 Default Source Editor

- [ ] Three inputs (X, Y, Z) render when `uiHint.kind === 'vec3'`
- [ ] Inputs parse/update a single `{ x, y, z }` object
- [ ] Changing X preserves Y and Z values
- [ ] Inputs disabled when port is driven (wire/bus)
- [ ] Paste JSON `{"x":1,"y":2,"z":3}` populates all fields
- [ ] Paste comma-separated `1, 2, 3` also works
- [ ] Styling uses `.param-xyz` class matching existing patterns

---

### P0-2: Camera Block (Resource Contributor)

- [ ] Block type: `'Camera'`, category: `'Scene'`
- [ ] Block has **NO output ports** (verify visually and in code)
- [ ] Inputs defined:
  - `position` (Signal<vec3>, default: {0,0,100})
  - `target` (Signal<vec3>, default: {0,0,0})
  - `up` (Signal<vec3>, optional, default: {0,1,0})
  - `projectionKind` (Scalar<string>, select: perspective/orthographic)
  - `fovYDeg` (Signal<number>, slider 10-120, default: 60)
  - `orthoHeight` (Signal<number>, default: 10)
  - `near` (Signal<number>, default: 0.1)
  - `far` (Signal<number>, default: 1000)
- [ ] Vec3 editor renders for position/target/up
- [ ] Dropdown renders for projectionKind
- [ ] Block appears in library under Scene category
- [ ] Block registered in block registry

---

### P0-3: CameraIR Schema (Locked)

- [ ] CameraIR interface in `types3d.ts` includes all fields:
  - `id: CameraId`
  - `handedness: 'right'` (literal type)
  - `forwardAxis: '-Z'` (literal type)
  - `upAxis: '+Y'` (literal type)
  - `projection.kind: 'perspective' | 'orthographic'`
  - `projection.near: number`
  - `projection.far: number`
  - `projection.fovYRad: number` (RADIANS)
  - `projection.orthoHeight: number`
  - `pose.position: { x, y, z }`
  - `pose.target: { x, y, z }`
  - `pose.up: { x, y, z }`
  - `viewportPolicy: 'useRuntimeViewport'`
  - `sourceBlockId: BlockId`
- [ ] Convention fields use literal types (not `string`)
- [ ] fovYRad is documented as radians

---

### P1-1: Camera Compiler/Lowering

- [ ] `src/editor/compiler/blocks/scene/Camera.ts` created
- [ ] `lowerCamera()` function implemented
- [ ] Registered in block type registry with `capability: 'camera'`
- [ ] `ctx.builder.addCamera()` method exists in IRBuilder
- [ ] `program.cameras: CameraIR[]` populated after compilation
- [ ] Camera ID follows pattern `camera-${blockId}`
- [ ] fovYDeg converted to fovYRad (× π/180)
- [ ] Defaults applied for optional `up` input

---

### P1-2: Camera Validation & Diagnostics

- [ ] `CAMERA_INVALID_NEAR`: near <= 0 → error
- [ ] `CAMERA_INVALID_FAR`: far <= near → error
- [ ] `CAMERA_DEGENERATE_LOOKAT`: position === target → error
- [ ] `CAMERA_DEGENERATE_UP`: up parallel to view direction → error
- [ ] `CAMERA_INVALID_FOV`: fovY <= 1° or >= 179° → error
- [ ] `CAMERA_INVALID_PROJECTION`: kind not in valid set → error
- [ ] All errors include `where: { blockId, port }`
- [ ] Errors surface in UI (compile diagnostics panel or console)

---

### P1-3: Camera Selection Semantics

- [ ] `program.activeCameraId: CameraId | null` added to CompiledProgramIR
- [ ] 0 cameras → activeCameraId = null, runtime creates default
- [ ] 1 camera → activeCameraId = that camera's ID
- [ ] N cameras → activeCameraId = first by stable order (creation order or sorted ID)
- [ ] Default runtime camera: position (0,0,100), target (0,0,0), perspective 60°
- [ ] Selection is deterministic (same patch → same active camera)

---

## Validation Checklist

### Manual UI Testing

**Vec3 Editor:**
- [ ] Create Camera block, select it
- [ ] Inspector shows X/Y/Z for position
- [ ] Type in X field, Y and Z unchanged
- [ ] Copy `{"x":5,"y":10,"z":15}`, paste into X field → all three update
- [ ] Wire a signal to position → inputs become disabled

**Camera Block:**
- [ ] Drag Camera from library
- [ ] Block has NO visible output port
- [ ] All 8 inputs visible in Inspector
- [ ] Projection dropdown works
- [ ] FOV slider ranges 10-120

### DevTools Verification

**Compiled Program:**
```javascript
// In console after playing patch:
const program = window.__DEBUG_PROGRAM__;
console.log(program.cameras);       // Array with camera entries
console.log(program.activeCameraId); // ID of active camera
```

- [ ] `program.cameras.length === 1` with one Camera block
- [ ] `program.cameras[0].id === 'camera-<blockId>'`
- [ ] `program.cameras[0].projection.fovYRad` is in radians (~1.047 for 60°)
- [ ] `program.activeCameraId` matches the camera ID

**Validation Errors:**
- [ ] Set near = 0 → compile error appears
- [ ] Set far = 0.01 (less than near) → compile error
- [ ] Set position = target = (0,0,0) → degenerate lookAt error

---

## Documentation Requirements

- [ ] CameraIR conventions documented in `types3d.ts` JSDoc
- [ ] `lowerCamera()` has inline comments explaining validation
- [ ] Camera selection rules documented in `program.ts` or related

---

## Rollback Plan

All changes are additive. If blocked:
1. **Vec3 issue:** Use three separate number inputs temporarily (keep vec3 type in model)
2. **Validation issue:** Skip validation, add as TODO
3. **Selection issue:** Hardcode first camera, document limitation

---

## Success Criteria Summary

**Must Have:**
- Camera block exists, contributes to `program.cameras`
- No wire outputs (resource pattern correct)
- Vec3 editor works for position/target
- CameraIR schema locked with conventions
- Basic validation (near > 0, far > near)

**Should Have:**
- All 6 validation rules
- Deterministic multi-camera selection
- activeCameraId in program

**Won't Have (Deferred):**
- RenderInstances3D consuming camera
- Mesh blocks
- Camera preview/frustum visualization
