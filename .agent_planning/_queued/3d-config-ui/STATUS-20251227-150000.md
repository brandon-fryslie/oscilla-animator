# Status Report - 2025-12-27-150000
Scope: project/3d-config-ui
Confidence: FRESH
Git Commit: (current working tree)

## Executive Summary

**Overall Readiness: 40% ready for 3D config UI implementation**

The 3D runtime infrastructure is COMPLETE and well-designed. However, there are significant gaps between the runtime layer and the UI layer:

| Component | Status | Blocking? |
|-----------|--------|-----------|
| CameraStore/MeshStore | COMPLETE | No |
| CameraIR/MeshIR types | COMPLETE | No |
| Step executors (CameraEval, MeshMaterialize, Instances3DProject) | COMPLETE | No |
| Camera block definition | NOT STARTED | **Yes** |
| Mesh block definition | NOT STARTED | **Yes** |
| RenderInstances3D block | NOT STARTED | **Yes** |
| Vec3 UI control | NOT STARTED | **Yes** |
| Quaternion UI control | NOT STARTED | **Yes** |
| Inspector integration | PARTIAL (patterns exist) | No |

---

## 1. Existing UI Patterns

### [FRESH] Inspector Architecture

**Location:** `src/editor/Inspector.tsx` (1581 lines)

The Inspector uses a component-based approach with specialized sections:

1. **`InspectorContainer`** - Standard wrapper with title, type badge, color accent
2. **`DefaultSourceControl`** - Renders controls based on `uiHint.kind`:
   - `slider` - Range input (min/max/step)
   - `number` - Number input
   - `select` - Dropdown with options
   - `color` - Color picker
   - `boolean` - Checkbox
   - `xy` - XY/vec2 editor (two number inputs)
   - `text` - Text input fallback

3. **Section components:**
   - `DiagnosticsSection` - Shows errors/warnings
   - `DefaultSourcesSection` - Undriven input controls
   - `CompatibleBlocksSection` - Block replacement options

### [FRESH] Block Definition Pattern

**Location:** `src/editor/blocks/domain.ts` (1413 lines)

Blocks use `createBlock()` factory with `defaultSource` on inputs for UI generation:

```typescript
input('rows', 'Rows', 'Scalar:number', {
  tier: 'primary',
  defaultSource: {
    value: 10,
    world: 'scalar',
    uiHint: { kind: 'slider', min: 1, max: 100, step: 1 },
  },
}),
```

**Key observations:**
- `uiHint.kind` drives control type
- `defaultSource.value` provides initial value
- `tier: 'primary' | 'secondary'` for UI priority
- `paramSchema` is LEGACY but still present (marked with TODO for removal)

### [FRESH] LensChainEditor Pattern

**Location:** `src/editor/modulation-table/LensChainEditor.tsx` (1205 lines)

Complex parameter editing with:
- SVG curve preview components
- Expandable/collapsible sections
- Recently used tracking
- Category-organized presets

**Relevant for 3D UI:** The pattern of visual previews (curves) could be adapted for camera/mesh previews.

---

## 2. Block Definition Gaps

### [FRESH] Camera Block - NOT STARTED

**No Camera block exists in the codebase.**

Searched:
- `src/editor/blocks/` - No camera-related definitions
- `src/editor/compiler/blocks/domain/` - No camera lowering

**Required elements for Camera block:**

```typescript
// Proposed inputs based on CameraIR structure:
input('position', 'Position', 'Signal<vec3>', {
  tier: 'primary',
  defaultSource: {
    value: { x: 0, y: 0, z: 100 },
    world: 'signal',
    uiHint: { kind: 'vec3' }  // NEW uiHint kind needed
  },
}),
input('lookAt', 'Look At', 'Signal<vec3>', {
  tier: 'primary',
  defaultSource: {
    value: { x: 0, y: 0, z: 0 },
    world: 'signal',
    uiHint: { kind: 'vec3' }
  },
}),
input('projectionKind', 'Projection', 'Scalar:string', {
  tier: 'primary',
  defaultSource: {
    value: 'perspective',
    world: 'config',
    uiHint: {
      kind: 'select',
      options: [
        { value: 'perspective', label: 'Perspective' },
        { value: 'orthographic', label: 'Orthographic' }
      ]
    }
  },
}),
input('fovY', 'Field of View (deg)', 'Signal<number>', {
  tier: 'primary',
  defaultSource: {
    value: 60,
    world: 'signal',
    uiHint: { kind: 'slider', min: 10, max: 120, step: 5 }
  },
}),
// etc.
```

### [FRESH] Mesh Block - NOT STARTED

**No Mesh/Geometry block exists in the codebase.**

**Required elements for Mesh block:**

The `MeshIR` type defines the recipe structure:
- `profile`: circle/ngon/polyline
- `extrude`: linear/rounded
- `bevel`: optional

This would need a multi-select UI:
1. Profile selector (circle/ngon/polyline)
2. Profile-specific params (radius, segments, sides, etc.)
3. Extrusion selector (linear/rounded)
4. Extrusion-specific params (depth, caps, etc.)

### [FRESH] RenderInstances3D Block - NOT STARTED

**No 3D render block exists.**

Needs to consume:
- Domain
- Camera (reference by ID)
- Mesh (reference by ID)
- Field<vec3> positions
- Field<quat> rotations (optional)
- Field<number> scales (optional)
- Style fields (color, opacity)

And produce Instance2DBufferRef via `executeInstances3DProject`.

---

## 3. Inspector Integration

### [FRESH] Control Types Available

| uiHint.kind | Implementation | Status |
|-------------|----------------|--------|
| `slider` | `<input type="range">` | COMPLETE |
| `number` | `<input type="number">` | COMPLETE |
| `select` | `<select>` | COMPLETE |
| `color` | `<input type="color">` | COMPLETE |
| `boolean` | `<input type="checkbox">` | COMPLETE |
| `xy` | Two number inputs | COMPLETE |
| `text` | `<input type="text">` | COMPLETE |
| `vec3` | **NOT IMPLEMENTED** | MISSING |
| `quat` | **NOT IMPLEMENTED** | MISSING |

### [FRESH] Required New Controls

1. **Vec3 Editor (`uiHint.kind: 'vec3'`)**
   - Three labeled number inputs (X, Y, Z)
   - Optional: 3D gizmo preview
   - Copy/paste support for { x, y, z } objects

2. **Quaternion Editor (`uiHint.kind: 'quat'`)**
   - Options:
     - Raw XYZW inputs (expert mode)
     - Euler angles XYZ (user-friendly, with conversion)
     - Axis-angle (alternative representation)
   - Normalize button

3. **Camera Preview Widget**
   - Shows frustum visualization
   - Interactive position/orientation gizmo

4. **Mesh Preview Widget**
   - Shows wireframe preview of generated geometry
   - Updates on parameter change

---

## 4. Store/State Integration

### [FRESH] CameraIR/MeshIR Storage

**Current state:** CameraStore and MeshStore are RUNTIME caches only.

**Gap:** No patch-level storage for camera/mesh definitions.

**Required integration:**

1. **Option A: Store in Patch**
   - Add `cameras: CameraIR[]` and `meshes: MeshIR[]` to patch data
   - Compile to CameraTable/MeshTable during IR generation
   - UI blocks reference by ID

2. **Option B: Generate from Blocks**
   - Camera/Mesh blocks generate IR directly
   - IDs derived from block IDs
   - Compile phase populates tables from block outputs

**Recommendation:** Option B aligns with existing block-centric architecture.

### [FRESH] Block Registry

**Location:** `src/editor/blocks/registry.ts`

Blocks register via `registerBlockType()` for compiler integration:

```typescript
registerBlockType({
  type: 'RenderInstances2D',
  capability: 'render',
  inputs: [...],
  outputs: [...],
  lower: lowerRenderInstances2D,
});
```

Camera/Mesh blocks would need similar registration with `capability: 'scene'` or similar.

---

## 5. UI Components Needed

### [FRESH] Priority 1 - Core Controls

| Component | Complexity | Blocking? |
|-----------|------------|-----------|
| Vec3Editor | Low | Yes |
| ProjectionSelector | Low | Yes |
| NumberSlider (already exists) | N/A | No |

### [FRESH] Priority 2 - Enhanced Controls

| Component | Complexity | Blocking? |
|-----------|------------|-----------|
| QuaternionEditor | Medium | No (can use lookAt) |
| FOVSlider with preview | Medium | No (slider works) |
| NearFarRange | Low | No |

### [FRESH] Priority 3 - Mesh Controls

| Component | Complexity | Blocking? |
|-----------|------------|-----------|
| ProfileTypeSelector | Low | Yes (if mesh block added) |
| ExtrusionTypeSelector | Low | Yes (if mesh block added) |
| SegmentSlider | Low | No |

### [FRESH] Priority 4 - Preview Widgets

| Component | Complexity | Blocking? |
|-----------|------------|-----------|
| CameraFrustumPreview | High | No |
| MeshWireframePreview | High | No |
| 3D Gizmo (position) | Very High | No |

---

## 6. Data Flow Verification

### [FRESH] Current 3D Data Flow

```
                   [NOT IMPLEMENTED]
                         |
                         v
+------------------+    +-----------------+    +------------------+
| Camera Block     | -> | CameraTable     | -> | CameraStore      |
| (NOT EXISTS)     |    | (in Program IR) |    | (runtime cache)  |
+------------------+    +-----------------+    +------------------+
                                                      |
                                                      v
                                               +-------------+
                                               | CameraEval  |
                                               | (matrices)  |
                                               +-------------+
                                                      |
                                                      v
                                         +------------------------+
                                         | Instances3DProjectTo2D |
                                         | (projection step)      |
                                         +------------------------+
                                                      |
                                                      v
                                         +------------------------+
                                         | Instance2DBufferRef    |
                                         | (2D render data)       |
                                         +------------------------+
```

**Gap:** The UI -> IR generation path does not exist for 3D.

---

## 7. Ambiguities Found

| Area | Question | Impact |
|------|----------|--------|
| Camera ID generation | How are camera IDs generated from blocks? Block ID? User-specified? | Medium - affects referencing |
| Multiple cameras | Can a patch have multiple cameras? If so, how to select active? | Medium - affects architecture |
| Mesh vs Shape | Is a "Mesh" block distinct from geometry primitives? | Low - naming only |
| Orientation input | Should cameras use lookAt (euler) or quaternion? | Medium - affects UI complexity |
| Dynamic camera params | Which camera params can be animated (Signal) vs static (Scalar)? | High - affects type signatures |

---

## Recommendations

### Priority Order

1. **Create Vec3Editor control** (1-2 hours)
   - Extend `DefaultSourceControl` to handle `{ kind: 'vec3' }`
   - Three number inputs in a row

2. **Create Camera block definition** (2-3 hours)
   - `src/editor/blocks/camera.ts` with inputs for position, lookAt, fov, near, far
   - Use `Signal<vec3>` for animatable position/lookAt
   - Use `Scalar:string` for projection type selection

3. **Create Camera compiler/lowering** (2-3 hours)
   - `src/editor/compiler/blocks/domain/Camera.ts`
   - Generate CameraIR from block inputs
   - Add to CameraTable in program IR

4. **Wire Camera to RenderInstances3D** (3-4 hours)
   - Create RenderInstances3D block definition
   - Wire camera input (by ID reference)
   - Connect to Instances3DProjectTo2D executor

5. **Optional: Mesh block** (4-6 hours)
   - More complex due to profile/extrude variations
   - Can defer if using default/hardcoded meshes initially

---

## Workflow Recommendation

- [X] CONTINUE - Issues are clear, implementer can fix

**Reasoning:** The 3D runtime infrastructure is complete and well-documented. The gaps are in the UI/block layer, which follows clear existing patterns. The implementer can:

1. Copy existing patterns from domain blocks
2. Add new uiHint kinds following DefaultSourceControl pattern
3. Create compiler lowering following RenderInstances2D pattern

No clarification needed - the path forward is deterministic.
