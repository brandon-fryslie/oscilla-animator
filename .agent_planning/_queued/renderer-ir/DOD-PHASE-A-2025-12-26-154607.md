# Definition of Done: Phase A - IR Type Definitions
**Generated:** 2025-12-26-154607
**Plan:** PLAN-PHASE-A-2025-12-26-154607.md
**Master Plan:** MASTER-PLAN-2025-12-26-154607.md

---

## Sprint Scope

This sprint delivers pure TypeScript type definitions for the complete Renderer IR system. No runtime implementation, no behavior changes - only interfaces and type unions that exactly match design doc 01-RendererIR.md.

**Deliverables:** 4 main deliverables across 6 work items
**Estimated Effort:** 2 sprints
**Deferred:** Runtime implementation (Phases C, D), color encoding (Phase B), caching (Phase E)

---

## Acceptance Criteria

All criteria must be met before sprint completion. No exceptions.

### P0: RenderFrameIR Core Types

- [ ] `RenderFrameIR` interface defined in `src/editor/compiler/ir/renderIR.ts`
  - `version: 1` field
  - `frameKey?: FrameKey` (optional)
  - `clear: ClearSpecIR` field
  - `passes: RenderPassIR[]` field
  - `overlays?: RenderPassIR[]` (optional)
  - `meta?: RenderFrameMetaIR` (optional)
- [ ] `RenderPassIR` union type defined with all variants:
  - `Instances2DPassIR`
  - `Paths2DPassIR`
  - `PostFXPassIR` (stub for future, can be empty interface)
- [ ] `RenderPassHeaderIR` interface defined with all fields:
  - `id: string` (stable pass identity)
  - `z: number` (ordering control)
  - `enabled: boolean`
  - `clip?: ClipSpecIR` (optional)
  - `view?: Mat3x2IR` (optional)
  - `blend?: BlendSpecIR` (optional)
  - `notes?: string[]` (optional warnings)
- [ ] `ClearSpecIR` interface defined:
  - `mode: "none" | "color"`
  - `colorRGBA?: number` (packed u32 - convention TBD in Phase B)
- [ ] `BlendSpecIR` interface defined:
  - `mode: "normal" | "add" | "multiply" | "screen"`
  - `opacity?: number` (pass-wide alpha)
- [ ] `ClipSpecIR` union type defined:
  - Rect variant: `{ kind: "rect"; x: number; y: number; w: number; h: number }`
  - Path variant: `{ kind: "path"; geometry: PathGeometryBufferIR }` (forward reference ok)
- [ ] `FrameKey` type defined (can be simple string or number for now)
- [ ] `RenderFrameMetaIR` interface defined (can be `{ [key: string]: unknown }` placeholder)
- [ ] All types have JSDoc comments explaining purpose and relationship to design doc
- [ ] TypeScript strict mode passes (`just typecheck`)
- [ ] No imports of runtime code - types only

### P0: Buffer Reference Types

- [ ] `BufferRefIR` interface defined:
  - `bufferId: number` (dense ID in BufferStore)
  - `type: "f32" | "u32" | "u16" | "u8"`
  - `length: number` (element count, not bytes)
- [ ] `ScalarF32IR` type defined: `{ kind: "scalar:f32"; value: number }`
- [ ] `ScalarU32IR` type defined: `{ kind: "scalar:u32"; value: number }`
- [ ] `ScalarU16IR` type defined: `{ kind: "scalar:u16"; value: number }`
- [ ] JSDoc explains scalar broadcast semantics (value used as-if it were a buffer)
- [ ] `Mat3x2IR` interface defined (2D affine transform):
  - Fields: `a, b, c, d, e, f: number` (standard affine matrix layout)
  - JSDoc documents convention: `[a c e; b d f; 0 0 1]` homogeneous coords
- [ ] All types compile cleanly (`just typecheck`)

### P1: Instances2D Pass Types

- [ ] `Instances2DPassIR` interface defined:
  - `kind: "instances2d"` (literal type for union discrimination)
  - `header: RenderPassHeaderIR`
  - `count: number` (instance count)
  - `material: InstanceMaterialIR`
  - `buffers: InstanceBufferSetIR`
  - `sort?: InstanceSortIR` (optional)
- [ ] `InstanceMaterialIR` union type defined with all variants:
  - Shape2D: `{ kind: "shape2d"; shading: "flat"; colorSpace: "srgb" | "linear" }`
  - Sprite: `{ kind: "sprite"; sampling: "nearest" | "linear"; textureId: string }`
  - Glyph: `{ kind: "glyph"; fontId: string }` (future, but define now)
- [ ] `InstanceBufferSetIR` interface defined with all fields:
  - Required: `posXY: BufferRefIR` (Float32Array, length = count*2)
  - Optional common: `size: BufferRefIR | ScalarF32IR`
  - Optional common: `rot: BufferRefIR | ScalarF32IR` (radians)
  - Optional common: `colorRGBA: BufferRefIR | ScalarU32IR` (packed - encoding TBD Phase B)
  - Optional common: `opacity: BufferRefIR | ScalarF32IR`
  - Optional shape: `shapeId?: BufferRefIR | ScalarU16IR` (Uint16Array: 0=circle, 1=square, 2=star...)
  - Optional stroke: `strokeWidth?: BufferRefIR | ScalarF32IR`
  - Optional stroke: `strokeColorRGBA?: BufferRefIR | ScalarU32IR`
  - Custom: `custom?: Record<string, BufferRefIR>` (extensibility for advanced materials)
- [ ] `InstanceSortIR` union type defined:
  - None: `{ kind: "none" }`
  - ByKey: `{ kind: "byKey"; key: BufferRefIR; order: "asc" | "desc" }` (Float32 key)
- [ ] JSDoc documents buffer layout conventions (posXY is interleaved xy pairs)
- [ ] JSDoc documents shapeId encoding (0=circle, etc.) - matches shape2d block conventions
- [ ] All types compile (`just typecheck`)

### P1: Paths2D Pass Types

- [ ] `Paths2DPassIR` interface defined:
  - `kind: "paths2d"` (literal type)
  - `header: RenderPassHeaderIR`
  - `geometry: PathGeometryBufferIR`
  - `style: PathStyleIR`
  - `draw: { stroke: boolean; fill: boolean }`
- [ ] `PathGeometryBufferIR` interface defined:
  - `pathCount: number` (number of paths in this pass)
  - `pathCommandStart: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathCommandLen: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathPointStart: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathPointLen: BufferRefIR` (Uint32Array, length = pathCount)
  - `commands: BufferRefIR` (Uint8Array or Uint16Array - Phase B locks to u16)
  - `pointsXY: BufferRefIR` (Float32Array, length = totalPoints*2)
  - `aux?: BufferRefIR` (optional, for arc parameters etc. - future)
  - `encoding: PathEncodingIR`
- [ ] `PathEncodingIR` type defined:
  - `kind: "v1"`
  - `commands: ("M" | "L" | "Q" | "C" | "Z")[]` (conceptual - stored as numeric codes)
  - JSDoc documents command semantics:
    - M (MoveTo): consumes 1 point
    - L (LineTo): consumes 1 point
    - Q (QuadraticTo): consumes 2 points (ctrl, end)
    - C (CubicTo): consumes 3 points (c1, c2, end)
    - Z (Close): consumes 0 points
- [ ] `PathStyleIR` interface defined:
  - Fill: `fillColorRGBA?: BufferRefIR | ScalarU32IR` (per-path or global)
  - Fill: `fillRule?: "nonzero" | "evenodd"`
  - Stroke: `strokeColorRGBA?: BufferRefIR | ScalarU32IR`
  - Stroke: `strokeWidth?: BufferRefIR | ScalarF32IR`
  - Stroke: `lineCap?: "butt" | "round" | "square"`
  - Stroke: `lineJoin?: "miter" | "round" | "bevel"`
  - Stroke: `miterLimit?: number`
  - Stroke: `dash?: { pattern: number[]; offset?: number } | null`
  - Opacity: `opacity?: BufferRefIR | ScalarF32IR`
- [ ] JSDoc documents path indexing scheme (per-path slices into command/point arrays)
- [ ] JSDoc documents command encoding (numeric codes: 0=M, 1=L, 2=Q, 3=C, 4=Z or similar)
- [ ] All types compile (`just typecheck`)

### P2: Type Export and Module Organization

- [ ] All RenderIR types exported from `src/editor/compiler/ir/renderIR.ts`
- [ ] Type exports grouped logically in file (Frame types, Pass types, Buffer types, etc.)
- [ ] File header comment documents purpose and design doc reference
- [ ] Create type-only imports in existing files to verify accessibility (no runtime changes)
- [ ] Example import in test file: `import type { RenderFrameIR } from '@/editor/compiler/ir/renderIR'` compiles
- [ ] No circular dependencies introduced (`just typecheck` passes)
- [ ] Run `just check` - must pass with zero warnings
- [ ] Git diff shows only additive changes (new file, or additions to existing IR files)

### P2: Design Doc Alignment Verification

- [ ] Review checklist completed for Doc 01 Section 1 (RenderFrameIR):
  - All fields present: version, frameKey, clear, passes, overlays, meta
  - Types match spec exactly (no deviations)
- [ ] Review checklist completed for Doc 01 Section 2 (Pass model):
  - RenderPassIR union complete (Instances2D, Paths2D, PostFX)
  - RenderPassHeaderIR matches spec (id, z, enabled, clip, view, blend, notes)
- [ ] Review checklist completed for Doc 01 Section 3 (Instances2D):
  - Instances2DPassIR structure complete
  - InstanceMaterialIR has all variants (shape2d, sprite, glyph)
  - InstanceBufferSetIR has all required/optional fields
  - InstanceSortIR has none/byKey variants
- [ ] Review checklist completed for Doc 01 Section 4 (Paths2D):
  - Paths2DPassIR structure complete
  - PathGeometryBufferIR indexing scheme matches spec
  - PathEncodingIR command set correct (M, L, Q, C, Z)
  - PathStyleIR has all stroke/fill/dash fields
- [ ] Review checklist completed for Doc 01 Section 5 (Buffer references):
  - BufferRefIR fields correct (bufferId, type, length)
  - Scalar broadcast types defined (F32, U32, U16)
- [ ] Review checklist completed for Doc 01 Section 6 (Clear, blend, clip, transforms):
  - ClearSpecIR matches spec
  - BlendSpecIR matches spec
  - ClipSpecIR has rect/path variants
  - Mat3x2IR has correct fields
- [ ] Document any intentional deviations in `PHASE-A-DEVIATIONS.md` (should be zero)
- [ ] Run `just typecheck` - must pass
- [ ] All JSDoc comments reference design doc sections

---

## Verification Steps

Run these commands in order. All must pass.

### 1. Type Check

```bash
just typecheck
```

**Expected:** Zero errors, zero warnings

### 2. Full Check Suite

```bash
just check
```

**Expected:** Typecheck + lint + tests all pass

### 3. Design Doc Review

- Open `design-docs/13-Renderer/01-RendererIR.md`
- For each section (1-6), verify corresponding types exist and match exactly
- Complete verification checklist (P2 criteria above)

### 4. Git Diff Inspection

```bash
git diff --stat
git diff src/editor/compiler/ir/renderIR.ts
```

**Expected:**
- Only new file `src/editor/compiler/ir/renderIR.ts` or additions to existing IR files
- No modifications to runtime code in `src/editor/runtime/`
- No modifications to blocks in `src/editor/compiler/blocks/`
- No test file changes (except optional type-only tests)

### 5. Import Test

Create temporary test file:

```typescript
// test-imports.ts
import type {
  RenderFrameIR,
  RenderPassIR,
  Instances2DPassIR,
  Paths2DPassIR,
  BufferRefIR,
  ScalarF32IR,
} from '@/editor/compiler/ir/renderIR';

// Should compile without errors
const _test: RenderFrameIR = {} as any;
```

Run `just typecheck` - must pass. Delete test file after verification.

---

## Sprint Complete When

- [ ] All acceptance criteria checked
- [ ] All verification steps passed
- [ ] Code review approved
- [ ] Design doc alignment verified (100% match)
- [ ] No runtime code modified (pure types only)
- [ ] Phase B, C, D leads notified (can begin planning)

**Sign-off Required:**
- [ ] Lead engineer approval
- [ ] Design doc author approval
- [ ] Downstream phase leads acknowledged

---

## What Happens Next

After Phase A sign-off:

1. **Phase B (Color & Encoding)** can begin detailed planning
2. **Phase C (Instances2D Runtime)** can begin high-level design
3. **Phase D (Paths2D Runtime)** can begin high-level design
4. Phase 6 runtime work continues in parallel (executeNodeEval, executeRenderAssemble)

**Critical Path:** Phase A → Phase B → Phase C (first visual output)

---

## Rollback Criteria

Rollback Phase A if:

- TypeScript compilation issues unfixable without runtime changes
- Circular dependency issues with existing IR types cannot be resolved
- Major design doc revision invalidates current type definitions
- Downstream phases identify critical missing types (should not happen if verification thorough)

**Rollback Procedure:**
1. Revert commit(s) adding renderIR types
2. Verify `just check` still passes
3. Document reason for rollback
4. Update master plan with revised Phase A scope
