# Sprint Plan: Phase A - IR Type Definitions
**Generated:** 2025-12-26-154607
**Source STATUS:** STATUS-20251226160000.md
**Master Plan:** MASTER-PLAN-2025-12-26-154607.md
**Estimated Sprints:** 2
**Phase:** A (IR Type Definitions)

---

## Sprint Goal

Define all RenderFrameIR types as pure TypeScript interfaces in `src/editor/compiler/ir/renderIR.ts`. This phase is purely additive - no runtime changes, no behavior modifications. All types must match design doc 01-RendererIR.md exactly.

**Success Metric:** `just typecheck` passes with all new types, zero runtime changes.

---

## Scope

### In Scope (This Sprint)

**Deliverable 1: RenderFrameIR Core Types**
- RenderFrameIR root interface
- RenderPassIR union type (Instances2D, Paths2D, PostFX variants)
- RenderPassHeaderIR with all pass-level specs
- Clear, blend, clip, view transform types

**Deliverable 2: Buffer Reference Types**
- BufferRefIR interface (bufferId, type, length)
- Scalar broadcast types (ScalarF32IR, ScalarU32IR, ScalarU16IR)
- Mat3x2IR (2D affine transform)

**Deliverable 3: Instances2D Pass Types**
- Instances2DPassIR complete structure
- InstanceMaterialIR (shape2d, sprite, glyph variants)
- InstanceBufferSetIR (posXY, size, rot, colorRGBA, etc.)
- InstanceSortIR (none, byKey)

**Deliverable 4: Paths2D Pass Types**
- Paths2DPassIR complete structure
- PathGeometryBufferIR (command/point streams, path indexing)
- PathEncodingIR (command set: M, L, Q, C, Z)
- PathStyleIR (fill, stroke, dash, caps, joins)

### Explicitly Out of Scope

- Runtime implementation (Phase C, D)
- Canvas renderer changes (Phase F)
- Color encoding migration (Phase B)
- Materialization step integration (Phase C, D)
- Cache key specifications (Phase E)
- 3D types (CameraIR, MeshIR) - (Phase G)
- Any modifications to existing runtime code
- Tests for runtime behavior (tests for type completeness only)

---

## Work Items

### P0: RenderFrameIR Core Types

**Status:** Not Started
**Effort:** Small (1 day)
**Dependencies:** None
**Spec Reference:** Doc 01 Section 1 • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Create the root RenderFrameIR interface and all supporting pass infrastructure types. This is the contract between VM and renderer - the frame payload produced by `executeRenderAssemble` and consumed by Canvas renderer.

#### Acceptance Criteria

- [ ] `RenderFrameIR` interface defined in `src/editor/compiler/ir/renderIR.ts`
  - `version: 1` field
  - `frameKey?: FrameKey` (optional)
  - `clear: ClearSpecIR` field
  - `passes: RenderPassIR[]` field
  - `overlays?: RenderPassIR[]` (optional)
  - `meta?: RenderFrameMetaIR` (optional)
- [ ] `RenderPassIR` union type defined with all variants:
  - `Instances2DPassIR`
  - `Paths2DPassIR`
  - `PostFXPassIR` (stub for future, can be empty interface)
- [ ] `RenderPassHeaderIR` interface defined with all fields:
  - `id: string` (stable pass identity)
  - `z: number` (ordering control)
  - `enabled: boolean`
  - `clip?: ClipSpecIR` (optional)
  - `view?: Mat3x2IR` (optional)
  - `blend?: BlendSpecIR` (optional)
  - `notes?: string[]` (optional warnings)
- [ ] `ClearSpecIR` interface defined:
  - `mode: "none" | "color"`
  - `colorRGBA?: number` (packed u32 - convention TBD in Phase B)
- [ ] `BlendSpecIR` interface defined:
  - `mode: "normal" | "add" | "multiply" | "screen"`
  - `opacity?: number` (pass-wide alpha)
- [ ] `ClipSpecIR` union type defined:
  - Rect variant: `{ kind: "rect"; x: number; y: number; w: number; h: number }`
  - Path variant: `{ kind: "path"; geometry: PathGeometryBufferIR }` (forward reference ok)
- [ ] `FrameKey` type defined (can be simple string or number for now)
- [ ] `RenderFrameMetaIR` interface defined (can be `{ [key: string]: unknown }` placeholder)
- [ ] All types have JSDoc comments explaining purpose and relationship to design doc
- [ ] TypeScript strict mode passes (`just typecheck`)
- [ ] No imports of runtime code - types only

#### Technical Notes

- This is the "table of contents" for the entire renderer IR
- FrameKey will be used for hot-swap cache continuity (Phase E)
- PostFXPassIR is future work but define the union now for completeness
- ClipSpecIR path variant creates circular reference to PathGeometryBufferIR - TypeScript allows forward references

---

### P0: Buffer Reference Types

**Status:** Not Started
**Effort:** Small (0.5 days)
**Dependencies:** None
**Spec Reference:** Doc 01 Section 5 • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Define the canonical buffer reference system that materializers use to allocate typed arrays and passes use to reference them. These are the building blocks for all instance and path buffer payloads.

#### Acceptance Criteria

- [ ] `BufferRefIR` interface defined:
  - `bufferId: number` (dense ID in BufferStore)
  - `type: "f32" | "u32" | "u16" | "u8"`
  - `length: number` (element count, not bytes)
- [ ] `ScalarF32IR` type defined: `{ kind: "scalar:f32"; value: number }`
- [ ] `ScalarU32IR` type defined: `{ kind: "scalar:u32"; value: number }`
- [ ] `ScalarU16IR` type defined: `{ kind: "scalar:u16"; value: number }`
- [ ] JSDoc explains scalar broadcast semantics (value used as-if it were a buffer)
- [ ] `Mat3x2IR` interface defined (2D affine transform):
  - Fields: `a, b, c, d, e, f: number` (standard affine matrix layout)
  - JSDoc documents convention: `[a c e; b d f; 0 0 1]` homogeneous coords
- [ ] All types compile cleanly (`just typecheck`)

#### Technical Notes

- BufferRefIR references ValueStore buffer allocations (Phase 6 infrastructure)
- Scalar broadcasts avoid allocating N copies of constant values
- Mat3x2IR follows Canvas2D `setTransform(a,b,c,d,e,f)` convention
- These types will be used extensively in Phases C and D

---

### P1: Instances2D Pass Types

**Status:** Not Started
**Effort:** Medium (1 day)
**Dependencies:** P0 Buffer Reference Types
**Spec Reference:** Doc 01 Section 3 • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Define the complete Instances2D pass structure - the "thousands of particles" fast path. This includes material selection (shape2d, sprite, glyph), buffer layout for per-instance attributes, and optional sorting.

#### Acceptance Criteria

- [ ] `Instances2DPassIR` interface defined:
  - `kind: "instances2d"` (literal type for union discrimination)
  - `header: RenderPassHeaderIR`
  - `count: number` (instance count)
  - `material: InstanceMaterialIR`
  - `buffers: InstanceBufferSetIR`
  - `sort?: InstanceSortIR` (optional)
- [ ] `InstanceMaterialIR` union type defined with all variants:
  - Shape2D: `{ kind: "shape2d"; shading: "flat"; colorSpace: "srgb" | "linear" }`
  - Sprite: `{ kind: "sprite"; sampling: "nearest" | "linear"; textureId: string }`
  - Glyph: `{ kind: "glyph"; fontId: string }` (future, but define now)
- [ ] `InstanceBufferSetIR` interface defined with all fields:
  - Required: `posXY: BufferRefIR` (Float32Array, length = count*2)
  - Optional common: `size: BufferRefIR | ScalarF32IR`
  - Optional common: `rot: BufferRefIR | ScalarF32IR` (radians)
  - Optional common: `colorRGBA: BufferRefIR | ScalarU32IR` (packed - encoding TBD Phase B)
  - Optional common: `opacity: BufferRefIR | ScalarF32IR`
  - Optional shape: `shapeId?: BufferRefIR | ScalarU16IR` (Uint16Array: 0=circle, 1=square, 2=star...)
  - Optional stroke: `strokeWidth?: BufferRefIR | ScalarF32IR`
  - Optional stroke: `strokeColorRGBA?: BufferRefIR | ScalarU32IR`
  - Custom: `custom?: Record<string, BufferRefIR>` (extensibility for advanced materials)
- [ ] `InstanceSortIR` union type defined:
  - None: `{ kind: "none" }`
  - ByKey: `{ kind: "byKey"; key: BufferRefIR; order: "asc" | "desc" }` (Float32 key)
- [ ] JSDoc documents buffer layout conventions (posXY is interleaved xy pairs)
- [ ] JSDoc documents shapeId encoding (0=circle, etc.) - matches shape2d block conventions
- [ ] All types compile (`just typecheck`)

#### Technical Notes

- InstanceBufferSetIR allows scalar broadcasts for constant values (e.g., all same size)
- ColorRGBA encoding (u32 vs u8x4) is locked in Phase B - type accepts both for now
- ShapeId encoding must match shape2d block implementations (see blocks/domain/)
- Custom fields allow future material extensions without breaking changes

---

### P1: Paths2D Pass Types

**Status:** Not Started
**Effort:** Medium (1.5 days)
**Dependencies:** P0 Buffer Reference Types
**Spec Reference:** Doc 01 Section 4 • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Define the complete Paths2D pass structure - the "morphing line art / glyph outlines" track. This includes packed command/point streams, per-path indexing, and rich styling (stroke, fill, dash, caps, joins).

#### Acceptance Criteria

- [ ] `Paths2DPassIR` interface defined:
  - `kind: "paths2d"` (literal type)
  - `header: RenderPassHeaderIR`
  - `geometry: PathGeometryBufferIR`
  - `style: PathStyleIR`
  - `draw: { stroke: boolean; fill: boolean }`
- [ ] `PathGeometryBufferIR` interface defined:
  - `pathCount: number` (number of paths in this pass)
  - `pathCommandStart: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathCommandLen: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathPointStart: BufferRefIR` (Uint32Array, length = pathCount)
  - `pathPointLen: BufferRefIR` (Uint32Array, length = pathCount)
  - `commands: BufferRefIR` (Uint8Array or Uint16Array - Phase B locks to u16)
  - `pointsXY: BufferRefIR` (Float32Array, length = totalPoints*2)
  - `aux?: BufferRefIR` (optional, for arc parameters etc. - future)
  - `encoding: PathEncodingIR`
- [ ] `PathEncodingIR` type defined:
  - `kind: "v1"`
  - `commands: ("M" | "L" | "Q" | "C" | "Z")[]` (conceptual - stored as numeric codes)
  - JSDoc documents command semantics:
    - M (MoveTo): consumes 1 point
    - L (LineTo): consumes 1 point
    - Q (QuadraticTo): consumes 2 points (ctrl, end)
    - C (CubicTo): consumes 3 points (c1, c2, end)
    - Z (Close): consumes 0 points
- [ ] `PathStyleIR` interface defined:
  - Fill: `fillColorRGBA?: BufferRefIR | ScalarU32IR` (per-path or global)
  - Fill: `fillRule?: "nonzero" | "evenodd"`
  - Stroke: `strokeColorRGBA?: BufferRefIR | ScalarU32IR`
  - Stroke: `strokeWidth?: BufferRefIR | ScalarF32IR`
  - Stroke: `lineCap?: "butt" | "round" | "square"`
  - Stroke: `lineJoin?: "miter" | "round" | "bevel"`
  - Stroke: `miterLimit?: number`
  - Stroke: `dash?: { pattern: number[]; offset?: number } | null`
  - Opacity: `opacity?: BufferRefIR | ScalarF32IR`
- [ ] JSDoc documents path indexing scheme (per-path slices into command/point arrays)
- [ ] JSDoc documents command encoding (numeric codes: 0=M, 1=L, 2=Q, 3=C, 4=Z or similar)
- [ ] All types compile (`just typecheck`)

#### Technical Notes

- Path geometry uses indexed arrays to support multiple paths in one pass efficiently
- Command stream encoding (u8 vs u16) is locked in Phase B (doc 03 specifies u16)
- PathEncodingIR.commands is conceptual - actual storage is numeric in `commands` buffer
- Path flattening policy (Phase D) will produce different command/point buffers for same source
- This structure supports morphing by maintaining stable point counts across frames

---

### P2: Type Export and Module Organization

**Status:** Not Started
**Effort:** Small (0.5 days)
**Dependencies:** All P0, P1 items
**Spec Reference:** Doc 01 (all) • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Organize all types into a clean module structure with proper exports, create a barrel export file if needed, and ensure types are accessible to downstream code (runtime, blocks, tests).

#### Acceptance Criteria

- [ ] All RenderIR types exported from `src/editor/compiler/ir/renderIR.ts`
- [ ] Type exports grouped logically in file (Frame types, Pass types, Buffer types, etc.)
- [ ] File header comment documents purpose and design doc reference
- [ ] Create type-only imports in existing files to verify accessibility (no runtime changes)
- [ ] Example import in test file: `import type { RenderFrameIR } from '@/editor/compiler/ir/renderIR'` compiles
- [ ] No circular dependencies introduced (`just typecheck` passes)
- [ ] Run `just check` - must pass with zero warnings
- [ ] Git diff shows only additive changes (new file, or additions to existing IR files)

#### Technical Notes

- Place in `src/editor/compiler/ir/renderIR.ts` alongside existing IR types
- Do not modify runtime code - types only
- If renderIR.ts becomes large (>1000 lines), consider splitting into subdirectory
- Mark all exports with `export type` or `export interface` (not runtime values yet)

---

### P2: Design Doc Alignment Verification

**Status:** Not Started
**Effort:** Small (0.5 days)
**Dependencies:** All other work items
**Spec Reference:** Doc 01 (all sections) • **Status Reference:** STATUS-20251226160000.md Doc 01 gaps

#### Description

Systematic review of all defined types against design doc 01-RendererIR.md to ensure 100% coverage and exact match. This is the quality gate before Phase A completion.

#### Acceptance Criteria

- [ ] Review checklist completed for Doc 01 Section 1 (RenderFrameIR):
  - All fields present: version, frameKey, clear, passes, overlays, meta
  - Types match spec exactly (no deviations)
- [ ] Review checklist completed for Doc 01 Section 2 (Pass model):
  - RenderPassIR union complete (Instances2D, Paths2D, PostFX)
  - RenderPassHeaderIR matches spec (id, z, enabled, clip, view, blend, notes)
- [ ] Review checklist completed for Doc 01 Section 3 (Instances2D):
  - Instances2DPassIR structure complete
  - InstanceMaterialIR has all variants (shape2d, sprite, glyph)
  - InstanceBufferSetIR has all required/optional fields
  - InstanceSortIR has none/byKey variants
- [ ] Review checklist completed for Doc 01 Section 4 (Paths2D):
  - Paths2DPassIR structure complete
  - PathGeometryBufferIR indexing scheme matches spec
  - PathEncodingIR command set correct (M, L, Q, C, Z)
  - PathStyleIR has all stroke/fill/dash fields
- [ ] Review checklist completed for Doc 01 Section 5 (Buffer references):
  - BufferRefIR fields correct (bufferId, type, length)
  - Scalar broadcast types defined (F32, U32, U16)
- [ ] Review checklist completed for Doc 01 Section 6 (Clear, blend, clip, transforms):
  - ClearSpecIR matches spec
  - BlendSpecIR matches spec
  - ClipSpecIR has rect/path variants
  - Mat3x2IR has correct fields
- [ ] Document any intentional deviations in `PHASE-A-DEVIATIONS.md` (should be zero)
- [ ] Run `just typecheck` - must pass
- [ ] All JSDoc comments reference design doc sections

#### Technical Notes

- This is a manual review checklist, not automated tests
- Create a checklist markdown file to track review progress
- Any deviations must be justified and documented
- This gate prevents downstream phases from implementing wrong contracts

---

## Dependencies

### Upstream Dependencies (BLOCKING)

**Phase 6 ScheduleExecutor:**
- `executeNodeEval` - needs to produce RenderFrameIR (not blocking for types, blocking for Phase C)
- `executeRenderAssemble` - needs to consume buffer refs and assemble frame (not blocking for types)

**Status:** Phase 6 partially complete, but type definitions don't require runtime changes.

**Action:** Phase A can proceed in parallel with Phase 6 runtime work.

### Downstream Dependencies (UNBLOCKED)

Phase A completion unblocks:
- **Phase B (Color/Encoding)** - needs BufferRefIR and InstanceBufferSetIR types
- **Phase C (Instances2D Runtime)** - needs Instances2DPassIR complete
- **Phase D (Paths2D Runtime)** - needs Paths2DPassIR complete
- **Phase E (Caching)** - needs all IR types for cache key specifications

---

## Risks

### Technical Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Type definitions don't match runtime needs | Medium | High | Review with runtime implementer before finalizing |
| Circular type references break compilation | Low | Medium | Use forward declarations, test incrementally |
| Color encoding ambiguity (u32 vs u8x4) | Medium | Low | Document as "TBD Phase B" in types, use union if needed |
| Missing fields discovered in later phases | Medium | Medium | Design review against all 8 design docs before commit |

### Process Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Scope creep (implementing runtime too early) | High | Medium | Strict PR reviews - reject any runtime changes |
| Incomplete type coverage | Medium | High | Systematic verification against design doc 01 |
| Type changes ripple to downstream phases | Low | High | Lock types after design review, use versioning if changes needed |

---

## Success Criteria (Phase A Complete)

### Must Have

- [ ] All types from design doc 01-RendererIR.md defined as TypeScript interfaces
- [ ] `just typecheck` passes with zero errors
- [ ] No runtime code modified (pure types)
- [ ] All types have JSDoc documentation
- [ ] Design doc alignment verification checklist 100% complete

### Should Have

- [ ] Example usage comments in JSDoc showing typical values
- [ ] Type organization clear and logical (grouped by purpose)
- [ ] No TypeScript `any` types used (strict typing throughout)

### Nice to Have

- [ ] Type test file demonstrating type construction (compile-time only)
- [ ] Diagram showing type relationships (RenderFrameIR → passes → buffers)

---

## Testing Strategy

### Type-Level Tests (This Phase)

- **Compilation tests:** `just typecheck` must pass
- **Strict mode:** No `any`, no `@ts-ignore`, no `@ts-expect-error`
- **Type completeness:** All design doc types have corresponding TS interfaces

### Runtime Tests (Deferred to Later Phases)

- **Phase C:** Instances2D materialization and rendering
- **Phase D:** Paths2D geometry buffer construction
- **Phase E:** Cache key computation using IR types
- **Phase F:** Canvas renderer consuming RenderFrameIR

---

## Verification Steps (Before Phase A Sign-Off)

1. **Run full type check:**
   ```bash
   just typecheck
   ```
   Expected: Zero errors, zero warnings

2. **Review design doc alignment:**
   - Open design doc 01-RendererIR.md
   - For each section, verify corresponding types exist and match
   - Check off verification checklist

3. **Code review:**
   - All types are `export type` or `export interface` (no runtime values)
   - JSDoc comments present and accurate
   - No imports of runtime modules
   - File organization clean and logical

4. **Git diff review:**
   - Only new file(s) or additions to existing IR files
   - No modifications to runtime code
   - No test file changes (except optional type tests)

5. **Sign-off:**
   - Lead engineer approval
   - Design doc author approval (if different)
   - Downstream phase leads notified (Phases B, C, D can begin planning)

---

## Rollback Plan

If Phase A needs to be rolled back:

1. **Low Risk:** Pure type definitions, no runtime impact
2. **Rollback Procedure:**
   - Revert commit(s) adding renderIR types
   - Verify `just check` still passes
   - No runtime behavior affected

3. **Why Rollback Might Happen:**
   - Major design doc revision discovered
   - TypeScript compilation issues unfixable without runtime changes
   - Circular dependency issues with existing IR types

---

## Next Phase Preview

**Phase B (Color & Encoding Foundation)** begins after Phase A completion:

- ColorBufferDesc specification (u8x4 linear premul RGBA)
- PathCommandStreamDesc specification (u16, LE)
- Type system split (TypeDesc vs BufferDesc)
- Materialization as scheduled step

**Estimated Start:** After Phase A verification complete (2 sprints from now)
