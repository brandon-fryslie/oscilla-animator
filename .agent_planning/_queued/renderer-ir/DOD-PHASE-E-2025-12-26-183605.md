# Definition of Done: Phase E - IR Rendering Pipeline Final Wiring

**Generated:** 2025-12-26-183605
**Plan:** PLAN-PHASE-E-2025-12-26-183605.md
**Topic:** IR Rendering Pipeline Integration (Final Wiring)
**Sprint Scope:** Instances2D (circles) only

---

## Sprint Deliverables

This sprint delivers:
1. **Updated StepIR type definitions** (separate R,G,B,A slots)
2. **Block lowering with materialization steps** (RenderInstances2D emits StepMaterializeColor)
3. **Real RenderFrameIR assembly** (executeRenderAssemble builds Instances2DPassIR)
4. **PreviewPanel â†’ renderFrame() wiring** (IR mode calls new API)
5. **IRRuntimeAdapter RenderFrameIR output** (pure IR mode working)
6. **End-to-end rendering** (circles visible on canvas)

**Deferred:**
- Paths2D rendering
- Position/radius materialization (stubbed)
- Performance optimizations
- Cache implementation

---

## P0-1: Update schedule.ts with User-Provided StepIR Types

### Acceptance Criteria

- [ ] `schedule.ts` lines 363-441 replaced with user-provided StepIR type definitions
- [ ] `StepMaterializeColor` has fields: `domainSlot`, `colorExprSlot`, `outRSlot`, `outGSlot`, `outBSlot`, `outASlot`, optional `format`
- [ ] `StepMaterializePath` has fields: `domainSlot`, `pathExprSlot`, `outCmdsSlot`, `outParamsSlot`, optional `flattenTolerancePx`
- [ ] `StepRenderAssemble` has fields: `instance2dListSlot`, `pathBatchListSlot`, `outFrameSlot`
- [ ] TypeScript compilation succeeds (existing code using old types will fail - expected, will be fixed in P0-2 and P0-3)

---

## P0-2: Update executeMaterializeColor for New Step Format

### Acceptance Criteria

- [ ] Function signature updated to accept new `StepMaterializeColor` format
- [ ] Reads domain/count from `domainSlot` (handle or number)
- [ ] Reads color field expr from `colorExprSlot`
- [ ] Creates 4 separate Float32Array buffers (one per channel)
- [ ] Writes R channel to `step.outRSlot`
- [ ] Writes G channel to `step.outGSlot`
- [ ] Writes B channel to `step.outBSlot`
- [ ] Writes A channel to `step.outASlot`
- [ ] Handles both signal<color> (single value broadcast) and field<color> (per-instance)
- [ ] Performance counters still emitted (debug logging)
- [ ] Unit test added: signal<color> produces 4 single-value buffers
- [ ] Unit test added: field<color>[10] produces 4 ten-element buffers
- [ ] TypeScript compilation succeeds with no errors

---

## P0-3: Update RenderInstances2D Block Lowering to Emit Materialization Steps

### Acceptance Criteria

- [ ] Block lowering allocates 4 ValueSlots for color channels (R, G, B, A)
- [ ] Creates `StepMaterializeColor` with all required fields from user-provided format
- [ ] Sets `domainSlot` to domain input's value slot
- [ ] Sets `colorExprSlot` to color field input's value slot
- [ ] Sets `outRSlot`, `outGSlot`, `outBSlot`, `outASlot` to allocated slots
- [ ] Step is added to schedule via IRBuilder API
- [ ] Render sink receives metadata with buffer slot references
- [ ] Lowering result declares materialize step(s)
- [ ] TypeScript compilation succeeds
- [ ] Unit test: lowering RenderInstances2D block produces StepMaterializeColor in schedule
- [ ] E2E test: Simple patch with RenderInstances2D compiles without errors

---

## P0-4: Implement Real Instances2DPassIR Assembly in executeRenderAssemble

### Acceptance Criteria

- [ ] Reads `instance2dListSlot` from step to get render sink metadata
- [ ] Extracts buffer slot references from metadata
- [ ] Reads R, G, B, A Float32Array buffers from ValueStore
- [ ] Reads instance count from domain or buffer length
- [ ] Creates `InstanceBufferSetIR` with color buffers as `BufferRefIR`
- [ ] Creates `InstanceMaterialIR` with default circle material
- [ ] Creates `Instances2DPassIR` with header, buffers, material, count
- [ ] Creates `RenderFrameIR` with clear spec and passes array containing the Instances2D pass
- [ ] Writes RenderFrameIR to `step.outFrameSlot`
- [ ] Handles empty/zero-instance case gracefully (empty passes array)
- [ ] Unit test: executeRenderAssemble with valid buffers produces Instances2DPassIR
- [ ] E2E test: Full pipeline from block lowering to RenderFrameIR assembly succeeds

---

## P0-5: Wire PreviewPanel to Call renderFrame() in IR Mode

### Acceptance Criteria

- [ ] Canvas render loop checks `useIR` flag (from store.uiStore.settings.useNewCompiler)
- [ ] In IR mode: extracts RenderFrameIR from IR program/adapter
- [ ] Calls `canvasRenderer.renderFrame(frameIR, valueStore)` with extracted frame
- [ ] Passes ValueStore instance to renderFrame() for buffer reads
- [ ] Falls back to legacy `render()` path when not in IR mode
- [ ] Handles case where RenderFrameIR is not yet available (skip render or show blank)
- [ ] No visual regressions in legacy (non-IR) mode
- [ ] E2E test: IR mode renders circles to canvas successfully
- [ ] Manual test: Toggle IR flag on/off, both modes work

---

## P0-6: Update IRRuntimeAdapter to Output RenderFrameIR in Pure IR Mode

### Acceptance Criteria

- [ ] Adds `getRenderFrameIR(): RenderFrameIR | null` method to IRRuntimeAdapter
- [ ] After `executeFrame()`, reads RenderFrameIR from schedule output slot
- [ ] Stores RenderFrameIR in private field for access by PreviewPanel
- [ ] `getRenderFrameIR()` returns latest RenderFrameIR or null if not available
- [ ] Bridge mode still works (if legacyRenderFn provided)
- [ ] Pure IR mode works (if legacyRenderFn is null/undefined)
- [ ] Unit test: IRRuntimeAdapter with complete schedule produces RenderFrameIR
- [ ] E2E test: PreviewPanel successfully calls getRenderFrameIR() and renders

---

## P1-1: Add E2E Integration Test for IR Rendering Pipeline

### Acceptance Criteria

- [ ] Test file created: `src/editor/compiler/__tests__/ir-rendering-pipeline.e2e.test.ts`
- [ ] Test creates patch with Domain + RenderInstances2D
- [ ] Compiles with IR compiler and verifies CompiledProgramIR structure
- [ ] Verifies schedule contains StepMaterializeColor step
- [ ] Executes schedule and reads RenderFrameIR from output slot
- [ ] Verifies RenderFrameIR.passes[0].kind === 'instances2d'
- [ ] Verifies Instances2DPassIR has valid buffers and instance count
- [ ] Renders to canvas and verifies no errors thrown
- [ ] Test passes reliably (no flakiness)
- [ ] Documented in test file with clear explanation of what's being tested

---

## P1-2: Update Documentation and Add Runtime Verification

### Acceptance Criteria

- [ ] HANDOFF.md (or equivalent) updated with Phase E completion status
- [ ] Inline comments added to RenderInstances2D lowering explaining step emission
- [ ] Inline comments added to executeMaterializeColor explaining new format
- [ ] Inline comments added to executeRenderAssemble explaining assembly logic
- [ ] Debug logging added to each pipeline stage (controllable via flag)
- [ ] executeRenderAssemble validates buffer sizes match instance count
- [ ] Performance counters emitted for materialization time
- [ ] Performance counters emitted for assembly time
- [ ] Console logs clearly indicate IR vs legacy rendering mode

---

## Sprint Success Criteria

### Functional Requirements

- [ ] Simple patch with RenderInstances2D compiles without errors
- [ ] Schedule contains StepMaterializeColor with correct format
- [ ] executeMaterializeColor produces 4 Float32Array buffers
- [ ] executeRenderAssemble produces RenderFrameIR with Instances2DPassIR
- [ ] PreviewPanel renders circles to canvas using renderFrame()
- [ ] Circles are visible with correct colors
- [ ] No console errors during rendering

### Technical Requirements

- [ ] All P0 items completed and tested
- [ ] TypeScript compilation succeeds with no errors
- [ ] Existing tests pass (no regressions)
- [ ] E2E test added and passing
- [ ] Documentation updated

### Quality Requirements

- [ ] Code reviewed by at least one other developer
- [ ] Manual testing shows circles render correctly
- [ ] Performance acceptable (60fps for 100 circles)
- [ ] No memory leaks detected

### Deliverables

- [ ] PLAN-PHASE-E-2025-12-26-183605.md (this file's companion)
- [ ] DOD-PHASE-E-2025-12-26-183605.md (this file)
- [ ] Working code changes across 6+ files
- [ ] E2E test suite
- [ ] Updated documentation

---

## Definition of Done - READY FOR IMPLEMENTATION

This sprint is **READY FOR IMPLEMENTATION** when:

1. All P0 acceptance criteria are met
2. At least one E2E test passes showing end-to-end rendering
3. Manual testing confirms circles render correctly in IR mode
4. No regressions in legacy mode
5. Documentation is updated

**Minimum Viable Deliverable:**
- Circles render to canvas via IR path with correct colors
- All P0 work items complete
- One passing E2E test

**Complete Deliverable:**
- All of the above, plus P1-1 and P1-2 complete
- Performance metrics collected
- Debug logging in place
