# Sprint Plan: Modulation Table UI Improvements
Generated: 2024-12-24

## Sprint Goal
Fix the critical listener panel bug and implement UX improvements for a more intuitive modulation table experience.

## Scope

**In scope (this sprint):**
1. P0: Fix listener panel not showing blocks (critical bug)
2. P1: Sections expanded by default, block groups collapsed
3. P2: Header-click collapse (remove arrow buttons)
4. P3: Rainbow emoji for color/palette column
5. P4: Compatible-only default + adapter chain support with visual indicators
6. P5: Styled JavaScript tooltips (Tippy.js)
7. P6: Remove subcategory prefix from block names
8. P7: Per-column bound/available counts in group headers

**Explicitly out of scope (future sprints):**
- Heavy adapter confirmation dialog UX
- Tooltip content improvements beyond basic styling
- Additional bus column customization
- Drag-and-drop reordering of sections

---

## Work Items

### P0: Fix Listener Panel Bug + Ensure All Blocks Visible
**Priority:** CRITICAL - blocks all other work

**Root Cause:** `getRowGroupsByDirection('input')` filters for `'listeners:'` prefix but input rows use `blockDef.subcategory` as prefix, causing mismatched filtering.

**Clarified Requirement:**
- ALL blocks in the patch with bus-eligible ports MUST appear in the table
- Blocks with bus-eligible INPUT ports â†’ appear in Listeners section
- Blocks with bus-eligible OUTPUT ports â†’ appear in Publishers section
- Many blocks will appear on BOTH sides (e.g., a block with both inputs and outputs)
- NO filtering by arbitrary categories - every block with any bus-eligible port shows up
- If a block exists in the patch but has NO bus-eligible ports at all, log an error to the diagnostic system (this is an unexpected condition)

**Implementation:**
1. In `ModulationTableStore.ts` line 191, change input row grouping:
   ```typescript
   // FROM:
   const groupKey = createGroupKey(blockDef.subcategory ?? 'Other', block.id);
   // TO:
   const groupKey = createGroupKey('listeners', block.id);
   ```

2. Verify output row grouping (line 168) uses `'publishers'` prefix (already correct)

3. Add diagnostic logging: After iterating blocks, if a block has zero bus-eligible ports (neither input nor output), log a warning/error to the diagnostic system

4. Remove any other filtering logic that might exclude blocks from appearing

**Acceptance Criteria:**
- [ ] Listener panel shows ALL blocks that have at least one bus-eligible input port
- [ ] Publisher panel shows ALL blocks that have at least one bus-eligible output port
- [ ] Blocks with both inputs and outputs appear on BOTH sides
- [ ] No filtering by subcategory, block type, or any other arbitrary criteria
- [ ] If a block in patch has no bus-eligible ports, error is logged to diagnostics
- [ ] No console errors related to missing groups

---

### P1: Section Collapse Defaults
**Priority:** High

**Implementation:**
1. In `types.ts` `createDefaultViewState()` (line 406-407), change:
   ```typescript
   publishersSectionCollapsed: false,
   listenersSectionCollapsed: false,
   ```

2. Ensure `collapseAllGroups()` is still called on mount (line 452-454 in ModulationTable.tsx) to collapse block groups.

**Acceptance Criteria:**
- [ ] On load, both Listeners and Publishers sections are visible/expanded
- [ ] Individual block groups (e.g., "Time", "Grid Domain") start collapsed
- [ ] User can still collapse sections manually

---

### P2: Header-Click Collapse UX
**Priority:** Medium

**Implementation:**
1. Remove `.section-collapse-btn` elements from `ModulationTable.tsx`
2. Make the entire `.section-table-header` clickable to toggle collapse
3. Update CSS to indicate clickability (cursor, hover state)
4. Remove lines 638-640 and 682-684 (the `â—‚`/`â–¸` buttons)

**Acceptance Criteria:**
- [ ] No arrow button visible in section headers
- [ ] Clicking "â†“ LISTENERS bus â†’ input" header collapses the section
- [ ] Clicking "â†‘ PUBLISHERS output â†’ bus" header collapses the section
- [ ] Cursor shows pointer on header hover

---

### P3: Rainbow Emoji for Color Column
**Priority:** Low

**Implementation:**
1. In `types.ts` line 424, change:
   ```typescript
   'palette': 'ðŸŒˆ',
   ```

**Acceptance Criteria:**
- [ ] Color/palette bus column shows rainbow emoji (ðŸŒˆ) instead of black square (â– )

---

### P4: Compatible-Only + Adapter Chain Support
**Priority:** High

**Implementation:**

1. Change default in `types.ts` line 404:
   ```typescript
   showOnlyCompatibleColumnsForFocusedRow: true,
   ```

2. Update `visibleColumns` filter (line 372-378) to include adapter-compatible:
   ```typescript
   if (showOnlyCompatibleColumnsForFocusedRow && this.viewState.focusedCell) {
     const row = this.rows.find((r) => r.key === this.viewState.focusedCell?.rowKey);
     if (row) {
       columns = columns.filter((c) =>
         this.isTypeCompatible(c.type, row.type) ||
         this.isTypeConvertible(c.type, row.type)
       );
     }
   }
   ```

3. Update cell rendering to show cost indicators:
   - Green dot (`â€¢`): Direct compatibility or cheap adapter
   - Yellow warning triangle (`âš `): Medium cost adapter
   - Orange/red indicator: Heavy adapter (requires confirmation)

4. In `TableCellComponent`, add cost-based indicators for `convertible` status cells.

**Acceptance Criteria:**
- [ ] Compatible-only checkbox is checked by default
- [ ] Adapter-chain-compatible columns are shown when focused
- [ ] Cheap adapters show green indicator, behave like direct binding
- [ ] Medium adapters show yellow triangle indicator
- [ ] Heavy adapters show distinct scary indicator

---

### P5: Styled JavaScript Tooltips
**Priority:** Medium

**Implementation:**

1. Install Tippy.js:
   ```bash
   pnpm add @tippyjs/react tippy.js
   ```

2. Create tooltip wrapper component or use Tippy directly
3. Replace `title` attributes with Tippy tooltips in:
   - Cell status tooltips
   - Column header tooltips
   - Row header tooltips
   - Group header tooltips

4. Configure dark theme styling to match app

**Acceptance Criteria:**
- [ ] Tooltips appear as styled overlays, not browser default
- [ ] Tooltips match dark theme of app
- [ ] Cell hover shows status/lens chain info in styled tooltip
- [ ] Column/row headers show type info in styled tooltip

---

### P6: Remove Block Name Prefix
**Priority:** Low

**Implementation:**
1. In `ModulationTableStore.ts` line 235, change:
   ```typescript
   // FROM:
   label: `${blockDef.subcategory ?? 'Other'}: ${block.label}`
   // TO:
   label: block.label
   ```

**Acceptance Criteria:**
- [ ] Block groups show just "Time", "Grid Domain", "Render" instead of "TimeRoot: Time", "Other: Grid Domain", "Render: Render"

---

### P7: Per-Column Bound/Available Counts
**Priority:** Medium

**Implementation:**

1. Replace "(x ports)" with per-column counts
2. Create helper function to compute bound/available counts per column for a group
3. Update `GroupHeaderRow` to show counts per column
4. Format: `(bound,available)` in parentheses with dark gray color
   - Green number for bound
   - Yellow number for available (compatible but not bound)
   - Empty if both are 0

**Example:** "Time: (1,1) (0,0) (1,2) (1,2) (3) (1)"

**Acceptance Criteria:**
- [ ] Group header shows per-column counts instead of total port count
- [ ] Bound count appears in green
- [ ] Available count appears in yellow
- [ ] Empty cells show nothing (not "0")
- [ ] Parentheses are dark gray

---

## Dependencies
- P0 must be completed first (blocks testing of other features)
- P5 (tooltips) can be done in parallel with other items
- P4 depends on existing adapter system

## Risks
- Tippy.js bundle size (~10KB gzipped) - acceptable
- Cost threshold tuning may need iteration
- Per-column counts computation could be expensive for large patches (mitigate with memoization)
