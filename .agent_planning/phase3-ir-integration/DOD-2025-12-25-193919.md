# Definition of Done: Phase 3 Bridge Compiler - Sprint 1

**Generated:** 2025-12-25-193919
**Plan:** PLAN-2025-12-25-193919.md
**Scope:** Core Compilation Passes (Pass 2, 3, 4-5)

---

## Sprint Scope

This sprint delivers:
1. **Pass 2 (Type Graph)** - SlotType → TypeDesc conversion, bus eligibility validation, conversion path computation
2. **Pass 3 (Time Topology)** - TimeRoot discovery, TimeModel generation, canonical time signals
3. **Pass 4-5 (Dependency Graph & SCC)** - Unified dep graph, cycle validation with state boundaries

Deferred to Sprint 2:
- Pass 6-8 (Block lowering, bus lowering, linking)
- Dual-emit compiler modification
- IR validator
- Block compiler contract changes

---

## Acceptance Criteria

### Pass 2: Type Graph Construction

- [ ] File `src/editor/compiler/passes/pass2-types.ts` exists and exports `pass2TypeGraph()`
- [ ] Function signature: `pass2TypeGraph(normalized: NormalizedPatch): TypedPatch`
- [ ] SlotType → TypeDesc conversion implemented with regex pattern matching
- [ ] Bus eligibility validation rejects non-scalar Field types
- [ ] Reserved bus validation enforces phaseA/pulse/energy/palette constraints
- [ ] Conversion path precomputation uses adapter/lens registry
- [ ] Errors emitted with context: `PortTypeUnknown`, `BusIneligibleType`, `ReservedBusTypeViolation`, `NoConversionPath`
- [ ] Test file `src/editor/compiler/passes/__tests__/pass2-types.test.ts` with minimum 12 tests
- [ ] TypedPatch includes `busTypes: Map<string, TypeDesc>` and `conversionPaths: Map<Connection, string[]>`
- [ ] All Pass 2 tests passing (12+)

### Pass 3: Time Topology Inference

- [ ] File `src/editor/compiler/passes/pass3-time.ts` exists and exports `pass3TimeTopology()`
- [ ] Function signature: `pass3TimeTopology(typed: TypedPatch): TimeResolvedPatch`
- [ ] Single TimeRoot discovery finds blocks with `capability === 'time'`
- [ ] Validation errors for zero or multiple TimeRoots
- [ ] Canonical time signals generated using IRBuilder: `tAbsMs`, `tModelMs`, `phase01`, `wrapEvent`
- [ ] TimeModelIR record extracted from TimeRoot params (finite/cyclic/infinite)
- [ ] TimeResolvedPatch includes `timeModel`, `timeRootIndex`, `timeSignals`
- [ ] Errors emitted with context: `MissingTimeRoot`, `MultipleTimeRoots`, `TimeRootViolation`
- [ ] Test file `src/editor/compiler/passes/__tests__/pass3-time.test.ts` with minimum 10 tests
- [ ] Tests cover all three TimeModel kinds: finite, cyclic, infinite
- [ ] All Pass 3 tests passing (10+)

### Pass 4: Dependency Graph Construction

- [ ] File `src/editor/compiler/passes/pass4-depgraph.ts` exists and exports `pass4DepGraph()`
- [ ] Function signature: `pass4DepGraph(timeResolved: TimeResolvedPatch): DepGraph`
- [ ] BlockEval nodes created for all blocks
- [ ] BusValue nodes created for all buses
- [ ] Wire edges connect BlockEval → BlockEval
- [ ] Publisher edges connect BlockEval → BusValue
- [ ] Listener edges connect BusValue → BlockEval
- [ ] DepGraph structure matches `ir/patches.ts` types: `{ nodes, edges }`
- [ ] Errors emitted with context: `DanglingConnection`, `DanglingBindingEndpoint`
- [ ] Test file `src/editor/compiler/passes/__tests__/pass4-depgraph.test.ts` with minimum 8 tests
- [ ] All Pass 4 tests passing (8+)

### Pass 5: Cycle Validation (SCC)

- [ ] File `src/editor/compiler/passes/pass5-scc.ts` exists and exports `pass5CycleValidation()`
- [ ] Function signature: `pass5CycleValidation(depGraph: DepGraph): AcyclicOrLegalGraph`
- [ ] Tarjan's SCC algorithm implemented (or Kosaraju as fallback)
- [ ] Trivial SCCs skipped: size==1 and no self-loop
- [ ] Non-trivial SCCs validated for state boundary: `capability === 'state'` AND `breaksCombinatorialCycle === true`
- [ ] AcyclicOrLegalGraph includes `{ graph, sccs, errors }`
- [ ] Errors emitted with context: `IllegalCycle`, `CycleWithoutStateBoundary`
- [ ] Test file `src/editor/compiler/passes/__tests__/pass5-scc.test.ts` with minimum 12 tests
- [ ] Tests cover trivial SCCs, self-loops, legal/illegal cycles
- [ ] All Pass 5 tests passing (12+)

### Pipeline Integration

- [ ] File `src/editor/compiler/passes/__tests__/pipeline-integration.test.ts` exists
- [ ] Integration test runs Pass 1 → Pass 2 → Pass 3 → Pass 4 → Pass 5 on minimal patch
- [ ] Integration test runs full pipeline on golden patch ("Breathing Constellation")
- [ ] Test validates AcyclicOrLegalGraph structure is well-formed
- [ ] Test validates TimeResolvedPatch has valid TimeModel and TimeSignals
- [ ] Test validates TypedPatch has conversion paths where needed
- [ ] Test confirms no errors for well-formed patches
- [ ] Test confirms errors for malformed patches (missing TimeRoot, illegal cycle, type mismatch)

### Error Handling Tests

- [ ] Pass 2 error tests cover all 4 error types: `PortTypeUnknown`, `BusIneligibleType`, `ReservedBusTypeViolation`, `NoConversionPath`
- [ ] Pass 3 error tests cover all 3 error types: `MissingTimeRoot`, `MultipleTimeRoots`, `TimeRootViolation`
- [ ] Pass 4 error tests cover all 2 error types: `DanglingConnection`, `DanglingBindingEndpoint`
- [ ] Pass 5 error tests cover all 2 error types: `IllegalCycle`, `CycleWithoutStateBoundary`
- [ ] All error messages include context (block IDs, slot IDs, bus IDs)

### Documentation

- [ ] File `design-docs/12-Compiler-Final/TypeDesc-Unification.md` exists
- [ ] Document explains editor TypeDesc vs IR TypeDesc relationship
- [ ] Document specifies how `busEligible` is computed from `world` + `domain`
- [ ] Utility function `isBusEligible(type: TypeDesc): boolean` added to `ir/types.ts`
- [ ] Utility function tested in `ir/__tests__/types.test.ts`

### Regression Prevention

- [ ] All existing IRBuilder tests still passing (24 tests)
- [ ] All existing Pass 1 tests still passing (14 tests)
- [ ] TypeScript compilation succeeds with no errors
- [ ] No breaking changes to existing APIs

---

## Test Coverage Requirements

**Minimum test count:** 42+ new tests

Breakdown:
- Pass 2: 12 tests (implementation + errors)
- Pass 3: 10 tests (implementation + errors)
- Pass 4: 8 tests (implementation + errors)
- Pass 5: 12 tests (implementation + cycles)
- Integration: 2+ tests (minimal + golden)

**Total project tests after Sprint 1:** 80+ tests (38 existing + 42 new)

---

## Non-Functional Requirements

### Code Quality
- [ ] All new code follows existing patterns (see `pass1-normalize.ts`)
- [ ] All functions have TSDoc comments
- [ ] All complex algorithms have inline comments explaining logic
- [ ] No `any` types used (use proper TypeScript types)
- [ ] No `eslint-disable` comments (fix linting errors properly)

### Performance
- [ ] Pass 1-5 pipeline completes in < 100ms for golden patch
- [ ] SCC algorithm is O(V+E) time complexity (Tarjan or Kosaraju)
- [ ] No unnecessary map/array allocations in hot paths

### Maintainability
- [ ] Each pass is in a separate file
- [ ] Test files mirror implementation files
- [ ] Error types are defined with clear naming
- [ ] No duplicate code between passes (extract shared utilities)

---

## Verification Checklist

Run these commands to verify completion:

```bash
# Run all new tests
pnpm vitest run src/editor/compiler/passes/__tests__/

# Run full test suite
pnpm test

# Type check
pnpm typecheck

# Lint
pnpm lint

# Full check
just check
```

Expected results:
- ✅ All tests passing (80+ total)
- ✅ No TypeScript errors
- ✅ No linting errors
- ✅ Build succeeds

---

## Ready for Sprint 2 When...

- [ ] All acceptance criteria above are met
- [ ] All tests are passing
- [ ] Documentation is updated
- [ ] Code review feedback addressed (if applicable)
- [ ] No known blockers for dual-emit compiler work

Sprint 2 will modify `compileBusAware.ts` to call Passes 1-5 and emit both closures and IR. The foundation built in Sprint 1 makes this possible.
