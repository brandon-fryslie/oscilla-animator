Agent: iterative-implementer | 2026-01-01-08:08:00
Mode: manual
Completed: Fix test failures from Bus-Block Unification | Files: 12 | Commits: 1
Cache: N/A (no eval cache invalidation needed - only test fixes)
Status: in_progress

## Summary

Fixed majority of test failures caused by default BusBlocks being created in RootStore constructor.

### Problem

Bus-Block Unification Sprint 3 introduced 6 default BusBlocks created at initialization, which broke tests:
1. Tests checking `blocks.length` expected 0 but got 6
2. History started at revision 6 instead of revision 0
3. ~52 tests failing across multiple test suites

### Solution Implemented

1. **PatchStore.userBlocks** - Added computed getter that filters out hidden blocks (BusBlocks)
   - Returns only user-visible blocks
   - Used by tests to get accurate counts

2. **HistoryStore.reset()** - Added method to clear history back to revision 0
   - Clears all revisions
   - Resets currentRevisionId to 0
   - Resets nextRevisionId to 1

3. **RootStore history reset** - Call historyStore.reset() after creating default buses in:
   - Constructor (line 140-144)
   - loadPatch (line 350-351)
   - clearPatch (line 410-411)

4. **Test fixes** - Updated integration.test.ts to use userBlocks.length instead of blocks.length

5. **Type compatibility** - Restored deprecated lensStack/adapterChain fields to Edge/Publisher/Listener/Connection
   - These were removed in commit 42c45de but are still used by code
   - Marked as @deprecated for future cleanup

### Results

- integration.test.ts: 21/21 tests passing (was 4 failing)
- Overall: 52 failures → 43 failures  
- Remaining failures mostly in other test files that need blocks.length → userBlocks.length updates

### Next Steps

To complete test fixes:
1. Update HistoryStore.test.ts to use userBlocks.length
2. Update TxBuilder.test.ts to use userBlocks.length  
3. Update BusStore.events.test.ts to account for default buses
4. Update composite tests to account for default buses
5. Fix edge migration tests (different issue - may need transforms field support)
