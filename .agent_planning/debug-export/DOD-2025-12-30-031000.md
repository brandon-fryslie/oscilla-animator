# Definition of Done: Debug + Export Workstream

**Generated**: 2025-12-30-031000
**Plan**: PLAN-2025-12-30-031000.md
**Source**: STATUS-2025-12-30-030600.md
**Scope**: Workstream 7 - Debug + Export

---

## Sprint 1: Foundation - DebugDisplay IR + Determinism

**Sprint Scope**: This sprint delivers 3 critical foundation features that unblock all subsequent work:
1. DebugDisplay IR lowering (unblocks IR debugging)
2. Deterministic replay verification (prerequisite for export)
3. DebugProbe UI connection (complete debug flow)

**Deferred**: None - all items are critical path

### Deliverable 1.1: DebugDisplay IR Lowering

- [ ] `lowerDebugDisplay()` emits StepDebugProbe for each connected input (signal/phase/domain/field)
- [ ] Probe IDs assigned as `${instanceId}:${portId}` pattern
- [ ] StepDebugProbe.mode set to "value" for real-time display
- [ ] Test: Patch with Sine → DebugDisplay compiles to IR without error
- [ ] Test: executeDebugProbe receives correct slot references from lowered DebugDisplay
- [ ] TypeScript compiles without errors

### Deliverable 1.2: Deterministic Replay Verification

- [ ] All runtime Math.random() usage replaced with seeded PRNG (core/rand.ts)
- [ ] controlSurface/store.ts uses explicit seed parameter instead of Math.random()
- [ ] Test: Same patch + seed → bit-identical frame output (100 frames)
- [ ] Test: Different seeds → different output (verify PRNG works)
- [ ] Documentation: Add comment explaining why compile-time Math.random() is OK

### Deliverable 1.3: Connect DebugProbe to UI

- [ ] ProbeCard reads values from TraceController.getProbeValues(probeId)
- [ ] ProbeCard displays signal values from IR-compiled patches
- [ ] ProbeCard displays field samples (first 5 values) from IR-compiled patches
- [ ] Toggle in DebugHUD to enable/disable specific probes
- [ ] Test: End-to-end flow: Sine → DebugDisplay (IR) → TraceController → ProbeCard UI
- [ ] Legacy DebugStore path continues to work (backward compatibility)

---

## Sprint 2: Image Sequence Export

**Sprint Scope**: This sprint delivers complete image sequence export:
1. ImageSequenceExporter class (PNG/WebP export)
2. Export UI with controls and progress
3. Comprehensive export tests

**Deferred**: Video/GIF formats (Sprint 4, 6)

### Deliverable 2.1: ImageSequenceExporter Class

- [ ] ImageSequenceExporter class exports frames as PNG blobs
- [ ] Supports custom resolution (width, height independent of viewport)
- [ ] Supports frame range (start frame, end frame, step)
- [ ] Supports format selection (PNG, WebP, JPEG with quality)
- [ ] Progress callback fires on each frame with (current, total, percentage)
- [ ] Cancellation support (cancel() method aborts export)
- [ ] Test: Export 60 frames at 1920x1080 produces 60 blobs
- [ ] Test: Export with step=2 produces half the frames
- [ ] Test: Cancellation stops export mid-sequence

### Deliverable 2.2: Export UI and Controls

- [ ] Export dialog accessible from File menu → "Export Image Sequence..."
- [ ] Controls: Resolution (width, height), Frame Range (start, end, step), Format (PNG/WebP/JPEG)
- [ ] Quality slider for JPEG/WebP (0-100)
- [ ] Progress bar shows export percentage
- [ ] Cancel button stops export mid-sequence
- [ ] Download button triggers file save (File System Access API or blob download)
- [ ] Test: User can export 30 frames at 720p as PNG
- [ ] Test: Cancel button stops export and cleans up resources

### Deliverable 2.3: Image Export Tests

- [ ] Test: Export 60 frames at 60fps produces 60 blobs (frame count validation)
- [ ] Test: Same seed produces bit-identical PNG bytes (determinism)
- [ ] Test: Different seeds produce different PNG bytes (PRNG validation)
- [ ] Test: Custom resolution (1920x1080) produces correct blob dimensions
- [ ] Test: Invalid frame range (start > end) throws error
- [ ] Test: Export with no frames (empty patch) handles gracefully
- [ ] Test: Cancellation cleans up OffscreenCanvas resources

---

## Sprint 3: Signal History Visualization

**Sprint Scope**: This sprint delivers real-time waveform visualization:
1. SignalHistoryBuffer (ring buffer for time-series)
2. SignalGraph component (canvas waveform)
3. Integration with debug UI

**Deferred**: Multi-signal overlay, zoom/pan controls (future enhancement)

### Deliverable 3.1: SignalHistoryBuffer

- [ ] SignalHistoryBuffer class stores time-series data (t, value) pairs
- [ ] Ring buffer with configurable size (default 1000 samples)
- [ ] Auto-scaling: track min/max for display bounds
- [ ] Sample rate management (assume 60fps, handle variable rates)
- [ ] addSample(t, value) method writes to buffer
- [ ] getSamples(count) returns most recent N samples
- [ ] Test: Buffer wraps correctly at capacity (sample 1001 overwrites sample 1)
- [ ] Test: Auto-scaling updates min/max on new extremes
- [ ] Test: getSamples(100) returns correct data

### Deliverable 3.2: SignalGraph Component

- [ ] SignalGraph component renders waveform on canvas
- [ ] X-axis: time (seconds), Y-axis: value (auto-scaled)
- [ ] Grid rendering with time divisions (1s, 0.5s, 0.1s based on zoom)
- [ ] Crosshair on hover showing (t, value)
- [ ] Auto-scaling adjusts Y-axis bounds to fit min/max
- [ ] Test: Renders Sine wave as smooth curve
- [ ] Test: Auto-scaling updates when new extremes added
- [ ] Test: Grid divisions adjust based on time range

### Deliverable 3.3: Integration with Debug UI

- [ ] SignalGraph tab in DebugDrawer shows all probed signals
- [ ] ProbeCard enhanced with "Show History" toggle
- [ ] TraceController.recordProbe() writes to SignalHistoryBuffer
- [ ] Graph updates in real-time as player advances
- [ ] Test: End-to-end flow: Sine → DebugDisplay → TraceController → SignalGraph
- [ ] Test: Multiple signals displayed in separate graphs or overlaid

---

## Sprint 4: Video Export

**Sprint Scope**: This sprint delivers video export with WebCodecs:
1. VideoEncoder integration (H.264/VP9)
2. Muxer integration (MP4/WebM containers)
3. Video export UI and tests

**Deferred**: Audio export, AV1 codec (browser support limited)

### Deliverable 4.1: WebCodecs VideoEncoder Integration

- [ ] VideoExporter class uses WebCodecs VideoEncoder API
- [ ] H.264 codec support (baseline profile, level 4.0)
- [ ] VP9 codec support (fallback if H.264 not available)
- [ ] Browser support detection with graceful fallback to image sequence
- [ ] Bitrate configuration (default: 5 Mbps for 1080p)
- [ ] Quality configuration (CRF or constant bitrate mode)
- [ ] Test: Encode 60 frames to H.264 produces valid encoded chunks
- [ ] Test: Browser without WebCodecs falls back to image sequence
- [ ] Test: Codec config validation (invalid bitrate throws error)

### Deliverable 4.2: Muxer Integration (MP4/WebM)

- [ ] Muxer library integrated (mp4-muxer or MP4Box.js)
- [ ] MP4 container support for H.264 codec
- [ ] WebM container support for VP9 codec
- [ ] Muxer receives EncodedVideoChunk from VideoEncoder
- [ ] Final output: complete MP4/WebM blob ready for download
- [ ] Test: 60 encoded chunks → valid MP4 file (playable in browser)
- [ ] Test: WebM muxing for VP9 codec
- [ ] Test: Invalid chunks (corrupted data) handled gracefully

### Deliverable 4.3: Video Export UI and Tests

- [ ] Export dialog includes "Export Video" option
- [ ] Codec selector: H.264 (default), VP9 (advanced)
- [ ] Bitrate slider (1-20 Mbps, default 5 Mbps)
- [ ] Quality mode: Constant Bitrate or CRF (if supported)
- [ ] Progress bar shows encoding progress
- [ ] Download button saves MP4/WebM file
- [ ] Test: Export 30 frames at 1080p H.264 produces playable MP4
- [ ] Test: VP9 export produces playable WebM
- [ ] Test: Unsupported codec shows error message

---

## Sprint 5: Field Visualization

**Sprint Scope**: This sprint delivers visual field inspection:
1. FieldStats computation (min/max/mean/stdDev)
2. FieldHeatmap component (colormap grid)
3. Mode selector (text/heatmap/histogram)

**Deferred**: Scatter plot mode, 3D visualization (future enhancement)

### Deliverable 5.1: FieldStats Computation

- [ ] computeFieldStats(fieldValues: Float32Array) returns { min, max, mean, stdDev }
- [ ] Handles empty fields gracefully (returns zero stats)
- [ ] Handles NaN/Inf values (filter or report)
- [ ] Efficient for large fields (1000+ elements)
- [ ] Test: Known distribution (0-1 uniform) produces correct stats
- [ ] Test: NaN values filtered or reported in stats
- [ ] Test: Large field (10000 elements) computes in <10ms

### Deliverable 5.2: FieldHeatmap Component

- [ ] FieldHeatmap component renders field values as colored grid
- [ ] Colormap integration (use existing colormapLookup utilities)
- [ ] Grid dimensions: auto-detect or configurable (e.g., 10x10 for 100 elements)
- [ ] Color scaling based on field min/max (auto or manual)
- [ ] Hover shows (index, value) tooltip
- [ ] Test: 100-element field renders as 10x10 grid
- [ ] Test: Colormap maps min→blue, max→red correctly
- [ ] Test: Hover tooltip displays correct value

### Deliverable 5.3: Mode Selector and Integration

- [ ] ProbeCard has mode selector for field probes (text/heatmap/histogram)
- [ ] Text mode: show first 5 values (existing behavior)
- [ ] Heatmap mode: show FieldHeatmap component
- [ ] Histogram mode: show distribution histogram (bins + counts)
- [ ] Mode persists per probe (localStorage or DebugStore)
- [ ] Test: Switch between modes updates display
- [ ] Test: Mode preference persists across page reload

---

## Sprint 6: GIF Export

**Sprint Scope**: This sprint delivers animated GIF export:
1. GIF library integration (gif.js)
2. Palette optimization and dithering
3. GIF export UI

**Deferred**: Custom palette editor, advanced compression (future enhancement)

### Deliverable 6.1: GIF Library Integration

- [ ] GIF library integrated (gif.js or modern-gif)
- [ ] GifExporter class renders frames to GIF
- [ ] Web Worker encoding (off main thread)
- [ ] Frame delay configuration (ms per frame, based on fps)
- [ ] Loop configuration (infinite or N iterations)
- [ ] Test: 30 frames at 30fps produces looping GIF
- [ ] Test: Worker encoding doesn't block main thread
- [ ] Test: Frame delay matches configured fps

### Deliverable 6.2: Palette Optimization and Dithering

- [ ] Palette optimization: analyze frames to build optimal 256-color palette
- [ ] Dithering modes: None, Floyd-Steinberg, Ordered
- [ ] Quality slider: controls palette size (16-256 colors)
- [ ] Test: Palette optimization reduces file size vs default palette
- [ ] Test: Dithering improves gradient quality
- [ ] Test: Quality slider affects color count in output

### Deliverable 6.3: GIF Export UI

- [ ] Export dialog includes "Export GIF" option
- [ ] Quality slider (16-256 colors, default 128)
- [ ] Dithering selector: None, Floyd-Steinberg, Ordered
- [ ] Loop mode: Infinite or N iterations
- [ ] FPS selector (10, 15, 24, 30, 60)
- [ ] Progress bar shows encoding progress
- [ ] Test: Export 15 frames at 15fps produces looping GIF
- [ ] Test: Quality slider affects output file size

---

## Sprint 7: Standalone Player Export

**Sprint Scope**: This sprint delivers self-contained HTML export:
1. HTML template generation
2. Runtime bundling (inline or CDN)
3. IR serialization

**Deferred**: Audio export, custom controls editor (future enhancement)

### Deliverable 7.1: HTML Template Generation

- [ ] StandaloneExporter generates self-contained HTML file
- [ ] HTML includes: runtime bundle, IR program, canvas rendering
- [ ] Playback controls: play/pause, scrub, loop toggle
- [ ] Responsive canvas (fits viewport)
- [ ] No external dependencies (all code inlined or CDN)
- [ ] Test: Generated HTML opens in browser and plays animation
- [ ] Test: HTML works offline (no network requests after load)
- [ ] Test: Playback controls functional (play/pause/scrub)

### Deliverable 7.2: Runtime Bundling Strategy

- [ ] Runtime bundle includes: ScheduleExecutor, Canvas2DRenderer, ValueStore, type definitions
- [ ] Bundle size optimized (<100KB minified+gzipped)
- [ ] Two modes: Inline (embed in HTML) or CDN (link to hosted bundle)
- [ ] Tree-shaking removes unused runtime code
- [ ] Test: Bundle includes all necessary runtime code
- [ ] Test: Inline mode embeds bundle in HTML
- [ ] Test: CDN mode links to external bundle URL

### Deliverable 7.3: IR Serialization and Export UI

- [ ] IR program serializes to JSON (Schedule, RenderFrameIR, metadata)
- [ ] Serialized IR includes all necessary data: slots, steps, passes, specs
- [ ] Deserialization in standalone player reconstructs runtime state
- [ ] Export dialog includes "Export Standalone Player" option
- [ ] Configuration: Inline or CDN mode, playback controls on/off
- [ ] Test: Serialized IR deserializes correctly in player
- [ ] Test: Export produces working standalone HTML

---

## Sprint 8: Runtime State Inspector

**Sprint Scope**: This sprint delivers deep debugging tools:
1. Runtime snapshot capture
2. RuntimeStateTree UI component
3. Inspector integration with DebugDrawer

**Deferred**: Snapshot diff, time-travel debugging (future enhancement)

### Deliverable 8.1: Runtime Snapshot Capture

- [ ] captureRuntimeSnapshot(runtime) returns snapshot object
- [ ] Snapshot includes: all ValueStore slots, StateBuffer state, metadata
- [ ] Slot metadata: type, value, source (which block allocated)
- [ ] StateBuffer metadata: operation state (e.g., integrator accumulator)
- [ ] Snapshot is serializable (JSON-compatible)
- [ ] Test: Snapshot captures all 100 slots in test runtime
- [ ] Test: Snapshot includes correct type metadata
- [ ] Test: Snapshot serializes to JSON without loss

### Deliverable 8.2: RuntimeStateTree UI Component

- [ ] RuntimeStateTree component displays snapshot as expandable tree
- [ ] Tree nodes: ValueStore → Slots → Slot details
- [ ] Tree nodes: StateBuffer → Operations → State values
- [ ] Slot details: index, type, value, source block
- [ ] Search/filter slots by name or block ID
- [ ] Test: Tree expands/collapses nodes correctly
- [ ] Test: Search filters slots by name
- [ ] Test: Slot details display correct metadata

### Deliverable 8.3: Inspector Integration and Testing

- [ ] "Runtime State" tab in DebugDrawer
- [ ] "Capture Snapshot" button triggers captureRuntimeSnapshot()
- [ ] RuntimeStateTree displays captured snapshot
- [ ] Snapshot updates on each capture (not automatic)
- [ ] Test: End-to-end: compile patch → execute → capture → display
- [ ] Test: Snapshot shows correct slot values from simple patch
- [ ] Test: State buffer values display correctly

---

## Overall Workstream Definition of Done

**The Debug + Export workstream is complete when:**

### Debug Capabilities
- [ ] DebugDisplay works in both IR and legacy modes
- [ ] ProbeCard displays values from IR-compiled patches
- [ ] Signal history visualization shows waveforms in real-time
- [ ] Field visualization includes text, heatmap, and histogram modes
- [ ] Runtime state inspector captures and displays ValueStore/StateBuffer

### Export Capabilities
- [ ] Image sequence export produces PNG/WebP/JPEG files
- [ ] Video export produces playable MP4 (H.264) and WebM (VP9) files
- [ ] GIF export produces optimized animated GIFs with dithering
- [ ] Standalone player export generates self-contained HTML

### Quality Requirements
- [ ] Deterministic replay verified (same seed → identical output)
- [ ] All 8 sprints pass acceptance criteria (170+ criteria total)
- [ ] Test coverage >80% for new code (unit + integration tests)
- [ ] No regressions in existing features (2425+ tests still passing)
- [ ] TypeScript compiles without errors
- [ ] Performance targets met (export, encoding, field stats)

### Documentation Requirements
- [ ] Export UI includes tooltips and help text
- [ ] Error messages are clear and actionable
- [ ] Code comments explain non-obvious decisions
- [ ] README updated with export feature documentation

---

**Total Acceptance Criteria**: 170+ across 24 deliverables in 8 sprints

**End of Definition of Done**
