# Definition of Done: UI Prep Refactor - Foundation Sprint
Generated: 2025-12-27-030440
Plan: PLAN-2025-12-27-030440.md
Source: STATUS-2025-12-27-030500.md

---

## Sprint Scope

**This sprint delivers:**
1. Stabilized test suite (79 failures → 0)
2. Complete kernel Op application layer (all 26 Op types)
3. PatchStore wired to kernel transactions

**Deferred to future sprints:**
- TimeRoot auto-publish to canonical buses
- Layout separation (lanes → ViewState)
- Validator integration with UI
- Query API, state preservation, undo/redo
- Performance tracking, lens/adapter completion

---

## Acceptance Criteria

### Deliverable 1: Stabilize Test Suite

**Priority**: P0 (Critical)
**Effort**: Medium (3-5 days)
**Dependencies**: None

- [ ] All 79 test failures resolved (0 failures, maintain 1873+ passing)
- [ ] No new test skips added - failures must be fixed, not hidden
- [ ] Identified bugs have corresponding issue numbers or inline TODOs with spec references
- [ ] `just test` passes cleanly in CI
- [ ] Test output shows clear summary of coverage by subsystem

---

### Deliverable 2: Complete Kernel Op Application

**Priority**: P0 (Critical)
**Effort**: Large (1-2 weeks)
**Dependencies**: None

- [ ] `applyOp()` implementation handles all 26 Op types with full logic (no stubs)
- [ ] Each Op validates preconditions (e.g., WireAdd checks port compatibility)
- [ ] Invalid Ops return descriptive error results, not throw exceptions
- [ ] Unit tests for each Op type verify both success and failure paths
- [ ] Inverse Op generation works for all reversible Ops (undo support)
- [ ] Documentation shows which Ops are idempotent vs. state-dependent
- [ ] Integration test: Create block → Wire → Publish → Undo chain works end-to-end

**Op Types Coverage:**
- Block Ops (5): BlockAdd, BlockRemove, BlockRetype, BlockSetLabel, BlockPatchParams
- Wire Ops (3): WireAdd, WireRemove, WireRetarget
- Bus Ops (3): BusAdd, BusRemove, BusUpdate
- Binding Ops (6): PublisherAdd/Remove/Update, ListenerAdd/Remove/Update
- Composite Ops (4): CompositeDefAdd/Remove/Update/ReplaceGraph
- Time Ops (1): TimeRootSet
- Settings Ops (1): PatchSettingsUpdate
- Asset Ops (3): AssetAdd/Remove/Update

---

### Deliverable 3: Wire PatchStore to Kernel Transactions

**Priority**: P0 (Critical)
**Effort**: Large (1-2 weeks)
**Dependencies**: Deliverable 2 (Complete Op Application)

- [ ] PatchStore uses kernel.beginTx() for all mutations (no direct patch edits)
- [ ] All UI actions (addBlock, addWire, updateBus, etc.) go through transaction builder
- [ ] MobX observables still react correctly to kernel-driven state changes
- [ ] Transaction rollback on validation failure (e.g., invalid wire) works correctly
- [ ] Existing UI functionality preserved (manual smoke test: create patch, add blocks, wire, run)
- [ ] Unit tests verify transaction isolation - failed Tx doesn't corrupt patch state
- [ ] Integration test: UI → TxBuilder → applyOp → SemanticGraph update → UI reaction chain works

---

## Sprint Completion Criteria

**All of the following must be true:**

- [ ] `just test` passes with 0 failures (1873+ passing tests maintained)
- [ ] `just typecheck` passes (already passing, must stay passing)
- [ ] All 26 Op types fully implemented with comprehensive unit tests
- [ ] PatchStore exclusively uses kernel transactions for all mutations
- [ ] Existing UI functionality preserved - manual smoke test passes:
  - Create new patch
  - Add blocks (various types)
  - Create wires between blocks
  - Add bus publishers/listeners
  - Run animation in player
  - Scrub timeline
  - No crashes, no visual regressions
- [ ] No new lint errors introduced (ideally reduce from 826 current errors)
- [ ] Code review completed and approved
- [ ] All deliverable acceptance criteria checked off above

---

## Definition of "Fixed" for Test Failures

A test failure is considered **fixed** when:
1. Test passes consistently (not flaky)
2. Fix addresses root cause, not just symptoms
3. If behavior changed during IR migration, spec alignment is verified
4. Related tests in same subsystem still pass
5. No new test skips introduced to hide failures

---

## Definition of "Complete" for Op Implementation

An Op type is considered **complete** when:
1. Full implementation in `applyOp()` (no stubs, no TODOs)
2. Precondition validation with descriptive error messages
3. Unit test covering success path
4. Unit test covering failure path (invalid inputs)
5. Inverse Op generated correctly (if reversible)
6. Documented idempotency guarantees
7. Integration test demonstrates Op in realistic transaction

---

## Definition of "Wired" for Store Integration

PatchStore is considered **wired to kernel** when:
1. No direct `this.patch.blocks.push()` style mutations remain
2. Every mutation goes through `kernel.beginTx()` → builder → `commit()`
3. MobX reactions fire correctly on kernel state changes
4. Failed transactions don't corrupt observable state
5. UI actions preserve existing behavior (verified by manual smoke test)
6. Integration test demonstrates full UI → Kernel → UI cycle

---

## Verification Checklist

Before marking sprint complete:

**Automated Checks:**
- [ ] Run `just check` (typecheck + lint + test) - all pass
- [ ] Run full test suite 3 times - consistent results (no flakes)
- [ ] Run `just build` - production build succeeds

**Manual Checks:**
- [ ] Load existing patches from disk - no errors
- [ ] Create new patch from scratch - all UI works
- [ ] Browser console shows no errors during normal operation
- [ ] Chrome DevTools MCP verification: blocks render correctly
- [ ] Player timeline scrubbing smooth, no stutters

**Code Quality:**
- [ ] No commented-out code left in production paths
- [ ] TODOs have issue numbers or spec references
- [ ] New code follows existing patterns (MobX actions, runInAction)
- [ ] Type safety maintained (no `any` types introduced)

**Documentation:**
- [ ] PLAN file updated with any scope changes during sprint
- [ ] Technical notes added for tricky implementation decisions
- [ ] Blockers/risks section updated with any new findings

---

## Out of Scope for This Sprint

The following are explicitly **NOT** part of this sprint's DoD:

- TimeRoot auto-publish to phaseA/pulse buses
- Layout separation (lanes → ViewState)
- Validator preflight integration with UI
- Query API (ActionsAPI, DiagnosticsAPI, PortInfo)
- State preservation / hot-swap
- Undo/redo with history tree
- Performance tracking or budgets
- Lens catalog completion
- Auto-adapter selection algorithm
- Reducing lint errors from 826 (nice-to-have, not required)

These remain in the backlog for future sprints.

---

## Success Metrics

**Quantitative:**
- Test failures: 79 → 0 (100% resolved)
- Op types implemented: 0 → 26 (100% coverage)
- PatchStore mutation paths: Direct → Kernel transactions (100% migrated)
- Overall project completion: 35-40% → 50-55%

**Qualitative:**
- Confidence in test suite restored
- Foundation for undo/redo established
- Transaction architecture proven operational
- Team can build advanced features on stable base

---

## Rollback Criteria

**Abort this sprint if:**
1. Op implementation reveals fundamental kernel architecture flaws
2. MobX integration with kernel proves incompatible
3. Test failures indicate spec contradictions requiring design rework

In case of rollback:
- Document findings in STATUS file
- Update PLAN with new approach
- Re-evaluate sprint scope with stakeholders
