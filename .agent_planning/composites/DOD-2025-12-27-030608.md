# Definition of Done: Composite Library + Custom Composite Creation

**Generated:** 2025-12-27-030608
**Plan:** PLAN-2025-12-27-030608.md
**Topic:** composites

---

## Sprint Scope

This sprint delivers **three critical deliverables**:
1. **Enable Built-in Composite Display** - Expose 23 composites in palette (quick win)
2. **Custom Composite Creation UI** - Allow users to create their own composites
3. **User Composite Persistence** - Save/load custom composites in project file

**Deferred to future sprints:**
- Macro migration
- Composite nesting (needs cycle detection)
- Visual composite graph editor
- Advanced parameter forwarding UI

---

## Acceptance Criteria

### Deliverable 1: Enable Built-in Composite Display (P0)

**Code Changes:**
- [ ] `listCompositeDefinitions` import is uncommented in `BlockLibrary.tsx` (line 11)
- [ ] Stub function `const listCompositeDefinitions = () => [];` is removed (line 12)

**Functional Requirements:**
- [ ] All 23 built-in composites appear in the "Composites" section of block palette
- [ ] Composites are grouped by subcategory (Domain, Signal, Field, Render, Other)
- [ ] Dragging a composite from palette creates a single composite block in the patch
- [ ] Double-clicking a composite from palette adds it to the active lane
- [ ] Composite blocks compile successfully through IR system (no compilation errors)
- [ ] Composite parameters are editable in Inspector panel (e.g., GridPoints rows/cols)

**Testing:**
- [ ] Manual testing in `just dev` confirms all 23 composites drag/drop correctly
- [ ] Chrome DevTools MCP test verifies composite rendering (e.g., DotsRenderer, GridPoints)
- [ ] Existing 40 tests in `composite-library.test.ts` still pass

---

### Deliverable 2: Custom Composite Creation UI (P0)

**Selection and Context Menu:**
- [ ] Multi-select works on canvas (Shift+Click to add blocks to selection)
- [ ] Drag-select box works (drag to select multiple blocks)
- [ ] Right-click on selection shows "Save as Composite" option in context menu
- [ ] "Save as Composite" is disabled if selection is empty or contains only one block

**Composite Creation Dialog:**
- [ ] Dialog opens with form fields:
  - Name (text input, required)
  - Description (textarea, optional)
  - Subcategory (dropdown: Domain, Signal, Field, Render, Other)
  - Exposed Inputs (list with checkboxes, auto-detected)
  - Exposed Outputs (list with checkboxes, auto-detected)
- [ ] Exposed ports are auto-detected from selection boundary:
  - Inputs: Any input port on selected block NOT connected to another selected block
  - Outputs: Any output port on selected block NOT connected to another selected block
- [ ] User can toggle which ports to expose via checkboxes
- [ ] "Save" button is disabled if name is empty
- [ ] "Cancel" button closes dialog without saving

**Validation:**
- [ ] Composite names are validated (no empty, no duplicates)
- [ ] Composite IDs are auto-generated from name (format: `user:<sanitized-name>`)
- [ ] Validation prevents composites containing TimeRoot blocks (enforced by `validateCompositeDefinition`)
- [ ] Error messages are displayed for validation failures (e.g., "Composite cannot contain TimeRoot blocks")

**Storage:**
- [ ] Clicking "Save" stores composite in `CompositeStore.composites` array
- [ ] Composite definition includes: id, name, description, blocks, connections, exposedInputs, exposedOutputs, subcategory
- [ ] Internal wiring (connections between selected blocks) is captured in composite graph

**Palette Integration:**
- [ ] New custom composite appears in block palette under user-defined subcategory
- [ ] Custom composite has `user:` prefix in its type ID
- [ ] Custom composites are visually distinguished from built-in composites (e.g., different color, "(Custom)" suffix)

**Instantiation:**
- [ ] Custom composite can be dragged from palette and dropped on canvas
- [ ] Instantiation creates internal blocks with correct parameters
- [ ] Instantiation creates internal connections (wiring) correctly
- [ ] Exposed inputs/outputs are wired correctly to composite block ports
- [ ] Composite block compiles successfully through IR system
- [ ] Rendered output matches expected behavior (verified via Chrome DevTools MCP)

**Testing:**
- [ ] Unit test: Create composite from 3 blocks, verify graph structure
- [ ] Unit test: Validate port auto-detection logic
- [ ] Unit test: Validate TimeRoot block rejection
- [ ] E2E test (Chrome DevTools MCP): Create composite → drag to canvas → compile → render
- [ ] E2E test: Custom composite with GridDomain + RenderInstances2D renders correctly

---

### Deliverable 3: User Composite Persistence (P0)

**Project File Schema:**
- [ ] Project file schema extended to include `composites` field (array of CompositeDefinition)
- [ ] Schema is backward compatible (missing `composites` field defaults to empty array)

**Save Operations:**
- [ ] User composites are serialized when project is saved (manual "Save Project" action)
- [ ] Composite definitions include all metadata: id, name, description, graph, ports, subcategory
- [ ] Serialization handles special cases (e.g., `__fromParam` parameter forwarding)

**Load Operations:**
- [ ] User composites are deserialized when project is loaded
- [ ] Each loaded composite is validated via `validateCompositeDefinition`
- [ ] Invalid composites are logged as warnings (console.warn) but don't crash the app
- [ ] Valid composites are added to `CompositeStore.composites`
- [ ] Loaded composites appear in block palette under correct subcategories

**Namespacing:**
- [ ] User composites use `user:*` prefix (e.g., `user:MyCustomGrid`)
- [ ] Built-in composites use `composite:*` prefix (e.g., `composite:GridPoints`)
- [ ] Namespacing prevents ID collisions between user and built-in composites

**Testing:**
- [ ] Unit test: Serialize composite → deserialize → verify structure unchanged (round-trip)
- [ ] Unit test: Load project with missing `composites` field → no errors
- [ ] Unit test: Load project with invalid composite → warning logged, other composites still load
- [ ] E2E test (Chrome DevTools MCP): Create composite → save project → reload → composite appears in palette
- [ ] E2E test: Loaded custom composite instantiates and renders correctly

---

## Sprint Success Metrics

**User-Facing:**
1. ✅ Users can see and use 23 built-in composites immediately
2. ✅ Users can create custom composites from selected blocks (2-3 click workflow)
3. ✅ Custom composites survive browser refresh (persisted in project file)
4. ✅ Custom composites compile and render correctly (no regressions)

**Technical:**
1. ✅ All existing 40 tests in `composite-library.test.ts` pass
2. ✅ New unit tests for custom composite creation (minimum 5 tests)
3. ✅ New unit tests for persistence (minimum 3 tests)
4. ✅ E2E tests via Chrome DevTools MCP (minimum 3 tests)
5. ✅ TypeScript compiles without errors (`just typecheck`)
6. ✅ No lint errors (`just lint-fix`)

**Performance:**
- [ ] Composite creation dialog opens in < 100ms
- [ ] Composite instantiation completes in < 500ms (for composites with < 10 blocks)
- [ ] Project save/load with 50 custom composites completes in < 2s

---

## Out of Scope (Future Sprints)

These features are explicitly **NOT** included in this sprint:

1. **Composite Management UI (P1)**
   - Rename, delete, duplicate operations
   - Composite library panel with search/filter
   - "View Graph" dialog for composite internals

2. **Parameter Forwarding UI (P2)**
   - Expose internal block parameters as composite-level parameters
   - Inspector integration for forwarded parameters

3. **Composite Preview Thumbnails (P3)**
   - Auto-generated thumbnails for composites in palette
   - Thumbnail hover previews

4. **Advanced Features (Future)**
   - Macro-to-composite migration
   - Composite nesting (with cycle detection)
   - Visual composite graph editor
   - Export/import composite libraries

---

## Ready for Implementation When:

1. ✅ All P0 acceptance criteria are documented (this file)
2. ✅ Full plan with technical details is documented (PLAN-2025-12-27-030608.md)
3. ✅ Dependencies are clearly identified (none - all infrastructure exists)
4. ✅ Test strategy is defined (unit + E2E)
5. ⏳ Architectural decision confirmed: Project file persistence (awaiting user confirmation)

---

## Definition of Done Checklist

A work item is DONE when:

- [ ] All acceptance criteria are met (checkboxes above)
- [ ] Code is committed to the feature branch
- [ ] Unit tests are written and passing (`just test`)
- [ ] E2E tests are written and passing (Chrome DevTools MCP)
- [ ] TypeScript compiles without errors (`just typecheck`)
- [ ] No lint errors (`just lint-fix`)
- [ ] Manual testing confirms behavior in `just dev`
- [ ] No regressions in existing functionality (40 existing tests pass)
- [ ] Code is reviewed (self-review or pair programming)
- [ ] Documentation updated if needed (CLAUDE.md, memory files)

---

## Notes

**Critical Path:**
1. P0 Enable Display (2 hours) → Unblocks user value immediately
2. P0 Creation UI (2-3 days) → Core feature
3. P0 Persistence (1 day) → Prevents data loss

**Risk Mitigation:**
- All runtime code exists and is tested (low implementation risk)
- Persistence is the only unknown (recommend project file over localStorage)
- Parameter forwarding is deferred to P2 (reduces scope risk)

**Verification Strategy:**
Use Chrome DevTools MCP for all E2E tests - tests are NOT reliable indicators of rendering correctness per CLAUDE.md.
