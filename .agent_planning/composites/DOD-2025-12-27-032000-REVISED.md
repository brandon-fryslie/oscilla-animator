# Definition of Done: Composite Library + Custom Composite Creation (REVISED)

**Generated:** 2025-12-27-032000
**Plan:** PLAN-2025-12-27-030608.md (with scope adjustment)
**Topic:** composites
**Revision:** Persistence dropped, Parameter Forwarding added

---

## Sprint Scope (Revised)

This sprint delivers **three critical deliverables**:
1. **Enable Built-in Composite Display** - Expose 23 composites in palette (quick win)
2. **Custom Composite Creation UI** - Allow users to create their own composites
3. **Parameter Forwarding UI** - Expose internal block parameters as composite-level parameters

**Deferred to future sprints:**
- User Composite Persistence (save/load in project file)
- Macro migration
- Composite nesting
- Visual composite graph editor

---

## Acceptance Criteria

### Deliverable 1: Enable Built-in Composite Display (P0)

**Code Changes:**
- [ ] `listCompositeDefinitions` import is uncommented in `BlockLibrary.tsx` (line 11)
- [ ] Stub function `const listCompositeDefinitions = () => [];` is removed (line 12)

**Functional Requirements:**
- [ ] All 23 built-in composites appear in the "Composites" section of block palette
- [ ] Composites are grouped by subcategory (Domain, Signal, Field, Render, Other)
- [ ] Dragging a composite from palette creates a single composite block in the patch
- [ ] Double-clicking a composite from palette adds it to the active lane
- [ ] Composite blocks compile successfully through IR system (no compilation errors)
- [ ] Composite parameters are editable in Inspector panel (e.g., GridPoints rows/cols)

**Testing:**
- [ ] Manual testing in `just dev` confirms all 23 composites drag/drop correctly
- [ ] Chrome DevTools MCP test verifies composite rendering (e.g., DotsRenderer, GridPoints)
- [ ] Existing 40 tests in `composite-library.test.ts` still pass

---

### Deliverable 2: Custom Composite Creation UI (P0)

**Selection and Context Menu:**
- [ ] Multi-select works on canvas (Shift+Click to add blocks to selection)
- [ ] Drag-select box works (drag to select multiple blocks)
- [ ] Right-click on selection shows "Save as Composite" option in context menu
- [ ] "Save as Composite" is disabled if selection is empty or contains only one block

**Composite Creation Dialog:**
- [ ] Dialog opens with form fields:
  - Name (text input, required)
  - Description (textarea, optional)
  - Subcategory (dropdown: Domain, Signal, Field, Render, Other)
  - Exposed Inputs (list with checkboxes, auto-detected)
  - Exposed Outputs (list with checkboxes, auto-detected)
- [ ] Exposed ports are auto-detected from selection boundary
- [ ] User can toggle which ports to expose via checkboxes
- [ ] "Save" button is disabled if name is empty
- [ ] "Cancel" button closes dialog without saving

**Validation:**
- [ ] Composite names are validated (no empty, no duplicates)
- [ ] Composite IDs are auto-generated from name (format: `user:<sanitized-name>`)
- [ ] Validation prevents composites containing TimeRoot blocks

**Storage:**
- [ ] Clicking "Save" stores composite in `CompositeStore.composites` array
- [ ] Composite definition includes: id, name, description, blocks, connections, exposedInputs, exposedOutputs, subcategory

**Palette Integration:**
- [ ] New custom composite appears in block palette under user-defined subcategory
- [ ] Custom composites are visually distinguished from built-in composites

**Instantiation:**
- [ ] Custom composite can be dragged from palette and dropped on canvas
- [ ] Instantiation creates internal blocks with correct parameters
- [ ] Composite block compiles successfully through IR system

**Testing:**
- [ ] Unit test: Create composite from 3 blocks, verify graph structure
- [ ] Unit test: Validate port auto-detection logic
- [ ] E2E test (Chrome DevTools MCP): Create composite → drag to canvas → compile → render

---

### Deliverable 3: Parameter Forwarding UI (P0)

**Composite Creation Dialog - Parameters Tab:**
- [ ] Composite creation dialog has "Parameters" tab (in addition to Ports tab)
- [ ] Tab lists all parameters of internal blocks with checkboxes
- [ ] User can select which parameters to expose and provide display names
- [ ] Default values can be set for exposed parameters

**Storage:**
- [ ] Saved composite includes `exposedParams` metadata with mappings:
  ```typescript
  exposedParams: Array<{
    name: string;           // Composite-level param name
    targetBlock: string;    // Internal block ID
    targetParam: string;    // Internal param name
    defaultValue?: unknown; // Optional default
  }>
  ```

**Inspector Integration:**
- [ ] Inspector shows composite-level parameters when composite instance is selected
- [ ] Forwarded parameters are editable in Inspector
- [ ] Changing composite parameter updates internal block parameter

**Compilation:**
- [ ] During composite expansion, internal params use `{ __fromParam: 'compositeLevelParamName' }`
- [ ] Parameter forwarding works correctly through IR compilation

**Testing:**
- [ ] Unit test: Parameter forwarding during composite expansion
- [ ] Unit test: Inspector shows forwarded params correctly
- [ ] E2E test (Chrome DevTools MCP): Create composite with forwarded params → edit param → rendering updates

---

## Sprint Success Metrics

**User-Facing:**
1. ✅ Users can see and use 23 built-in composites immediately
2. ✅ Users can create custom composites from selected blocks
3. ✅ Users can expose internal parameters as composite-level parameters
4. ⚠️ Custom composites do NOT persist across browser refresh (deferred)

**Technical:**
1. ✅ All existing 40 tests in `composite-library.test.ts` pass
2. ✅ New unit tests for custom composite creation (minimum 5 tests)
3. ✅ New unit tests for parameter forwarding (minimum 3 tests)
4. ✅ E2E tests via Chrome DevTools MCP (minimum 3 tests)
5. ✅ TypeScript compiles without errors (`just typecheck`)
6. ✅ No lint errors (`just lint-fix`)

---

## Out of Scope (Future Sprints)

1. **User Composite Persistence** - Save/load in project file (DEFERRED)
2. **Composite Management UI** - Rename, delete, duplicate
3. **Composite Preview Thumbnails** - Auto-generated thumbnails
4. **Macro Migration** - Convert macros to composites
5. **Composite Nesting** - Composites containing composites

---

## Definition of Done Checklist

A work item is DONE when:

- [ ] All acceptance criteria are met (checkboxes above)
- [ ] Code is committed to the feature branch
- [ ] Unit tests are written and passing (`just test`)
- [ ] E2E tests are written and passing (Chrome DevTools MCP)
- [ ] TypeScript compiles without errors (`just typecheck`)
- [ ] No lint errors (`just lint-fix`)
- [ ] Manual testing confirms behavior in `just dev`
- [ ] No regressions in existing functionality (40 existing tests pass)

---

## Notes

**Known Limitation:** Custom composites will be lost on browser refresh. This is acceptable for MVP - persistence will be added in a future sprint.

**Critical Path:**
1. P0 Enable Display (2 hours) → Unblocks user value immediately
2. P0 Creation UI (2-3 days) → Core feature
3. P0 Parameter Forwarding UI (1-2 days) → Enhances usability

**Verification Strategy:**
Use Chrome DevTools MCP for all E2E tests - tests are NOT reliable indicators of rendering correctness per CLAUDE.md.
