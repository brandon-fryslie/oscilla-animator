# Legacy Code Removal Sprint Plan (Revised)

**Generated:** 2025-12-27-031255
**Source STATUS:** STATUS-2025-12-27.md
**Topic:** Legacy Code Removal Refactor
**Scope:** paramSchema removal + legacy type/lens alias cleanup

---

## Executive Summary

**Current State:** The refactor branch has made significant progress removing legacy code (8 major items removed since 2025-12-25). Based on user feedback, DebugStore API and Legacy Events are **actively in use** and must be preserved.

**This Sprint Focus:** Two remaining low-risk cleanup tasks:
1. **paramSchema removal** - 27 blocks with paramSchema that should be removed (compiler verified to not use it)
2. **Legacy type/lens alias removal** - Clean up unused type aliases and lens aliases

**Verification Status:**
- Compiler does NOT read `.paramSchema` anywhere (grep confirmed 0 hits)
- Inspector.tsx lines 607-611 reference `definition.paramSchema` - needs updating
- All 27 blocks have TODO comments marking paramSchema for removal
- defaultSource is the canonical mechanism (45 compiler files reference it)

**Total Work Items:** 5 (P1: 3, P2: 2)
**Estimated Sprint Duration:** 1-2 days
**Risk Level:** LOW - well-scoped, clear acceptance criteria

---

## Work Items by Priority

### P1 (High) - Core Cleanup

---

## P1-1: Remove Inspector.tsx paramSchema References

**Status:** Not Started
**Effort:** Small (1-2 hours)
**Dependencies:** None
**Spec Reference:** design-docs/10-Refactor-for-UI-prep/14-RemoveParams.md
**Status Reference:** STATUS-2025-12-27.md § 1. paramSchema on Blocks

### Description

Inspector.tsx currently displays a "Parameters preview" section (lines 607-619) that iterates over `definition.paramSchema`. This is the only UI code that references paramSchema. Since defaultSource is now the canonical parameter mechanism, this preview section should either:
- Be removed entirely if no longer needed, OR
- Be updated to display defaultSource metadata instead

### Acceptance Criteria

- [ ] Inspector.tsx lines 607-619 no longer reference `definition.paramSchema`
- [ ] If keeping parameter preview: UI displays defaultSource inputs with their metadata (label, uiHint)
- [ ] If removing parameter preview: Code cleanly removed, no visual regression
- [ ] TypeScript compilation passes (`just typecheck`)
- [ ] Chrome DevTools verification: Block inspector displays correctly

### Technical Notes

**Current code structure:**
```typescript
{definition.paramSchema.length > 0 && (
  <div className="insp-section">
    <span className="insp-section-title">Parameters</span>
    <div className="param-preview-list">
      {definition.paramSchema.map(param => (...))}
    </div>
  </div>
)}
```

**Options:**
1. Remove entirely if redundant with input slots section
2. Replace with: `definition.inputs.filter(s => s.defaultSource)` to show parameter-like inputs

---

## P1-2: Remove paramSchema from 27 Block Definitions

**Status:** Not Started
**Effort:** Medium (2-3 hours)
**Dependencies:** P1-1 (Inspector must not reference paramSchema)
**Spec Reference:** design-docs/10-Refactor-for-UI-prep/14-RemoveParams.md
**Status Reference:** STATUS-2025-12-27.md § 1. paramSchema on Blocks

### Description

27 blocks across 5 files have `paramSchema: [...]` arrays that are no longer used. Each has a TODO comment: `// TODO: Remove paramSchema after compiler updated (Phase 4)`. The compiler has been verified to use only `defaultSource`, so paramSchema can now be safely removed.

### Acceptance Criteria

- [ ] All 27 `paramSchema` arrays removed from block definitions
- [ ] All 27 TODO comments removed
- [ ] Files affected:
  - [ ] `src/editor/blocks/signal.ts` (4 blocks: lines 70, 164, 251, 474)
  - [ ] `src/editor/blocks/domain.ts` (16 blocks)
  - [ ] `src/editor/blocks/time-root.ts` (3 blocks: lines 46, 114, 184)
  - [ ] `src/editor/blocks/field-primitives.ts` (2 blocks: lines 100, 185)
  - [ ] `src/editor/blocks/rhythm.ts` (2 blocks: lines 43, 113)
- [ ] TypeScript compilation passes (`just typecheck`)
- [ ] All tests pass (`just test`)
- [ ] Chrome DevTools verification: Blocks render and compile correctly

### Technical Notes

**Pattern to remove from each block:**
```typescript
// TODO: Remove paramSchema after compiler updated (Phase 4)
paramSchema: [
  { key: 'foo', label: 'Foo', type: 'number' as const },
  // ...
],
```

**Safety check before removal:**
- Verify each block has corresponding `defaultSource` on input slots
- Ensure no other code reads `definition.paramSchema` (already verified: only Inspector.tsx)

---

## P1-3: Remove paramSchema from BlockDefinition Type

**Status:** Not Started
**Effort:** Small (30 minutes)
**Dependencies:** P1-2 (no blocks use paramSchema), P1-1 (Inspector doesn't reference it)
**Spec Reference:** design-docs/10-Refactor-for-UI-prep/14-RemoveParams.md
**Status Reference:** STATUS-2025-12-27.md § 1. paramSchema on Blocks

### Description

Remove the `paramSchema` field from the `BlockDefinition` interface in `src/editor/blocks/types.ts` (line 59). This is the final step to fully eliminate paramSchema from the type system.

### Acceptance Criteria

- [ ] `readonly paramSchema: ParamSchema[];` removed from BlockDefinition interface (line 59)
- [ ] `ParamSchema` type definition removed (if no longer referenced elsewhere)
- [ ] TypeScript compilation passes (`just typecheck`)
- [ ] No references to `ParamSchema` or `.paramSchema` remain in codebase (grep verification)
- [ ] All tests pass (`just test`)

### Technical Notes

**Before removal, verify:**
```bash
grep -r "ParamSchema" src/editor/ --include="*.ts" --include="*.tsx"
```

If `ParamSchema` type is defined elsewhere and used for other purposes, only remove the field from BlockDefinition, not the type itself.

---

### P2 (Medium) - Nice-to-Have Cleanup

---

## P2-1: Remove Legacy Type Aliases

**Status:** Not Started
**Effort:** Small (1 hour)
**Dependencies:** None
**Spec Reference:** N/A (cleanup)
**Status Reference:** STATUS-2025-12-27.md § 7. Legacy Type Aliases

### Description

Clean up 4 legacy type aliases in `src/editor/types.ts` that are no longer needed or used:

1. **Line 447:** `'Other'` fallback BlockSubcategory - actively used, cannot remove
2. **Line 455:** `BlockCategory` alias for `BlockSubcategory` - check if used, remove if unused
3. **Line 274:** `'Field<Point>'` alias for `'Field<vec2>'` - check usage, prefer canonical form
4. **Line 292:** `'RenderTree'` internal legacy slot type - verify if still needed

### Acceptance Criteria

- [ ] `BlockCategory` type alias removed if no external references exist (audit `src/editor/index.ts` export)
- [ ] `'Field<Point>'` string literal removed from SlotType union if unused (only found in HelpCenter.tsx docs)
- [ ] `'RenderTree'` slot type either removed or marked with comment explaining why it remains
- [ ] `'Other'` subcategory KEPT (actively used in 11 locations)
- [ ] TypeScript compilation passes (`just typecheck`)
- [ ] All tests pass (`just test`)

### Technical Notes

**Audit commands:**
```bash
# Check BlockCategory usage
grep -r "BlockCategory" src/ --include="*.ts" --include="*.tsx"

# Check Field<Point> usage
grep -r "Field<Point>" src/ --include="*.ts" --include="*.tsx"

# Check RenderTree usage
grep -r "RenderTree" src/ --include="*.ts" --include="*.tsx" | wc -l  # 52 files
```

**Decision tree:**
- If `BlockCategory` only used in type exports → remove
- If `'Field<Point>'` only in docs → keep for clarity OR update docs to use `'Field<vec2>'`
- If `'RenderTree'` heavily used (52 files) → keep with comment explaining it's internal type

---

## P2-2: Audit and Document Legacy Lens Aliases

**Status:** Not Started
**Effort:** Small (30 minutes)
**Dependencies:** None
**Spec Reference:** N/A (documentation)
**Status Reference:** STATUS-2025-12-27.md § 6. Legacy Lens Aliases

### Description

The 19 PascalCase → camelCase lens aliases in `LensRegistry.ts` (lines 762-782) exist for backward compatibility with saved patches. Rather than removing them (risky), document their purpose and verify they're not causing issues.

### Acceptance Criteria

- [ ] Add comment block above line 761 explaining:
  - Purpose: Backward compatibility for saved patches using old PascalCase IDs
  - Status: Safe to keep indefinitely (additive, not blocking anything)
  - Migration path: Can be removed after all production patches use camelCase IDs
- [ ] Verify no new code is using PascalCase lens IDs (grep check)
- [ ] Confirm canonical camelCase IDs are documented in LensRegistry
- [ ] No code changes needed, documentation only

### Technical Notes

**Audit command:**
```bash
# Check for new PascalCase lens usage (should only find registry itself)
grep -r "Polarity\|Softclip\|Hysteresis" src/ --include="*.ts" --exclude="LensRegistry.ts"
```

These aliases are harmless and provide a safety net for patch loading. No urgency to remove.

---

## Dependency Graph

```
P1-1: Inspector.tsx paramSchema removal
  |
  v
P1-2: Remove paramSchema from 27 blocks
  |
  v
P1-3: Remove paramSchema from BlockDefinition type

P2-1: Remove legacy type aliases (independent)

P2-2: Document lens aliases (independent)
```

**Critical Path:** P1-1 → P1-2 → P1-3 (must be done sequentially)
**Parallel Work:** P2-1 and P2-2 can be done anytime

---

## Recommended Sprint Execution Order

### Session 1: paramSchema Removal (3-4 hours)
1. **P1-1:** Update Inspector.tsx (decide: remove or replace with defaultSource display)
2. **P1-2:** Remove paramSchema arrays from 27 blocks
3. **P1-3:** Remove paramSchema from BlockDefinition type
4. Run full checks: `just check`

### Session 2: Type Alias Cleanup (1-2 hours)
5. **P2-1:** Audit and remove unused type aliases
6. **P2-2:** Document lens aliases
7. Final verification: `just check` + Chrome DevTools smoke test

---

## Risk Assessment

### Low Risk Items
- **P1-1, P1-2, P1-3:** Compiler doesn't use paramSchema (verified), clear TODOs exist
- **P2-2:** Documentation only, no code changes

### Minimal Risk Items
- **P2-1:** Type aliases - need careful audit to avoid breaking imports

### Mitigation Strategies
1. **Run `just typecheck` after every change** - catch type errors immediately
2. **Use Chrome DevTools MCP** - verify blocks work correctly after paramSchema removal
3. **Keep git commits granular** - easy rollback if issues found

---

## Out of Scope (Per User Feedback)

**DO NOT REMOVE:**
- ✗ Legacy DebugStore API (actively in use)
- ✗ Legacy Events (actively in use)
- ✗ Feature Flags (needed until IR compiler production-ready)
- ✗ LegacyClosure Bridge (intentional migration bridge)

---

## Success Criteria

**Sprint is complete when:**
1. All paramSchema references removed from blocks and types
2. Inspector.tsx works correctly without paramSchema
3. Unused type aliases removed (except actively used ones like `'Other'`)
4. Lens aliases documented for maintainability
5. `just check` passes (typecheck + lint + test)
6. Chrome DevTools verification confirms blocks compile and render

**Definition of Done:** See DOD-2025-12-27-031255.md

---

## Files to Modify

### Confirmed Changes (P1)
- `src/editor/Inspector.tsx` (lines 607-619)
- `src/editor/blocks/signal.ts` (4 paramSchema removals)
- `src/editor/blocks/domain.ts` (16 paramSchema removals)
- `src/editor/blocks/time-root.ts` (3 paramSchema removals)
- `src/editor/blocks/field-primitives.ts` (2 paramSchema removals)
- `src/editor/blocks/rhythm.ts` (2 paramSchema removals)
- `src/editor/blocks/types.ts` (remove paramSchema field)

### Potential Changes (P2)
- `src/editor/types.ts` (type alias cleanup)
- `src/editor/lenses/LensRegistry.ts` (documentation only)

---

## Verification Checklist

After completing all work items:

- [ ] `just typecheck` passes
- [ ] `just lint-fix` passes
- [ ] `just test` passes
- [ ] Chrome DevTools: Create new block with defaultSource inputs → renders correctly
- [ ] Chrome DevTools: Inspect existing block → parameter section displays correctly
- [ ] Chrome DevTools: Compile patch → no errors
- [ ] Git status: Only intended files modified
- [ ] No grep hits for: `paramSchema` (except comments/docs if needed)

---

## Next Steps After This Sprint

Once this sprint completes:
1. **Monitor production patches** for any issues with paramSchema removal
2. **Plan Feature Flags removal** when IR compiler is stable and default
3. **Consider DebugStore API migration** if/when usage patterns change
4. **Continue main development work** - legacy cleanup is now minimal
