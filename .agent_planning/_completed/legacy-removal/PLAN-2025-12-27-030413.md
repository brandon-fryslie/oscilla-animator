# Legacy Code Removal Sprint Plan

**Generated:** 2025-12-27-030413
**Source:** STATUS-2025-12-27-035500.md
**Branch:** refactor
**Scope:** Focused cleanup sprint - 2-3 safe deliverables

---

## Executive Summary

**Current State:** The refactor branch has made excellent progress, removing 8 major legacy items (PhaseClockLegacy, TimelineHint, legacy lens field, migrateLegacyLenses, runLegacyTimeRootCheck, CompileSucceeded/Failed events, block-legacy-badge CSS, DEFAULT_INPUT alias).

**Remaining Legacy Debt:**
- **paramSchema** on 27 blocks (well-marked with TODOs, low risk)
- **Legacy DebugStore API** (7 deprecated methods, 4 active call sites)
- **Legacy Events** (8 granular event types still in union, used only in tests)
- **Feature Flags** (DEFER - needed until IR compiler stable)
- **LegacyClosure Bridge** (INTENTIONAL - not for removal)

**Sprint Focus:** Low-risk cleanup that won't destabilize the codebase. Remove legacy code that has clear migration paths and minimal dependencies.

**Total Effort:** 1-2 days of focused cleanup work

---

## Backlog by Priority

### P0 (Critical) - None

No critical legacy cleanup items. All remaining work is cleanup/tech-debt reduction.

---

### P1 (High Priority) - Low-Risk Cleanup

---

## P1-1: Remove Legacy DebugStore API

**Status:** Not Started
**Effort:** Small (1-2 hours)
**Dependencies:** None
**Spec Reference:** N/A (internal cleanup) • **Status Reference:** STATUS-2025-12-27-035500.md § "Legacy DebugStore API"

### Description

Remove 7 deprecated methods from DebugStore.ts that have direct replacements in the new API. All methods are clearly marked as deprecated with `@deprecated` JSDoc tags and have straightforward migration paths.

**Deprecated Methods (lines 809-900):**
- `isBlockDebugging()` → `isBlockProbed()`
- `debuggingBlockIds` → `probedBlockIds`
- `toggleBlockDebug()` → `toggleBlockProbe()`
- `setEntry()` → `updateProbe()`
- `replLines` → `consoleLines`
- `clearRepl()` → `clearConsole()`
- `addReplLine()` → `log()`

**Active Call Sites (4 total):**
- `src/editor/compiler/debugSampler.ts` - lines 64, 88, 137 (uses `isBlockDebugging`)
- `src/editor/compiler/blocks/debug/DebugDisplay.ts` - (needs verification)

### Acceptance Criteria

- [ ] All 4 call sites in `debugSampler.ts` updated to use `isBlockProbed()` instead of `isBlockDebugging()`
- [ ] Verify `DebugDisplay.ts` doesn't use deprecated methods (or update if it does)
- [ ] Remove all 7 deprecated methods from `DebugStore.ts` (lines 809-900)
- [ ] TypeScript compiles with no errors (`just typecheck`)
- [ ] Existing DebugStore tests still pass
- [ ] No runtime errors when toggling debug mode in the UI

### Technical Notes

- This is a pure refactoring - behavior should be identical before/after
- The new API names are clearer (`probe` vs `debug`) and align with the UI terminology
- All deprecated methods are simple one-line forwards to the new API
- **Risk Level:** VERY LOW - mechanical rename with no behavior changes

---

## P1-2: Remove Legacy Events from EditorEvent Union

**Status:** Not Started
**Effort:** Small (2-3 hours)
**Dependencies:** None
**Spec Reference:** N/A (internal cleanup) • **Status Reference:** STATUS-2025-12-27-035500.md § "Legacy Events"

### Description

Remove 8 granular event types that were superseded by `GraphCommitted` event. According to the comment in `events/types.ts` line 269, these events are "replaced by GraphCommitted" but still remain in the EditorEvent union (lines 497-505).

**Events to Remove:**
- `BlockAdded` / `BlockRemoved`
- `WireAdded` / `WireRemoved`
- `BindingAdded` / `BindingRemoved`
- `BusCreated` / `BusDeleted`

**Usage Analysis:**
- Test files: `BusStore.events.test.ts`, `PatchStore.events.test.ts` - extensive test coverage for these events
- UI files: `BusBoard.tsx`, `PublishMenu.tsx` - local handler functions named `handleBusCreated` (not actually listening to events)

**Migration Strategy:**
1. Audit all test files to determine if tests are validating important behavior
2. If behavior is still important, migrate tests to use `GraphCommitted` event
3. If tests are purely verifying the old event types, remove them
4. Remove event type definitions and emissions from stores

### Acceptance Criteria

- [ ] Audit test files to identify which tests validate important behavior vs just testing event emission
- [ ] Migrate important behavior tests to use `GraphCommitted` event (or keep if validating store behavior)
- [ ] Remove event type definitions from `events/types.ts` (8 types + their union entries)
- [ ] Remove event emissions from `PatchStore.ts` and `BusStore.ts`
- [ ] All remaining tests pass (`just test`)
- [ ] TypeScript compiles with no errors (`just typecheck`)
- [ ] UI functionality unchanged (bus creation, wire creation still work)

### Technical Notes

- **IMPORTANT:** This requires careful test analysis - don't blindly delete all tests
- Some tests may be validating important store behavior (timing, data correctness)
- Those tests should be migrated to use `GraphCommitted` or kept as-is if testing valid functionality
- Only remove tests that are purely "did we emit this event" with no behavior validation
- **Risk Level:** LOW-MEDIUM - Requires careful test analysis, but events are already superseded

---

### P2 (Medium Priority) - Defer to Next Sprint

---

## P2-1: Remove paramSchema from Block Definitions

**Status:** Not Started (DEFER TO NEXT SPRINT)
**Effort:** Medium (3-4 hours)
**Dependencies:** Verify compiler/Inspector only use defaultSource
**Spec Reference:** N/A (internal cleanup) • **Status Reference:** STATUS-2025-12-27-035500.md § "paramSchema on Blocks"

### Description

Remove `paramSchema` field from 27 block definitions across 5 files. All blocks are marked with `// TODO: Remove paramSchema after compiler updated (Phase 4)`.

**Files Affected:**
- `src/editor/blocks/signal.ts` - 4 blocks
- `src/editor/blocks/domain.ts` - 16 blocks
- `src/editor/blocks/time-root.ts` - 3 blocks
- `src/editor/blocks/field-primitives.ts` - 2 blocks
- `src/editor/blocks/rhythm.ts` - 2 blocks

**Dependencies:**
- `src/editor/Inspector.tsx` - lines 607, 611 reference `definition.paramSchema`
- Compiler may read paramSchema during compilation

**Migration Path:**
1. Verify Inspector.tsx can be updated to use `defaultSource` instead
2. Verify compiler only uses `defaultSource` (not paramSchema)
3. Remove paramSchema from all block definitions
4. Update BlockDefinition type to make paramSchema optional (then remove entirely)

### Acceptance Criteria

- [ ] Audit Inspector.tsx to confirm it can safely use `defaultSource` instead of `paramSchema`
- [ ] Audit compiler IR builder and block compilers to confirm no paramSchema usage
- [ ] Update Inspector.tsx parameter rendering to use `defaultSource` (if needed)
- [ ] Remove `paramSchema` from all 27 block definitions
- [ ] Update `BlockDefinition` type to remove paramSchema field
- [ ] TypeScript compiles with no errors (`just typecheck`)
- [ ] All tests pass (`just test`)
- [ ] Inspector UI still shows parameters correctly
- [ ] No runtime errors when inspecting blocks

### Technical Notes

- **DEFER REASON:** Requires verification that Inspector and compiler are fully migrated to `defaultSource`
- The TODOs say "Phase 4" - may be waiting for IR compiler completion
- Inspector.tsx definitely uses `definition.paramSchema` (lines 607, 611)
- This is safe to defer - the TODOs are clear and not causing issues
- **Risk Level:** MEDIUM - Requires careful verification of Inspector and compiler dependencies

---

### P3 (Low Priority) - Out of Scope

---

## P3-1: Remove Legacy Type Aliases

**Status:** Not Started (OUT OF SCOPE)
**Effort:** Small (30 minutes)
**Dependencies:** None
**Spec Reference:** N/A • **Status Reference:** STATUS-2025-12-27-035500.md § "Legacy Type Aliases"

### Description

Remove unused legacy type aliases from `src/editor/types.ts`:
- `'Other'` fallback BlockSubcategory (line 447)
- `BlockCategory` alias for `BlockSubcategory` (line 455)
- `'Field<Point>'` alias for `'Field<vec2>'` (line 274)
- `'RenderTree'` internal legacy slot type (line 292)

**OUT OF SCOPE REASON:** Very low value, minimal harm in leaving them. Not worth the risk of breaking type compatibility for saved patches or external references.

### Acceptance Criteria

Not applicable - out of scope for this sprint.

---

## P3-2: Remove Legacy Lens Aliases

**Status:** Not Started (OUT OF SCOPE)
**Effort:** Small (30 minutes)
**Dependencies:** None
**Spec Reference:** N/A • **Status Reference:** STATUS-2025-12-27-035500.md § "Legacy Lens Aliases"

### Description

Remove PascalCase → camelCase lens aliases from `LensRegistry.ts` (lines 761-783). 19 aliases like `'Polarity' → 'polarity'`, `'Softclip' → 'softclip'`, etc.

**OUT OF SCOPE REASON:** These are additive aliases for backward compatibility with saved patches. They cause no harm and removing them would break old patches. Keep indefinitely.

### Acceptance Criteria

Not applicable - out of scope for this sprint.

---

## Items Explicitly Excluded from This Sprint

### Feature Flags (DEFER - IR Compiler Not Stable)

**Status:** Active and Required
**File:** `src/editor/compiler/featureFlags.ts`

**Reason for Exclusion:** Feature flags control the legacy vs IR compiler path. The IR compiler is not yet stable enough to be the default. According to STATUS report, `useUnifiedCompiler: false` is still the default.

**Migration Path:** When IR compiler is stable and default, enable `useUnifiedCompiler: true`, test thoroughly, then remove feature flags entirely.

**Future Sprint:** Plan this work when IR compiler is ready for production.

---

### LegacyClosure Bridge (INTENTIONAL - NOT LEGACY)

**Status:** Intentional migration bridge
**Files:** `src/editor/runtime/signal-expr/LegacyClosure.ts`, `ClosureRegistry.ts`, `SigEvaluator.ts`

**Reason for Exclusion:** This is NOT legacy debt - it's an intentional bridge between new SignalExpr runtime and legacy closure-based signals during the migration period. Will be removed when all blocks are migrated to IR compiler.

**This is architectural, not technical debt.**

---

## Dependency Graph

```
Legacy DebugStore API (P1-1)
    |
    v
  [Independent - no dependencies]

Legacy Events (P1-2)
    |
    v
  [Independent - may affect tests only]

paramSchema (P2-1 - DEFERRED)
    |
    v
  Requires: Inspector.tsx migration to defaultSource
  Requires: Compiler verification
```

**No blocking dependencies between P1 items** - they can be worked in parallel or any order.

---

## Recommended Sprint Execution

### Sprint Scope (2-3 deliverables)

**INCLUDE:**
1. ✓ P1-1: Remove Legacy DebugStore API (1-2 hours, very low risk)
2. ✓ P1-2: Remove Legacy Events (2-3 hours, low-medium risk)

**DEFER TO NEXT SPRINT:**
3. ✗ P2-1: Remove paramSchema (needs verification, medium risk)

**OUT OF SCOPE:**
4. ✗ P3-1: Legacy Type Aliases (too low value)
5. ✗ P3-2: Legacy Lens Aliases (should keep for compatibility)

**Total Sprint Effort:** 3-5 hours of focused work

---

## Risk Assessment

### Low Risk Items (Safe for This Sprint)

1. **Legacy DebugStore API** - Pure refactoring, mechanical rename, no behavior change
2. **Legacy Events** - Events already superseded, mainly affects tests

### Medium Risk Items (Defer)

1. **paramSchema removal** - Inspector depends on it, needs careful verification

### High Risk Items (Future Sprints)

1. **Feature Flags** - Requires IR compiler to be production-ready
2. **LegacyClosure Bridge** - Intentional bridge, not for removal yet

---

## Success Criteria for Sprint

- [ ] Legacy DebugStore API removed - 7 deprecated methods gone
- [ ] Legacy Events removed - 8 event types removed from union
- [ ] TypeScript compiles cleanly (`just typecheck`)
- [ ] All remaining tests pass (`just test`)
- [ ] No runtime errors in dev mode (`just dev`)
- [ ] UI functionality unchanged (debug mode, bus creation still work)
- [ ] Commit message follows conventional commits format
- [ ] No breaking changes to public API or saved patch format

---

## Sprint Retrospective Questions

After completing this sprint:

1. Did removing legacy events surface any important behavior tests we should keep?
2. Is the Inspector ready for paramSchema removal, or does it need more work?
3. Are there other small legacy items we missed that could be quick wins?
4. How close is the IR compiler to being production-ready for Feature Flags removal?

---

## Next Sprint Planning

**Focus Areas:**
1. paramSchema removal (if Inspector verification passes)
2. Continue IR compiler stabilization
3. Address the 15 failing test files (TimeRoot NaN issues, ColorLFO issues)

**Do NOT Include:**
- Feature Flags (wait for IR compiler stability)
- LegacyClosure Bridge (intentional migration bridge)
- Legacy Type/Lens Aliases (too low value)
