# Legacy Code Removal Status Report

**Timestamp:** 2025-12-25-153000
**Scope:** project/full - Legacy Code Inventory
**Confidence:** FRESH
**Git Branch:** bmf

## Executive Summary

This report provides a complete inventory of legacy code in the oscilla-animator codebase. The goal is total removal of legacy code to prevent it from interfering with the architectural overhaul.

**Total Legacy Items Identified:** 10 major categories
**Estimated Removal Complexity:** Medium (mostly isolated, but some test dependencies)
**Blocking Dependencies:** Tests use PhaseClockLegacy extensively

---

## Complete Legacy Inventory

### 1. PhaseClockLegacy Block [HIGH PRIORITY]

**Status:** DEPRECATED - Must be removed
**Rationale:** Violates TimeRoot architecture by "owning its own time"

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/blocks/signal.ts` | 408-500 | Block definition |
| `src/editor/compiler/blocks/domain/PhaseClockLegacy.ts` | 1-63 | Block compiler |
| `src/editor/compiler/blocks/domain/index.ts` | 22 | Export |
| `src/editor/compiler/blocks/index.ts` | 26, 86 | Registry entries |

**Usages (must be migrated):**
- `src/editor/__tests__/domain-pipeline.test.ts:23,336-372` - Direct tests
- `src/editor/__tests__/composite-library.test.ts:581` - Used in test setup
- `src/editor/__tests__/composite.expansion.test.ts:307,345-346` - Used in test setup

**Dependencies:** None (standalone deprecated block)


---

### 2. Legacy Lens API in BusStore [MEDIUM PRIORITY]

**Status:** DEPRECATED - Legacy `lens` field replaced by `lensStack`

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/types.ts` | 263-264 | `lens?: LensDefinition` field (deprecated) |
| `src/editor/stores/BusStore.ts` | 289-392 | Legacy lens handling code |
| `src/editor/stores/BusStore.ts` | 478-494 | `migrateLegacyLenses()` method |

**Code Details:**
- `updateListener()` handles both `lens` and `lensStack` for backwards compat
- `addLensToStack()` removes legacy `lens` field
- `clearLensStack()` removes legacy `lens` field
- `migrateLegacyLenses()` migrates old patches on load

**Dependencies:** May affect saved patches (but project is unreleased)
**Migration Path:**
1. Remove `lens` field from `Listener` interface
2. Remove migration code
3. Remove legacy handling in update methods

---

### 3. Legacy DebugStore API [LOW PRIORITY]

**Status:** DEPRECATED - Old method names kept for debugSampler compat

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/stores/DebugStore.ts` | 809-900 | Legacy API section |

**Deprecated Methods:**
- `isBlockDebugging()` -> use `isBlockProbed()`
- `debuggingBlockIds` -> use `probedBlockIds`
- `toggleBlockDebug()` -> use `toggleBlockProbe()`
- `setEntry()` -> use `updateProbe()`
- `replLines` -> use `consoleLines`
- `clearRepl()` -> use `clearConsole()`
- `addReplLine()` -> use `log()`

**Dependencies:** `debugSampler.ts` (needs audit)
**Migration Path:** Update all callers to use new API, then remove

---

### 4. Legacy Events [LOW PRIORITY]

**Status:** DEPRECATED - Old compile events kept for compatibility

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/events/types.ts` | 508-535 | Legacy event types |

**Legacy Events:**
- `CompileSucceeded` / `CompileFailed` -> replaced by `CompileFinished`
- `BlockAdded/BlockRemoved/WireAdded/etc` -> replaced by `GraphCommitted`

**Dependencies:** Need to audit all event handlers
**Migration Path:** Search for legacy event handlers, migrate to new events

---

### 5. TimelineHint Type [MEDIUM PRIORITY]

**Status:** DEPRECATED - Use `TimeModel` instead

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/compiler/types.ts` | 48-64 | Type definition |
| `src/core/types.ts` | 336-357 | Duplicate type definition |
| `src/editor/runtime/player.ts` | 16, 52, 83, 96, 215, 285, 297, 323, 330, 345, 648 | Heavy usage |
| `src/editor/runtime/index.ts` | 62 | Re-export |

**Dependencies:** Player heavily uses TimelineHint internally
**Migration Path:**
1. Migrate player to use TimeModel exclusively
2. Remove TimelineHint type definitions
3. Remove re-exports

---

### 6. Feature Flags for Legacy Compiler [MEDIUM PRIORITY]

**Status:** Controls legacy vs unified compiler

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/compiler/featureFlags.ts` | 1-148 | Full file |

**Flags controlling legacy behavior:**
- `useUnifiedCompiler: false` (legacy default)
- `busCompilation: false` (legacy runtime wiring)
- `timeCtxPropagation: false` (legacy time management)

**Dependencies:** Entire compiler system
**Migration Path:**
1. Enable unified architecture everywhere
2. Remove legacy code paths
3. Remove feature flags entirely

---

### 7. paramSchema on Blocks [MEDIUM PRIORITY]

**Status:** Legacy parameter system, should use `defaultSource` on inputs

| Files with TODOs | Count |
|------------------|-------|
| `src/editor/blocks/signal.ts` | 5 |
| `src/editor/blocks/rhythm.ts` | 2 |
| `src/editor/blocks/field-primitives.ts` | 2 |
| `src/editor/blocks/time-root.ts` | 3 |
| `src/editor/blocks/domain.ts` | 16 |

**Total:** 28 blocks with `paramSchema` TODOs

**Dependencies:** Compiler may still read `paramSchema`
**Migration Path:**
1. Ensure compiler uses `defaultSource` from inputs
2. Remove `paramSchema` from all block definitions
3. Remove `paramSchema` from `BlockDefinition` type

---

### 8. Legacy CSS Classes [LOW PRIORITY]

**Status:** Unused CSS kept for compatibility

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/Editor.css` | 210-243 | `panel-help-btn`, `panel-toggle-btn` |
| `src/editor/Inspector.css` | 70, 92-96 | `block-legacy-badge` styles |
| `src/editor/LogWindow.css` | 91 | Comment about removed toolbar |

**Dependencies:** Need to verify no components use these classes
**Migration Path:** Search TSX files, remove unused CSS

---

### 9. Legacy Type Definitions [LOW PRIORITY]

**Status:** Deprecated type aliases and fallbacks

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/types.ts` | 285 | `Field<Point>` (legacy alias for `Field<vec2>`) - NOT USED |
| `src/editor/types.ts` | 303 | `RenderTree` slot type (internal/legacy) |
| `src/editor/types.ts` | 412 | `'legacy-composite'` form mention |
| `src/editor/types.ts` | 450 | `'Other'` fallback for legacy blocks |
| `src/editor/types.ts` | 457-459 | `BlockCategory` deprecated alias |
| `src/core/types.ts` | 111-114 | `DEFAULT_INPUT` deprecated alias |

**Dependencies:** May be used in type checks
**Migration Path:** Audit usage, remove if unused

---

### 10. Diagnostics Legacy Check [LOW PRIORITY]

**Status:** Fallback for minimal test mocks

| File | Lines | Description |
|------|-------|-------------|
| `src/editor/diagnostics/DiagnosticHub.ts` | 310, 339-373 | `runLegacyTimeRootCheck()` |

**Purpose:** Called when `patchStore.root` is not available (minimal mocks)
**Dependencies:** Test infrastructure
**Migration Path:** Fix tests to use proper mocks, remove legacy check

---

## Dependency Graph

```
                           +------------------+
                           |  Feature Flags   |
                           +--------+---------+
                                    |
                    +---------------+----------------+
                    |                                |
            +-------v-------+               +--------v--------+
            | Unified       |               | Legacy Compiler |
            | Compiler      |               | (integration.ts)|
            +-------+-------+               +--------+--------+
                    |                                |
                    +---------------+----------------+
                                    |
                            +-------v-------+
                            | TimeModel vs  |
                            | TimelineHint  |
                            +-------+-------+
                                    |
                            +-------v-------+
                            |    Player     |
                            +---------------+

+-------------------+       +-------------------+
| PhaseClockLegacy  |       | Legacy Lens API   |
+-------------------+       +-------------------+
         |                           |
         v                           v
+-------------------+       +-------------------+
| Tests (3 files)   |       | BusStore          |
+-------------------+       +-------------------+

+-------------------+       +-------------------+
| paramSchema       |       | Legacy DebugStore |
+-------------------+       +-------------------+
         |                           |
         v                           v
+-------------------+       +-------------------+
| 28 block files    |       | debugSampler      |
+-------------------+       +-------------------+
```

---

## Safe Removal Order

Based on dependency analysis, remove in this order to minimize breakage:

### Phase 1: Isolated Items (No Dependencies)
1. **Legacy CSS Classes** - Just delete, verify no TSX usage
2. **Legacy Type Aliases** - Audit and remove unused ones
3. **Legacy DebugStore API** - Update debugSampler first

### Phase 2: Test-Dependent Items
4. **PhaseClockLegacy** - Migrate tests first, then remove block




### Phase 3: Compiler/Runtime Items
5. **paramSchema removal** - Verify compiler uses defaultSource, then bulk remove
6. **Legacy Lens API** - Remove after confirming no saved patches need migration
7. **Legacy Events** - Audit handlers, migrate, then remove

### Phase 4: Core Architecture
8. **TimelineHint** - Major refactor of player.ts
9. **Feature Flags** - Enable unified everywhere, remove legacy paths
10. **Diagnostics Legacy Check** - Fix test mocks

---

## Risk Assessment

| Item | Risk | Mitigation |
|------|------|------------|
| PhaseClockLegacy removal | MEDIUM - Tests break | Migrate tests first |
| TimelineHint removal | HIGH - Player refactor | Do last, carefully |
| paramSchema removal | LOW - Mostly cleanup | Verify compiler ready |
| Feature Flags removal | MEDIUM - May expose bugs | Run full test suite |
| Legacy Lens API | LOW - Project unreleased | Just remove |
| Legacy Events | LOW - Easy to audit | Grep for handlers |
| CSS Classes | VERY LOW - Visual only | Quick visual test |

---

## Ambiguities Requiring Clarification

### Question 1: Should PhaseClockLegacy tests be deleted or migrated?

**Context:** Three test files use PhaseClockLegacy as a time source.
**Options:**
- A: Delete the tests entirely (lose coverage)


**Recommendation:** Option B - The tests cover domain pipeline behavior, worth keeping.

### Question 2: Is there any saved patch data to migrate?

**Context:** Legacy lens API has migration code. Project appears unreleased.
**Impact:** If no saved patches exist, migration code can be deleted immediately.

**Recommendation:** Confirm no production patches exist, then remove migration code.

### Question 3: Should feature flags be removed entirely or converted to dev-only?

**Context:** Feature flags control legacy/unified compiler switching.
**Options:**
- A: Remove entirely (simplest)
- B: Keep for A/B testing (more flexible)
- C: Keep as dev-only for debugging (compromise)

**Recommendation:** Option A - Project is unreleased, no need for A/B testing.

---

## Verdict

**Workflow Recommendation:** CONTINUE

The legacy items are well-isolated and can be removed systematically. No blocking ambiguities that would require pausing work.

**Suggested First Steps:**
1. Migrate the 3 test files using PhaseClockLegacy
2. Remove PhaseClockLegacy block and compiler
3. Remove legacy CSS classes (quick win)
4. Proceed with Phase 2-4 items

---

## Files Modified in This Evaluation

None - read-only audit.

## Next Actions

1. Implementer should start with PhaseClockLegacy test migration
2. Create a branch for legacy removal work
3. Work through phases in order
4. Run `just check` after each major removal
