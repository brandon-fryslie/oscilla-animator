# Legacy Code Removal Plan

**Generated:** 2025-12-25-150650
**Source:** STATUS-2025-12-25-153000.md
**Scope:** Complete removal of ALL legacy code from oscilla-animator codebase
**Approach:** Systematic, phased removal to minimize breakage

---

## Executive Summary

This plan provides a comprehensive inventory and removal strategy for ALL legacy code in the oscilla-animator codebase. The legacy items range from deprecated blocks and APIs to feature flags controlling architectural decisions.

**Total Items Identified:** 10 major categories + 7 additional subcategories
**Total Files Affected:** 37+ files
**Estimated Complexity:** Medium-High
**Critical Dependencies:** Test files heavily use PhaseClockLegacy

**Key Risks:**
- PhaseClockLegacy removal will break 3 test files
- TimelineHint removal requires major player.ts refactor
- Feature flag removal may expose latent bugs in unified compiler

**Recommended Approach:** Work through 4 phases in dependency order, running `just check` after each phase.

---

## Complete Legacy Inventory

### Category 1: PhaseClockLegacy Block [P0 - CRITICAL]

**Priority:** P0 (Must remove first - blocks architectural progress)
**Status:** DEPRECATED - Violates TimeRoot architecture
**Effort:** Medium (3-5 days)
**Dependencies:** None (but test files depend ON it)

#### Files to Delete

| File | Lines | Action |
|------|-------|--------|
| `src/editor/blocks/signal.ts` | 408-500 | Delete PhaseClockLegacy block definition |
| `src/editor/compiler/blocks/domain/PhaseClockLegacy.ts` | 1-63 | Delete entire file |
| `src/editor/compiler/blocks/domain/index.ts` | 22 | Remove `export * from './PhaseClockLegacy'` |
| `src/editor/compiler/blocks/index.ts` | 26, 86 | Remove registry entries |

#### Files to Migrate (Tests)

| File | Lines | Description |
|------|-------|-------------|

| `src/editor/__tests__/composite-library.test.ts` | 581 | Replace PhaseClockLegacy usage in test setup |
| `src/editor/__tests__/composite.expansion.test.ts` | 307, 345-346 | Replace PhaseClockLegacy usage in test setup |

#### Acceptance Criteria

- [ ] PhaseClockLegacy.ts file completely deleted
- [ ] Block definition removed from signal.ts
- [ ] All compiler registry entries removed
- [ ] All tests pass with `just test`
- [ ] No grep hits for "PhaseClockLegacy" in src/

#### Technical Notes
**Rationale:** PhaseClockLegacy violates the core architectural principle that TimeRoot blocks "own time". It allows arbitrary blocks to create their own time, which breaks determinism and scrubbing.

**Migration Pattern:**
```typescript
// OLD (legacy):
const clock = { type: 'PhaseClockLegacy', params: { period: 2000 } };

// NEW (correct):

const clock = { type: 'PhaseClock' }; // Reads from bus 'phaseA'
```

---

### Category 2: Legacy Lens API in BusStore [P1 - HIGH]

**Priority:** P1 (High - but project is unreleased, no saved patches to migrate)
**Status:** DEPRECATED - `lens` field replaced by `lensStack`
**Effort:** Small (1-2 days)
**Dependencies:** None (migration code only needed for production patches)

#### Files to Modify

| File | Lines | Action |
|------|-------|--------|
| `src/editor/types.ts` | 263-264 | Remove `lens?: LensDefinition` from Listener interface |
| `src/editor/stores/BusStore.ts` | 289-392 | Remove legacy lens handling in updateListener() |
| `src/editor/stores/BusStore.ts` | 289-392 | Remove legacy lens removal in addLensToStack() |
| `src/editor/stores/BusStore.ts` | 289-392 | Remove legacy lens removal in clearLensStack() |
| `src/editor/stores/BusStore.ts` | 478-494 | Delete migrateLegacyLenses() method entirely |

#### Detailed Removal Checklist

**In `src/editor/types.ts`:**
- [ ] Line 263-264: Remove `lens?: LensDefinition` field from Listener interface

**In `src/editor/stores/BusStore.ts`:**
- [ ] Lines 289-392: Remove all legacy lens handling code
  - [ ] Remove backward compatibility checks for `lens` field
  - [ ] Remove `lens` field clearing in addLensToStack()
  - [ ] Remove `lens` field clearing in clearLensStack()
- [ ] Lines 478-494: Delete entire `migrateLegacyLenses()` method
- [ ] Remove any calls to `migrateLegacyLenses()` (search for invocations)

#### Acceptance Criteria
- [ ] `lens?: LensDefinition` field removed from Listener interface
- [ ] All backward compatibility code handling `lens` field removed
- [ ] migrateLegacyLenses() method deleted
- [ ] No grep hits for "migrateLegacyLenses" in src/
- [ ] No grep hits for "lens\?" in BusStore.ts (regex search)
- [ ] All tests pass with `just test`
- [ ] TypeScript compiles with `just typecheck`

#### Technical Notes
**Rationale:** The old `lens` field was a single-lens API. It was replaced by `lensStack` which supports composing multiple lenses. Migration code is unnecessary since the project is unreleased.

**Risk Assessment:** LOW - Project has no production patches to migrate.

---

### Category 3: Legacy DebugStore API [P2 - MEDIUM]

**Priority:** P2 (Medium - cosmetic API cleanup)
**Status:** DEPRECATED - Old method names kept for backward compatibility
**Effort:** Small (1-2 days)
**Dependencies:** Must audit debugSampler.ts first

#### Deprecated Methods in `src/editor/stores/DebugStore.ts` (Lines 809-900)

| Old Method | New Method | Lines |
|------------|------------|-------|
| `isBlockDebugging()` | `isBlockProbed()` | 809-815 |
| `debuggingBlockIds` (getter) | `probedBlockIds` | 816-820 |
| `toggleBlockDebug()` | `toggleBlockProbe()` | 821-850 |
| `setEntry()` | `updateProbe()` | 851-870 |
| `replLines` (getter) | `consoleLines` | 871-880 |
| `clearRepl()` | `clearConsole()` | 881-890 |
| `addReplLine()` | `log()` | 891-900 |

#### Files to Audit

| File | Purpose |
|------|---------|
| `src/editor/compiler/debugSampler.ts` | Check if it calls legacy methods |
| `src/editor/components/DebugReplPanel.tsx` | Check if it calls legacy methods |

#### Acceptance Criteria
- [ ] All callers of legacy methods identified via grep
- [ ] All callers migrated to use new method names
- [ ] All deprecated methods removed from DebugStore.ts (lines 809-900)
- [ ] No grep hits for "isBlockDebugging" in src/
- [ ] No grep hits for "debuggingBlockIds" in src/
- [ ] No grep hits for "toggleBlockDebug" in src/
- [ ] No grep hits for "setEntry" in src/ (excluding other contexts)
- [ ] No grep hits for "replLines" in src/
- [ ] No grep hits for "clearRepl" in src/
- [ ] No grep hits for "addReplLine" in src/
- [ ] All tests pass with `just test`

#### Technical Notes
**Rationale:** The debug system was refactored from "debugging" terminology to "probing" terminology for clarity. Legacy methods were kept for backward compatibility but are no longer needed.

**Search Pattern:**
```bash
grep -r "isBlockDebugging\|debuggingBlockIds\|toggleBlockDebug\|clearRepl\|addReplLine" src/
```

---

### Category 4: Legacy Events [P2 - MEDIUM]

**Priority:** P2 (Medium - cleanup for event system modernization)
**Status:** DEPRECATED - Old events replaced by new unified events
**Effort:** Small (1-2 days)
**Dependencies:** None

#### Files to Modify

| File | Lines | Action |
|------|-------|--------|
| `src/editor/events/types.ts` | 508-535 | Remove legacy event type definitions |

#### Legacy Events to Remove (Lines 508-535)

**Replaced by `CompileFinished`:**
- [ ] Line 508-515: Remove `CompileSucceeded` event type
- [ ] Line 516-523: Remove `CompileFailed` event type

**Replaced by `GraphCommitted`:**
- [ ] Line 524-527: Remove `BlockAdded` event type
- [ ] Line 528-531: Remove `BlockRemoved` event type
- [ ] Line 532-535: Remove `WireAdded` event type
- [ ] Remove `WireRemoved` event type (if present)

#### Files to Audit for Legacy Event Handlers

| File | Action |
|------|--------|
| `src/editor/compiler/integration.ts` | Check lines 933-937, 977-981 for legacy event emissions |
| All `*.tsx` files | Search for `.on('CompileSucceeded')` or `.on('CompileFailed')` |
| All `*.ts` files in stores/ | Search for legacy event handlers |

#### Acceptance Criteria
- [ ] All legacy event type definitions removed from events/types.ts
- [ ] All legacy event emissions removed (lines 933-937, 977-981 in integration.ts)
- [ ] All legacy event handlers migrated to new events
- [ ] No grep hits for "CompileSucceeded" in src/
- [ ] No grep hits for "CompileFailed" in src/
- [ ] No grep hits for "BlockAdded" in src/ (event type, not method)
- [ ] No grep hits for "BlockRemoved" in src/ (event type, not method)
- [ ] No grep hits for "WireAdded" in src/
- [ ] No grep hits for "WireRemoved" in src/
- [ ] All tests pass with `just test`

#### Technical Notes
**Rationale:** The event system was refactored to use more comprehensive, unified events. `CompileFinished` includes both success and failure cases. `GraphCommitted` captures all graph mutations in one event.

**Migration Pattern:**
```typescript
// OLD:
events.on('CompileSucceeded', (e) => { ... });
events.on('CompileFailed', (e) => { ... });

// NEW:
events.on('CompileFinished', (e) => {
  if (e.status === 'ok') { ... }
  else { ... }
});
```

**Files Emitting Legacy Events:**
- `src/editor/compiler/integration.ts:933-937` - emits CompileSucceeded
- `src/editor/compiler/integration.ts:977-981` - emits CompileFailed

---

### Category 5: TimelineHint Type [P0 - CRITICAL]

**Priority:** P0 (Critical - blocks TimeModel migration)
**Status:** DEPRECATED - Use TimeModel instead
**Effort:** Large (1-2 weeks)
**Dependencies:** None (but player.ts heavily depends ON it)

#### Files to Modify

| File | Lines | Action |
|------|-------|--------|
| `src/editor/compiler/types.ts` | 48-64 | Delete TimelineHint type definition |
| `src/core/types.ts` | 336-357 | Delete duplicate TimelineHint type |
| `src/editor/runtime/player.ts` | 16, 52, 83, 96, 215, 285, 297, 323, 330, 345, 648 | Replace all TimelineHint usage with TimeModel |
| `src/editor/runtime/index.ts` | 62 | Remove TimelineHint re-export |

#### Detailed Player.ts Refactor Checklist

**Imports (line 16):**
- [ ] Remove `TimelineHint` import
- [ ] Ensure `TimeModel` is imported from compiler/types

**Type Definitions:**
- [ ] Line 52: Remove `timelineHint?: TimelineHint` field
- [ ] Replace with `timeModel?: TimeModel`

**Player State (line 83):**
- [ ] Remove `timelineHint` from player state
- [ ] Add `timeModel` to player state

**setProgram() method (line 96, 215):**
- [ ] Remove `timelineHint` parameter
- [ ] Use `program.timeModel` instead

**Internal logic (lines 285, 297, 323, 330, 345, 648):**
- [ ] Replace all `timelineHint === 'cyclic'` checks with `timeModel?.kind === 'cyclic'`
- [ ] Replace all `timelineHint === 'finite'` checks with `timeModel?.kind === 'finite'`
- [ ] Replace all `timelineHint === 'infinite'` checks with `timeModel?.kind === 'infinite'`

#### Acceptance Criteria
- [ ] TimelineHint type deleted from compiler/types.ts
- [ ] TimelineHint type deleted from core/types.ts
- [ ] All player.ts references converted to TimeModel
- [ ] TimelineHint re-export removed from runtime/index.ts
- [ ] No grep hits for "TimelineHint" in src/
- [ ] All tests pass with `just test`
- [ ] Player correctly handles all three TimeModel kinds (finite/cyclic/infinite)
- [ ] Scrubbing works correctly with each TimeModel kind

#### Technical Notes
**Rationale:** TimelineHint was a temporary type used before TimeModel was formalized. It served the same purpose but lacked precision. TimeModel is the canonical type from the TimeRoot spec.

**TimelineHint â†’ TimeModel Mapping:**
```typescript
// OLD:
type TimelineHint = 'finite' | 'cyclic' | 'infinite';

// NEW:
type TimeModel =
  | { kind: 'finite'; durationMs: number }
  | { kind: 'cyclic'; periodMs: number }
  | { kind: 'infinite'; windowMs: number }
```

**Risk Assessment:** HIGH - player.ts is a critical runtime component. Thorough testing required.

---

### Category 6: Feature Flags for Legacy Compiler [P0 - CRITICAL]

**Priority:** P0 (Critical - enables removal of legacy compiler code)
**Status:** Controls legacy vs unified compiler architecture
**Effort:** Large (1-2 weeks)
**Dependencies:** Unified compiler must be fully tested first

#### Files to Delete

| File | Lines | Action |
|------|-------|--------|
| `src/editor/compiler/featureFlags.ts` | 1-148 | Delete entire file |

#### Files to Modify

| File | Action |
|------|--------|
| `src/editor/compiler/integration.ts` | Remove all `getFeatureFlags()` calls and conditional logic |
| `src/editor/compiler/integration.ts` | Remove `compileWithUnified()` wrapper - make it the only path |
| `src/editor/compiler/compile.ts` | Delete entire legacy compiler (if unified is enabled) |

#### Feature Flags Currently in Use (featureFlags.ts)

**Lines 1-148 of `src/editor/compiler/featureFlags.ts`:**

- [ ] Line 15-20: `useUnifiedCompiler: false` - REMOVE (default to true, then remove flag)
- [ ] Line 30-35: `busCompilation: false` - REMOVE (unified handles this)
- [ ] Line 50-55: `timeCtxPropagation: false` - REMOVE (unified handles this)
- [ ] All other flags - audit and remove

#### Detailed Removal Plan

**Phase 1: Enable Unified Compiler Globally**
- [ ] Change `useUnifiedCompiler` default to `true`
- [ ] Run full test suite
- [ ] Test all manual workflows (Golden Patch, macro expansion, etc.)
- [ ] Verify no regressions

**Phase 2: Remove Conditional Logic**
- [ ] In `integration.ts:825-826`: Remove "Using UnifiedCompiler" log check
- [ ] In `integration.ts:899-905`: Remove conditional - use unified always
- [ ] Remove `compileWithUnified()` wrapper function (lines 728-754)
- [ ] Inline unified compiler call directly

**Phase 3: Delete Legacy Compiler**
- [ ] Delete `src/editor/compiler/compile.ts` (legacy compilation logic)
- [ ] Remove all imports of legacy compiler functions
- [ ] Verify no dead code remains

**Phase 4: Delete Feature Flags**
- [ ] Delete `src/editor/compiler/featureFlags.ts` entirely
- [ ] Remove all `getFeatureFlags()` calls
- [ ] Remove `import { getFeatureFlags }` statements

#### Acceptance Criteria
- [ ] Unified compiler is the ONLY compiler code path
- [ ] All feature flags removed
- [ ] featureFlags.ts deleted
- [ ] compile.ts legacy code deleted (or gutted if still needed)
- [ ] No grep hits for "getFeatureFlags" in src/
- [ ] No grep hits for "useUnifiedCompiler" in src/
- [ ] No grep hits for "busCompilation" in src/
- [ ] No grep hits for "timeCtxPropagation" in src/
- [ ] All tests pass with `just test`
- [ ] Golden Patch works correctly
- [ ] All macros expand correctly

#### Technical Notes
**Rationale:** Feature flags were added to allow gradual migration to the unified compiler architecture. Now that the unified compiler is mature, the flags are no longer needed.

**Risk Assessment:** HIGH - This is a major architectural change. The unified compiler must be thoroughly tested before removing legacy paths.

**Testing Strategy:**
1. Enable unified compiler for 1 week of development
2. Monitor for any regressions or edge cases
3. Once stable, proceed with removal

---

### Category 7: paramSchema on Blocks [P2 - MEDIUM]

**Priority:** P2 (Medium - cosmetic cleanup)
**Status:** Legacy parameter system - should use `defaultSource` on inputs
**Effort:** Medium (3-5 days)
**Dependencies:** Compiler must fully use `defaultSource` from inputs

#### Files with paramSchema TODOs

| File | Block Count | Lines with TODO |
|------|-------------|-----------------|
| `src/editor/blocks/signal.ts` | 5 blocks | Various |
| `src/editor/blocks/rhythm.ts` | 2 blocks | Various |
| `src/editor/blocks/field-primitives.ts` | 2 blocks | Various |
| `src/editor/blocks/time-root.ts` | 3 blocks | Various |
| `src/editor/blocks/domain.ts` | 16 blocks | Various |

**Total:** 28 blocks with paramSchema TODOs

#### Detailed Removal Plan

**Phase 1: Verify Compiler Uses defaultSource**
- [ ] Audit compiler code to confirm it reads `defaultSource` from inputs
- [ ] Verify `paramSchema` is NOT used anywhere in compiler
- [ ] Search for "paramSchema" in compiler/ directory
- [ ] Ensure Inspector.tsx uses `defaultSource` for param defaults

**Phase 2: Remove paramSchema from Block Definitions**

For each file, remove `paramSchema` arrays:

**src/editor/blocks/signal.ts:**
- [ ] Remove paramSchema from all 5 blocks
- [ ] Verify inputs have correct `defaultSource` values

**src/editor/blocks/rhythm.ts:**
- [ ] Remove paramSchema from all 2 blocks
- [ ] Verify inputs have correct `defaultSource` values

**src/editor/blocks/field-primitives.ts:**
- [ ] Remove paramSchema from all 2 blocks
- [ ] Verify inputs have correct `defaultSource` values

**src/editor/blocks/time-root.ts:**
- [ ] Remove paramSchema from all 3 blocks (FiniteTimeRoot, InfiniteTimeRoot)
- [ ] Verify inputs have correct `defaultSource` values

**src/editor/blocks/domain.ts:**
- [ ] Remove paramSchema from all 16 blocks
- [ ] Verify inputs have correct `defaultSource` values

**Phase 3: Remove paramSchema from Types**
- [ ] Remove `paramSchema` field from BlockDefinition interface
- [ ] Remove ParamSchema type definition
- [ ] Remove related type definitions

#### Acceptance Criteria
- [ ] Compiler verified to use ONLY `defaultSource` from inputs
- [ ] paramSchema removed from all 28 blocks
- [ ] paramSchema field removed from BlockDefinition type
- [ ] No grep hits for "paramSchema" in src/editor/blocks/
- [ ] No grep hits for "ParamSchema" type in src/
- [ ] All tests pass with `just test`
- [ ] Inspector correctly shows default values from `defaultSource`

#### Technical Notes
**Rationale:** The original block system used a separate `paramSchema` array to define parameters. This was replaced by embedding parameter metadata directly in the `inputs` array via `defaultSource`. The `paramSchema` field is now redundant.

**Migration Pattern:**
```typescript
// OLD:
{
  inputs: [{ id: 'freq', type: 'Signal<number>' }],
  paramSchema: [{ id: 'freq', type: 'number', default: 1, min: 0, max: 10 }]
}

// NEW:
{
  inputs: [{
    id: 'freq',
    type: 'Signal<number>',
    defaultSource: { kind: 'constant', value: 1 }
  }]
}
```

**Risk Assessment:** LOW - paramSchema is purely metadata, not used at runtime.

---

### Category 8: Legacy CSS Classes [P3 - LOW]

**Priority:** P3 (Low - visual/cosmetic)
**Status:** Unused CSS kept for backward compatibility
**Effort:** Small (1 day)
**Dependencies:** None

#### Files to Modify

| File | Lines | Classes to Remove |
|------|-------|-------------------|
| `src/editor/Editor.css` | 210-243 | `.panel-help-btn`, `.panel-toggle-btn` |
| `src/editor/Inspector.css` | 70, 92-96 | `.block-legacy-badge` |
| `src/editor/LogWindow.css` | 91 | Comment about removed toolbar |

#### Detailed Removal Checklist

**src/editor/Editor.css (lines 210-243):**
- [ ] Remove `.panel-help-btn` class definition
- [ ] Remove `.panel-toggle-btn` class definition
- [ ] Verify no TSX files use these classes (grep)

**src/editor/Inspector.css (lines 70, 92-96):**
- [ ] Remove `.block-legacy-badge` class definition
- [ ] Verify Inspector.tsx doesn't render this badge

**src/editor/LogWindow.css (line 91):**
- [ ] Remove comment about removed toolbar (cosmetic cleanup)

#### Acceptance Criteria
- [ ] All unused CSS classes removed
- [ ] No grep hits for "panel-help-btn" in src/
- [ ] No grep hits for "panel-toggle-btn" in src/
- [ ] No grep hits for "block-legacy-badge" in src/
- [ ] Visual regression test: UI still looks correct
- [ ] No broken styles in Editor, Inspector, or LogWindow

#### Technical Notes
**Rationale:** These CSS classes were left behind when UI components were removed or refactored. They serve no purpose and add to codebase cruft.

**Verification:**
```bash
# Check for usage in TSX/TS files
grep -r "panel-help-btn\|panel-toggle-btn\|block-legacy-badge" src/ --include="*.tsx" --include="*.ts"
```

**Risk Assessment:** VERY LOW - CSS-only change, no runtime impact.

---

### Category 9: Legacy Type Definitions [P3 - LOW]

**Priority:** P3 (Low - type system cleanup)
**Status:** Deprecated type aliases and fallbacks
**Effort:** Small (1-2 days)
**Dependencies:** Must verify no code uses these types

#### Files to Modify

| File | Lines | Type to Remove |
|------|-------|----------------|
| `src/editor/types.ts` | 285 | `Field<Point>` (alias for `Field<vec2>`) - COMMENT SAYS NOT USED |
| `src/editor/types.ts` | 303 | `RenderTree` slot type (internal/legacy) |
| `src/editor/types.ts` | 412 | `'legacy-composite'` form mention |
| `src/editor/types.ts` | 450 | `'Other'` fallback for legacy blocks |
| `src/editor/types.ts` | 457-459 | `BlockCategory` deprecated alias |
| `src/core/types.ts` | 111-114 | `DEFAULT_INPUT` deprecated alias |

#### Detailed Removal Plan

**src/editor/types.ts:**

- [ ] Line 285: Remove `Field<Point>` type alias
  - Verify no usages: `grep -r "Field<Point>" src/`

- [ ] Line 303: Remove `RenderTree` slot type
  - Audit: is this actually used? If yes, why is it marked legacy?
  - If unused, remove

- [ ] Line 412: Remove `'legacy-composite'` from BlockForm union type
  - Verify no blocks use this form
  - Search: `grep -r "legacy-composite" src/`

- [ ] Line 450: Remove `'Other'` from BlockSubcategory union type
  - Verify no blocks use this category
  - Search: `grep -r "subcategory.*Other" src/`

- [ ] Lines 457-459: Remove `BlockCategory` type alias
  - This is an alias for `BlockSubcategory`
  - Verify no code uses `BlockCategory`
  - Replace all usages with `BlockSubcategory`

**src/core/types.ts:**

- [ ] Lines 111-114: Remove `DEFAULT_INPUT` constant
  - This is marked as deprecated alias
  - Verify no code uses it
  - Search: `grep -r "DEFAULT_INPUT" src/`

#### Acceptance Criteria
- [ ] All deprecated type aliases removed
- [ ] No grep hits for removed types in src/
- [ ] TypeScript compiles with `just typecheck`
- [ ] All tests pass with `just test`
- [ ] No runtime errors when running editor

#### Technical Notes
**Rationale:** These are leftover type definitions from earlier iterations of the type system. They add confusion and should be removed.

**Special Cases:**
- `Field<Point>` is explicitly marked "NOT USED" in a comment (line 285)
- `BlockCategory` is a deprecated alias - prefer `BlockSubcategory`
- `'Other'` fallback suggests some legacy blocks don't have proper categories

**Risk Assessment:** LOW - Type-only changes, caught at compile time.

---

### Category 10: Diagnostics Legacy Check [P3 - LOW]

**Priority:** P3 (Low - test infrastructure cleanup)
**Status:** Fallback for minimal test mocks
**Effort:** Small (1 day)
**Dependencies:** Test infrastructure must provide proper mocks

#### Files to Modify

| File | Lines | Action |
|------|-------|--------|
| `src/editor/diagnostics/DiagnosticHub.ts` | 310, 339-373 | Remove runLegacyTimeRootCheck() |

#### Detailed Removal Plan

**Lines 310, 339-373:**
- [ ] Identify where `runLegacyTimeRootCheck()` is called
- [ ] Determine if it's still needed (only for minimal mocks?)
- [ ] Fix test infrastructure to provide proper `patchStore.root` access
- [ ] Remove the entire `runLegacyTimeRootCheck()` method
- [ ] Remove any calls to it

#### Acceptance Criteria
- [ ] All tests use proper mocks with `patchStore.root` available
- [ ] runLegacyTimeRootCheck() method deleted
- [ ] No grep hits for "runLegacyTimeRootCheck" in src/
- [ ] All tests pass with `just test`

#### Technical Notes
**Rationale:** This method is a fallback for when `patchStore.root` is not available in test mocks. Proper test infrastructure should always provide this.

**From STATUS report:**
> Purpose: Called when `patchStore.root` is not available (minimal mocks)

**Risk Assessment:** LOW - Test-only code, no production impact.

---

### Category 11: Additional Legacy Items (Discovered via Grep)

**Priority:** P2-P3 (Various)
**Status:** Miscellaneous legacy references
**Effort:** Small (1 day)

#### 11.1: Legacy Composite References in Documentation

**File:** `src/editor/HelpCenter.tsx`
**Lines:** 300-304

```typescript
In the current editor, some "legacy-composite" blocks still exist while
the system moves toward explicit composite definitions. These act like
composites in the UI but are backed by older code.
```

**Action:**
- [ ] Remove this paragraph (or update to reflect current state)
- [ ] Verify no "legacy-composite" blocks actually exist

#### 11.2: Legacy laneId in PatchStore

**File:** `src/editor/stores/PatchStore.ts`
**Line:** 271

```typescript
laneId: '', // Legacy payload, unused by ViewStore now
```

**Action:**
- [ ] Verify `laneId` is truly unused
- [ ] Remove from block selection event payload if unused
- [ ] Update type definitions to remove laneId field

#### 11.3: Legacy Macros Archive Comment

**File:** `src/editor/blocks/macros.ts`
**Line:** 213

```typescript
// Legacy macros have been archived to .agent_planning/LEGACY-BLOCKS-ARCHIVE.md
```

**Action:**
- [ ] Verify archive file exists and is up to date
- [ ] Consider moving archive to more permanent location (docs/?)
- [ ] Update comment to point to correct location

#### 11.4: Integration.ts Legacy Compiler Code

**File:** `src/editor/compiler/integration.ts`
**Lines:** 899-905

```typescript
const result = flags.useUnifiedCompiler
  ? compileWithUnified(patch)
  : (() => {
      const seed: Seed = store.uiStore.settings.seed;
      return compilePatch(patch, registry, seed, ctx);
    })();
```

**Action:**
- [ ] Remove conditional after feature flags removed (Category 6)
- [ ] Make unified compiler the ONLY path
- [ ] Delete legacy `compilePatch()` function

#### 11.5: Legacy Event Emissions in integration.ts

**File:** `src/editor/compiler/integration.ts`

**Lines 933-937:** Emits legacy `CompileSucceeded` event
```typescript
// Emit legacy CompileSucceeded event for backward compatibility
store.events.emit({
  type: 'CompileSucceeded',
  durationMs,
});
```

**Lines 977-981:** Emits legacy `CompileFailed` event
```typescript
// Emit legacy CompileFailed event for backward compatibility
store.events.emit({
  type: 'CompileFailed',
  errorCount: result.errors.length,
});
```

**Action:**
- [ ] Remove both legacy event emissions (covered in Category 4)
- [ ] Verify no listeners remain for these events

---

## Dependency Graph

```
                           +------------------+
                           |  Feature Flags   |
                           |   (Category 6)   |
                           +--------+---------+
                                    |
                    +---------------+----------------+
                    |                                |
            +-------v-------+               +--------v--------+
            | Unified       |               | Legacy Compiler |
            | Compiler      |               | (integration.ts)|
            | (KEEP)        |               | (DELETE)        |
            +-------+-------+               +--------+--------+
                    |                                |
                    +---------------+----------------+
                                    |
                            +-------v-------+
                            | TimeModel vs  |
                            | TimelineHint  |
                            | (Category 5)  |
                            +-------+-------+
                                    |
                            +-------v-------+
                            |    Player     |
                            +---------------+

+-------------------+       +-------------------+
| PhaseClockLegacy  |       | Legacy Lens API   |
|   (Category 1)    |       |   (Category 2)    |
+--------+----------+       +---------+---------+
         |                            |
         v                            v
+-------------------+       +-------------------+
| Tests (3 files)   |       | BusStore          |
| (MIGRATE)         |       | (CLEANUP)         |
+-------------------+       +-------------------+

+-------------------+       +-------------------+
| paramSchema       |       | Legacy DebugStore |
| (Category 7)      |       |   (Category 3)    |
+--------+----------+       +---------+---------+
         |                            |
         v                            v
+-------------------+       +-------------------+
| 28 block files    |       | debugSampler      |
| (CLEANUP)         |       | (AUDIT)           |
+-------------------+       +-------------------+

      INDEPENDENT CLEANUPS (No Dependencies):

+-------------------+  +-------------------+  +-------------------+
| Legacy CSS        |  | Legacy Types      |  | Legacy Events     |
| (Category 8)      |  | (Category 9)      |  | (Category 4)      |
+-------------------+  +-------------------+  +-------------------+

+-------------------+
| Diagnostics Check |
| (Category 10)     |
+-------------------+
```

---

## Safe Removal Order (by Phase)

### Phase 1: Quick Wins (Low Risk, High Value)
**Estimated Time:** 2-3 days
**Risk Level:** LOW

1. **Legacy CSS Classes (Category 8)** - Pure CSS cleanup, no runtime impact
   - Delete unused CSS classes
   - Visual regression test

2. **Legacy Type Definitions (Category 9)** - Type-level cleanup
   - Remove unused type aliases
   - TypeScript will catch any errors at compile time

3. **Legacy Macros Archive Comment (Category 11.3)** - Documentation cleanup
   - Update comment to point to correct location

4. **Legacy laneId in PatchStore (Category 11.2)** - Small cleanup
   - Remove unused event payload field

**Phase 1 Acceptance:**
- [ ] All Phase 1 items completed
- [ ] `just check` passes
- [ ] No visual regressions

---

### Phase 2: Test Infrastructure (Medium Risk)
**Estimated Time:** 3-5 days
**Risk Level:** MEDIUM

1. **PhaseClockLegacy Test Migration (Category 1)** - Migrate 3 test files
   - `domain-pipeline.test.ts`
   - `composite-library.test.ts`
   - `composite.expansion.test.ts`


2. **PhaseClockLegacy Block Removal (Category 1)** - Delete block and compiler
   - Delete PhaseClockLegacy.ts
   - Remove from signal.ts
   - Remove from registry

3. **Diagnostics Legacy Check (Category 10)** - Fix test mocks
   - Ensure all tests provide proper patchStore.root
   - Remove runLegacyTimeRootCheck()

**Phase 2 Acceptance:**
- [ ] All Phase 2 items completed
- [ ] All tests pass with `just test`
- [ ] No grep hits for "PhaseClockLegacy"

---

### Phase 3: API Cleanup (Low-Medium Risk)
**Estimated Time:** 3-5 days
**Risk Level:** LOW-MEDIUM

1. **Legacy DebugStore API (Category 3)** - Migrate callers, remove old methods
   - Audit debugSampler.ts
   - Migrate all callers to new API
   - Remove deprecated methods

2. **Legacy Lens API (Category 2)** - Remove backward compatibility code
   - Remove `lens` field from Listener interface
   - Remove migration code from BusStore

3. **Legacy Events (Category 4)** - Remove old event types
   - Remove CompileSucceeded/CompileFailed
   - Remove BlockAdded/BlockRemoved/WireAdded
   - Migrate event handlers
   - Remove legacy event emissions (Category 11.5)

4. **Legacy HelpCenter Documentation (Category 11.1)** - Update docs
   - Remove or update legacy-composite paragraph

**Phase 3 Acceptance:**
- [ ] All Phase 3 items completed
- [ ] `just check` passes
- [ ] No legacy API usage remains

---

### Phase 4: Core Architecture (High Risk, High Impact)
**Estimated Time:** 2-3 weeks
**Risk Level:** HIGH

1. **TimelineHint Removal (Category 5)** - Major player.ts refactor
   - Replace all TimelineHint usage with TimeModel
   - Test all three TimeModel kinds thoroughly
   - Verify scrubbing works correctly

2. **Feature Flags Removal (Category 6)** - Enable unified compiler permanently
   - Phase 4a: Enable `useUnifiedCompiler` globally
   - Test for 1 week, monitor for regressions
   - Phase 4b: Remove feature flags entirely
   - Delete featureFlags.ts
   - Remove conditional logic from integration.ts
   - Phase 4c: Delete legacy compiler code
   - Remove compilePatch() and compile.ts (if fully legacy)

3. **paramSchema Removal (Category 7)** - Clean up block definitions
   - Verify compiler uses defaultSource exclusively
   - Remove paramSchema from all 28 blocks
   - Remove paramSchema from BlockDefinition type

**Phase 4 Acceptance:**
- [ ] All Phase 4 items completed
- [ ] Unified compiler is ONLY compiler
- [ ] TimeModel fully replaces TimelineHint
- [ ] `just check` passes
- [ ] Golden Patch works correctly
- [ ] All macros expand correctly
- [ ] All three TimeModel kinds tested (finite/cyclic/infinite)

---

## Final Verification Checklist

After all phases complete:

**Code Hygiene:**
- [ ] No grep hits for "legacy" in src/ (case-insensitive)
- [ ] No grep hits for "deprecated" in src/ (case-insensitive)
- [ ] No grep hits for "PhaseClockLegacy" anywhere
- [ ] No grep hits for "TimelineHint" anywhere
- [ ] No grep hits for "getFeatureFlags" anywhere

**Testing:**
- [ ] All unit tests pass: `just test`
- [ ] Type checking passes: `just typecheck`
- [ ] Linting passes: `just lint`
- [ ] Full check passes: `just check`

**Manual Verification:**
- [ ] Golden Patch ("Breathing Constellation") renders correctly
- [ ] All TimeRoot types work (Finite, Cycle, Infinite)
- [ ] Bus system works correctly
- [ ] Macro expansion works
- [ ] Composite blocks work
- [ ] Scrubbing works for all time models
- [ ] Debug/probe system works
- [ ] Inspector shows correct defaults

**Documentation:**
- [ ] Update CLAUDE.md if needed
- [ ] Update design docs if architecture changed
- [ ] Update ROADMAP.md to mark legacy removal complete

---

## Risk Assessment

| Category | Risk Level | Mitigation Strategy |
|----------|------------|---------------------|
| 1. PhaseClockLegacy | MEDIUM | Migrate tests first, comprehensive testing |
| 2. Legacy Lens API | LOW | Project unreleased, no production data |
| 3. Legacy DebugStore | LOW | Audit callers first, straightforward rename |
| 4. Legacy Events | LOW | Easy to grep for handlers, clear migration path |
| 5. TimelineHint | HIGH | Thorough testing, manual verification of scrubbing |
| 6. Feature Flags | HIGH | Gradual rollout, 1-week soak test before removal |
| 7. paramSchema | LOW | Verify compiler first, bulk removal |
| 8. Legacy CSS | VERY LOW | Visual-only, easy to verify |
| 9. Legacy Types | LOW | Compile-time verification |
| 10. Diagnostics Check | LOW | Test-only code |
| 11. Misc Items | LOW | Small, isolated changes |

**Overall Risk:** MEDIUM-HIGH due to Categories 5 and 6

**Recommended Mitigation:**
1. Work through phases in strict order
2. Run `just check` after EVERY category completion
3. Manual testing after each phase
4. Extra soak testing for Phase 4 (architecture changes)

---

## Ambiguities Requiring Clarification

### Question 1: Timing for Feature Flags Removal

**Context:** Feature flags control unified vs legacy compiler. Removing them is a major architectural decision.

**Options:**
- A: Remove immediately (aggressive, risky)
- B: Enable unified for 1 week, then remove (recommended)
- C: Keep flags as dev-only for debugging (conservative)

**Recommendation:** Option B - Enable unified compiler globally, monitor for 1 week, then proceed with removal if stable.

### Question 2: Legacy compiler.ts Deletion

**Context:** After feature flags removed, is `compile.ts` entirely legacy, or does it contain shared utilities?

**Investigation Needed:**
- Audit `compile.ts` for non-legacy functions
- Determine if anything is needed by unified compiler
- If fully legacy, delete entire file

**Recommendation:** Audit first, then decide on deletion vs partial cleanup.

### Question 3: Should "legacy-composite" blocks be migrated?

**Context:** HelpCenter mentions "legacy-composite" blocks still exist. Are there any?

**Investigation Needed:**
- Search codebase for blocks with `form: 'legacy-composite'`
- If found, determine migration path
- Update HelpCenter documentation

**Recommendation:** Search first - if zero results, just update docs. If found, add to removal plan.

---

## Success Criteria

This legacy removal effort is complete when:

1. **Zero Legacy Code:**
   - No grep hits for "legacy" in src/ (excluding comments/docs)
   - No grep hits for "deprecated" in src/ (excluding comments/docs)
   - All items in Categories 1-11 removed

2. **Unified Architecture:**
   - Single compiler path (unified only)
   - Single time model (TimeModel only)
   - Single parameter system (defaultSource only)
   - Single event system (new events only)

3. **Tests Pass:**
   - All unit tests pass
   - All integration tests pass
   - Manual testing of Golden Patch succeeds

4. **Documentation Updated:**
   - CLAUDE.md reflects current state
   - Design docs reflect current state
   - No stale references to removed features

5. **Codebase Health:**
   - TypeScript compiles without errors
   - ESLint passes
   - No console warnings about deprecated features

---

## Notes for Implementer

**DO:**
- Work through phases in order (don't skip ahead)
- Run `just check` after each category
- Commit frequently with clear messages
- Update this plan if you discover new legacy items
- Ask questions if anything is unclear

**DON'T:**
- Skip testing after each change
- Mix changes from different categories in one commit
- Assume something is unused without grepping
- Delete code without checking for callers
- Rush through Phase 4 (high-risk items)

**When in Doubt:**
- Grep for usages before deleting
- Check git blame for context
- Consult design docs
- Ask for clarification

---

## Estimated Timeline

**Phase 1 (Quick Wins):** 2-3 days
**Phase 2 (Test Infrastructure):** 3-5 days
**Phase 3 (API Cleanup):** 3-5 days
**Phase 4 (Core Architecture):** 2-3 weeks

**Total:** 3.5-4.5 weeks of focused work

**Note:** This is a DOCUMENTATION-ONLY plan. No code changes have been made yet.
