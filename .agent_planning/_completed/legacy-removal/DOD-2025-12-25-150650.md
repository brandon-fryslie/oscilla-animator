# Definition of Done: Legacy Code Removal

**Generated:** 2025-12-25-150650
**Plan:** PLAN-2025-12-25-150650.md
**Source:** STATUS-2025-12-25-153000.md

This document contains ONLY the acceptance criteria for removing all legacy code from the oscilla-animator codebase. Each criterion must be met for the legacy removal effort to be considered complete.

---

## Phase 1: Quick Wins

### Category 8: Legacy CSS Classes

- [ ] `.panel-help-btn` removed from Editor.css
- [ ] `.panel-toggle-btn` removed from Editor.css
- [ ] `.block-legacy-badge` removed from Inspector.css
- [ ] Comment about removed toolbar removed from LogWindow.css
- [ ] No grep hits for "panel-help-btn" in src/
- [ ] No grep hits for "panel-toggle-btn" in src/
- [ ] No grep hits for "block-legacy-badge" in src/
- [ ] Visual regression test: UI still looks correct
- [ ] No broken styles in Editor, Inspector, or LogWindow

### Category 9: Legacy Type Definitions

- [ ] `Field<Point>` type alias removed from editor/types.ts
- [ ] `RenderTree` legacy slot type removed (if unused)
- [ ] `'legacy-composite'` removed from BlockForm union type
- [ ] `'Other'` removed from BlockSubcategory union type
- [ ] `BlockCategory` type alias removed
- [ ] All usages of `BlockCategory` replaced with `BlockSubcategory`
- [ ] `DEFAULT_INPUT` constant removed from core/types.ts
- [ ] No grep hits for "Field<Point>" in src/
- [ ] No grep hits for "BlockCategory" in src/ (as a type)
- [ ] No grep hits for "DEFAULT_INPUT" in src/
- [ ] TypeScript compiles with `just typecheck`
- [ ] All tests pass with `just test`

### Category 11.3: Legacy Macros Archive Comment

- [ ] Comment in blocks/macros.ts updated to point to correct archive location
- [ ] Archive file exists and is accessible

### Category 11.2: Legacy laneId in PatchStore

- [ ] `laneId` field verified as unused
- [ ] `laneId` removed from block selection event payload
- [ ] Type definitions updated to remove laneId field
- [ ] No grep hits for "laneId" in event payloads

### Phase 1 Final Acceptance

- [ ] All Phase 1 items completed
- [ ] `just check` passes (typecheck + lint + test)
- [ ] No visual regressions
- [ ] Git commit created for Phase 1

---

## Phase 2: Test Infrastructure

### Category 1: PhaseClockLegacy Test Migration

- [ ] `domain-pipeline.test.ts` migrated to use CycleTimeRoot + PhaseClock
- [ ] `composite-library.test.ts` migrated to use CycleTimeRoot + PhaseClock
- [ ] `composite.expansion.test.ts` migrated to use CycleTimeRoot + PhaseClock
- [ ] All 3 test files pass with new time source
- [ ] Test coverage maintained or improved

### Category 1: PhaseClockLegacy Block Removal

- [ ] PhaseClockLegacy block definition removed from signal.ts (lines 408-500)
- [ ] PhaseClockLegacy.ts file deleted from compiler/blocks/domain/
- [ ] Export removed from compiler/blocks/domain/index.ts
- [ ] Registry entries removed from compiler/blocks/index.ts
- [ ] No grep hits for "PhaseClockLegacy" in src/
- [ ] All tests pass with `just test`

### Category 10: Diagnostics Legacy Check

- [ ] All tests provide proper `patchStore.root` in mocks
- [ ] `runLegacyTimeRootCheck()` method deleted from DiagnosticHub.ts
- [ ] All calls to `runLegacyTimeRootCheck()` removed
- [ ] No grep hits for "runLegacyTimeRootCheck" in src/
- [ ] All tests pass with `just test`

### Phase 2 Final Acceptance

- [ ] All Phase 2 items completed
- [ ] All tests pass with `just test`
- [ ] No grep hits for "PhaseClockLegacy"
- [ ] Git commit created for Phase 2

---

## Phase 3: API Cleanup

### Category 3: Legacy DebugStore API

- [ ] All callers of `isBlockDebugging()` identified and migrated to `isBlockProbed()`
- [ ] All callers of `debuggingBlockIds` migrated to `probedBlockIds`
- [ ] All callers of `toggleBlockDebug()` migrated to `toggleBlockProbe()`
- [ ] All callers of `setEntry()` migrated to `updateProbe()`
- [ ] All callers of `replLines` migrated to `consoleLines`
- [ ] All callers of `clearRepl()` migrated to `clearConsole()`
- [ ] All callers of `addReplLine()` migrated to `log()`
- [ ] All deprecated methods removed from DebugStore.ts (lines 809-900)
- [ ] debugSampler.ts audited and updated
- [ ] No grep hits for "isBlockDebugging" in src/
- [ ] No grep hits for "debuggingBlockIds" in src/
- [ ] No grep hits for "toggleBlockDebug" in src/
- [ ] No grep hits for "replLines" in src/
- [ ] No grep hits for "clearRepl" in src/
- [ ] No grep hits for "addReplLine" in src/
- [ ] All tests pass with `just test`

### Category 2: Legacy Lens API

- [ ] `lens?: LensDefinition` field removed from Listener interface (types.ts:263-264)
- [ ] Legacy lens handling removed from `updateListener()` in BusStore.ts
- [ ] Legacy lens field clearing removed from `addLensToStack()` in BusStore.ts
- [ ] Legacy lens field clearing removed from `clearLensStack()` in BusStore.ts
- [ ] `migrateLegacyLenses()` method deleted from BusStore.ts (lines 478-494)
- [ ] All calls to `migrateLegacyLenses()` removed
- [ ] No grep hits for "migrateLegacyLenses" in src/
- [ ] No grep hits for "lens\?" in BusStore.ts (regex search)
- [ ] All tests pass with `just test`
- [ ] TypeScript compiles with `just typecheck`

### Category 4: Legacy Events

- [ ] `CompileSucceeded` event type removed from events/types.ts
- [ ] `CompileFailed` event type removed from events/types.ts
- [ ] `BlockAdded` event type removed (if exists)
- [ ] `BlockRemoved` event type removed (if exists)
- [ ] `WireAdded` event type removed (if exists)
- [ ] `WireRemoved` event type removed (if exists)
- [ ] Legacy CompileSucceeded emission removed from integration.ts:933-937
- [ ] Legacy CompileFailed emission removed from integration.ts:977-981
- [ ] All event handlers migrated to use CompileFinished and GraphCommitted
- [ ] No grep hits for "CompileSucceeded" in src/
- [ ] No grep hits for "CompileFailed" in src/
- [ ] No grep hits for "BlockAdded" in src/ (as event type)
- [ ] No grep hits for "BlockRemoved" in src/ (as event type)
- [ ] No grep hits for "WireAdded" in src/
- [ ] No grep hits for "WireRemoved" in src/
- [ ] All tests pass with `just test`

### Category 11.1: Legacy HelpCenter Documentation

- [ ] Paragraph about "legacy-composite" removed or updated in HelpCenter.tsx
- [ ] Verification that no actual legacy-composite blocks exist

### Phase 3 Final Acceptance

- [ ] All Phase 3 items completed
- [ ] `just check` passes (typecheck + lint + test)
- [ ] No legacy API usage remains
- [ ] Git commit created for Phase 3

---

## Phase 4: Core Architecture (HIGH RISK)

### Category 5: TimelineHint Removal

- [ ] TimelineHint type deleted from compiler/types.ts (lines 48-64)
- [ ] TimelineHint type deleted from core/types.ts (lines 336-357)
- [ ] TimelineHint import removed from player.ts
- [ ] TimeModel import added to player.ts
- [ ] `timelineHint` field replaced with `timeModel` in player state
- [ ] All `timelineHint === 'cyclic'` checks replaced with `timeModel?.kind === 'cyclic'`
- [ ] All `timelineHint === 'finite'` checks replaced with `timeModel?.kind === 'finite'`
- [ ] All `timelineHint === 'infinite'` checks replaced with `timeModel?.kind === 'infinite'`
- [ ] TimelineHint re-export removed from runtime/index.ts
- [ ] No grep hits for "TimelineHint" in src/
- [ ] All tests pass with `just test`
- [ ] Player correctly handles finite TimeModel (test with FiniteTimeRoot)
- [ ] Player correctly handles cyclic TimeModel (test with CycleTimeRoot)
- [ ] Player correctly handles infinite TimeModel (test with InfiniteTimeRoot)
- [ ] Scrubbing works correctly with finite TimeModel
- [ ] Scrubbing works correctly with cyclic TimeModel
- [ ] Scrubbing works correctly with infinite TimeModel

### Category 6: Feature Flags Removal

**Phase 4a: Enable Unified Compiler Globally**

- [ ] `useUnifiedCompiler` default changed to `true` in featureFlags.ts
- [ ] Full test suite passes with unified compiler
- [ ] Golden Patch tested manually with unified compiler
- [ ] All macro expansions tested with unified compiler
- [ ] 1 week soak test completed with no regressions

**Phase 4b: Remove Feature Flags**

- [ ] "Using UnifiedCompiler" log check removed from integration.ts:825-826
- [ ] Conditional compiler selection removed from integration.ts:899-905
- [ ] Unified compiler inlined directly (no wrapper)
- [ ] featureFlags.ts file deleted
- [ ] All `getFeatureFlags()` calls removed
- [ ] All `import { getFeatureFlags }` statements removed
- [ ] No grep hits for "getFeatureFlags" in src/
- [ ] No grep hits for "useUnifiedCompiler" in src/
- [ ] No grep hits for "busCompilation" in src/
- [ ] No grep hits for "timeCtxPropagation" in src/

**Phase 4c: Delete Legacy Compiler**

- [ ] Legacy compiler code audited in compile.ts
- [ ] Legacy-only functions identified
- [ ] Legacy `compilePatch()` function deleted (if fully legacy)
- [ ] compile.ts deleted or gutted (if entire file is legacy)
- [ ] All imports of legacy compiler functions removed
- [ ] No dead code remains from legacy compiler

### Category 7: paramSchema Removal

- [ ] Compiler verified to use ONLY `defaultSource` from inputs (not paramSchema)
- [ ] Inspector.tsx verified to use `defaultSource` for defaults
- [ ] paramSchema removed from all 5 blocks in signal.ts
- [ ] paramSchema removed from all 2 blocks in rhythm.ts
- [ ] paramSchema removed from all 2 blocks in field-primitives.ts
- [ ] paramSchema removed from all 3 blocks in time-root.ts
- [ ] paramSchema removed from all 16 blocks in domain.ts
- [ ] All inputs verified to have correct `defaultSource` values
- [ ] `paramSchema` field removed from BlockDefinition interface
- [ ] ParamSchema type definition removed
- [ ] No grep hits for "paramSchema" in src/editor/blocks/
- [ ] No grep hits for "ParamSchema" type in src/
- [ ] All tests pass with `just test`
- [ ] Inspector correctly shows default values from `defaultSource`

### Phase 4 Final Acceptance

- [ ] All Phase 4 items completed
- [ ] Unified compiler is the ONLY compiler path
- [ ] TimeModel fully replaces TimelineHint
- [ ] `just check` passes (typecheck + lint + test)
- [ ] Golden Patch works correctly
- [ ] All macros expand correctly
- [ ] All three TimeModel kinds tested manually
- [ ] Git commit created for Phase 4

---

## Final Verification (All Phases Complete)

### Code Hygiene

- [ ] No grep hits for "legacy" in src/ (case-insensitive, excluding docs/comments)
- [ ] No grep hits for "deprecated" in src/ (case-insensitive, excluding docs/comments)
- [ ] No grep hits for "PhaseClockLegacy" anywhere
- [ ] No grep hits for "TimelineHint" anywhere
- [ ] No grep hits for "getFeatureFlags" anywhere
- [ ] No grep hits for "useUnifiedCompiler" anywhere
- [ ] No grep hits for "CompileSucceeded" anywhere
- [ ] No grep hits for "CompileFailed" anywhere

### Testing

- [ ] All unit tests pass: `just test`
- [ ] Type checking passes: `just typecheck`
- [ ] Linting passes: `just lint`
- [ ] Full check passes: `just check`
- [ ] No console warnings about deprecated features

### Manual Verification

- [ ] Golden Patch ("Breathing Constellation") renders correctly
- [ ] FiniteTimeRoot works correctly
- [ ] CycleTimeRoot works correctly
- [ ] InfiniteTimeRoot works correctly
- [ ] Bus system works correctly
- [ ] Macro expansion works (test at least 3 different macros)
- [ ] Composite blocks work (test at least 3 different composites)
- [ ] Scrubbing works for finite time model
- [ ] Scrubbing works for cyclic time model
- [ ] Scrubbing works for infinite time model
- [ ] Debug/probe system works
- [ ] Inspector shows correct parameter defaults

### Documentation

- [ ] CLAUDE.md updated if needed
- [ ] Design docs updated if architecture changed
- [ ] ROADMAP.md updated to mark legacy removal complete
- [ ] No stale references to removed features in docs

### Git Hygiene

- [ ] All changes committed with clear messages
- [ ] Commits organized by phase (one commit per phase minimum)
- [ ] No uncommitted changes
- [ ] Git history is clean and readable

---

## Sprint Scope

This is a **4-phase sequential sprint** delivering complete legacy code removal.

### Sprint Delivers:

**Phase 1:** CSS cleanup, type cleanup, documentation fixes (2-3 days)
**Phase 2:** Test infrastructure modernization, PhaseClockLegacy removal (3-5 days)
**Phase 3:** API modernization, event system cleanup (3-5 days)
**Phase 4:** Core architecture unification (2-3 weeks)

### Deferred:

None - this is a complete legacy removal effort.

### Success Metric:

Zero legacy code remains. Unified architecture throughout. All tests pass. Manual verification succeeds.

---

## Notes

**IMPORTANT:** This is a DOCUMENTATION-ONLY plan. No code changes have been made yet.

**Risk Areas:**
- Phase 4 (TimelineHint and Feature Flags) is HIGH RISK
- Requires extra soak testing and manual verification
- DO NOT rush through Phase 4

**When to Stop and Ask:**
- If any test fails after a change
- If you discover new legacy items not in this plan
- If you're unsure about a migration path
- If removal seems riskier than documented

**Update This DOD:**
- Add criteria if you discover new legacy items
- Check off items as you complete them
- Note any deviations from the plan
