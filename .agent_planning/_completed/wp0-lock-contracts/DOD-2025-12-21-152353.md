# Definition of Done: WP0 Lock the Contracts

**Generated**: 2025-12-21 15:23:53
**Plan**: PLAN-2025-12-21-152353.md
**Source STATUS**: STATUS-20251221-133500.md

---

## Acceptance Criteria

### P0: Reserved Bus Validation Registry

- [ ] Create `RESERVED_BUS_CONTRACTS` constant in `src/editor/semantic/busContracts.ts` with canonical TypeDesc and combine mode for each reserved bus (phaseA, phaseB, pulse, energy, progress, palette)
- [ ] Add `validateReservedBus()` function that checks bus name against registry and validates TypeDesc match (world + domain)
- [ ] Add `validateReservedBusCombineMode()` function that enforces canonical combine mode for reserved buses
- [ ] Emit `E_RESERVED_BUS_TYPE_MISMATCH` diagnostic when reserved bus has wrong TypeDesc
- [ ] Emit `E_RESERVED_BUS_COMBINE_MODE_MISMATCH` diagnostic when reserved bus has wrong combine mode
- [ ] Integrate validation into `Validator.validateAll()` as new rule
- [ ] Add test coverage: create bus named "phaseA" with wrong domain → expect compile error
- [ ] Add test coverage: create bus named "energy" with combineMode='last' → expect compile error
- [ ] Add test coverage: create bus named "customBus" with any type → expect success (not reserved)

### P0: TimeRoot Upstream Dependency Validation

- [ ] Add `validateTimeRootDependencies()` method to `Validator` class
- [ ] Identify TimeRoot block in patch (already validated as exactly one)
- [ ] For each TimeRoot input port, trace dependency graph backwards using `SemanticGraph`
- [ ] Check if any upstream node is a block output (not DefaultSource/Config/UIControl)
- [ ] Emit `E_TIME_ROOT_UPSTREAM_DEPENDENCY` diagnostic if TimeRoot has evaluated block dependencies
- [ ] Include violating block ID and connection path in diagnostic payload
- [ ] Add test coverage: Wire NumberSource → TimeRoot.param → expect compile error
- [ ] Add test coverage: TimeRoot with only Config params → expect success
- [ ] Add test coverage: TimeRoot with DefaultSource input → expect success

### P0: Composite TimeRoot Constraint

- [ ] Add validation to composite definition creation/modification
- [ ] Check all blocks in composite definition graph for TimeRoot types
- [ ] Emit `E_COMPOSITE_CONTAINS_TIMEROOT` diagnostic if TimeRoot found in composite
- [ ] Prevent composite definition save if TimeRoot present
- [ ] Add test coverage: Define composite with only domain/signal blocks → expect success
- [ ] Add test coverage: Patch with TimeRoot + composite (no TimeRoot inside) → expect success
- [ ] Update composite definition UI to show validation error when TimeRoot added

### P1: Combine Mode Compatibility Matrix

- [ ] Create `COMBINE_MODE_COMPATIBILITY` matrix mapping TypeDesc domain to allowed combine modes
- [ ] Add `validateCombineModeCompatibility()` function
- [ ] For signal:number → allow sum, avg, min, max, last
- [ ] For signal:phase → allow last only
- [ ] For signal:trigger/event → allow or, last
- [ ] For field domains → allow last, layer, sum (if per-element combine defined)
- [ ] Emit `E_BUS_COMBINE_MODE_INCOMPATIBLE` diagnostic for invalid combinations
- [ ] Add test coverage: Bus signal:phase with combineMode='sum' → expect error
- [ ] Add test coverage: Bus signal:number with combineMode='avg' → expect success
- [ ] Add test coverage: Bus signal:trigger with combineMode='or' → expect success

### P2: TypeDesc Authority Enforcement

- [ ] Refactor BlockDefinition to use TypeDesc for input/output declarations (not SlotType strings)
- [ ] Update `isDirectlyCompatible()` to use TypeDesc as primary check
- [ ] Update connection validation to check TypeDesc match (world + domain)
- [ ] Add `E_TYPE_DESC_MISMATCH` diagnostic for incompatible TypeDesc connections
- [ ] Migrate all block definitions to use TypeDesc declarations
- [ ] Add backward compatibility layer for existing SlotType strings during transition
- [ ] Add test coverage: Connect signal:number to signal:phase → expect TypeDesc error
- [ ] Add test coverage: Connect field:vec2 to signal:number → expect world mismatch error
- [ ] Update adapter/lens system to work with TypeDesc compatibility checks



---

## Sprint Scope

**Sprint 1 delivers**: All P0 validation rules (Reserved Bus, TimeRoot Dependencies, Composite TimeRoot)


**Sprint 3 delivers**: P2 TypeDesc Authority Enforcement (large refactor, can be deferred)

**Deferred**: P2 can move to WP0.5 if needed due to scope/risk

---

## Golden Patch Validation Checklist

After Sprint 1 (P0) completion, validate:

- [ ] Breathing Constellation patch with correct reserved buses → compiles successfully
- [ ] Patch with phaseA bus (wrong type) → clear compile error with `E_RESERVED_BUS_TYPE_MISMATCH` diagnostic
- [ ] Patch with multiple TimeRoots → clear error with `E_TIME_ROOT_MULTIPLE` diagnostic
- [ ] Patch with TimeRoot depending on NumberSource → clear error with `E_TIME_ROOT_UPSTREAM_DEPENDENCY` diagnostic
- [ ] All diagnostics include primaryTarget, clear message, and suggested actions
- [ ] Diagnostics render correctly in UI with actionable guidance

After Sprint 2 (P1+P3) completion, validate:

- [ ] Patch with signal:phase bus using combineMode='sum' → clear error with `E_BUS_COMBINE_MODE_INCOMPATIBLE` diagnostic

---

## Quality Gates

- [ ] All new DiagnosticCode entries added to `src/editor/diagnostics/types.ts`
- [ ] All validation functions integrated into `Validator.validateAll()`
- [ ] Test coverage >90% for all new validation rules
- [ ] TypeScript strict mode passes with no errors
- [ ] ESLint passes with no errors (`just lint`)
- [ ] All tests pass (`just test`)
- [ ] No regressions in existing validator tests
- [ ] Diagnostic messages are clear, concise, and actionable
- [ ] Spec docs updated if implementation required changes

---

## New Diagnostic Codes

The following diagnostic codes must be implemented:

### Errors (compile-blocking)
- `E_RESERVED_BUS_TYPE_MISMATCH` - Reserved bus has wrong TypeDesc (world/domain mismatch)
- `E_RESERVED_BUS_COMBINE_MODE_MISMATCH` - Reserved bus has wrong combine mode
- `E_TIME_ROOT_UPSTREAM_DEPENDENCY` - TimeRoot depends on evaluated block output
- `E_COMPOSITE_CONTAINS_TIMEROOT` - Composite definition contains TimeRoot block
- `E_BUS_COMBINE_MODE_INCOMPATIBLE` - Bus combine mode incompatible with TypeDesc domain
- `E_TYPE_DESC_MISMATCH` - Connection with incompatible TypeDesc (P2 only)

### Warnings (non-blocking)

---

## File Deliverables

### New Files
- `src/editor/semantic/busContracts.ts` - Reserved bus registry and validation
- `src/editor/semantic/__tests__/busContracts.test.ts` - Test coverage for bus contracts
- `src/editor/semantic/__tests__/compositeValidator.test.ts` - Test coverage for composite validation (optional, can be in existing validator.test.ts)

### Modified Files
- `src/editor/semantic/validator.ts` - Add 4+ new validation rules
- `src/editor/diagnostics/types.ts` - Add 8 new DiagnosticCode entries
- `src/editor/stores/CompositeStore.ts` - Integrate composite validation
- `src/editor/semantic/__tests__/validator.test.ts` - Expand test coverage

### P2-Only Files (can be deferred)
- `src/editor/types.ts` - Refactor PortDefinition to use TypeDesc authority

---

## Success Criteria

WP0 is complete when:

1. **All P0 acceptance criteria met** (Sprint 1 deliverable)
2. **All P1 acceptance criteria met** (Sprint 2 deliverable)
3. **Golden Patch validation checklist passes completely**
4. **All quality gates passed**
5. **Spec says**: "Patch loads, validates, and produces intelligible errors until time/runtime exists" ✓

**P2 (TypeDesc Authority)** can be deferred to WP0.5 due to large refactor scope. P0+P1+P3 deliver the core contract enforcement.

---

## Definition of "Done"

A work item is DONE when:

- [ ] Implementation complete and committed
- [ ] All acceptance criteria checked off
- [ ] Tests written and passing (>90% coverage)
- [ ] TypeScript compiles with no errors
- [ ] ESLint passes with no warnings
- [ ] Code reviewed (self-review or peer review)
- [ ] Diagnostic messages tested in UI (if applicable)
- [ ] Documentation updated (if API changes)
- [ ] No known regressions introduced

**CRITICAL**: Do NOT mark items as done if:
- Tests are failing
- Implementation is partial
- Errors encountered but not resolved
- Acceptance criteria not fully met
