# Definition of Done: FieldExpr + Materialization Integration

**Generated**: 2025-12-25-230109
**Plan**: PLAN-2025-12-25-230109.md
**Source**: STATUS-2025-12-25-225500.md
**Topic**: fieldexpr-integration

---

## Sprint Scope

**This sprint delivers**: Minimum viable integration connecting 8-pass compiler output to runtime field materialization

**Deliverables** (2-3 max):
1. Type Adapter Layer - Convert compiler TypeDesc ↔ runtime TypeDesc
2. Signal Bridge - Minimal signal evaluation for broadcast nodes
3. Integration Module - Wire compiler IR to runtime Materializer

**Deferred to future sprints**:
- Full signal IR evaluation (Phase 4 dependency)
- Missing node kinds (select, transform)
- Bus combine integration
- Performance optimization

---

## Acceptance Criteria

### Deliverable 1: Type Adapter Layer

- [ ] `compilerToRuntimeType(compilerType: CompilerTypeDesc): RuntimeTypeDesc` function implemented
- [ ] `runtimeToCompilerType(runtimeType: RuntimeTypeDesc): CompilerTypeDesc` function implemented (for debugging)
- [ ] All common field domains (number, vec2, vec3, vec4, color, boolean) convert correctly
- [ ] Unsupported domains throw `UnsupportedTypeError` with clear message listing supported types
- [ ] Signal types with field-compatible domains convert correctly (for broadcast nodes)
- [ ] Unit tests cover all supported conversions and error cases
- [ ] Type adapter has NO dependencies on MobX stores or UI state

**File**: `src/editor/runtime/integration/typeAdapter.ts` (~150 lines)
**Tests**: `src/editor/runtime/integration/__tests__/typeAdapter.test.ts` (~200 lines)

---

### Deliverable 2: Signal Bridge for Broadcast Nodes

- [ ] `SignalBridge` class implemented with `registerSignal()` and `evalSig()` methods
- [ ] Bridge supports registering signal closures by SigExprId
- [ ] `evalSig()` evaluates registered closures with current time from SigEnv
- [ ] Unregistered signal IDs throw clear error with signal ID in message
- [ ] Materializer.ts updated to use SignalBridge instance instead of stub
- [ ] All existing runtime/field tests continue to pass (63 tests)
- [ ] New test: broadcast field node materializes correctly with real signal values (not 0)
- [ ] Bridge is marked with TODO comment: "TEMPORARY: Replace with Phase 4 signal IR evaluator"

**Files**:
- `src/editor/runtime/integration/SignalBridge.ts` (~100 lines)
- `src/editor/runtime/field/Materializer.ts` (MODIFY - replace evalSig stub)
- `src/editor/runtime/integration/__tests__/SignalBridge.test.ts` (~150 lines)

---

### Deliverable 3: Integration Module and API

- [ ] `CompilerRuntime` class implemented with loadProgram, materializeField, dispose methods
- [ ] loadProgram() extracts FieldExprTable from LinkedGraphIR and converts types
- [ ] materializeField() delegates to runtime Materializer with proper environment setup
- [ ] Domain count resolution works (getDomainCount from IR domain slots)
- [ ] Constant pool access works (constants from IR const pool)
- [ ] Integration test: compile simple patch (1 const field) → materialize → verify output
- [ ] Integration test: compile broadcast field → materialize → verify signal values propagate
- [ ] Integration test: compile map operation → materialize → verify function applied
- [ ] All type conversions use typeAdapter (no inline conversion logic)
- [ ] Proper error handling with context (which field, which domain, what failed)

**Files**:
- `src/editor/runtime/integration/CompilerRuntime.ts` (~250 lines)
- `src/editor/runtime/integration/__tests__/integration.test.ts` (~300 lines)

---

## Test Success Criteria

### Unit Tests
- [ ] Type adapter: 10+ test cases covering all conversions and errors
- [ ] Signal bridge: 5+ test cases covering registration, evaluation, errors
- [ ] Integration module: 8+ test cases covering API methods and error paths

### Integration Tests
- [ ] End-to-end test: Patch with const field → compile → materialize → verify typed array
- [ ] End-to-end test: Patch with broadcast field → compile → materialize → verify signal values
- [ ] End-to-end test: Patch with map operation → compile → materialize → verify function applied

### Regression Tests
- [ ] All 144 compiler pass tests still pass
- [ ] All 63 runtime field tests still pass
- [ ] `pnpm vitest run` completes with 210+ tests passing (207 existing + 3+ new)
- [ ] `pnpm typecheck` passes with zero errors
- [ ] `just check` passes (typecheck + lint + test)

---

## Code Quality Criteria

### Architecture
- [ ] One-way dependency: runtime imports from compiler, NEVER reverse
- [ ] Clear separation: type adapter, signal bridge, integration module are distinct
- [ ] No circular dependencies between modules
- [ ] Integration module is the ONLY place that connects compiler to runtime

### Code Style
- [ ] All functions have TSDoc comments explaining purpose and parameters
- [ ] Error messages include context (which field, which domain, what operation)
- [ ] TODO comments only for "Phase 4 replacement" (signal bridge)
- [ ] No console.log or debugging code left in production files
- [ ] Consistent naming: compiler types use "Compiler" prefix, runtime types use "Runtime" prefix

### Testing
- [ ] Tests use descriptive names: "should convert number field type correctly"
- [ ] Tests are isolated: no shared mutable state between tests
- [ ] Tests use arrange-act-assert pattern
- [ ] Integration tests use programmatic patch construction (no JSON fixtures)
- [ ] Error cases are tested: unsupported types, missing signals, invalid domains

---

## Documentation Criteria

### Code Documentation
- [ ] Type adapter has JSDoc explaining conversion rules and limitations
- [ ] Signal bridge has JSDoc explaining temporary nature and Phase 4 replacement plan
- [ ] Integration module has JSDoc explaining data flow and ownership semantics

### README Updates
- [ ] NO README updates required for this sprint (internal integration only)

### Memory Files
- [ ] NO memory file updates required (integration is internal implementation detail)

---

## Verification Checklist

### Before Starting
- [x] All 144 compiler pass tests passing
- [x] All 63 runtime field tests passing
- [x] `pnpm typecheck` passes
- [x] `just check` passes

### After Type Adapter
- [ ] Type adapter unit tests pass
- [ ] No changes to existing test counts
- [ ] `pnpm typecheck` still passes

### After Signal Bridge
- [ ] Signal bridge unit tests pass
- [ ] Materializer tests with bridge pass
- [ ] Runtime field test count: 63+ (may add broadcast test)

### After Integration Module
- [ ] Integration tests pass (3+ tests)
- [ ] End-to-end compilation → materialization proven
- [ ] Total test count: 210+ (207 existing + 3+ new)

### Final Verification
- [ ] `pnpm vitest run` - all tests pass
- [ ] `pnpm typecheck` - zero errors
- [ ] `just check` - full check passes
- [ ] `git status` - only new files in src/editor/runtime/integration/
- [ ] No modifications to compiler pass files (except maybe imports)
- [ ] No modifications to existing runtime field files (except Materializer.ts evalSig)

---

## Success Metrics

### Quantitative Targets
- **Test Count**: 210+ total tests (207 existing + ≥3 new integration tests)
- **Type Coverage**: ≥6 field domains supported (number, vec2, vec3, vec4, color, boolean)
- **Integration Paths**: ≥3 end-to-end paths tested (const, broadcast, map)
- **Zero Regressions**: All 207 existing tests continue passing
- **Lines Added**: ~1,150 lines (6 new files)
- **Lines Modified**: <20 lines (only Materializer.ts evalSig)

### Qualitative Targets
- Clean module boundaries (no spaghetti imports)
- Easy to test (integration tests are straightforward)
- Easy to replace (signal bridge is clearly temporary)
- Easy to understand (clear naming, good comments)

---

## Out of Scope

**Explicitly NOT included in this sprint**:

- ❌ Full signal IR evaluation (Phase 4 - future work)
- ❌ select node kind implementation
- ❌ transform node kind implementation
- ❌ Bus combine integration with Pass 7 output
- ❌ Performance optimization or profiling
- ❌ Buffer pooling optimization
- ❌ UI integration or visual testing
- ❌ Hot reload or live coding support
- ❌ WebAssembly field evaluation
- ❌ Multi-threaded materialization

These are deferred to future sprints.

---

## Definition of Done: Sprint Complete

**This sprint is DONE when**:

1. ✅ **All deliverables complete**: Type adapter, signal bridge, integration module
2. ✅ **All acceptance criteria met**: Every checkbox above is checked
3. ✅ **All tests pass**: 210+ tests passing with zero failures
4. ✅ **Zero regressions**: No existing functionality broken
5. ✅ **Code quality**: Clean architecture, good comments, no TODOs (except Phase 4 marker)
6. ✅ **Integration proven**: End-to-end test demonstrates compiler → runtime flow works
7. ✅ **Ready for Phase 4**: Signal bridge can be cleanly replaced when Phase 4 completes

**This sprint is NOT done until**:
- All checkboxes above are checked
- All tests pass
- Code review confirms clean abstractions

---

## Next Sprint Prerequisites

**Before starting Sprint 2 (Complete Field Operations)**:

1. This sprint must be COMPLETE (all criteria above met)
2. All 210+ tests must be stable (no flaky tests)
3. Integration module API must be proven with ≥3 different patch types
4. Signal bridge must work well enough to not block field testing
5. Architecture review: Confirm one-way dependencies are clean

---

## Risk Mitigation

### If Type Conversion Fails
- **Fallback**: Extend runtime TypeDesc to include compiler fields (world, domain)
- **Impact**: More refactoring, but still one-way dependency

### If Signal Bridge Performance is Bad
- **Fallback**: Cache signal evaluations if deterministic
- **Impact**: More complex bridge, but still temporary until Phase 4

### If Integration Tests Are Too Complex
- **Fallback**: Start with single-block patches only
- **Impact**: Reduced test coverage, but proves basic flow

### If Domain Count Resolution is Unclear
- **Fallback**: Hardcode domain count for tests, investigate in parallel
- **Impact**: Blocks dynamic domains, but allows progress

---

## Final Approval Criteria

**This sprint can be marked COMPLETE when**:

- [ ] All acceptance criteria checkboxes are checked
- [ ] All test success criteria are met
- [ ] All code quality criteria are met
- [ ] All verification checklist items pass
- [ ] Zero regressions in existing functionality
- [ ] Integration tests prove end-to-end flow works
- [ ] Code is committed to compiler_rewrite branch
- [ ] No merge conflicts with main branch

**Stakeholder sign-off**: Not required (internal implementation sprint)

**Reviewer sign-off**: Required before merge to main

---

## Summary

**Sprint Goal**: Connect 8-pass compiler output to runtime field materialization

**Deliverables**: 3 (type adapter, signal bridge, integration module)

**Test Target**: 210+ tests passing (207 existing + ≥3 new)

**Scope**: Minimum viable integration for field-only patches

**Timeline**: Small-to-medium effort (estimated 5-7 days for 3 deliverables)

**Risk**: Medium (architectural decisions required, but clear path forward)

**Readiness**: HIGH - All decisions made, clear acceptance criteria, no blockers
