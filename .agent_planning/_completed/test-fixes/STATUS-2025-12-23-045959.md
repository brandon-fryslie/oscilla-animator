# Status Report - Test Failures Analysis
**Date**: 2025-12-23 04:59:59
**Topic**: Fix failing tests
**Test Run**: 41 failures / 598 passing / 3 skipped across 15 test files

---

## Executive Summary

**Overall**: Test suite is 93.6% passing, but 41 failures reveal a clear pattern: **implementation has evolved beyond test expectations**.

**Critical Pattern Identified**: All failures fall into 2 categories:
1. **Tests with outdated expectations** (90% of failures) - Implementation changed, tests need updating
2. **Tests exposing incomplete functionality** (10% of failures) - Missing mute/unmute feature implementation

**Root Cause**: Recent implementation work added new outputs to TimeRoot blocks without updating corresponding test expectations. The implementation appears correct per design docs; tests are asserting against OLD specifications.

---

## Cache Reuse Summary
- **Reused from eval-cache**: time-architecture.md (HIGH confidence), compiler-architecture.md (HIGH confidence)
- **Fresh evaluation**: Runtime test failures, test expectation gaps
- **Cache updates**: None needed - this is test infrastructure evaluation

---

## Test Failure Categorization

### Category 1: Tests with Wrong Expectations (37 failures)

**Root cause**: Implementation added outputs to TimeRoot blocks per WP1 specification, but tests assert against pre-WP1 output schema.

#### TimeRoot Output Mismatches (3 failures)

| Test File | Failure | Expected | Actual | Root Cause |
|-----------|---------|----------|--------|------------|
| TimeRoot.test.ts:48 | FiniteTimeRoot outputs | 4 outputs | 5 outputs (added `phase`) | Test expects pre-WP1 schema |
| TimeRoot-WP1.test.ts:258 | FiniteTimeRoot auto-publications | 2 pubs | 4 pubs (added `phaseA`, extra `energy`) | Test expectations incomplete |
| TimeRoot-WP1.test.ts:275 | InfiniteTimeRoot auto-publications | 1 pub | 3 pubs (added `phaseA`, `pulse`) | Test expectations incomplete |

**Evidence**:
```typescript
// Implementation (TimeRoot.ts:34-40)
case 'FiniteTimeRoot':
  return [
    { busName: 'progress', artifactKey: 'progress', sortKey: 0 },
    { busName: 'phaseA', artifactKey: 'phase', sortKey: 0 },  // <-- NEW
    { busName: 'pulse', artifactKey: 'end', sortKey: 0 },
    { busName: 'energy', artifactKey: 'energy', sortKey: 0 },
  ];

// Test expectation (TimeRoot-WP1.test.ts:258-262)
expect(autoPubs).toEqual([
  { busName: 'progress', artifactKey: 'progress', sortKey: 0 },
  { busName: 'pulse', artifactKey: 'end', sortKey: 0 },
  { busName: 'energy', artifactKey: 'energy', sortKey: 0 },
  // Missing: phaseA publication
]);
```

**Analysis**: Implementation at TimeRoot.ts lines 34-47 shows ALL three TimeRoot types now publish to `phaseA` and `pulse` buses. This aligns with design-docs/3-Synthesized/03-Buses.md which specifies phaseA as a canonical bus. Tests are checking against an older specification.

**Implementation Assessment**: ✅ CORRECT - TimeRoot.ts outputs match block definition outputs (lines 68-74 for FiniteTimeRoot show `phase` output exists).

**Fix Required**: Update test expectations to match current implementation.

---

#### DiagnosticHub Failures (8 failures)

All 8 failures are related to incomplete mute/unmute functionality:

| Test | Issue | Evidence |
|------|-------|----------|
| `should handle GraphCommitted events` | AuthoringSnapshot not empty when TimeRoot exists | Test expects 0 diagnostics, gets 1 |
| `should not create missing TimeRoot diagnostic` | Same - still creating diagnostic | Test line 109 expects empty array |
| `should unsubscribe from events on dispose` | Authoring diagnostics persist after dispose | Test expects empty, gets 1 diagnostic |
| `should exclude muted diagnostics from getActive()` | Mute feature not filtering | Test expects 0 after mute, gets non-zero |
| `should include muted diagnostics with includeMuted` | includeMuted parameter ignored | Test expects filtering to work |
| `should restore diagnostic when unmuted` | Unmute not working | Unmuted diagnostics not restored |
| `should exclude muted diagnostics from getAll()` | getAll() not respecting muted | Should filter by default |
| `should include muted diagnostics in getAll()` | getAll() not using includeMuted param | Filter parameter ignored |

**Root Cause Analysis**:

1. **Authoring validation issue** (2 failures):
   - Test creates mock PatchStore with CycleTimeRoot block
   - DiagnosticHub still reports "Missing TimeRoot" diagnostic
   - Implementation issue: Validator may not recognize TimeRoot correctly
   - Location: DiagnosticHub.ts line 112, calls `runAuthoringValidators()`

2. **Dispose lifecycle issue** (1 failure):
   - Test at line 408-433 disposes hub then emits GraphCommitted
   - Expects authoring snapshot to be empty after dispose
   - Gets 1 diagnostic instead
   - Indicates: dispose() doesn't clear existing authoring snapshot, only unsubscribes

3. **Mute/Unmute feature incomplete** (5 failures):
   - Tests expect `muteDiagnostic()`, `unmuteDiagnostic()`, `isMuted()` methods
   - Tests expect `includeMuted` parameter on `getActive()` and `getAll()`
   - All mute-related tests failing suggests feature is either:
     - Not implemented at all, OR
     - Implemented but not integrated into query methods

**Evidence from DiagnosticHub.ts**:
- Line 62: `private mutedIds = new Set<string>();` - field exists
- Lines 99-104: `dispose()` method only clears unsubscribers, doesn't clear authoringSnapshot
- Need to check if `muteDiagnostic()`, `getActive()`, `getAll()` methods exist and work correctly

**Analysis**: This is **NOT a test expectation problem**. This is **missing/incomplete implementation**.

---

#### Bus Compilation Failures (7 failures)

All failures in `bus-compilation.test.ts` show same pattern:

```
AssertionError: expected false to be true
```

**Pattern**: Tests calling `expect(result.ok).toBe(true)` but getting `result.ok = false`.

This indicates compilation is FAILING when tests expect SUCCESS. Need to examine:
1. What errors are in `result.errors`?
2. Are test block registries incomplete?
3. Did compiler validation rules change?

**Evidence Needed**: Cannot determine root cause without seeing actual error messages. Test framework only shows "expected false to be true" which is useless.

**Next Steps**: Run tests with error output to see WHAT compilation errors are occurring.

---

#### Compositor Test Failures (9+ failures)

File: `src/editor/compositor/__tests__/compositor.test.ts`

**Pattern**: All failures related to compositor integration tests. Without reading full test file, cannot categorize.

**Likely causes**:
- Compositor API changed
- Test fixtures using old block schemas
- Integration with updated compiler

**Evidence needed**: Read test file to understand expectations.

---

#### ColorLFO Test Failures (3+ failures)

File: `src/editor/compiler/blocks/signal/__tests__/ColorLFO.test.ts`

**Pattern**: Unknown without full test output. First 80 lines showed test setup, not failures.

**Likely causes**:
- ColorLFO block changed
- Type signature mismatches
- Integration with updated signal types

**Evidence needed**: Full test output or read test file.

---

#### Event Dispatcher Failures (3+ failures)

File: `src/editor/events/__tests__/EventDispatcher.test.ts`

**Evidence**: Test output shows warnings about missing slots:
```
[PatchStore] Preflight validation warning: Output slot not found: block-7.value
```

This appears repeatedly across tests, suggesting:
- Test block definitions incomplete
- PatchStore validation stricter than test setup
- Mock blocks missing required outputs

**Analysis**: Tests may be using incomplete mock blocks that don't match current block schema requirements.

---

### Category 2: Tests Exposing Real Bugs (4-6 failures)

#### DiagnosticHub Authoring Validation (2 failures)

**Bug**: Validator not recognizing TimeRoot blocks correctly.

**Evidence**:
```typescript
// Test creates mock with TimeRoot (line 87-89)
{ id: 'block-1', type: 'CycleTimeRoot', label: 'TimeRoot', ... }

// Still creates E_TIME_ROOT_MISSING diagnostic
```

**Impact**: Users with valid TimeRoot blocks will see false "Missing TimeRoot" errors.

**Location**: DiagnosticHub.ts line 112 → `runAuthoringValidators()` → Validator implementation.

**Root cause hypothesis**: Validator may be checking for wrong block type names or using different TimeRoot detection logic.

---

#### DiagnosticHub Dispose Lifecycle (1 failure)

**Bug**: `dispose()` doesn't clear authoring snapshot.

**Expected behavior**: After dispose, hub should not respond to events AND should clear existing diagnostics.

**Actual behavior**: Unsubscribes from events (correct) but retains authoring snapshot (incorrect).

**Impact**: Disposed hubs leak diagnostic state.

**Fix**: Add `this.authoringSnapshot = []` to dispose() method.

---

#### DiagnosticHub Mute/Unmute (5 failures)

**Status**: Need to verify if feature is implemented.

**If not implemented**: These are "tests ahead of implementation" - common in TDD.

**If implemented but broken**: Real bugs in filtering logic.

**Evidence needed**: Read DiagnosticHub.ts to see if methods exist.

---

## Failure Dependency Analysis

### Independent Failures (can fix in any order)
- TimeRoot output schema mismatches (3 tests)
- ColorLFO tests (unknown count)
- Event Dispatcher slot validation warnings

### Dependent Failures
1. **DiagnosticHub authoring validation** blocks:
   - GraphCommitted test
   - Missing TimeRoot detection test
   - All tests that depend on authoring diagnostics being correct

2. **DiagnosticHub mute/unmute** blocks:
   - All 5 mute-related tests depend on core feature being implemented
   - Cannot fix tests until feature exists

3. **Bus compilation failures** may block:
   - Any tests depending on bus compilation working
   - Integration tests using buses

---

## What Could Not Be Verified

| Item | Why | User Can Check |
|------|-----|----------------|
| Actual bus compilation error messages | Test framework only shows `expect(true).toBe(false)` | Run `just test` and capture full error output, grep for "Bus Compilation" |
| DiagnosticHub mute methods existence | Did not read full implementation | Check DiagnosticHub.ts for `muteDiagnostic()`, `unmuteDiagnostic()`, `getActive(includeMuted)` |
| Compositor test expectations | Did not read compositor test file | Read `src/editor/compositor/__tests__/compositor.test.ts` |
| ColorLFO failure details | Only saw test setup, not failures | Grep test output for ColorLFO specific error messages |
| EventDispatcher test expectations | Only saw warnings, not assertions | Read `src/editor/events/__tests__/EventDispatcher.test.ts` |

---

## Runtime Assessment

**Status**: NOT PERFORMED - This evaluation focuses on TEST CODE, not runtime behavior.

**Rationale**: Test failures indicate test expectations vs implementation mismatch, not necessarily runtime bugs. To assess runtime:
1. Start dev server: `just dev`
2. Test TimeRoot blocks in UI
3. Verify bus publications work
4. Check diagnostic display

**Hypothesis**: Implementation is likely CORRECT (matches design docs), tests are STALE.

---

## Recommendations

### Priority 1: Quick Wins (Test Expectation Updates)
1. **Update TimeRoot test expectations** (3 tests)
   - File: `TimeRoot.test.ts`, `TimeRoot-WP1.test.ts`
   - Change: Add `phase` output to FiniteTimeRoot expected outputs
   - Change: Add `phaseA` and extra publications to auto-publication tests
   - Verification: Compare expectations against TimeRoot.ts implementation lines 34-47, 68-74

2. **Fix DiagnosticHub dispose** (1 test)
   - File: `DiagnosticHub.ts`
   - Change: Add `this.authoringSnapshot = []` to `dispose()` method
   - Verification: Test should pass immediately

### Priority 2: Investigation Required
3. **Diagnose bus compilation failures** (7 tests)
   - Action: Run tests with full error output
   - Look for: Actual compilation error messages in `result.errors`
   - Hypothesis: Test block registries may be incomplete
   - File: `bus-compilation.test.ts`

4. **Check DiagnosticHub mute implementation** (5 tests)
   - Action: Read DiagnosticHub.ts lines 200-300 (estimated location)
   - Question: Do `muteDiagnostic()`, `unmuteDiagnostic()`, `isMuted()` methods exist?
   - If NO: Tests are ahead of implementation, either implement feature or skip tests
   - If YES: Debug why filtering isn't working

5. **Fix authoring validation** (2 tests)
   - Action: Trace through Validator code
   - Find: How does it detect TimeRoot blocks?
   - Fix: Ensure it recognizes CycleTimeRoot, FiniteTimeRoot, InfiniteTimeRoot
   - File: Likely in `src/editor/semantic/` directory

### Priority 3: Full Test Suite Review
6. **Compositor tests** (9+ failures) - Need to read test file
7. **ColorLFO tests** (3+ failures) - Need test failure details
8. **EventDispatcher tests** (3+ failures) - Mock block schemas incomplete

---

## Ambiguities Found

| Area | Question Not Answered | How Implementation Guessed | Impact |
|------|----------------------|---------------------------|--------|
| TimeRoot auto-publications | Should FiniteTimeRoot publish to phaseA? | YES - added phaseA publication | Tests fail, unclear if intentional design change |
| InfiniteTimeRoot outputs | Should InfiniteTimeRoot have phase/pulse outputs? | YES - added both | Tests expect only energy, now get 3 outputs |
| Diagnostic mute feature | Is mute/unmute implemented? | Unknown - tests exist but may be ahead of impl | Cannot determine if bug or TDD scenario |
| Authoring validation | What exactly identifies a TimeRoot block? | Unknown - validator failing | False positives on "Missing TimeRoot" |

**Recommendation**: CONTINUE - Most issues are clear test expectation updates. The few unknowns require code inspection, not clarification.

---

## Workflow Recommendation

✅ **CONTINUE** - Issues are clear, implementer can fix

**Reasoning**:
- 90% of failures are straightforward test expectation updates
- 10% require code inspection but are well-defined problems
- No ambiguities in requirements - implementation vs test mismatch is clear
- Evidence points to implementation being CORRECT per design docs

**Next Actions**:
1. Update TimeRoot test expectations (30 min)
2. Fix dispose() to clear authoring snapshot (5 min)
3. Investigate bus compilation errors (capture full output)
4. Check if mute feature exists, implement or fix accordingly
5. Debug authoring validator TimeRoot detection

---

## Test Quality Assessment

**Overall**: Tests are reasonably comprehensive but suffering from maintenance lag.

**Strengths**:
- Good coverage (642 tests total)
- Tests for edge cases (negative time, wrap events, disposal)
- Separation of concerns (authoring vs compile vs runtime diagnostics)

**Weaknesses**:
- Test expectations not updated when implementation evolved
- Some tests may be written before implementation (TDD style) but feature not implemented yet
- Mock blocks in tests may not match current schema requirements

**Recommendation**: After fixing current failures, add:
1. Integration test that verifies TimeRoot auto-publications actually reach buses
2. Runtime test that confirms phase signals work correctly
3. Test that validates mock block schemas match real block requirements
