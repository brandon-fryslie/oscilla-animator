# Definition of Done - Test Fixes Sprint

**Generated**: 2025-12-23 06:00:00
**Source Plan**: PLAN-2025-12-23-060000.md
**Source STATUS**: STATUS-2025-12-23-045959.md

---

## Sprint Scope

**This sprint delivers**:
1. All P0 quick wins (test expectation updates + dispose fix)
2. DiagnosticHub mute/unmute feature implementation
3. Bus compilation test failures diagnosed and fixed

**Deferred**:
- DiagnosticHub authoring validation (P1.2) - Can live with false diagnostic temporarily
- Compositor integration tests (P2.1) - Lower priority integration tests
- ColorLFO block tests (P2.2) - Specific block, lower priority
- EventDispatcher mock schema issues (P2.3) - Test infrastructure cleanup

---

## Acceptance Criteria

### P0.1: Update TimeRoot Test Expectations

- [ ] `TimeRoot.test.ts:48` - FiniteTimeRoot expected output count updated from 4 to 5 (includes `phase` output)
- [ ] `TimeRoot-WP1.test.ts:258` - FiniteTimeRoot auto-publications include `{ busName: 'phaseA', artifactKey: 'phase', sortKey: 0 }`
- [ ] `TimeRoot-WP1.test.ts:275` - InfiniteTimeRoot auto-publications include `phaseA` and `pulse` publications
- [ ] All three TimeRoot tests pass without modifying implementation code
- [ ] Test expectations match actual TimeRoot.ts implementation (lines 34-47, 68-74)
- [ ] No implementation changes to TimeRoot.ts (tests updated only)

### P0.2: Fix DiagnosticHub Dispose Lifecycle

- [ ] `this.authoringSnapshot = []` added to DiagnosticHub.dispose() method
- [ ] `this.runtimeSnapshot = []` added to DiagnosticHub.dispose() method (if not already present)
- [ ] Test "should unsubscribe from events on dispose" passes
- [ ] Disposed hubs have zero diagnostics in both snapshots (verified by test)
- [ ] No regressions in other DiagnosticHub tests

### P1.1: Implement DiagnosticHub Mute/Unmute Feature

- [ ] `muteDiagnostic(id: string)` method adds diagnostic ID to `mutedIds` set
- [ ] `unmuteDiagnostic(id: string)` method removes diagnostic ID from `mutedIds` set
- [ ] `isMuted(id: string)` method returns boolean from `mutedIds.has(id)`
- [ ] `getActive(includeMuted = false)` filters out muted diagnostics when `includeMuted = false`
- [ ] `getActive(includeMuted = true)` includes muted diagnostics when `includeMuted = true`
- [ ] `getAll(includeMuted = false)` filters out muted diagnostics when `includeMuted = false`
- [ ] `getAll(includeMuted = true)` includes muted diagnostics when `includeMuted = true`
- [ ] Test "should exclude muted diagnostics from getActive()" passes
- [ ] Test "should include muted diagnostics with includeMuted" passes
- [ ] Test "should restore diagnostic when unmuted" passes
- [ ] Test "should exclude muted diagnostics from getAll()" passes
- [ ] Test "should include muted diagnostics in getAll()" passes
- [ ] All five mute-related tests pass

### P1.3: Diagnose and Fix Bus Compilation Test Failures

- [ ] Full error output captured from `result.errors` for all 7 failing tests
- [ ] Root cause identified: block registry incompleteness OR validation rule changes OR bus type issues
- [ ] Fix implemented based on root cause (test block definitions OR compiler logic OR test expectations)
- [ ] All 7 bus compilation tests in `bus-compilation.test.ts` pass
- [ ] No regressions in other compilation tests
- [ ] Root cause and fix strategy documented in commit message or PR description

---

## Sprint Success Criteria

**Minimum Viable** (must achieve):
- [ ] Test pass rate improves from 93.6% to at least 98% (35+ of 41 failures fixed)
- [ ] All P0 items (P0.1, P0.2) 100% complete
- [ ] At least one of P1.1 or P1.3 complete

**Stretch Goal**:
- [ ] Test pass rate reaches 100% (all 642 tests passing)
- [ ] All P0 items complete
- [ ] All P1 items (P1.1, P1.3) complete
- [ ] P2 items scoped for next sprint

---

## Quality Gates

- [ ] All fixes verified with `just check` (typecheck + lint + test all passing)
- [ ] No test expectation changes that contradict design docs in `design-docs/3-Synthesized/`
- [ ] No implementation changes that break existing functionality
- [ ] Manual smoke test in dev server (`just dev`) confirms:
  - [ ] TimeRoot blocks still work correctly
  - [ ] Bus publications visible in Bus Board
  - [ ] Diagnostics display correctly (no crashes)
- [ ] Code review confirms:
  - [ ] Implementation matches design docs where applicable
  - [ ] Test changes are expectation updates (not hiding bugs)
  - [ ] Mute/unmute feature API is simple and focused (no scope creep)

---

## Verification Commands

Run these to verify sprint completion:

```bash
# Full test suite
just test

# Type checking
just typecheck

# Linting
just lint

# Full check (all three above)
just check

# Manual verification
just dev
# Then test:
# 1. Add TimeRoot blocks to patch
# 2. Verify bus publications appear
# 3. Check diagnostic panel (no crashes)
```

---

## Exit Criteria

**Sprint is complete when**:
1. All acceptance criteria above are checked off
2. All quality gates pass
3. Test suite shows â‰¥98% pass rate (or 100% if stretch goal achieved)
4. Changes committed with clear commit messages explaining fixes

**Sprint is blocked if**:
- P1.3 investigation reveals architectural issues requiring multi-sprint fix
- Mute/unmute feature scope expands beyond core API (defer UI/persistence)
- Multiple P2 items reveal systemic test infrastructure problems

**Mitigation if blocked**:
- Timebox P1.3 investigation to 1 hour; defer if too large
- Limit P1.1 to core API methods only (no UI, no persistence)
- Document blockers and defer P2 items to dedicated test cleanup sprint

