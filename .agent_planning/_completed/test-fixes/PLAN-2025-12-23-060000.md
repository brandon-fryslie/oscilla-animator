# Test Fixes Sprint Plan

**Generated**: 2025-12-23 06:00:00
**Source STATUS**: STATUS-2025-12-23-045959.md
**Current State**: 41 failures / 598 passing (93.6% pass rate)
**Sprint Goal**: Achieve 100% test pass rate (642/642 passing)

---

## Executive Summary

**Current Reality** (per STATUS-2025-12-23-045959.md):
- 598 tests passing, 41 failing, 3 skipped
- **Root cause**: Implementation evolved per WP1 specification, tests assert against pre-WP1 expectations
- 90% of failures are **stale test expectations** (implementation is correct)
- 10% of failures expose **missing DiagnosticHub mute/unmute feature**

**Sprint Deliverables** (prioritized for maximum impact):
1. **Quick wins**: Update TimeRoot and bus test expectations (fixes 10+ failures in <1 hour)
2. **DiagnosticHub completion**: Implement missing mute/unmute feature (fixes 5 failures)
3. **Integration test cleanup**: Fix bus compilation, compositor, and event dispatcher tests (fixes remaining 20+ failures)

**Dependency Order**:
- P0 items are independent (can run in parallel)
- P1 items may depend on P0 completion
- P2 items are cleanup/polish

---

## Backlog by Priority

### P0 (Critical): Quick Wins - Test Expectation Updates

#### P0.1: Update TimeRoot Test Expectations

**Status**: Not Started
**Effort**: Small (30-60 minutes)
**Dependencies**: None
**Spec Reference**: design-docs/3-Synthesized/03-Buses.md (canonical bus auto-publication) • **Status Reference**: STATUS-2025-12-23-045959.md lines 33-66

**Description**:
Implementation correctly added `phase` output to all TimeRoot blocks and auto-publishes to `phaseA` and `pulse` buses per WP1 specification. Tests still expect pre-WP1 output schema.

**Root Cause Evidence** (from STATUS):
- TimeRoot.ts lines 34-47 shows all three TimeRoot types publish to `phaseA` and `pulse`
- Block definitions at lines 68-74 confirm FiniteTimeRoot has `phase` output
- Design docs specify phaseA as canonical bus
- Tests checking against older specification

**Acceptance Criteria**:
- [ ] `TimeRoot.test.ts:48` - Update FiniteTimeRoot expected output count from 4 to 5 (added `phase` output)
- [ ] `TimeRoot-WP1.test.ts:258` - Update FiniteTimeRoot auto-publications: add `{ busName: 'phaseA', artifactKey: 'phase', sortKey: 0 }` to expected array
- [ ] `TimeRoot-WP1.test.ts:275` - Update InfiniteTimeRoot auto-publications: add `phaseA` and `pulse` publications to expected array
- [ ] All three TimeRoot tests pass without modifying implementation code
- [ ] Test expectations match actual TimeRoot.ts implementation (lines 34-47, 68-74)

**Technical Notes**:
- Implementation is CORRECT per design docs - do NOT modify TimeRoot.ts
- Only update test expectations in test files
- Compare test expectations against `TimeRoot.autoPublications()` method implementation

**Files to Modify**:
- `src/editor/blocks/__tests__/TimeRoot.test.ts`
- `src/editor/compiler/blocks/domain/__tests__/TimeRoot-WP1.test.ts`

---

#### P0.2: Fix DiagnosticHub Dispose Lifecycle

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: None
**Spec Reference**: N/A (bug fix) • **Status Reference**: STATUS-2025-12-23-045959.md lines 206-217

**Description**:
`DiagnosticHub.dispose()` unsubscribes from events (correct) but does not clear the `authoringSnapshot` array, causing disposed hubs to leak diagnostic state.

**Root Cause Evidence** (from STATUS):
- Test at line 408-433 expects empty authoring snapshot after dispose
- DiagnosticHub.ts line 99-104 shows dispose() only clears unsubscribers
- Missing: `this.authoringSnapshot = []`

**Acceptance Criteria**:
- [ ] Add `this.authoringSnapshot = []` to DiagnosticHub.dispose() method
- [ ] Add `this.runtimeSnapshot = []` to DiagnosticHub.dispose() method (if not already present)
- [ ] Test `should unsubscribe from events on dispose` passes
- [ ] Verify no memory leaks: disposed hubs have zero diagnostics in snapshots
- [ ] No other tests regress

**Technical Notes**:
- Simple one-line fix in dispose() method
- May need to also clear runtimeSnapshot for consistency
- Check if any other state needs clearing (mutedIds set?)

**Files to Modify**:
- `src/editor/diagnostics/DiagnosticHub.ts`

---

### P1 (High): Missing Feature Implementation

#### P1.1: Implement DiagnosticHub Mute/Unmute Feature

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: None
**Spec Reference**: N/A (feature implementation) • **Status Reference**: STATUS-2025-12-23-045959.md lines 98-111, 219-228

**Description**:
Five tests expect mute/unmute functionality that is either not implemented or not integrated into query methods. Tests expect:
- `muteDiagnostic(id: string)` method
- `unmuteDiagnostic(id: string)` method
- `isMuted(id: string)` method
- `includeMuted: boolean` parameter on `getActive()` and `getAll()` methods

**Root Cause Evidence** (from STATUS):
- `private mutedIds = new Set<string>()` exists (line 62) but may not be used
- All 5 mute-related tests failing suggests feature incomplete
- Tests expect filtering behavior not currently working

**Acceptance Criteria**:
- [ ] `muteDiagnostic(id: string)` method adds diagnostic ID to `mutedIds` set
- [ ] `unmuteDiagnostic(id: string)` method removes diagnostic ID from `mutedIds` set
- [ ] `isMuted(id: string)` method returns boolean from `mutedIds.has(id)`
- [ ] `getActive(includeMuted = false)` filters out muted diagnostics by default, includes when `includeMuted = true`
- [ ] `getAll(includeMuted = false)` filters out muted diagnostics by default, includes when `includeMuted = true`
- [ ] Test "should exclude muted diagnostics from getActive()" passes
- [ ] Test "should include muted diagnostics with includeMuted" passes
- [ ] Test "should restore diagnostic when unmuted" passes
- [ ] Test "should exclude muted diagnostics from getAll()" passes
- [ ] Test "should include muted diagnostics in getAll()" passes

**Technical Notes**:
- `mutedIds` field already exists, just need to wire up methods
- Filtering logic: `diagnostics.filter(d => includeMuted || !this.mutedIds.has(d.id))`
- Consider if muted state should persist across dispose/recreate cycles
- May need to update DiagnosticHub.ts interface/type exports

**Files to Modify**:
- `src/editor/diagnostics/DiagnosticHub.ts`
- Possibly `src/editor/diagnostics/types.ts` (if method signatures need type exports)

---

#### P1.2: Fix DiagnosticHub Authoring Validation TimeRoot Detection

**Status**: Not Started
**Effort**: Medium (1-2 hours)
**Dependencies**: None
**Spec Reference**: design-docs/3-Synthesized/11-Roadmap.md WP0 (exactly-one-TimeRoot validation) • **Status Reference**: STATUS-2025-12-23-045959.md lines 186-202

**Description**:


**Root Cause Evidence** (from STATUS):

- Still creates `E_TIME_ROOT_MISSING` diagnostic
- Validator may be checking wrong block type names or using different detection logic

**Acceptance Criteria**:

- [ ] Test "should handle GraphCommitted events" passes (no false Missing TimeRoot diagnostic)
- [ ] Test "should not create missing TimeRoot diagnostic" passes
- [ ] Validator uses block type name matching (not label or other field)
- [ ] Add test case for each TimeRoot type to ensure all three are recognized

**Technical Notes**:
- Likely in `src/editor/semantic/` directory or validator module
- DiagnosticHub.ts line 112 calls `runAuthoringValidators()`
- Need to trace through validator implementation
- Check if validator is using outdated TimeRoot type names

**Files to Modify**:
- Likely `src/editor/semantic/validators.ts` or similar
- Possibly validator configuration/setup code

---

### P1 (High): Investigation Required

#### P1.3: Diagnose and Fix Bus Compilation Test Failures

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: May need P0.1 completion
**Spec Reference**: design-docs/3-Synthesized/03-Buses.md, 05-Compilation.md • **Status Reference**: STATUS-2025-12-23-045959.md lines 114-132

**Description**:
All 7 failures in `bus-compilation.test.ts` show pattern: `expect(result.ok).toBe(true)` but getting `result.ok = false`. Tests expect compilation SUCCESS but getting FAILURE. Test framework only shows "expected false to be true" without actual error messages.

**Root Cause Hypotheses**:
1. Test block registries incomplete (missing block definitions)
2. Compiler validation rules changed
3. Bus type validation stricter than test setup
4. TimeRoot auto-publication changes broke test assumptions

**Acceptance Criteria**:
- [ ] Run tests with full error output: capture actual `result.errors` content
- [ ] Identify root cause: block registry vs validation vs bus type issues
- [ ] Fix identified issue (may be test block definitions, compiler logic, or test expectations)
- [ ] All 7 bus compilation tests pass
- [ ] Verify fix doesn't break other compilation tests
- [ ] Document what changed and why tests failed

**Technical Notes**:
- First step: Run `just test bus-compilation` and capture full error output
- Look for: error codes in `result.errors`, missing block types, validation failures
- May need to update test block registries to match current schema
- Could be related to TimeRoot auto-publication changes (P0.1)

**Files to Modify**:
- `src/editor/compiler/__tests__/bus-compilation.test.ts` (likely test expectations or mock blocks)
- Possibly compiler validation logic if rules are incorrect

---

### P2 (Medium): Integration Test Cleanup

#### P2.1: Fix Compositor Integration Tests

**Status**: Not Started
**Effort**: Medium (2-4 hours)
**Dependencies**: May need P0.1, P1.3 completion
**Spec Reference**: design-docs/3-Synthesized/06-Runtime.md • **Status Reference**: STATUS-2025-12-23-045959.md lines 135-147

**Description**:
9+ failures in compositor integration tests. Likely causes: compositor API changed, test fixtures using old block schemas, integration with updated compiler.

**Root Cause Hypotheses**:
1. Compositor API evolved but tests use old interface
2. Test fixtures reference old TimeRoot or bus schemas
3. Integration with compiler changes from WP1

**Acceptance Criteria**:
- [ ] Read compositor test file to understand failure patterns
- [ ] Identify if failures are expectation mismatches or real bugs
- [ ] Update test expectations or fix compositor implementation as needed
- [ ] All compositor integration tests pass
- [ ] Verify compositor still works in dev environment (manual smoke test)
- [ ] Document any compositor API changes discovered

**Technical Notes**:
- Start by reading full test file: `src/editor/compositor/__tests__/compositor.test.ts`
- Check if tests depend on P0.1 (TimeRoot changes) or P1.3 (bus compilation)
- May reveal additional compositor bugs vs just test staleness

**Files to Modify**:
- `src/editor/compositor/__tests__/compositor.test.ts`
- Possibly `src/editor/compositor/compositor.ts` if bugs found

---

#### P2.2: Fix ColorLFO Test Failures

**Status**: Not Started
**Effort**: Small-Medium (1-2 hours)
**Dependencies**: None
**Spec Reference**: design-docs/3-Synthesized/09-Blocks.md (signal blocks) • **Status Reference**: STATUS-2025-12-23-045959.md lines 150-162

**Description**:
3+ failures in ColorLFO block tests. Likely causes: ColorLFO block changed, type signature mismatches, integration with updated signal types.

**Root Cause Hypotheses**:
1. ColorLFO block output schema changed
2. Signal type definitions evolved
3. Test expectations use old color type format

**Acceptance Criteria**:
- [ ] Capture full test output for ColorLFO failures
- [ ] Identify if failures are type mismatches, output schema changes, or logic bugs
- [ ] Update test expectations or fix ColorLFO implementation as needed
- [ ] All ColorLFO tests pass
- [ ] Verify ColorLFO block works correctly in manual testing (add to patch, observe output)

**Technical Notes**:
- Read test file: `src/editor/compiler/blocks/signal/__tests__/ColorLFO.test.ts`
- Check ColorLFO block definition for recent changes
- May be related to color type system updates

**Files to Modify**:
- `src/editor/compiler/blocks/signal/__tests__/ColorLFO.test.ts`
- Possibly ColorLFO block implementation if bugs found

---

#### P2.3: Fix EventDispatcher Mock Block Schema Issues

**Status**: Not Started
**Effort**: Medium (1-2 hours)
**Dependencies**: None
**Spec Reference**: N/A (test infrastructure) • **Status Reference**: STATUS-2025-12-23-045959.md lines 164-180

**Description**:
3+ failures in EventDispatcher tests with warnings: `[PatchStore] Preflight validation warning: Output slot not found: block-7.value`. Mock blocks in tests don't match current block schema requirements.

**Root Cause Evidence** (from STATUS):
- Repeated warnings about missing slots across tests
- Suggests test block definitions incomplete
- PatchStore validation stricter than test setup

**Acceptance Criteria**:
- [ ] Read EventDispatcher test file to identify all mock block definitions
- [ ] Update mock blocks to include all required outputs/inputs per current schema
- [ ] Eliminate all "slot not found" warnings in test output
- [ ] All EventDispatcher tests pass
- [ ] Verify mock blocks match real block schema requirements

**Technical Notes**:
- Mock blocks need to match current block registry schemas
- Check what slots are required for blocks used in tests
- May need to add missing input/output definitions to test block factories

**Files to Modify**:
- `src/editor/events/__tests__/EventDispatcher.test.ts`
- Test helper utilities if mock block factories exist

---

## Dependency Graph

```
P0.1 (TimeRoot expectations) ────┐
                                 ├──> P1.3 (Bus compilation)
P0.2 (Dispose fix) ───────────────┤
                                 └──> P2.1 (Compositor tests)
P1.1 (Mute/unmute) ──────────────┘

P1.2 (Authoring validation) ──> (independent)

P2.2 (ColorLFO) ──> (independent)
P2.3 (EventDispatcher) ──> (independent)
```

**Execution Strategy**:
1. **Start with P0 items** (parallel work, quick wins, builds confidence)
2. **Then P1.3** (may reveal dependencies on P0.1)
3. **Then P1.1, P1.2** (can run in parallel)
4. **Finally P2 items** (cleanup, may benefit from earlier fixes)

---

## Recommended Sprint Execution

### Sprint Scope (ONE Sprint Focus)

**Deliverables** (choose 2-3 max):
1. ✅ **All P0 items complete** (test expectation updates + dispose fix) - MUST HAVE
2. ✅ **P1.1 complete** (mute/unmute feature) - HIGH VALUE
3. ✅ **P1.3 complete** (bus compilation diagnosed and fixed) - HIGH IMPACT

**Deferred to Next Sprint**:
- P1.2 (authoring validation) - Can live with false diagnostic temporarily
- P2.1 (compositor tests) - Integration tests, lower priority
- P2.2 (ColorLFO) - Specific block, lower priority
- P2.3 (EventDispatcher) - Test infrastructure cleanup

**Rationale**:
- P0 items are trivial fixes (<1 hour total) with immediate impact (10+ tests fixed)
- P1.1 is a complete feature implementation (clean scope)
- P1.3 is investigation + fix (high impact on test count)
- Together: ~40-50% of failures fixed in one focused sprint

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Bus compilation failures reveal deeper compiler bugs | Medium | High | P1.3 investigation phase will reveal scope; can defer if too large |
| Mute/unmute feature scope creep (persistence, UI integration) | Medium | Medium | Limit to core API methods; defer UI/persistence to future work |
| Compositor tests depend on unfixed upstream issues | Low | Medium | P0 items fix likely dependencies; re-assess after P0 complete |
| Authoring validator fix touches too much validation logic | Medium | High | Well-scoped to TimeRoot detection only; limit blast radius |
| ColorLFO or EventDispatcher hide architectural issues | Low | Low | Isolated test failures, unlikely to block other work |

**High-Risk Items Needing Investigation**:
- P1.3 (bus compilation) - Unknown root cause, may reveal larger issues
- P1.2 (authoring validation) - Touches core validation logic

**Mitigation Strategy**:
- Start with P0 items (low risk, high confidence)
- P1.3 investigation phase is timboxed (1 hour to diagnose, decide if fixable in sprint)
- If P1.3 too large, defer and focus on P1.1 + P1.2 instead

---

## Success Metrics

**Sprint Success** (minimum viable):
- Test pass rate: 93.6% → 98%+ (at least 35 of 41 failures fixed)
- P0 items: 100% complete
- P1.1 or P1.3: At least one complete

**Stretch Goal**:
- Test pass rate: 100% (all 642 tests passing)
- All P0 + all P1 items complete
- P2 items started or scoped for next sprint

**Quality Gates**:
- No test expectation changes that contradict design docs
- No implementation changes that break existing functionality
- All fixes verified with `just check` (typecheck + lint + test)
- Manual smoke test in dev server after major fixes

---

## Open Questions

| Question | Impact if Not Resolved | Recommendation |
|----------|----------------------|----------------|
| Should FiniteTimeRoot publish to phaseA bus? | Tests unclear on intent | RESOLVED: Yes per design docs, tests are stale |
| Is mute/unmute feature in scope for this release? | 5 tests may be premature | Implement basic API, defer UI/persistence |
| What changed in bus compilation validation? | Can't fix P1.3 without knowing | Investigation phase required (1 hour timebox) |
| Are compositor tests integration or unit tests? | Determines fix strategy | Read test file to assess scope |

**No Blockers**: Proceed with sprint. All questions answerable through investigation.

---

## Execution Tracking

**First-Pass Estimate** (complexity-based, NOT time):
- P0.1: XS (trivial test updates)
- P0.2: XS (one-line fix)
- P1.1: M (feature implementation, clear scope)
- P1.2: M (validation logic, clear scope)
- P1.3: M-L (investigation + fix, unknown scope)
- P2.1: M-L (integration tests, unknown scope)
- P2.2: S-M (block tests, likely simple)
- P2.3: S-M (test infrastructure, likely simple)

**Sprint Capacity Recommendation**:
Focus on P0 + P1.1 + P1.3 investigation. Re-assess after P0 complete.

