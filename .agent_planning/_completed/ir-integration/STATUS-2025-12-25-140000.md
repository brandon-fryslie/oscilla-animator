# Status: Phase 2 IR Data Structures Integration
Generated: 2025-12-25-140000
Source: Gap analysis from conversation

## Overview

Phase 2 IR Data Structures from `.worktrees/2-ir-data-structures/` need to be integrated into the main branch. The worktree contains key schemas that implement the "Program as Data" philosophy but are NOT present on the current branch.

## Current State

### Branch Structure
- **Current branch:** `new-local`
- **Source worktree:** `.worktrees/2-ir-data-structures/src/ir/`
- **Target location:** `src/editor/compiler/ir/` (existing) or new location

### What EXISTS on current branch (`src/editor/compiler/ir/`):

| File | Contents | Status |
|------|----------|--------|
| `types.ts` | TypeDesc, TypeWorld, TypeDomain, ValueSlot, NodeIndex | COMPLETE |
| `schedule.ts` | ScheduleIR, StepIR variants, TimeModelIR, CachingIR | COMPLETE |
| `program.ts` | CompiledProgramIR, NodeTable, BusTable, ConstPool | COMPLETE |
| `stores.ts` | ValueStore, StateBuffer, StateLayout | COMPLETE |

### What's MISSING (in worktree but not on branch):

| File | Critical Types | Status |
|------|---------------|--------|
| `signal-expr.ts` | SignalExprIR, SignalExprTable, StatefulSignalOp | NOT INTEGRATED |
| `opcode.ts` | OpCode enum (50+ opcodes), OPCODE_REGISTRY, OpCodeMeta | NOT INTEGRATED |
| `transform.ts` | TransformChainIR, TransformStepIR, PureFnRef, CastOp | NOT INTEGRATED |
| `const-pool.ts` | DefaultSourceTable, DefaultSourceIR, UIControlHint | NOT INTEGRATED |
| `core.ts` | SigExprId, FieldExprId, TransformChainId | NOT INTEGRATED |

## Gap Analysis

### Critical Missing Schemas

1. **SignalExprIR** (`signal-expr.ts`)
   - 12 expression kinds: const, timeAbsMs, timeModelMs, phase01, wrapEvent, inputSlot, map, zip, select, transform, busCombine, stateful
   - StatefulSignalOp: integrate, delayMs, delayFrames, sampleHold, slew, edgeDetectWrap
   - CombineSpec and CombineMode

2. **OpCode Registry** (`opcode.ts`)
   - 50+ opcodes organized by category (time, math, vec, color, state, domain, field, render, transform)
   - Full metadata registry with inputTypes, outputType, purity classification
   - Essential for runtime dispatch tables

3. **TransformChainIR** (`transform.ts`)
   - TransformTable with chains array
   - TransformStepIR: cast, map, scaleBias, normalize, quantize, ease, slew
   - CastOp for type conversions
   - PureFnRef for opcode or kernel references

4. **DefaultSourceTable** (`const-pool.ts`)
   - Replaces old params system
   - DefaultSourceIR with valueRef (const or expr)
   - UIControlHint for editor integration

### Type Compatibility Notes

The worktree uses a different TypeDesc structure than current branch:
- Worktree: `{ world, domain, category, busEligible }`
- Current: `{ world, domain, semantics?, unit? }`

**Resolution:** Adapt worktree types to use current branch TypeDesc structure.

## Dependencies

1. Current `types.ts` TypeDesc must remain compatible
2. `program.ts` CompiledProgramIR references these tables
3. `schedule.ts` CombineSpec may need reconciliation

## Risks

1. **Type conflicts** - Different TypeDesc structures
2. **Import paths** - Worktree uses `../editor/types`, current uses local
3. **Test coverage** - Worktree tests exist in `__tests__/` but may need path updates

## Verdict: CONTINUE

The integration is well-scoped and the gap analysis is complete. No blockers identified.
