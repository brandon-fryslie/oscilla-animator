# Definition of Done: Phase 2 IR Data Structures Integration
Generated: 2025-12-25-140000
Plan: PLAN-2025-12-25-140000.md

## Acceptance Criteria

### Deliverable 1: SignalExprIR and OpCode Registry

- [ ] Create `src/editor/compiler/ir/signalExpr.ts`
  - [ ] Export `SignalExprTable` interface with `nodes: SignalExprIR[]`
  - [ ] Export `SignalExprIR` discriminated union with 12 variants:
    - const, timeAbsMs, timeModelMs, phase01, wrapEvent, inputSlot
    - map, zip, select, transform, busCombine, stateful
  - [ ] Export `StatefulSignalOp` type (integrate, delayMs, delayFrames, sampleHold, slew, edgeDetectWrap)
  - [ ] All variants include `type: TypeDesc`
  - [ ] Stateful variant includes `stateId: StateId`

- [ ] Create `src/editor/compiler/ir/opcodes.ts`
  - [ ] Export `OpCode` const object with 50+ opcodes
  - [ ] Export `OpCodeCategory` type (time, math, vec, color, state, domain, field, render, transform)
  - [ ] Export `OpCodePurity` type (pure, stateful, io)
  - [ ] Export `OpCodeMeta` interface with opcode, name, category, inputTypes, outputType, purity
  - [ ] Export `OPCODE_REGISTRY: Record<OpCode, OpCodeMeta>` with all entries

- [ ] Run `just typecheck` - no errors in new files
- [ ] Run `just test` - no regressions

### Deliverable 2: TransformChainIR and DefaultSourceTable

- [ ] Create `src/editor/compiler/ir/transforms.ts`
  - [ ] Export `TransformTable` interface with `chains: TransformChainIR[]`
  - [ ] Export `TransformChainIR` with steps, fromType, toType, cost
  - [ ] Export `TransformStepIR` discriminated union (cast, map, scaleBias, normalize, quantize, ease, slew)
  - [ ] Export `CastOp` type (numberToVec2, vec2ToNumber, colorToVec3, etc.)
  - [ ] Export `PureFnRef` type with opcode and kernel variants

- [ ] Create `src/editor/compiler/ir/defaultSources.ts`
  - [ ] Export `DefaultSourceTable` interface with `sources: DefaultSourceIR[]`
  - [ ] Export `DefaultSourceIR` with id, targetBlockIndex, targetPortIndex, valueRef
  - [ ] Export `ValueRef` discriminated union (const, expr)
  - [ ] Export `UIControlHint` union type (slider, number, select, color, boolean, text, xy)

- [ ] Run `just typecheck` - no errors in new files

### Deliverable 3: Update Exports and Types

- [ ] Update `src/editor/compiler/ir/types.ts`
  - [ ] Add `SigExprId = number` type
  - [ ] Add `FieldExprId = number` type
  - [ ] Add `TransformChainId = number` type

- [ ] Update `src/editor/compiler/ir/index.ts`
  - [ ] Export all types from `signalExpr.ts`
  - [ ] Export all types from `opcodes.ts`
  - [ ] Export all types from `transforms.ts`
  - [ ] Export all types from `defaultSources.ts`

- [ ] Update `src/editor/compiler/ir/program.ts` (optional)
  - [ ] Reference real SignalExprTable instead of placeholder (if compatible)

- [ ] Run `just check` - full check passes (typecheck + lint + test)

---

## Verification Commands

```bash
# After each file creation
just typecheck

# Final verification
just check

# Quick lint check
pnpm exec eslint src/editor/compiler/ir/*.ts
```

## Success Criteria

- 4 new files created in `src/editor/compiler/ir/`
- All types compile without errors
- `just check` passes
- No runtime changes required
