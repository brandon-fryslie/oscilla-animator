# Definition of Done: RenderInstances3D Block Implementation

**Generated:** 2025-12-28-042409
**Plan:** PLAN-2025-12-28-042409.md
**Scope:** Sprint deliverables for RenderInstances3D block

---

## Sprint Scope

This sprint delivers the RenderInstances3D block that connects 3D domain data to the existing 2D canvas renderer via the projection infrastructure.

**Deliverables:**
1. RenderInstances3D block type definition with lowering
2. Render sink handler integration for 3D projection
3. Test coverage for block lowering and error cases

**Deferred:**
- Advanced projection options as user-configurable inputs
- Mesh input support
- Rotation/scale field support
- Inspector preview widgets

---

## Acceptance Criteria

### Deliverable 1: RenderInstances3D Block Definition

**File:** `src/editor/compiler/blocks/domain/RenderInstances3D.ts`

- [ ] Block type registered via `registerBlockType()` with capability `'render'`
- [ ] Input port `domain` declared as Special<domain>
- [ ] Input port `positions3d` declared as Field<vec3>
- [ ] Input port `color` declared as Field<color>
- [ ] Input port `radius` declared as Field<number> (accepts Signal<number>)
- [ ] Input port `opacity` declared as Signal<number>
- [ ] Input port `camera` declared as Special<camera>, marked optional
- [ ] No output ports (render sink pattern)
- [ ] `lowerRenderInstances3D` function validates domain is Special<domain>, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function validates positions3d is Field<vec3>, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function validates color is Field<color>, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function validates radius is Field or Signal, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function validates opacity is Signal<number>, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function validates camera (if provided) is Special<camera>, throws descriptive error otherwise
- [ ] `lowerRenderInstances3D` function calls `ctx.b.renderSink('instances3d', sinkInputs)` with all input slots
- [ ] `lowerRenderInstances3D` function returns `{ outputs: [], declares: { renderSink: { sinkId: 0 } } }`
- [ ] Sink inputs use `domain.id` for special domain type
- [ ] Sink inputs use `.slot` property for field/signal types
- [ ] Sink inputs include `camera: camera?.id` (undefined if not provided)
- [ ] File exports block type for module registration

### Deliverable 2: Render Sink Handler

**File:** TBD (located during investigation - likely IRBuilderImpl or render pass)

- [ ] Investigation completed: located existing `renderSink()` handler implementation
- [ ] Investigation completed: understood color field splitting mechanism from RenderInstances2D
- [ ] Added `'instances3d'` case to render sink dispatcher/handler
- [ ] Handler allocates output ValueSlot for Instance2DBufferRef result
- [ ] Handler extracts all input slots (domain, positions3d, color, radius, opacity, camera)
- [ ] Handler splits Field<color> into 4 separate materialization slots (colorR, colorG, colorB, colorA)
- [ ] Handler constructs StepInstances3DProjectTo2D with all required fields:
  - [ ] `kind: 'Instances3DProjectTo2D'`
  - [ ] `id: <unique step id>`
  - [ ] `domainSlot: <from domain input>`
  - [ ] `cameraEvalSlot: <from camera input or undefined>`
  - [ ] `positionSlot: <from positions3d input>`
  - [ ] `colorRSlot, colorGSlot, colorBSlot, colorASlot: <from split color>`
  - [ ] `radiusSlot: <from radius input>`
  - [ ] `zSort: true` (default)
  - [ ] `cullMode: 'frustum'` (default)
  - [ ] `clipMode: 'discard'` (default)
  - [ ] `sizeSpace: 'px'` (default)
  - [ ] `outSlot: <allocated output slot>`
- [ ] Handler registers step in render phase of schedule
- [ ] Handler handles `camera: undefined` case (pass8 will inject default camera)
- [ ] No errors when camera input is omitted (optional input semantics)

### Deliverable 3: Test Coverage

**File:** `src/editor/compiler/blocks/domain/__tests__/RenderInstances3D.test.ts`

**Unit Tests:**
- [ ] Test: Block lowers successfully with all inputs provided
- [ ] Test: Block lowers successfully with camera omitted (undefined)
- [ ] Test: Error thrown with descriptive message if domain is not Special<domain>
- [ ] Test: Error thrown with descriptive message if positions3d is not Field
- [ ] Test: Error thrown with descriptive message if color is not Field
- [ ] Test: Error thrown with descriptive message if radius is neither Field nor Signal
- [ ] Test: Error thrown with descriptive message if opacity is not Signal
- [ ] Test: Error thrown with descriptive message if camera is provided but not Special<camera>
- [ ] Test: `ctx.b.renderSink` called with correct sink kind `'instances3d'`
- [ ] Test: Sink inputs contain correct slot IDs/indices from input refs
- [ ] Test: Return value has empty outputs array
- [ ] Test: Return value declares renderSink

**Integration Tests:**
- [ ] Test: Block integrates with Camera block output (CameraRef connects)
- [ ] Test: Block integrates with Domain outputs (DomainN)
- [ ] Test: Block integrates with Field<vec3> from spatial operators
- [ ] Test: Block integrates with Field<color> from color operators

**End-to-End Test:**
- [ ] Test: Full pipeline from Camera + Domain → RenderInstances3D compiles to IR
- [ ] Test: Compiled IR includes CameraIR in program.cameras table
- [ ] Test: Compiled IR includes StepInstances3DProjectTo2D in schedule
- [ ] Test: Schedule execution produces Instance2DBufferRef
- [ ] Test: Instance2DBufferRef has correct structure (x, y, r, g, b, a, s, z, alive arrays)
- [ ] Test: Projected x/y coordinates are in valid screen space range
- [ ] Test: RGBA channels populated from color field

---

## Integration Validation

### Build & Type Safety
- [ ] TypeScript compiles without errors (`just typecheck`)
- [ ] No new linter warnings (`just lint`)
- [ ] All tests pass (`just test`)
- [ ] Full check passes (`just check`)

### Runtime Integration
- [ ] Block appears in block registry after import
- [ ] Block can be instantiated in patch (if UI layer exists)
- [ ] Compilation to IR succeeds with valid inputs
- [ ] Execution produces Instance2DBufferRef in correct ValueSlot
- [ ] Output connects to existing 2D Canvas renderer (assembleInstanceBuffers)

### Error Handling
- [ ] Clear, actionable error messages for invalid domain input
- [ ] Clear, actionable error messages for invalid positions3d input
- [ ] Clear, actionable error messages for invalid color input
- [ ] Clear, actionable error messages for invalid radius input
- [ ] Clear, actionable error messages for invalid camera input
- [ ] Errors include block type name and port ID for debugging

### Default Camera Injection
- [ ] Works correctly when camera input is omitted (pass8 injects default)
- [ ] Works correctly when camera input is explicitly provided
- [ ] No runtime errors if no cameras defined in program (default camera created)
- [ ] Error message if camera input is invalid type (not Special<camera>)

---

## Documentation

- [ ] File header comment explains purpose: "RenderInstances3D Block Compiler"
- [ ] File header references design docs (07-3d-Canonical.md, 06-3d-IR-Deltas.md)
- [ ] Inline comments explain validation logic
- [ ] Inline comments explain sink input mapping (domain.id vs .slot)
- [ ] Test file includes descriptive test names
- [ ] Test file includes comments for non-obvious test cases

---

## Code Quality

- [ ] Follows existing RenderInstances2D pattern closely
- [ ] Follows Camera block pattern for validation
- [ ] No code duplication (reuse validation helpers if available)
- [ ] No hardcoded magic numbers (use constants for defaults)
- [ ] Consistent naming (camelCase, descriptive)
- [ ] No console.log or debug statements
- [ ] No commented-out code
- [ ] Proper error messages (no generic "Invalid input")

---

## Performance

- [ ] No unnecessary allocations in lowering function (block lowering runs at compile time)
- [ ] Efficient input validation (early exit on first error)
- [ ] Color field split happens once (not per element)
- [ ] ValueSlots used correctly (references, not inline data)

---

## Sprint Success Metrics

**Minimum viable:**
- RenderInstances3D block defined and registered
- Block lowers with valid inputs
- Render sink handler emits StepInstances3DProjectTo2D
- Basic unit tests pass

**Full success:**
- All acceptance criteria met
- Integration tests pass
- End-to-end test validates full 3D → 2D pipeline
- No regressions in existing tests
- TypeScript/lint clean

**Stretch goals (not required):**
- Inspector UI integration (vec3 control)
- Manual smoke test in running app
- Performance benchmarks

---

## Known Limitations (Accepted for MVP)

- Projection options (zSort, cullMode) are hardcoded, not user-configurable
- No mesh input support (deferred to future sprint)
- No rotation/scale field support (positions only)
- No preview widget in Inspector
- No visual gizmos for 3D manipulation
- Color field splitting implementation may be naive (optimize if needed)

---

## Next Steps (Post-Sprint)

After this sprint is complete and validated:

1. **UI Integration:** Add vec3 control to Inspector for positions3d input
2. **Mesh Support:** Add mesh input port, connect to MeshStore
3. **Advanced Options:** Expose projection options as block inputs
4. **Transform Support:** Add rotation/scale field inputs
5. **Preview Widgets:** Add camera frustum preview, 3D gizmo
6. **Performance:** Optimize color channel splitting, buffer reuse
7. **Documentation:** User-facing docs for 3D rendering workflow

---

## Sign-Off Checklist

Before marking sprint complete:

- [ ] All deliverable acceptance criteria met
- [ ] All integration validation passed
- [ ] Code reviewed (self or peer)
- [ ] Tests documented and passing
- [ ] No known blocking issues
- [ ] Ready for next sprint (Mesh support or UI integration)
