# Status: Phase 3 IR Integration
Generated: 2025-12-25T16:00:00

## Current State

### Existing IR Infrastructure (from Phase 2)
The current branch has comprehensive IR type definitions:

1. **`ir/types.ts`** - Core type system (TypeDesc, TypeWorld, TypeDomain, dense indices)
2. **`ir/signalExpr.ts`** - SignalExprIR with 12 variants (const, timeAbsMs, phase01, map, zip, select, etc.)
3. **`ir/transforms.ts`** - TransformChainIR, TransformStepIR (7 step types)
4. **`ir/schedule.ts`** - TimeModelIR, ScheduleIR, StepIR variants (timeDerive, nodeEval, busEval, etc.)
5. **`ir/program.ts`** - CompiledProgramIR, NodeTable, BusTable, ConstPool
6. **`ir/stores.ts`** - ValueStore, StateBuffer, StateLayout
7. **`ir/opcodes.ts`** - OpCode enum with 50+ opcodes
8. **`ir/defaultSources.ts`** - DefaultSourceTable, UIControlHint
9. **`ir/index.ts`** - Barrel exports

### Phase 3 Worktree Content
The `.worktrees_recovered/3-bridge-compiler/` contains:

1. **`ir/IRBuilder.ts`** - Interface for fluent IR construction (217 lines)
2. **`ir/IRBuilderImpl.ts`** - Implementation with constant deduplication (395 lines)
3. **`ir/schema.ts`** - Alternative type schema (578 lines) - OVERLAPS with existing types
4. **`ir/__tests__/builder.test.ts`** - Comprehensive tests (387 lines)
5. **`passes/pass1-normalize.ts`** - First compilation pass (92 lines)
6. **`passes/__tests__/pass1-normalize.test.ts`** - Pass 1 tests (366 lines)

## Gap Analysis

### NEEDED: IRBuilder Pattern
The worktree provides a fluent builder API that doesn't exist on the current branch:
- `allocSigExprId()`, `allocFieldExprId()`, `allocStateId()`, `allocConstId()`
- `sigConst()`, `sigTimeAbsMs()`, `sigPhase01()`, `sigMap()`, `sigZip()`
- `fieldConst()`, `fieldMap()`, `fieldZip()`, `broadcastSigToField()`
- `transformChain()`, `renderSink()`, `build()`

### NEEDED: Patch Transformation Types
The worktree defines intermediate compilation types not on current branch:
- `NormalizedPatch` - Output of Pass 1 with frozen block IDs
- `TypedPatch` - Output of Pass 2 with type assignments
- `TimeResolvedPatch` - Output of Pass 3 with time topology
- `DefaultSourceAttachment` - For unwired input handling

### NEEDED: Dependency Graph Types
- `DepNode`, `DepEdge`, `DepGraph` - For Pass 4
- `SCC`, `AcyclicOrLegalGraph` - For Pass 5 cycle validation

### NEEDED: Compilation Passes
- `pass1-normalize.ts` - First pass that normalizes patch structure
- Tests for pass1

### TYPE CONFLICTS to Resolve
The worktree `schema.ts` has different type definitions:
1. **Branded ID types** - schema.ts uses `number & { __brand }` pattern
2. **TypeDesc structure** - schema.ts adds `category` and `busEligible` fields
3. **SignalExprIR** - Uses `trueBranch/falseBranch` vs current `t/f`
4. **TransformStepIR** - Different structure (simpler in worktree)

### Resolution Strategy
Adapt the IRBuilder to use existing types from Phase 2 while adding new patch transformation types.

## What's Working
- All existing tests pass (1015 tests)
- Typecheck passes
- IR type definitions are comprehensive

## What's Missing
1. IRBuilder interface and implementation
2. Patch transformation types for compilation pipeline
3. Dependency graph types
4. Pass 1 implementation
5. Builder and Pass 1 tests
