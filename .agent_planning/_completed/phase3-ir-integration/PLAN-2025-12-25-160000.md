# Sprint Plan: Phase 3 IR Integration
Generated: 2025-12-25T16:00:00

## Sprint Goal
Integrate IRBuilder pattern and Pass 1 normalization from Phase 3 worktree, adapting to existing type system.

## Scope
**In scope (this sprint):**
1. IRBuilder interface and implementation (adapted for existing types)
2. Patch transformation types (NormalizedPatch, TypedPatch, TimeResolvedPatch)
3. Pass 1 normalization implementation

**Explicitly out of scope (future sprints):**
- Passes 2-11 (Type Graph, Time Topology, Dependency Graph, etc.)
- IR Validator
- Dual-emit compiler integration
- Full CompiledProgramIR population

## Work Items

### P0: IRBuilder Interface and Implementation
Adapt the IRBuilder pattern from worktree to work with existing type definitions.

**Files to create:**
- `src/editor/compiler/ir/IRBuilder.ts` - Interface
- `src/editor/compiler/ir/IRBuilderImpl.ts` - Implementation
- `src/editor/compiler/ir/__tests__/builder.test.ts` - Tests

**Acceptance Criteria (REQUIRED):**
- [ ] IRBuilder interface exports signal expression builders (sigConst, sigTimeAbsMs, sigPhase01, sigMap, sigZip, sigSelect)
- [ ] IRBuilder interface exports field expression builders (fieldConst, fieldMap, fieldZip, fieldSelect, broadcastSigToField)
- [ ] IRBuilder interface exports ID allocation methods (allocSigExprId, allocFieldExprId, allocStateId, allocConstId, allocValueSlot)
- [ ] IRBuilderImpl deduplicates constant values
- [ ] IRBuilderImpl.build() produces valid structure with signalExprs, fieldExprs, constants, stateLayout
- [ ] All builder tests pass

**Technical Notes:**
- Use existing `SignalExprIR` from `signalExpr.ts` (with t/f naming)
- Use existing `TypeDesc` from `types.ts`
- Builder will need adapted type definitions for FieldExprIR since current branch focuses on SignalExprIR

### P1: Patch Transformation Types
Add the intermediate patch types needed for the compilation pipeline.

**Files to modify:**
- `src/editor/compiler/ir/program.ts` or new file `src/editor/compiler/ir/patches.ts`

**Types to add:**
- `TypedPatch` - Extends NormalizedPatch with type assignments
- `TimeResolvedPatch` - Extends TypedPatch with time topology
- `DefaultSourceAttachment` - For unwired input handling
- Dependency graph types: `DepNode`, `DepEdge`, `DepGraph`, `SCC`, `AcyclicOrLegalGraph`

**Acceptance Criteria (REQUIRED):**
- [ ] TypedPatch extends NormalizedPatch with busTypes and conversionPaths
- [ ] TimeResolvedPatch extends TypedPatch with timeModel and timeRootIndex
- [ ] Dependency graph types are defined for Pass 4-5
- [ ] Types are exported from ir/index.ts

**Technical Notes:**
- Consider whether to use existing `Block`, `Connection`, etc. from `../../types` or create IR-specific versions
- Align with HANDOFF.md specifications

### P2: Pass 1 - Normalize Patch
Implement the first compilation pass that normalizes a patch for further processing.

**Files to create:**
- `src/editor/compiler/passes/pass1-normalize.ts`
- `src/editor/compiler/passes/__tests__/pass1-normalize.test.ts`
- `src/editor/compiler/passes/index.ts` (barrel export)

**Acceptance Criteria (REQUIRED):**
- [ ] pass1Normalize function takes a Patch and returns NormalizedPatch
- [ ] Block IDs are frozen to indices in stable sorted order
- [ ] All pass1 tests pass

**Technical Notes:**
- Adapt to use types from `../../types` (Patch, Block, Connection, etc.)
- Match the worktree implementation structure but adapt for current type system

## Dependencies
- Phase 2 IR types must be complete (they are)
- TypeScript compilation must pass before and after
- All existing tests must continue to pass

## Risks
1. **Type Incompatibility**: Worktree uses different TypeDesc structure (with category/busEligible). Mitigation: Adapt builder to use existing types.
2. **Patch Type Misalignment**: Worktree references `Patch` type that may differ. Mitigation: Carefully map to existing `../../types` definitions.
3. **Test Import Paths**: Test files may need different imports. Mitigation: Verify import paths during integration.

## Verification
After integration:
```bash
just typecheck  # Must pass
just test       # All tests must pass (1015+)
```
