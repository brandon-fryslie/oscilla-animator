# Definition of Done: Phase 3 IR Integration
Generated: 2025-12-25T16:00:00

## P0: IRBuilder Interface and Implementation

### Required Criteria
- [ ] IRBuilder interface exists at `src/editor/compiler/ir/IRBuilder.ts`
- [ ] IRBuilderImpl class exists at `src/editor/compiler/ir/IRBuilderImpl.ts`
- [ ] Signal expression builders: sigConst, sigTimeAbsMs, sigPhase01, sigMap, sigZip, sigSelect
- [ ] Field expression builders: fieldConst, fieldMap, fieldZip, fieldSelect, broadcastSigToField
- [ ] ID allocation: allocSigExprId, allocFieldExprId, allocStateId, allocConstId, allocValueSlot
- [ ] Constant deduplication works (identical values return same constId)
- [ ] build() returns valid IR structure
- [ ] Tests exist at `src/editor/compiler/ir/__tests__/builder.test.ts`
- [ ] All builder tests pass

## P1: Patch Transformation Types

### Required Criteria
- [ ] NormalizedPatch type defined with:
  - blockIndexMap: Map<BlockId, BlockIndex>
  - blocks, wires, publishers, listeners, buses
  - defaultSources: DefaultSourceAttachment[]
- [ ] TypedPatch type extends NormalizedPatch with busTypes and conversionPaths
- [ ] TimeResolvedPatch type extends TypedPatch with timeModel, timeRootIndex, timeSignals
- [ ] Dependency graph types: DepNode, DepEdge, DepGraph
- [ ] Cycle validation types: SCC, AcyclicOrLegalGraph
- [ ] All types exported from ir/index.ts
- [ ] TypeScript compiles without errors

## P2: Pass 1 - Normalize Patch

### Required Criteria
- [ ] pass1Normalize function exists at `src/editor/compiler/passes/pass1-normalize.ts`
- [ ] Function signature: `pass1Normalize(patch: Patch): NormalizedPatch`
- [ ] Block IDs frozen to indices in sorted order
- [ ] Default sources attached for unwired inputs without listeners
- [ ] Publishers filtered (enabled only) and sorted (sortKey, then id)
- [ ] Listeners filtered (enabled only)
- [ ] Tests exist at `src/editor/compiler/passes/__tests__/pass1-normalize.test.ts`
- [ ] All pass1 tests pass

## Global Verification

### Required Criteria
- [ ] `just typecheck` passes
- [ ] `just test` passes (all 1015+ tests)
- [ ] No new lint errors introduced
