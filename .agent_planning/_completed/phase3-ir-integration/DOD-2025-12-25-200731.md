# Definition of Done: Phase 3 Bridge Compiler - Sprint 2

Generated: 2025-12-25-200731
Plan: PLAN-2025-12-25-200731.md
Scope: Dual-Emit Compilation + IR Validation (Passes 6-8 + Validator)

---

## Sprint 2 Scope

This sprint delivers dual-emit compilation where `compileBusAware.ts` emits both legacy closures (for execution) AND IR nodes (for validation). The IR is structural only - not yet executable.

**Deliverables:** 6 P0 items (Passes 6-8, Integration, Validator Core + Integration), 2 P1 items (Golden Patch Test, Documentation)

**Deferred:** Block compiler migration (Phase 4), IR executor (Phase 4), Passes 9-11 (Sprint 3)

---

## Acceptance Criteria

### P0-1: Pass 6 - Block Lowering Infrastructure

- [ ] Function `pass6BlockLowering(validated: AcyclicOrLegalGraph, compiledPortMap: Map<string, Artifact>): UnlinkedIRFragments` exists in `src/editor/compiler/passes/pass6-block-lowering.ts`
- [ ] IRBuilder instance is created and passed through compilation context
- [ ] For each block in dependency order, create IR node representing its output
- [ ] Artifact-to-IR mapping for basic types: `Scalar:number` → `sigConst`, `Signal:number` → placeholder `sigOp`
- [ ] UnlinkedIRFragments structure includes: `builder: IRBuilder`, `blockOutputs: Map<BlockIndex, ValueRefPacked[]>`, `errors: CompileError[]`
- [ ] Pass preserves existing closure compilation - closures still work exactly as before
- [ ] Test suite `pass6-block-lowering.test.ts` with minimum 8 tests covering artifact types
- [ ] Integration test confirms pass runs without breaking existing compilation

---

### P0-2: Pass 7 - Bus Lowering to IR

- [ ] Create `sigCombine` or `fieldCombine` node based on bus type (Signal vs Field)
- [ ] Handle empty buses: use bus.defaultValue as constant node
- [ ] IRWithBusRoots structure includes: `builder: IRBuilder`, `busRoots: Map<BusIndex, ValueRefPacked>`, `errors: CompileError[]`
- [ ] Test verifies Signal buses use Signal combine modes (sum, last)
- [ ] Test verifies Field buses use Field combine modes (sum, average, max, min, last)

---

### P0-3: Pass 8 - Link Resolution

- [ ] Create `BlockInputRootIR` table mapping (blockIdx, inPortIdx) → ValueRefPacked
- [ ] Create `BlockOutputRootIR` table mapping (blockIdx, outPortIdx) → ValueRefPacked
- [ ] Resolve all wire connections: input port → upstream block output
- [ ] Validate no missing roots: every input port has a value source
- [ ] LinkedGraphIR structure matches spec from `ir/program.ts`
- [ ] Test suite `pass8-link-resolution.test.ts` with minimum 6 tests
- [ ] Test for `UnresolvedPort` error when input has no source

---

### P0-4: Dual-Emit Compiler Integration

- [ ] `compileBusAwarePatch()` signature extended with optional `emitIR: boolean` flag (default false)
- [ ] When `emitIR === true`, run Passes 6-8 after closure compilation succeeds
- [ ] Passes 6-8 receive `compiledPortMap` as input (the closure compilation results)
- [ ] New field added to `CompileResult`: `ir?: LinkedGraphIR`
- [ ] If IR compilation fails, still return success with closure result (IR errors logged as warnings)
- [ ] Existing tests pass with `emitIR: false` (default)
- [ ] New test suite `dual-emit-integration.test.ts` with minimum 10 tests
- [ ] Test verifies closure and IR both present when `emitIR: true`
- [ ] Test verifies IR compilation errors don't break closure compilation

---

### P0-5: IR Validator Core

- [ ] Function `validateIR(ir: LinkedGraphIR): ValidationResult` exists in `src/editor/compiler/ir/validator.ts`
- [ ] Validate all SigExprId references exist in SignalIR table
- [ ] Validate all FieldExprId references exist in FieldIR table
- [ ] Validate all constId references are in bounds for ConstantIR
- [ ] Validate all TransformChainId references exist
- [ ] Validate no circular expression references (signal/field DAGs are acyclic)
- [ ] ValidationResult includes: `valid: boolean`, `errors: IRValidationError[]`, `warnings: IRValidationError[]`
- [ ] Test suite `ir-validator.test.ts` with minimum 15 tests covering all error cases
- [ ] Test for `InvalidSigExprRef` when signal node references non-existent upstream
- [ ] Test for `InvalidFieldExprRef` when field node references non-existent upstream

---

### P0-6: IR Validator Integration

- [ ] Validator runs automatically when `emitIR: true` and `NODE_ENV === 'development'`
- [ ] Validation runs AFTER Pass 8 completes
- [ ] Validation errors are appended to `CompileResult.irWarnings`
- [ ] Validation errors are logged to console with structured output
- [ ] Environment variable `DISABLE_IR_VALIDATION` can skip validation for performance
- [ ] Test suite `ir-validator-integration.test.ts` with minimum 5 tests
- [ ] Test verifies validator catches intentionally broken IR
- [ ] Test verifies validator runs in dev mode but not production

---

### P1-1: Golden Patch IR Validation Test

- [ ] Test file `src/editor/compiler/__tests__/golden-patch-ir.test.ts` exists
- [ ] Test loads golden patch from test fixtures
- [ ] Test compiles with `emitIR: true`
- [ ] Test validates CompileResult has both `program` and `ir` fields
- [ ] Test runs IR validator and expects no errors
- [ ] Test verifies IR has expected structure: nodes, buses, constants
- [ ] Test verifies time model in IR matches closure time model

---

### P1-2: IR Emission Documentation

- [ ] Documentation file created: `design-docs/12-Compiler-Final/21-Dual-Emit-Strategy.md`
- [ ] Document explains Sprint 2 approach: IR from closures, not from block compilers
- [ ] Document specifies IR limitations: structural only, not executable
- [ ] Document outlines Phase 4 migration path: block compilers will emit IR directly
- [ ] Document includes examples of Artifact→IR translation for common types
- [ ] Document explains validator role and limitations
- [ ] Cross-reference to 16-Block-Lowering.md for future block compiler contract

---

## Overall Sprint Success Criteria

Sprint 2 is **DONE** when:

1. ✅ All P0 items (P0-1 through P0-6) have all acceptance criteria checked
2. ✅ All existing tests pass (no regressions)
3. ✅ All new test suites pass:
   - `pass6-block-lowering.test.ts` (8+ tests)
   - `pass7-bus-lowering.test.ts` (10+ tests)
   - `pass8-link-resolution.test.ts` (6+ tests)
   - `dual-emit-integration.test.ts` (10+ tests)
   - `ir-validator.test.ts` (15+ tests)
   - `ir-validator-integration.test.ts` (5+ tests)
4. ✅ Golden patch compiles with `emitIR: true` and produces valid IR
5. ✅ Documentation complete (21-Dual-Emit-Strategy.md)
6. ✅ No blockers for Sprint 3 (Passes 9-11)

**Minimum Test Coverage:** 54 new tests across 6 test suites

**Non-Regression Requirement:** All 38 existing tests from Sprint 1 still passing

**Ready for Next Sprint:** Passes 6-8 working, IR validated, closures still executing, team understands dual-emit strategy
