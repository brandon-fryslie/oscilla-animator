# Status Report - Phase 3 Bridge Compiler
Timestamp: 2025-12-25-200000
Scope: module/phase3-ir-integration
Confidence: FRESH
Git Commit: af676c5

## Executive Summary

**Overall: 35% complete | Critical gaps: 5 topics | Tests: 38 passing**

Phase 3 has a solid foundation with IRBuilder and Pass 1 completed, but 5 major topics remain before dual-emit compilation is achievable.

---

## Completed Work [FRESH]

### 1. IRBuilder API (P0)

| File | Lines | Purpose | Status |
|------|-------|---------|--------|
| `ir/IRBuilder.ts` | 233 | Interface for fluent IR construction | COMPLETE |
| `ir/IRBuilderImpl.ts` | 422 | Implementation with constant deduplication | COMPLETE |
| `ir/builderTypes.ts` | 140 | Builder-specific types (PureFnRef, ReduceFn) | COMPLETE |
| `ir/__tests__/builder.test.ts` | 387 | 24 tests covering all builder methods | PASS (24/24) |

**Features Implemented:**
- Signal expression builders: `sigConst`, `sigTimeAbsMs`, `sigTimeModelMs`, `sigPhase01`, `sigWrapEvent`, `sigMap`, `sigZip`, `sigSelect`, `sigTransform`, `sigCombine`, `sigStateful`
- Field expression builders: `fieldConst`, `fieldMap`, `fieldZip`, `fieldSelect`, `fieldTransform`, `fieldCombine`, `broadcastSigToField`, `reduceFieldToSig`
- ID allocation: `allocSigExprId`, `allocFieldExprId`, `allocStateId`, `allocConstId`, `allocValueSlot`
- Constant deduplication (JSON.stringify-based key)
- Transform chain building
- Render sink registration

### 2. Patch Transformation Types (P1)

| File | Lines | Purpose | Status |
|------|-------|---------|--------|
| `ir/patches.ts` | 238 | Compilation pipeline intermediate types | COMPLETE |

**Types Defined:**
- `BlockIndex`, `ConstId` - Branded numeric IDs
- `DefaultSourceAttachment` - For unwired input handling
- `NormalizedPatch` - Output of Pass 1
- `TypedPatch` - Output of Pass 2 (type graph)
- `TimeResolvedPatch`, `TimeSignals` - Output of Pass 3 (time topology)
- `DepNode`, `DepEdge`, `DepGraph` - For Pass 4
- `SCC`, `IllegalCycleError`, `AcyclicOrLegalGraph` - For Pass 5
- Type guards: `isBlockEval`, `isBusValue`

### 3. Pass 1 - Normalize Patch (P2)

| File | Lines | Purpose | Status |
|------|-------|---------|--------|
| `passes/pass1-normalize.ts` | 108 | First compilation pass | COMPLETE |
| `passes/__tests__/pass1-normalize.test.ts` | 366 | 14 tests | PASS (14/14) |
| `passes/index.ts` | 15 | Barrel export | COMPLETE |

**Functionality:**
- Freezes block IDs to dense indices (stable sorted order)
- Attaches default sources for unwired inputs without bus listeners
- Canonicalizes publishers (enabled only, sorted by sortKey then id)
- Canonicalizes listeners (enabled only)

---

## Remaining Work - Gap Analysis

### Topic 1: lowering-pass-types (Pass 2 - Type Graph)
**Complexity: Medium | Priority: P0**

**Purpose:** Establish types for every slot and bus in a unified, compiler-authoritative way.

**What Needs to Be Built:**

| Component | Description | Complexity |
|-----------|-------------|------------|
| `passes/pass2-types.ts` | Main pass implementation | Medium |
| Type conversion | SlotType -> IR TypeDesc mapping | Medium |
| Bus eligibility validation | `bus.type.busEligible === true` | Low |
| Reserved bus type validation | phaseA/pulse/energy/palette constraints | Low |
| Compatibility precomputation | Direct assignable + adapter/lens chains | High |

**Input:** `NormalizedPatch`
**Output:** `TypedPatch` (already defined in patches.ts)

**Key Challenge:** The editor has `TypeDesc` in `src/editor/types.ts` with `category` and `busEligible` fields that the IR `TypeDesc` lacks. Need mapping logic.

**Dependencies:**
- Adapter/Lens registry access for conversion path computation
- Reserved bus roles spec (from `busContracts.ts`)

**Errors to Emit:**
- `PortTypeUnknown`, `BusIneligibleType`, `ReservedBusTypeViolation`, `NoConversionPath`

---

### Topic 2: lowering-pass-time (Pass 3 - Time Topology)
**Complexity: Medium | Priority: P0**

**Purpose:** Produce the authoritative TimeModel and canonical time signals.

**What Needs to Be Built:**

| Component | Description | Complexity |
|-----------|-------------|------------|
| `passes/pass3-time.ts` | Main pass implementation | Medium |
| TimeRoot discovery | Find single TimeRoot by capability | Low |
| TimeRoot validation | Exactly one, no illegal upstream deps | Low |
| Time signal generation | tAbsMs, tModelMs, phase01, wrapEvent as IR nodes | Medium |
| TimeModel extraction | From TimeRoot block params | Low |

**Input:** `TypedPatch`
**Output:** `TimeResolvedPatch + TimePlan` (TimeResolvedPatch exists in patches.ts)

**Key Actions:**
1. Find single TimeRoot (FiniteTimeRoot, CycleTimeRoot, InfiniteTimeRoot)
2. Validate constraints (exactly one)
3. Generate canonical time signals using IRBuilder
4. Produce TimeModelIR record

**Integration Point:** `compileBusAware.ts:inferTimeModel()` already extracts TimeModel from TimeRoot params. Pass 3 needs to formalize this + emit IR nodes.

**Errors to Emit:**
- `MissingTimeRoot`, `MultipleTimeRoots`, `TimeRootViolation`

---

### Topic 3: lowering-pass-depgraph (Pass 4-5 - Dependency Graph & SCC)
**Complexity: High | Priority: P0**

**Purpose:** Build unified dependency graph for scheduling and cycle validation.

**What Needs to Be Built:**

| Component | Description | Complexity |
|-----------|-------------|------------|
| `passes/pass4-depgraph.ts` | Dependency graph construction | Medium |
| `passes/pass5-scc.ts` | SCC detection and cycle validation | High |
| Node building | BlockEval(blockIdx) + BusValue(busIdx) | Low |
| Edge building | Wire, Publisher, Listener, Time edges | Medium |
| SCC algorithm | Tarjan or Kosaraju implementation | High |
| State boundary detection | Blocks with `capability: state` | Medium |

**Types Already Exist:**
- `DepNode`, `DepEdge`, `DepGraph` in patches.ts
- `SCC`, `IllegalCycleError`, `AcyclicOrLegalGraph` in patches.ts

**Key Insight:** `compileBusAware.ts:topoSortBlocksWithBuses()` (lines 100-191) already does similar work but produces a flat order, not a DepGraph. Need to extract graph structure for SCC analysis.

**Pass 4 Output:** `DepGraph`
**Pass 5 Output:** `AcyclicOrLegalGraph`

**Errors to Emit:**
- Pass 4: `DanglingConnection`, `DanglingBindingEndpoint`
- Pass 5: `IllegalCycle`, `CycleWithoutStateBoundary`

---

### Topic 4: dual-emit-compiler (Modify compileBusAware for dual emit)
**Complexity: Very High | Priority: P1**

**Purpose:** Modify `compileBusAware.ts` to emit both legacy Artifact closures AND new IR nodes simultaneously.

**What Needs to Be Built:**

| Component | Description | Complexity |
|-----------|-------------|------------|
| IRBuilder integration | Add IRBuilder to compile context | Low |
| Block compiler contract | Each block emits BOTH Artifact + IR nodes | Very High |
| Pass 6 lowering | Block compilers emit Expr fragments | Very High |
| Pass 7 lowering | Buses become explicit combine nodes | High |
| Pass 8 linking | Resolve all ValueRefs to concrete IDs | Medium |
| Dual output | Return both legacy `CompileResult` + `BuilderProgramIR` | Medium |

**Critical Challenge:** This is where the closure-based system meets the IR-based system. Every block compiler in `src/editor/compiler/blocks/` needs to be updated to emit IR nodes in addition to closures.

**Block Compilers to Update (17 files):**
- `blocks/domain/` - CycleTimeRoot, FiniteTimeRoot, InfiniteTimeRoot, TimeRoot, FieldConstColor, etc.
- `blocks/` - All other block compilers

**Integration Points:**
- `compileBusAwarePatch()` needs IRBuilder instance
- Block `compile()` signature needs to accept `builder: IRBuilder`
- `CompileResult` needs optional `ir: BuilderProgramIR` field

---

### Topic 5: ir-validator (Validate emitted IR)
**Complexity: Medium | Priority: P1**

**Purpose:** Validate that emitted IR is well-formed and complete.

**What Needs to Be Built:**

| Component | Description | Complexity |
|-----------|-------------|------------|
| `ir/validator.ts` | Main validation logic | Medium |
| ID reference validation | All SigExprId/FieldExprId refs exist | Medium |
| Type consistency | Operator types match operand types | Medium |
| State reference validation | All StateId refs have entries | Low |
| Const pool validation | All constId refs are in bounds | Low |
| Transform chain validation | All TransformChainId refs exist | Low |
| Cycle detection (IR level) | No circular expression references | Medium |

**Validation Errors:**
- `InvalidSigExprRef`, `InvalidFieldExprRef`, `InvalidStateRef`, `InvalidConstRef`
- `TypeMismatch`, `CircularExprRef`, `MissingRequiredField`

---

## Ambiguities Found

| Area | Question | How LLM Might Guess | Impact |
|------|----------|---------------------|--------|
| TypeDesc mapping | Editor TypeDesc has `category`/`busEligible`, IR TypeDesc doesn't. Which is authoritative? | Use IR TypeDesc, compute eligibility | Could cause type mismatches at boundaries |
| Block compiler contract | Should blocks emit IR during `compile()` or in a separate pass? | Extend compile() signature | Major architectural decision - affects all 17 block files |
| Hot-swap boundary | At what point do we switch from legacy to IR runtime? | Dual emit during transition | Determines migration path length |
| State layout | How does IR StateId map to runtime state buffers? | Use StateLayoutEntry array | Could affect state persistence |

**CRITICAL AMBIGUITY:** The block compiler contract is undefined. The design doc says block compilers must be "pure with respect to compilation" and "may not capture JS closures". But current block compilers DO capture closures (they return Artifacts with function values). This is a fundamental architecture gap.

---

## Dependencies and Risks

### Internal Dependencies

```
Pass 1 (DONE) -> Pass 2 -> Pass 3 -> Pass 4 -> Pass 5 -> Pass 6/7 -> Pass 8 -> Validator
                   |          |          |
                   v          v          v
              TypedPatch  TimeResolved  DepGraph
```

### External Dependencies

| Dependency | Location | Risk |
|------------|----------|------|
| Adapter/Lens Registry | `lenses/LensRegistry.ts` | Needed for Pass 2 type conversion |
| Bus Contracts | `semantic/busContracts.ts` | Needed for Pass 2 reserved bus validation |
| Block Registry | `blocks/registry.ts` | Needed for Pass 6 block compilation |
| TimeRoot blocks | `blocks/domain/TimeRoot.ts` | Needed for Pass 3 time extraction |

### Risks

1. **Block Compiler Migration (HIGH):** 17 block compiler files need modification for dual emit. Risk of subtle behavior differences between closure and IR paths.

2. **Type System Divergence (MEDIUM):** Editor `TypeDesc` vs IR `TypeDesc` could cause silent type mismatches.

3. **State Management (MEDIUM):** IR state model uses `StateId` and `StateLayoutEntry`, current system uses closure captures. Migration path unclear.

4. **Testing Gap (MEDIUM):** Only 38 tests for new IR code. Need integration tests that verify closure and IR paths produce equivalent results.

---

## Runtime Check Results

| Check | Status | Output |
|-------|--------|--------|
| `npx vitest run ir/__tests__/builder.test.ts` | PASS | 24/24 tests |
| `npx vitest run passes/__tests__/pass1-normalize.test.ts` | PASS | 14/14 tests |
| TypeScript compile | PASS | No errors |

### Missing Checks (implementer should create)

1. **Pass 2 tests** - Type graph construction, conversion path computation
2. **Pass 3 tests** - Time topology, TimeRoot discovery, time signal generation
3. **Pass 4-5 tests** - Dependency graph, SCC detection, cycle validation
4. **Integration test** - Full pipeline Pass 1-5 on real patch
5. **Equivalence test** - Verify IR and closure paths produce same results

---

## Recommendations (Priority Order)

1. **Clarify block compiler contract** - Decide: extend `compile()` or add separate IR emission method? This affects all 17 block files.

2. **Implement Pass 2-3** - Type graph and time topology are prerequisites for everything else.

3. **Implement Pass 4-5** - Dependency graph and SCC are needed for scheduling.

4. **Design dual-emit strategy** - Before modifying `compileBusAware.ts`, document exactly how legacy and IR paths coexist.

5. **Add integration tests** - Verify full pipeline works end-to-end before attempting block compiler changes.

---

## Verdict

- [x] **PAUSE** - Ambiguities need clarification before proceeding

### Clarification Needed Before Proceeding

**Question 1: Block Compiler Contract**
- **Context:** Pass 6 requires block compilers to emit IR nodes (SigExprId/FieldExprId) instead of closures
- **How it was guessed:** N/A - not yet implemented
- **Options:**
  - Option A: Extend `BlockCompiler.compile()` signature to accept `IRBuilder`, emit both Artifact + IR
  - Option B: Add separate `compileToIR()` method to BlockCompiler interface
  - Option C: Create new IR-only block compilers in parallel to existing ones
- **Impact of wrong choice:** Option A requires modifying all 17 block files. Option B adds API complexity. Option C doubles maintenance burden.

**Question 2: TypeDesc Unification**
- **Context:** Editor `TypeDesc` (with `category`, `busEligible`) differs from IR `TypeDesc` (simpler)
- **How it was guessed:** N/A - types defined but no mapping implemented
- **Options:**
  - Option A: Add `category`/`busEligible` to IR TypeDesc
  - Option B: Keep separate, compute eligibility at compile time
  - Option C: Merge into single TypeDesc used everywhere
- **Impact of wrong choice:** Type mismatches at editor/IR boundary could cause silent bugs.

---

## Files Summary

| Category | Files | Status |
|----------|-------|--------|
| IRBuilder | 4 files | COMPLETE |
| Patch Types | 1 file | COMPLETE |
| Pass 1 | 2 files | COMPLETE |
| Pass 2-5 | 0 files | NOT STARTED |
| Dual Emit | 0 files | NOT STARTED |
| Validator | 0 files | NOT STARTED |
| Tests | 2 files (38 tests) | PASS |
