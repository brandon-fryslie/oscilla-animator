# Definition of Done: WP2 Bus-Aware Compiler

**Generated**: 2025-12-21-151654
**Plan**: PLAN-2025-12-21-151654.md
**Source**: STATUS-2025-12-21-133500.md

---

## Sprint Scope

This sprint completes WP2 by removing obsolete "UiSignalBindings" references from specs and fixing minor test failures. The core bus-aware compilation implementation is already complete (99.6% test pass rate, 797/800 tests).

**Delivers**: Documentation cleanup (2-3 hours total)
**Deferred**: WP1 (TimeRoot compiler), WP3 (Field compilation validation)

---

## Acceptance Criteria

### P0: Remove UiSignalBindings from Spec Docs

**Deliverable**: Spec-code alignment on UI integration pattern

- [ ] File `design-docs/3-Synthesized/03-Buses.md` - Remove `UiSignalBindings` interface definition (lines 115-137)
- [ ] File `design-docs/3-Synthesized/03-Buses.md` - Add new "UI Integration" section explaining BusStore + compiledPortMap pattern
- [ ] File `design-docs/3-Synthesized/05-Compilation.md` - Remove `uiBindings: UiSignalBindings` from `CompiledProgram` interface (line 36)
- [ ] File `design-docs/3-Synthesized/05-Compilation.md` - Document that UI reads `CompileResult.compiledPortMap` and `CompileResult.timeModel`
- [ ] File `design-docs/3-Synthesized/06-Runtime.md` - Replace "UiSignalBindings.buses.pulse" reference (line 94) with "pulse bus in BusStore"
- [ ] File `design-docs/3-Synthesized/11-Roadmap.md` - Update WP1 deliverable (line 48): "Compiler outputs TimeModel" (remove UiSignalBindings)
- [ ] File `design-docs/3-Synthesized/11-Roadmap.md` - Update WP2 deliverable (line 77): Remove "UiSignalBindings uses bus IDs, not ports"
- [ ] Verification: Run `grep -r "UiSignalBindings" design-docs/3-Synthesized/` returns zero results
- [ ] Verification: New spec text explains: "UI controls publish to buses like any other publisher (no special binding system)"

**Technical Validation**:
```bash
# Must return zero results in synthesized specs
grep -r "UiSignalBindings" design-docs/3-Synthesized/

# Must confirm no code references (already true per STATUS)
grep -r "UiSignal" src/editor/
```

---

### P1: Fix Macro Test Expectations

**Deliverable**: 100% test pass rate (800/800 tests)

- [ ] Inspect `src/editor/macros.ts` MACRO_REGISTRY - document actual structure of `breathingDots` and `goldenPatch` macros
- [ ] File `src/editor/__tests__/composite-library.test.ts` - Update breathingDots test expectations (line ~400) to match actual publishers field
- [ ] File `src/editor/__tests__/composite-library.test.ts` - Update goldenPatch test expectations (line ~414) to match actual block list
- [ ] File `src/editor/__tests__/macro-validation.test.ts` - Update goldenPatch bus publication expectations (line ~204) to match actual buses
- [ ] Verification: Run `just test` - output shows "Tests: 800 passed, 800 total"
- [ ] Verification: Zero test failures in composite-library.test.ts
- [ ] Verification: Zero test failures in macro-validation.test.ts

**Technical Validation**:
```bash
# Must show 100% pass
just test

# Output must include:
# Test Suites: X passed, X total
# Tests:       800 passed, 800 total
```

---

### P2: Standardize Lens Terminology in Spec

**Deliverable**: Spec uses "Lens" as primary term (matches implementation)

- [ ] Rename `design-docs/3-Synthesized/04-Adapters.md` → `design-docs/3-Synthesized/04-Lenses.md`
- [ ] File `design-docs/3-Synthesized/04-Lenses.md` - Update title to "Lenses (Type Adapters)"
- [ ] File `design-docs/3-Synthesized/04-Lenses.md` - Replace "Adapter" → "Lens" in all body text (except historical notes)
- [ ] File `design-docs/3-Synthesized/04-Lenses.md` - Add note: "Previously called 'Adapters' in early specs - implementation uses 'Lens'"
- [ ] File `design-docs/3-Synthesized/03-Buses.md` - Update cross-references to use "Lens" terminology
- [ ] File `design-docs/3-Synthesized/11-Roadmap.md` - Update WP2 deliverable text to say "Lens library" not "Adapter library"
- [ ] Document legacy `adapterChain` field exists for backward compatibility but `lensStack` is current
- [ ] Verification: Grep shows "Lens" as primary term, "Adapter" only in historical context

**Technical Validation**:
```bash
# Primary term should be "Lens"
grep -c "Lens" design-docs/3-Synthesized/04-Lenses.md
# Should be significantly higher than:
grep -c "Adapter" design-docs/3-Synthesized/04-Lenses.md

# Check cross-references updated
grep "04-Adapters" design-docs/3-Synthesized/*.md  # Should return zero
grep "04-Lenses" design-docs/3-Synthesized/*.md    # Should find references
```

---

### P3: Add UIControlPublisher Documentation (Optional)

**Deliverable**: Documented pattern for UI control integration

- [ ] File `design-docs/3-Synthesized/03-Buses.md` - Add section "UI Control Publishers"
- [ ] Explain: UI controls (sliders, knobs) publish to buses via BusStore.createPublisher
- [ ] Document: UI publishers use `sortKey = -1000` (high priority to override defaults)
- [ ] Show example: User drags slider → publishes to "energy" bus → listeners receive via lens stack
- [ ] Clarify: No special binding layer - unified bus architecture
- [ ] Cross-reference to `design-docs/3-Synthesized/07-UI-Spec.md` for UI widget specs
- [ ] Add design rationale: Why UI-as-publisher is better than separate binding system
- [ ] Verification: Section clearly explains how user interaction flows into patch

**Conceptual Model (must be in docs)**:
```
UI Slider
  ↓ User drags
BusPublisher { blockId: 'ui-control-1', busId: 'energy', sortKey: -1000 }
  ↓ Highest priority
Bus compilation combines with sortKey ordering
  ↓ UI value wins
Listeners receive via lens stack
  ↓
Runtime propagation
```

---

## Overall WP2 Completion Criteria

### Documentation

- [ ] Zero "UiSignalBindings" references in `design-docs/3-Synthesized/` directory
- [ ] Spec explains UI integration via BusStore + compiledPortMap (not separate binding system)
- [ ] Spec uses "Lens" terminology consistently (matches implementation)
- [ ] UI control publisher pattern documented (how user interaction flows into patch)

### Test Quality

- [ ] 100% test pass rate: 800/800 tests passing
- [ ] All bus-compilation.test.ts tests passing (8/8) - already true per STATUS
- [ ] All lenses.test.ts tests passing (55/55) - already true per STATUS
- [ ] All field-bus-compilation.test.ts tests passing (8/8) - already true per STATUS
- [ ] All macro structure tests passing (composite-library.test.ts, macro-validation.test.ts)

### Core Functionality (Already Complete per STATUS)

- [x] Bus-aware compilation pipeline: 673 lines in compileBusAware.ts, working end-to-end
- [x] Deterministic publisher ordering: busSemantics.getSortedPublishers() canonical implementation
- [x] Bus combination semantics: Signal (last, sum), Field (last, sum, average, max, min) implemented
- [x] Lens stack application: Listeners apply lens chains correctly
- [x] Topological sort: Includes wire AND bus dependencies, cycle detection working
- [x] Type validation: TypeDesc enforcement, combine mode validation

### WP3 Readiness

- [ ] No blockers for field compilation work (field bus tests already passing)
- [ ] Spec-code alignment sufficient for next phase
- [ ] Test infrastructure ready (99.6% → 100% pass rate)

---

## Sprint Deliverables Summary

**Must Have** (2-3 hours):
1. P0: Spec cleanup - remove UiSignalBindings (1-2 hours)
2. P1: Fix macro tests - 100% pass rate (30 minutes)

**Should Have** (1-2 hours):
3. P2: Lens terminology alignment (30 minutes)
4. P3: UIControlPublisher documentation (1 hour)

**Total Effort**: 3-5 hours for complete WP2 closure

---

## Success Metrics

**Before Sprint**:
- Test pass rate: 99.6% (797/800)
- UiSignalBindings references: 5+ in specs
- Terminology: Mixed "Adapter" and "Lens"

**After Sprint**:
- Test pass rate: 100% (800/800)
- UiSignalBindings references: 0 in synthesized specs
- Terminology: "Lens" primary term throughout
- UI integration pattern: Documented clearly

---

## Risk Mitigation

**Low Risk**:
- All changes are documentation or test expectations
- No production code changes required
- Core implementation already verified working (99.6% tests pass)

**Rollback Plan**:
- Documentation changes: git revert (no runtime impact)
- Test changes: Worst case, skip failing tests temporarily (but should be quick fixes)

---

## Dependencies

**None** - All work is self-contained within WP2 scope

**Upstream** (already complete):
- Bus-aware compiler implementation ✅
- Lens system implementation ✅
- Bus semantics module ✅

**Downstream** (ready to proceed after cleanup):
- WP1: TimeRoot compiler + Player rewrite
- WP3: Field compilation validation (tests already passing, just needs Golden Patch)
- WP0: Contract enforcement (reserved buses, TypeDesc validation)

---

## Validation Commands

Run these to verify WP2 completion:

```bash
# Test Quality: Must show 100% pass
just test

# Spec Cleanup: Must return zero results
grep -r "UiSignalBindings" design-docs/3-Synthesized/

# Terminology: Must find new filename
ls design-docs/3-Synthesized/04-Lenses.md

# Implementation: Confirm no UiSignal code (already true)
grep -r "UiSignal" src/editor/
```

Expected outputs:
- `just test`: "Tests: 800 passed, 800 total"
- UiSignalBindings grep: Empty (exit code 1)
- 04-Lenses.md: File exists
- UiSignal code grep: Empty (exit code 1)

---

## Provenance

**Source**: STATUS-2025-12-21-133500.md (project-evaluator FRESH assessment)
**User Specification**: UiSignalBindings is OBSOLETE - remove all references
**Planner**: status-planner
**Generated**: 2025-12-21-151654
