# Status: Block Compiler Migration (Phase 3)

**Timestamp**: 2025-12-26-030000
**Scope**: project/block-compiler-migration
**Confidence**: FRESH
**Git Commit**: a429cfc (compiler_rewrite branch)

---

## Executive Summary

**Current State**: All 36 block compilers emit **CLOSURES** via `BlockCompiler.compile()` returning `CompiledOutputs`.

**Target State**: Block compilers emit **IR nodes** via `BlockLowerFn` taking `LowerCtx` with `IRBuilder` and returning `LowerResult`.

**Gap Analysis**:
- Pass 6 (`pass6-block-lowering.ts`) currently creates **PLACEHOLDER IR** from closure artifacts
- The `BlockLowerFn`, `LowerCtx`, `LowerResult` types from design doc **DO NOT EXIST** in codebase
- `SignalExprBuilder` exists as a lightweight migration helper (Sprint 7 infrastructure)
- Full `IRBuilder` interface exists but is used only by compilation passes, not block compilers

**Completion**: 0% of blocks migrated to IR emission

---

## Reused From Cache/Previous Evaluations

- eval-cache/compiler-architecture.md (STALE, 5 days ago - but useful for structure)
  - Block inventory numbers confirmed: 36 implementation files
  - `params.` usage confirmed: 80 references across 28 files

---

## Block Compiler Inventory

### Exact Count

| Category | Count | Files |
|----------|-------|-------|
| **Signal Blocks** | 8 | AddSignal, SubSignal, MulSignal, DivSignal, MinSignal, MaxSignal, ClampSignal, Oscillator, Shaper, ColorLFO |
| **Domain Source Blocks** | 3 | DomainN, GridDomain, SVGSampleDomain |
| **Field Blocks** | 17 | FieldConstNumber, FieldConstColor, FieldHash01ById, FieldMapNumber, FieldMapVec2, FieldZipNumber, FieldZipSignal, FieldAddVec2, FieldColorize, FieldOpacity, FieldHueGradient, FieldFromExpression, FieldStringToColor, FieldFromSignalBroadcast, FieldReduce, StableIdHash, JitterFieldVec2 |
| **Position Map Blocks** | 3 | PositionMapGrid, PositionMapCircle, PositionMapLine |
| **Time Blocks** | 3 | FiniteTimeRoot, InfiniteTimeRoot |
| **Render Blocks** | 2 | RenderInstances2D, Render2dCanvas |
| **Rhythm Blocks** | 2 | EnvelopeAD, PulseDivider |
| **Debug Blocks** | 1 | DebugDisplay |
| **Utility** | 3 | PhaseClock, TriggerOnWrap, ViewportInfo |
| **Total** | 36 | Implementation files (excluding index.ts, helpers.ts, tests) |

---

## Complexity Categorization

### Tier 1: Pure Math / Simple Transform (8 blocks)
**Characteristics**: No params, 2 inputs, single output, pure signal math
**Migration Effort**: LOW (1-2 hours each, highly parallelizable)
**Dependencies**: None

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| AddSignal | 58 | 0 | `sigZip(a, b, OpCode.Add)` |
| SubSignal | 58 | 0 | `sigZip(a, b, OpCode.Sub)` |
| MulSignal | 58 | 0 | `sigZip(a, b, OpCode.Mul)` |
| DivSignal | 60 | 0 | `sigZip(a, b, OpCode.Div)` |
| MinSignal | 57 | 0 | `sigZip(a, b, OpCode.Min)` |
| MaxSignal | 57 | 0 | `sigZip(a, b, OpCode.Max)` |
| ClampSignal | 47 | 2 | `sigMap` with clamp kernel |

### Tier 2: Parameterized Math (5 blocks)
**Characteristics**: 1-4 params, waveform/shape selection, signal math
**Migration Effort**: MEDIUM (2-3 hours each)
**Dependencies**: Tier 1 patterns

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| Oscillator | 70 | 3 | Shape param selects waveform kernel |
| Shaper | 80 | 2 | Kind param selects shaping function |
| ColorLFO | 128 | 4 | Color space math with HSL conversion |
| PulseDivider | 59 | 1 | Stateful: needs `sigStateful` |
| TriggerOnWrap | 68 | 0 | Event detection logic |

### Tier 3: Field Producers / Const Blocks (6 blocks)
**Characteristics**: Create Field artifacts, may consume Domain
**Migration Effort**: MEDIUM (2-3 hours each)
**Dependencies**: Domain infrastructure

| Block | Lines | Params | Domain Input | Migration Notes |
|-------|-------|--------|--------------|-----------------|
| FieldConstNumber | 46 | 1 | YES | `fieldConst(value, type)` |
| FieldConstColor | 46 | 1 | YES | `fieldConst(colorValue, type)` |
| FieldHash01ById | 73 | 1 | YES | Hash function as `fieldMap` |
| StableIdHash | 72 | 1 | YES | Salt-based hash |
| FieldFromSignalBroadcast | 74 | 0 | YES | `broadcastSigToField` |
| ViewportInfo | 43 | 0 | NO | Returns viewport data |

### Tier 4: Field Transformers (9 blocks)
**Characteristics**: Take Field input, apply transform, output Field
**Migration Effort**: MEDIUM-HIGH (3-4 hours each)
**Dependencies**: Tier 3 patterns, transform infrastructure

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| FieldMapNumber | 92 | 4 | `fieldMap` with function selection |
| FieldMapVec2 | 106 | 8 | Complex transforms: rotate, scale, offset |
| FieldZipNumber | 89 | 1 | `fieldZip` with op selection |
| FieldZipSignal | 102 | 1 | Signal+Field zip |
| FieldAddVec2 | 68 | 0 | `fieldZip` for vec2 |
| FieldColorize | 97 | 3 | Number->Color conversion |
| FieldOpacity | 71 | 3 | Value->Opacity with curve |
| FieldHueGradient | 134 | 4 | HSL gradient generation |
| JitterFieldVec2 | 97 | 2 | Random displacement |

### Tier 5: Domain Producers (3 blocks)
**Characteristics**: Create Domain artifacts with identity arrays
**Migration Effort**: HIGH (4-5 hours each)
**Dependencies**: Domain IR representation

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| DomainN | 40 | 2 | `domainFromN(n)` |
| GridDomain | 70 | 5 | Grid with positions |
| SVGSampleDomain | 331 | 4 | SVG parsing + sampling (COMPLEX) |

### Tier 6: Position Maps (3 blocks)
**Characteristics**: Domain -> Field<vec2>
**Migration Effort**: MEDIUM (3 hours each)
**Dependencies**: Tier 5 (Domain), Tier 3 (Field)

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| PositionMapGrid | 74 | 5 | Row/col major layout |
| PositionMapCircle | 78 | 6 | Circular distribution |
| PositionMapLine | 73 | 5 | Linear interpolation |

### Tier 7: Time Blocks (3 blocks)
**Characteristics**: TimeModel integration, system time signals
**Migration Effort**: HIGH (5-6 hours each)
**Dependencies**: TimeModelIR, schedule pass integration

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| FiniteTimeRoot | ~40 | 1 | Progress/duration |

| InfiniteTimeRoot | ~40 | 1 | Ambient phase |

### Tier 8: Stateful Blocks (2 blocks)
**Characteristics**: Mutable state, trigger detection
**Migration Effort**: HIGH (5-6 hours each)
**Dependencies**: StateLayout, `sigStateful`, state allocation

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| EnvelopeAD | 79 | 3 | Attack/decay timing |
| PhaseClock | 113 | 2 | Phase accumulation |

### Tier 9: Render Sinks (2 blocks)
**Characteristics**: RenderTree output, field materialization
**Migration Effort**: VERY HIGH (6-8 hours each)
**Dependencies**: RenderSinkIR, all field patterns

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| RenderInstances2D | 198 | 3 | Field evaluation, draw loop |
| Render2dCanvas | 46 | 0 | Canvas rendering |

### Tier 10: Special Blocks (3 blocks)
**Characteristics**: Expression evaluation, string handling
**Migration Effort**: VERY HIGH (8+ hours each)
**Dependencies**: Expression compiler, runtime bridging

| Block | Lines | Params | Migration Notes |
|-------|-------|--------|-----------------|
| FieldFromExpression | 114 | 1 | JS expression compilation |
| FieldStringToColor | 42 | 0 | String->Color parsing |
| FieldReduce | 86 | 1 | Field->Signal reduction |
| DebugDisplay | 138 | 3 | Debug visualization |

---

## Missing Infrastructure

### CRITICAL: Types Not Implemented

The following types from `design-docs/12-Compiler-Final/16-Block-Lowering.md` **DO NOT EXIST** in codebase:

```typescript
// None of these exist - need creation first!
export type BlockCapability = 'time' | 'identity' | 'state' | 'render' | 'io' | 'pure';
export interface BlockPortDecl { ... }
export interface BlockTypeDecl { ... }
export type BlockLowerFn = (args: { ctx: LowerCtx; inputs: ValueRefPacked[]; config?: unknown }) => LowerResult;
export interface LowerCtx { ... }
export interface LowerResult { ... }
export interface BlockDeclarations { ... }
```

### Partially Implemented

| Component | Status | Location | Notes |
|-----------|--------|----------|-------|
| `IRBuilder` | EXISTS | `src/editor/compiler/ir/IRBuilder.ts` | Full interface, 232 lines |
| `IRBuilderImpl` | EXISTS | `src/editor/compiler/ir/IRBuilderImpl.ts` | Implementation |
| `SignalExprBuilder` | EXISTS | `src/editor/runtime/signal-expr/SignalExprBuilder.ts` | Lightweight migration helper |
| `ValueRefPacked` | EXISTS | `src/editor/compiler/passes/pass6-block-lowering.ts` | Only `sig` and `field` kinds |
| `TypeDesc` | EXISTS | `src/editor/compiler/ir/types.ts` | Core type system |
| `OpCode` | EXISTS | `src/editor/compiler/ir/opcodes.ts` | Operation codes |

---

## Dependency Graph

```
                    Domain Producers (Tier 5)
                           |
                           v
    +----------------------+----------------------+
    |                      |                      |
    v                      v                      v
Position Maps          Field Const           Field Transform
(Tier 6)              (Tier 3)               (Tier 4)
    |                      |                      |
    +----------------------+----------------------+
                           |
                           v
                    Render Sinks (Tier 9)
```

**Signal Chain**:
```
Time Blocks (Tier 7) --> Pure Math (Tier 1) --> Parameterized (Tier 2) --> Stateful (Tier 8)
```

---

## Parallel Workstreams

### Workstream A: Signal Blocks (Independent)
**Blocks**: Tier 1 + Tier 2 (13 blocks)
**Can start immediately**: YES
**Dependencies**: None
**Estimated effort**: 15-20 hours total

### Workstream B: Field Infrastructure (Blocking)
**Pre-requisite**: Create `LowerCtx`, `BlockLowerFn`, `LowerResult` types
**Blocks**: Tier 3 â†’ Tier 4 (15 blocks)
**Dependencies**: Domain IR representation
**Estimated effort**: 30-40 hours total

### Workstream C: Domain + Position (Blocking)
**Blocks**: Tier 5 + Tier 6 (6 blocks)
**Dependencies**: Domain IR infrastructure
**Estimated effort**: 15-20 hours total

### Workstream D: Time Blocks (Blocking)
**Blocks**: Tier 7 (3 blocks)
**Dependencies**: TimeModelIR integration
**Estimated effort**: 15-18 hours total

### Workstream E: Stateful + Render (Last)
**Blocks**: Tier 8 + Tier 9 + Tier 10 (7 blocks)
**Dependencies**: All other workstreams
**Estimated effort**: 40-50 hours total

---

## Recommended Migration Order

### Phase 3A: Foundation (BLOCKING - must do first)
1. Create missing types: `BlockLowerFn`, `LowerCtx`, `LowerResult`, `BlockDeclarations`
2. Create `BlockTypeDecl` registry parallel to existing `BlockCompiler`
3. Add dual-emit capability to block compiler infrastructure

### Phase 3B: Signal Blocks (Parallel with 3C)
Order by complexity:
1. AddSignal, SubSignal, MulSignal, DivSignal (simplest patterns)
2. MinSignal, MaxSignal, ClampSignal
3. Oscillator, Shaper
4. ColorLFO (most complex signal block)

### Phase 3C: Field Blocks (Parallel with 3B)
Order by dependency:
1. FieldConstNumber, FieldConstColor (no upstream deps)
2. FieldMapNumber, FieldAddVec2 (simple transforms)
3. FieldZipNumber, FieldZipSignal
4. FieldColorize, FieldOpacity, FieldHueGradient
5. FieldFromSignalBroadcast, FieldReduce

### Phase 3D: Domain Chain
Order by dependency:
1. DomainN (simplest)
2. GridDomain
3. PositionMapGrid, PositionMapCircle, PositionMapLine
4. SVGSampleDomain (most complex)

### Phase 3E: Time Blocks
1. InfiniteTimeRoot (simplest)

3. FiniteTimeRoot

### Phase 3F: Stateful + Render
1. PulseDivider, TriggerOnWrap (stateful events)
2. EnvelopeAD, PhaseClock (stateful signals)
3. Render2dCanvas
4. RenderInstances2D

### Phase 3G: Special Cases (Last)
1. FieldFromExpression (expression compiler)
2. FieldStringToColor
3. DebugDisplay

---

## Test Infrastructure Status

### Existing Tests
| Test File | Coverage |
|-----------|----------|
| `GridDomain.test.ts` | Basic compilation |
| `TimeRoot.test.ts` | TimeModel variants |
| `TimeRoot-WP1.test.ts` | WP1 validation |
| `ColorLFO.test.ts` | Color signal output |

### Missing Tests
- **0 tests** for IR emission from blocks
- **0 tests** for dual-emit mode
- Need golden tests comparing closure vs IR output

### Test Strategy for Migration
For each block migration:
1. Create IR emission test (unit)
2. Add dual-emit equivalence test (golden)
3. Verify closure path still works

---

## Ambiguities / Clarification Needed

### NEEDS_CLARIFICATION: Dual-Emit vs Replace

**Question**: Should migrated blocks emit BOTH closures AND IR, or replace closures entirely?

**Current guess**: Design doc 21-Dual-Emit-Strategy.md suggests dual-emit first, but Phase 4+ removes closures.

**Options**:
- A) Dual-emit (safe, but doubles work)
- B) Replace closure with IR immediately (faster, but riskier)

**Impact**: Affects migration order and testing strategy.

### NEEDS_CLARIFICATION: Domain IR Representation

**Question**: How is Domain represented in IR?

**Current guess**: `ValueSlot` with special handling, but design doc says `DomainId` (not implemented).

**Options**:
- A) ValueSlot with domain tag
- B) Separate DomainIR table
- C) Field with special metadata

---

## Recommendations

### Priority 1: Create Missing Types (BLOCKING)
Create `src/editor/compiler/ir/lowerTypes.ts`:
- `BlockCapability`
- `BlockPortDecl`
- `BlockTypeDecl`
- `LowerCtx`
- `BlockLowerFn`
- `LowerResult`
- `BlockDeclarations`

### Priority 2: Migrate Signal Blocks First
- Low risk, high reward
- Validates migration pattern
- Unblocks Workstream A

### Priority 3: Domain IR Representation
- Clarify design before migrating Domain/Field blocks
- Blocks 15+ migrations

### Priority 4: Stateful Block Infrastructure
- `sigStateful` in IRBuilder needs validation
- State allocation patterns

---

## Verdict

- [x] **CONTINUE** - Issues are clear, work can proceed with Priority 1 (create missing types)
- [ ] PAUSE - Would need pause if Domain IR representation is critical path

**Next Action**: Create `lowerTypes.ts` with missing type definitions, then migrate AddSignal as proof of concept.

---

## File References

- Design spec: `design-docs/12-Compiler-Final/16-Block-Lowering.md`
- Dual-emit strategy: `design-docs/12-Compiler-Final/21-Dual-Emit-Strategy.md`
- Current Pass 6: `src/editor/compiler/passes/pass6-block-lowering.ts`
- Block registry: `src/editor/compiler/blocks/index.ts`
- IRBuilder interface: `src/editor/compiler/ir/IRBuilder.ts`
- SignalExprBuilder: `src/editor/runtime/signal-expr/SignalExprBuilder.ts`
