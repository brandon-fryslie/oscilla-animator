# Sprint Plan: Block Compiler Migration (Phase 3)

**Generated**: 2025-12-26-030000
**Source**: STATUS-2025-12-26-030000.md
**Topic**: block-compiler-migration
**Scope**: Migrate block compilers from closure emission to IR emission

---

## Executive Summary

**Current State**: All 36 block compilers emit closures via `BlockCompiler.compile()`. Pass 6 creates placeholder IR from these closure artifacts.

**Target State**: Block compilers emit IR nodes directly via `BlockLowerFn` taking `LowerCtx` and returning `LowerResult`.

**Sprint Goal**: Establish IR lowering infrastructure and migrate all Signal blocks (13 blocks) to direct IR emission using parallel workstreams.

**Total Work Items**: 18 (P0: 3, P1: 13, P2: 2)

**Parallel Execution**: 4 independent workstreams after initial types are created.

---

## Workstream Architecture

```
WORKSTREAM A (BLOCKING - Sequential)
└─> Create IR lowering types
    └─> UNLOCKS all other workstreams

WORKSTREAM B (Parallel - after A)     WORKSTREAM C (Parallel - after A)
├─> Signal blocks 1-7                 ├─> Signal blocks 8-13
│   ├─> AddSignal                     │   ├─> Oscillator
│   ├─> SubSignal                     │   ├─> Shaper
│   ├─> MulSignal                     │   ├─> ColorLFO
│   ├─> DivSignal                     │   ├─> PulseDivider
│   ├─> MinSignal                     │   ├─> TriggerOnWrap
│   ├─> MaxSignal                     │   └─> EnvelopeAD
│   └─> ClampSignal                   │

WORKSTREAM D (Parallel - after A)
└─> Domain IR design (prep for next sprint)
```

**Execution Strategy**: One agent per workstream. Workstream A must complete before B/C/D can start. B/C/D execute in parallel.

---

## Priority 0: Foundation (BLOCKING)

These items MUST complete before any block migration can proceed.

---

### P0-1: Create IR Lowering Types

**Status**: Not Started
**Effort**: Medium
**Dependencies**: None
**Spec Reference**: 16-Block-Lowering.md § 1-2 • **Status Reference**: STATUS-2025-12-26-030000.md § Missing Infrastructure

#### Description

Create the missing type definitions from the design spec that define the block lowering contract. These types do not exist in the codebase and are required for all block migrations.

Create file: `src/editor/compiler/ir/lowerTypes.ts`

The design spec defines these types explicitly in 16-Block-Lowering.md but they are missing from the implementation. This creates the compiler-facing contract that blocks use to emit IR.

#### Acceptance Criteria (REQUIRED)

- [ ] `BlockCapability` type created with all variants: 'time', 'identity', 'state', 'render', 'io', 'pure'
- [ ] `BlockPortDecl` interface created with portId, label, dir, type, optional fields
- [ ] `BlockTypeDecl` interface created with type, capability, inputs, outputs, lower function
- [ ] `BlockLowerFn` type alias created matching spec signature: `(args: { ctx: LowerCtx; inputs: ValueRefPacked[]; config?: unknown }) => LowerResult`
- [ ] `LowerCtx` interface created with blockIdx, blockType, instanceId, label, inTypes, outTypes, b (IRBuilder), seedConstId
- [ ] `LowerResult` interface created with outputs array and optional declares
- [ ] `BlockDeclarations` interface created with timeModel, domainOut, renderSink fields
- [ ] All types exported from `src/editor/compiler/ir/index.ts`
- [ ] TypeScript compilation succeeds with no errors

#### Technical Notes

**File Location**: `src/editor/compiler/ir/lowerTypes.ts` (new file)

**Dependencies**:
- Import `TypeDesc` from `./types.ts`
- Import `IRBuilder` from `./IRBuilder.ts`
- Import `TimeModel` from `../types.ts`

**Reference Implementation**: See design-docs/12-Compiler-Final/16-Block-Lowering.md lines 20-151

The `ValueRefPacked` type already exists in `pass6-block-lowering.ts` but should be moved to `lowerTypes.ts` for consistency. Current definition only has `sig` and `field` kinds - verify this matches spec requirements.

**Critical**: These types define the contract between block compilers and the IR system. They must match the design spec exactly.

---

### P0-2: Extend ValueRefPacked Type

**Status**: Not Started
**Effort**: Small
**Dependencies**: P0-1
**Spec Reference**: 16-Block-Lowering.md § 2 • **Status Reference**: STATUS-2025-12-26-030000.md § Missing Infrastructure

#### Description

Move and extend `ValueRefPacked` from pass6-block-lowering.ts to lowerTypes.ts. The current implementation only handles `sig` and `field` kinds, but the spec requires `scalarConst` and `special` kinds for full block migration support.

#### Acceptance Criteria (REQUIRED)

- [ ] `ValueRefPacked` type moved from `pass6-block-lowering.ts` to `lowerTypes.ts`
- [ ] Added `scalarConst` variant with `constId: number` field
- [ ] Added `special` variant with `tag: string` and `id: number` fields
- [ ] Import updated in `pass6-block-lowering.ts` from new location
- [ ] All existing usages continue to work (no breaking changes)
- [ ] TypeScript compilation succeeds

#### Technical Notes

**Current Location**: `src/editor/compiler/passes/pass6-block-lowering.ts`
**New Location**: `src/editor/compiler/ir/lowerTypes.ts`

The spec defines 4 variants total:
```typescript
export type ValueRefPacked =
  | { k: 'sig', id: SigId }
  | { k: 'field', id: FieldId }
  | { k: 'scalarConst', constId: number }
  | { k: 'special', tag: string, id: number };
```

The `special` variant will be used for Domain, RenderTree, and other non-signal/field values.

---

### P0-3: Create BlockTypeDecl Registry Infrastructure

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P0-1, P0-2
**Spec Reference**: 16-Block-Lowering.md § 1 • **Status Reference**: STATUS-2025-12-26-030000.md § Missing Infrastructure

#### Description

Create registry infrastructure for `BlockTypeDecl` declarations that run parallel to the existing `BlockCompiler` registry. This enables dual-emit mode where blocks can provide both a legacy closure compiler AND an IR lowering function.

Create file: `src/editor/compiler/ir/blockRegistry.ts`

#### Acceptance Criteria (REQUIRED)

- [ ] `blockTypeRegistry` Map created to store BlockTypeDecl by block type string
- [ ] `registerBlockType(decl: BlockTypeDecl): void` function created
- [ ] `getBlockType(type: string): BlockTypeDecl | undefined` function created
- [ ] `hasBlockType(type: string): boolean` function created
- [ ] Registry is separate from but compatible with existing BlockCompiler registry
- [ ] Exported from `src/editor/compiler/ir/index.ts`
- [ ] Unit test created verifying registration and retrieval
- [ ] TypeScript compilation succeeds

#### Technical Notes

**Design Choice**: Keep IR registry separate from closure registry to support dual-emit mode. Blocks can register BOTH a BlockCompiler (closures) AND a BlockTypeDecl (IR) during migration.

**Future**: When all blocks migrate to IR, BlockCompiler registry can be deprecated.

**Integration Point**: Pass 6 will check if a block has a BlockTypeDecl registered. If yes, call the `lower` function. If no, fall back to closure-to-IR translation.

---

## Priority 1: Signal Block Migration (Tier 1 + Tier 2)

These blocks can migrate immediately after P0 items complete. They have no dependencies on Domain/Field infrastructure.

**Workstream B**: Items P1-1 through P1-7
**Workstream C**: Items P1-8 through P1-13

---

### P1-1: Migrate AddSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P0-1, P0-2, P0-3
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 62)

#### Description

Migrate AddSignal from closure emission to IR emission. This is the simplest block and serves as the migration pattern proof-of-concept. Creates a `sigOp` node with OpCode.Add.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerAddSignal` function created implementing BlockLowerFn signature
- [ ] Function extracts two signal inputs from `inputs` array
- [ ] Creates IR node via `ctx.b.sigOp(OpCode.Add, [sig1, sig2], outType, prov)`
- [ ] Returns `LowerResult` with single output `{ k: 'sig', id: sigId }`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created comparing closure output vs IR output on same inputs
- [ ] Existing closure path still works (dual-emit mode)
- [ ] Unit test verifies IR emission produces correct node structure

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/AddSignal.ts`

**Migration Pattern**:
```typescript
const lowerAddSignal: BlockLowerFn = ({ ctx, inputs }) => {
  const a = inputs[0]; // { k: 'sig', id: ... }
  const b = inputs[1];

  const sigId = ctx.b.sigOp(OpCode.Add, [a.id, b.id], ctx.outTypes[0], {
    blockIdx: ctx.blockIdx,
    label: ctx.label
  });

  return { outputs: [{ k: 'sig', id: sigId }] };
};
```

**Test Strategy**: Create dual-emit test that compiles patch with both closure and IR modes, evaluates both at t=0, t=1000, t=5000, and asserts numeric equality.

**Golden Test Pattern**: Will be reused for all signal blocks.

---

### P1-2: Migrate SubSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 63)

#### Description

Migrate SubSignal using the exact same pattern as AddSignal but with OpCode.Sub.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerSubSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Sub, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created using same dual-emit pattern as P1-1
- [ ] Test validates subtraction at t=0, t=1000, t=5000
- [ ] Dual-emit mode verified working

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/SubSignal.ts`
**Reuse**: Copy P1-1 test structure, change operation and expected values.

---

### P1-3: Migrate MulSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 64)

#### Description

Migrate MulSignal using OpCode.Mul.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerMulSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Mul, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating multiplication
- [ ] Test covers edge cases: 0 * x = 0, 1 * x = x
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/MulSignal.ts`

---

### P1-4: Migrate DivSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 65)

#### Description

Migrate DivSignal using OpCode.Div.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerDivSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Div, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating division
- [ ] Test covers edge case: divide by zero behavior matches closure
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/DivSignal.ts`
**Edge Case**: Verify divide-by-zero behavior matches between closure and IR.

---

### P1-5: Migrate MinSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 66)

#### Description

Migrate MinSignal using OpCode.Min.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerMinSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Min, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating min operation
- [ ] Test validates: min(a, b) where a < b, a > b, a == b
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/MinSignal.ts`

---

### P1-6: Migrate MaxSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 67)

#### Description

Migrate MaxSignal using OpCode.Max.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerMaxSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Max, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating max operation
- [ ] Test validates: max(a, b) where a < b, a > b, a == b
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/MaxSignal.ts`

---

### P1-7: Migrate ClampSignal Block

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 1 (line 68)

#### Description

Migrate ClampSignal. This block has 2 inputs (value, range) where range could be a signal or defaultSource. Uses clamp kernel logic.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerClampSignal` function created
- [ ] Extracts value signal and min/max signals from inputs
- [ ] Creates clamp operation: `min(max(value, minVal), maxVal)`
- [ ] Uses nested `sigOp` calls or single `sigClamp` if available
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates clamping behavior at boundaries
- [ ] Test covers: value < min, min < value < max, value > max
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/math/ClampSignal.ts`
**Status Note**: Has 2 params according to STATUS. Verify if these should become defaultSource inputs instead (per spec: kill params).

---

### P1-8: Migrate Oscillator Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P1-1 through P1-7 (for pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 2 (line 77)

#### Description

Migrate Oscillator block. Has 3 params: shape (sine/tri/square/saw), frequency, amplitude. Shape param selects waveform kernel.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerOscillator` function created
- [ ] Shape parameter converted to config field (or defaultSource if user-adjustable)
- [ ] Frequency and amplitude taken from inputs array
- [ ] Shape selection creates appropriate waveform IR node (sin/tri/square/saw)
- [ ] Each waveform kernel implemented as sigOp sequence
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates all 4 waveforms match closure output
- [ ] Test samples multiple time points and frequencies
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/signal/Oscillator.ts`
**Complexity**: Parameterized shape selection requires branching logic or kernel dispatch.
**Config vs Input**: Clarify if shape should be static config or dynamic input.

---

### P1-9: Migrate Shaper Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P1-8 (for parameterized pattern)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 2 (line 78)

#### Description

Migrate Shaper block. Has 2 params: kind (ease-in/ease-out/smoothstep/etc), amount. Kind param selects shaping function.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerShaper` function created
- [ ] Kind parameter handled as config or defaultSource
- [ ] Amount parameter taken from inputs
- [ ] All shaping functions implemented as IR node sequences
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates each shaping mode matches closure
- [ ] Test covers input range [0, 1] and edge cases
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/signal/Shaper.ts`

---

### P1-10: Migrate ColorLFO Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P1-8, P1-9 (for complex pattern reference)
**Spec Reference**: 16-Block-Lowering.md § 4-7 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 2 (line 79)

#### Description

Migrate ColorLFO block. Most complex signal block: 4 params, color space math with HSL conversion. Outputs Signal:color.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerColorLFO` function created
- [ ] All 4 parameters handled appropriately (config vs inputs)
- [ ] HSL to RGB conversion implemented as IR node sequence
- [ ] Phase-driven color cycling logic preserved
- [ ] Output type is Signal:color
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates color output at multiple time points
- [ ] Test verifies HSL interpolation matches closure exactly
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/signal/ColorLFO.ts`
**Complexity**: HSL color space math requires multiple IR nodes. Consider using helper function to build HSL->RGB IR graph.

---

### P1-11: Migrate PulseDivider Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P0-1, P0-2, P0-3 (stateful infrastructure)
**Spec Reference**: 16-Block-Lowering.md § 6 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 2 (line 80)

#### Description

Migrate PulseDivider block. This is a STATEFUL block (capability: 'state') with 1 param. Requires `sigStateful` and state allocation.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerPulseDivider` function created
- [ ] State layout defined for pulse division counter
- [ ] State allocated via `ctx.b.allocState(layout, prov)`
- [ ] `sigStateful` node created with SigStateOp.PulseDivider
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates pulse division across multiple cycles
- [ ] Test verifies state persistence between evaluations
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/rhythm/PulseDivider.ts`
**State Layout**: Define counter state as i32.
**Critical**: First stateful block migration - pattern will be reused.

---

### P1-12: Migrate TriggerOnWrap Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P1-11 (for stateful pattern)
**Spec Reference**: 16-Block-Lowering.md § 6 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 2 (line 81)

#### Description

Migrate TriggerOnWrap block. Detects phase wrapping and outputs trigger event. Requires state to track previous phase value.

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerTriggerOnWrap` function created
- [ ] State layout defined for previous phase value (f32)
- [ ] State allocated via `ctx.b.allocState`
- [ ] `sigStateful` node created with SigStateOp.TriggerOnWrap
- [ ] Event detection logic preserved in IR
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates trigger timing on phase wraps
- [ ] Test verifies no false triggers on continuous phase
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/signal/TriggerOnWrap.ts`
**State**: Previous phase value (f64 or f32).

---

### P1-13: Migrate EnvelopeAD Block

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P1-11, P1-12 (for stateful pattern)
**Spec Reference**: 16-Block-Lowering.md § 6 • **Status Reference**: STATUS-2025-12-26-030000.md § Tier 8 (line 154)

#### Description

Migrate EnvelopeAD block. Complex stateful block with attack/decay timing. Tracks envelope state (attack/decay/idle phase and current level).

#### Acceptance Criteria (REQUIRED)

- [ ] `lowerEnvelopeAD` function created
- [ ] State layout defined for envelope phase and level
- [ ] State allocated with slots for: phase (i32), level (f32), trigger timestamp (f64)
- [ ] `sigStateful` node created with SigStateOp.EnvelopeAD
- [ ] Attack and decay timing parameters handled correctly
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates envelope shape matches closure
- [ ] Test covers trigger, attack phase, decay phase, retriggering
- [ ] Dual-emit mode verified

#### Technical Notes

**File**: `src/editor/compiler/blocks/rhythm/EnvelopeAD.ts`
**State Complexity**: Multi-slot state layout (phase enum + level + timing).
**Critical**: Most complex stateful signal block. Will validate state infrastructure thoroughly.

---

## Priority 2: Preparation for Next Sprint

These items prepare infrastructure for Field/Domain block migration but are not executed in this sprint.

---

### P2-1: Design Domain IR Representation

**Status**: Not Started
**Effort**: Medium
**Dependencies**: P0-1, P0-2
**Spec Reference**: 16-Block-Lowering.md § 3 • **Status Reference**: STATUS-2025-12-26-030000.md § Ambiguities (line 352)

#### Description

Design and document how Domain artifacts are represented in IR. STATUS identifies this as NEEDS_CLARIFICATION - the spec mentions `DomainId` but it's not implemented.

This is a DESIGN task, not an implementation task. Output is a design document that will guide next sprint's Domain block migrations.

#### Acceptance Criteria (REQUIRED)

- [ ] Design document created: `design-docs/12-Compiler-Final/17-Domain-IR-Representation.md`
- [ ] Document answers: How is Domain represented in ValueRefPacked?
- [ ] Document specifies: Where is Domain data stored (special table vs ValueSlot)?
- [ ] Document clarifies: How do Field blocks reference Domain (domainRef parameter)?
- [ ] Document defines: DomainId type and allocation strategy
- [ ] Document explains: Domain position metadata (N, positions array)
- [ ] Ambiguity from STATUS § line 352 resolved with explicit decision
- [ ] Design reviewed against existing Domain producer blocks (DomainN, GridDomain)
- [ ] Integration points identified for `domainFromN` and `domainPositions` IRBuilder methods

#### Technical Notes

**STATUS Note**: Line 352 identifies 3 options:
- A) ValueSlot with domain tag
- B) Separate DomainIR table
- C) Field with special metadata

**Recommendation**: Option B (Separate DomainIR table) aligns with design spec which treats Domain as "special typed root, not a Field" (line 144).

**Reference**: IRBuilder already has `domainFromN` method (line 228) - use this as starting point.

---

### P2-2: Create SignalExpr Integration Test Suite

**Status**: Not Started
**Effort**: Small
**Dependencies**: P1-1 through P1-13
**Spec Reference**: STATUS § Test Infrastructure • **Status Reference**: STATUS-2025-12-26-030000.md § Test Infrastructure (line 313)

#### Description

Create comprehensive integration test suite that validates all migrated Signal blocks produce equivalent output between closure and IR evaluation modes.

#### Acceptance Criteria (REQUIRED)

- [ ] Test file created: `src/editor/compiler/__tests__/signal-blocks-ir-equivalence.test.ts`
- [ ] Test compiles patch using ALL migrated signal blocks (P1-1 through P1-13)
- [ ] Test evaluates both closure and IR paths at t=0, t=1000, t=5000, t=10000
- [ ] Test asserts numeric equivalence with epsilon tolerance for floating point
- [ ] Test covers all waveform shapes in Oscillator
- [ ] Test covers all shaping modes in Shaper
- [ ] Test validates stateful blocks maintain state correctly
- [ ] Test validates ColorLFO produces identical RGB values
- [ ] All tests pass with dual-emit mode enabled

#### Technical Notes

**Purpose**: Validates that the entire Signal block migration maintains behavioral equivalence with closure implementation.

**Test Pattern**:
```typescript
test('Signal blocks IR equivalence', () => {
  const result = compilePatch(patch, registry, seed, ctx, { emitIR: true });

  const closureOutput = evaluateClosure(result.program, t);
  const irOutput = evaluateIR(result.ir, t);

  expect(closureOutput).toBeCloseTo(irOutput, 6); // 6 decimal places
});
```

---

## Dependency Graph

```
P0-1 (Create IR Lowering Types)
  └─> P0-2 (Extend ValueRefPacked)
       └─> P0-3 (BlockTypeDecl Registry)
            ├─> P1-1 (AddSignal)
            │    └─> P1-2 (SubSignal)
            │         └─> P1-3 (MulSignal)
            │              └─> P1-4 (DivSignal)
            │                   └─> P1-5 (MinSignal)
            │                        └─> P1-6 (MaxSignal)
            │                             └─> P1-7 (ClampSignal)
            │
            ├─> P1-8 (Oscillator)
            │    └─> P1-9 (Shaper)
            │         └─> P1-10 (ColorLFO)
            │
            ├─> P1-11 (PulseDivider - stateful)
            │    └─> P1-12 (TriggerOnWrap)
            │         └─> P1-13 (EnvelopeAD)
            │
            └─> P2-1 (Domain IR Design)

P1-1 through P1-13 -> P2-2 (Integration Test Suite)
```

---

## Parallel Execution Plan

### Phase 1: Sequential Foundation (Workstream A)
**Agent**: Single agent
**Items**: P0-1, P0-2, P0-3
**Duration**: ~1 complexity unit
**Blocker**: MUST complete before Phase 2

### Phase 2: Parallel Migration (Workstreams B, C, D)

**Workstream B** (Agent 1):
- P1-1: AddSignal
- P1-2: SubSignal
- P1-3: MulSignal
- P1-4: DivSignal
- P1-5: MinSignal
- P1-6: MaxSignal
- P1-7: ClampSignal

**Workstream C** (Agent 2):
- P1-8: Oscillator
- P1-9: Shaper
- P1-10: ColorLFO
- P1-11: PulseDivider
- P1-12: TriggerOnWrap
- P1-13: EnvelopeAD

**Workstream D** (Agent 3):
- P2-1: Domain IR Design

**Duration**: ~3 complexity units (parallel)

### Phase 3: Integration (Sequential)
**Agent**: Any
**Items**: P2-2
**Duration**: ~0.5 complexity units
**Depends**: All P1 items complete

---

## Risk Assessment

### High Risk

**Risk**: Stateful blocks (P1-11, P1-12, P1-13) may expose gaps in state allocation infrastructure.
**Mitigation**: Migrate P1-11 first as proof-of-concept. Block on P1-12/P1-13 if issues found.
**Impact**: Could delay Workstream C completion.

**Risk**: Dual-emit mode may expose incompatibilities between closure and IR type systems.
**Mitigation**: P1-1 (AddSignal) validates the pattern. Adjust strategy if issues found.
**Impact**: Could require redesign of P0 types.

### Medium Risk

**Risk**: ColorLFO (P1-10) HSL conversion may not have equivalent IR operations.
**Mitigation**: Investigate OpCode availability for HSL math before starting P1-10.
**Impact**: May need to add new OpCodes.

**Risk**: Config vs defaultSource decision not finalized for parameterized blocks.
**Mitigation**: Follow spec guidance: "kill params, use defaultSource inputs instead."
**Impact**: User-adjustable params become visible inputs in patch bay.

### Low Risk

**Risk**: Golden test infrastructure may need enhancement.
**Mitigation**: P1-1 creates the pattern - iterate if needed.

---

## Next Sprint Preview

**After this sprint completes**:

1. All Signal blocks (13) emitting IR directly
2. Domain IR representation designed and documented
3. Dual-emit mode validated across signal domain
4. Foundation ready for Field block migration

**Next Sprint Focus**:
- P0: Implement Domain IR infrastructure (based on P2-1 design)
- P1: Migrate Field producer blocks (Tier 3: 6 blocks)
- P2: Migrate Field transformer blocks (Tier 4: 9 blocks)
- P3: Migrate Domain producer blocks (Tier 5: 3 blocks)

---

## Success Criteria

This sprint is successful when:

1. All P0 items complete (types exist, registry working)
2. All 13 Signal blocks (P1-1 through P1-13) emit IR directly
3. Dual-emit mode works for all migrated blocks
4. Golden tests pass showing closure ≡ IR equivalence
5. Domain IR representation designed for next sprint
6. Integration test suite validates all migrations
7. No regression in existing closure-based runtime

---

## Blockers and Questions

### BLOCKER: Domain IR Representation
**Status**: Addressed by P2-1 (design task)
**Decision Required**: Choose between ValueSlot tag vs separate DomainIR table
**Blocking**: Field block migration (next sprint)

### QUESTION: Config vs DefaultSource for User Params
**Spec Guidance**: 16-Block-Lowering.md § 2 line 107-109 says "kill params, use DefaultSource"
**Impact**: Affects P1-8, P1-9, P1-10
**Recommendation**: Convert user-adjustable params to defaultSource inputs

### QUESTION: State Layout Hash Algorithm
**Spec Reference**: 16-Block-Lowering.md § 6 line 291 mentions `layoutHash`
**Impact**: Affects P1-11, P1-12, P1-13
**Recommendation**: Use stable hash of state slot definitions (name + type + count)

---

## File Management

**Files Created This Sprint**:
- `src/editor/compiler/ir/lowerTypes.ts` (P0-1)
- `src/editor/compiler/ir/blockRegistry.ts` (P0-3)
- `design-docs/12-Compiler-Final/17-Domain-IR-Representation.md` (P2-1)
- `src/editor/compiler/__tests__/signal-blocks-ir-equivalence.test.ts` (P2-2)

**Files Modified This Sprint**:
- All Signal block files (13 files) - add `lower` functions
- `src/editor/compiler/ir/index.ts` - export new types
- `src/editor/compiler/passes/pass6-block-lowering.ts` - import ValueRefPacked from new location

---

## Summary

**Total Items**: 18
**P0 (Critical)**: 3 items - Foundation types and registry
**P1 (High)**: 13 items - All Signal block migrations
**P2 (Medium)**: 2 items - Next sprint preparation

**Parallel Potential**: 4 workstreams (1 sequential + 3 parallel)
**Complexity**: ~4.5 units total (~1 sequential + ~3 parallel + ~0.5 integration)

**Key Deliverable**: All Signal blocks emitting IR directly, dual-emit validated, foundation ready for Field/Domain migration.
