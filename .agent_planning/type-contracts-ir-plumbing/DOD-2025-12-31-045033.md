# Definition of Done: Type Contracts + IR Plumbing
**Generated:** 2025-12-31-045033
**Plan:** PLAN-2025-12-31-045033.md
**Topic:** type-contracts-ir-plumbing

---

## Acceptance Criteria

### P0: Fix Test Blocker

**Deliverable:** Unblock typecheck pipeline

- [ ] Add `debugProbes` field to all 6 test mocks in `src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts`
- [ ] `just typecheck` passes without errors
- [ ] Test file imports and runs without type errors
- [ ] Mock structure matches current `BuilderProgramIR` interface exactly

---

### P0: Unified TypeDesc Contract

**Deliverable:** Single authoritative type contract in `src/core/types.ts`

- [ ] Create unified `TypeDesc` interface in `src/core/types.ts` with fields:
  - `world: TypeWorld` (union includes `'signal' | 'event' | 'field' | 'scalar' | 'config'`)
  - `domain: Domain` (migrate from editor/Domain type)
  - `category: TypeCategory` (migrate from editor)
  - `busEligible: boolean` (migrate from editor)
  - `lanes?: number[]` (NEW - semantic shape, replaces bundleKind/bundleArity)
  - `semantics?: string` (preserved from both)
  - `unit?: string` (preserved from both)
- [ ] Update editor (`src/editor/types.ts`) to re-export unified TypeDesc:
  - Remove local TypeDesc definition
  - Export `type TypeDesc = CoreTypeDesc` from core/types
  - Update all editor code to use re-exported type
- [ ] Update compiler IR (`src/editor/compiler/ir/types.ts`) to use unified TypeDesc:
  - Remove local TypeDesc definition
  - Import from `src/core/types.ts`
  - Update all IR code to use unified type
- [ ] Migrate `'special'` world references to appropriate alternatives:
  - If crossing editor/compiler boundary → `'config'`
  - If IR-internal metadata → remove from TypeDesc, use opaque IDs or enums
- [ ] Create migration helper `bundleKindToLanes(kind: BundleKind): number[]`:
  - Maps `'scalar'` → `[1]`, `'vec2'` → `[2]`, `'vec3'` → `[3]`, `'rgba'` → `[4]`, etc.
  - Use during migration, remove once all code uses `lanes`
- [ ] All typecheck errors resolved (no incompatible TypeDesc errors)
- [ ] Unit tests pass for type utilities (if any exist)

---

### P1: DefaultSource Shared Helper

**Deliverable:** Extract and align defaultSource materialization logic

- [ ] Create `src/editor/compiler/ir/defaultSourceUtils.ts` with exported helper:
  ```typescript
  export function materializeDefaultSource(
    builder: IRBuilder,
    type: TypeDesc,
    value: unknown
  ): ValueRefPacked | null
  ```
- [ ] Helper handles all worlds consistently:
  - `signal` (numeric): `sigConst` + `allocValueSlot` + `registerSigSlot` → `{ k: "sig", id, slot }`
  - `signal` (non-numeric): `allocConstId` → `{ k: "scalarConst", constId }`
  - `field`: `fieldConst` + `allocValueSlot` + `registerFieldSlot` → `{ k: "field", id, slot }`
  - `scalar`: `allocConstId` → `{ k: "scalarConst", constId }`
  - `config`: `allocConstId` → `{ k: "scalarConst", constId }`
  - `event`: Return `null` (events have no default values)
- [ ] Update Pass6 (`src/editor/compiler/passes/pass6-block-lowering.ts` lines 308-342):
  - Replace inline defaultSource logic with call to `materializeDefaultSource()`
  - Remove `special/domain` special case (no longer needed after TypeDesc unification)
  - Verify signal non-numeric handling now uses const pool (not coercion)
- [ ] Update Pass8 (`src/editor/compiler/passes/pass8-link-resolution.ts` lines 155-185):
  - Replace `createDefaultRef()` local helper with call to `materializeDefaultSource()`
  - Add `config` world handling (same as scalar)
- [ ] Add unit tests for `materializeDefaultSource()`:
  - Signal numeric: Returns sig + slot
  - Signal non-numeric (e.g., string): Returns scalarConst
  - Field: Returns field + slot
  - Scalar: Returns scalarConst
  - Config: Returns scalarConst
  - Event: Returns null
  - Verify `lanes` field is respected (if TypeDesc has lanes, allocate correct slot count)
- [ ] Integration test: Verify defaults resolve identically in pass6 and pass8 paths
- [ ] No regressions in existing defaultSource behavior (run full test suite)

---

### P1: Harden Pass 8 Link Resolution

**Deliverable:** Add missing IR validations to catch errors at compile-time

- [ ] **Output Slot Validation:**
  - After all blocks lowered, iterate `blockOutputRoots` in IR
  - For each output, verify slot is registered (check `sigSlots`, `fieldSlots`, or `scalarConsts`)
  - Emit `MissingOutputRegistration` diagnostic if output has no slot
  - Include `{ blockId, portId, type }` in error metadata
- [ ] **Bus Publisher Validation:**
  - After bus lowering (pass7), iterate `busRoots` in IR
  - For each bus, verify at least one block output publishes to it
  - Check block outputs' `busTargets` field for matching bus ID
  - Emit `BusWithoutPublisher` diagnostic if bus has zero publishers
  - Include `{ busId, busType }` in error metadata
- [ ] **Null ValueRef Documentation:**
  - Add code comment in pass8 wire resolution (near line 625) explaining:
    - When null is expected: Non-IR types (Domain, Event without data)
    - When null is error: IR types (signal/field/scalar) with missing data
  - Add runtime assertion: If null for IR type, emit diagnostic instead of silent skip
- [ ] Add unit tests for new validations:
  - Block with output port but no slot registration → `MissingOutputRegistration` error
  - Bus with zero publishers → `BusWithoutPublisher` error
  - Wire to signal port resolves to null → diagnostic emitted
  - Event port resolves to null → NO error (expected behavior)
- [ ] Integration test: Build patch with intentional validation errors, verify all diagnostics emitted
- [ ] Verify error messages are actionable (include block/port/bus names, not just IDs)

---

## Sprint Scope

**This sprint delivers:**
1. Unified TypeDesc contract (single authoritative type definition)
2. DefaultSource shared helper (consistent materialization across pass6/pass8)
3. Pass 8 validation hardening (output/bus/null checks)

**Deferred:**
- Advanced lens parameter bindings (documented TODO)
- Performance optimization (separate workstream)
- End-to-end runtime verification (separate workstream)

---

## Sprint-Level Definition of Done

- [ ] All P0 deliverables complete with acceptance criteria met
- [ ] All P1 deliverables complete with acceptance criteria met
- [ ] `just check` passes (typecheck + lint + test)
- [ ] No new runtime errors introduced
- [ ] All validation errors include actionable messages
- [ ] Code review completed
- [ ] Commits follow convention (feat/fix/refactor)

---

**End of Definition of Done**
