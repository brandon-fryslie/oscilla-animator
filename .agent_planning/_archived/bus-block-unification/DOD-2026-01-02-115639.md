# Definition of Done: Final Cleanup Sprint
**Generated**: 2026-01-02-115639
**Plan**: PLAN-2026-01-02-115639.md
**Topic**: bus-block-unification

---

## Sprint Scope

This sprint delivers **100% completion** of the bus-block-unification topic by removing ALL remaining legacy artifacts.

**Deliverables**:
1. Legacy type definitions removed from core types
2. Diagnostic system updated to use BusBlock references
3. All stub UI components restored or deleted
4. Migration utilities audited and justified
5. Code hygiene: no outdated TODOs or unused imports

**Deferred**: None - this is the final cleanup sprint

---

## Acceptance Criteria

### P0-A: Remove Legacy Type Definitions from types.ts

**Type System Cleanup**:
- [ ] `Connection` interface REMOVED from types.ts (or moved to migration.ts with "legacy only" comment)
- [ ] `Bus` interface REMOVED from types.ts OR moved to bus-block/conversion.ts with clear "UI facade only" comment
- [ ] `LensParamBinding` `kind: 'bus'` variant REMOVED (or documented as required with rationale)
- [ ] `DefaultSourceState` interface REMOVED or marked with `@deprecated` JSDoc and removal timeline
- [ ] All files importing removed types updated to use Edge/BusBlock/PortRef equivalents
- [ ] Zero TypeScript compilation errors
- [ ] All 2523 tests still pass

**Verification**:
```bash
# Must pass:
just typecheck
just test
# Must show 0 matches (or only migration.ts):
grep -r "interface Connection" src/editor/types.ts
grep -r "interface Bus" src/editor/types.ts
```

---

### P0-B: Clean Up Diagnostic System Legacy Types

**Diagnostic Type Migration**:
- [ ] `BusTargetRef { kind: 'bus' }` REMOVED from diagnostics/types.ts
- [ ] `BindingTargetRef { kind: 'binding' }` REMOVED from diagnostics/types.ts
- [ ] All diagnostic creation code uses `BlockTargetRef` for BusBlocks (blockId = bus ID)
- [ ] All diagnostic creation code uses `PortTargetRef` for edge-related errors
- [ ] `TargetRef` union type no longer includes bus/binding variants
- [ ] Diagnostic action executor correctly handles BusBlock-targeted diagnostics
- [ ] All diagnostic tests pass (run `just test -- diagnostics`)

**Verification**:
```bash
# Must show 0 matches in diagnostics/types.ts:
grep "kind: 'bus'" src/editor/diagnostics/types.ts
grep "kind: 'binding'" src/editor/diagnostics/types.ts
# Manual test: Create diagnostic targeting BusBlock, verify it appears in UI
```

---

### P1-A: Remove or Restore Bus UI Components

**Component Assessment Complete**:
- [ ] Each component assessed with decision documented: DELETE, RESTORE, or KEEP
  - `BusBoard.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `BusChannel.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `BusCreationDialog.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `BusInspector.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `BusPicker.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `BusViz.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)
  - `ConnectionInspector.tsx` - Decision: _______ (DELETE/RESTORE/KEEP)

**Deleted Components**:
- [ ] Component files deleted from filesystem
- [ ] All imports of deleted components removed
- [ ] CSS files for deleted components removed (if no longer needed)
- [ ] Routes/layout code updated to remove deleted component references

**Restored Components**:
- [ ] Zero references to `busStore` (use `patchStore`)
- [ ] Zero references to legacy `Bus` type (use `Block` with type check or conversion helper)
- [ ] Zero references to `Connection` type (use `Edge`)
- [ ] All components render without errors
- [ ] Event handling uses Edge-based events (not legacy bus events)

**Kept Components**:
- [ ] Code review confirms no legacy dependencies
- [ ] Components use current API (BusBlock, Edge, PortRef)

**Functional Verification**:
- [ ] Manual test: Create new BusBlock via UI (if dialog kept) → Success
- [ ] Manual test: Select BusBlock → Inspector shows details (if inspector kept) → Success
- [ ] Manual test: View bus mixer (if BusBoard kept) → Shows all BusBlocks → Success
- [ ] Manual test: Connect edge to BusBlock → Visualization updates (if BusViz kept) → Success

---

### P1-B: Clean Up Debug UI Stubs

**Debug Component Status**:
- [ ] Each debug component assessed: DELETE or RESTORE
  - `debug-ui/IRTab.tsx` - Decision: _______ (DELETE/RESTORE)
  - `debug-ui/BusesTab.tsx` - Decision: _______ (DELETE/RESTORE)
  - `debug-ui/ProbeCard.tsx` - Decision: _______ (DELETE/RESTORE)
  - `debug-ui/OverviewTab.tsx` - Decision: _______ (DELETE/RESTORE)

**Deleted Debug Components**:
- [ ] Files deleted, imports removed
- [ ] Debug panel tab routing updated

**Restored Debug Components**:
- [ ] Components show BusBlocks correctly (not legacy Bus entities)
- [ ] Components render without errors

**Verification**:
```bash
# Manual test: Open debug panel, switch tabs, verify no console errors
```

---

### P2-A: Audit Migration Utilities for Removal or Retention

**Migration Assessment Complete**:
- [ ] All migration utility files identified and listed
- [ ] Decision made for each file: KEEP or DELETE with justification documented

**If KEEPING Migration Utilities**:
- [ ] Each kept file has JSDoc header: `@fileoverview Legacy format migration - do not use for new code`
- [ ] Each kept file documents minimum supported patch version
- [ ] Test exists that loads old patch format and verifies conversion succeeds
- [ ] Migration code isolated to `src/editor/legacy/` or `src/editor/migration/` directory (optional but recommended)

**If DELETING Migration Utilities**:
- [ ] All imports removed
- [ ] Tests updated to not reference migration functions
- [ ] Documentation updated: "Minimum supported patch version: X.Y.Z"
- [ ] Decision rationale documented in commit message

**Files to Assess**:
- [ ] `bus-block/conversion.ts` - Decision: _______ (KEEP/DELETE)
  - Justification: _______
- [ ] `edgeMigration.ts` (if exists) - Decision: _______ (KEEP/DELETE)
  - Justification: _______
- [ ] Migration code in `transactions/applyOps.ts` - Decision: _______ (KEEP/DELETE)
  - Justification: _______

---

### P2-B: Clean Up Compiler IR Legacy Types

**IR Type Assessment**:
- [ ] All `kind: 'bus'` references in IR reviewed:
  - [ ] `ir/schema/CompiledProgramIR.ts:239` - Valid or Legacy? _______
  - [ ] `compiler/ir/schedule.ts:809` - Valid or Legacy? _______
  - [ ] `compiler/unified/FieldExpr.ts:47` - Valid or Legacy? _______
- [ ] Decision: Are these valid runtime busIndex references or legacy?

**If Legacy (Must Fix)**:
- [ ] Legacy `kind: 'bus'` IR types removed
- [ ] Compiler tests updated to match new IR schema
- [ ] IR serialization only emits current schema

**If Valid (Document)**:
- [ ] Comments added explaining: "busIndex in IR = runtime bus storage, NOT legacy Bus type"
- [ ] Consider renaming to `kind: 'busStorage'` for clarity (optional)

**Verification**:
- [ ] All compiler tests pass (`just test -- compiler`)
- [ ] Manual test: Compile patch with BusBlock → Inspect IR → Structure matches schema documentation

---

### P3-A: Update Comments and TODOs

**Comment Cleanup**:
- [ ] All `STUB|PLACEHOLDER` comments in production code (src/editor, excluding tests) reviewed
- [ ] Outdated comments removed or updated
- [ ] Remaining legacy code has clear comments explaining why it exists

**Specific Patterns**:
- [ ] Zero references to "Sprint 3" in code (use "Phase N" or "Topic: X" instead)
- [ ] Zero "will be removed in Sprint X" comments for already-completed sprints
- [ ] Migration utility comments explain old format version (e.g., "Supports patch format v1.2.3")

**Allowed Comments**:
- Test stubs: "stub nodes for test fixtures" (OK in tests)
- CSS placeholders: "placeholder background color" (OK in CSS)
- Migration utilities: "Legacy support for patch version X" (required)

**Verification**:
```bash
# Review output, ensure all are justified:
grep -r "TODO.*migration\|STUB\|PLACEHOLDER" src/editor --include="*.ts" --include="*.tsx" | grep -v ".test.ts"
```

---

### P3-B: Type Import Cleanup

**Import Hygiene**:
- [ ] Zero TypeScript errors related to missing type imports (`just typecheck`)
- [ ] All imports use current type names: Edge, BusBlock, PortRef, Endpoint (port-only)
- [ ] Linter runs clean: `just lint-fix` completes with 0 warnings/errors

**Verification**:
```bash
# Must pass with 0 errors:
just typecheck
just lint-fix
# Review for unused imports:
```

---

## Sprint Success Criteria (Overall)

**Code Quality Achieved**:
- [ ] Zero deprecated type definitions exported from types.ts (or clearly marked if kept)
- [ ] Zero stub UI components (all functional or deleted)
- [ ] Zero `kind === 'bus'` checks outside valid contexts (IR busIndex, migration)
- [ ] Zero TODO/STUB comments referencing outdated migration work

**Functional Quality Achieved**:
- [ ] All 2523 tests pass: `just test`
- [ ] TypeScript compiles clean: `just typecheck`
- [ ] Linter clean: `just lint-fix`
- [ ] Manual test: Create BusBlock → Connect → Compile → Run → Success
- [ ] Manual test: UI workflow (create/edit/delete BusBlock) → Success

**Documentation Complete**:
- [ ] Migration strategy documented (keep or remove old patch support)
- [ ] Remaining legacy code clearly commented with rationale
- [ ] Planning docs updated to reflect 100% topic completion

**Definition of "100% Complete"**:
- [ ] All P0 items DONE
- [ ] All P1 items DONE
- [ ] All P2 items DONE
- [ ] All P3 items DONE
- [ ] No known legacy artifacts remain (except justified migration code)
- [ ] Topic `bus-block-unification` marked COMPLETE in planning docs

---

## Exit Criteria Before Closing Topic

**Must Complete**:
1. ✅ All acceptance criteria checkboxes above marked complete
2. ✅ All tests passing
3. ✅ TypeScript + linter clean
4. ✅ Manual UI test passed
5. ✅ Code review by human confirms no legacy patterns remain

**Final Verification Checklist**:
```bash
# Run full check:
just check

# Grep for legacy patterns (should return 0 or only migration code):
grep -r "kind: 'bus'" src/editor --include="*.ts" | grep -v test | grep -v migration
grep -r "interface Bus\|interface Connection" src/editor/types.ts
grep -r "busStore" src/editor --include="*.ts" --include="*.tsx"

# Verify UI components:
ls src/editor/Bus*.tsx  # Each file should be functional or deleted
```

**Sign-Off**:
- [ ] Developer confirms: All legacy code removed or justified
- [ ] Code review confirms: No accidental legacy patterns
- [ ] Manual testing confirms: UI workflows functional
- [ ] Topic marked COMPLETE in `.agent_planning/bus-block-unification/`

---

**Generated**: 2026-01-02-115639
**Plan**: PLAN-2026-01-02-115639.md
**Topic**: bus-block-unification
**Sprint**: Final Cleanup (100% completion)
