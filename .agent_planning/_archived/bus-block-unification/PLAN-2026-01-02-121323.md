# PLAN: Aggressive Bus Architecture Cleanup
**Generated**: 2026-01-02-121323
**Planner**: status-planner
**Source**: STATUS-2026-01-02-edge-unification-eval.md
**Topic**: unify-connections-edge - REVISED Final Cleanup Sprint

---

## Executive Summary

**Current State**: Edge unification is functionally complete (~95%), but retains extensive bus-specific infrastructure in the compiler/IR that contradicts the design principle: **buses are PURELY a UI/UX convenience**.

**Target State**: Zero bus concepts in compiler/IR. BusBlock is treated identically to any other block. All bus-specific code paths, types, and diagnostics removed.

**Scope**: Aggressive cleanup removing ~2000+ lines of bus-specific code while preserving the Modulation Table (which works Blockâ†’Block including BusBlocks).

**Key Insight from User**:
- Buses are NOT a backend concept - they're a UI presentation layer
- LensParamBinding with `kind: 'bus'` should be REMOVED entirely (lenses don't have inputs)
- Migration utilities = tech debt to be eliminated
- Bus diagnostics can be added back later as regular block diagnostics

**Risk Level**: HIGH - This is a breaking cleanup that removes backward compatibility

---

## Gap Analysis

### Current Reality (from STATUS-2026-01-02-edge-unification-eval.md)

**Completed Work** âœ…:
- BusStore.ts DELETED
- Endpoint type simplified (no `kind: 'bus'` variant)
- Edge-based architecture functional
- All 2523 tests passing
- TypeScript compiles clean

**Remaining Bus Infrastructure** ðŸ”´:
1. **Compiler**: 53 files with 'bus' references
2. **IR**: BusIndex type, bus-specific node types
3. **Pass 7**: Entire `pass7-bus-lowering.ts` file (352 lines)
4. **Utilities**: `bus-block-utils.ts` (provides `getBusBlocks()`)
5. **Types**: `LensParamBinding` with `kind: 'bus'` variant
6. **Diagnostics**: Bus-specific diagnostic code
7. **Tests**: `bus-diagnostics.test.ts`, `bus-block-utils.test.ts`, `ir-bus-execution.test.ts`
8. **Migration**: `transforms/migrate.ts` (145 lines of legacy compat)
9. **Store Queries**: `PatchStore.busBlocks` computed property

### Target State (User Requirements)

**Zero Bus Concepts in Backend**:
- âŒ No `BusIndex` type in IR
- âŒ No `pass7-bus-lowering.ts`
- âŒ No `bus-block-utils.ts`
- âŒ No bus-specific diagnostic code
- âŒ No migration utilities
- âŒ No `getBusBlocks()` queries
- âŒ No `LensParamBinding` with `kind: 'bus'`

**What Remains**:
- âœ… `Bus` interface in types.ts (data transfer object for UI)
- âœ… `BusBlock` block definition (just a block type)
- âœ… `PatchStore.addBus()` (UI convenience method)
- âœ… Modulation Table (works Blockâ†’Block)
- âœ… UI components (BusCreationDialog, etc.)

**Litmus Test**: Can you grep for "bus" in `src/editor/compiler/` and `src/editor/ir/` and get ZERO results (excluding comments)?

---

## Prioritized Backlog

### P0: Remove All Bus Concepts from IR (CRITICAL)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: None
**Spec Reference**: User requirements - "No mention of 'buses' in compiler or IR"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Type System Current State"

#### Description
The IR layer should have ZERO knowledge of buses. BusIndex, bus-specific node types, and bus metadata must all be removed.

#### Acceptance Criteria (REQUIRED)
- [ ] `BusIndex` type removed from `src/editor/compiler/ir/types.ts`
- [ ] All `BusIndex` references removed from IR builder, schedule, program
- [ ] Grep for `\bbus\b` in `src/editor/ir/` returns ZERO files (excluding comments)
- [ ] Grep for `BusIndex` in `src/editor/` returns ZERO files
- [ ] All IR tests pass after removal
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Modify**:
- `src/editor/compiler/ir/types.ts:262` - Delete `BusIndex` type
- `src/editor/compiler/ir/IRBuilder.ts` - Remove any bus-specific methods
- `src/editor/compiler/ir/schedule.ts` - Remove bus metadata
- `src/editor/compiler/ir/program.ts` - Remove bus indexing

**Migration Strategy**: None - we're cutting off old format support

**Verification**:
```bash
# Must return 0 results (excluding comments/strings)
grep -r '\bbus\b' src/editor/ir/ --include="*.ts" | grep -v '//' | grep -v '\*'
grep -r 'BusIndex' src/editor/ --include="*.ts"
```

---

### P0: Delete Pass 7 (Bus Lowering) Entirely (CRITICAL)

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0 IR Cleanup (must happen first or in parallel)
**Spec Reference**: User requirements - "Everything that treats buses differently removed"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Sprint Completion Analysis"

#### Description
Pass 7 (`pass7-bus-lowering.ts`) exists solely to handle BusBlocks specially. Since buses are just blocks, this entire pass should be deleted.

#### Acceptance Criteria (REQUIRED)
- [ ] File `src/editor/compiler/passes/pass7-bus-lowering.ts` DELETED
- [ ] File `src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts` DELETED
- [ ] Pass 6 directly feeds into Pass 8 (no Pass 7)
- [ ] Compiler pipeline updated to skip Pass 7
- [ ] All references to `IRWithBusRoots` removed
- [ ] All references to `busRoots` map removed
- [ ] Full test suite passes without Pass 7
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Delete**:
- `src/editor/compiler/passes/pass7-bus-lowering.ts` (352 lines)
- `src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts` (entire file)

**Files to Modify**:
- `src/editor/compiler/passes/index.ts` - Remove Pass 7 from pipeline
- `src/editor/compiler/compile.ts` - Update pass orchestration
- `src/editor/compiler/types.ts` - Remove `IRWithBusRoots` type

**Impact Analysis**:
- BusBlocks are already lowered by Pass 6 (block lowering) like any other block
- Pass 7 was creating special combine nodes - this should now happen in Pass 6
- Pass 8 (link resolution) already handles all edges uniformly

**Fallback**: If Pass 6 doesn't handle BusBlock lowering, add it there FIRST, then delete Pass 7

---

### P0: Delete Bus Block Utilities (CRITICAL)

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0 Pass 7 Deletion
**Spec Reference**: User requirements - "No querying 'bus blocks', buses are just blocks"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Remaining Work"

#### Description
The compiler should not query "all BusBlocks" as a special category. If code needs to work with a block, it should use `getBlockById()` like any other block.

#### Acceptance Criteria (REQUIRED)
- [ ] File `src/editor/compiler/bus-block-utils.ts` DELETED
- [ ] File `src/editor/compiler/__tests__/bus-block-utils.test.ts` DELETED
- [ ] All `getBusBlocks()` calls removed from compiler
- [ ] All `getBusById()` calls replaced with `getBlockById()`
- [ ] `PatchStore.busBlocks` computed REMOVED
- [ ] Grep for `getBusBlocks` returns ZERO results
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Delete**:
- `src/editor/compiler/bus-block-utils.ts` (entire file)
- `src/editor/compiler/__tests__/bus-block-utils.test.ts` (entire file)

**Files to Modify**:
- `src/editor/stores/PatchStore.ts` - Remove `busBlocks: computed`
- Any compiler pass using `getBusBlocks()` - replace with standard block queries

**Replacement Pattern**:
```typescript
// OLD (bus-specific query)
const busBlocks = getBusBlocks(patch);

// NEW (standard block query)
const block = patch.blocks.find(b => b.id === blockId);
if (block?.type === 'BusBlock') { /* ... */ }
```

**Note**: `PatchStore.addBus()` can STAY (it's a UI convenience method that creates a BusBlock)

---

### P0: Remove LensParamBinding 'bus' Variant (CRITICAL)

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: None
**Spec Reference**: User requirements - "LensParamBinding REMOVED entirely - there is no 'input' on a lens"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Type System Current State"

#### Description
Lenses are value transformations, not data sources. The `kind: 'bus'` variant in `LensParamBinding` implies lenses can read from buses, which violates the architecture.

#### Acceptance Criteria (REQUIRED)
- [ ] `LensParamBinding` type no longer has `kind: 'bus'` variant
- [ ] All lens param bindings use `kind: 'default'`, `'wire'`, or `'literal'`
- [ ] All code constructing `{ kind: 'bus' }` bindings removed
- [ ] All code consuming `kind: 'bus'` bindings removed
- [ ] Grep for `kind.*bus.*LensParam` returns ZERO results
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Modify**:
- `src/editor/types.ts:233-237` - Remove `kind: 'bus'` from union type
- `src/editor/lenses/lensInstances.ts` - Remove bus binding construction
- `src/editor/lenses/lensResolution.ts` - Remove bus binding resolution
- Any transform code handling `kind: 'bus'`

**Current Definition** (types.ts:233-237):
```typescript
export type LensParamBinding =
  | { kind: 'default'; defaultSourceId: string }
  | { kind: 'wire'; from: PortRef; adapterChain?: AdapterStep[]; lensStack?: LensInstance[] }
  | { kind: 'bus'; busId: string; adapterChain?: AdapterStep[]; lensStack?: LensInstance[] }  // â† DELETE
  | { kind: 'literal'; value: unknown };
```

**Target Definition**:
```typescript
export type LensParamBinding =
  | { kind: 'default'; defaultSourceId: string }
  | { kind: 'wire'; from: PortRef; adapterChain?: AdapterStep[]; lensStack?: LensInstance[] }
  | { kind: 'literal'; value: unknown };
```

**Question for User**: Should we remove `kind: 'wire'` as well if lenses don't have inputs? Or does 'wire' mean "read from edge output"?

---

### P0: Delete All Bus Diagnostics (CRITICAL)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0 Pass 7 Deletion, P0 Bus Utils Deletion
**Spec Reference**: User requirements - "ALL bus-specific Debug/Diagnostics code DELETED - user will add back later"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Remaining `kind === 'bus'` Checks"

#### Description
All bus-specific diagnostic code should be removed. Later, we can add back diagnostics that work on BusBlocks like any other block.

#### Acceptance Criteria (REQUIRED)
- [ ] File `src/editor/compiler/__tests__/bus-diagnostics.test.ts` DELETED
- [ ] All diagnostic targets with `kind: 'bus'` removed
- [ ] All diagnostic targets with `kind: 'binding'` (bus-related) removed
- [ ] `DiagnosticStore` bus-specific filtering removed
- [ ] Grep for `diagnostic.*bus|bus.*diagnostic` returns ZERO results (case-insensitive)
- [ ] Full test suite passes (diagnostic tests may need updates)
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Delete**:
- `src/editor/compiler/__tests__/bus-diagnostics.test.ts` (entire file)

**Files to Modify**:
- `src/editor/stores/DiagnosticStore.ts:186` - Remove legacy bus target checks
- Any diagnostic emission code referencing buses

**Code to Remove** (DiagnosticStore.ts:183-191):
```typescript
// Legacy bus target
if (target.kind === 'bus') return target.busId === busId;
if (target.kind === 'binding') return target.busId === busId;
```

**Replacement**: Standard block diagnostic targeting works fine for BusBlocks

---

### P0: Delete All Migration Utilities (CRITICAL)

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None (can run in parallel)
**Spec Reference**: User requirements - "All migration utilities must be REMOVED - no keeping old format support"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Migration Safety"

#### Description
We're cutting off support for old patch formats. All migration code is now tech debt.

#### Acceptance Criteria (REQUIRED)
- [ ] File `src/editor/transforms/migrate.ts` DELETED (145 lines)
- [ ] File `src/editor/transforms/__tests__/migrate.test.ts` DELETED
- [ ] All `convertLegacyTransforms()` calls removed
- [ ] All `getEdgeTransforms()` fallback logic removed
- [ ] Edges MUST have `transforms` field (no legacy format support)
- [ ] Grep for `migration|migrate|legacy` returns ZERO results in /editor (excluding docs)
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Delete**:
- `src/editor/transforms/migrate.ts` (entire file)
- `src/editor/transforms/__tests__/migrate.test.ts` (entire file)

**Files to Modify**:
- Any code using `getEdgeTransforms()` - assume `edge.transforms` exists
- Any code using `convertLegacyTransforms()` - remove fallback paths

**Breaking Change**: Old patch files will not load - this is intentional per user requirements

**User Communication**: Add a console error: "Patch format too old - please use previous version to migrate"

---

### P1: Remove Bus References from Compiler (HIGH)

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: All P0 items
**Spec Reference**: User requirements - "No mention of 'buses' in compiler or IR"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Remaining Work"

#### Description
Systematically remove all bus-related code from compiler passes, leaving only standard block handling.

#### Acceptance Criteria (REQUIRED)
- [ ] Grep for `\bbus\b` in `src/editor/compiler/` returns ZERO active code (comments OK)
- [ ] All compiler passes treat BusBlock like any other block
- [ ] No special-casing of `block.type === 'BusBlock'`
- [ ] Pass 6 handles BusBlock lowering via standard block compiler
- [ ] Pass 8 handles BusBlock edges like any other edge
- [ ] File `src/editor/compiler/__tests__/ir-bus-execution.test.ts` DELETED or RENAMED
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Audit** (53 files with 'bus' references):
- `src/editor/compiler/integration.ts`
- `src/editor/compiler/compileBusAware.ts` - RENAME or DELETE
- `src/editor/compiler/types.ts` - Remove bus-specific types
- All pass files - Remove bus-specific logic
- All IR files - Already handled by P0

**Special Case**: `compileBusAware.ts` might be a legacy file to delete entirely

**Test Files to Update**:
- `src/editor/compiler/__tests__/ir-bus-execution.test.ts` - DELETE or convert to generic block test
- Any pass tests with bus-specific cases - generalize or delete

**Verification**:
```bash
# Must return 0 active code results
grep -r '\bbus\b' src/editor/compiler/ --include="*.ts" \
  | grep -v '//' | grep -v '\*' | grep -v 'describe.*bus' | grep -v 'test.*bus'
```

---

### P1: Audit and Remove Bus-Specific Store Queries (HIGH)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0 Bus Utils Deletion
**Spec Reference**: User requirements - "No querying 'bus blocks', buses are just blocks"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Code Reduction Achieved"

#### Description
Stores should not have computed properties or methods that treat buses specially. Remove all such queries.

#### Acceptance Criteria (REQUIRED)
- [ ] `PatchStore.busBlocks` computed property REMOVED
- [ ] All `getBusById()` calls replaced with `getBlockById()`
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Modify**:
- `src/editor/stores/PatchStore.ts:95` - Remove `busBlocks: computed`
- `src/editor/stores/EmphasisStore.ts` - Remove any bus-specific emphasis logic
- `src/editor/stores/DebugStore.ts` - Remove any bus-specific debug queries

**Replacement Pattern**:
```typescript
// OLD
const buses = this.patchStore.busBlocks;

// NEW
const buses = this.patchStore.blocks.filter(b => b.type === 'BusBlock');
```

**Note**: UI code CAN filter by `block.type === 'BusBlock'` - that's fine. We're removing STORE-LEVEL queries.

---

### P1: Implement UI Stubs (Except Bus-Related) (HIGH)

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: All P0 items, P1 Compiler Cleanup
**Spec Reference**: User requirements - "Fully implement any UI stubs - EXCEPT bus-related ones which should be removed"
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "UI Component Status"

#### Description
The STATUS file mentions UI components were stubbed during migration. We need to fully implement these stubs, but remove any bus-specific UI code.

#### Acceptance Criteria (REQUIRED)
- [ ] All `// TODO: stub` comments in UI components resolved
- [ ] `BlockContextMenu.tsx` fully functional
- [ ] `BusChannel.tsx` fully functional OR DELETED if bus-specific
- [ ] `ContextMenu.tsx` fully functional
- [ ] `PatchBay.tsx` fully functional
- [ ] `BlockView.tsx` fully functional
- [ ] `GraphWorkspace.tsx` fully functional
- [ ] Manual UI testing shows all operations work
- [ ] No console errors during typical usage
- [ ] Grep for `stub|TODO.*stub` in UI components returns ZERO results

#### Technical Notes
**Files to Audit** (17 files with stub references):
- `src/editor/BlockContextMenu.tsx`
- `src/editor/BusChannel.tsx` - Might be bus-specific, could DELETE
- `src/editor/ContextMenu.tsx`
- `src/editor/PatchBay.tsx`
- `src/editor/board/BlockView.tsx`
- `src/editor/board/GraphWorkspace.tsx`
- Runtime executor files (low priority)
- Field materializer files (low priority)

**Decision Tree**:
- If stub is bus-specific UI â†’ DELETE
- If stub is general edge/block UI â†’ IMPLEMENT
- If stub is internal debug code â†’ KEEP as TODO (low priority)

**Manual Testing Required**:
1. Create BusBlock via UI
2. Connect edges to/from BusBlock
3. Edit BusBlock parameters
4. Delete BusBlock
5. Compile patch with BusBlock
6. Verify modulation table shows BusBlock connections

---

### P2: Verify Modulation Table Works Block-to-Block (MEDIUM)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P1 Compiler Cleanup
**Spec Reference**: User requirements - "Modulation Table: DO NOT DELETE - it should work Block to Block (including buses)"
**Status Reference**: N/A (user requirement)

#### Description
The Modulation Table is a UI feature that shows signal routing. It must work for all blocks, including BusBlocks.

#### Acceptance Criteria (REQUIRED)
- [ ] Modulation Table displays BusBlock connections
- [ ] Modulation Table treats BusBlocks like any other block
- [ ] No bus-specific code paths in modulation table logic
- [ ] Manual testing shows BusBlock edges appear correctly
- [ ] Grep for `bus` in `src/editor/modulation-table/` returns only generic block handling
- [ ] TypeScript compiles with 0 errors

#### Technical Notes
**Files to Audit**:
- `src/editor/modulation-table/ModulationTableStore.ts`
- `src/editor/modulation-table/ModulationTable.tsx`
- `src/editor/modulation-table/ModulationTableGrid.tsx`

**Expected Behavior**: Modulation table should show:
- Source block (any type)
- Edge with transforms
- Target block (any type)

If BusBlock appears as source or target, it should be displayed like any other block.

**No Special Cases**: Remove any `if (block.type === 'BusBlock')` special handling unless it's purely cosmetic (e.g., icon).

---

### P2: Update Test Suite for New Architecture (MEDIUM)

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: All P0 items, P1 Compiler Cleanup
**Spec Reference**: General best practices
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Test Status"

#### Description
After removing all bus-specific code, update tests to reflect the new architecture where buses are just blocks.

#### Acceptance Criteria (REQUIRED)
- [ ] All deleted test files removed from test suite config
- [ ] All remaining tests pass (2500+ tests)
- [ ] No skipped tests related to bus functionality
- [ ] Test coverage maintained or improved
- [ ] TypeScript compiles with 0 errors
- [ ] No console warnings during test run

#### Technical Notes
**Test Files Already Deleted by P0**:
- `pass7-bus-lowering.test.ts`
- `bus-diagnostics.test.ts`
- `bus-block-utils.test.ts`
- `migrate.test.ts`

**Test Files to Update**:
- `src/editor/compiler/__tests__/ir-bus-execution.test.ts` - Rename to generic block test OR delete
- Any integration tests with bus-specific cases - generalize

**New Test Coverage Needed**:
- BusBlock creation via UI
- BusBlock edge handling in compiler
- BusBlock combine mode configuration
- BusBlock default value handling

**Verification**:
```bash
just test
# Should show ~2500 passing tests, 0 related to "bus" as a special category
```

---

### P3: Documentation Cleanup (LOW)

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: All P0-P2 items
**Spec Reference**: General best practices
**Status Reference**: STATUS-2026-01-02-edge-unification-eval.md Â§ "Recommendations"

#### Description
Update all planning documents and code comments to reflect the new architecture.

#### Acceptance Criteria (REQUIRED)
- [ ] ROADMAP.md marks `unify-connections-edge` as COMPLETE
- [ ] STATUS files in topic directory marked as SUPERSEDED
- [ ] Code comments referring to "bus lowering" updated or removed
- [ ] No TODO comments about bus migration
- [ ] All deleted files removed from documentation references

#### Technical Notes
**Files to Update**:
- `.agent_planning/bus-block-unification/ROADMAP.md` - Mark topic complete
- `.agent_planning/bus-block-unification/STATUS-*.md` - Add "SUPERSEDED" header
- Any design docs in `design-docs/` referencing bus architecture

**Comments to Update**:
- "TODO: migrate to BusBlock" â†’ DELETE (done)
- "Legacy bus format" â†’ DELETE (no longer supported)
- "Pass 7 handles bus lowering" â†’ DELETE (no Pass 7)

**Grep Audit**:
```bash
# Find outdated comments
grep -r 'TODO.*bus\|legacy.*bus\|migrate.*bus' src/editor/ --include="*.ts"
```

---

## Dependency Graph

```
P0 Items (Parallel - no dependencies):
â”œâ”€â”€ Remove BusIndex from IR
â”œâ”€â”€ Delete Pass 7
â”œâ”€â”€ Delete Bus Utils
â”œâ”€â”€ Remove LensParamBinding 'bus' variant
â”œâ”€â”€ Delete Bus Diagnostics
â””â”€â”€ Delete Migration Utilities

â†“ (All P0 must complete)

P1 Items:
â”œâ”€â”€ Remove Bus References from Compiler (depends on P0)
â”œâ”€â”€ Remove Bus Store Queries (depends on P0 Bus Utils)
â””â”€â”€ Implement UI Stubs (depends on P0, P1 Compiler)

â†“ (All P1 must complete)

P2 Items:
â”œâ”€â”€ Verify Modulation Table (depends on P1 Compiler)
â””â”€â”€ Update Test Suite (depends on All P0, P1)

â†“ (All P2 must complete)

P3 Items:
â””â”€â”€ Documentation Cleanup (depends on All P0-P2)
```

---

## Recommended Sprint Planning

### Sprint 1: Backend Purge (1 week)
**Goal**: Remove all bus concepts from compiler/IR

**Work Items**:
- P0: Remove BusIndex from IR (2-3 hours)
- P0: Delete Pass 7 (1-2 hours)
- P0: Delete Bus Utils (1-2 hours)
- P0: Delete Bus Diagnostics (2-3 hours)
- P0: Delete Migration Utilities (1-2 hours)
- P1: Remove Bus References from Compiler (4-6 hours)

**Deliverables**:
- Compiler/IR has ZERO bus-specific code
- All bus-specific test files deleted
- Test suite passes (~2500 tests)
- TypeScript compiles clean

**Success Criteria**:
```bash
grep -r '\bbus\b' src/editor/compiler/ --include="*.ts" | grep -v '//' | wc -l
# Output: 0
```

### Sprint 2: Type System & Store Cleanup (3-4 days)
**Goal**: Remove bus concepts from type system and stores

**Work Items**:
- P0: Remove LensParamBinding 'bus' variant (3-4 hours)
- P1: Remove Bus Store Queries (2-3 hours)
- P2: Update Test Suite (4-6 hours)

**Deliverables**:
- `LensParamBinding` has no bus variant
- Stores have no bus-specific computed properties
- All tests updated and passing

**Success Criteria**:
- Grep for `kind.*bus.*Lens` returns 0 results

### Sprint 3: UI Implementation (1-2 weeks)
**Goal**: Fully implement UI stubs and verify modulation table

**Work Items**:
- P1: Implement UI Stubs (1-2 weeks, can be split across multiple devs)
- P2: Verify Modulation Table (2-3 hours)

**Deliverables**:
- All UI stubs implemented
- Modulation table works for BusBlocks
- Manual testing complete

**Success Criteria**:
- No stub comments in UI code
- Can create/connect/edit/delete BusBlocks via UI
- Modulation table shows BusBlock connections

### Sprint 4: Polish (1-2 days)
**Goal**: Documentation and final cleanup

**Work Items**:
- P3: Documentation Cleanup (1-2 hours)
- Final integration testing
- Performance verification

**Deliverables**:
- All docs updated
- ROADMAP marked complete
- Topic closed

---

## Risk Assessment

### HIGH RISKS ðŸ”´

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Deleting Pass 7 breaks compilation | MEDIUM | HIGH | Verify Pass 6 handles BusBlock lowering first |
| Removing migration breaks existing patches | HIGH | MEDIUM | User accepts this - document clearly |
| UI stubs hide critical functionality | HIGH | HIGH | Prioritize manual testing early |
| Test suite masks broken behavior | MEDIUM | HIGH | Use Chrome DevTools to verify runtime behavior |

### MEDIUM RISKS ðŸŸ¡

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| LensParamBinding 'wire' also needs removal | LOW | MEDIUM | Ask user for clarification |
| Modulation Table has hidden bus logic | LOW | MEDIUM | Thorough code audit before changes |
| TypeScript errors cascade across files | MEDIUM | MEDIUM | Fix one P0 item at a time, verify TS after each |

### LOW RISKS ðŸŸ¢

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Documentation gets out of sync | MEDIUM | LOW | P3 item ensures alignment |
| Comments reference deleted code | HIGH | LOW | Simple grep and update |

---

## Breaking Changes

**User Communication Required**:

1. **Patch Format Breaking Change**:
   - Old patches with legacy bus format will NOT load
   - Error message: "Patch format too old - please migrate using v1.x"

2. **No Backward Compatibility**:
   - Migration utilities deleted
   - No fallback paths for old data structures

3. **API Changes**:
   - `PatchStore.busBlocks` removed (use `blocks.filter(b => b.type === 'BusBlock')`)
   - Pass 7 removed from compiler pipeline

---

## Success Metrics

### Code Quality âœ…
- [ ] TypeScript compiles with 0 errors
- [ ] Test suite passes (2500+ tests)
- [ ] Zero bus-specific code in compiler/IR (verified via grep)
- [ ] Zero migration utilities (verified via file deletion)

### Architecture âœ…
- [ ] BusBlock treated identically to other blocks
- [ ] No special compiler passes for buses
- [ ] No bus-specific store queries
- [ ] No bus-specific diagnostic code

### Functionality âœ…
- [ ] Can create BusBlock via UI
- [ ] Can connect edges to/from BusBlock
- [ ] BusBlock compiles correctly
- [ ] Modulation table shows BusBlock connections
- [ ] No console errors during typical usage

### Code Reduction ðŸ“‰
**Predicted Deletion**:
- Pass 7: ~350 lines
- bus-block-utils.ts: ~200 lines
- Migration utilities: ~145 lines
- Bus diagnostics: ~100 lines
- IR bus types: ~50 lines
- Store bus queries: ~80 lines
- Test files: ~500 lines
- **Total**: ~1425 lines deleted

**Additional Simplification**:
- Removal of bus-specific branches in 53 compiler files
- Estimated additional reduction: ~500-800 lines

**Grand Total**: ~2000+ lines removed

---

## Files to Delete (Complete List)

**Compiler**:
- [ ] `src/editor/compiler/passes/pass7-bus-lowering.ts`
- [ ] `src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts`
- [ ] `src/editor/compiler/bus-block-utils.ts`
- [ ] `src/editor/compiler/__tests__/bus-block-utils.test.ts`
- [ ] `src/editor/compiler/__tests__/bus-diagnostics.test.ts`
- [ ] `src/editor/compiler/__tests__/ir-bus-execution.test.ts` (or rename)
- [ ] `src/editor/compiler/compileBusAware.ts` (if obsolete)

**Transforms**:
- [ ] `src/editor/transforms/migrate.ts`
- [ ] `src/editor/transforms/__tests__/migrate.test.ts`

**UI** (if bus-specific):
- [ ] `src/editor/BusChannel.tsx` (evaluate - might be general edge UI)

**Total**: ~9-10 files to delete

---

## Files to Modify (Partial List)

**IR**:
- `src/editor/compiler/ir/types.ts` - Remove BusIndex
- `src/editor/compiler/ir/IRBuilder.ts` - Remove bus methods
- `src/editor/compiler/ir/schedule.ts` - Remove bus metadata
- `src/editor/compiler/ir/program.ts` - Remove bus indexing

**Compiler**:
- `src/editor/compiler/passes/index.ts` - Remove Pass 7
- `src/editor/compiler/compile.ts` - Update pipeline
- `src/editor/compiler/types.ts` - Remove IRWithBusRoots
- `src/editor/compiler/integration.ts` - Remove bus logic

**Stores**:
- `src/editor/stores/PatchStore.ts` - Remove bus computeds
- `src/editor/stores/DiagnosticStore.ts` - Remove bus diagnostics

**Types**:
- `src/editor/types.ts` - Remove LensParamBinding 'bus' variant

**UI** (stub implementation):
- `src/editor/BlockContextMenu.tsx`
- `src/editor/BusChannel.tsx`
- `src/editor/ContextMenu.tsx`
- `src/editor/PatchBay.tsx`
- `src/editor/board/BlockView.tsx`
- `src/editor/board/GraphWorkspace.tsx`

---

## Verification Commands

**After Each P0 Item**:
```bash
# Verify TypeScript compiles
just typecheck

# Verify tests pass
just test

# Verify specific removals
grep -r 'BusIndex' src/editor/ --include="*.ts"
grep -r '\bbus\b' src/editor/compiler/ --include="*.ts" | grep -v '//'
```

**After Sprint 1 Complete**:
```bash
# Zero bus concepts in compiler/IR
grep -r '\bbus\b' src/editor/compiler/ --include="*.ts" | grep -v '//' | wc -l
# Expected: 0

grep -r '\bbus\b' src/editor/ir/ --include="*.ts" | grep -v '//' | wc -l
# Expected: 0
```

**After Sprint 2 Complete**:
```bash
# Zero bus-specific type variants
grep -r "kind.*['\"]bus['\"]" src/editor/ --include="*.ts"
# Expected: 0 (excluding Bus interface definition)

# Zero bus-specific store queries
# Expected: 0
```

**After All Work Complete**:
```bash
# Full check
just check
# Expected: 0 errors, 2500+ tests passing
```

---

## Open Questions for User

1. **LensParamBinding 'wire' variant**: Should we also remove `kind: 'wire'`? The user said "there is no 'input' on a lens", which suggests lenses shouldn't read from wires either. Please clarify.

2. **BusChannel.tsx UI file**: Is this bus-specific UI (delete) or general edge visualization (keep and implement)? Needs investigation.

3. **Pass 6 capability**: Does Pass 6 already handle BusBlock lowering, or do we need to add that BEFORE deleting Pass 7?

4. **Error handling**: What error message should we show when old patch format is detected?

5. **Migration timeline**: Is there a grace period where we keep migration code, or delete immediately?

---

## Estimated Timeline

**Aggressive Schedule** (1 developer, full-time):
- Sprint 1 (Backend Purge): 3-4 days
- Sprint 2 (Type/Store Cleanup): 2-3 days
- Sprint 3 (UI Implementation): 5-10 days
- Sprint 4 (Polish): 1 day

**Total**: 2-3 weeks

**Conservative Schedule** (accounting for unknowns):
- Sprint 1: 1 week
- Sprint 2: 1 week
- Sprint 3: 2 weeks
- Sprint 4: 2-3 days

**Total**: 4-5 weeks

**Parallel Development** (2+ developers):
- Can parallelize P0 items (1 week)
- Can parallelize UI stub implementation (1 week instead of 2)

**Total with 2 devs**: 2-3 weeks

---

## Next Steps

1. **User Review**: Get confirmation on open questions
2. **Create Sprint 1 Branch**: `feature/bus-architecture-cleanup-sprint1`
3. **Start with P0 IR Cleanup**: Safest item to start with
4. **Verify After Each Change**: Don't batch changes
5. **Document Breaking Changes**: Prepare user communication

---

**Generated**: 2026-01-02-121323
**Planner**: status-planner
**Files**: See "Files to Delete" and "Files to Modify" sections
**Total Items**: 11 (6 P0, 3 P1, 2 P2, 1 P3)
**Estimated Effort**: 2-5 weeks depending on parallelization
