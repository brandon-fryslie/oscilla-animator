# Final Cleanup Sprint: Bus-Block Unification
**Generated**: 2026-01-02-115639
**Source STATUS**: STATUS-2026-01-02-p1-type-cleanup.md
**Topic**: bus-block-unification

---

## Executive Summary

**Mission**: Achieve 100% cleanup of legacy Bus-Block unification artifacts, leaving ZERO legacy code.

**Current State** (from STATUS-2026-01-02-p1-type-cleanup.md):
- ✅ BusStore.ts **DELETED**
- ✅ Endpoint type **SIMPLIFIED** (no `kind: 'bus'` variant in types.ts)
- ✅ All 2523 tests **PASSING**
- ✅ TypeScript compiles **CLEAN**
- ⚠️ **95% complete** - remaining 5% is legacy compatibility code

**Target State**:
- Zero references to Connection type (replaced by Edge)
- Zero `kind: 'bus'` checks (ESPECIALLY in IR/compiler internals.  no mention of 'bus' in IR or compiler)
- Zero Bus interface usage (all conversion utilities removed)
- All stub/placeholder UI components fully implemented
- Clean type system with no deprecated types

**Estimated Total Effort**: 12-16 hours across 5 major work items

**Risk Level**: LOW - All tests pass, changes are deletions and simplifications

---

## Backlog by Priority

### P0 (Critical): Type System Cleanup

These changes affect the core type system and must be done first to enable downstream cleanup.

---

## P0-A: Remove Legacy Type Definitions from types.ts

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: None
**Spec Reference**: Edge-based architecture (design-docs/historical/spec/) • **Status Reference**: STATUS-2026-01-02-p1-type-cleanup.md § "Legacy Types Still Present"

### Description
The core types.ts file still contains deprecated type definitions that enable legacy code patterns. These must be removed to prevent accidental usage and clarify the type system.

**Current Evidence** (STATUS file § "Legacy Types Still Present"):
- `Bus` interface (types.ts:168-201) - marked as "data transfer type" but still exported
- `Connection` interface (types.ts:714-740) - marked `@deprecated`, still exported
- `LensParamBinding` has `kind: 'bus'` variant (types.ts:236)
- `DefaultSourceState` interface (types.ts:747-753) - marked as deprecated migration type

**Investigation Required**:
1. Grep all imports of `Bus` interface → identify which files actually need it
2. Grep all imports of `Connection` interface → verify all converted to Edge
3. Check if `LensParamBinding` `kind: 'bus'` variant is still used
4. Determine if any serialization code depends on these types

### Acceptance Criteria
- [ ] `Connection` interface REMOVED from types.ts (or moved to migration.ts if needed for deserialization)
- [ ] `Bus` interface either REMOVED or moved to bus-block/conversion.ts with clear "migration only" comment
- [ ] `LensParamBinding` `kind: 'bus'` variant REMOVED 
- [ ] `DefaultSourceState` interface either REMOVED or clearly documented as temporary
- [ ] All imports of removed types updated to use Edge/BusBlock equivalents
- [ ] TypeScript compiles with 0 errors
- [ ] All 2523 tests still pass

### Technical Notes
**Replacement Strategy**:
- `Bus` → Use `BusBlock` (block.type === 'BusBlock') + `convertBlockToBus()` helper only in UI
- `Connection` → Use `Edge` everywhere
- `LensParamBinding` `kind: 'bus'` → May need to map to port-based binding during migration

**Safe Removal Check**:
```bash
# Before removing, verify usage:
grep -r "import.*\bBus\b" src/editor --include="*.ts" --include="*.tsx"
grep -r "import.*\bConnection\b" src/editor --include="*.ts" --include="*.tsx"
```

---

## P0-B: Clean Up Diagnostic System Legacy Types

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0-A (types.ts cleanup)
**Spec Reference**: Diagnostic system (src/editor/diagnostics/) • **Status Reference**: STATUS-2026-01-02-p1-type-cleanup.md § "Store Legacy Check Removal"

### Description
The diagnostic system (diagnostics/types.ts) defines `BusTargetRef` and `BindingTargetRef` that reference legacy bus concepts. After Bus→BusBlock migration, diagnostics should target BusBlocks via `BlockTargetRef`, not legacy Bus entities.

**Current Evidence** (grep findings):
- `diagnostics/types.ts:40` - `BusTargetRef { kind: 'bus'; busId: string }`
- `diagnostics/types.ts:47` - `BindingTargetRef { kind: 'binding'; bindingId: string; direction: 'publish'|'subscribe' }`
- Used in `TargetRef` union type (types.ts:86-93)

**Investigation Required**:
1. Find all code that creates `BusTargetRef` instances
2. Find all code that creates `BindingTargetRef` instances
3. Determine if diagnostic actions can use `BlockTargetRef` instead (with `blockId` = bus ID)
4. Check if any UI components depend on these target types

### Acceptance Criteria
- [ ] `BusTargetRef` interface REMOVED (or mapped to `BlockTargetRef { kind: 'block'; blockId: string }`)
- [ ] `BindingTargetRef` interface REMOVED (or replaced with `PortTargetRef` for edges)
- [ ] All diagnostic creation code updated to use block/port references
- [ ] `TargetRef` union type simplified to remove bus/binding variants
- [ ] Diagnostic action executor handles BusBlock diagnostics correctly
- [ ] All diagnostic tests pass
- [ ] Manual test: Diagnostic error on BusBlock shows correct target in UI

### Technical Notes
**Migration Path**:
- `BusTargetRef { kind: 'bus'; busId: 'bus-1' }` → `BlockTargetRef { kind: 'block'; blockId: 'bus-1' }`
- `BindingTargetRef { kind: 'binding'; bindingId: 'bind-1'; direction: 'publish' }` → `PortTargetRef { kind: 'port'; blockId: '...'; slotId: 'in' }`

**Evidence File**: diagnostics/__tests__/ActionExecutor.test.ts:72 has test case with legacy target

---

### P1 (High): Remove Legacy UI Component Stubs

These components were stubbed out during migration (commit 8362cb4) and need to be either fully removed or properly implemented.

---

## P1-A: Remove or Restore Bus UI Components

**Status**: Not Started
**Effort**: Large (4-6 hours)
**Dependencies**: P0-A, P0-B (type cleanup)
**Spec Reference**: UI layer refactoring • **Status Reference**: STATUS-2026-01-02-edge-unification-eval.md § "Sprint 3 Completion"

### Description
Commit 8362cb4 ("chore: stub UI components for Edge-based architecture migration") aggressively stubbed out multiple UI components. These stubs must be either:
1. **Deleted** if the component is obsolete (e.g., BusStore-dependent components)
2. **Restored** and migrated to use BusBlock + Edge APIs
3. **Kept** if still functional but simplified

**Affected Components** (from commit 8362cb4):
- `BusBoard.tsx` - Shows mixer console for all buses
- `BusChannel.tsx` - Individual bus channel strip
- `BusCreationDialog.tsx` - Dialog to create new buses
- `BusInspector.tsx` - Shows details for selected BusBlock
- `BusPicker.tsx` - Dropdown to select a bus
- `BusViz.tsx` - Visualization of bus values (Phase 3: static placeholders)
- `ConnectionInspector.tsx` - Shows edge details (may reference old Connection type)

**Current Status** (from investigation):
- `BusBoard.tsx` - Uses `convertBlockToBus()` helper, appears functional
- `BusInspector.tsx` - Minimal stub, needs restoration
- `BusCreationDialog.tsx` - References `buses[` array (legacy pattern)
- Other components not yet inspected

### Acceptance Criteria
- [ ] Each component assessed: DELETE, RESTORE, or KEEP decision documented
- [ ] Deleted components: Files removed, imports cleaned up
- [ ] Restored components: Fully functional with BusBlock/Edge APIs, no legacy type usage
- [ ] Kept components: Code review confirms no legacy dependencies
- [ ] All references to deleted components removed from imports
- [ ] UI still allows creating/editing/viewing BusBlocks
- [ ] Manual test: Bus workflow (create → connect → edit → delete) works end-to-end

### Technical Notes
**Decision Criteria**:
- **DELETE** if: Component duplicates functionality now in BlockView/Inspector
- **RESTORE** if: Component provides unique UI value (e.g., BusBoard mixer view)
- **KEEP** if: Component already migrated and functional

**Restoration Strategy** (for components to restore):
1. Replace `busStore.getBuses()` with `patchStore.blocks.filter(b => b.type === 'BusBlock')`
2. Replace `Bus` type with `Block` + `convertBlockToBus()` only in UI rendering
3. Replace `Connection` references with `Edge`

---

## P1-B: Clean Up Debug UI Stubs

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P0-A (type cleanup)
**Spec Reference**: Debug UI components • **Status Reference**: Commit 8362cb4 changes

### Description
Debug/introspection UI components were also stubbed during migration. These are developer tools, not user-facing, so simpler to restore or delete.

**Affected Components** (from commit 8362cb4):
- `debug-ui/IRTab.tsx` - Shows IR representation (may reference old IR structure)
- `debug-ui/BusesTab.tsx` - Shows all buses (likely needs BusBlock migration)
- `debug-ui/ProbeCard.tsx` - Shows runtime probe values
- `debug-ui/OverviewTab.tsx` - Shows patch overview

**Investigation Required**:
1. Check if any debug UI uses BusStore or legacy types
2. Determine if debug tabs are still valuable or can be deleted

### Acceptance Criteria
- [ ] Each debug component assessed for deletion or restoration
- [ ] Deleted components removed from codebase
- [ ] Restored components use current IR/runtime APIs
- [ ] Debug UI shows BusBlocks correctly (not legacy Bus entities)
- [ ] Manual test: Open debug panel, verify tabs load without errors

### Technical Notes
**Low Priority**: Debug UI is internal tooling, can be temporarily broken if needed.

**Option**: Mark debug tabs as "TODO: Restore after Edge migration" with clear placeholders instead of broken stubs.

---

### P2 (Medium): Migration Code Assessment

Migration utilities are expected to reference legacy types - that's their job. But we should assess whether they're still needed.

---

## P2-A: Audit Migration Utilities for Removal or Retention

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P0-A (type cleanup)
**Spec Reference**: Migration strategy • **Status Reference**: STATUS-2026-01-02-p1-type-cleanup.md § "Migration/Conversion Utilities"

### Description
Migration utilities are EXPECTED to use legacy types to convert old patch formats. However, we should assess:
1. Are these utilities still actively used?
2. Can we remove support for very old patch formats?
3. Should these be clearly marked as "legacy support only"?

**Current Migration Files** (from STATUS file):
- `bus-block/conversion.ts` - Converts Bus ↔ BusBlock
- `edgeMigration.ts` (if exists) - Converts old edges to port-based
- `transactions/applyOps.ts` - May have migration logic for old ops

**Investigation Required**:
1. Check if `edgeMigration.ts` still exists or was deleted
2. Review `bus-block/conversion.ts` - is `convertBlockToBus()` still used in UI?
3. Check patch serialization - do we still load old formats?
4. Review `applyOps.ts` for legacy operation handling

### Acceptance Criteria
- [ ] All migration utility files identified and documented
- [ ] Decision made for each: KEEP (with clear comments) or DELETE
- [ ] Kept files have JSDoc header: "Legacy format migration - do not use for new code"
- [ ] Deleted files: All imports removed, tests updated
- [ ] If keeping migration: Add test that loads old patch format and verifies conversion
- [ ] If deleting migration: Document minimum supported patch version

### Technical Notes
**Keep Migration If**:
- User patches exist in old format
- Deserialization code needs to handle old versions
- Cost of breaking old patches > cost of maintaining migration code

**Delete Migration If**:
- No users have old patches (new project)
- All patches can be bulk-migrated once
- Maintenance burden is high

---

## P2-B: Clean Up Compiler IR Legacy Types

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P0-A (type cleanup)
**Spec Reference**: Compiler IR schema • **Status Reference**: Grep findings for IR types

### Description
The compiler IR (Intermediate Representation) still has some legacy type references. These need review to determine if they're:
1. **Valid** - IR legitimately uses `busIndex` for runtime bus references

**Found IR Legacy References** (from grep):
- `ir/schema/CompiledProgramIR.ts:239` - `{ kind: 'bus'; busIndex: BusIndex }`
- `compiler/ir/schedule.ts:809` - `{ kind: "bus"; busIndex: BusIndex }`

**Investigation Required**:
1. Check if `busIndex` references are valid (runtime buses are OK)
2. Determine if `FieldExpr` `kind: 'bus'` is legacy or valid
4. Check if IR tests still reference old types

### Acceptance Criteria
- [ ] All IR `kind: 'bus'` references reviewed and justified or removed
- [ ] `FieldExpr` bus variant either REMOVED or documented as valid
- [ ] Compiler tests updated to use current IR structure
- [ ] IR serialization/deserialization handles only current schema
- [ ] Manual test: Compile patch with BusBlock, inspect IR, verify structure matches schema

### Technical Notes
**Valid IR Bus References**:
- Runtime IR can have `busIndex` to reference runtime bus storage
- This is NOT the same as old "Bus as connection hub" model

**Legacy IR References**:
- Edge IR with `kind: 'bus'` endpoints (should be port-only)

---

### P3 (Low): Documentation and Code Hygiene

Final cleanup tasks to ensure codebase is maintainable.

---

## P3-A: Update Comments and TODOs

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: All P0-P2 work complete
**Spec Reference**: Code quality standards • **Status Reference**: Grep findings for TODO/STUB comments

### Description
Throughout the codebase, there are comments referencing the migration, legacy types, or future work. These should be updated to reflect current state.

**Found Comment Patterns** (from grep):
- "TODO: Proper TypeDesc -> SlotType mapping" (bus-block/conversion.ts:21)
- "Migration type - will be removed once..." comments
- "Stub implementation" comments
- References to "Sprint 3" or specific migration phases

**Tasks**:
2. Grep for `STUB|PLACEHOLDER` comments in non-test code
3. Update or remove outdated comments
4. Add comments explaining why remaining legacy code exists (if any)

### Acceptance Criteria
- [ ] All `TODO.*migration` comments reviewed and updated/removed
- [ ] All `STUB` comments in production code removed (tests OK to keep)
- [ ] Remaining legacy code has clear comments: "Legacy support for patch version X"
- [ ] No references to "Sprint 3" or outdated sprint names in code
- [ ] Updated comments reference current architecture (Edge-based)

### Technical Notes
**Safe to Keep**:
- Test stubs (stub nodes, stub buses for test fixtures)
- "Placeholder" in CSS class names
- Migration utility comments explaining old format

**Must Update/Remove**:
- TODOs that are now done
- "Will be removed in Sprint X" comments (already in that sprint)
- Incorrect architecture descriptions

---

## P3-B: Type Import Cleanup

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0-A (type removal)
**Spec Reference**: Import hygiene • **Status Reference**: Type system cleanup

### Description
After removing legacy types, ensure no files import them. Also clean up redundant imports.

**Tasks**:
1. After P0-A: Run `just typecheck` to catch imports of removed types
2. Fix any import errors by using Edge/BusBlock equivalents
3. Remove unused imports (e.g., `import type { Connection }` if not used)
4. Consolidate duplicate imports

### Acceptance Criteria
- [ ] Zero TypeScript errors related to missing type imports
- [ ] No unused imports of legacy types (checked with linter)
- [ ] Imports use current type names (Edge, BusBlock, PortRef)
- [ ] `just lint-fix` runs clean
- [ ] `just typecheck` runs clean

### Technical Notes
**Quick Check**:
```bash
# After removing types, this should find all files needing updates:
just typecheck 2>&1 | grep "Cannot find name"
```

---

## Dependency Graph

```
P0-A (Remove legacy types) ─┬─> P0-B (Clean diagnostic types)
                             ├─> P1-A (Remove UI stubs)
                             ├─> P1-B (Clean debug UI)
                             ├─> P2-A (Audit migration utils)
                             ├─> P2-B (Clean IR types)
                             └─> P3-A (Update comments)
                                   │
                                   └─> P3-B (Clean imports)

All P0-P2 work ──────────────────> P3-A
P3-A ───────────────────────────> P3-B
```

**Critical Path**: P0-A → P1-A → P3-B (longest dependency chain)

**Parallel Work**: P0-B, P1-B, P2-A, P2-B can happen in parallel after P0-A

---

## Recommended Sprint Planning

### Sprint 3.1: Type System Foundation (Days 1-2)
**Scope**: P0-A, P0-B
**Goal**: Clean type system, no deprecated types exported
**Exit Criteria**: TypeScript compiles, all imports updated

### Sprint 3.2: UI Migration (Days 3-4)
**Scope**: P1-A, P1-B
**Goal**: All UI components functional or deleted
**Exit Criteria**: Manual UI test passes, no stub components

### Sprint 3.3: Backend Cleanup (Day 5)
**Scope**: P2-A, P2-B
**Goal**: Migration code assessed, IR cleaned
**Exit Criteria**: Clear migration strategy, IR matches current schema

### Sprint 3.4: Final Polish (Day 6)
**Scope**: P3-A, P3-B
**Goal**: Code hygiene, documentation
**Exit Criteria**: No TODOs, no unused imports, clean linter output

**Total Timeline**: 6 days (with built-in slack for unknowns)

---

## Risk Assessment

### Risk 1: UI Component Restoration Complexity (MEDIUM)

**Issue**: Restoring stubbed UI components may reveal deep dependencies on old APIs

**Likelihood**: Medium
**Impact**: High (could block user workflows)

**Mitigation**:
- Start with BusBoard.tsx (highest user value)
- Test each component in isolation
- Have rollback plan (keep stubs temporarily)

**Contingency**: If restoration is too complex, document components as "Phase 4: UI Restoration" and defer

### Risk 2: Old Patches Break (LOW)

**Issue**: Removing migration utilities could break loading of old patches

**Likelihood**: Low (recent STATUS shows all tests pass)
**Impact**: Medium (user data loss)

**Mitigation**:
- Test with old patch files before removing migration
- Document minimum supported patch version
- Provide one-time migration script if needed

**Contingency**: Keep migration utilities indefinitely with clear "legacy support" comments

### Risk 3: IR Schema Mismatch (LOW)

**Issue**: IR cleanup might break compiler-runtime contract

**Likelihood**: Low (all compiler tests pass)
**Impact**: High (runtime errors)

**Mitigation**:
- Review IR schema thoroughly before changes
- Run all compiler + runtime integration tests
- Manual test: compile and run patch after IR cleanup

**Contingency**: Revert IR changes, document as "requires deeper investigation"

---

## Success Metrics

### Code Quality Metrics

**Before Cleanup** (current state):
- Legacy type definitions: 4 (Bus, Connection, LensParamBinding.bus, DefaultSourceState)
- Stubbed UI components: 7+
- `kind === 'bus'` checks: ~12 files (many in IR/tests)
- Migration utilities: 2-3 files
- TODO/STUB comments: 50+ (from grep)

**After Cleanup** (target state):
- Legacy type definitions: 0 (or moved to migration.ts with clear marking)
- Stubbed UI components: 0 (all functional or deleted)
- `kind === 'bus'` checks: Only in valid IR contexts (busIndex)
- Migration utilities: 0-1 (if needed, clearly marked)
- TODO/STUB comments: <5 (only valid stubs in tests)

### Functional Metrics

- [ ] All 2523 tests still pass
- [ ] TypeScript compiles with 0 errors
- [ ] Linter runs clean (`just lint-fix`)
- [ ] Manual test: Create BusBlock → Connect edges → Compile → Run → Success
- [ ] Manual test: Load old patch (if migration kept) → Converts correctly
- [ ] Manual test: UI shows BusBlocks in mixer, inspector, library

### Documentation Metrics

- [ ] No references to "Sprint 3" in code (current work is "Phase N" or "Topic: X")
- [ ] All legacy code has clear "Why this exists" comments
- [ ] Migration utilities have JSDoc explaining format versions
- [ ] Planning docs updated to reflect completion

---

## Edge Cases and Considerations

### Edge Case 1: IR Bus References Are Valid

**Scenario**: Some `kind: 'bus'` checks in IR are NOT legacy - they're valid runtime references

**Handling**:
- Document these as "Runtime bus storage (not legacy Bus entities)"
- Add comment explaining difference: "busIndex in IR != old Bus type"
- Keep these checks, but rename to `kind: 'busStorage'` for clarity?

### Edge Case 2: UI Components Still Needed

**Scenario**: Users actively use BusBoard/BusInspector, deletion would harm UX

**Handling**:
- Prioritize restoration over deletion
- Allocate more time to P1-A if needed
- Consider partial restoration (minimal viable component)

### Edge Case 3: Migration Code Still Needed Long-Term

**Scenario**: Users have large library of old patches that need migration

**Handling**:
- Keep migration utilities indefinitely
- Move to `src/editor/legacy/` directory with clear README
- Add tests that verify migration still works
- Document in CLAUDE.md: "Patch format migration supported from version X"

### Edge Case 4: Semantic Meaning of "Bus" Changed

**Scenario**: After cleanup, "bus" means "BusBlock" (runtime signal bus), not old "connection hub"

**Handling**:
- Update all variable names: `busId` → `busBlockId` for clarity
- Add glossary to CLAUDE.md:
  - "Bus (legacy)" - Old connection hub system (removed)
  - "BusBlock" - Current signal bus block type
  - "busIndex" - Runtime storage reference (IR only)

---

## Output Format Notes

All work items follow format:
- **Priority Level**: P0-P3
- **Item ID**: P0-A, P1-B, etc.
- **Status**: Not Started (this is initial planning)
- **Effort**: Small/Medium/Large with hour estimates
- **Dependencies**: Prerequisites before starting
- **Spec Reference**: Which docs define the target state
- **Status Reference**: Which STATUS file sections provide current state evidence
- **Description**: What and why
- **Acceptance Criteria**: Testable, specific conditions for "done"
- **Technical Notes**: Implementation hints

---

## Final Notes

**When This Sprint Is Complete**:
- Topic `bus-block-unification` is 100% DONE
- Zero legacy code remains (except justified migration utilities)
- Edge-based architecture is fully realized
- Code is maintainable and clear

**Defer to Future Work**:
- Performance optimization of Edge processing
- Advanced UI features (bus waveform viz, live modulation view)
- Field-typed buses (still in "signal-only" phase)

**Estimated Completion**: 6 working days (12-16 hours of focused work)

---

**Planner**: status-planner
**Timestamp**: 2026-01-02-115639
**Topic**: bus-block-unification
**Sprint**: Final Cleanup (100% completion goal)
