# Definition of Done: Bus-Block Unification Sprint 3
**Generated**: 2026-01-01
**Plan**: PLAN-2026-01-01-sprint3.md

---

## P0: BusStore Removal

### Acceptance Criteria

- [ ] **BusStore deleted**: `src/editor/stores/BusStore.ts` no longer exists
- [ ] **RootStore updated**: No `busStore` property on RootStore
- [ ] **getBusBlocks getter**: PatchStore has `@computed get busBlocks(): Block[]`
- [ ] **getBusById method**: PatchStore has `getBusById(id): Block | undefined`
- [ ] **addBus method**: PatchStore has `addBus(params): Block`
- [ ] **removeBus method**: PatchStore has `removeBus(id): void`
- [ ] **updateBus method**: PatchStore has `updateBus(id, changes): void`
- [ ] **Reactivity works**: UI updates when busBlocks changes
- [ ] **Tests pass**: All store tests pass

### Verification

```bash
ls src/editor/stores/BusStore.ts  # Should fail (file deleted)
grep -r "busStore" src/editor/stores/RootStore.ts  # Should return nothing
pnpm test src/editor/stores/__tests__/PatchStore.test.ts
```

---

## P1: Type Definition Cleanup

### Acceptance Criteria

- [ ] **Endpoint simplified**: `Endpoint` type removed or aliased to `PortRef`
- [ ] **Bus removed**: No `interface Bus` in types.ts
- [ ] **Publisher removed**: No `interface Publisher` in types.ts
- [ ] **Listener removed**: No `interface Listener` in types.ts
- [ ] **Patch.buses removed**: Patch interface has no `buses` field
- [ ] **Patch.publishers removed**: Patch interface has no `publishers` field
- [ ] **Patch.listeners removed**: Patch interface has no `listeners` field
- [ ] **Edge simplified**: Edge.from and Edge.to are `PortRef` type
- [ ] **Compiles**: TypeScript compilation succeeds with no errors
- [ ] **Tests pass**: All tests pass

### Verification

```bash
grep "interface Bus" src/editor/types.ts  # Should return nothing
grep "interface Publisher" src/editor/types.ts  # Should return nothing
grep "interface Listener" src/editor/types.ts  # Should return nothing
grep "buses:" src/editor/types.ts  # Should return nothing (in Patch)
pnpm exec tsc --noEmit
```

---

## P2: UI Component Adaptation

### Acceptance Criteria

- [ ] **BusBoard works**: Shows buses from `patchStore.busBlocks`
- [ ] **BusInspector works**: Edits BusBlock params correctly
- [ ] **BusCreationDialog works**: Creates BusBlock via `patchStore.addBus()`
- [ ] **BusPicker works**: Lists available BusBlocks
- [ ] **BusChannel works**: Renders BusBlock info correctly
- [ ] **ConnectionInspector works**: Handles edges to BusBlock ports
- [ ] **No BusStore refs**: No UI component imports BusStore
- [ ] **Tests pass**: All UI tests pass
- [ ] **Manual verification**: Create/edit/delete bus works in dev server

### Verification

```bash
grep -r "busStore" src/editor/*.tsx  # Should return nothing
pnpm test src/editor/__tests__/  # UI tests pass
```

---

## Sprint 3 Overall Acceptance

### All Tests Pass

```bash
pnpm test --run
# Expected: All tests pass
```

### TypeScript Compiles

```bash
pnpm exec tsc --noEmit
# Expected: No errors
```

### Code Reduction Verified

```bash
# Count lines removed
wc -l src/editor/stores/BusStore.ts 2>/dev/null || echo "Deleted (good)"
# Total codebase should be ~800-1000 lines smaller
```

### Manual Verification Checklist

1. [ ] Start dev server: `just dev`
2. [ ] Create a new bus "TestBus" of type Signal<float>
3. [ ] Verify bus appears in BusBoard
4. [ ] Open bus inspector, verify can edit name/combine mode
5. [ ] Add a block that publishes to TestBus
6. [ ] Add a block that listens from TestBus
7. [ ] Compile the patch - verify no errors
8. [ ] Delete the bus - verify it's removed
9. [ ] Verify undo/redo works for bus operations

---

## Final State Verification

### No Legacy Concepts

```bash
# These should all return nothing
grep -r "interface Bus " src/editor/
grep -r "interface Publisher" src/editor/
grep -r "interface Listener" src/editor/
grep -r "kind.*'bus'" src/editor/
grep -r "BusStore" src/editor/
```

### Architecture Simplified

- [ ] Patch has only `blocks: Block[]` and `edges: Edge[]` for connection data
- [ ] Edge.from and Edge.to are both `PortRef` (no Endpoint union)
- [ ] All buses are BusBlocks in the blocks array
- [ ] One store (PatchStore) manages both blocks and buses
- [ ] Compiler has no bus-specific paths

### File Deletions Completed

- [ ] `src/editor/stores/BusStore.ts` - DELETED
- [ ] Related test files - DELETED or MERGED

### Type Definitions Removed

From `src/editor/types.ts`:
- [ ] `Bus` interface - REMOVED
- [ ] `Publisher` interface - REMOVED
- [ ] `Listener` interface - REMOVED
- [ ] `Endpoint` discriminated union - REMOVED (or simplified to PortRef alias)

---

## Success Metrics Summary

| Metric | Target |
|--------|--------|
| Lines deleted | 800-1000 |
| Types removed | 4 (Bus, Publisher, Listener, Endpoint) |
| Stores unified | BusStore → PatchStore |
| Edge kinds | 3 → 1 (all port→port) |
| Compiler paths | 2 → 1 (unified lowering) |
| All tests | PASS |
| TypeScript | COMPILES |
| UI | FUNCTIONAL |
