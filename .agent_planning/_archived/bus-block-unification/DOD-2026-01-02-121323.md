# Definition of Done: Aggressive Bus Architecture Cleanup
**Generated**: 2026-01-02-121323
**Plan**: PLAN-2026-01-02-121323.md
**Topic**: unify-connections-edge - REVISED Final Cleanup Sprint

---

## Acceptance Criteria

### P0: Remove All Bus Concepts from IR

- [ ] `BusIndex` type removed from `src/editor/compiler/ir/types.ts`
- [ ] All `BusIndex` references removed from IR builder, schedule, program
- [ ] Grep for `\bbus\b` in `src/editor/ir/` returns ZERO files (excluding comments)
- [ ] Grep for `BusIndex` in `src/editor/` returns ZERO files
- [ ] All IR tests pass after removal
- [ ] TypeScript compiles with 0 errors

### P0: Delete Pass 7 (Bus Lowering) Entirely

- [ ] File `src/editor/compiler/passes/pass7-bus-lowering.ts` DELETED
- [ ] File `src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts` DELETED
- [ ] Pass 6 directly feeds into Pass 8 (no Pass 7)
- [ ] Compiler pipeline updated to skip Pass 7
- [ ] All references to `IRWithBusRoots` removed
- [ ] All references to `busRoots` map removed
- [ ] Full test suite passes without Pass 7
- [ ] TypeScript compiles with 0 errors

### P0: Delete Bus Block Utilities

- [ ] File `src/editor/compiler/bus-block-utils.ts` DELETED
- [ ] File `src/editor/compiler/__tests__/bus-block-utils.test.ts` DELETED
- [ ] All `getBusBlocks()` calls removed from compiler
- [ ] All `getBusById()` calls replaced with `getBlockById()`
- [ ] `PatchStore.busBlocks` computed REMOVED
- [ ] Grep for `getBusBlocks` returns ZERO results
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

### P0: Remove LensParamBinding 'bus' Variant

- [ ] `LensParamBinding` type no longer has `kind: 'bus'` variant
- [ ] All lens param bindings use `kind: 'default'`, `'wire'`, or `'literal'`
- [ ] All code constructing `{ kind: 'bus' }` bindings removed
- [ ] All code consuming `kind: 'bus'` bindings removed
- [ ] Grep for `kind.*bus.*LensParam` returns ZERO results
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

### P0: Delete All Bus Diagnostics

- [ ] File `src/editor/compiler/__tests__/bus-diagnostics.test.ts` DELETED
- [ ] All diagnostic targets with `kind: 'bus'` removed
- [ ] All diagnostic targets with `kind: 'binding'` (bus-related) removed
- [ ] `DiagnosticStore` bus-specific filtering removed
- [ ] Grep for `diagnostic.*bus|bus.*diagnostic` returns ZERO results (case-insensitive)
- [ ] Full test suite passes (diagnostic tests may need updates)
- [ ] TypeScript compiles with 0 errors

### P0: Delete All Migration Utilities

- [ ] File `src/editor/transforms/migrate.ts` DELETED (145 lines)
- [ ] File `src/editor/transforms/__tests__/migrate.test.ts` DELETED
- [ ] All `convertLegacyTransforms()` calls removed
- [ ] All `getEdgeTransforms()` fallback logic removed
- [ ] Edges MUST have `transforms` field (no legacy format support)
- [ ] Grep for `migration|migrate|legacy` returns ZERO results in /editor (excluding docs)
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

### P1: Remove Bus References from Compiler

- [ ] Grep for `\bbus\b` in `src/editor/compiler/` returns ZERO active code (comments OK)
- [ ] All compiler passes treat BusBlock like any other block
- [ ] No special-casing of `block.type === 'BusBlock'`
- [ ] Pass 6 handles BusBlock lowering via standard block compiler
- [ ] Pass 8 handles BusBlock edges like any other edge
- [ ] File `src/editor/compiler/__tests__/ir-bus-execution.test.ts` DELETED or RENAMED
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

### P1: Audit and Remove Bus-Specific Store Queries

- [ ] `PatchStore.busBlocks` computed property REMOVED
- [ ] All `getBusById()` calls replaced with `getBlockById()`
- [ ] Full test suite passes
- [ ] TypeScript compiles with 0 errors

### P1: Implement UI Stubs (Except Bus-Related)

- [ ] All `// TODO: stub` comments in UI components resolved
- [ ] `BlockContextMenu.tsx` fully functional
- [ ] `BusChannel.tsx` fully functional OR DELETED if bus-specific
- [ ] `ContextMenu.tsx` fully functional
- [ ] `PatchBay.tsx` fully functional
- [ ] `BlockView.tsx` fully functional
- [ ] `GraphWorkspace.tsx` fully functional
- [ ] Manual UI testing shows all operations work
- [ ] No console errors during typical usage
- [ ] Grep for `stub|TODO.*stub` in UI components returns ZERO results

### P2: Verify Modulation Table Works Block-to-Block

- [ ] Modulation Table displays BusBlock connections
- [ ] Modulation Table treats BusBlocks like any other block
- [ ] No bus-specific code paths in modulation table logic
- [ ] Manual testing shows BusBlock edges appear correctly
- [ ] Grep for `bus` in `src/editor/modulation-table/` returns only generic block handling
- [ ] TypeScript compiles with 0 errors

### P2: Update Test Suite for New Architecture

- [ ] All deleted test files removed from test suite config
- [ ] All remaining tests pass (2500+ tests)
- [ ] No skipped tests related to bus functionality
- [ ] Test coverage maintained or improved
- [ ] TypeScript compiles with 0 errors
- [ ] No console warnings during test run

### P3: Documentation Cleanup

- [ ] ROADMAP.md marks `unify-connections-edge` as COMPLETE
- [ ] STATUS files in topic directory marked as SUPERSEDED
- [ ] Code comments referring to "bus lowering" updated or removed
- [ ] No TODO comments about bus migration
- [ ] All deleted files removed from documentation references

---

## Sprint Scope

This sprint delivers:
1. **Zero bus concepts in compiler/IR** - BusBlocks are treated identically to other blocks
2. **Zero migration utilities** - No backward compatibility for old patch formats
3. **Zero bus-specific diagnostics** - Can be added back later as regular block diagnostics
4. **Fully functional UI** - All stubs implemented, modulation table works
5. **Updated test suite** - All tests pass, no bus-specific test categories

Deferred:
- Sprint 4 (Lens Param Bindings) - Independent feature work, not part of this topic

---

## Verification Commands

**After Sprint 1 (Backend Purge)**:
```bash
grep -r '\bbus\b' src/editor/compiler/ --include="*.ts" | grep -v '//' | wc -l
# Expected: 0

grep -r '\bbus\b' src/editor/ir/ --include="*.ts" | grep -v '//' | wc -l
# Expected: 0
```

**After Sprint 2 (Type/Store Cleanup)**:
```bash
grep -r "kind.*['\"]bus['\"]" src/editor/ --include="*.ts"
# Expected: 0 (excluding Bus interface definition)

# Expected: 0
```

**After All Work Complete**:
```bash
just check
# Expected: 0 errors, 2500+ tests passing
```

---

## Success Criteria Summary

**Code Quality**:
- TypeScript compiles with 0 errors
- Test suite passes (2500+ tests)
- Zero bus-specific code in compiler/IR (verified via grep)
- Zero migration utilities (verified via file deletion)

**Architecture**:
- BusBlock treated identically to other blocks
- No special compiler passes for buses
- No bus-specific store queries
- No bus-specific diagnostic code

**Functionality**:
- Can create BusBlock via UI
- Can connect edges to/from BusBlock
- BusBlock compiles correctly
- Modulation table shows BusBlock connections
- No console errors during typical usage

**Code Reduction**:
- ~2000+ lines of bus-specific code removed
- ~9-10 files deleted
- Simplified architecture with fewer special cases

---

## Breaking Changes

**User must be aware**:
1. Old patches with legacy bus format will NOT load
2. No migration utilities - patches must be migrated using previous version
3. API changes:
   - `PatchStore.busBlocks` removed
   - Pass 7 removed from compiler pipeline

---

**Generated**: 2026-01-02-121323
**Plan Reference**: PLAN-2026-01-02-121323.md
**Total Criteria**: 89 acceptance criteria across 12 deliverables
**Estimated Timeline**: 2-5 weeks (depending on parallelization)
