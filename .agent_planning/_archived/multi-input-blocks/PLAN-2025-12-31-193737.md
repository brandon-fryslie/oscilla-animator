# Sprint Plan: Multi-Input Blocks (Phase 1)

**Generated**: 2025-12-31-193737
**Source STATUS**: STATUS-2025-12-31-193238.md
**Sprint**: Phase 0 - Sprint 3: Multi-Input Blocks with Combine Modes
**Feature Flag**: NONE (shipping directly)
**Effort Estimate**: 2-3 days (12-18 hours)
**Dependencies**: Edge Unification Sprint 1 (4 work items remaining)
**User Decision**: Approved without feature flag (2025-12-31)

---

## Executive Summary

This sprint implements **Phase 1 of the multi-input blocks feature** behind a feature flag, enabling input ports to accept multiple edges with combine semantics. This is a natural extension of the Edge unification work (Sprint 1) and implements the architectural vision documented in `ARCHITECTURE-PROPOSAL.md`.

**Current State** (from STATUS-2025-12-31-193238.md):
- Edge type unified and in use (Sprint 1 Part 1 complete, 2/6 items done)
- Single-input invariant enforced in PatchStore.ts:905-907 and BusStore.ts:346-348
- Bus combine logic fully implemented and battle-tested (pass7-bus-lowering.ts:88-150)
- Compiler passes NOT YET updated to use Edge type (Pass 2, 6, 7, 8 pending)

**Target State**:
- Input slots support optional `combineMode` field
- Multiple edges to same input allowed (behind feature flag)
- Pass 6 handles multi-input resolution with combine logic
- Combine semantics validated against world/domain constraints
- Backward compatibility maintained (flag off = old single-input behavior)

**Strategic Value**:
- Unifies 3 connection types → 1 edge type
- Eliminates buses as architectural necessity
- Simplifies Probe Mode, disconnect logic, and connection operations
- Massive architectural simplification (see ARCHITECTURE-PROPOSAL.md § Benefits)

---

## Work Items

### P0: Add combineMode to Slot Interface

**Status**: Not Started
**Effort**: Small (2-4 hours)
**Dependencies**: None
**Spec Reference**: ARCHITECTURE-PROPOSAL.md lines 22-34 • **STATUS Reference**: STATUS-2025-12-31-193238.md § "Minimal Implementation Path" lines 224-239

#### Description

Extend the `Slot` interface in `src/editor/types.ts` to support an optional `combineMode` field for multi-input ports. This field specifies how multiple edges are combined when N > 1 edges connect to an input.

The `combineMode` uses the existing `BusCombineMode` type already defined for buses:
```typescript
export type BusCombineMode = 'sum' | 'average' | 'max' | 'min' | 'last' | 'layer';
```

**Current Evidence** (STATUS lines 224-239):
- Slot interface exists at types.ts:552-598
- BusCombineMode already defined at types.ts:113
- Bus combine semantics documented in busSemantics.ts:41-60

**Technical Approach**:
1. Add optional `combineMode?: BusCombineMode` field to Slot interface
2. Document that combineMode only meaningful for input slots
3. Document default behavior: 'last' if not specified (matches single-input semantics)
4. Add JSDoc explaining validation rules (world/domain compatibility)

#### Acceptance Criteria (REQUIRED)

- [ ] Slot interface extended with `readonly combineMode?: BusCombineMode` field
- [ ] JSDoc added explaining: (a) only for input slots, (b) default is 'last', (c) validated against world/domain
- [ ] No breaking changes to existing code (field is optional)
- [ ] Type exports updated if necessary
- [ ] TypeScript compilation succeeds with no errors

#### Technical Notes

**Validation rules** (STATUS lines 299-322):
- **Signal/Field world**: All combine modes valid
- **Config world**: Only 'last' valid (stepwise changes)
- **Scalar world**: Multi-input N/A (compile-time constants)

**Domain validation** (STATUS lines 326-352):
- **Numeric domains** (float, int, vec2, vec3): All modes
- **Color domain**: 'last' and 'layer' only
- **String/boolean**: 'last' only

**Ordering semantics** (STATUS lines 547-554):
- Use `sortKey` from Edge for deterministic ordering
- Order matters for 'last' and 'layer' modes

---

### P1: Remove Single-Input Invariant

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: None
**Spec Reference**: ARCHITECTURE-PROPOSAL.md lines 23-25 • **STATUS Reference**: STATUS-2025-12-31-193238.md § "Single-Input Invariant" lines 78-103

#### Description


**Current Evidence** (STATUS lines 78-103):
- PatchStore.ts:905-907: Wire connections enforce 1:1

**Impact**:
- Multiple edges now allowed to same input (permanent change)
- Existing patches continue to work (single-input is subset of multi-input)
- No UI changes needed initially (Inspector will show multiple edges)

#### Acceptance Criteria (REQUIRED)

- [ ] PatchStore.connect() no longer calls disconnectInputPort
- [ ] disconnectInputPort logic unchanged (still used for explicit disconnects)
- [ ] Unit tests verify multiple edges can connect to same input
- [ ] Integration test confirms multiple edges to same input work correctly
- [ ] No edge cases cause errors (e.g., duplicate edges, self-loops)

#### Technical Notes

**Validation needed**:
- Prevent duplicate edges (same from/to endpoints)
- Prevent bus→bus edges (should already be rejected)
- Maintain enabled/disabled edge semantics

**Testing strategy**:
1. Create test patch with BlockA.out → BlockB.in
2. Add second edge BlockC.out → BlockB.in with flag ON
3. Verify both edges exist
4. Repeat with flag OFF, verify second edge replaces first
5. Test edge removal (should only remove specified edge, not all)

---

### P2: Extract Combine Logic from Pass 7

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: None (can proceed in parallel)
**Spec Reference**: ARCHITECTURE-PROPOSAL.md lines 38-40 • **STATUS Reference**: STATUS-2025-12-31-193238.md § "Minimal Implementation Path" lines 284-290

#### Description

Extract the bus combine logic from Pass 7 (pass7-bus-lowering.ts) into reusable utility functions in a new `combine-utils.ts` file. This allows both Pass 6 (multi-input ports) and Pass 7 (buses) to share the same battle-tested combine semantics.

**Current Evidence** (STATUS lines 107-136):
- Bus combine implemented at pass7-bus-lowering.ts:88-150
- Creates sigCombine/fieldCombine nodes
- Handles empty buses with default values
- Canonical combine semantics in busSemantics.ts:41-60

**Extracted functionality**:
1. **Combine node creation**: Given N inputs + combineMode → emit IR node
3. **Default value handling**: When N=0, use defaultValue
4. **Type validation**: Verify combineMode valid for world/domain

#### Acceptance Criteria (REQUIRED)

- [ ] New file `src/editor/compiler/passes/combine-utils.ts` created
- [ ] Function `createCombineNode(mode, inputs, type, builder)` implemented
- [ ] Function `validateCombineMode(mode, world, domain)` implemented
- [ ] Pass 7 refactored to use combine-utils (no behavior change)
- [ ] All existing Pass 7 tests still pass (regression check)
- [ ] JSDoc added explaining combine semantics and ordering rules

#### Technical Notes

**Function signature**:
```typescript
/**
 * Create a combine node for N inputs with specified mode.
 * Returns a ValueRefPacked that represents the combined value.
 */
export function createCombineNode(
  mode: BusCombineMode,
  inputs: readonly ValueRefPacked[],
  type: TypeDesc,
  builder: IRBuilder,
  defaultValue?: unknown
): ValueRefPacked;

/**
 * Validate that a combine mode is compatible with world/domain.
 */
export function validateCombineMode(
  mode: BusCombineMode,
  world: SlotWorld,
  domain: CoreDomain
): { valid: boolean; reason?: string };
```

**Reuse from busSemantics.ts**:
- Combine semantics for Signal: busSemantics.ts:41-60
- Combine semantics for Field: similar logic
- Sorting logic: (sortKey, id) for determinism

---

### P2: Update Pass 6 for Multi-Input Resolution

**Status**: Not Started
**Effort**: Medium (6-8 hours)
**Dependencies**: P1: Remove Single-Input Invariant, P2: Extract Combine Logic from Pass 7
**Spec Reference**: ARCHITECTURE-PROPOSAL.md lines 36-40 • **STATUS Reference**: STATUS-2025-12-31-193238.md § "Compiler Pass Integration Points" lines 144-148

#### Description

Update Pass 6 (pass6-block-lowering.ts) to handle multiple edges to the same input port. When N > 1 edges connect to an input, create a combine node using the extracted combine logic. When N = 0, use default source. When N = 1, use direct passthrough (no combine).

**Current Evidence** (STATUS lines 144-148):
- Current logic: `const edge = edges.find(e => e.to === input)`
- Needs to change to: `const inputEdges = edges.filter(e => e.to === input && e.enabled)`

**New resolution logic**:
```
if (inputEdges.length === 0):
  → Use defaultSource (materializeDefaultSource)
else if (inputEdges.length === 1):
  → Direct passthrough (no combine overhead)
else:
  → Apply combine mode from slot.combineMode || 'last'
  → Sort edges by (sortKey, id) for determinism
  → Create combine node using combine-utils
```

#### Acceptance Criteria (REQUIRED)

- [ ] Pass 6 filters edges by `e.to === inputPort && e.enabled`
- [ ] N=0 case: Uses materializeDefaultSource (existing behavior)
- [ ] N=1 case: Direct passthrough without combine node
- [ ] N>1 case: Creates combine node with combineMode from slot
- [ ] Edge ordering uses sortKey for deterministic combine (same as buses)
- [ ] Default combineMode is 'last' if not specified on slot
- [ ] Unit tests cover all 3 cases (N=0, N=1, N>1)
- [ ] Integration test verifies compiled IR matches expected structure

#### Technical Notes

**Input resolution pseudo-code**:
```typescript
function resolveInput(
  inputSlot: Slot,
  edges: Edge[],
  blockOutputs: Map<BlockIndex, Map<string, ValueRefPacked>>
): ValueRefPacked {
  const inputEdges = edges.filter(e =>
    e.to.kind === 'port' &&
    e.to.blockId === currentBlockId &&
    e.to.slotId === inputSlot.id &&
    e.enabled
  );

  if (inputEdges.length === 0) {
    // Use default source
    return materializeDefaultSource(inputSlot.defaultSource, builder);
  }

  if (inputEdges.length === 1) {
    // Direct passthrough
    return resolveEdgeSource(inputEdges[0], blockOutputs);
  }

  // Multi-input: apply combine
  const combineMode = inputSlot.combineMode || 'last';
  const sortedInputs = sortEdges(inputEdges).map(e =>
    resolveEdgeSource(e, blockOutputs)
  );
  return createCombineNode(combineMode, sortedInputs, inputSlot.type, builder);
}
```

**Edge cases**:
- Disabled edges should be ignored (filter by `e.enabled`)
- Edge ordering uses `sortKey` (ascending), ties broken by edge ID
- Adapters/lenses on edges NOT YET supported (validate and error if present)

**Test coverage**:
1. Single edge to input → direct passthrough (no combine overhead)
2. Two edges to input → combine node created
3. Zero edges to input → default source used
4. Different combine modes (sum, max, last, etc.) → correct IR nodes
5. Edge ordering matters for 'last' mode → verify sortKey respected

---

### P3: Add Combine Mode Validation

**Status**: Not Started
**Effort**: Small (3-4 hours)
**Dependencies**: P0: Add combineMode to Slot Interface
**Spec Reference**: N/A (quality/safety concern) • **STATUS Reference**: STATUS-2025-12-31-193238.md § "Semantic/Type-System Implications" lines 295-352

#### Description

Add validation to ensure `combineMode` is compatible with the slot's world and domain. Invalid combinations should produce compile-time errors with clear messages, not silent failures.

**Validation rules** (STATUS lines 295-352):

**By World**:
- `signal`/`field`: All modes valid
- `config`: Only 'last' valid
- `scalar`: Multi-input N/A (error if N > 1 edges)

**By Domain**:
- `float`/`int`/`vec2`/`vec3`: All modes valid
- `color`: Only 'last' and 'layer'
- `string`/`boolean`: Only 'last'

**Failure mode**: Emit compile error like:
```
"Input 'strength' (world: config, domain: float) does not support combineMode 'sum'. Valid modes: ['last']"
```

#### Acceptance Criteria (REQUIRED)

- [ ] Validation function `validateCombineMode(mode, world, domain)` implemented
- [ ] Called during Pass 6 when creating combine nodes
- [ ] Invalid combinations emit CompileError with actionable message
- [ ] Unit tests cover all invalid combinations
- [ ] Unit tests verify all valid combinations pass
- [ ] Documentation updated with validation rules

#### Technical Notes

**Implementation**:
```typescript
function validateCombineMode(
  mode: BusCombineMode,
  world: SlotWorld,
  domain: CoreDomain
): { valid: boolean; reason?: string } {
  // 'last' is always valid
  if (mode === 'last') return { valid: true };

  // Scalar world doesn't support multi-input
  if (world === 'scalar') {
    return { valid: false, reason: 'Scalar inputs cannot have multiple sources' };
  }

  // Config world only supports 'last'
  if (world === 'config') {
    return { valid: false, reason: 'Config inputs only support combineMode "last"' };
  }

  // Domain-specific validation
  if (['float', 'int', 'vec2', 'vec3'].includes(domain)) {
    // All modes valid
    return { valid: true };
  }

  if (domain === 'color') {
    if (mode === 'layer') return { valid: true };
    return { valid: false, reason: 'Color domain only supports "last" and "layer"' };
  }

  // String, boolean, etc.
  return { valid: false, reason: `Domain "${domain}" only supports combineMode "last"` };
}
```

**Where to validate**:
- Pass 6 before creating combine node
- Optionally: Block definition validation (catch at definition time)
- Optionally: UI validation (prevent selecting invalid mode in Inspector)

---

## Dependency Graph

```
P0: Add combineMode to Slot Interface
  ↓
P1: Remove Single-Input Invariant
  ↓
P2: Extract Combine Logic from Pass 7 (parallel)
  ↓
P2: Update Pass 6 for Multi-Input Resolution
  ↓
P3: Add Combine Mode Validation
```

**Parallel work**:
- P2 "Extract Combine Logic" can proceed independently
- P0 and P1 can proceed in parallel

**Critical path**: P0 → P1 → P2 → P2 (total ~14 hours)

---

## Recommended Sprint Execution

### Day 1 (6-8 hours)
1. **Morning**: P0 - Add combineMode to Slot Interface (2-4 hours)
2. **Afternoon**: P1 - Feature Flag + Remove Invariant (3-5 hours)
   - Combined effort: flag + conditional logic

**Milestone**: Multi-input connections allowed (no compile support yet)

### Day 2 (6-8 hours)
1. **Morning**: P2 - Extract Combine Logic from Pass 7 (4-6 hours)
2. **Afternoon**: Start P2 - Update Pass 6 (partial, 2-4 hours)

**Milestone**: Combine logic extracted and tested

### Day 3 (4-6 hours)
1. **Morning**: Complete P2 - Update Pass 6 (4-6 hours)
2. **Afternoon**: P3 - Add Combine Mode Validation (3-4 hours)

**Milestone**: Full multi-input compilation working

### Buffer
- 2-4 hours for testing, debugging, edge cases
- Documentation updates
- Golden patch tests

---

## Risk Assessment

### MEDIUM: Semantic Complexity

**Risk**: Combine modes have subtle semantics (order matters for 'last', 'layer')
**Impact**: Incorrect combine logic produces wrong output
**Mitigation**:
- Reuse battle-tested bus combine logic
- Comprehensive unit tests for all modes
- Document ordering semantics clearly (sortKey)
- Golden patch tests verify actual output

### LOW: Performance

**Risk**: N edges per input increases combine operations
**Impact**: Slower compilation/runtime
**Mitigation**:
- Same optimization applies (sorted array, single pass)
- Expect <5% performance impact
- Skip combine node when N=1 (direct passthrough)

### LOW: UI Complexity

**Risk**: Multi-edge rendering becomes cluttered
**Impact**: Hard to see what's connected
**Mitigation**:
- Defer UI updates to separate sprint (out of scope)
- Existing Inspector already shows edge lists
- Canvas can handle multiple wires (may overlap initially)

### LOW: Backward Compatibility

**Risk**: Existing patches break
**Impact**: User work lost
**Mitigation**:
- Feature flag during development (default OFF)
- Single-input is subset of multi-input (trivial migration)
- All existing patches work unchanged
- Extensive regression testing

---

## Out of Scope (Deferred to Future Sprints)

### UI Updates (Sprint 3.5 or 4)
- Inspector: Multi-edge visualization + combine mode selector
- Canvas: Multi-wire rendering without overlap
- Edge ordering UI for 'layer' mode

### Bus Removal (Phase 4)
- Only after multi-input blocks prove successful
- Migrate buses to "BusCombiner" blocks
- Deprecate BusStore
- Update BusBoard to query edges by channelName

### Transform Unification (Sprint 4)
- Consolidate adapters + lenses into unified transforms
- Apply to both multi-input edges and single edges

---

## Test Requirements

### Unit Tests (New)

**Slot Interface**:
- ✅ Slot with combineMode defined
- ✅ combineMode optional (backward compat)
- ✅ combineMode ignored on output slots

**Feature Flag**:
- ✅ Flag OFF: single-input invariant enforced
- ✅ Flag ON: multiple edges allowed
- ✅ Flag toggle doesn't break existing patches

**Combine Validation**:
- ✅ All valid combinations pass
- ✅ Invalid world/domain combinations emit errors
- ✅ Error messages are actionable

**Combine Logic**:
- ✅ Each combine mode (sum, average, max, min, last, layer)
- ✅ Edge ordering (sortKey) respected
- ✅ Default value when N=0
- ✅ Direct passthrough when N=1

### Integration Tests (New)

**End-to-End Compilation**:
- ✅ Patch with multi-input block compiles successfully
- ✅ IR structure matches expected (combine nodes present)
- ✅ Different combine modes produce different IR
- ✅ Single edge to input → no combine node (optimization)

**Backward Compatibility**:
- ✅ Existing patches compile identically (flag OFF)
- ✅ Edge unification Sprint 1 patches still work

### Golden Patch Tests (New)

**Create new golden patches**:
- Multi-input with 'sum' mode (2 float signals → combined)
- Multi-input with 'last' mode (verify ordering)
- Multi-input with 'layer' mode (color domain)
- Mixed single/multi inputs on same block
- Empty input (default source) + multi-input on different slots

---

## Success Criteria

**Sprint complete when**:
1. ✅ All P0, P1, P2, P3 work items have acceptance criteria met
2. ✅ Feature flag toggles between old/new behavior
3. ✅ Multi-input compilation produces correct IR
4. ✅ All unit tests pass (existing + new)
5. ✅ All integration tests pass
6. ✅ Golden patch tests verify actual output
7. ✅ No regressions in existing functionality (flag OFF)
8. ✅ Documentation updated (ARCHITECTURE-PROPOSAL.md, this plan)

**Definition of Done**: See separate `DOD-2025-12-31-193737.md` file.

---

## Next Actions

**After Sprint 3 Complete**:
1. **Sprint 3.5 (Optional)**: UI updates for multi-input (Inspector + Canvas)
2. **Sprint 4**: Transform unification (adapters + lenses)
3. **Phase 4 (Future)**: Bus removal (after multi-input proven)

**Blockers**:
- Edge Unification Sprint 1 should ideally complete first (4 work items remaining)
- OR: Proceed in parallel with careful coordination (both modify Pass 6)

**Decision Point**: User approval to proceed with Sprint 3?

---

## References

**Authoritative Sources**:
- `.agent_planning/_queued/edge-unification/ARCHITECTURE-PROPOSAL.md` (architectural vision)
- `.agent_planning/multi-input-blocks/STATUS-2025-12-31-193238.md` (current state evaluation)

**Related Plans**:
- `.agent_planning/phase0-architecture-refactoring/PLAN-2025-12-31-170000-sprint1-connections.md` (Edge unification Sprint 1)
- `.agent_planning/phase0-architecture-refactoring/DOD-2025-12-31-170000-sprint1-connections.md` (Edge unification acceptance criteria)

**Code References**:
- `src/editor/types.ts` (Slot, Edge, BusCombineMode types)
- `src/editor/stores/PatchStore.ts` (single-input invariant)
- `src/editor/stores/BusStore.ts` (single-input invariant)
- `src/editor/compiler/passes/pass6-block-lowering.ts` (input resolution)
- `src/editor/compiler/passes/pass7-bus-lowering.ts` (bus combine logic)
- `src/editor/semantic/busSemantics.ts` (canonical combine semantics)

---

**Plan complete. Ready for implementation after user approval and Edge unification Sprint 1 completion.**
