# Definition of Done: Render Pipeline Completion Sprint
**Generated**: 2025-12-31-045303
**Plan**: PLAN-2025-12-31-045303.md
**Source Status**: STATUS-20251231.md

---

## Sprint Scope

This sprint delivers **2 core deliverables** to complete the render pipeline:

**Deliverable 1**: Fix blockers and complete stubbed features
- Fix type errors blocking test execution
- Implement ClipGroup rendering (no stub)
- Implement ColorGrade effect (no stub)

**Deliverable 2**: Automated test suite for all 6 render gaps
- Z-order rendering tests
- Curve flattening tests
- Clipping/masking tests
- Per-instance transform tests
- PostFX effect tests
- Gradient material tests

**Deferred**: None (all critical work in scope)

---

## Acceptance Criteria

### P0: Fix Type Errors (BLOCKING)

**Goal**: Unblock test execution by fixing TypeScript compilation errors

- [ ] All 6 mock objects in `state-offset-resolution.test.ts` include `debugProbes: []` field
- [ ] TypeScript compilation succeeds (`just typecheck` passes with zero errors)
- [ ] All existing tests pass (`just test` executes without compilation errors)
- [ ] No new type errors introduced in any files

**Verification**: Run `just check` and verify clean output

---

### P0: Implement ClipGroup Rendering (CRITICAL)

**Goal**: Complete ClipGroup rendering so clipped content actually renders

- [ ] ClipGroup case in `canvasRenderer.ts` implements full rendering logic (no stub, no console.warn)
- [ ] Canvas state saved before applying clip via `ctx.save()`
- [ ] Clip region applied via `applyPassHeader()` for rect/circle clips
- [ ] All child passes in `pass.children` rendered recursively
- [ ] Canvas state restored after children via `ctx.restore()`
- [ ] Path-based clipping either implemented OR documented as deferred with error on usage

**Verification**:
- Grep for "ClipGroup pass rendering not implemented" - should find zero results
- Code inspection: verify recursive rendering of children
- Test: ClipGroup test case passes (from P2 test suite)

---

### P1: Implement ColorGrade Effect (HIGH)

**Goal**: Complete ColorGrade PostFX effect with pixel manipulation

- [ ] ColorGrade case in `renderPostFX.ts` implements pixel manipulation (no stub, no console.warn)
- [ ] Source canvas converted to ImageData via `ctx.getImageData()`
- [ ] Color matrix applied to RGB channels for each pixel
- [ ] Alpha channel handled correctly (preserved or transformed)
- [ ] Modified ImageData written to destination via `ctx.putImageData()`
- [ ] Color matrix parameters read from `effect.matrix` field (or default identity matrix if undefined)

**Verification**:
- Grep for "ColorGrade effect not implemented" - should find zero results
- Code inspection: verify ImageData manipulation logic
- Test: ColorGrade test case passes (from P2 test suite)

---

### P2: Automated Test Suite (REQUIRED FOR COMPLETE)

**Goal**: Create persistent automated tests for all 6 render pipeline features

#### Test Infrastructure

- [ ] Test fixture creates minimal patch with render sink
- [ ] Helper function compiles patch to IR and executes render schedule
- [ ] Test file created at `src/editor/runtime/__tests__/render-pipeline.test.ts`

#### Gap 1: Z-Order Rendering Tests

- [ ] Test: overlapping shapes render in correct z-order
  - **Given**: 3 shapes at z=0, z=1, z=2 with different colors
  - **Then**: top layer (z=2) is visible at overlap point

#### Gap 2: Curve Flattening Tests

- [ ] Test: cubic bezier flattens to line segments
  - **Given**: PathCmd.CUBIC with control points, tolerance=0.5
  - **Then**: materialized path contains only line segments (no bezier commands)

- [ ] Test: quadratic bezier flattens to line segments
  - **Given**: PathCmd.QUAD with control point, tolerance=0.5
  - **Then**: materialized path contains only line segments

#### Gap 3: Clipping/Masking Tests

- [ ] Test: rect clip bounds rendering
  - **Given**: instances outside clip rect
  - **Then**: instances outside clip are not visible

- [ ] Test: circle clip bounds rendering
  - **Given**: instances outside clip circle
  - **Then**: instances outside clip are not visible

- [ ] Test: ClipGroup renders children with clip applied
  - **Given**: ClipGroup with rect clip and child passes
  - **Then**: children render within clip bounds only

#### Gap 4: Per-Instance Transform Tests

- [ ] Test: rotation applies per instance
  - **Given**: 2 instances with different rotation values
  - **Then**: each instance rotated independently

- [ ] Test: scaleXY applies per instance
  - **Given**: 2 instances with different scaleXY values
  - **Then**: each instance scaled independently

#### Gap 5: PostFX Effect Tests

- [ ] Test: blur effect renders
  - **Given**: scene with blur postfx pass
  - **Then**: output canvas has blur applied (verify via edge detection or visual inspection)

- [ ] Test: bloom effect renders
  - **Given**: scene with bloom postfx pass
  - **Then**: output canvas has bloom glow (verify via brightness increase)

- [ ] Test: vignette effect renders
  - **Given**: scene with vignette postfx pass
  - **Then**: output canvas has darkened edges (corner pixels darker than center)

- [ ] Test: colorGrade effect applies matrix
  - **Given**: scene with colorGrade postfx pass and grayscale matrix
  - **Then**: output canvas is grayscale (R=G=B for all pixels within tolerance)

#### Gap 6: Gradient Material Tests

- [ ] Test: linear gradient renders
  - **Given**: shape with linear gradient material (color stops)
  - **Then**: pixels transition along gradient axis

- [ ] Test: radial gradient renders
  - **Given**: shape with radial gradient material (center to edge)
  - **Then**: pixels transition from center to edge

**Verification**: Run `just test` and verify all render-pipeline tests pass

---

## Global Validation Checklist

**Before marking sprint COMPLETE, verify all of the following**:

### Build & Tests
- [ ] `just typecheck` passes with zero type errors
- [ ] `just test` passes with all tests green (no failures, no skipped tests)
- [ ] `just lint-fix` applied and passes with zero warnings
- [ ] `just check` passes (full suite: typecheck + lint + test)

### Code Quality
- [ ] No `console.warn()` calls in render pipeline code (grep for "not implemented")
- [ ] No stub implementations remaining in canvasRenderer.ts or renderPostFX.ts
- [ ] All 6 gaps have functional implementations (not just types)
- [ ] All 6 gaps have at least 1 passing automated test

### Git Hygiene
- [ ] All changes committed with clear commit messages
- [ ] Git status is clean (no uncommitted changes)
- [ ] Commit messages follow project conventions (no "Generated by Claude")

### Regression Prevention
- [ ] All existing tests still pass (no regressions introduced)
- [ ] No new ESLint errors introduced
- [ ] No breaking changes to IR types or renderer API

---

## Manual Verification (Optional, Recommended)

**After all automated checks pass, optionally verify in dev server**:

- [ ] Run `just dev` and load a test patch
- [ ] Visual inspection: z-order renders correctly (overlapping shapes)
- [ ] Visual inspection: bezier curves render smoothly (no jagged edges)
- [ ] Visual inspection: clipping works (content clipped to bounds)
- [ ] Visual inspection: per-instance transforms work (rotation, scale)
- [ ] Visual inspection: PostFX effects work (blur, bloom, vignette, colorGrade)
- [ ] Visual inspection: gradients render correctly (linear, radial)
- [ ] No errors in browser console

**Note**: Manual verification is NOT required for COMPLETE status (automated tests are sufficient), but is highly recommended for confidence.

---

## Sprint Success Criteria

**Sprint is COMPLETE when**:
1. ✓ All type errors resolved
2. ✓ ClipGroup fully implemented (no stub)
3. ✓ ColorGrade fully implemented (no stub)
4. ✓ All 6 gaps have passing automated tests
5. ✓ All acceptance criteria checkboxes above are checked
6. ✓ `just check` passes with zero errors

**Sprint is BLOCKED if**:
1. Type errors require major refactor (more than 1 hour)
2. Canvas API features not available in test environment
3. Test infrastructure cannot be set up (missing deps, env issues)

**Escalation Path**: If blocked, pause and report blocker to user for scope adjustment.

---

## Definition of "COMPLETE" (Clarified)

Per user clarification, **COMPLETE status requires**:

1. **Full implementation** - no stubs, no console.warn() placeholders
2. **Type safety** - TypeScript compiles without errors
3. **Automated tests** - at least 1 passing test per feature
4. **No regressions** - all existing tests still pass

**NOT required for COMPLETE**:
- Manual verification in dev server (automated tests are sufficient)
- Visual regression testing (deferred to future QA workstream)
- Edge case handling beyond spec requirements

---

## File Manifest

**Modified Files**:
- `src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts` - add debugProbes to 6 mocks
- `src/editor/runtime/canvasRenderer.ts` - implement ClipGroup rendering
- `src/editor/runtime/renderPostFX.ts` - implement ColorGrade effect

**New Files**:
- `src/editor/runtime/__tests__/render-pipeline.test.ts` - test suite for all 6 gaps

**Not Modified**:
- IR type definitions (already complete)
- Render pass executors (no changes needed)
- Block compilers (out of scope)

---

## Risk Mitigation

**If ColorGrade ImageData is too slow**:
- Accept simple 3x3 matrix implementation as proof of concept
- Document GPU-based implementation as future optimization
- Performance is NOT a blocker for COMPLETE status

**If test pixel assertions are flaky**:
- Use tolerance in color comparisons (±5 for RGB values)
- Simplify to structural assertions (e.g., "gradient object exists")
- Flakiness on CI is NOT a blocker if tests pass locally

**If path clipping is complex**:
- Defer to future sprint, document as limitation
- Throw clear error if path clip is used
- Path clipping is NOT required for COMPLETE status (rect/circle are sufficient)

---

**END OF DOD**
