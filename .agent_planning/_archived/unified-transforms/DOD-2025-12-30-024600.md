# Definition of Done: Unified Transforms Refactor
**Generated**: 2025-12-30-024600
**Plan**: PLAN-2025-12-30-024600.md
**Scope**: 6 phases across 5 sprints (18-24 days)

---

## Sprint 1: Foundation & Adapter Unification

### Deliverable 1: Transform Facade Modules
- [ ] All 5 files created in `src/editor/transforms/` with documented exports
- [ ] `normalizeTransformStack()` round-trips correctly (empty arrays, enabled defaults)
- [ ] `listLensesFor()` filters by domain correctly
- [ ] `validate.ts` exports placeholder validators (can return empty errors for now)
- [ ] `apply.ts` wrappers call existing compiler logic (no behavior change)
- [ ] `just check` passes with no new errors
- [ ] Unit tests cover normalization and catalog functions

### Deliverable 2: Unified Adapter Execution
- [ ] All 18 adapters have `apply` implementations in registry
- [ ] `applyAdapterStep()` is replaced with registry lookup (< 10 lines)
- [ ] Missing adapters now error explicitly (not silent "default" case)
- [ ] All existing bus compilation tests pass
- [ ] Manual test: Wire with `ConstToSignal` adapter compiles correctly
- [ ] `just check` passes

### Sprint 1 Scope
**This sprint delivers**: Transform facade + unified adapter execution
**Deferred**: Lens scope expansion, UI changes, IR support

---

## Sprint 2: Lens Scope Unification

### Deliverable 3: Expand LensScope to Include Wires
- [ ] All 27 lens definitions have explicit `allowedScopes` arrays (no undefined)
- [ ] Wire lenses (majority) explicitly allow `'wire'` scope
- [ ] Scope validator rejects illegal lens usage with clear error messages
- [ ] Compiler calls scope validator before applying lens stacks
- [ ] All existing lens tests pass
- [ ] Manual test: Apply scale lens to wire (allowed)
- [ ] Manual test: Apply ease lens to wire (rejected with error)
- [ ] `just check` passes

### Sprint 2 Scope
**This sprint delivers**: Consistent lens scope enforcement across all 4 binding types
**Deferred**: UI migration, IR support, semantic validation

---

## Sprint 3: Centralized Transform Application

### Deliverable 4: Move Transform Logic to Facade
- [ ] `transforms/apply.ts` contains canonical implementation (not wrappers)
- [ ] All adapter and lens application goes through transform engine
- [ ] Scope parameter is explicit at all call sites (no hidden wire special cases)
- [ ] Lens param resolution uses same transform engine (recursive support intact)
- [ ] Depth limit for lens param bindings enforced by validator
- [ ] All bus compilation tests pass
- [ ] Field bus compilation tests pass (adapter chains critical here)
- [ ] Manual test: Lens param binding with adapters resolves correctly
- [ ] `just check` passes

### Sprint 3 Scope
**This sprint delivers**: One canonical transform engine used everywhere
**Deferred**: UI changes, IR support

---

## Sprint 4: Registry-Driven Lens UI

### Deliverable 5: Migrate Lens UI to Registry
- [ ] Lens UI components located or created
- [ ] `LensSelector` renders lens options from `LensRegistry.getAllLenses()`
- [ ] Lens list filtered by scope (wire selector shows wire-compatible lenses only)
- [ ] Lens list filtered by domain (float input shows float lenses only)
- [ ] Param editors render from `LensDef.params` schema (no hardcoded switches)
- [ ] All lens param types supported: default, literal, wire, bus bindings
- [ ] Reordering, enabling/disabling, removing lenses works
- [ ] Manual test in `just dev`: Add/edit/remove lenses via UI on wire
- [ ] Changes persist correctly in patch
- [ ] `just check` passes

### Sprint 4 Scope
**This sprint delivers**: Registry-driven lens UI (no hardcoded catalogs)
**Deferred**: IR support, semantic validation

---

## Sprint 5: Full IR Transform Support

### Deliverable 6: IR Compiler Transform Lowering
- [ ] All cheap adapters have `compileToIR` implementations
- [ ] All pure lenses have `compileToIR` implementations
- [ ] IR passes thread transform stacks through lowering (Pass 6, 7, 8 modified)
- [ ] IR validator rejects unsupported transforms with clear errors
- [ ] Supported transforms compile to IR nodes correctly
- [ ] IR runtime can execute adapter/lens nodes (if runtime fallback used)
- [ ] Wire transforms work in IR mode (test: `ConstToSignal` adapter on wire)
- [ ] Unsupported transforms error clearly (test: `slew` lens errors with message)
- [ ] All existing IR tests pass
- [ ] Manual test: Same patch in closure vs IR mode produces same runtime behavior
- [ ] `just check` passes

### Sprint 5 Scope
**This sprint delivers**: IR compiler supports transforms (closure/IR mode equivalence)
**Deferred**: Semantic validation (optional Sprint 6)

---

## Optional Sprint 6: Semantic Registry

### Deliverable 7: Numeric Semantics Registry
- [ ] `ValueSemantics.ts` created with semantic mappings
- [ ] All `Signal<phase>` and phase bus types mapped to `'phase'` semantic
- [ ] All phase-specific lenses declare `requiresSemantics: 'phase'`
- [ ] Semantic validator rejects phase lens on non-phase signal
- [ ] Semantic validator allows phase lens on `Signal<phase>` and `phaseA` bus
- [ ] No `semantics` field added to `TypeDesc`, `Slot`, or `Bus` (constraint 1.2 preserved)
- [ ] All existing tests pass
- [ ] Manual test: Apply `phaseOffset` to `Signal<float>` (rejected)
- [ ] Manual test: Apply `phaseOffset` to `Signal<phase>` (allowed)
- [ ] `just check` passes

### Sprint 6 Scope
**This sprint delivers**: Phase lens validation (prevents runtime semantic errors)
**Deferred**: None (completes all planned work)

---

## Overall Definition of Done (All Sprints Complete)

### Architecture (Required)
- [ ] One canonical transform abstraction exists (`src/editor/transforms/*`)
- [ ] Transform facade includes: types, normalize, catalog, validate, apply modules
- [ ] No adapter execution logic in compiler switch statements (registry is source of truth)
- [ ] Lens scope enforced consistently (wires not special-cased, all 4 scopes supported)
- [ ] Transform application centralized (one code path for all scopes)

### UI (Required)
- [ ] Lens lists and param schemas are registry-driven in UI (no duplicated hardcoded catalogs)
- [ ] Lens selector filters by scope and domain correctly
- [ ] Param editors render from `LensDef.params` schema dynamically
- [ ] All lens param binding types supported (default, literal, wire, bus)

### Compiler (Required)
- [ ] IR compiler supports transforms (closure vs IR mode behavior consistent)
- [ ] Cheap adapters compile to IR nodes
- [ ] Pure lenses compile to IR nodes
- [ ] Stateful/expensive transforms error clearly in IR mode (not silently ignored)
- [ ] Transform stacks thread through all 3 IR lowering passes (6, 7, 8)

### Testing (Required)
- [ ] `just check` passes without errors
- [ ] All existing tests pass (900+ tests)
- [ ] New tests for: normalization, catalog, adapter execution, lens scope, transform application, IR compilation
- [ ] Manual verification in `just dev` for all critical flows

### Manual Verification Flows (Required - All Must Pass)
**Wire transforms**:
- [ ] Create wire with adapter → compiles correctly
- [ ] Create wire with lens → applies correctly
- [ ] Edit lens params → changes persist
- [ ] Wire in IR mode → same behavior as closure mode



**Lens param bindings**:
- [ ] Lens param with wire binding + adapter chain → resolves correctly
- [ ] Lens param with bus binding + lens stack → resolves correctly
- [ ] Recursive lens param bindings → depth limit enforced (max 3 levels)
- [ ] Lens param cycles → detected and rejected

**UI flows**:
- [ ] Open lens selector for wire → shows wire-compatible lenses only
- [ ] Add lens via UI → appears in inspector, persists in patch
- [ ] Edit lens params via UI → changes applied, compile succeeds
- [ ] Reorder lenses via drag-drop → order persists, affects compilation
- [ ] Disable lens via toggle → skipped during compilation
- [ ] Remove lens via UI → removed from patch

**IR mode consistency**:
- [ ] Patch with cheap adapters → compiles in both modes, same output
- [ ] Patch with pure lenses → compiles in both modes, same output
- [ ] Patch with stateful lens → closure mode works, IR mode errors clearly
- [ ] IR error messages explain what's unsupported and suggest alternatives

### Optional Enhancements (Nice-to-Have)
- [ ] Transform chain editor UI shared across Connection/Bus inspectors
- [ ] Numeric semantics registry for phase lens validation (Sprint 6)
- [ ] Performance optimizations for transform stack evaluation
- [ ] Plugin system for custom adapters/lenses

---

## Regression Prevention

### Data Integrity
- [ ] Load existing patches with transforms → work identically before/after refactor
- [ ] Disabled transforms (enabled=false) → correctly skipped
- [ ] Empty transform stacks → no runtime errors
- [ ] Patches without transforms → unaffected by changes

### Compilation Correctness
- [ ] Bus compilation with field adapters → field materialization works
- [ ] Complex lens chains (3+ lenses) → applied in correct order
- [ ] Adapter chain followed by lens stack → both applied correctly
- [ ] Lens param bindings with transforms → resolve recursively

### UI Stability
- [ ] Adapter suggestions in modulation table → consistent across scopes
- [ ] Lens options match registry exactly (no hardcoded lists)
- [ ] Adding lens to registry → immediately available in UI without code change
- [ ] Param schema changes in registry → UI updates automatically

---

## Acceptance Sign-Off Checklist

**Before marking Sprint 1 complete**:
- [ ] Transform facade modules exist and tested
- [ ] Adapter execution unified under registry
- [ ] All Sprint 1 acceptance criteria passed
- [ ] Code reviewed for constraint violations (§1.1-1.4)

**Before marking Sprint 2 complete**:
- [ ] Lens scope includes all 4 binding types
- [ ] All 27 lenses have explicit scope declarations
- [ ] Scope validation integrated into compiler
- [ ] All Sprint 2 acceptance criteria passed

**Before marking Sprint 3 complete**:
- [ ] Transform application centralized in facade
- [ ] All compiler call sites use explicit scope
- [ ] Lens param resolution uses transform engine
- [ ] All Sprint 3 acceptance criteria passed

**Before marking Sprint 4 complete**:
- [ ] Lens UI located or created
- [ ] UI uses registry for all lens metadata
- [ ] All lens editing flows work correctly
- [ ] All Sprint 4 acceptance criteria passed

**Before marking Sprint 5 complete**:
- [ ] IR passes support transforms
- [ ] Closure vs IR mode behavior consistent
- [ ] Unsupported transforms error clearly
- [ ] All Sprint 5 acceptance criteria passed

**Before marking Sprint 6 complete** (if executed):
- [ ] Semantic registry created
- [ ] Phase lenses validated by semantics
- [ ] No generic type pollution (constraint 1.2)
- [ ] All Sprint 6 acceptance criteria passed

**Before marking entire project complete**:
- [ ] All required sprints (1-5) complete
- [ ] All overall acceptance criteria passed
- [ ] All manual verification flows passed
- [ ] All regression checks passed
- [ ] Documentation updated (if needed)
- [ ] No outstanding blockers or critical bugs

---

## Final Verification Command Sequence

Run these commands in order before sign-off:

```bash
# 1. Type check
just typecheck

# 2. Lint
just lint-fix

# 3. Test suite
just test

# 4. Full check
just check

# 5. Dev server (manual testing)
just dev
# → Perform all manual verification flows documented above

# 6. Build production
just build
```

**All must pass with no errors.**

---

## Metrics for Success

**Code Quality**:
- Lines removed: ~400+ (switch statements, duplicate UI code, local transform functions)
- Lines added: ~800-1000 (transform facade, IR support, registry extensions)
- Net reduction in complexity: Centralized logic, fewer code paths

**Maintainability**:
- Adapters: 1 place to modify (registry) instead of 2 (registry + switch)
- Lenses: 1 place to modify (registry) instead of 3 (registry + 2 UI components)
- Scopes: 1 validator instead of 4 scattered checks

**Consistency**:
- IR vs closure mode: Same semantics (or explicit error)
- UI vs runtime: Same lens metadata source (registry)

**Extensibility**:
- Adding new adapter: 1 file modified (registry)
- Adding new lens: 1 file modified (registry)
- UI updates automatically when registry changes
