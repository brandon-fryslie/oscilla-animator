# Definition of Done: Unify Bus.combineMode → Bus.combine (CombinePolicy)

**Generated**: 2026-01-01-052959
**Plan**: PLAN-2026-01-01-052959.md
**Source**: STATUS-2026-01-01-050000.md
**Topic**: multi-input-cleanup

---

## ⚠️ PREREQUISITE: User Confirmation Required

**BLOCKER**: This change contradicts the design specification and loses type safety.

**Required before proceeding**:
- [ ] User explicitly confirms intent to proceed despite design spec violation
- [ ] User acknowledges type safety will be lost (buses can accept invalid modes at compile-time)
- [ ] User acknowledges this adds validation complexity with no functional benefit

**See PLAN-2026-01-01-052959.md "Blockers and Questions" section for full context.**

---

## Acceptance Criteria

### P0: Fix Blocker

#### Unrelated Type Error in GridDomain.ts
- [ ] `just typecheck` passes without GridDomain.ts error
- [ ] Tests can run

---

### P0: Type Definitions

#### Update Bus Interface to Use CombinePolicy
- [ ] Bus interface has `combine: CombinePolicy` field (not combineMode)
- [ ] BusCombineMode type still exported for validation use
- [ ] TypeScript compilation succeeds for types.ts
- [ ] All imports of Bus type fail as expected (will fix in next tasks)

---

### P0: Core Bus Store

#### Update BusStore to Use CombinePolicy
- [ ] Default bus definitions use `combine: { when: 'multi', mode: 'sum' }` format
- [ ] createBus() accepts `combine: CombinePolicy` parameter
- [ ] updateBus() handles `combine` field (not combineMode)
- [ ] BusStore internal methods unwrap `combine.mode` when needed
- [ ] TypeScript compilation succeeds for BusStore.ts

---

### P1: Compiler Passes

#### Update pass7-bus-lowering to Read bus.combine.mode
- [ ] Pass 7 reads `bus.combine.mode` instead of `bus.combineMode`
- [ ] Bus combine logic still works correctly
- [ ] TypeScript compilation succeeds
- [ ] Existing bus lowering tests pass (will need bus creation updates)

#### Update compileBusAware to Read bus.combine.mode
- [ ] All 5 references to `bus.combineMode` changed to `bus.combine.mode`
- [ ] Bus compilation logic unchanged
- [ ] TypeScript compilation succeeds
- [ ] Legacy compile path still works

#### Update combine-utils to Accept CombinePolicy or BusCombineMode
- [ ] Combine utilities accept `CombinePolicy | BusCombineMode`
- [ ] Utilities extract `mode` from CombinePolicy when needed
- [ ] Combine logic remains unchanged
- [ ] TypeScript compilation succeeds
- [ ] All combine utility tests pass

---

### P1: Semantic Validation

#### Update Bus Semantic Contracts
- [ ] Bus contracts validate `bus.combine` field (not combineMode)
- [ ] Contracts reject `{ when: 'always', ... }` for buses (compile error)
- [ ] Contracts reject `{ mode: 'error' }` for buses (compile error)
- [ ] Contracts reject `{ mode: 'first' }` for buses (compile error)
- [ ] Valid bus policies still validate correctly
- [ ] TypeScript compilation succeeds
- [ ] Validation tests pass

#### Update Validator Bus Combine Mode Access
- [ ] All 3 references updated to `bus.combine.mode`
- [ ] Validation logic unchanged
- [ ] TypeScript compilation succeeds
- [ ] Validator tests pass

---

### P1: Transaction System

#### Update Transaction Builder Bus Operations
- [ ] createBus() accepts `combine: CombinePolicy` parameter
- [ ] updateBus() handles `combine` field changes
- [ ] Transaction operation types updated
- [ ] TypeScript compilation succeeds
- [ ] Transaction tests pass

---

### P2: UI Components

#### Update BusInspector to Edit bus.combine
- [ ] UI displays `bus.combine.mode` (unwrap from policy)
- [ ] Dropdown only shows valid bus combine modes (no 'error', no 'first')
- [ ] When updating, wrap in `{ when: 'multi', mode: selectedMode }`
- [ ] UI correctly updates bus combine mode
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test confirms dropdown works

#### Update BusChannel to Display bus.combine
- [ ] BusChannel displays `bus.combine.mode`
- [ ] Display logic unchanged (read-only view)
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test confirms display works

#### Update BusCreationDialog to Use CombinePolicy
- [ ] Import CombinePolicy type (not just BusCombineMode)
- [ ] Default bus types use `combine: { when: 'multi', mode: ... }` format
- [ ] State manages CombinePolicy (or just mode + wrap on create)
- [ ] Creation wraps selected mode in `{ when: 'multi', mode: selectedMode }`
- [ ] Dropdown filters out 'error' and 'first' modes
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test: create bus with each valid mode

---

### P2: Tests

#### Update All Bus Creation in Tests
- [ ] All bus creation in tests uses CombinePolicy format
- [ ] All bus combine mode assertions updated to `bus.combine.mode`
- [ ] All tests pass with new format
- [ ] No tests skipped or disabled
- [ ] Test coverage unchanged (same assertions, new syntax)

#### Add Bus Policy Validation Tests
- [ ] Test: Bus creation rejects `{ when: 'always', mode: 'sum' }` with clear error
- [ ] Test: Bus creation rejects `{ when: 'multi', mode: 'error' }` with clear error
- [ ] Test: Bus creation rejects `{ when: 'multi', mode: 'first' }` with clear error
- [ ] Test: Valid policies still accepted (`{ when: 'multi', mode: 'sum' }`, etc.)
- [ ] Tests verify error messages are actionable
- [ ] All new tests pass

---

### P3: Documentation

#### Update Bus Policy Documentation
- [ ] All JSDoc comments updated to reference `bus.combine`
- [ ] Code comments referencing combineMode updated
- [ ] README or architecture docs updated if they mention bus combine modes
- [ ] No references to deprecated `Bus.combineMode` field remain

---

## Sprint Scope

**This sprint delivers** (if user confirms to proceed):
1. Bus interface using CombinePolicy (same as Slot)
2. All compiler passes reading bus.combine.mode
3. Comprehensive validation rejecting invalid bus policies
4. UI components editing/displaying bus.combine
5. Full test suite updated and passing
6. Documentation updated

**Deferred**: None - this is a complete migration

---

## Final Completion Checklist

**All tasks complete**:
- [ ] All ~35 files updated
- [ ] `just typecheck` passes
- [ ] `just test` passes (all tests)
- [ ] `just lint-fix` passes
- [ ] Manual UI test: Create bus with each mode (sum, average, max, min, last, layer)
- [ ] Manual UI test: Edit existing bus combine mode
- [ ] Semantic validator rejects invalid bus policies
- [ ] No references to `Bus.combineMode` remain (except in comments explaining change)

**Quality gates**:
- [ ] No test coverage loss
- [ ] No new TypeScript errors
- [ ] No new ESLint errors
- [ ] All bus policy validation tests pass
- [ ] UI still responsive and correct

---

## Sprint Success Definition

**Sprint is complete when**:
1. Bus uses `combine: CombinePolicy` throughout the codebase
2. All compiler passes, validation, and UI work with new structure
3. Invalid bus policies are rejected with clear error messages
4. All tests pass
5. No references to old `Bus.combineMode` field remain

**Sprint is successful when**:
1. All acceptance criteria above are met
2. System behaves identically to before (except new validation)
3. TypeScript compilation enforces... wait, no it doesn't anymore (type safety lost)
4. User confirms the change meets their needs

---

## Notes

- **Estimated effort**: 4-6 hours (~35 files, ~80-100 lines)
- **Risk level**: HIGH (design spec violation, type safety loss)
- **Breaking change**: Yes - all bus creation code must be updated
- **Reversible**: Yes - can revert in 1-2 hours if needed

**See PLAN-2026-01-01-052959.md for detailed implementation guidance.**
