# Definition of Done: Bus System Execution (Sprint 19)
**Generated**: 2025-12-31-014721
**Plan**: PLAN-20251231-014721.md
**Status**: STATUS-20251231.md

---

## Sprint Scope
This sprint delivers:
1. **P0 - Bus Roots Threading**: Fix critical infrastructure - busRoots in IRBuilder and BuilderProgramIR, StepBusEval emission
2. **P1 - Non-numeric Bus Safety**: Compile-time errors for unsupported vec2/vec3/color buses
3. **P2 - End-to-end Bus Execution Tests**: Integration tests verifying IR bus execution

Deferred:
- Non-numeric bus combine implementation (needs spec clarification)
- Field buses execution step (complex, future sprint)
- Event bus schedule emission (future sprint)

---

## Acceptance Criteria

### P0 - Bus Roots Threading (CRITICAL)

**Goal**: Fix data flow gap - add busRoots to IRBuilder and BuilderProgramIR, emit StepBusEval in schedule

- [ ] BuilderProgramIR interface has `busRoots: readonly [BusIndex, ValueRefPacked][]` field
- [ ] IRBuilderImpl has `registerBusRoot(busIndex: BusIndex, ref: ValueRefPacked)` method
- [ ] Pass7 calls `builder.registerBusRoot()` for each bus combine node created
- [ ] IRBuilderImpl.build() includes `busRoots: Array.from(this.busRoots.entries())` in output
- [ ] buildSchedule emits StepBusEval for each busRoot BEFORE signal evaluation steps

**Files Modified**:
- `src/editor/compiler/ir/builderTypes.ts`
- `src/editor/compiler/ir/IRBuilderImpl.ts`
- `src/editor/compiler/passes/pass7-bus-lowering.ts`
- `src/editor/compiler/ir/buildSchedule.ts`

---

### P1 - Non-numeric Bus Safety

**Goal**: Emit compile-time errors for unsupported non-numeric bus configurations

- [ ] Add compile-time validation in busContracts or semantic layer that checks bus TypeDesc.domain
- [ ] Emit clear error message: "Non-numeric buses (vec2/vec3/color) not yet supported in IR mode. Bus '{busId}' has type '{domain}'"
- [ ] Error references the relevant bus and type in the message
- [ ] Test that creates vec2 bus and verifies compile error is emitted
- [ ] Test that creates color bus and verifies compile error is emitted

**Files Modified**:
- `src/editor/semantic/busContracts.ts`
- `src/editor/semantic/__tests__/busContracts.test.ts`

---

### P2 - End-to-end Bus Execution Tests

**Goal**: Add integration tests verifying bus evaluation works in IR mode

- [ ] Test compiles patch to IR mode (not closure)
- [ ] Test verifies schedule.steps includes StepBusEval for the bus
- [ ] Test runs schedule and verifies bus value in ValueStore matches published value

**Files Created**:
- `src/editor/compiler/__tests__/ir-bus-execution.test.ts`

---

## Completion Checklist

### Pre-Implementation
- [ ] Read all files in "Files Modified" sections
- [ ] Understand busRoots data flow: Pass7 → Pass8 → IRBuilder → BuilderProgramIR → buildSchedule
- [ ] Review StepBusEval type definition (schedule.ts:268-288)
- [ ] Review executeBusEval runtime (executeBusEval.ts:42-179)

### During Implementation
- [ ] P0: Add busRoots to BuilderProgramIR interface
- [ ] P0: Add registerBusRoot() method to IRBuilderImpl
- [ ] P0: Call registerBusRoot() in Pass7 for each bus
- [ ] P0: Include busRoots in IRBuilderImpl.build() output
- [ ] P0: Emit StepBusEval in buildSchedule before signal steps
- [ ] P1: Add type validation in busContracts
- [ ] P1: Write error message with bus ID and type domain
- [ ] P1: Add tests for vec2/color bus errors
- [ ] P2: Create ir-bus-execution.test.ts
- [ ] P2: Test schedule emission (verify StepBusEval present)
- [ ] P2: Test runtime evaluation (verify bus value correct)

### Post-Implementation
- [ ] `just check` passes (2646+ tests pass, 0 new failures)
- [ ] `pnpm typecheck` passes (no type errors)
- [ ] Manual test: Create patch with bus in dev server, verify bus value updates
- [ ] Schedule inspection: Verify StepBusEval appears before StepSignalEval in schedule
- [ ] Runtime test: Verify executeBusEval is actually called during schedule execution
- [ ] Error test: Create vec2 bus, verify compile error is clear and helpful
- [ ] Error test: Create color bus, verify compile error is clear and helpful

---

## Verification Steps

### P0 Verification
1. Create test patch with numeric bus (e.g., "last" combine mode)
2. Compile to IR mode
3. Inspect compiled.schedule.steps
4. Verify StepBusEval step exists for the bus
5. Verify StepBusEval appears BEFORE StepSignalEval
6. Run schedule, check ValueStore for bus value

### P1 Verification
1. Create patch with vec2 bus
2. Attempt to compile
3. Verify compile error is emitted (not runtime error)
4. Verify error message includes bus ID and type "vec2"
5. Repeat with color bus
6. Verify error message includes bus ID and type "color"

### P2 Verification
1. Run `just test-file src/editor/compiler/__tests__/ir-bus-execution.test.ts`
2. Verify all assertions pass
3. Verify test actually enables IR mode (not closure)
4. Verify test checks schedule.steps content
5. Verify test checks ValueStore contents

---

## Definition of Done

This sprint is DONE when:
1. ALL acceptance criteria are met (15 total items)
2. ALL completion checklist items are checked
3. ALL verification steps pass
4. `just check` passes with 2646+ tests passing
5. Manual testing confirms buses work in dev server
6. No regressions in legacy closure mode

This sprint is FAILED if:
- Buses still don't evaluate in IR mode after P0 complete
- Non-numeric buses crash runtime instead of compile error
- Tests pass but manual testing reveals buses don't work
- Existing tests regress

---

## Next Steps After Completion

After this sprint is DONE:
1. Create STATUS-<next-timestamp>.md documenting completion
2. Update bus execution percentage (20% → 60%+)
3. Plan Sprint 20: Non-numeric bus combine implementation
4. Plan Sprint 21: Field buses execution step
5. Consider: Event bus schedule emission (may bundle with Sprint 20)
