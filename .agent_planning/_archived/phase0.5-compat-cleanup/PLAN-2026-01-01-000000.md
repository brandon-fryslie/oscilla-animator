# Phase 0.5: Compatibility Layer Cleanup

**Generated**: 2026-01-01-000000
**Status Source**: STATUS-2026-01-01.md
**Spec Reference**: Phase 0 Architecture Refactoring (Sprints 1-4)
**Priority**: P1 (High - Tech Debt Reduction)
**Estimated Effort**: 3-5 weeks (sequential) or 6-8 weeks (incremental)

---

## Executive Summary

Phase 0 Architecture Refactoring successfully unified the codebase around Edge types, default sources, V2 adapter, and TransformRegistry. However, backward compatibility layers were maintained throughout, creating:

- **7 categories of legacy code** requiring removal
- **~15-20% maintenance overhead** from dual-path execution
- **200+ usages** of deprecated types across the codebase
- **2796/2814 tests passing** (18 pre-existing failures unrelated to cleanup)

This plan provides a phased approach to safely remove compatibility shims while maintaining test coverage and ensuring zero regressions.

**Critical Finding**: The system is fully functional with Phase 0 changes. This cleanup is **technical debt reduction**, not bug fixing. The work can proceed incrementally without blocking other features.

---

## Current State vs. Target State

### Current State
- ✅ Edge type defined and working
- ✅ Default sources materialized in Pass 0
- ✅ V2 adapter integrated
- ✅ TransformRegistry created with all transforms migrated
- ⚠️ Dual-path execution in compiler (edges + legacy arrays)
- ⚠️ Migration helpers (edgeMigration.ts) still required
- ⚠️ Legacy transform storage (lensStack/adapterChain) instead of unified transforms
- ⚠️ Old registries (LensRegistry, AdapterRegistry) not fully replaced

### Target State
- ✓ Edges array is **authoritative** in Patch interface
- ✓ Compiler passes use **edges exclusively** (no dual paths)
- ✓ Migration helper code **deleted**
- ✓ Edge uses unified **transforms array** (not lensStack/adapterChain)
- ✓ Compiler uses **TRANSFORM_REGISTRY** exclusively
- ✓ Old registries **deleted**

---

## Migration Strategy

### Approach: Incremental with Safety Gates

**Why Incremental?**
- Lower risk of breaking production patches
- Easier to isolate and debug issues
- Can ship partial progress
- Allows time for comprehensive testing

**Safety Gates:**
1. All tests must pass after each phase
2. Golden patch compilation verified
3. No performance regressions (±5% tolerance)
4. Manual testing with Chrome DevTools MCP

---

## Sprint Organization

This plan is organized into **5 sequential sprints** + **2 parallel tracks**:

### Critical Path (Sequential - Must Complete in Order)

**Sprint 1**: Make Edges Authoritative (1-2 weeks)
**Sprint 2**: Compiler Edges-Only Execution (1 week)
**Sprint 3**: Remove Migration Helpers (1 day)
**Sprint 4**: Clean Type Definitions & Patch Interface (1 day)
**Sprint 5**: Remove PatchStore Legacy Arrays (2-3 days)

### Parallel Tracks (Can Start Anytime)

**Track A**: Transform Storage Unification (1 week)
**Track B**: Registry Cleanup (2-3 days)

---

## Sprint 1: Make Edges Authoritative

**Priority**: P0 (Critical)
**Effort**: 1-2 weeks
**Dependencies**: None
**Status Reference**: STATUS-2026-01-01.md Category 5 (lines 305-363)

### Sprint Goal

Make the `edges` array the single source of truth for all connection data, while maintaining backward compatibility during the transition.

### Work Items

#### 1.1: Add Patch Migration on Load

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: None
**Spec Reference**: STATUS lines 777-781

##### Description


##### Acceptance Criteria

- [ ] Migration function `migratePatchToEdges(patch: Patch): Patch` created
- [ ] Detects patches with empty/missing `edges` array
- [ ] Preserves all edge metadata (weight, sortKey, enabled, transforms)
- [ ] Handles patches that already have edges (no-op)
- [ ] Called automatically when loading patches from storage
- [ ] Unit tests verify roundtrip conversion (legacy → edges → legacy)
- [ ] Integration test loads old patch format and verifies compilation succeeds

##### Technical Notes

```typescript
function migratePatchToEdges(patch: Patch): Patch {
  // Already migrated?
  if (patch.edges && patch.edges.length > 0) {
    return patch;
  }

  // Convert legacy arrays to edges
  const edges = [
    ...patch.connections.map(connectionToEdge),
  ];

  return {
    ...patch,
    edges,
    // Keep legacy arrays for now (will be removed in Sprint 4)
    connections: patch.connections,
  };
}
```

---

#### 1.2: Make Edges Required in Patch Type

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: 1.1
**Spec Reference**: STATUS lines 842-872

##### Description

Update the Patch interface to make `edges: Edge[]` required (remove the `?` suffix). This forces all code to handle edges and makes the type system enforce the new standard.

##### Acceptance Criteria

- [ ] Patch interface updated: `edges: Edge[]` (not `edges?: Edge[]`)
- [ ] All Patch creation sites provide edges array (may be empty for fresh patches)
- [ ] TypeScript compilation succeeds with no errors
- [ ] PatchStore.edges initialized to `[]` by default
- [ ] All tests pass with required edges field
- [ ] No runtime errors from missing edges property

##### Technical Notes

```typescript
// Before
export interface Patch {
  edges?: Edge[];
  connections: Connection[];
  // ...
}

// After
export interface Patch {
  edges: Edge[];  // Required, authoritative
  connections: Connection[];  // Still present, will be removed in Sprint 4
  // ...
}
```

---

#### 1.3: Update PatchStore to Always Populate Edges

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: 1.2
**Spec Reference**: STATUS lines 366-421

##### Description

Ensure all PatchStore mutation methods (add/remove/update) maintain the edges array alongside legacy arrays. This creates a transition period where both representations are kept in sync.

##### Acceptance Criteria

- [ ] `addConnection()` also adds equivalent edge via `addEdge()`
- [ ] `removeConnection()` also removes equivalent edge
- [ ] Edge mutations trigger UI updates (MobX reactivity preserved)
- [ ] All PatchStore tests pass
- [ ] No duplicate edges created from dual writes

##### Technical Notes

```typescript
class PatchStore {
  @action addConnection(conn: Connection): void {
    // Legacy path
    this.connections.push(conn);

    // New path (keep in sync)
    const edge = connectionToEdge(conn);
    this.addEdge(edge);
  }

  @action addEdge(edge: Edge): void {
    validateEdge(edge);

    // Prevent duplicates
    const existing = this.edges.find(e => e.id === edge.id);
    if (existing) return;

    this.edges.push(edge);
  }
}
```

---

#### 1.4: Update Transaction Ops for Edges

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: 1.3
**Spec Reference**: STATUS lines 657-663

##### Description

Audit and update all transaction operations (undo/redo) to work with Edge types. This ensures the transaction system remains functional during the migration.

##### Acceptance Criteria

- [ ] All `ops.ts` functions handle Edge type
- [ ] Undo/redo works for edge creation
- [ ] Undo/redo works for edge deletion
- [ ] Undo/redo works for edge modification (enabled, weight)
- [ ] Transaction history tests pass
- [ ] No memory leaks in transaction stack
- [ ] Kernel ops in `src/editor/kernel/ops.ts` verified to work with edges

##### Technical Notes

```typescript
// Example transaction op
export function addEdgeOp(edge: Edge): Operation {
  return {
    name: 'addEdge',
    do: (store: PatchStore) => store.addEdge(edge),
    undo: (store: PatchStore) => store.removeEdge(edge.id),
    description: `Add edge ${edge.id}`
  };
}
```

---

#### 1.5: Add Validation Tests

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: 1.4
**Spec Reference**: STATUS lines 46-65

##### Description

Create tests that validate the edges-authoritative behavior and catch regressions during migration.

##### Acceptance Criteria

- [ ] Test: Patch with edges-only (no legacy arrays) compiles successfully
- [ ] Test: Warning emitted if edges is empty but connections are filled
- [ ] Test: Migration converts all legacy edge types correctly
- [ ] Test: Dual-write maintains consistency between edges and legacy arrays
- [ ] Test: Golden patch compilation with edges-only format
- [ ] All new tests pass

##### Technical Notes

```typescript
describe('Edges authoritative validation', () => {
  it('compiles patch with edges-only format', () => {
    const patch: Patch = {
      version: 1,
      blocks: [/* ... */],
      edges: [
        { id: 'e1', from: port('a', 'out'), to: port('b', 'in'), enabled: true }
      ],
      connections: [],  // Empty legacy arrays
      buses: []
    };

    const result = compile(patch);
    expect(result.errors).toHaveLength(0);
  });
});
```

---

### Sprint 1 Success Criteria

- [ ] All patches loaded through the system have edges populated
- [ ] PatchStore maintains edges array in sync with legacy arrays
- [ ] Transaction system works with Edge type
- [ ] 2796+ tests passing (no regressions)
- [ ] Golden patch compiles with edges-only format
- [ ] Documentation updated with migration notes

---

## Sprint 2: Compiler Edges-Only Execution

**Priority**: P0 (Critical)
**Effort**: 1 week
**Dependencies**: Sprint 1 complete
**Status Reference**: STATUS-2026-01-01.md Category 3 (lines 152-248)

### Sprint Goal

Remove all dual-path execution from compiler passes, making them use edges exclusively. This eliminates ~15% code complexity overhead.

### Work Items

#### 2.1: Update Pass 1 (Normalize) to Edges-Only

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: Sprint 1
**Spec Reference**: STATUS lines 156-199

##### Description

Remove the dual-format handling in pass1-normalize.ts that supports both edges and legacy arrays. Use edges exclusively.

##### Acceptance Criteria

- [ ] Lines 99-122 (dual format handling) removed
- [ ] Lines 140-156 (dual connectivity checks) simplified to edges-only
- [ ] `convertFromEdges()` import removed
- [ ] Single edge-based connectivity check: `hasEdgeToInput(edges, blockId, inputId)`
- [ ] All Pass 1 tests pass
- [ ] Compile time for golden patch unchanged (±5%)

##### Technical Notes

```typescript
// REMOVE THIS (lines 99-122)
if (patch.edges !== undefined && patch.edges.length > 0) {
  // New format: patch has unified edges array
  const canonical = canonicalizeEdges(patch.edges);
  edges = [...canonical];

  // Also convert to legacy format for passes that haven't migrated yet
  const converted = convertFromEdges(patch.edges);
  connections = converted.connections;
} else {
  // Legacy format: patch has separate arrays
  connections = patch.connections ?? [];
  edges = undefined;
}

// REPLACE WITH THIS
const edges = canonicalizeEdges(patch.edges);
```

---

#### 2.2: Update Pass 2 (Type Checking) to Edges-Only

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: 2.1
**Spec Reference**: STATUS lines 202-215

##### Description

Remove legacy wire format handling and use unified edge iteration for type checking.

##### Acceptance Criteria

- [ ] Legacy wire format handling removed (line 460)
- [ ] All type error detection preserved
- [ ] Pass 2 tests updated and passing
- [ ] No new type errors on golden patch

##### Technical Notes

```typescript
// Unified type checking
for (const edge of patch.edges) {
  if (!edge.enabled) continue;

  const sourceType = getSourceType(edge.from);
  const targetType = getTargetType(edge.to);

  // Apply transform chain
  let currentType = sourceType;
  for (const transform of edge.transforms ?? []) {
    currentType = applyTransformType(currentType, transform);
  }

  // Validate compatibility
  if (!isCompatible(currentType, targetType)) {
    errors.push(typeError(edge, currentType, targetType));
  }
}
```

---

#### 2.3: Update Pass 7 (Bus Lowering) to Edges-Only

**Status**: Not Started
**Effort**: Medium (6-8 hours)
**Dependencies**: 2.2
**Spec Reference**: STATUS lines 218-246

##### Description


##### Acceptance Criteria

- [ ] Bus combine node creation unchanged
- [ ] All bus lowering tests pass
- [ ] Multi-bus patches compile correctly

##### Technical Notes

```typescript
// REMOVE dual-path (lines 164-177)
if (edges !== undefined && edges.length > 0) {
} else {
}

// REPLACE WITH
  .filter(e =>
    e.to.kind === 'bus' &&
    e.to.busId === bus.id &&
    e.enabled
  )
  .sort((a, b) => {
    if (a.weight !== b.weight) return (b.weight ?? 0) - (a.weight ?? 0);
    return (a.sortKey ?? 0) - (b.sortKey ?? 0);
  });
```

---

#### 2.4: Update Pass 8 (Link Resolution) Verification

**Status**: Not Started
**Effort**: Small (2-4 hours)
**Dependencies**: 2.3
**Spec Reference**: STATUS lines 239-247

##### Description

Verify that Pass 8 has no remaining legacy paths (already mostly cleaned up).

##### Acceptance Criteria

- [ ] Code audit confirms edges-only usage
- [ ] All link resolution tests pass
- [ ] No broken connections in compiled IR
- [ ] Fragment linking works for all edge types

##### Technical Notes

Pass 8 already has comments indicating cleanup (lines 194, 271, 717). This is primarily verification work.

---

#### 2.5: Remove Legacy Arrays from NormalizedPatch

**Status**: Not Started
**Effort**: Small (2-4 hours)
**Dependencies**: 2.4
**Spec Reference**: STATUS lines 782-792

##### Description

Clean up the intermediate representation to remove legacy connection arrays, using edges exclusively.

##### Acceptance Criteria

- [ ] `NormalizedPatch` interface has only `edges: Edge[]`
- [ ] All compiler passes compile without errors
- [ ] IR serialization/deserialization works
- [ ] No test failures from IR changes

##### Technical Notes

```typescript
// src/editor/compiler/ir/patches.ts
export interface NormalizedPatch {
  blocks: NormalizedBlock[];
  edges: Edge[];  // Only edges
  buses: Bus[];
}
```

---

### Sprint 2 Success Criteria

- [ ] Zero dual-path execution in compiler passes
- [ ] All passes use edges exclusively
- [ ] NormalizedPatch has no legacy arrays
- [ ] 2796+ tests passing (no regressions)
- [ ] Compile time unchanged (±5%)
- [ ] Golden patch compiles correctly

---

## Sprint 3: Remove Migration Helpers

**Priority**: P1 (High)
**Effort**: 1 day
**Dependencies**: Sprint 2 complete
**Status Reference**: STATUS-2026-01-01.md Category 2 (lines 121-149)

### Sprint Goal

Delete the bidirectional migration helper code that is no longer needed after compiler passes use edges exclusively.

### Work Items

#### 3.1: Audit Migration Helper Usage

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: Sprint 2
**Spec Reference**: STATUS lines 139-147

##### Description

Verify that no production code (outside tests) imports from edgeMigration.ts.

##### Acceptance Criteria

- [ ] Grep confirms no imports of `convertFromEdges` (except tests)
- [ ] Grep confirms no imports of `convertToEdges` (except tests)
- [ ] Grep confirms no imports of migration helper functions
- [ ] All identified imports are in test files or migration-on-load code
- [ ] Safe-to-delete confirmation documented

##### Technical Notes

```bash
# Search for imports
rg "from.*edgeMigration" --type ts
rg "convertFromEdges|convertToEdges" --type ts
```

---

#### 3.2: Delete Migration Helper Module

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: 3.1
**Spec Reference**: STATUS lines 122-149

##### Description

Delete the edgeMigration.ts file and its test suite, as they are no longer needed.

##### Acceptance Criteria

- [ ] File deleted: `src/editor/edgeMigration.ts` (315 lines)
- [ ] File deleted: `src/editor/__tests__/edgeMigration.test.ts`
- [ ] TypeScript compilation succeeds
- [ ] All remaining tests pass
- [ ] No broken imports
- [ ] Git history preserves deleted code for future reference

##### Technical Notes

Keep migration-on-load code (`migratePatchToEdges` from Sprint 1) for backward compatibility. Only delete the bidirectional helpers used during dual-path execution.

---

### Sprint 3 Success Criteria

- [ ] edgeMigration.ts deleted
- [ ] No imports of deleted module
- [ ] 2796+ tests passing
- [ ] Codebase ~315 lines smaller

---

## Sprint 4: Clean Type Definitions & Patch Interface

**Priority**: P1 (High)
**Effort**: 1 day
**Dependencies**: Sprint 3 complete
**Status Reference**: STATUS-2026-01-01.md Category 1 & 5

### Sprint Goal


### Work Items

#### 4.1: Remove Deprecated Type Definitions

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: Sprint 3
**Spec Reference**: STATUS lines 69-118

##### Description


##### Acceptance Criteria

- [ ] `Connection` interface removed (lines 744-779)
- [ ] TypeScript compilation attempted (will have errors - expected)
- [ ] All compile errors documented for fixing in 4.2
- [ ] No test files directly reference deleted types

##### Technical Notes

This will break compilation. That's expected. Sprint 4.2 fixes the errors.

---

#### 4.2: Remove Legacy Arrays from Patch Interface

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: 4.1
**Spec Reference**: STATUS lines 305-363

##### Description


##### Acceptance Criteria

- [ ] Patch interface updated: remove `defaultSources`, `defaultSourceAttachments`
- [ ] `edges: Edge[]` is the only connection field
- [ ] Patch version bumped (e.g., version: 2)
- [ ] Migration-on-load code handles old version gracefully
- [ ] TypeScript compilation succeeds
- [ ] All tests pass

##### Technical Notes

```typescript
// Before (version 1)
export interface Patch {
  readonly version: number;
  blocks: Block[];
  edges: Edge[];
  connections: Connection[];  // REMOVE
  buses: Bus[];
  defaultSources: DefaultSourceState[];  // REMOVE
  defaultSourceAttachments?: DefaultSourceAttachment[];  // REMOVE
}

// After (version 2)
export interface Patch {
  readonly version: 2;
  blocks: Block[];
  edges: Edge[];
  buses: Bus[];
  // All legacy fields removed
}
```

---

#### 4.3: Fix Remaining Compile Errors

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: 4.2
**Spec Reference**: STATUS lines 774-807

##### Description

Fix any remaining TypeScript errors from removing deprecated types.

##### Acceptance Criteria

- [ ] Zero TypeScript errors
- [ ] All affected files updated
- [ ] No `@ts-ignore` or `@ts-expect-error` added (fix properly)
- [ ] All tests pass
- [ ] No runtime errors in dev server

##### Technical Notes

Most errors should be caught by previous sprints. This is cleanup of any stragglers.

---

### Sprint 4 Success Criteria

- [ ] Patch interface has no legacy arrays
- [ ] Patch version bumped to 2
- [ ] Zero TypeScript errors
- [ ] 2796+ tests passing
- [ ] Migration-on-load handles version 1 patches

---

## Sprint 5: Remove PatchStore Legacy Arrays

**Priority**: P1 (High)
**Effort**: 2-3 days
**Dependencies**: Sprint 4 complete
**Status Reference**: STATUS-2026-01-01.md Category 6 (lines 365-421)

### Sprint Goal

Remove legacy connection arrays from PatchStore, completing the migration to edges-only.

### Work Items

#### 5.1: Remove Legacy Observables

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: Sprint 4
**Spec Reference**: STATUS lines 369-404

##### Description


##### Acceptance Criteria

- [ ] `connections: Connection[]` observable removed
- [ ] MobX makeObservable config updated
- [ ] TypeScript compilation succeeds

##### Technical Notes

```typescript
// Keep these computed getters (they filter the edges array)
@computed get wireEdges(): Edge[] {
  return this.edges.filter(e =>
    e.from.kind === 'port' && e.to.kind === 'port'
  );
}

  return this.edges.filter(e =>
    e.from.kind === 'port' && e.to.kind === 'bus'
  );
}

  return this.edges.filter(e =>
    e.from.kind === 'bus' && e.to.kind === 'port'
  );
}
```

---

#### 5.2: Remove Legacy Mutation Methods

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: 5.1
**Spec Reference**: STATUS lines 405-417

##### Description


##### Acceptance Criteria

- [ ] `addConnection()` method removed
- [ ] `removeConnection()` method removed
- [ ] `updateConnection()` method removed
- [ ] All method calls replaced with `addEdge()`/`removeEdge()`/`updateEdge()`
- [ ] UI components updated to use edge methods
- [ ] All tests pass

##### Technical Notes

Search for all calls to removed methods and replace:
```typescript
// Before
patchStore.addConnection({ id: 'c1', from: portA, to: portB });

// After
patchStore.addEdge({
  id: 'e1',
  from: { kind: 'port', blockId: 'a', slotId: 'out' },
  to: { kind: 'port', blockId: 'b', slotId: 'in' },
  enabled: true
});
```

---

#### 5.3: Update UI Components

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: 5.2
**Spec Reference**: STATUS lines 674-681

##### Description

Update Canvas and Inspector components to work exclusively with edges.

##### Acceptance Criteria

- [ ] Canvas connection rendering uses edges
- [ ] Inspector edge editor uses edges
- [ ] UI tests pass
- [ ] Manual testing confirms no visual regressions
- [ ] Connection creation/deletion works in dev server

##### Technical Notes

Verify with Chrome DevTools MCP that UI is functional:
1. Create a wire edge (port → port)
4. Delete an edge
5. Modify edge properties (weight, enabled)

---

### Sprint 5 Success Criteria

- [ ] PatchStore has no legacy arrays
- [ ] All mutation methods use edges
- [ ] UI components work with edges
- [ ] 2796+ tests passing
- [ ] Dev server fully functional
- [ ] No MobX reactivity issues

---

## Track A: Transform Storage Unification (Parallel)

**Priority**: P2 (Medium)
**Effort**: 1 week
**Dependencies**: None (can start immediately)
**Status Reference**: STATUS-2026-01-01.md Category 4 (lines 250-303)

### Track Goal

Replace separate `lensStack` and `adapterChain` fields on Edge with unified `transforms: TransformStep[]` array.

### Work Items

#### A.1: Add Transforms Field to Edge Interface

**Status**: Not Started
**Effort**: Small (2-4 hours)
**Dependencies**: None
**Spec Reference**: STATUS lines 254-291

##### Description

Add the unified transforms field to Edge while keeping legacy fields during migration.

##### Acceptance Criteria

- [ ] Edge interface has `transforms?: TransformStep[]` field
- [ ] Legacy fields marked deprecated: `lensStack`, `adapterChain`
- [ ] TypeScript compilation succeeds
- [ ] No runtime changes yet (field is optional)
- [ ] TransformStep type already exists (confirmed at STATUS lines 286-291)

##### Technical Notes

```typescript
export interface Edge {
  readonly id: string;
  readonly from: Endpoint;
  readonly to: Endpoint;

  readonly transforms?: TransformStep[];  // NEW: unified transform array

  /** @deprecated Use transforms instead */
  readonly lensStack?: LensInstance[];

  /** @deprecated Use transforms instead */
  readonly adapterChain?: AdapterStep[];

  readonly enabled: boolean;
  readonly weight?: number;
  readonly sortKey?: number;
}
```

---

#### A.2: Write Transform Conversion Utility

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: A.1
**Spec Reference**: STATUS lines 295-301

##### Description

Create bidirectional converter between legacy transform storage and new unified format.

##### Acceptance Criteria

- [ ] Function: `convertLegacyTransforms(lensStack?, adapterChain?) → TransformStep[]`
- [ ] Function: `convertToLegacyTransforms(transforms) → { lensStack, adapterChain }`
- [ ] Preserves transform order and metadata
- [ ] Handles empty/undefined inputs
- [ ] 100% test coverage
- [ ] Roundtrip conversion verified: legacy → new → legacy

##### Technical Notes

```typescript
function convertLegacyTransforms(
  lensStack?: LensInstance[],
  adapterChain?: AdapterStep[]
): TransformStep[] {
  const transforms: TransformStep[] = [];

  // Lenses first (if present)
  for (const lens of lensStack ?? []) {
    transforms.push({
      kind: 'lens',
      enabled: true,  // Legacy lenses were always enabled
      lens
    });
  }

  // Then adapters (if present)
  for (const step of adapterChain ?? []) {
    transforms.push({
      kind: 'adapter',
      enabled: step.enabled ?? true,
      step
    });
  }

  return transforms;
}
```

---

#### A.3: Update Edge Creation to Populate Transforms

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: A.2
**Spec Reference**: STATUS lines 797-801

##### Description

Update all edge creation sites to populate the transforms field.

##### Acceptance Criteria

- [ ] All `addEdge()` calls populate transforms field
- [ ] All edge factory functions use transforms
- [ ] Legacy fields still populated during migration period
- [ ] No edges created with only legacy fields (transforms always present)
- [ ] Tests verify transforms field is populated

##### Technical Notes

Search for edge creation and update:
```bash
rg "addEdge|createEdge|connectionToEdge" --type ts
```

---

#### A.4: Update Compiler to Read Transforms Field

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: A.3
**Spec Reference**: STATUS lines 590-593

##### Description

Update compiler passes to read from transforms field instead of lensStack/adapterChain.

##### Acceptance Criteria

- [ ] Pass 2 (Type Checking) reads transforms field
- [ ] Pass 6 (Block Lowering) reads transforms field
- [ ] Pass 7 (Bus Lowering) reads transforms field
- [ ] Pass 8 (Link Resolution) reads transforms field
- [ ] Falls back to legacy fields if transforms is empty (during migration)
- [ ] All compiler tests pass

##### Technical Notes

```typescript
// Get transforms with fallback
function getTransforms(edge: Edge): TransformStep[] {
  // Prefer new format
  if (edge.transforms && edge.transforms.length > 0) {
    return edge.transforms;
  }

  // Fall back to legacy during migration
  return convertLegacyTransforms(edge.lensStack, edge.adapterChain);
}
```

---

#### A.5: Remove Legacy Transform Fields

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: A.4
**Spec Reference**: STATUS lines 295-303

##### Description

Remove lensStack and adapterChain fields from Edge interface after full migration.

##### Acceptance Criteria

- [ ] Edge interface: `lensStack` removed
- [ ] Edge interface: `adapterChain` removed
- [ ] Only `transforms: TransformStep[]` remains
- [ ] TypeScript compilation succeeds
- [ ] All tests pass
- [ ] No references to removed fields in codebase

##### Technical Notes

Final Edge interface:
```typescript
export interface Edge {
  readonly id: string;
  readonly from: Endpoint;
  readonly to: Endpoint;
  readonly transforms?: TransformStep[];  // Only unified field
  readonly enabled: boolean;
  readonly weight?: number;
  readonly sortKey?: number;
}
```

---

### Track A Success Criteria

- [ ] Edge uses unified transforms array
- [ ] Legacy lensStack/adapterChain removed
- [ ] All compiler passes use transforms
- [ ] 2796+ tests passing
- [ ] Transform metadata preserved

---

## Track B: Registry Cleanup (Parallel)

**Priority**: P2 (Medium)
**Effort**: 2-3 days
**Dependencies**: None (can start immediately)
**Status Reference**: STATUS-2026-01-01.md Category 7 (lines 422-461)

### Track Goal

Complete the migration to TRANSFORM_REGISTRY by updating the compiler and removing old LensRegistry/AdapterRegistry files.

### Work Items

#### B.1: Complete Sprint 4 Deliverable 3 (Compiler Registry Update)

**Status**: Not Started
**Effort**: Medium (1-2 days)
**Dependencies**: None
**Spec Reference**: STATUS lines 444-449, 802-806

##### Description

Update all compiler passes to use TRANSFORM_REGISTRY instead of old LensRegistry and AdapterRegistry.

##### Acceptance Criteria

- [ ] Pass 2 imports from TRANSFORM_REGISTRY
- [ ] Pass 6 imports from TRANSFORM_REGISTRY
- [ ] Pass 7 imports from TRANSFORM_REGISTRY
- [ ] Pass 8 imports from TRANSFORM_REGISTRY
- [ ] No imports from old registries in compiler code
- [ ] All compiler tests pass
- [ ] Transform lookups work correctly

##### Technical Notes

```typescript
// Before
import { LENS_REGISTRY } from '../lenses/LensRegistry';

const lensImpl = LENS_REGISTRY.get(lensName);

// After
import { TRANSFORM_REGISTRY } from '../transforms/TransformRegistry';

const transform = TRANSFORM_REGISTRY.getTransform(lensName);
const lensImpl = transform.kind === 'lens' ? transform.impl : null;
```

---

#### B.2: Update Non-Compiler Imports

**Status**: Not Started
**Effort**: Small (4-6 hours)
**Dependencies**: B.1
**Spec Reference**: STATUS lines 438-443

##### Description

Update remaining imports from old registries to new TRANSFORM_REGISTRY.

##### Acceptance Criteria

- [ ] `src/editor/transforms/catalog.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/compiler/ir/transforms.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/lenses/lensInstances.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/adapters/autoAdapter.ts` uses TRANSFORM_REGISTRY
- [ ] All imports from old registries removed
- [ ] TypeScript compilation succeeds

##### Technical Notes

Search and replace:
```bash
rg "from.*LensRegistry|from.*AdapterRegistry" --type ts
```

---

#### B.3: (Optional) Implement Facade Pattern

**Status**: Not Started
**Effort**: Small (2-4 hours)
**Dependencies**: B.2
**Spec Reference**: STATUS lines 450-459

##### Description

Optionally implement facade pattern in old registries to provide deprecation warnings.

##### Acceptance Criteria

- [ ] LensRegistry exports facade that delegates to TRANSFORM_REGISTRY
- [ ] AdapterRegistry exports facade that delegates to TRANSFORM_REGISTRY
- [ ] Console warnings emitted when using old registries
- [ ] Existing code continues to work (with warnings)
- [ ] Migration guide in CHANGELOG references warnings

##### Technical Notes

```typescript
// LensRegistry.ts facade
import { TRANSFORM_REGISTRY } from '../transforms/TransformRegistry';

export const LENS_REGISTRY = {
  get(name: string) {
    console.warn(
      `LENS_REGISTRY is deprecated. Use TRANSFORM_REGISTRY.getTransform('${name}') instead.`
    );
    const transform = TRANSFORM_REGISTRY.getTransform(name);
    return transform?.kind === 'lens' ? transform.impl : undefined;
  }
};
```

---

#### B.4: Delete Old Registry Files

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: B.3 (or B.2 if skipping facade)
**Spec Reference**: STATUS lines 422-461

##### Description

Delete the old LensRegistry and AdapterRegistry files after migration is complete.

##### Acceptance Criteria

- [ ] File deleted: `src/editor/lenses/LensRegistry.ts`
- [ ] File deleted: `src/editor/adapters/AdapterRegistry.ts`
- [ ] Migration files deleted: `src/editor/transforms/migrateLenses.ts`
- [ ] Migration files deleted: `src/editor/transforms/migrateAdapters.ts`
- [ ] TypeScript compilation succeeds
- [ ] All tests pass
- [ ] No broken imports

##### Technical Notes

Only delete after confirming no external code depends on old registries.

---

### Track B Success Criteria

- [ ] Compiler uses TRANSFORM_REGISTRY exclusively
- [ ] Old registries deleted
- [ ] Migration helpers deleted
- [ ] 2796+ tests passing
- [ ] No console warnings from deprecated registry usage

---

## Risk Assessment

### High-Risk Items

#### 1. Serialization Format Breaking Changes

**Impact**: Saved patches won't load after removing legacy arrays
**Probability**: High (this is a guaranteed breaking change)
**Mitigation**:
- Bump Patch.version to 2 when removing legacy arrays
- Implement robust migration-on-load (Sprint 1.1)
- Keep migration code for 2-3 releases before removal
- Add validation warnings for old patches
- Document migration path in CHANGELOG
- Test with diverse real-world patches

**Status Reference**: STATUS lines 649-656

---

#### 2. Transaction System Breakage

**Probability**: Medium (depends on transaction op implementation)
**Mitigation**:
- Comprehensive audit in Sprint 1.4
- Update all transaction ops to use Edge type
- Test undo/redo for all edge operations
- Verify kernel ops compatibility
- Test transaction history persistence

**Status Reference**: STATUS lines 657-663

---

#### 3. Compiler Regression During Dual-Path Removal

**Impact**: Subtle bugs when removing fallback logic
**Probability**: Medium (complex compiler logic)
**Mitigation**:
- Remove dual-path one pass at a time (Sprint 2)
- Run full test suite after each pass update
- Add golden patch compilation test
- Manual testing with Chrome DevTools MCP
- Performance benchmarking (±5% tolerance)

**Status Reference**: STATUS lines 665-672

---

### Medium-Risk Items

#### 1. UI Component Breakage

**Impact**: Inspector/Canvas stops working after PatchStore changes
**Probability**: Medium (many UI components)
**Mitigation**:
- Comprehensive audit of PatchStore consumers
- Update components incrementally (Sprint 5.3)
- Add UI tests for connection creation
- Manual testing in dev server
- Chrome DevTools MCP verification

**Status Reference**: STATUS lines 674-681

---

#### 2. Transform Migration Data Loss

**Impact**: Lens/adapter settings lost when migrating to transforms
**Probability**: Low (well-defined conversion)
**Mitigation**:
- Thorough converter with tests (Track A.2)
- Verify roundtrip conversion
- Keep legacy fields populated during migration
- Test with real-world transform chains
- Validate transform metadata preservation

**Status Reference**: STATUS lines 683-688

---

### Low-Risk Items

#### 1. Registry Facade Removal

**Impact**: External code breaks if using old imports
**Probability**: Low (mostly internal code)
**Mitigation**:
- Deprecation warnings (Track B.3)
- Optional facade pattern
- Gradual removal timeline
- Clear migration documentation

**Status Reference**: STATUS lines 690-693

---

## Completion Gates

### Minimum Viable Cleanup (Can Ship)

- [ ] Edges array is authoritative in all compiler passes (Sprint 2)
- [ ] No dual-path execution in Pass 1, 2, 7, 8 (Sprint 2)
- [ ] Sprint 4 Deliverable 3 complete: TRANSFORM_REGISTRY in use (Track B.1)
- [ ] Migration helpers can be safely removed (Sprint 3)

### Full Cleanup (Ideal State)

- [ ] Patch interface has no legacy arrays (Sprint 4)
- [ ] PatchStore has no legacy observables (Sprint 5)
- [ ] edgeMigration.ts deleted (Sprint 3)
- [ ] LensRegistry/AdapterRegistry deleted (Track B.4)
- [ ] Edge has transforms field (no lensStack/adapterChain) (Track A.5)

### Version Bump Required

**Yes** - Removing legacy arrays from Patch is a breaking change. Bump to version 2.

**Status Reference**: STATUS lines 713-731

---

## Testing Strategy

### Unit Tests

```typescript
// Edge-only compilation
describe('Edges authoritative', () => {
  it('compiles patch with edges-only', () => {
    const patch: Patch = {
      version: 2,
      blocks: [
        { id: 'osc', type: 'Oscillator', config: {} },
        { id: 'gain', type: 'Gain', config: {} }
      ],
      edges: [
        {
          id: 'e1',
          from: { kind: 'port', blockId: 'osc', slotId: 'out' },
          to: { kind: 'port', blockId: 'gain', slotId: 'in' },
          enabled: true
        }
      ],
      buses: []
    };

    const result = compile(patch);
    expect(result.errors).toHaveLength(0);
  });
});

// Transform migration
describe('Transform storage unification', () => {
  it('migrates lensStack + adapterChain to transforms', () => {
    const legacy = {
      lensStack: [{ lensId: 'mul', params: { factor: 2 } }],
      adapterChain: [{ adapterId: 'float-to-vec2', enabled: true }]
    };

    const transforms = convertLegacyTransforms(
      legacy.lensStack,
      legacy.adapterChain
    );

    expect(transforms).toHaveLength(2);
    expect(transforms[0]).toMatchObject({
      kind: 'lens',
      enabled: true,
      lens: { lensId: 'mul', params: { factor: 2 } }
    });
    expect(transforms[1]).toMatchObject({
      kind: 'adapter',
      enabled: true,
      step: { adapterId: 'float-to-vec2', enabled: true }
    });
  });
});
```

### Integration Tests

```typescript
// Transaction system with edges
describe('Transaction system', () => {
  it('undo/redo edge creation', () => {
    const store = new PatchStore();
    const edge: Edge = {
      id: 'e1',
      from: { kind: 'port', blockId: 'a', slotId: 'out' },
      to: { kind: 'port', blockId: 'b', slotId: 'in' },
      enabled: true
    };

    // Execute
    const op = addEdgeOp(edge);
    op.do(store);
    expect(store.edges).toContainEqual(edge);

    // Undo
    op.undo(store);
    expect(store.edges).not.toContainEqual(edge);

    // Redo
    op.do(store);
    expect(store.edges).toContainEqual(edge);
  });
});
```

### Golden Patch Tests

- [ ] Load all existing golden patches
- [ ] Verify migration to edges format
- [ ] Compile and verify IR output matches expected
- [ ] Run in player and verify no visual/audio regressions
- [ ] Performance benchmark: compile time within ±5%

---

## Dependencies and Sequencing

### Critical Path (Must Be Sequential)

```
Sprint 1: Edges Authoritative (1-2 weeks)
    ↓
Sprint 2: Compiler Edges-Only (1 week)
    ↓
Sprint 3: Remove Migration Helpers (1 day)
    ↓
Sprint 4: Clean Type Definitions (1 day)
    ↓
Sprint 5: PatchStore Cleanup (2-3 days)
```

**Total Sequential Time**: 3-4 weeks

### Parallel Tracks (Can Start Anytime)

```
Track A: Transform Unification (1 week)
    [Can run in parallel with Sprints 1-5]

Track B: Registry Cleanup (2-3 days)
    [Can run in parallel with Sprints 1-5]
```

### Optimal Schedule

**Weeks 1-2**: Sprint 1 + Track B (start registry cleanup early)
**Week 3**: Sprint 2 + Track A (start transform unification)
**Week 4**: Sprints 3-5 (finish critical path)
**Week 5**: Track A completion (if not finished)

**Total Parallel Time**: 4-5 weeks

---

## Estimated Effort Summary

| Phase | Effort | Risk | Dependencies |
|-------|--------|------|--------------|
| Sprint 1: Edges authoritative | 1-2 weeks | HIGH | None |
| Sprint 2: Compiler edges-only | 1 week | MEDIUM | Sprint 1 |
| Sprint 3: Remove migration helpers | 1 day | LOW | Sprint 2 |
| Sprint 4: Clean type definitions | 1 day | LOW | Sprint 3 |
| Sprint 5: PatchStore cleanup | 2-3 days | MEDIUM | Sprint 4 |
| **Sequential Total** | **3-4 weeks** | - | - |
| Track A: Transform unification | 1 week | MEDIUM | None |
| Track B: Registry cleanup | 2-3 days | LOW | None |
| **Parallel Total** | **1 week** | - | - |
| **Overall (Parallel)** | **4-5 weeks** | - | - |

**Status Reference**: STATUS lines 736-750

---

## Next Steps

### Immediate Actions

1. **Decision Required**: Big-bang (3-4 weeks focused) vs. incremental (6-8 weeks interleaved)?
2. **Start Track B**: Complete Sprint 4 Deliverable 3 (TRANSFORM_REGISTRY in compiler) - can start now
3. **Begin Sprint 1**: Implement migration-on-load for backward compatibility
4. **Create Tests**: Golden patch compilation with edges-only format
5. **Audit Transaction Ops**: Ensure undo/redo works with Edge type

### Recommended Approach

**Incremental with Parallel Work:**
- Start Track B immediately (low risk, high value)
- Begin Sprint 1 while Track B is in progress
- Start Track A during Sprint 2
- Complete critical path (Sprints 1-5) over 4-5 weeks
- Ship partial progress after Sprint 2 (edges authoritative, no dual-path)

### Blockers

**None** - All Phase 0 work is complete. Cleanup can start immediately.

### Open Questions

See "Ambiguities Found" section in STATUS-2026-01-01.md (lines 572-581):
- Transform field naming (`transforms` vs `transformStack`) - **Resolved**: Use `transforms`
- Migration timeline - **Resolved**: Incremental approach recommended
- Patch version bump - **Resolved**: Bump to version 2 in Sprint 4
- Transaction ops - **Addressed**: Sprint 1.4 will audit and update
- Serialization format - **Addressed**: Keep migration code for 2-3 releases

---

## Files Requiring Changes

### Sprint 1: Edges Authoritative
- `src/editor/types.ts` - Make edges required
- `src/editor/stores/PatchStore.ts` - Always populate edges
- `src/editor/kernel/migration.ts` - NEW: Migration-on-load
- `src/editor/transactions/ops.ts` - Update for Edge type
- `src/editor/kernel/ops.ts` - Verify Edge compatibility
- `src/ui/components/**/*.tsx` - UI creates edges

### Sprint 2: Compiler Edges-Only
- `src/editor/compiler/passes/pass1-normalize.ts` - Remove dual-path
- `src/editor/compiler/passes/pass2-types.ts` - Edges-only type checking
- `src/editor/compiler/passes/pass7-bus-lowering.ts` - Edges-only bus handling
- `src/editor/compiler/passes/pass8-link-resolution.ts` - Verify edges-only
- `src/editor/compiler/ir/patches.ts` - Remove legacy arrays from NormalizedPatch

### Sprint 3: Remove Migration Helpers
- `src/editor/edgeMigration.ts` - DELETE (315 lines)
- `src/editor/__tests__/edgeMigration.test.ts` - DELETE

### Sprint 4: Clean Type Definitions
- `src/editor/types.ts` - Remove legacy arrays from Patch interface
- Fix all compile errors from type removal

### Sprint 5: PatchStore Cleanup
- `src/editor/stores/PatchStore.ts` - Remove legacy observables and methods
- `src/ui/components/**/*.tsx` - Update to use edge methods

### Track A: Transform Unification
- `src/editor/types.ts` - Add transforms field to Edge
- `src/editor/transforms/migrate.ts` - NEW: Convert legacy transforms
- Update all edge creation sites
- Update compiler to read transforms
- Remove lensStack/adapterChain fields

### Track B: Registry Cleanup
- `src/editor/compiler/passes/pass2-types.ts` - Use TRANSFORM_REGISTRY
- `src/editor/compiler/passes/pass6-block-lowering.ts` - Use TRANSFORM_REGISTRY
- `src/editor/compiler/passes/pass7-bus-lowering.ts` - Use TRANSFORM_REGISTRY
- `src/editor/compiler/passes/pass8-link-resolution.ts` - Use TRANSFORM_REGISTRY
- `src/editor/transforms/catalog.ts` - Use TRANSFORM_REGISTRY
- DELETE: `src/editor/lenses/LensRegistry.ts`
- DELETE: `src/editor/adapters/AdapterRegistry.ts`
- DELETE: `src/editor/transforms/migrateLenses.ts`
- DELETE: `src/editor/transforms/migrateAdapters.ts`

---

## Success Metrics

### Code Quality
- **Lines removed**: ~1000-1500 (edgeMigration.ts, registries, legacy types)
- **Complexity reduction**: ~15-20% in compiler passes
- **Type safety**: Zero `any` types in edge handling

### Testing
- **Test coverage**: Maintain 2796+ passing tests
- **New tests**: +50-100 for migration and edge validation
- **Performance**: Compile time within ±5% of baseline

### Maintainability
- **Single source of truth**: Edges only, no dual arrays
- **Clear APIs**: One way to create connections (addEdge)
- **Documentation**: Migration guide and CHANGELOG entries

---

## Documentation Updates Required

- [ ] CHANGELOG.md - Document breaking changes and migration path
- [ ] Migration guide - How to convert old patches to version 2
- [ ] API documentation - Update PatchStore/Edge documentation
- [ ] README.md - Update if connection examples exist

---

## Final Notes

**Why This Cleanup Matters:**
1. **Maintenance burden**: Dual-path code adds ~15-20% complexity overhead
2. **Bug surface**: Multiple sources of truth create inconsistency bugs
3. **Onboarding cost**: New developers must understand both systems
4. **Future work blocked**: Clean architecture enables Phase 6+ work

**Why Not Urgent:**
1. **System is functional**: Phase 0 works correctly with compatibility layers
2. **No performance impact**: Dual paths don't affect runtime performance
3. **Low bug risk**: Compatibility code is stable and well-tested

**Recommendation**: Proceed incrementally over 4-5 weeks, shipping partial progress after Sprint 2. Prioritize Track B (registry cleanup) to start immediately while planning Sprint 1.

**Status Reference**: STATUS lines 822-833
