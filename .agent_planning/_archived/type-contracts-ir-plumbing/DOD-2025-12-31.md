# Definition of Done: Type Contracts + IR Plumbing
**Generated:** 2025-12-31
**Source:** PLAN-2025-12-31-045033.md

---

## Sprint Goal
Establish a unified type contract across editor and compiler, eliminate defaultSource inconsistencies, and harden IR validation to catch errors at compile-time.

---

## Acceptance Criteria

### P0: Fix Test Blocker
- [ ] Add `debugProbes` field to all test mocks in `state-offset-resolution.test.ts`
- [ ] `just typecheck` passes without errors

### P0: Unified TypeDesc Contract
- [ ] Create unified `TypeDesc` interface in `src/core/types.ts` with:
  - `world: 'signal' | 'event' | 'field' | 'scalar' | 'config'`
  - `domain: Domain`
  - `category: TypeCategory`
  - `busEligible: boolean`
  - `lanes?: number[]` (replaces bundleKind/bundleArity)
- [ ] Update editor (`src/editor/types.ts`) to re-export from core
- [ ] Update compiler IR (`src/editor/compiler/ir/types.ts`) to import from core
- [ ] Migrate `'special'` world to `'config'` or remove from TypeDesc
- [ ] Create `bundleKindToLanes()` migration helper
- [ ] All typecheck errors resolved

### P1: DefaultSource Shared Helper
- [ ] Create `materializeDefaultSource()` in `src/editor/compiler/ir/defaultSourceUtils.ts`
- [ ] Helper handles all worlds: signal, field, scalar, config, event
- [ ] Update Pass6 to use shared helper
- [ ] Update Pass8 to use shared helper
- [ ] Unit tests for all world types
- [ ] Signal non-numeric uses const pool (not coercion)

### P1: Harden Pass 8 Link Resolution
- [ ] Output slot validation (emit `MissingOutputRegistration` if no slot)
- [ ] Document null ValueRef handling (when expected vs error)
- [ ] Unit tests for new validations
- [ ] Error messages include block/port names (actionable)

---

## Validation

- [ ] `just check` passes (typecheck + lint + test)
- [ ] No new runtime errors introduced
- [ ] Manual verification with dev server
