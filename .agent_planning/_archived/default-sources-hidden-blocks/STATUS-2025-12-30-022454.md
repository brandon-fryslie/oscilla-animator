# Status Report - 2025-12-30-022454
Scope: module/default-sources-hidden-blocks
Confidence: FRESH

## Executive Summary
Overall: 0% complete | Critical issues: 0 | Tests reliable: N/A (not yet implemented)

**Plan Goal**: Transform all "default sources" from simple constant values into hidden provider blocks (so an input's fallback can be e.g., an Oscillator producing a sine wave). The current constant-default behavior becomes a hidden `Const` provider block.

**Current State**: This is a greenfield feature. **Nothing from the plan has been implemented yet.** All infrastructure is NET NEW.

**Blockers**:
1. TypeScript compilation currently broken (test file syntax error in `src/editor/__tests__/bus-compilation.test.ts:27`)
2. This feature requires significant architectural changes across multiple systems

**Workflow Recommendation**: CONTINUE with caution - plan is comprehensive but implementation will be invasive

---

## Evaluation Reuse Summary
- Carried forward: 0 findings (no previous evaluation)
- Spot-checked: 0 findings
- Re-evaluated: 0 findings
- Fresh evaluation: All findings are new

---

## Runtime Check Results
N/A - Feature not yet implemented. No persistent checks exist for this feature.

### Required Checks (to be created during implementation)
| Check | Purpose | Status |
|-------|---------|--------|
| Manual: Constant default unchanged | Verify backward compatibility | NOT IMPLEMENTED |
| Manual: Oscillator default animates | Verify provider blocks work | NOT IMPLEMENTED |
| Manual: Wire override/disconnect | Verify driven input behavior | NOT IMPLEMENTED |
| Manual: No provider leakage | Verify providers stay hidden | NOT IMPLEMENTED |

---

## Current State (What Exists Today)

### 1. Default Source Infrastructure (WORKING, but limited to constants)

**File**: `src/editor/stores/DefaultSourceStore.ts`
- **Status**: COMPLETE for current constant-only model
- **What it does**:
  - Manages `DefaultSource` objects (id/type/value/uiHint)
  - Creates defaults when blocks are added (`createDefaultSourcesForBlock`)
  - Provides lookup: `getDefaultSourceForInput(blockId, slotId)`
  - Uses **random IDs** via `root.generateId('ds')` ⚠️ **RED FLAG**: Plan requires deterministic IDs
- **What's missing**: No concept of "provider blocks" or "attachments"

**Evidence**: Lines 68-220 show complete constant-value implementation.

### 2. Inspector UI (WORKING, but constant-only)

**File**: `src/editor/Inspector.tsx`
- **Component**: `DefaultSourcesSection` (lines 1301-1388)
- **Status**: COMPLETE for current model
- **What it does**:
  - Shows active (undriven) inputs with editable controls
  - Shows driven inputs as read-only "overridden"
  - Uses `DefaultSourceControl` component for rendering
- **What's missing**:
  - No provider selection dropdown
  - No provider config UI
  - No concept of "block provider" vs "constant provider"

**Evidence**: Lines 1301-1388 implement current UI.

### 3. Compiler Integration - Legacy Path (WORKING, constant-only)

**File**: `src/editor/compiler/compileBusAware.ts`
- **Function**: `resolveDefaultSource` (referenced at line 676)
- **Status**: COMPLETE for current model
- **What it does**:
  - Looks up default value via `defaultSourceValues[blockId:slotId]`
  - Falls back to `slot.defaultSource.value`
  - Creates a constant `Artifact`
- **What's missing**: No concept of "inject hidden provider blocks"

**Evidence**: Line 676 and lines 1369-1384 show constant resolution.

### 4. Compiler Integration - IR Path (WORKING, constant-only)

**File**: `src/editor/compiler/passes/pass1-normalize.ts`
- **Function**: `pass1Normalize`
- **Status**: COMPLETE for current model
- **What it does**:
  - Creates `DefaultSourceAttachment[]` with `constId`
  - Attaches default sources for unwired inputs
- **What's missing**: Only handles constants, not provider blocks

**Evidence**: Lines 63-95 show current constant attachment logic.

### 5. Compiler Patch Structure (READY for extension)

**File**: `src/editor/compiler/integration.ts`
- **Function**: `editorToPatch` (lines 401-425)
- **Status**: WORKING, ready for injection logic
- **What it does**:
  - Converts editor state to `CompilerPatch`
  - Builds `defaultSourceValues` lookup map (line 404-412)

**Evidence**: Lines 401-425 show current conversion logic.

**Type**: `CompilerPatch` interface (compiler/types.ts:544)
- Has `defaultSources?: Record<string, unknown>`
- Has `defaultSourceValues?: Record<string, unknown>`
- ⚠️ **READY FOR EXTENSION**: Can add injected blocks/connections here

### 6. Patch Type (NEEDS EXTENSION)

**File**: `src/editor/types.ts`
- **Interface**: `Patch` (line 726)
- **Status**: Missing `defaultSourceAttachments` field
- **What exists**:
  - `blocks: Block[]`
  - `connections: Connection[]`
  - `buses: Bus[]`
  - `defaultSources: DefaultSourceState[]` (line 746)
- **What's missing**:
  - `defaultSourceAttachments: DefaultSourceAttachment[]` (NEW FIELD REQUIRED)

**Evidence**: Lines 726-761 show current Patch structure.

### 7. Block Registry and Library (READY for hidden blocks)

**File**: `src/editor/blocks/registry.ts`
- **Status**: WORKING, supports tags
- **What it does**:
  - Registers all block definitions
  - Provides `getBlockTags(definition)` (line 47)
  - Builds `BLOCK_DEFS_BY_TYPE` map (line 83)
- **What's missing**:
  - No filtering logic for hidden blocks
  - No `DSConst*` blocks registered

**File**: `src/editor/BlockLibrary.tsx`
- **Status**: WORKING, no filtering for hidden blocks
- **What it does**:
  - Groups blocks by form/subcategory
  - Renders draggable block items
- **What's missing**:
  - No filtering of blocks with `tags.hidden === true`
  - Will show provider blocks unless we add filter

**Evidence**: No filtering logic found in `groupBlocksByForm` (lines 46-85).

### 8. Existing "Const" Blocks (WRONG KIND)

**Files found**:
- `src/editor/compiler/blocks/domain/FieldConstNumber.ts`
- `src/editor/compiler/blocks/domain/FieldConstColor.ts`
- `src/editor/blocks/domain/PathConst.ts`

⚠️ **IMPORTANT**: These are **Field/Path** const blocks, NOT the Signal/Scalar const providers we need.

**What's missing**: The `DSConst*` family for Signal<float>, Signal<int>, Signal<color>, etc.

---

## What's Missing (Gap Analysis)

### Phase A: Types + Allowlist (0% complete)

**NEW FILES REQUIRED**:
1. `src/editor/defaultSources/types.ts`
   - `DefaultSourceTarget` type
   - `DefaultSourceProvider` type
   - `DefaultSourceAttachment` type

2. `src/editor/defaultSources/allowlist.ts`
   - `DefaultSourceProviderBlockSpec` type
   - `DEFAULT_SOURCE_PROVIDER_BLOCKS` array
   - Includes const providers + Oscillator

3. `src/editor/defaultSources/constProviders.ts`
   - Mapping: SlotType → Const provider block type
   - List of required const block types

**TYPE CHANGES REQUIRED**:
- `src/editor/types.ts`: Add `Patch.defaultSourceAttachments: DefaultSourceAttachment[]`

**Status**: ❌ NONE EXIST

### Phase B: Const Provider Blocks (0% complete)

**NEW FILES REQUIRED**:
1. `src/editor/blocks/default-source-providers.ts`
   - Block definitions for:
     - `DSConstSignalFloat`
     - `DSConstSignalInt`
     - `DSConstSignalColor`
     - `DSConstSignalVec2`
     - `DSConstFieldFloat`
     - `DSConstFieldVec2`
     - `DSConstFieldColor`
     - `DSConstScalarString`
     - `DSConstScalarWaveform`
     - (more as needed based on registry scan)
   - Each with `tags: { role: 'defaultSourceProvider', hidden: true }`

2. `src/editor/compiler/blocks/defaultSources/DSConstSignalFloat.ts` (and similar)
   - Compiler implementations (pass-through)
   - Register in `src/editor/compiler/blocks/index.ts`

**CHANGES REQUIRED**:
- `src/editor/blocks/registry.ts`: Import and include DSConst blocks in `ALL_INDIVIDUAL_BLOCKS`
- `src/editor/BlockLibrary.tsx`: Filter out `tags.hidden === true` blocks

**Status**: ❌ NONE EXIST

### Phase C: Store + Persistence (10% complete - ID generation only)

**CHANGES REQUIRED** in `src/editor/stores/DefaultSourceStore.ts`:
- ✅ Already has: `sources: Map<string, DefaultSource>`
- ❌ MISSING: `attachmentsByTarget: Map<string, DefaultSourceAttachment>`
- ❌ MISSING: Helper to create/update attachments
- ❌ CRITICAL: Replace `root.generateId('ds')` with deterministic IDs:
  - Current (line 191): `root.generateId('ds')` - random!
  - Required: `ds:input:${blockId}:${slotId}`
  - Required: `dsprov:${blockId}:${slotId}`
  - Required: `ds:prov:${providerId}:${inputId}`

**CHANGES REQUIRED** in `src/editor/stores/RootStore.ts`:
- ❌ MISSING: `toJSON()` - save `defaultSourceAttachments`
- ❌ MISSING: `loadPatch()` - load `defaultSourceAttachments`
- ❌ MISSING: Backward compatibility - rebuild attachments if missing

**Status**: ⚠️ 10% complete (structure exists, but needs major refactor for IDs + attachments)

### Phase D: Compiler Injection (0% complete)

**CHANGES REQUIRED** in `src/editor/compiler/integration.ts`:
- ❌ MISSING: `injectDefaultSourceProviders(store, patch): CompilerPatch` function
- ❌ MISSING: Call to injection in `editorToPatch()` (after line 413)
- ❌ MISSING: Logic to:
  1. For each attachment where input is undriven
  2. Add provider block to `CompilerPatch.blocks`
  3. Add wire: provider output → target input
  5. Extend `defaultSourceValues` with provider internal defaults

**Status**: ❌ NONE EXIST

### Phase E: UI (0% complete)

**CHANGES REQUIRED** in `src/editor/Inspector.tsx`:
- ❌ MISSING: Provider selection dropdown (Constant vs allowlisted providers)
- ❌ MISSING: Provider config panel UI
- ❌ MISSING: Show bus-fed inputs as read-only
- ❌ MISSING: Show editable inputs with controls

**Status**: ❌ NONE EXIST

### Phase F: Validation (0% complete)

**NEW FILES REQUIRED**:
1. `src/editor/defaultSources/validate.ts`
   - `validateDefaultSourceAttachments(rootStore): Diagnostic[]`
   - Allowlist checks
   - Type compatibility checks
   - Bus existence checks
   - Cycle detection

**INTEGRATION REQUIRED**:
- Hook into semantic validator or compiler diagnostic hub

**Status**: ❌ NONE EXIST

---

## Data Flow Verification

Cannot verify - feature not implemented.

**Expected flow (from plan)**:
```
1. User edits default source → Store creates/updates attachment
2. Compile triggered → editorToPatch runs
3. Injection: For unwired inputs with attachments:
   - Create hidden provider block
   - Wire provider output → input
   - Wire bus → provider (if needed)
6. Runtime executes provider as normal block
```

**Current flow**:
```
1. User edits default value → Store updates DefaultSource.value
2. Compile triggered → editorToPatch runs
3. No injection (constants handled inline)
4. Legacy compiler resolves constant via `resolveDefaultSource()`
5. IR compiler attaches constant in pass1-normalize
6. Runtime evaluates constant value
```

---

## Ambiguities Found

### 1. Const Provider Coverage - Which slot types?

**Question**: Which slot types need const provider blocks?

**Context**: Plan says "Start with the types that appear in `slot.defaultSource` across the registry" but doesn't enumerate them.

**Options**:
- Option A: Scan registry now, create only needed types (minimal)
- Option B: Create comprehensive set upfront (Signal<float/int/color/vec2>, Field<float/vec2/color>, Scalar<string/waveform>)

**Impact**: Incomplete set = runtime errors when a slot type has no matching const provider.

**How it was guessed**: Plan assumes implementer will scan registry.

### 2. Provider ID Stability - What about existing patches?

**Question**: How do we migrate existing patches with random `ds-*` IDs to deterministic IDs?

**Context**: DefaultSourceStore currently generates random IDs (line 191). Plan requires deterministic IDs.

**Options**:
- Option A: Migration pass in `loadPatch()` - rewrite old IDs to new scheme
- Option B: Break existing patches (require re-creation)
- Option C: Support both ID schemes (legacy + new)

**Impact**: Wrong choice = data loss or broken backward compatibility.

**How it was guessed**: Plan mentions deterministic IDs but doesn't address migration.



**Context**: Plan says "convert busName → busId by searching `store.busStore.buses`" but doesn't say what to do if bus doesn't exist.

**Options**:
- Option A: Fail compilation if bus doesn't exist (strict)
- Option C: Create bus on-demand (magical)

**Impact**: Wrong choice = silent failures or unexpected errors.

**How it was guessed**: Plan assumes bus exists, doesn't handle missing bus case.

### 4. Driven Input Behavior - Show provider config or not?

**Question**: When an input is driven by wire/bus, should the default source provider UI be visible (read-only) or hidden?

**Context**: Plan says "Driven inputs remain read-only" but current UI shows them in a separate section.

**Options**:
- Option A: Show provider config as read-only (current pattern)
- Option B: Hide provider config entirely when driven
- Option C: Show collapsed placeholder ("Default: Oscillator (overridden)")

**Impact**: UI clutter vs. discoverability.

**How it was guessed**: Plan preserves current behavior but doesn't specify details.

### 5. Provider Block Naming - User-visible or hidden?

**Question**: Should provider blocks have user-visible names/IDs in diagnostics/debug?

**Context**: Plan uses deterministic IDs like `dsprov:${blockId}:${slotId}` but doesn't say if these appear in error messages.

**Options**:
- Option A: Show technical IDs in errors (debug-friendly)
- Option B: Show friendly names like "Default provider for BlockName.inputName" (user-friendly)
- Option C: Never mention provider blocks in errors (hide implementation detail)

**Impact**: Debug experience vs. implementation leakage.

**How it was guessed**: Plan doesn't address error messages.

---

## Implementation Assessment

| Component | Status | Confidence | Evidence | Issues |
|-----------|--------|------------|----------|--------|
| **DefaultSourceStore** | PARTIAL | FRESH | Lines 68-220 in DefaultSourceStore.ts | Random IDs (line 191) ⚠️, No attachments |
| **Inspector UI** | PARTIAL | FRESH | Lines 1301-1388 in Inspector.tsx | Constant-only, no provider selection |
| **Compiler (legacy)** | PARTIAL | FRESH | Line 676 in compileBusAware.ts | Constant-only, no injection |
| **Compiler (IR)** | PARTIAL | FRESH | Lines 63-95 in pass1-normalize.ts | Constant-only, no injection |
| **Compiler Integration** | READY | FRESH | Lines 401-425 in integration.ts | Ready for injection function |
| **Patch Type** | INCOMPLETE | FRESH | Line 726 in types.ts | Missing `defaultSourceAttachments` field |
| **Block Registry** | READY | FRESH | Line 47 in registry.ts | Supports tags, no filtering yet |
| **BlockLibrary** | INCOMPLETE | FRESH | Lines 46-85 in BlockLibrary.tsx | No hidden block filtering |
| **Const Providers** | NOT_STARTED | FRESH | N/A | No DSConst* blocks exist |
| **Allowlist** | NOT_STARTED | FRESH | N/A | No allowlist file exists |
| **Validation** | NOT_STARTED | FRESH | N/A | No validation module exists |

---

## LLM Blind Spot Findings

### Blind Spot: Deterministic IDs
- [x] **Current state**: Random IDs via `root.generateId('ds')` (DefaultSourceStore.ts:191)
- [x] **Issue**: Cannot rebuild mappings after load, not stable across sessions
- [x] **Plan addresses**: Yes (Section 5.2) - requires deterministic IDs
- [x] **Remaining risk**: Migration from old patches not addressed

### Blind Spot: Hidden Block Leakage
- [x] **Current state**: No filtering in BlockLibrary
- [x] **Issue**: Provider blocks will appear in palette unless filtered
- [x] **Plan addresses**: Yes (Section 4.3.4) - filter `tags.hidden === true`
- [x] **Remaining risk**: Other UIs (context menus, search) may not filter

### Blind Spot: Second Run / Existing Data
- [x] **Current state**: Patch save/load works for constants
- [x] **Issue**: Attachments not persisted or loaded
- [x] **Plan addresses**: Yes (Section 5.3) - save/load attachments
- [x] **Remaining risk**: Backward compatibility for old patches with random IDs

### Blind Spot: Error Messages
- [x] **Current state**: Errors reference block IDs directly
- [x] **Issue**: Provider block IDs like `dsprov:foo:bar` may leak into errors
- [x] **Plan addresses**: No - doesn't mention diagnostic formatting
- [x] **Remaining risk**: Confusing error messages for users

---

## Test Suite Assessment

**Quality Score**: N/A (feature not implemented)

**Current test state**:
- TypeScript compilation broken (syntax error in `src/editor/__tests__/bus-compilation.test.ts:27`)
- No tests exist for default source provider blocks
- No tests exist for default source attachments
- No tests exist for compiler injection

**Required test coverage (from plan)**:
- ❌ Constant default still works (backward compatibility)
- ❌ Oscillator default drives unwired input
- ❌ Wire override/disconnect behavior
- ❌ Provider blocks hidden from palette
- ❌ Provider blocks cannot be wired manually
- ❌ Bus-fed inputs work correctly

**Plan directive**: "do **not** rely on tests" - manual verification via `just dev`

---

## Dependencies and Risks

### Dependencies
1. **TypeScript compilation must work** - currently broken
2. **Block registry must support tags** - ✅ WORKING
3. **Compiler passes must handle injected blocks** - ⚠️ ASSUMED (not verified)
4. **MobX observability must track attachments** - ⚠️ ASSUMED (not verified)

### Risks

**HIGH RISK: ID Migration**
- Current patches have random `ds-*` IDs
- New system requires deterministic IDs
- No migration strategy specified
- **Mitigation**: Need backward-compat loader or data migration script

**HIGH RISK: Compiler Injection Complexity**
- Must not break existing compilation passes
- Both legacy and IR compilers must handle injected graph
- **Mitigation**: Thorough testing of both compiler paths

**MEDIUM RISK: UI Complexity**
- Provider selection + config UI is non-trivial
- Must handle driven vs. undriven states
- Must render different UIs for different provider types
- **Mitigation**: Incremental implementation (Const first, Oscillator second)

**MEDIUM RISK: Hidden Block Leakage**
- Multiple UIs may show blocks (palette, search, diagnostics)
- Must filter consistently everywhere
- **Mitigation**: Centralized `isBlockHidden(def)` helper

**LOW RISK: Performance**
- Injecting blocks at compile time adds overhead
- **Mitigation**: Only inject for undriven inputs (minimal)

---

## Recommendations

### Priority 1: Fix TypeScript Compilation
**Why**: Cannot proceed with implementation until codebase compiles.
**Action**: Fix syntax error in `src/editor/__tests__/bus-compilation.test.ts:27`

### Priority 2: Resolve Ambiguities
**Why**: Five critical design questions need answers before implementation.
**Action**: Answer ambiguities 1-5 listed above.

### Priority 3: Incremental Implementation Strategy
**Why**: This is a large, invasive change. Incremental approach reduces risk.
**Proposed sequence**:
1. **Phase 0: Deterministic IDs** - Refactor DefaultSourceStore to use deterministic IDs (backward-compat mode)
2. **Phase 1: Types + Minimal Const** - Add types, create one Const provider (DSConstSignalFloat)
3. **Phase 2: Injection (Const only)** - Implement injection for Const providers only
4. **Phase 3: UI (Const only)** - No UI change (Const is default, no selection needed yet)
5. **Phase 4: Validate Const path** - Manual testing, verify backward compat
6. **Phase 5: Full Const family** - Add remaining DSConst* blocks
7. **Phase 6: Allowlist + Oscillator** - Add allowlist, Oscillator provider
8. **Phase 7: UI (Provider selection)** - Add dropdown, provider config UI
9. **Phase 8: Validation** - Add validation module

### Priority 4: Backward Compatibility Plan
**Why**: Existing patches with random IDs will break.
**Action**: Design migration strategy before implementing deterministic IDs.

---

## Acceptance Criteria (from plan)

- [ ] **Default source can be set to Oscillator for a compatible input** - NOT IMPLEMENTED
- [ ] **Provider is not visible as a block in PatchBay** - NOT IMPLEMENTED (no filtering)
- [ ] **Provider cannot be wired like a normal block** - UNKNOWN (no provider blocks exist)
- [ ] **Provider only reads from global buses/time + internal constants** - NOT IMPLEMENTED
- [ ] **Compiler behavior is consistent** - UNKNOWN (injection not implemented)
- [ ] **All provider types live in one allowlist file** - NOT IMPLEMENTED (no allowlist exists)

**Overall**: 0/6 acceptance criteria met.

---

## Workflow Recommendation

**VERDICT**: ⚠️ **PAUSE** - Ambiguities need clarification before proceeding

**Rationale**:
1. **TypeScript compilation is broken** - must fix before any implementation
2. **Five critical ambiguities** need design decisions:
   - Const provider coverage (which types?)
   - ID migration strategy (how to handle existing patches?)
   - Driven input UI (show provider config or hide?)
   - Provider block naming (how to format in diagnostics?)
3. **No incremental path defined** - plan jumps straight to full implementation
4. **Backward compatibility unclear** - risk of breaking existing patches

**Questions needing answers before continuing**:

1. **Const provider coverage**: Scan registry now or create comprehensive set?
2. **ID migration**: How to handle existing patches with random IDs?
3. **Missing bus**: Fail compilation or fall back?
4. **Driven input UI**: Show provider config as read-only or hide?
5. **Provider naming**: How to format in error messages?
6. **Incremental approach**: Approve phased rollout (Const first, Oscillator later)?

Once these are answered, implementation can proceed with confidence.

---

## Next Actions (if CONTINUE is chosen)

1. Fix TypeScript compilation error
2. Answer 6 questions above
3. Implement Phase 0: Deterministic IDs (with backward compat)
4. Implement Phase 1: Types + minimal Const provider
5. Return for evaluation before proceeding to Phase 2
