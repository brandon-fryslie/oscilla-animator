# Definition of Done: Signal Runtime + Stateful Ops

**Generated**: 2025-12-30-031559
**Plan**: PLAN-2025-12-30-031559.md
**Topic**: Signal Runtime + Stateful Ops (Workstream 4)

---

## Sprint 1: State ID Resolution in buildSchedule

### Deliverable: State Offset Mapping Infrastructure

- [ ] `buildSchedule` collects StateDecls from lowering context
- [ ] StateDecl sorting is deterministic: same input → same offsets every time
- [ ] Alignment rules applied: scalars 4-byte aligned, buffers 16-byte aligned
- [ ] SignalExprStateful nodes have `params.stateOffset` set after buildSchedule
- [ ] Compile error emitted for StateDeclConflict (same ID, different size)
- [ ] Compile error emitted for StateRefMissingDecl (unknown stateId)

### Deliverable: Test Coverage

- [ ] Determinism test: compile same patch 10x → identical state offsets
- [ ] Local stability test: add new block → existing blocks' offsets unchanged
- [ ] Missing decl test: reference invalid stateId → compile error with block name
- [ ] Conflict test: two blocks use same stateId with different sizes → error
- [ ] All tests in `SigStateful.test.ts` pass without manual offset workarounds

---

## Sprint 2: Bundle Type System

### Deliverable: Type System Extensions

- [ ] `BundleKind` enum defined with Scalar, Vec2, Vec3, RGBA, Mat4
- [ ] `TypeDesc` includes `bundleArity: number` field
- [ ] TypeDesc creation automatically infers bundleArity from domain
- [ ] Port definitions support `PortScalar` vs `PortBundle` types
- [ ] Compile error emitted when connecting bundle port to scalar port

### Deliverable: Slot Allocation

- [ ] ValueSlot allocation increments by bundleArity (vec2 consumes 2 slots)
- [ ] Slots are contiguous: bundle at slot N uses slots [N, N+bundleArity)
- [ ] bundleSplit operation extracts components from bundle
- [ ] bundleMerge operation constructs bundle from components
- [ ] Integration test: vec2 signal wire → verify 2 consecutive slots allocated

---

## Sprint 3: Multi-Component Slot Evaluation

### Deliverable: InputSlot Bundle Reading

- [ ] `SignalExprIR` inputSlot nodes include `bundleArity: number` field
- [ ] `evalInputSlot()` returns single number for scalar (arity=1)
- [ ] `evalInputSlot()` reads N consecutive slots for bundles (arity>1)
- [ ] Vec2 input slot reads slots [N, N+1] correctly
- [ ] Vec3 input slot reads slots [N, N+1, N+2] correctly
- [ ] RGBA input slot reads slots [N, N+1, N+2, N+3] correctly

### Deliverable: Runtime Safety

- [ ] Runtime error emitted if bundle read exceeds slot buffer bounds
- [ ] ColorHSLToRGB kernel receives 3 scalar values (not array)
- [ ] Integration test: vec2 signal → evalInputSlot → verify [x, y] components
- [ ] Integration test: vec3 signal → evalInputSlot → verify [r, g, b] components

---

## Sprint 4: ColorLFO Dynamic HSL Mode

### Deliverable: ColorLFO HSL Support

- [ ] ColorLFO block has optional Saturation and Lightness input ports
- [ ] ColorLFO lowering emits 3 separate signals (H, S, L)
- [ ] H, S, L signals merged into vec3 bundle via bundleMerge
- [ ] ColorHSLToRGB kernel receives 3 scalar inputs (h, s, l)
- [ ] ColorHSLToRGB outputs vec3 (r, g, b) bundle

### Deliverable: Legacy Cleanup

- [ ] Legacy ColorShiftHue code path removed from ColorLFO
- [ ] Documentation updated: S/L are now dynamic, not baked
- [ ] Backward compatibility: unconnected S/L use config defaults

### Deliverable: Validation

- [ ] Chrome DevTools validation: animate H, S, L independently → verify color changes
- [ ] Integration test: ColorLFO with dynamic S/L → verify RGB output

---

## Sprint 5: Integration Testing & Validation

### Deliverable: Stateful Ops Integration Tests

- [ ] Integration test: PulseDivider block → compile → IR has params.stateOffset
- [ ] Integration test: EnvelopeAD block → compile → IR has params.stateOffset
- [ ] Integration test: Integrate block → compile → IR has params.stateOffset
- [ ] Integration test: DelayFrames block → compile → state layout correct size

### Deliverable: Chrome DevTools Runtime Validation

- [ ] Chrome DevTools: PulseDivider (divisions=4) → pulse every 0.25 phase
- [ ] Chrome DevTools: EnvelopeAD (attack=0.1s) → envelope rises in 0.1s
- [ ] Chrome DevTools: EnvelopeAD (decay=0.5s) → envelope falls in 0.5s
- [ ] Chrome DevTools: ColorLFO HSL → color output matches expected RGB
- [ ] Chrome DevTools: ColorLFO HSL → no legacy ColorShiftHue used

### Deliverable: Bundle Type System Integration Tests

- [ ] Integration test: vec2 signal → 2 consecutive slots allocated
- [ ] Integration test: vec3 signal → 3 consecutive slots allocated
- [ ] Integration test: vec2 read → returns [x, y] components
- [ ] Integration test: vec3 read → returns [r, g, b] components

### Deliverable: Determinism & Error Handling Tests

- [ ] Determinism test: compile 10x → identical state offsets
- [ ] Local stability test: add block → existing offsets unchanged
- [ ] Error test: StateDeclConflict → compile error with clear message
- [ ] Error test: StateRefMissingDecl → compile error with block name
- [ ] Error test: bundle type mismatch → compile error

### Deliverable: Clean Build

- [ ] All tests in `SigStateful.test.ts` pass without manual workarounds
- [ ] Build passes: `just check` succeeds with no errors

---

## Sprint Scope Summary

### Sprint 1 Delivers
- State offset mapping in buildSchedule (4 infrastructure criteria + 5 test criteria)

### Sprint 2 Delivers
- Bundle type system (5 type system criteria + 5 slot allocation criteria)

### Sprint 3 Delivers
- Multi-component slot evaluation (6 bundle reading criteria + 4 runtime safety criteria)

### Sprint 4 Delivers
- ColorLFO dynamic HSL mode (5 HSL support criteria + 3 legacy cleanup criteria + 2 validation criteria)

### Sprint 5 Delivers
- Integration testing & validation (4 stateful ops tests + 5 runtime validation tests + 4 bundle type tests + 5 determinism/error tests + 2 build criteria)

---

## Overall Completion Criteria

All 5 sprints are considered complete when:

1. **No manual workarounds** in test suite (state offsets set automatically)
2. **All stateful ops work** in real patches (PulseDivider, EnvelopeAD, etc.)
3. **Multi-component signals work** (vec2, vec3, rgba read correctly)
4. **ColorLFO supports dynamic HSL** (not just hue rotation)
5. **Chrome DevTools validation passes** (visual confirmation of correct behavior)
6. **Build is clean** (`just check` passes with no errors)

**Total Acceptance Criteria**: 60 checkboxes across 5 sprints
