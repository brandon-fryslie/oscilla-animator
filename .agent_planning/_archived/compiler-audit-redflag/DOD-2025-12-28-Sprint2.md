# Definition of Done: Block Lowering Foundation - Sprint 2

**Generated:** 2025-12-28
**Plan:** PLAN-2025-12-28-Sprint2.md
**Source:** STATUS-2025-12-28.md

---

## Sprint Scope

This sprint delivers **3 items** to implement real IR lowering:
1. Pass 6 block lowering for core signal blocks
2. ColorLFO HSL→RGB kernel
3. SVGSampleDomain initialization fix

---

## Acceptance Criteria

### Deliverable 1: Pass 6 Block Lowering

**Goal:** Core signal blocks emit real IR nodes, not placeholders

**Blocks to Support:**
- [ ] Constant blocks: Constant, Vec2Constant, ColorConstant
- [ ] Math blocks: Add, Multiply, Subtract, Divide
- [ ] LFO blocks: SineLFO (at minimum)
- [ ] Utility blocks: Remap, Clamp (at minimum)

**Technical Requirements:**
- [ ] Block lowering registry maps block type → lowering function
- [ ] `artifactToValueRef()` dispatches to appropriate lowering function
- [ ] IR nodes correctly represent block computations
- [ ] Inputs are wired to upstream IR nodes (not hardcoded)

**Success Condition:** A patch with Constant → Add → Multiply compiles to IR that represents actual arithmetic, not placeholders.

**Verification:**
```bash
# Create test patch programmatically
# Inspect compiled IR to verify real operations
# Run patch and verify output matches expected
```

---

### Deliverable 2: ColorLFO HSL→RGB Kernel

**Goal:** Color conversion works in IR mode

- [ ] `colorHslToRgb` opcode added to IR transforms
- [ ] Signal evaluator implements HSL→RGB math
- [ ] ColorLFO block lowering uses new opcode
- [ ] ColorLFO output produces valid RGB colors

**Success Condition:** ColorLFO patch compiles and produces correct color output

**Verification:**
```bash
# Create patch with ColorLFO
# Verify color cycles through hue correctly
# Compare to legacy closure behavior
```

---

### Deliverable 3: SVGSampleDomain Initialization

**Goal:** SVG domains register correctly at runtime

- [ ] Domain registration happens for SVGSampleDomain blocks
- [ ] Domain slots are valid when field evaluation runs
- [ ] No "invalid domain" errors at runtime

**Success Condition:** SVG-based patches run without domain errors

**Verification:**
```bash
# Create patch with SVGSampleDomain
# Run and verify no domain-related errors
# Verify field sampling works on SVG geometry
```

---

## Known Limitations After Sprint 2

**These are EXPECTED and do NOT block sprint completion:**

- Only core signal blocks lowered (not all blocks)
- Field blocks still use placeholders
- Bus evaluation not working
- Event buses not functional
- Type conversions not implemented

---

## Test Requirements

**After completing all deliverables:**

1. **TypeScript passes:**
   ```bash
   just typecheck  # Pre-existing errors only, no new errors
   ```

2. **Tests run:**
   ```bash
   just test  # All files load
   ```

3. **Document new test coverage:**
   - Pass 6 lowering tests for new blocks
   - ColorLFO IR test
   - SVGSampleDomain test

---

## Files Modified (Expected)

1. `src/editor/compiler/passes/pass6-block-lowering.ts` - Block lowering
2. `src/editor/compiler/ir/transforms.ts` - New opcodes
3. `src/editor/runtime/executor/steps/executeSignalEval.ts` - Opcode impl
4. Domain initialization files for SVGSampleDomain

**Possibly:**
- New block-lowerers directory
- Test files for new functionality

---

## Success Criteria Summary

**Sprint 2 is DONE when:**

- [ ] Constant, Add, Multiply, Subtract, Divide emit real IR
- [ ] SineLFO emits real IR (not placeholder)
- [ ] ColorLFO HSL→RGB conversion works
- [ ] SVGSampleDomain initializes without errors
- [ ] TypeScript has no new errors
- [ ] Test suite runs successfully

**Sprint 2 is NOT done if:**

- Math blocks still emit placeholder IR
- ColorLFO produces wrong colors
- SVGSampleDomain has domain errors
- New TypeScript errors introduced
