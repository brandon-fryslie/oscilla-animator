# Multi-Input Cleanup - Leftover Code Inventory
**Timestamp**: 2026-01-01-040000
**Scope**: project/full
**Confidence**: FRESH

## Executive Summary
**Completion**: System is clean - no legacy single-input codepaths found
**Cleanup Items**: 12 .bak files, 0 deprecated codepaths, 0 old field references
**Verdict**: **CONTINUE** - Simple cleanup of backup files, no code changes needed

---

## Findings

### P0: Backup Files to Delete ✅ FOUND

**Evidence**: 12 .bak files exist in the codebase

```
/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/field/BufferPool.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/executor/RuntimeState.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/signal-expr/__tests__/SigStateful.test.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/signal-expr/__tests__/SigEvaluator.test.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/stores/BusStore.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/adapters/autoAdapter.test.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/adapters/AdapterRegistry.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/BlockLibrary.tsx.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/types.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/semantic/__tests__/busContracts.test.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts.bak
/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/passes/combine-utils.ts.bak
```

**Priority**: P2
**Reason**: Backup files from multi-input implementation - safe to delete

**Action**: Delete all .bak files

---

### P1: Field Name Verification ✅ CORRECT

**Status**: System already uses `Slot.combine`, NOT `combineMode`

**Evidence**:
- `src/editor/types.ts:667` defines `combine?: CombinePolicy` (CORRECT)
- No references to `Slot.combineMode` in active code (VERIFIED)
- All usage is through `Slot.combine` field (CORRECT)
- `resolveWriters.ts` accesses `inputSlot.combine` (CORRECT)

**What Changed**:
```typescript
// OLD (never existed in this form - spec evolved before implementation):
interface Slot {
  combineMode?: BusCombineMode;
}

// CURRENT (what was actually implemented):
interface Slot {
  combine?: CombinePolicy;  // More expressive than original spec
}
```

**Priority**: N/A - Already correct, no cleanup needed

---

### P2: Legacy Single-Input References ✅ NOT FOUND

**Search**: `single.input|one.connection|only.one.input` (case-insensitive)

**Findings**:
- 9 files match, ALL are **documentation/comments** explaining multi-input
- NO code enforcing single-input constraint found
- Single-input invariant properly removed from:
  - `PatchStore.ts` (no longer disconnects on connect)
  - `BusStore.ts` (allows multi-listener buses)

**Evidence of Correct Behavior**:
```typescript
// resolveWriters.ts - handles N >= 0 writers correctly
export interface WriterResolution {
  readonly writers: readonly Writer[];  // Can be empty, single, or multiple
  readonly combine: CombinePolicy;
}
```

**Priority**: N/A - No cleanup needed

---

### P3: Outdated Comments/TODOs ✅ VERIFIED

**Search**: `TODO.*multi|FIXME.*multi|TODO.*combine|FIXME.*combine`

**Findings**:
```
src/editor/compiler/passes/combine-utils.ts:73:    // TODO: Check custom combine registry
src/editor/compiler/passes/combine-utils.ts:189:    // TODO: Look up custom combine implementation
```

**Analysis**: These TODOs are **FUTURE WORK**, not legacy cleanup
- Refer to custom combine modes (e.g., `{ kind: 'custom'; id: 'blendOver' }`)
- Part of extensibility plan (design-docs/now/01-MultiBlock-Input.md §1.1)
- NOT leftover from old system

**Priority**: N/A - Valid future work, not cleanup

---

### P4: Bus.combineMode vs Slot.combine ✅ CORRECT

**Status**: These are DIFFERENT fields for DIFFERENT purposes

**Bus.combineMode** (type: `BusCombineMode`):
- Lives on `Bus` interface
- Controls how publishers to a bus are combined
- Used by Pass 7 (bus lowering)
- **CORRECT** - buses still use this field

**Slot.combine** (type: `CombinePolicy`):
- Lives on `Slot` interface
- Controls how multiple writers to an input port are combined
- Used by resolveWriters + Pass 6 (block lowering)
- **CORRECT** - inputs now support multi-input

**Evidence**:
```typescript
// src/editor/types.ts
export interface Bus {
  combineMode: BusCombineMode;  // KEEP - for bus publishers
}

export interface Slot {
  combine?: CombinePolicy;      // KEEP - for input ports
}
```

**Priority**: N/A - No cleanup needed, both fields are correct

---

### P5: Duplicate/Dead Code ✅ NOT FOUND

**Search Patterns**:
- Old combine logic not using `createCombineNode()`: NOT FOUND
- Inline combine implementations: NOT FOUND
- Feature flags for multi-input: NOT FOUND (always enabled)

**Evidence**: All combine logic routes through shared utilities
- Pass 6: Uses `createCombineNode()` from `combine-utils.ts`
- Pass 7: Uses `createCombineNode()` from `combine-utils.ts`
- No duplicate implementations found

**Priority**: N/A - Code is clean

---

### P6: Compatibility Shims ✅ NOT FOUND

**Search**: `old.format|new.format|compatibility|shim`

**Findings**:
- 50+ matches in comments describing **type compatibility checks** (correct usage)
- 0 matches for format migration code
- 0 matches for "if old format" conditionals

**Notable "compatibility" references (all correct)**:
- `semantic/index.ts` - Type compatibility checker (CORE FEATURE)
- `ConnectionInspector.tsx` - UI showing type compatibility (CORRECT)
- `portUtils.ts` - Type compatibility for connections (CORRECT)

**Priority**: N/A - No cleanup needed

---

## Recommendations

### Priority Order

**P2: Delete Backup Files** (5 minutes)
```bash
rm /Users/bmf/code/oscilla-animator_codex/src/editor/runtime/field/BufferPool.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/runtime/executor/RuntimeState.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/runtime/signal-expr/__tests__/SigStateful.test.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/runtime/signal-expr/__tests__/SigEvaluator.test.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/stores/BusStore.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/adapters/autoAdapter.test.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/adapters/AdapterRegistry.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/BlockLibrary.tsx.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/types.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/semantic/__tests__/busContracts.test.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts.bak
rm /Users/bmf/code/oscilla-animator_codex/src/editor/compiler/passes/combine-utils.ts.bak
```

**Evidence**: This is the ONLY cleanup item found. Everything else is already clean.

---

## Verification

### What Multi-Input System Uses

**Correct Field Names** (verified in codebase):
- `Slot.combine: CombinePolicy` - for input port multi-input resolution
- `Bus.combineMode: BusCombineMode` - for bus publisher combination
- `CombineMode` type - extends BusCombineMode with 'first', 'error', custom
- `CombinePolicy` type - `{ when: 'multi'|'always', mode: CombineMode|'error' }`

**Shared Utilities** (verified clean):
- `combine-utils.ts` - `createCombineNode()` used by both Pass 6 and Pass 7
- `resolveWriters.ts` - `resolveInputWriters()` enumerates all writer types
- Default policy: `{ when: 'multi', mode: 'last' }`

**Integration Points** (verified working):
- Pass 6: Multi-input via `resolveInputWriters()` + `createCombineNode()`
- Pass 7: Bus lowering via `getPublishersFromEdges()` + `createCombineNode()`
- PatchStore/BusStore: No single-input checks (removed correctly)

---

## Workflow Recommendation

✅ **CONTINUE** - Simple cleanup task

**Cleanup Steps**:
1. Delete 12 .bak files (list above)
2. Verify no git-tracked files affected: `git status`
3. Done

**No Code Changes Needed** - System is already clean:
- No legacy `combineMode` field on Slot (uses `combine` correctly)
- No single-input enforcement (removed correctly)
- No duplicate combine logic (uses shared utilities)
- No compatibility shims (direct implementation)

---

## Evidence: "No Evidence It Ever Worked Differently"

**User Goal**: Make it look like multi-input was always the design

**Current State**: ✅ ACHIEVED (except .bak files)

1. **No feature flags** - Multi-input is always enabled
2. **No fallback paths** - Only one codepath exists (multi-input)
3. **No conditional logic** - No "if multi-input enabled" checks
4. **Clean type names** - `Slot.combine`, not `Slot.multiInputCombine`
5. **Integrated utilities** - Shared combine logic used everywhere
6. **No migration code** - Direct implementation, no format converters

**Only Trace**: 12 .bak files from implementation sprint (safe to delete)

---

## Summary

| Category | Status | Action |
|----------|--------|--------|
| Backup files (.bak) | 12 found | DELETE |
| Field naming (combineMode vs combine) | ✅ Correct | NONE |
| Single-input enforcement | ✅ Removed | NONE |
| Duplicate combine logic | ✅ Clean | NONE |
| Feature flags | ✅ None found | NONE |
| Compatibility shims | ✅ None found | NONE |
| TODOs/FIXMEs | Future work only | NONE |

**Total Cleanup**: Delete 12 backup files (5 minutes)
