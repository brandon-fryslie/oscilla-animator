# Sprint Plan: Unify Bus.combineMode → Bus.combine (CombinePolicy)

**Generated**: 2026-01-01-052959
**Source**: STATUS-2026-01-01-050000.md
**Topic**: multi-input-cleanup
**Effort**: Medium (4-6 hours, ~35 files, ~80-100 lines)

---

## ⚠️ BLOCKERS AND QUESTIONS

**CRITICAL**: This plan implements a change that **contradicts the design specification** and **loses type safety**.

### Question for User

**What problem are you trying to solve by unifying Bus.combineMode and Slot.combine?**

**Current State** (per STATUS-2026-01-01-050000.md and design-docs/now/01-MultiBlock-Input.md):
- Bus and Slot **already share the same CombineMode type** (line 125 in types.ts)
- This IS the unification - both use the same combine modes ('sum', 'average', 'max', 'min', 'last', 'layer')
- They have **different wrappers intentionally**:
  - **Bus.combineMode: BusCombineMode** - Direct mode (no 'when' policy needed, always combines publishers)
  - **Slot.combine: CombinePolicy** - Richer policy with 'when' semantics and 'error' mode

**Design Authority** (design-docs/now/01-MultiBlock-Input.md):
- §1.1: "A single unified enum, used by **both inputs and buses**" ✅ Already done
- §6.2: "They use the same reducer implementations and type rules, but they are **distinct sites**"

### Options

**Option A: Leave as-is (RECOMMENDED)**
- **Pros**:
  - Type-safe (buses can't use invalid modes like 'error' or 'first' at compile-time)
  - Follows design spec
  - Simpler code (no validation overhead)
  - Already correctly unified at the type level
- **Cons**:
  - Different field names might look inconsistent to readers
- **Effort**: 0 hours

**Option B: Make Bus use CombinePolicy (THIS PLAN)**
- **Pros**:
  - Same field name (superficial consistency)
- **Cons**:
  - **Loses compile-time type safety** - buses could accept invalid modes
  - **Violates design spec** (§6.2 says they're distinct sites)
  - Adds validation complexity (runtime checks needed everywhere)
  - Makes UI code more complex (wrapping/unwrapping policies)
  - Buses would have meaningless 'when' field (always 'multi')
- **Effort**: 4-6 hours (35 files, 80-100 lines + tests + validation)
- **Risk**: HIGH - breaking change, loses compile-time safety

### Impact of Wrong Choice

If we proceed with Option B and it's wrong:
1. Added runtime validation where compile-time type safety was sufficient
2. Lost type safety at bus creation sites (can pass 'error' or 'first' modes that are invalid for buses)
3. Made UI code more complex (unwrapping policies, filtering invalid modes)
4. Violated design spec explicitly
5. **Would need to revert** - another 4-6 hours

**RECOMMENDATION**: Pause and confirm user intent before proceeding.

---

## Executive Summary

**IF** we proceed with this change (assuming user confirms):

**Current State** (per STATUS-2026-01-01-050000.md):
- Bus uses `combineMode: BusCombineMode` (6 modes: sum, average, max, min, last, layer)
- Slot uses `combine: CombinePolicy` (wrapper with 'when' semantics + all CombineMode values)
- Both share the underlying CombineMode type ✅ Already unified where it matters

**Target State**:
- Bus uses `combine: CombinePolicy` (same as Slot)
- All `bus.combineMode` references changed to `bus.combine.mode`
- Add validation everywhere to reject invalid policies for buses

**Gap**:
- ~35 files need updates
- ~80-100 lines of code changes
- New validation requirements (reject 'when: always', 'mode: error', 'mode: first' for buses)
- All tests need bus creation syntax updated

**Recommended Focus**:
1. Fix unrelated GridDomain.ts typecheck error first (blocker)
2. Update type definitions and core interfaces
3. Update compiler passes and validation
4. Update UI components
5. Update all tests
6. Add new validation tests for bus policy constraints

**Risk Assessment**:
- **HIGH** - This is a breaking change that loses type safety
- All bus creation sites could potentially pass invalid policies
- Requires extensive validation throughout the codebase

---

## Backlog by Priority

### P0 (Critical) - Fix Blocker First

#### Unrelated Type Error in GridDomain.ts

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: None
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 250

**Description**:
Fix GridDomain.ts:183 - cols parameter may be undefined. This is blocking all typecheck runs.

**Acceptance Criteria**:
- [ ] `just typecheck` passes without GridDomain.ts error
- [ ] Tests can run

**Technical Notes**:
- Line 183 in src/editor/compiler/blocks/domain/GridDomain.ts
- May need to add optional chaining or default value

---

### P0 (Critical) - Type Definitions

#### Update Bus Interface to Use CombinePolicy

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: GridDomain.ts fix
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §1.1-1.2 • **Status Reference**: STATUS-2026-01-01-050000.md line 153

**Description**:
Change `Bus.combineMode: BusCombineMode` to `Bus.combine: CombinePolicy` in types.ts. Keep BusCombineMode type for use in validation utilities.

**Acceptance Criteria**:
- [ ] Bus interface has `combine: CombinePolicy` field (not combineMode)
- [ ] BusCombineMode type still exported for validation use
- [ ] TypeScript compilation succeeds for types.ts
- [ ] All imports of Bus type fail as expected (will fix in next tasks)

**Technical Notes**:
- File: src/editor/types.ts:172
- Keep BusCombineMode type definition (line 113) - still useful for validation
- This will break ~35 files - intentional, will fix systematically

---

### P0 (Critical) - Core Bus Store

#### Update BusStore to Use CombinePolicy

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: Bus interface update
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §1.2 • **Status Reference**: STATUS-2026-01-01-050000.md line 155-160

**Description**:
Update BusStore to create and manage buses with CombinePolicy. All default buses need to wrap their combine mode in `{ when: 'multi', mode: ... }` policy structure.

**Acceptance Criteria**:
- [ ] Default bus definitions use `combine: { when: 'multi', mode: 'sum' }` format
- [ ] createBus() accepts `combine: CombinePolicy` parameter
- [ ] updateBus() handles `combine` field (not combineMode)
- [ ] BusStore internal methods unwrap `combine.mode` when needed
- [ ] TypeScript compilation succeeds for BusStore.ts

**Technical Notes**:
- Files: src/editor/stores/BusStore.ts
- Lines to update: 99, 103-109 (6 default buses), 125, 149, 216
- Pattern: `combineMode: 'sum'` → `combine: { when: 'multi', mode: 'sum' }`
- All buses will use `when: 'multi'` (buses always combine when N > 1)

---

### P1 (High) - Compiler Passes

#### Update pass7-bus-lowering to Read bus.combine.mode

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: BusStore update
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §6.2 • **Status Reference**: STATUS-2026-01-01-050000.md line 163

**Description**:
Change bus combine mode access from `bus.combineMode` to `bus.combine.mode` in pass 7 (bus lowering).

**Acceptance Criteria**:
- [ ] Pass 7 reads `bus.combine.mode` instead of `bus.combineMode`
- [ ] Bus combine logic still works correctly
- [ ] TypeScript compilation succeeds
- [ ] Existing bus lowering tests pass (will need bus creation updates)

**Technical Notes**:
- File: src/editor/compiler/passes/pass7-bus-lowering.ts:274
- Single line change: `bus.combineMode` → `bus.combine.mode`
- Keep combine logic unchanged - only access path changes

---

#### Update compileBusAware to Read bus.combine.mode

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: BusStore update
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §6.2 • **Status Reference**: STATUS-2026-01-01-050000.md line 164-165

**Description**:
Change bus combine mode access in legacy compileBusAware.ts from `bus.combineMode` to `bus.combine.mode`.

**Acceptance Criteria**:
- [ ] All 5 references to `bus.combineMode` changed to `bus.combine.mode`
- [ ] Bus compilation logic unchanged
- [ ] TypeScript compilation succeeds
- [ ] Legacy compile path still works

**Technical Notes**:
- File: src/editor/compiler/compileBusAware.ts
- Lines: 242, 489, 498, 1088, 1090 (5 lines total)
- Mechanical find-replace in this file only

---

#### Update combine-utils to Accept CombinePolicy or BusCombineMode

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: Pass 7 and compileBusAware updates
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §6.2 • **Status Reference**: STATUS-2026-01-01-050000.md line 165

**Description**:
Update combine utility functions to accept either CombinePolicy (extract mode) or direct BusCombineMode for backward compatibility.

**Acceptance Criteria**:
- [ ] Combine utilities accept `CombinePolicy | BusCombineMode`
- [ ] Utilities extract `mode` from CombinePolicy when needed
- [ ] Combine logic remains unchanged
- [ ] TypeScript compilation succeeds
- [ ] All combine utility tests pass

**Technical Notes**:
- File: src/editor/compiler/combine-utils.ts
- Pattern: `function foo(mode: BusCombineMode | CombinePolicy) { const m = typeof mode === 'string' ? mode : mode.mode; ... }`
- Keep BusCombineMode as option for simpler call sites

---

### P1 (High) - Semantic Validation

#### Update Bus Semantic Contracts

**Status**: Not Started
**Effort**: Medium (1.5 hours)
**Dependencies**: BusStore update
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §4.1 • **Status Reference**: STATUS-2026-01-01-050000.md line 168-171

**Description**:
Update bus semantic validation contracts to validate `combine: CombinePolicy` instead of `combineMode: BusCombineMode`. Add validation to **reject invalid policies** for buses ('when: always', 'mode: error', 'mode: first').

**Acceptance Criteria**:
- [ ] Bus contracts validate `bus.combine` field (not combineMode)
- [ ] Contracts reject `{ when: 'always', ... }` for buses (compile error)
- [ ] Contracts reject `{ mode: 'error' }` for buses (compile error)
- [ ] Contracts reject `{ mode: 'first' }` for buses (compile error)
- [ ] Valid bus policies still validate correctly
- [ ] TypeScript compilation succeeds
- [ ] Validation tests pass

**Technical Notes**:
- Files:
  - src/editor/semantic/busContracts.ts (lines 20, 41, 53, 65, 77, 89, 100, 241-247, 266)
  - src/editor/semantic/busSemantics.ts (update helpers)
- New validation:
  ```typescript
  if (bus.combine.when === 'always') {
    errors.push({ kind: 'InvalidBusPolicy', msg: "Buses must use 'when: multi'" });
  }
  if (bus.combine.mode === 'error' || bus.combine.mode === 'first') {
    errors.push({ kind: 'InvalidBusCombineMode', msg: "Buses cannot use 'error' or 'first'" });
  }
  ```

---

#### Update Validator Bus Combine Mode Access

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: Bus contracts update
**Spec Reference**: design-docs/now/01-MultiBlock-Input.md §4.1 • **Status Reference**: STATUS-2026-01-01-050000.md line 172

**Description**:
Update validator.ts to access `bus.combine.mode` instead of `bus.combineMode`.

**Acceptance Criteria**:
- [ ] All 3 references updated to `bus.combine.mode`
- [ ] Validation logic unchanged
- [ ] TypeScript compilation succeeds
- [ ] Validator tests pass

**Technical Notes**:
- File: src/editor/semantic/validator.ts:445, 583, 604
- Mechanical find-replace in this file

---

### P1 (High) - Transaction System

#### Update Transaction Builder Bus Operations

**Status**: Not Started
**Effort**: Small (45 minutes)
**Dependencies**: BusStore update
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 185-188

**Description**:
Update TransactionBuilder bus creation and update operations to use `combine: CombinePolicy`.

**Acceptance Criteria**:
- [ ] createBus() accepts `combine: CombinePolicy` parameter
- [ ] updateBus() handles `combine` field changes
- [ ] Transaction operation types updated
- [ ] TypeScript compilation succeeds
- [ ] Transaction tests pass

**Technical Notes**:
- Files:
  - src/editor/kernel/TransactionBuilder.ts:218, 224
  - src/editor/kernel/types.ts:116
  - src/editor/kernel/ops.ts:94
- Update signatures and operation payloads

---

### P2 (Medium) - UI Components

#### Update BusInspector to Edit bus.combine

**Status**: Not Started
**Effort**: Medium (1 hour)
**Dependencies**: BusStore update
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 175-176

**Description**:
Update BusInspector UI component to display and edit `bus.combine.mode` instead of `bus.combineMode`. **Filter out invalid modes** ('error', 'first') and force 'when: multi'.

**Acceptance Criteria**:
- [ ] UI displays `bus.combine.mode` (unwrap from policy)
- [ ] Dropdown only shows valid bus combine modes (no 'error', no 'first')
- [ ] When updating, wrap in `{ when: 'multi', mode: selectedMode }`
- [ ] UI correctly updates bus combine mode
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test confirms dropdown works

**Technical Notes**:
- File: src/editor/BusInspector.tsx:294-295
- Pattern: Display `bus.combine.mode`, update with `{ when: 'multi', mode: newMode }`
- Filter modes: Show only BusCombineMode values (sum, average, max, min, last, layer)

---

#### Update BusChannel to Display bus.combine

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: BusStore update
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 176

**Description**:
Update BusChannel component to display `bus.combine.mode` instead of `bus.combineMode`.

**Acceptance Criteria**:
- [ ] BusChannel displays `bus.combine.mode`
- [ ] Display logic unchanged (read-only view)
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test confirms display works

**Technical Notes**:
- File: src/editor/BusChannel.tsx:183-184
- Pattern: `bus.combine.mode` (unwrap for display)

---

#### Update BusCreationDialog to Use CombinePolicy

**Status**: Not Started
**Effort**: Medium (1.5 hours)
**Dependencies**: BusStore update
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 177-182

**Description**:
Update bus creation dialog to create buses with `combine: CombinePolicy` instead of `combineMode: BusCombineMode`. Filter invalid modes from dropdown.

**Acceptance Criteria**:
- [ ] Import CombinePolicy type (not just BusCombineMode)
- [ ] Default bus types use `combine: { when: 'multi', mode: ... }` format
- [ ] State manages CombinePolicy (or just mode + wrap on create)
- [ ] Creation wraps selected mode in `{ when: 'multi', mode: selectedMode }`
- [ ] Dropdown filters out 'error' and 'first' modes
- [ ] TypeScript compilation succeeds
- [ ] Manual UI test: create bus with each valid mode

**Technical Notes**:
- File: src/editor/BusCreationDialog.tsx
- Lines: 13, 57-67, 281, 302, 360, 466
- Pattern: Store mode internally, wrap in policy on creation
- Filter: Only show BusCombineMode options in dropdown

---

### P2 (Medium) - Tests

#### Update All Bus Creation in Tests

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: All P0 and P1 tasks complete
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 189-192

**Description**:
Update all test files that create Bus objects to use new `combine: { when: 'multi', mode: ... }` syntax instead of `combineMode: 'mode'`.

**Acceptance Criteria**:
- [ ] All bus creation in tests uses CombinePolicy format
- [ ] All bus combine mode assertions updated to `bus.combine.mode`
- [ ] All tests pass with new format
- [ ] No tests skipped or disabled
- [ ] Test coverage unchanged (same assertions, new syntax)

**Technical Notes**:
- Estimated 20+ test files (STATUS says 20+)
- Example files:
  - src/editor/__tests__/bus-compilation.test.ts
  - src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts
- Pattern: `combineMode: 'sum'` → `combine: { when: 'multi', mode: 'sum' }`
- Search pattern: `combineMode:` in all test files

---

#### Add Bus Policy Validation Tests

**Status**: Not Started
**Effort**: Medium (1.5 hours)
**Dependencies**: Bus contracts update
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-050000.md line 206-214

**Description**:
Add new tests to verify that buses **reject invalid CombinePolicy** configurations (when: 'always', mode: 'error', mode: 'first').

**Acceptance Criteria**:
- [ ] Test: Bus creation rejects `{ when: 'always', mode: 'sum' }` with clear error
- [ ] Test: Bus creation rejects `{ when: 'multi', mode: 'error' }` with clear error
- [ ] Test: Bus creation rejects `{ when: 'multi', mode: 'first' }` with clear error
- [ ] Test: Valid policies still accepted (`{ when: 'multi', mode: 'sum' }`, etc.)
- [ ] Tests verify error messages are actionable
- [ ] All new tests pass

**Technical Notes**:
- Add to: src/editor/__tests__/bus-validation.test.ts (or create new file)
- Use semantic validator to test compile-time errors
- Verify BusStore.createBus also validates (if validation happens there)
- Error messages should explain why policy is invalid for buses

---

### P3 (Low) - Documentation

#### Update Bus Policy Documentation

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: All implementation complete
**Spec Reference**: N/A • **Status Reference**: N/A

**Description**:
Update any inline documentation or comments that reference Bus.combineMode to reflect the new Bus.combine field.

**Acceptance Criteria**:
- [ ] All JSDoc comments updated to reference `bus.combine`
- [ ] Code comments referencing combineMode updated
- [ ] README or architecture docs updated if they mention bus combine modes
- [ ] No references to deprecated `Bus.combineMode` field remain

**Technical Notes**:
- Search for: "combineMode" in comments and docs
- Update to: "combine.mode" or "combine policy"
- Be careful not to change Slot-related documentation (slots already use combine)

---

## Dependency Graph

```
GridDomain.ts fix (P0)
  └─> Bus interface update (P0)
       ├─> BusStore update (P0)
       │    ├─> pass7-bus-lowering (P1)
       │    ├─> compileBusAware (P1)
       │    ├─> combine-utils (P1)
       │    ├─> Bus contracts (P1)
       │    │    └─> Validator update (P1)
       │    ├─> Transaction builder (P1)
       │    ├─> BusInspector UI (P2)
       │    ├─> BusChannel UI (P2)
       │    ├─> BusCreationDialog UI (P2)
       │    └─> Test updates (P2)
       │         └─> Bus policy validation tests (P2)
       └─> Documentation updates (P3)
```

**Critical Path**: GridDomain fix → Bus interface → BusStore → All compiler/validation/UI updates → Tests

---

## Recommended Sprint Planning

### Sprint 1: Core Infrastructure (P0 items)
**Goal**: Update type definitions and core bus management
**Duration**: 2-3 hours
**Deliverables**:
1. GridDomain.ts typecheck fix
2. Bus interface using CombinePolicy
3. BusStore creating/managing buses with policies

**Exit Criteria**: TypeScript compiles, BusStore tests pass (after updating test syntax)

---

### Sprint 2: Compiler and Validation (P1 items)
**Goal**: Update all compiler passes and validation
**Duration**: 3-4 hours
**Deliverables**:
1. Pass 7 reading bus.combine.mode
2. compileBusAware updated
3. combine-utils accepting policies
4. Bus semantic contracts validating policies + rejecting invalid ones
5. Validator updated
6. Transaction builder updated

**Exit Criteria**: Full compilation pipeline works, semantic validation catches invalid policies

---

### Sprint 3: UI and Tests (P2 items)
**Goal**: Update UI components and test suite
**Duration**: 4-6 hours
**Deliverables**:
1. BusInspector editing bus.combine
2. BusChannel displaying bus.combine
3. BusCreationDialog using CombinePolicy
4. All tests updated to new bus syntax
5. New bus policy validation tests

**Exit Criteria**: All UI works, all tests pass, invalid policies rejected

---

### Sprint 4: Cleanup (P3 items)
**Goal**: Documentation and final polish
**Duration**: 30 minutes
**Deliverables**:
1. Documentation updated

**Exit Criteria**: No references to old Bus.combineMode remain

---

## Risk Assessment

### HIGH RISK Items

**Type Safety Loss**:
- **Risk**: Buses can now accept invalid CombinePolicy configurations at compile-time
- **Mitigation**: Extensive validation in bus contracts + BusStore
- **Residual Risk**: Runtime validation is less reliable than compile-time types
- **Impact**: Could allow bugs where buses use 'error' or 'first' modes

**Breaking Change**:
- **Risk**: All existing bus creation code breaks
- **Mitigation**: Systematic update of all ~35 files
- **Residual Risk**: Could miss some bus creation sites
- **Impact**: Runtime errors if we miss any sites

**Design Spec Violation**:
- **Risk**: This change contradicts design-docs/now/01-MultiBlock-Input.md §6.2
- **Mitigation**: Get explicit user confirmation before proceeding
- **Residual Risk**: Future refactors may expect buses to use BusCombineMode directly
- **Impact**: Confusion for future developers, potential need to revert

### MEDIUM RISK Items

**UI Complexity**:
- **Risk**: UI code becomes more complex (wrapping/unwrapping policies)
- **Mitigation**: Centralize policy wrapping logic
- **Impact**: More code to maintain, potential for UI bugs

**Test Maintenance**:
- **Risk**: ~20+ test files need updates
- **Mitigation**: Systematic find-replace with manual verification
- **Impact**: Could miss some tests, leading to false failures

### Investigation Needed

**Custom Combine Modes**:
- **Question**: Do we have any custom combine modes that might behave differently?
- **Investigation**: Check for `{ kind: 'custom', id: ... }` usage in bus context
- **Impact**: May need special handling for custom modes

**Event World Buses**:
- **Question**: Do buses in the 'event' world have different combine semantics?
- **Investigation**: Check if any buses have eventful types
- **Impact**: May need additional validation for event combine modes

---

## Pre-Flight Checklist

Before starting implementation:

- [ ] **User confirms intent** - Explicit confirmation to proceed despite design spec contradiction
- [ ] **Typecheck passes** - Fix GridDomain.ts error first
- [ ] **Backup created** - Commit or stash all current work
- [ ] **Design spec updated** - Update design-docs/now/01-MultiBlock-Input.md to reflect this change (or note deviation)
- [ ] **Impact understood** - Team aware this loses compile-time type safety

---

## Success Metrics

**Completion Criteria**:
- [ ] All ~35 files updated
- [ ] `just typecheck` passes
- [ ] `just test` passes (all tests)
- [ ] `just lint-fix` passes
- [ ] Manual UI test: Create bus with each mode (sum, average, max, min, last, layer)
- [ ] Manual UI test: Edit existing bus combine mode
- [ ] Semantic validator rejects invalid bus policies
- [ ] No references to `Bus.combineMode` remain (except in comments explaining change)

**Quality Gates**:
- [ ] No test coverage loss
- [ ] No new TypeScript errors
- [ ] No new ESLint errors
- [ ] All bus policy validation tests pass
- [ ] UI still responsive and correct

---

## Rollback Plan

If this change causes issues:

1. **Revert type definition**: Change `Bus.combine` back to `Bus.combineMode`
2. **Revert BusStore**: Restore direct BusCombineMode usage
3. **Revert compiler passes**: Restore `bus.combineMode` access
4. **Revert validation**: Remove policy validation, restore mode validation
5. **Revert UI**: Restore direct mode editing
6. **Revert tests**: Restore old bus creation syntax

**Estimated Revert Time**: 1-2 hours (mostly mechanical)

**Revert Trigger**: If type safety issues cause runtime bugs, or if team decides design spec should be followed

---

## Notes for Implementer

1. **Start with typecheck fix** - GridDomain.ts must pass before any Bus changes
2. **Work systematically** - Update files in dependency order (types → store → compiler → validation → UI → tests)
3. **Test incrementally** - Run typecheck after each file update
4. **Pattern consistency**: All buses use `{ when: 'multi', mode: <mode> }` - no variation
5. **Validation is critical**: Bus policy validation must be comprehensive (reject 'always', 'error', 'first')
6. **UI filtering**: Dropdown must not show invalid modes to users
7. **Consider a helper**: `function busCombinePolicy(mode: BusCombineMode): CombinePolicy { return { when: 'multi', mode }; }`
8. **Search thoroughly**: Use `git grep "combineMode"` to find all references
9. **Test manually**: UI changes need manual verification with Chrome DevTools MCP
10. **Update incrementally**: Don't try to update all 35 files at once - do it in logical groups

---

## Open Questions

1. Should we add a type alias `BusCombinePolicy = { when: 'multi'; mode: BusCombineMode }` to make this more explicit?
2. Should BusStore.createBus validate the policy, or rely on semantic validator?
3. Should we deprecate BusCombineMode type entirely, or keep it for validation?
4. Do we need migration code for any serialized patches with old combineMode field?
5. Should we update the design spec to reflect this change, or note it as a deviation?

---

## Summary

This plan provides a systematic approach to unifying Bus.combineMode → Bus.combine (CombinePolicy), but **strongly recommends pausing for user confirmation** due to:
1. Design spec contradiction
2. Type safety loss
3. Added complexity with no functional benefit

The plan is complete and actionable, but should only proceed with explicit user approval.
