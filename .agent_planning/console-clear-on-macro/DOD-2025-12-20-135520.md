# Definition of Done: HooksSystem for Console Clear on Macro

**Generated**: 2025-12-20-135520
**Plan**: PLAN-2025-12-20-135520.md
**Topic**: console-clear-on-macro
**Revision**: v2 (HooksSystem approach)

---

## Acceptance Criteria

### [P0] Implement HooksSystem Core Infrastructure
- [ ] Create `src/editor/HooksSystem.ts` with HooksSystem class
- [ ] `registerHook(name: string, signature?: string): void` - Define a hook exists
- [ ] `addHandler(hookName: string, handler: Function): () => void` - Add handler, returns cleanup function
- [ ] `addHandler` throws error immediately if hook not registered
- [ ] `trigger(hookName: string, ...args: unknown[]): void | Promise<void>` - Execute all handlers
- [ ] Support both sync and async handlers
- [ ] Handlers execute in registration order
- [ ] Export singleton instance `hooksSystem`
- [ ] TypeScript compilation succeeds (`just typecheck`)

### [P1] Register 'onExpandMacro' Hook in PatchStore
- [ ] Import `hooksSystem` in `src/editor/stores/PatchStore.ts`
- [ ] Register 'onExpandMacro' hook in PatchStore constructor
- [ ] Trigger 'onExpandMacro' at end of `expandMacro()` method (after all blocks/connections created)
- [ ] Pass context object with expansion details: `{ macroType: string, blockCount: number }`
- [ ] TypeScript compilation succeeds (`just typecheck`)

### [P2] Add LogStore Handler for 'onExpandMacro'
- [ ] Import `hooksSystem` in `src/editor/logStore.ts`
- [ ] Add handler for 'onExpandMacro' in LogStore constructor
- [ ] Handler checks `this.autoClearOnMacro` before calling `this.clear()`
- [ ] Store cleanup function for handler removal (testing/lifecycle)
- [ ] TypeScript compilation succeeds (`just typecheck`)

### [P3] Add HooksSystem Tests
- [ ] Create test file `src/editor/__tests__/HooksSystem.test.ts`
- [ ] Test case: registerHook() creates a hook
- [ ] Test case: addHandler() throws error for unregistered hook
- [ ] Test case: trigger() executes all handlers in order
- [ ] Test case: Cleanup function removes handler
- [ ] Test case: Async handlers are awaited
- [ ] Test case: Multiple handlers for same hook all execute
- [ ] Test case: Context parameter passed to handlers
- [ ] All tests pass (`just test`)

### [P4] Add Integration Tests for Macro Log Clearing
- [ ] Create test file `src/editor/__tests__/macro-log-clear.test.ts`
- [ ] Test case: Logs cleared when `autoClearOnMacro = true` during macro expansion
- [ ] Test case: Logs preserved when `autoClearOnMacro = false` during macro expansion
- [ ] Test case: Setting toggle persists across multiple macro expansions
- [ ] Test verifies hook context includes macro details
- [ ] All tests pass (`just test`)

### [P5] Manual Smoke Test
- [ ] Open app, add multiple log entries manually (click "Test Log" buttons or trigger compiler errors)
- [ ] Load a macro from preset library (e.g., "Breathing Constellation")
- [ ] Verify logs are cleared when auto-clear is enabled (default)
- [ ] Disable "Auto-clear" checkbox in LogWindow
- [ ] Load macro again, verify logs are preserved
- [ ] Re-enable "Auto-clear", load macro, verify logs cleared again
- [ ] No console errors or warnings

---

## Sprint Scope

**This sprint delivers**:
1. HooksSystem infrastructure for decoupled component communication
2. 'onExpandMacro' hook registration and triggering in PatchStore
3. LogStore handler to clear console logs on macro expansion (respecting autoClearOnMacro setting)

**Deferred**:
- Additional hooks beyond 'onExpandMacro' (future work)
- Hook introspection UI (debugging feature, not MVP)
- Persistent auto-clear setting across sessions

---

## Validation Checklist

### Code Changes
- [ ] `src/editor/HooksSystem.ts` created with core API
- [ ] `src/editor/stores/PatchStore.ts` modified to register and trigger 'onExpandMacro'
- [ ] `src/editor/logStore.ts` modified to add handler for 'onExpandMacro'

### Tests
- [ ] `src/editor/__tests__/HooksSystem.test.ts` created with 8+ test cases
- [ ] `src/editor/__tests__/macro-log-clear.test.ts` created with 3+ integration tests

### Quality Gates
- [ ] Type safety: `just typecheck` passes
- [ ] Test suite: `just test` passes
- [ ] Manual verification: Smoke test completed successfully
- [ ] No regressions: Existing functionality unaffected
- [ ] No direct coupling: PatchStore and LogStore remain decoupled

### Architecture Validation
- [ ] HooksSystem errors immediately on invalid hook usage
- [ ] Cleanup functions work correctly (handlers can be removed)
- [ ] Async handlers are properly awaited
- [ ] Hook context is passed to handlers correctly
- [ ] No memory leaks from handler registration

---

## Final Success Criteria

**The feature is complete when**:
1. User can toggle "Auto-clear on macro load" in LogWindow UI
2. When enabled (default), loading a macro clears the log console
3. When disabled, loading a macro preserves existing logs
4. No direct import/dependency between PatchStore and LogStore
5. HooksSystem is robust and tested (error on invalid usage)
6. All tests pass and manual smoke test succeeds
