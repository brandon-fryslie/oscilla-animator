# Evaluation: Console Clear on Macro Load
Timestamp: 2025-12-20-040000
Confidence: FRESH
Git Commit: c69c1fa
Files in Scope: 3

## Scope
Feature: Auto-clear log console when a macro is expanded

## What Exists

### Log System (COMPLETE)
**File**: `src/editor/logStore.ts`
- **Status**: COMPLETE
- **Evidence**: Lines 42-43, 196-199, 251-253
- **Functionality**:
  - Observable `autoClearOnMacro: boolean = true` (default enabled)
  - `clear(): void` method that resets entries and ID counter
  - `setAutoClearOnMacro(enabled: boolean)` to toggle the setting

**Assessment**: Log system is fully functional with clean state management.

### Log UI (COMPLETE)
**File**: `src/editor/LogWindow.tsx`
- **Status**: COMPLETE
- **Evidence**: Lines 139-150
- **Functionality**:
  - UI checkbox for "Auto-clear" setting (line 144-149)
  - Checkbox bound to `logStore.autoClearOnMacro`
  - Calls `logStore.setAutoClearOnMacro()` on change
  - Manual clear button also present (line 151-153)

**Assessment**: UI correctly exposes the auto-clear setting and manual clear.

### Macro Expansion (COMPLETE)
**File**: `src/editor/stores/PatchStore.ts`
- **Status**: COMPLETE
- **Evidence**: Lines 229-320
- **Functionality**:
  - `expandMacro(expansion: MacroExpansion): BlockId` method
  - Clears patch (line 231): `this.root.clearPatch()`
  - Creates blocks, connections, bus publishers/listeners
  - Returns first block ID

**Assessment**: Entry point for macro expansion is clear and well-defined.

## What's Missing

### MISSING: Hook to Clear Logs on Macro Expansion
**Status**: NOT_STARTED
**Required**: Add conditional log clear in `PatchStore.expandMacro()`
**Location**: `src/editor/stores/PatchStore.ts` line 229-232 (after `clearPatch()`)

**Implementation Pattern**:
```typescript
expandMacro(expansion: MacroExpansion): BlockId {
  // Clear the patch first - macros replace everything
  this.root.clearPatch();

  // NEW: Clear logs if auto-clear enabled
  if (this.root.logStore?.autoClearOnMacro) {
    this.root.logStore.clear();
  }

  // ... rest of expansion
}
```

### MISSING: LogStore Integration in RootStore
**Status**: NOT_STARTED
**Required**: Add `logStore: LogStore` to RootStore
**Location**: `src/editor/stores/RootStore.ts`

**Current State**: LogStore exists as singleton (`src/editor/logStore.ts:260`)
**Issue**: RootStore does not reference LogStore (lines 1-182 checked)

**Implementation Pattern**:
```typescript
// In RootStore.ts imports
import { LogStore } from '../logStore';

export class RootStore {
  patchStore: PatchStore;
  busStore: BusStore;
  uiStore: UIStateStore;
  compositeStore: CompositeStore;
  logStore: LogStore;  // NEW

  constructor() {
    this.patchStore = new PatchStore(this);
    this.busStore = new BusStore(this);
    this.uiStore = new UIStateStore(this);
    this.compositeStore = new CompositeStore(this);
    this.logStore = new LogStore();  // NEW
    // ...
  }
}
```

**Alternative**: If singleton pattern is intentional, import singleton:
```typescript
import { logStore } from '../logStore';

// In expandMacro:
if (logStore.autoClearOnMacro) {
  logStore.clear();
}
```

## Data Flow Verification

| Flow | Input | Process | Store | Retrieve | Display |
|------|-------|---------|-------|----------|---------|
| Auto-clear setting | ✅ UI checkbox | ✅ LogStore setter | ✅ Observable | ✅ Checkbox reads | ✅ UI renders |
| Manual clear | ✅ Button click | ✅ LogStore.clear() | ✅ Entries reset | ✅ UI observes | ✅ Empty log |
| Macro expansion | ❌ Not hooked | - | - | - | - |

**Issue**: Macro expansion flow not connected to log clearing logic.

## Implementation Risks

### Risk: LogStore Singleton vs. RootStore Integration
**Current State**: LogStore is singleton (`export const logStore = new LogStore()`)
**Decision Needed**: Should LogStore be:
1. **Integrated into RootStore** (like other stores) - Better for consistency
2. **Keep as singleton** - Current pattern, simpler

**Impact**: LOW - Either approach works, just needs consistency check

**Recommendation**: Keep singleton pattern (less churn). It's already used directly in LogWindow.tsx line 10.

### Risk: Side Effects of Clearing Logs
**Concern**: What if user is debugging and macro load clears important errors?
**Mitigation**: Already handled - `autoClearOnMacro` is user-configurable (default: true, but can be toggled off)

**Impact**: NONE - User has control

### Risk: Timing - Clear Before or After Expansion?
**Current**: `clearPatch()` called first (line 231), then blocks created
**Proposed**: Clear logs immediately after `clearPatch()`

**Reasoning**:
- Clearing patch may generate logs (block removal, connection cleanup)
- Those logs should be cleared too
- Fresh macro expansion should start with clean log state

**Impact**: NONE - Correct order is "clear patch, clear logs, expand macro"

## Test Suite Assessment

**Existing Tests**: None found for macro expansion logging behavior

**Missing Tests** (implementer should create):
1. **Auto-clear integration test** (`src/editor/__tests__/macro-log-clear.test.ts`)
   - Verify logs cleared when `autoClearOnMacro = true`
   - Verify logs preserved when `autoClearOnMacro = false`
   - Verify setting persists across macro expansions

**Coverage Gap**: No test coverage for log clearing on macro expansion (feature doesn't exist yet)

## Known LLM Blind Spots Check

- [x] **State persistence**: `autoClearOnMacro` is observable and persists
- [x] **Second run**: Log clearing is idempotent (safe to call multiple times)
- [x] **Concurrent access**: Not applicable (single-user editor)
- [x] **Error messages**: Clear action is silent (no error cases)
- [x] **Edge cases**: Empty log can be cleared (no-op, safe)

**Assessment**: No blind spot issues for this feature.

## Ambiguities Found

NONE - Requirements are crystal clear from existing code structure.

## Recommendations

### Priority 1: Integrate LogStore into RootStore (OPTIONAL)
**Rationale**: If following consistent store pattern
**Alternative**: Use existing singleton (recommended - less churn)

### Priority 2: Add Log Clear Hook to Macro Expansion (REQUIRED)
**File**: `src/editor/stores/PatchStore.ts`
**Location**: Line 231 (after `clearPatch()`)
**Code**:
```typescript
// Import at top if using singleton
import { logStore } from '../logStore';

// In expandMacro method (line 231)
if (logStore.autoClearOnMacro) {
  logStore.clear();
}
```

### Priority 3: Add Test Coverage (RECOMMENDED)
**Test file**: `src/editor/__tests__/macro-log-clear.test.ts`
**Test cases**:
- Logs cleared when autoClearOnMacro = true
- Logs preserved when autoClearOnMacro = false
- Setting toggle works correctly

## Persistent Runtime Checks

### Existing Checks (run these):
| Check Command | Purpose | Status |
|---------------|---------|--------|
| `just test` | Unit tests | N/A (no tests for this yet) |
| `just typecheck` | Type checking | Should pass after changes |

### Missing Checks (implementer should create):
1. **Manual smoke test**:
   - Open app, add log entries
   - Load a macro (e.g., from preset library)
   - Verify logs cleared
   - Disable "Auto-clear" checkbox
   - Load macro again
   - Verify logs preserved

2. **Unit test** (as described in Priority 3)

## Verdict

- [x] **CONTINUE** - Implementation path is clear and simple
- [ ] PAUSE - No ambiguities need clarification

**Next Steps**:
1. Decision: Use singleton logStore or integrate into RootStore (recommend: singleton)
2. Add 3-line hook to `PatchStore.expandMacro()` to call `logStore.clear()`
3. Add test coverage for new behavior
4. Manual smoke test to verify UX

**Complexity**: TRIVIAL (3-line change + test)
**Risk**: NONE (user-configurable, non-breaking)
**Dependencies**: NONE (all infrastructure exists)
