# Event System Phase D - Implementation Plan

**Generated**: 2025-12-20-161838
**Source**: STATUS-2025-12-20-161838.md
**Phase**: D (BlockReplaced event + final PatchStore decoupling)

---

## Executive Summary


**Current State**:
- 13 events implemented across Phases A-C
- PatchStore 95% decoupled from UIStateStore
- One remaining coupling: `replaceBlock()` directly mutates `uiStore.selectedBlockId` (lines 516-517)

**Gap**:
- Missing `BlockReplaced` event definition
- Direct UIStore mutation still present in PatchStore

**Outcome**:
- Zero direct cross-store mutations in PatchStore
- Full event-driven architecture for patch/bus domain stores
- Complete audit trail for block lifecycle operations

**Effort**: ~2 hours (high confidence, proven pattern)

---

## Backlog by Priority

### P0 (Critical) - Core Event System Completion

#### P0-1: Define BlockReplaced Event

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: None
**Spec Reference**: Event system architecture pattern (STATUS lines 45-80) • **Status Reference**: STATUS-2025-12-20-161838.md lines 38-56

##### Description
Define the `BlockReplaced` event interface in `src/editor/events/types.ts` following the established event pattern. This event represents a block being replaced with a different block type while preserving compatible connections.

##### Acceptance Criteria (REQUIRED)
- [ ] `BlockReplacedEvent` interface defined in `src/editor/events/types.ts`
- [ ] Event includes: `type: 'BlockReplaced'`, `oldBlockId`, `oldBlockType`, `newBlockId`, `newBlockType`
- [ ] Event includes connection metrics: `preservedConnections: number`, `droppedConnections: Array<{from: string; to: string}>`
- [ ] Event added to `EditorEvent` discriminated union type
- [ ] JSDoc comments document emission point (`PatchStore.replaceBlock()`), timing (after state changes), and payload structure

##### Technical Notes
- Follow exact pattern from `BlockAddedEvent` and `BlockRemovedEvent`
- Payload must include enough data to reconstruct the replacement operation (undo/redo support)
- Connection metrics come from existing `mapping` object in `replaceBlock()`
- Event emitted AFTER both new block creation and old block removal

---

#### P0-2: Emit BlockReplaced Event

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: P0-1 (event definition)
**Spec Reference**: Event emission pattern (STATUS lines 95-119) • **Status Reference**: STATUS-2025-12-20-161838.md lines 89-102

##### Description
Add event emission to `PatchStore.replaceBlock()` immediately before returning the replacement result. Event should only be emitted on successful replacements.

##### Acceptance Criteria (REQUIRED)
- [ ] `this.root.events.emit()` call added at end of `replaceBlock()` (after line 525)
- [ ] Event only emitted when `success: true` (not emitted on early returns/failures)
- [ ] Event payload populated from local variables: `oldBlockId`, `oldBlock.type`, `newBlockId`, `newBlockType`
- [ ] Connection metrics populated from `mapping.preserved.length` and `mapping.dropped`
- [ ] Emission occurs AFTER all state changes (new block created, old block removed)

##### Technical Notes
- Add emit call immediately before `return { success: true, ... }` statement (line 520-526)
- Use existing `mapping` variable for connection metrics
- Pattern identical to `BlockRemoved` event emission (lines 402-407)
- No error handling needed - events are synchronous and non-blocking

---


**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: P0-1 (event definition)

##### Description

##### Acceptance Criteria (REQUIRED)

##### Technical Notes
- Pattern: `this.events.on('BlockReplaced', (event) => { if (...) { ... } })`
- Use `this.uiStore.selectBlock(event.newBlockId)` for selection update (maintains existing method)
- No error handling needed - event payload guaranteed valid by PatchStore

---

#### P0-4: Remove Direct UIStore Mutation

**Status**: Not Started
**Effort**: Trivial (5 minutes)
**Spec Reference**: Decoupling requirement (STATUS lines 38-48) • **Status Reference**: STATUS-2025-12-20-161838.md lines 38-48

##### Description

##### Acceptance Criteria (REQUIRED)
- [ ] Lines 516-517 deleted from `PatchStore.replaceBlock()`
- [ ] Comment removed: "Update selection to new block"
- [ ] No direct `this.root.uiStore` references remain in `PatchStore.replaceBlock()`
- [ ] Grep for `this.root.uiStore` in PatchStore.ts returns zero matches
- [ ] UX unchanged: selection still follows block replacement (verified via integration test)

##### Technical Notes
- Delete these exact lines:
  ```typescript
  // Update selection to new block
  if (this.root.uiStore.uiState.selectedBlockId === oldBlockId) {
    this.root.uiStore.selectBlock(newBlockId);
  }
  ```
- Verify no other `this.root.uiStore` references in PatchStore (should be clean)
- This completes PatchStore decoupling milestone

---

### P1 (High) - Test Coverage

#### P1-1: Unit Tests for BlockReplaced Event

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P0-1, P0-2 (event definition and emission)
**Spec Reference**: Test coverage requirements (STATUS lines 311-327) • **Status Reference**: STATUS-2025-12-20-161838.md lines 289-309

##### Description
Add unit tests in `src/editor/stores/__tests__/PatchStore.events.test.ts` to verify `BlockReplaced` event emission with correct payload structure and timing.

##### Acceptance Criteria (REQUIRED)
- [ ] Test: `replaceBlock()` emits `BlockReplaced` event on success
- [ ] Test: Event payload includes correct `oldBlockId`, `oldBlockType`, `newBlockId`, `newBlockType`
- [ ] Test: Event payload includes correct connection metrics (`preservedConnections`, `droppedConnections`)
- [ ] Test: Event NOT emitted when replacement fails (early return)
- [ ] Test: Event emitted AFTER state changes (new block exists in store)
- [ ] All tests pass in isolation and with full suite

##### Technical Notes
- Follow existing event test pattern from `PatchStore.events.test.ts`
- Use `eventCapture` helper to verify event emission
- Test both successful and failed replacement scenarios
- Verify connection metrics by comparing with `replaceBlock()` return value

---

#### P1-2: Integration Tests for Selection Update

**Status**: Not Started
**Effort**: Small (30 minutes)
**Spec Reference**: Integration test requirements (STATUS lines 311-327) • **Status Reference**: STATUS-2025-12-20-161838.md lines 289-309

##### Description

##### Acceptance Criteria (REQUIRED)
- [ ] Test: Replacing selected block updates `uiStore.selectedBlockId` to new block ID
- [ ] Test: Replacing non-selected block preserves existing selection
- [ ] Test: Selection update occurs synchronously (no race conditions)
- [ ] Test: Multiple replacements in sequence maintain selection correctly
- [ ] All tests pass in isolation and with full suite

##### Technical Notes
- Replace a selected block and verify `uiStore.selectedBlockId` updated
- Replace a non-selected block and verify selection unchanged

---

## Dependency Graph

```
P0-1 (Define Event)
  ├─> P0-2 (Emit Event)
  │     └─> P0-4 (Remove Mutation)
  │           └─> P1-2 (Integration Tests)
        └─> P0-4 (Remove Mutation)
              └─> P1-2 (Integration Tests)

P0-2 (Emit Event)
  └─> P1-1 (Unit Tests)
```

**Critical Path**: P0-1 → P0-2 → P0-4 → P1-2 (all others can run in parallel after P0-1)

---

## Recommended Sprint Planning

### Sprint 1: Core Implementation (1.5 hours)
**Goal**: Implement BlockReplaced event and eliminate coupling

**Deliverables**:
1. P0-1: Define BlockReplaced event (15 min)
2. P0-2: Emit event in replaceBlock() (15 min)
4. P0-4: Remove direct UIStore mutation (5 min)
5. **Manual verification**: Replace a block in UI, verify selection follows


---

### Sprint 2: Test Coverage (1 hour)

**Deliverables**:
1. P1-1: Unit tests for event emission (30 min)
2. P1-2: Integration tests for selection update (30 min)

**Acceptance**: All tests pass, coverage includes edge cases

---

## Risk Assessment

### Low Risk Items
- **P0-1, P0-2, P0-3**: Identical pattern to Phase C (WireAdded/WireRemoved) - Very High Confidence
- **P0-4**: Simple deletion - Zero risk
- **P1-1, P1-2**: Standard test patterns - Low complexity

### No High-Risk Items
- All work follows proven patterns from Phases A-C
- No architectural unknowns
- No external dependencies

### Mitigation Strategies
- **If event payload wrong**: Compare with existing `BlockRemoved` event pattern, verify field names

---

## Phase D Completion Checklist

**Implementation**:
- [ ] `BlockReplacedEvent` defined in `src/editor/events/types.ts`
- [ ] Event added to `EditorEvent` union type
- [ ] `PatchStore.replaceBlock()` emits `BlockReplaced` event
- [ ] Lines 516-517 removed from `PatchStore.replaceBlock()`

**Verification**:
- [ ] `grep -n "this.root.uiStore" src/editor/stores/PatchStore.ts` returns 0 matches
- [ ] Unit tests pass: event emission, payload structure
- [ ] Integration tests pass: selection update scenarios
- [ ] Manual test: Replace selected block in UI, selection follows
- [ ] Manual test: Replace non-selected block, selection unchanged

**Documentation**:
- [ ] JSDoc comments on `BlockReplacedEvent` interface

---

## Post-Phase D Roadmap

### Immediate Next Steps (Tier 1 - High Value)

**BlockParamsUpdated Event** (Estimated: 2-3 hours)
- **Priority**: Medium-High
- **Value**: Enables undo/redo for parameter changes
- **Trigger**: `PatchStore.updateBlockParams()`
- **Payload**: `{ blockId, changedParams, oldValues, newValues }`
- **Complexity**: Medium (need to capture old values before mutation)
- **Recommendation**: Consider for next phase if undo/redo becomes priority

**TimeRootChanged Event** (Estimated: 3-4 hours)
- **Priority**: High (for runtime architecture)
- **Value**: Player can reconfigure time model reactively
- **Trigger**: When TimeRoot block replaced or params changed
- **Payload**: `{ timeModel: TimeModel }`
- **Complexity**: Medium (needs TimeRoot detection + TimeModel extraction)
- **Recommendation**: Critical for proper runtime/player coordination

---

### Optional Events (Tier 2 - Medium Value)

**PlaybackStarted/PlaybackStopped Events** (Estimated: 1 hour)
- **Priority**: Low
- **Value**: Telemetry, analytics, external integrations
- **Trigger**: `UIStateStore.play()`, `UIStateStore.pause()`
- **Payload**: `{ timestamp: number, currentTime: number }`
- **Complexity**: Trivial
- **Recommendation**: Add if analytics/telemetry needed

**CompileStarted Event** (Estimated: 30 minutes)
- **Priority**: Low
- **Value**: Loading indicators, performance tracking
- **Trigger**: Beginning of `CompilerService.compile()`
- **Payload**: `{ blockCount: number, connectionCount: number }`
- **Complexity**: Trivial
- **Recommendation**: Add if loading UX becomes important

---

### Low-Priority Events (Tier 3 - Defer)

**Logging Events** (Estimated: 2-3 hours)
- **Priority**: Very Low
- **Value**: Complete LogStore decoupling
- **Events**: `LogDebug`, `LogInfo`, `LogWarn`, `LogError`
- **Complexity**: Medium (replace ~10 call sites)
- **Recommendation**: **DEFER** - Logging is cross-cutting concern, direct access acceptable

**DiagnosticAdded/DiagnosticCleared Events** (Estimated: 4-6 hours)
- **Priority**: Very Low
- **Value**: External error tracking, IDE integration
- **Blocker**: No diagnostic state system exists yet
- **Complexity**: High (needs infrastructure first)
- **Recommendation**: **DEFER** - Implement diagnostic state first if needed

**Selection Change Events** (Estimated: 1 hour)
- **Priority**: Very Low
- **Value**: Analytics, external UI coordination
- **Payload**: `{ oldBlockId, newBlockId, source: 'user' | 'event' }`
- **Complexity**: Low
- **Recommendation**: **DEFER** - MobX reactivity already sufficient

---

## Quality Standards

### Event Definition Standards
- All events must be interfaces (not types)
- All events must have discriminant `type` field
- All events must be added to `EditorEvent` union
- All events must have JSDoc comments documenting:
  - Purpose
  - Emission point (which method emits it)
  - Timing (before/after state changes)
  - Payload field meanings

### Event Emission Standards
- Events emitted AFTER state changes committed
- Events only emitted on success (not on early returns/failures)
- Event payloads must be plain data objects (no methods, no store references)
- Events must be synchronous (no async emit)


### Test Coverage Standards
- Every event must have unit test for emission
- Every event must have unit test for payload correctness
- Edge cases must be tested (failure cases, no-op cases)

---

## Success Metrics

**Quantitative**:
- Event count: 13 → 14 (BlockReplaced added)
- PatchStore UIStore references: 1 → 0 (coupling eliminated)
- Test coverage: +6 test cases (unit + integration)

**Qualitative**:
- **Full PatchStore decoupling achieved** (major architectural milestone)
- Event-driven architecture pattern complete for patch/bus domain
- Undo/redo infrastructure ready (all block operations have events)
- Collaboration infrastructure ready (all state changes observable)

---

## Effort Summary

| Task | Effort | Confidence |
|------|--------|------------|
| P0-1: Define Event | 15 min | Very High |
| P0-2: Emit Event | 15 min | Very High |
| P0-4: Remove Mutation | 5 min | Very High |
| P1-1: Unit Tests | 30 min | High |
| P1-2: Integration Tests | 30 min | High |
| **Total** | **~2 hours** | **Very High** |

**Recommended Approach**: Complete P0-1 through P0-4 in a single session (1 hour), then add tests in a separate session (1 hour). This allows manual verification of UX before writing tests.

---

## Blockers and Questions

**None identified** - All requirements clear, pattern proven, dependencies minimal.

Phase D is ready for immediate implementation.
