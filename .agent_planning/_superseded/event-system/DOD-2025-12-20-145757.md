# Definition of Done: Event System Phase B

**Generated**: 2025-12-20-145757
**Plan**: PLAN-2025-12-20-145757.md
**Design Doc**: design-docs/4-Event-System/1-Events.md

---

## Sprint Scope

This sprint delivers **2 deliverables** from P0:
1. Bus Binding Events (BindingAdded, BindingRemoved)
2. Bus Lifecycle Events (BusCreated, BusDeleted)

**Deferred**: Connection events (P1), selection decoupling (P2), logging (P2), params/playback events (P3)

---

## Acceptance Criteria

### Deliverable 1: Bus Binding Events

#### Event Type Definitions
- [ ] `BindingAddedEvent` type defined in `src/editor/events/types.ts`
  - Includes: `bindingId`, `busId`, `blockId`, `port`, `direction: 'publish' | 'subscribe'`
- [ ] `BindingRemovedEvent` type defined in `src/editor/events/types.ts`
  - Includes: `bindingId`, `busId`, `blockId`, `port`, `direction: 'publish' | 'subscribe'`
- [ ] Both events added to `EditorEvent` discriminated union

#### Event Emission
- [ ] Event payloads include all required fields (bindingId, busId, blockId, port, direction)

#### Testing
- [ ] Unit test: Event direction field correctly distinguishes publish vs subscribe

---

### Deliverable 2: Bus Lifecycle Events

#### Event Type Definitions
- [ ] `BusCreatedEvent` type defined in `src/editor/events/types.ts`
  - Includes: `busId`, `name`, `type: TypeDescriptor`
- [ ] `BusDeletedEvent` type defined in `src/editor/events/types.ts`
  - Includes: `busId`, `name`
- [ ] Both events added to `EditorEvent` discriminated union

#### Event Emission
- [ ] `BusStore.createBus()` emits `BusCreated` AFTER bus added to store
- [ ] `BusStore.deleteBus()` emits `BusDeleted` BEFORE bus removed (so event has bus data)
- [ ] Event payloads include all required fields

#### Decoupling
- [ ] Direct mutation of `uiStore.uiState.selectedBusId` removed from `BusStore.deleteBus()` (line 153-154)
- [ ] Zero imports of UIStateStore in BusStore.ts (verified by grep)

#### Testing
- [ ] Unit test: `createBus()` emits `BusCreated` with correct payload
- [ ] Unit test: `deleteBus()` emits `BusDeleted` with correct payload
- [ ] Integration test: Deleting selected bus clears `uiStore.selectedBusId`
- [ ] Integration test: Deleting non-selected bus preserves `uiStore.selectedBusId`
- [ ] Integration test: Default buses created at startup emit `BusCreated` events

---

## Code Quality Checks

### Event System Invariants
- [ ] All events emitted AFTER state changes committed (or BEFORE for deletion events)
- [ ] Event handlers do not mutate domain store state (only UI state)
- [ ] Event payloads are plain data objects (no methods, no store references)

### Documentation
- [ ] New event types have TSDoc comments describing when/why they're emitted
- [ ] Event comments include "Emitted by:" and "When:" sections
- [ ] `EditorEvent` union type updated with new events

### Testing
- [ ] All new event emissions covered by unit tests
- [ ] Integration tests verify cross-store coordination works
- [ ] No regressions in existing event tests (MacroExpanded, BlockAdded, etc.)

---

## Integration Checks

### Build and Type Safety
- [ ] `just typecheck` passes with no errors
- [ ] `just build` completes successfully
- [ ] No new linter warnings introduced

### Test Suite
- [ ] `just test` passes all tests
- [ ] New tests added to appropriate test files:
  - `src/editor/events/__tests__/events.test.ts` (event emission)
  - `src/editor/stores/__tests__/BusStore.test.ts` (bus events)

### Manual Testing
- [ ] Create a new bus → `BusCreated` event visible in console (if logging enabled)
- [ ] Delete a bus → `BusDeleted` event visible, selection cleared if bus was selected
- [ ] Macro expansion → Multiple `BindingAdded` events for auto-bus connections

---

## Definition of "Done"

This sprint is **DONE** when:

1. All acceptance criteria checkboxes above are checked
2. All code quality checks pass
3. All integration checks pass
4. All tests pass (`just test`)
5. Type checking passes (`just typecheck`)
6. Code reviewed (self-review against design doc principles)

---

## Out of Scope (Deferred to Future Sprints)

The following are explicitly **NOT** included in this sprint:

- ConnectionAdded/ConnectionRemoved events (P1)
- BlockParamsUpdated event (P3)
- PlaybackStarted/PlaybackStopped events (P3)
- Removing UIStore mutation from PatchStore.removeBlock() (P2)
- Converting compilation logging to events (P2)
- DiagnosticAdded/DiagnosticCleared events (future)
- Selection change events (future, may not be needed)

These remain in the backlog for future sprints.
