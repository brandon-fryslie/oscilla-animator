# Definition of Done: Event System Phase D

**Generated**: 2025-12-20-161838
**Plan**: PLAN-2025-12-20-161838.md
**Source**: STATUS-2025-12-20-161838.md

---

## Acceptance Criteria

### P0-1: Define BlockReplaced Event
- [ ] `BlockReplacedEvent` interface defined in `src/editor/events/types.ts`
- [ ] Event includes: `type: 'BlockReplaced'`, `oldBlockId`, `oldBlockType`, `newBlockId`, `newBlockType`
- [ ] Event includes connection metrics: `preservedConnections: number`, `droppedConnections: Array<{from: string; to: string}>`
- [ ] Event added to `EditorEvent` discriminated union type
- [ ] JSDoc comments document emission point (`PatchStore.replaceBlock()`), timing (after state changes), and payload structure

### P0-2: Emit BlockReplaced Event
- [ ] `this.root.events.emit()` call added at end of `replaceBlock()` (after line 525)
- [ ] Event only emitted when `success: true` (not emitted on early returns/failures)
- [ ] Event payload populated from local variables: `oldBlockId`, `oldBlock.type`, `newBlockId`, `newBlockType`
- [ ] Connection metrics populated from `mapping.preserved.length` and `mapping.dropped`
- [ ] Emission occurs AFTER all state changes (new block created, old block removed)


### P0-4: Remove Direct UIStore Mutation
- [ ] Lines 516-517 deleted from `PatchStore.replaceBlock()`
- [ ] Comment removed: "Update selection to new block"
- [ ] No direct `this.root.uiStore` references remain in `PatchStore.replaceBlock()`
- [ ] Grep for `this.root.uiStore` in PatchStore.ts returns zero matches
- [ ] UX unchanged: selection still follows block replacement (verified via integration test)

### P1-1: Unit Tests for BlockReplaced Event
- [ ] Test: `replaceBlock()` emits `BlockReplaced` event on success
- [ ] Test: Event payload includes correct `oldBlockId`, `oldBlockType`, `newBlockId`, `newBlockType`
- [ ] Test: Event payload includes correct connection metrics (`preservedConnections`, `droppedConnections`)
- [ ] Test: Event NOT emitted when replacement fails (early return)
- [ ] Test: Event emitted AFTER state changes (new block exists in store)
- [ ] All tests pass in isolation and with full suite

### P1-2: Integration Tests for Selection Update
- [ ] Test: Replacing selected block updates `uiStore.selectedBlockId` to new block ID
- [ ] Test: Replacing non-selected block preserves existing selection
- [ ] Test: Selection update occurs synchronously (no race conditions)
- [ ] Test: Multiple replacements in sequence maintain selection correctly
- [ ] All tests pass in isolation and with full suite

---

## Sprint Scope

**This sprint delivers**:
1. `BlockReplaced` event definition and emission
2. Event-driven selection update for block replacement
3. Complete PatchStore decoupling from UIStateStore

**Deferred to future phases**:
- BlockParamsUpdated event (param change tracking)
- TimeRootChanged event (runtime coordination)
- PlaybackStarted/PlaybackStopped events (telemetry)
- Logging events (LogStore decoupling)

---

## Phase D Completion Checklist

### Implementation
- [ ] `BlockReplacedEvent` defined in `src/editor/events/types.ts`
- [ ] Event added to `EditorEvent` union type
- [ ] `PatchStore.replaceBlock()` emits `BlockReplaced` event
- [ ] Lines 516-517 removed from `PatchStore.replaceBlock()`

### Verification
- [ ] `grep -n "this.root.uiStore" src/editor/stores/PatchStore.ts` returns 0 matches
- [ ] Unit tests pass: event emission, payload structure
- [ ] Integration tests pass: selection update scenarios
- [ ] Manual test: Replace selected block in UI, selection follows
- [ ] Manual test: Replace non-selected block, selection unchanged

### Documentation
- [ ] JSDoc comments on `BlockReplacedEvent` interface

---

## Success Criteria

**Phase D is complete when**:
1. All acceptance criteria checked off
2. All tests pass (`just test`)
3. Zero direct cross-store mutations in PatchStore (verified via grep)
4. UX unchanged: selection behavior identical to pre-Phase D

**Architectural Milestone Achieved**: PatchStore fully decoupled from UIStateStore
