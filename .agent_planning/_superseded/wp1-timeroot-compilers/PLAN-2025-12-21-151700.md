# WP1: TimeRoot Compilers - Implementation Plan

**Generated**: 2025-12-21-151700
**Source STATUS**: STATUS-20251221-133500.md
**Topic**: wp1-timeroot-compilers
**Current State**: 85% complete - missing wrap events, energy output, and auto-publication

---

## Executive Summary

WP1 is substantially complete with all three TimeRoot block compilers working correctly. The remaining work focuses on implementing the **TimeOutputs bundle** (standardized outputs including wrap events and energy), adding **auto-publication** to canonical buses (phaseA, pulse, energy), and formalizing **WP0 contract validation** to prevent unsafe auto-publications.

**Key Finding**: WP1 was implemented before WP0 (dependency inversion). The plan includes formalization of WP0 contracts as a prerequisite gate while completing WP1 features.

**Architecture Decision**: Auto-publications are NOT stored in patch data. They are computed at compile time and injected into bus compilation, keeping patch files clean and avoiding "hidden publisher" confusion.

---

## Current State (from STATUS-20251221-133500.md)

### ✅ Complete
- TimeRoot block definitions (FiniteTimeRoot, InfiniteTimeRoot)
- Basic compilers for all three types with correct phase math
- TimeModel inference from TimeRoot blocks
- Player integration with TimeModel (monotonic time, no wrapping)

- Comprehensive compiler tests (259 lines)
- Feature flag `requireTimeRoot: true` ENABLED

### ❌ Missing (Per Spec & User Requirements)

- **Energy output**: Required on all TimeRoots per user spec
- **Auto-publication**: phase → phaseA, wrap → pulse, energy → energy (spec lines 112-113)
- **TimeOutputs bundle**: Standardized structure for all TimeRoot outputs
- **WP0 validation**: Reserved bus enforcement, TypeDesc validation

### ⚠️ Technical Debt
- Legacy inference paths for PhaseMachine/PhaseClock (dead code)
- Deprecated player.loopMode property (replaced by TimeModel)

---

## Gap Analysis

### Architecture Components

| Component | Spec Requirement | Current State | Gap |
|-----------|-----------------|---------------|-----|

| FiniteTimeRoot outputs | 3 outputs (t, progress, end event) | 2 outputs (systemTime, progress) | Missing: end event |
| Energy signal | All TimeRoots emit energy | None | Complete implementation needed |
| Auto-publication | Compiler injects publishers | No implementation | Complete implementation needed |
| WP0 contracts | Reserved bus validation | No enforcement | Validation gates needed |

### Core Modules

| Module | Status | Notes |
|--------|--------|-------|
| TimeRoot block definitions | ✅ Complete | `src/editor/blocks/time-root.ts` |
| TimeRoot compilers | ⚠️ Partial | `src/editor/compiler/blocks/domain/TimeRoot.ts` - missing outputs |
| TimeModel inference | ✅ Complete | `src/editor/compiler/compile.ts` lines 429-463 |
| Auto-publication logic | ❌ Missing | Needs implementation in compile.ts |
| WP0 validation gates | ❌ Missing | Blocker for safe auto-publication |

### Integration Points

**Bus System Integration**:
- Current: Manual publisher creation in patch data
- Required: Compiler-time injection of auto-publishers
- Gap: Need `autoPublications` return from TimeRoot compilers

**Player Integration**:
- Current: ✅ Complete - TimeModel flows correctly
- Required: No changes needed
- Gap: None

### Testing Infrastructure

**Unit Tests**:
- Current: Excellent coverage for phase math
- Required: Tests for wrap events, cycleIndex, energy, auto-publication
- Gap: 4 new test suites needed

---

## Prioritized Backlog

---

## [P0] Formalize WP0 Contract Validation Gates

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None (prerequisite for safe auto-publication)
**Spec Reference**: design-docs/3-Synthesized/02-Time-Architecture.md lines 112-113, ROADMAP.md WP0 • **Status Reference**: STATUS-20251221-133500.md lines 293-313

### Description

Before implementing auto-publication, establish compile-time validation gates that enforce the contracts WP1 depends on. This is a lightweight subset of full WP0 to unblock WP1 completion.

**Why This First**: Auto-publication injects publishers to reserved buses (phaseA, pulse, energy). Without validation, we could:
- Publish to non-existent buses
- Violate bus type constraints
- Create silent failures

**Approach**: Add validation gates in compile.ts that run BEFORE auto-publication injection.

### Acceptance Criteria

- [ ] `validateReservedBuses()` function ensures canonical buses exist with correct types
  - phaseA: Signal<phase>, combine: last
  - pulse: Event, combine: or
  - energy: Signal<number>, combine: sum
- [ ] Compile error if auto-publication targets non-existent bus
- [ ] Compile error if auto-publication type mismatches bus type
- [ ] Tests: Reserved bus validation catches type mismatches
- [ ] Tests: Missing reserved bus triggers compile error with helpful message

### Technical Notes

**File**: `src/editor/compiler/compile.ts`

Add after line 348 (before bus compilation):
```typescript
// Validate reserved buses exist and have correct types
const reservedBusErrors = validateReservedBuses(busStore);
if (reservedBusErrors.length > 0) {
  return { ok: false, errors: reservedBusErrors };
}
```

**Reserved Bus Contracts**:
```typescript
const RESERVED_BUSES = {
  phaseA: { type: 'Signal<phase>', combine: 'last' },
  pulse: { type: 'Event', combine: 'or' },
  energy: { type: 'Signal<number>', combine: 'sum' },
  palette: { type: 'Signal<color>', combine: 'last' },
  progress: { type: 'Signal<unit>', combine: 'last' },
};
```

---

## [P0] Implement TimeOutputs Bundle Interface

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: User requirement in task prompt • **Status Reference**: New requirement (not in STATUS file)

### Description

Define a standardized `TimeOutputs` interface that all TimeRoot compilers return. This ensures consistency and makes auto-publication logic simple and type-safe.

**User Requirement**: Every TimeRoot MUST emit:
- `time: Signal<time>` (monotonic, unbounded)
- `phaseA: Signal<phase>` (0..1, primary phase)
- `wrap: Signal<trigger>` (fires on phase wrap / direction flip)
- `energy: Signal<number>` (derived from speed/accel or 1.0 baseline)

**Why**: Uniform interface simplifies auto-publication and ensures all TimeRoots provide complete functionality.

### Acceptance Criteria

- [ ] `TimeOutputs` interface defined in compiler types with all 4 required fields

- [ ] FiniteTimeRoot returns complete TimeOutputs bundle (phaseA = progress, wrap = end event)
- [ ] InfiniteTimeRoot returns complete TimeOutputs bundle (phaseA = 0, wrap = never, energy = 1.0)
- [ ] Tests: All TimeRoot compilers return TimeOutputs-shaped objects
- [ ] Tests: Energy values are reasonable (≥0, typically 0..2 range)

### Technical Notes

**File**: `src/editor/compiler/types.ts`

```typescript
/**
 * Standardized outputs from all TimeRoot blocks.
 * Auto-published to canonical buses by compiler.
 */
export interface TimeOutputs {
  time: Artifact;      // Signal<time> - monotonic
  phaseA: Artifact;    // Signal<phase> - primary phase (0..1)
  wrap: Artifact;      // Event - fires on wrap/direction flip
  energy: Artifact;    // Signal<number> - speed/intensity
}
```

**Energy Derivation**:

- **FiniteTimeRoot**: `energy = progress < 1 ? 1.0 : 0.0` (active while animating)
- **InfiniteTimeRoot**: `energy = 1.0` (constant for ambient)

Future: Add speed/acceleration modulation inputs for dynamic energy.

---



**Status**: Not Started
**Effort**: Medium (2 days)
**Dependencies**: TimeOutputs bundle interface
**Spec Reference**: design-docs/3-Synthesized/02-Time-Architecture.md lines 105-110 • **Status Reference**: STATUS-20251221-133500.md lines 154-178

### Description



**Missing Outputs**:
1. **cycleT**: Signal<time> - time within current cycle (0..period or pingpong)
2. **wrap**: Event - fires when phase crosses 0 boundary (or pingpong direction flip)
3. **cycleIndex**: Signal<number> - count of completed cycles
4. **energy**: Signal<number> - intensity (1.0 baseline for now)

### Acceptance Criteria


- [ ] Compiler implements cycleT as modulo time: `cycleT = tMs % periodMs`
- [ ] Compiler implements wrap event: fires when `floor(tMs/period) > floor(lastTMs/period)`
- [ ] Compiler implements cycleIndex: `cycleIndex = floor(tMs / periodMs)`
- [ ] Compiler implements energy signal: returns 1.0 (baseline)
- [ ] Pingpong mode: wrap fires on BOTH forward→backward and backward→forward transitions
- [ ] Tests: Wrap event fires exactly once per period at t=0, period, 2*period, etc.
- [ ] Tests: Wrap event fires twice per period in pingpong mode (at direction flips)
- [ ] Tests: cycleIndex increments correctly, stays stable between wraps

### Technical Notes

**Files**:
- `src/editor/blocks/time-root.ts` (add output definitions lines 100-103)
- `src/editor/compiler/blocks/domain/TimeRoot.ts` (add compiler logic)

**Wrap Event Implementation**:
```typescript
// Event signature: (tMs: number, lastTMs: number, ctx: RuntimeCtx) => boolean
const wrap: Event = (tMs, lastTMs) => {
  const currCycle = Math.floor(tMs / periodMs);
  const lastCycle = Math.floor(lastTMs / periodMs);

  if (mode === 'pingpong') {
    // Wrap on direction change (even/odd cycle boundary)
    return currCycle !== lastCycle;
  }

  // Wrap on cycle boundary (sawtooth)
  return currCycle > lastCycle;
};
```

**Edge Cases**:
- Negative time: wrap should NOT fire when clamping tMs < 0 to 0
- First frame: lastTMs may be undefined → treat as no wrap
- Period change: wrap logic uses current period (hot-swap may cause phase jump)

---

## [P0] Add FiniteTimeRoot End Event

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: TimeOutputs bundle interface
**Spec Reference**: Implied by event system, user requirement • **Status Reference**: STATUS-20251221-133500.md lines 216-224

### Description

Add `end` event output to FiniteTimeRoot that fires when progress reaches 1.0. Enables "on completion" animations (e.g., fade out after stinger finishes).



### Acceptance Criteria

- [ ] FiniteTimeRoot block definition adds `end` event output
- [ ] Compiler implements end event: fires when `progress >= 1 && lastProgress < 1`
- [ ] End event fires exactly once (not continuously while progress=1)
- [ ] TimeOutputs bundle: `wrap` maps to end event for FiniteTimeRoot
- [ ] Tests: End event fires at durationMs transition
- [ ] Tests: End event does NOT fire on subsequent frames after completion

### Technical Notes

**File**: `src/editor/compiler/blocks/domain/TimeRoot.ts`

```typescript
const end: Event = (tMs, lastTMs) => {
  const currProgress = Math.min(tMs / durationMs, 1);
  const lastProgress = Math.min(lastTMs / durationMs, 1);
  return currProgress >= 1 && lastProgress < 1;
};
```

**TimeOutputs Mapping**:
- FiniteTimeRoot: `wrap = end` (conceptually, wrap means "animation completed")
- Allows uniform handling in auto-publication (both publish to pulse bus)

---

## [P1] Implement Auto-Publication to Canonical Buses

**Status**: Not Started
**Effort**: Medium (3 days)
**Dependencies**: [P0] WP0 validation gates, [P0] TimeOutputs bundle
**Spec Reference**: design-docs/3-Synthesized/02-Time-Architecture.md lines 112-113, user requirement • **Status Reference**: STATUS-20251221-133500.md lines 180-197, 476-505

### Description

Implement compiler-time injection of auto-publishers from TimeRoot outputs to canonical buses. This is the core architectural contract: TimeRoots AUTOMATICALLY publish to phaseA, pulse, and energy buses without requiring manual wiring in patch data.

**User Requirement** (from task prompt):
- Auto-publications are NOT in patch data
- TimeRoot compile returns `autoPublications: [{busName, artifact, sortKey}]`
- Bus-aware compiler injects these into bus combine at compile time

**Publications**:

- FiniteTimeRoot: `progress` → bus progress, `end` → bus pulse, `energy` → bus energy
- InfiniteTimeRoot: `energy` → bus energy (only energy, no phase or wrap)

### Acceptance Criteria

- [ ] TimeRoot compilers return `autoPublications` array alongside artifact outputs
- [ ] Auto-publications include: busName, artifact reference, sortKey=0 (highest priority)
- [ ] Main compile.ts injects auto-publications into bus-aware compiler BEFORE normal publishers
- [ ] Auto-publications do NOT appear in patch.publishers (not persisted)
- [ ] Bus Board visualizes auto-publications with distinct styling (e.g., "system" badge)


- [ ] Integration test: Manual publisher to phaseA combines AFTER TimeRoot (sortKey ordering)

### Technical Notes

**Files**:
- `src/editor/compiler/blocks/domain/TimeRoot.ts` - Return autoPublications
- `src/editor/compiler/compile.ts` - Inject into bus compilation
- `src/editor/compiler/compileBusAware.ts` - Merge auto + manual publishers

**Compiler Return Shape**:
```typescript
interface TimeRootCompileResult {
  artifacts: {
    systemTime: Artifact;
    phase?: Artifact;
    // ... other outputs
  };
  autoPublications: Array<{
    busName: string;           // 'phaseA', 'pulse', 'energy'
    artifactKey: string;       // 'phase', 'wrap', 'energy'
    sortKey: number;           // 0 for system publications
  }>;
}
```

**Injection Point** (compile.ts after line 348):
```typescript
// After TimeRoot validation, before bus compilation
const autoPublications = extractAutoPublications(timeRootBlock, compiledArtifacts);

// Pass to bus-aware compiler
const busResult = compileBusAware({
  patch,
  compiledPortMap,
  systemPublications: autoPublications, // Injected here
});
```

**sortKey=0**: System publications have highest priority. Manual publishers default to sortKey=100, ensuring TimeRoot phase is the "primary" source for phaseA.

---

## [P1] Update Block Definitions with All Outputs

**Status**: Not Started
**Effort**: Small (1 day)

**Spec Reference**: design-docs/3-Synthesized/02-Time-Architecture.md • **Status Reference**: STATUS-20251221-133500.md lines 154-178, 216-224

### Description

Update `src/editor/blocks/time-root.ts` to declare all missing output ports so they appear in UI and can be manually wired if needed (in addition to auto-publication).

**Why**: Even though outputs are auto-published, users may want to wire them directly to non-bus consumers. UI should show all available ports.

### Acceptance Criteria


- [ ] FiniteTimeRoot outputs: systemTime, progress, end, energy (4 total)
- [ ] InfiniteTimeRoot outputs: systemTime, energy (2 total)
- [ ] All outputs have correct type annotations (Signal<time>, Event, etc.)
- [ ] Block inspector shows all outputs with clear labels


### Technical Notes

**File**: `src/editor/blocks/time-root.ts`


```typescript
outputs: [
  output('systemTime', 'System Time', 'Signal<time>'),
  output('cycleT', 'Cycle Time', 'Signal<time>'),
  output('phase', 'Phase', 'Signal<phase>'),
  output('wrap', 'Wrap Event', 'Event'),
  output('cycleIndex', 'Cycle Index', 'Signal<number>'),
  output('energy', 'Energy', 'Signal<number>'),
],
```

**FiniteTimeRoot additions**:
```typescript
outputs: [
  output('systemTime', 'System Time', 'Signal<time>'),
  output('progress', 'Progress', 'Signal<number>'),
  output('end', 'End Event', 'Event'),
  output('energy', 'Energy', 'Signal<number>'),
],
```

**InfiniteTimeRoot additions**:
```typescript
outputs: [
  output('systemTime', 'System Time', 'Signal<time>'),
  output('energy', 'Energy', 'Signal<number>'),
],
```

---

## [P1] Add Compiler Tests for New Outputs

**Status**: Not Started
**Effort**: Medium (2 days)
**Dependencies**: All [P0] items, [P1] auto-publication
**Spec Reference**: Test strategy • **Status Reference**: STATUS-20251221-133500.md lines 396-421

### Description

Extend `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` with comprehensive tests for new outputs (wrap, cycleIndex, energy, end event) and auto-publication behavior.

**Current Coverage**: Phase math, basic outputs (259 lines) - EXCELLENT
**Missing Coverage**: Event outputs, energy, auto-publication

### Acceptance Criteria




- [ ] Test: FiniteTimeRoot end event fires exactly once at completion
- [ ] Test: All TimeRoots emit energy signal with value ≥ 0
- [ ] Test: Auto-publications array contains correct busNames and artifactKeys
- [ ] Test: Auto-publications have sortKey=0 (highest priority)
- [ ] Test: Negative time handling (wrap should not fire on clamp to 0)

### Technical Notes

**File**: `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts`

**Test Structure**:
```typescript

  it('fires wrap event at period boundary (loop mode)', () => {

    const wrap = result.wrap.value as Event;

    expect(wrap(0, -16, ctx)).toBe(false);       // First frame
    expect(wrap(500, 484, ctx)).toBe(false);     // Mid-cycle
    expect(wrap(1000, 984, ctx)).toBe(true);     // Wrap!
    expect(wrap(1016, 1000, ctx)).toBe(false);   // After wrap
  });

  it('fires wrap event on pingpong direction changes', () => {
    // Test both forward→backward and backward→forward
  });
});


  it('returns autoPublications for phaseA, pulse, energy', () => {

    expect(result.autoPublications).toEqual([
      { busName: 'phaseA', artifactKey: 'phase', sortKey: 0 },
      { busName: 'pulse', artifactKey: 'wrap', sortKey: 0 },
      { busName: 'energy', artifactKey: 'energy', sortKey: 0 },
    ]);
  });
});
```

**Edge Cases to Test**:
- First frame (lastTMs = undefined)
- Negative time (tMs < 0)
- Period change (hot-swap may cause wrap to skip or double-fire)
- Zero period (should compile error in WP0 validation)

---

## [P2] Remove Legacy Inference Paths

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: [P1] All core features working
**Spec Reference**: Code cleanup • **Status Reference**: STATUS-20251221-133500.md lines 240-273, 518-526

### Description

Remove dead code: legacy TimeModel inference from PhaseMachine/PhaseClock, and deprecated player.loopMode fallback. With `requireTimeRoot: true` enforced, these paths are unreachable.

**Why Now**: Dead code creates confusion and maintenance burden. Clean it up once core WP1 is stable.

### Acceptance Criteria

- [ ] Delete PhaseMachine inference (compile.ts lines 484-528)
- [ ] Delete PhaseClock inference (compile.ts lines 510-528)
- [ ] Delete player loopMode fallback (player.ts lines 558-581)
- [ ] Delete player.playDirection property (only used in legacy mode)
- [ ] All existing tests still pass (legacy paths were untested)
- [ ] No compile errors from removing legacy code

### Technical Notes

**Files to Clean**:
- `src/editor/compiler/compile.ts` (lines 484-528)
- `src/editor/runtime/player.ts` (lines 90, 92, 558-581)

**Safety Check**: Grep for any references to deleted code before removing:
```bash
rg "PhaseMachine.*TimeModel|loopMode.*fallback" src/
```

If any live code depends on removed paths, refactor first.

---

## [P2] Visual Verification of TimeConsole UI

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None (independent task)
**Spec Reference**: design-docs/3-Synthesized/07-UI-Spec.md • **Status Reference**: STATUS-20251221-133500.md lines 226-233, 529-538

### Description

Manual testing to verify TimeConsole UI correctly switches between Finite/Cycle/Infinite modes based on TimeModel.kind. Code structure looks correct but needs runtime verification.

**Why**: TimeConsole receives TimeModel and has mode-switching logic, but no visual confirmation that UI actually changes.

### Acceptance Criteria

- [ ] Load patch with FiniteTimeRoot → TimeConsole shows progress bar UI

- [ ] Load patch with InfiniteTimeRoot → TimeConsole shows sliding window UI
- [ ] Scrubbing works in all three modes (doesn't crash or show wrong UI)

- [ ] Screenshots: Capture all three UI modes for documentation

### Technical Notes

**Test Patches**:

2. Delete add FiniteTimeRoot (5s) → Verify progress bar
3. Delete FiniteTimeRoot, add InfiniteTimeRoot → Verify sliding window

**File**: `src/editor/components/TimeConsole.tsx` (lines 243-519)

**UI Elements to Verify**:
- Finite: Linear progress bar, "Play to End" button
- Cycle: Circular phase indicator, loop count, "Loop" label
- Infinite: Time display, no wrap indicator

**Acceptance**: UI matches spec diagrams in `07-UI-Spec.md`.

---

## [P3] Clarify TimeModel Update Timing

**Status**: Not Started
**Effort**: Small (research + spec update)
**Dependencies**: None (spec clarification)
**Spec Reference**: design-docs/3-Synthesized/02-Time-Architecture.md line 11 vs 10-Golden-Patch.md criteria #4 • **Status Reference**: STATUS-20251221-133500.md lines 339-360, 539-547

### Description

Resolve spec conflict: TimeRoot param changes trigger "immediate rebuild" OR "scheduled at pulse boundary"? Current behavior is immediate recompile, which can cause visual jank.

**Spec Conflict**:
- Time-Architecture.md: "changing params triggers TimeModel rebuild and hot-swap"
- Golden-Patch.md: "Period changes scheduled at pulse boundary"

**Impact**: If we rebuild immediately, period change causes phase jump. If we schedule, we need pulse event infrastructure (which WP1 now provides).

### Acceptance Criteria

- [ ] Decision documented: Immediate vs. scheduled vs. hybrid approach
- [ ] Spec updated (02-Time-Architecture.md) with final timing semantics
- [ ] If scheduled: Implementation plan for WP6 (Hot Swap Scheduling)
- [ ] If immediate: Rationale for accepting phase jump jank
- [ ] Prototype (optional): Both approaches tested for jank severity

### Technical Notes

**Options**:
1. **Immediate**: Simplest, but causes phase jump if period changes mid-cycle
2. **Scheduled at pulse**: Cleanest UX, requires WP6 scheduling infrastructure
3. **Hybrid**: Immediate for small changes (<10%), scheduled for large (defer to WP6)

**Recommendation**: Research in WP6 planning. For WP1, accept immediate rebuild with TODO for WP6 polish.

**Deferred to WP6**: Full hot-swap scheduling with pulse-edge detection.

---

## Dependency Graph

```
┌─────────────────────────────────────┐
│ [P0] WP0 Contract Validation Gates  │ ← PREREQUISITE
└────────────┬────────────────────────┘
             │
             ├──────────────────────────────────────┐
             │                                      │
             v                                      v
┌─────────────────────────────┐   ┌──────────────────────────────┐

└────────────┬────────────────┘   └──────────┬───────────────────┘
             │                               │
             │                               │
             v                               v
┌─────────────────────────────┐   ┌──────────────────────────────┐
│ [P0] FiniteTimeRoot End     │   │ [P1] Update Block Definitions│
└────────────┬────────────────┘   └──────────┬───────────────────┘
             │                               │
             └───────────┬───────────────────┘
                         │
                         v
             ┌─────────────────────────────┐
             │ [P1] Auto-Publication       │
             └────────────┬────────────────┘
                          │
                          v
             ┌─────────────────────────────┐
             │ [P1] Compiler Tests         │
             └────────────┬────────────────┘
                          │
          ┌───────────────┴───────────────┐
          v                               v
┌──────────────────────┐   ┌──────────────────────────┐
│ [P2] Remove Legacy   │   │ [P2] Visual Verification │
│      Inference       │   │      TimeConsole         │
└──────────────────────┘   └──────────────────────────┘
                          │
                          v
             ┌─────────────────────────────┐
             │ [P3] Clarify Update Timing  │ (Spec research)
             └─────────────────────────────┘
```

**Critical Path**: P0 items → P1 auto-publication → P1 tests
**Parallel Work**: P2 cleanup and verification (independent)

---

## Recommended Sprint Planning

### Sprint 1: Foundation (3-4 days)
**Goal**: Establish contracts and complete TimeOutputs

- [P0] WP0 Contract Validation Gates
- [P0] TimeOutputs Bundle Interface

- [P0] FiniteTimeRoot end event

**Deliverable**: All TimeRoot compilers emit complete TimeOutputs bundles, reserved bus validation active.

### Sprint 2: Integration (3-4 days)
**Goal**: Auto-publication working end-to-end

- [P1] Implement Auto-Publication to Canonical Buses
- [P1] Update Block Definitions with All Outputs
- [P1] Add Compiler Tests for New Outputs



### Sprint 3: Polish (2-3 days)
**Goal**: Clean up and verify

- [P2] Remove Legacy Inference Paths
- [P2] Visual Verification of TimeConsole UI
- [P3] Clarify TimeModel Update Timing (spec research)

**Deliverable**: WP1 complete, tech debt removed, UI verified, spec aligned.

**Total Estimate**: 8-11 days (complexity-based, not time-based)

---

## Risk Assessment

### High-Risk Items

**1. Auto-Publication Without WP0 (MITIGATED)**
- **Risk**: Publishing to invalid buses causes runtime errors
- **Mitigation**: P0 validation gates block unsafe publications
- **Fallback**: If validation too complex, add runtime checks + TODO for full WP0

**2. Wrap Event Edge Cases (MODERATE)**
- **Risk**: Wrap fires incorrectly on first frame, negative time, or period change
- **Mitigation**: Comprehensive test suite in [P1] compiler tests
- **Fallback**: Conservative implementation (wrap only on positive time, stable period)

**3. Energy Signal Semantics Unclear (LOW)**
- **Risk**: User spec says "derived from speed/accel" but unclear how
- **Mitigation**: Start with constant 1.0, add TODO for dynamic energy in future WP
- **Fallback**: Document that energy=1.0 is "baseline" for WP1

### Medium-Risk Items

**4. TimeModel Update Timing Ambiguity (DEFERRED)**
- **Risk**: Immediate rebuild causes jank, scheduled rebuild needs WP6 infrastructure
- **Mitigation**: Accept immediate for WP1, defer scheduling to WP6
- **Fallback**: Document current behavior, add spec note for WP6

**5. Legacy Code Removal Breaks Unknown Deps (LOW)**
- **Risk**: Deleted code has unexpected live references
- **Mitigation**: Grep search before deletion, run full test suite
- **Fallback**: Revert deletion, mark as deprecated instead

### Low-Risk Items

**6. Visual Verification Subjective (LOW)**
- **Risk**: "Looks right" is not objective test
- **Mitigation**: Compare against spec diagrams, capture screenshots
- **Fallback**: Skip if TimeConsole code is too complex, defer to WP7 (export)

---

## Blockers and Questions

### Resolved
- ✅ Should WP1 wait for WP0? **No** - implement lightweight validation gates as P0
- ✅ Are auto-publications persisted? **No** - computed at compile time only

### Open Questions
1. **Energy signal derivation**: User says "derived from speed/accel or 1.0 baseline". Should WP1 implement dynamic energy, or just constant 1.0?
   - **Recommendation**: Constant 1.0 for WP1, defer dynamic to future WP

2. **TimeModel update timing**: Immediate or scheduled?
   - **Recommendation**: Defer to WP6, accept immediate for WP1

3. **InfiniteTimeRoot phaseA value**: Spec doesn't define. Should it be constant 0, or undefined?
   - **Recommendation**: Constant 0 (simplest), document that infinite has no natural phase

### Clarification Needed
- None blocking WP1 start. Open questions have reasonable defaults.

---

## Files in Scope

**Core Implementation** (to modify):
- `src/editor/blocks/time-root.ts` - Add missing output definitions
- `src/editor/compiler/blocks/domain/TimeRoot.ts` - Implement wrap, cycleIndex, energy, auto-publications
- `src/editor/compiler/compile.ts` - Add WP0 validation gates, inject auto-publications
- `src/editor/compiler/types.ts` - Define TimeOutputs interface
- `src/editor/compiler/types-bus.ts` - Extend BusCompileResult if needed

**Testing** (to extend):
- `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` - Add wrap, energy, auto-publication tests

**Cleanup** (to remove):
- `src/editor/compiler/compile.ts` (lines 484-528) - Delete legacy inference
- `src/editor/runtime/player.ts` (lines 558-581) - Delete loopMode fallback

**Verification** (manual):
- `src/editor/components/TimeConsole.tsx` - Visual test mode switching

**Spec Docs** (to update):
- `design-docs/3-Synthesized/02-Time-Architecture.md` - Clarify update timing

**Total**: 9 files to modify, 1 to manually verify, 1 spec doc to update

---

## Definition of Done

WP1 is COMPLETE when:

1. ✅ All three TimeRoot compilers return TimeOutputs bundles

3. ✅ FiniteTimeRoot emits: systemTime, progress, end, energy
4. ✅ InfiniteTimeRoot emits: systemTime, energy
5. ✅ Auto-publications inject phase→phaseA, wrap→pulse, energy→energy
6. ✅ WP0 validation gates prevent unsafe auto-publications
7. ✅ Integration tests prove auto-publication works
8. ✅ Compiler tests cover wrap events, energy, cycleIndex
9. ✅ Legacy inference paths removed (PhaseMachine, loopMode)
10. ✅ TimeConsole UI verified in all three modes
11. ✅ `just check` passes (typecheck + lint + tests)
12. ✅ Spec docs aligned with implementation

**Acceptance Criteria Reference**: See DOD-2025-12-21-151700.md for checklist format.

---

## Next Steps After WP1

**Immediate Next WP**: WP2 (Bus-Aware Compiler Graph)
- Dependency: WP1 provides wrap events and auto-publications
- Builds on: Bus routing with deterministic publisher ordering
- Enables: Golden Patch signal-only parts (breath energy, pulse events)

**Deferred Work**:
- Dynamic energy signal (WP6 or later)
- Phase offset injection for scrubbing (WP6)
- Scheduled hot-swap at pulse boundary (WP6)
- Full WP0 contract enforcement (parallel to WP2)
