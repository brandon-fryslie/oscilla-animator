# WP1: TimeRoot + TimeModel + Player Rewrite - Status

**Timestamp**: 2025-12-21-133500
**Scope**: module/wp1-timeroot-compilers
**Confidence**: FRESH
**Git Commit**: 24ba70d

---

## Executive Summary

**Overall Status**: 85% COMPLETE - Core implementation functional, missing pieces identified

**Critical Finding**: The WP1 implementation is MOSTLY COMPLETE and WORKING. TimeRoot blocks compile correctly, TimeModel flows to player, player time advancement is monotonic. However, several spec-defined features are MISSING and dependency prerequisites are INCOMPLETE.



**Dependencies**: Both prerequisite topics (wp0-lock-contracts, bus-semantics-module) are PROPOSED with NO implementation started. This is a planning gap - WP1 was implemented without completing WP0.

---

## Reused From Cache/Previous Evaluations

- eval-cache/time-architecture.md (FRESH, written by project-evaluator 2025-12-21 12:30)
  - Player time advancement for cyclic/infinite (mathematically proven correct)
  - TimeRoot compiler logic and phase derivation
  - TimeModel type definition and semantics
  - Feature flag status (requireTimeRoot=true, ENABLED)

---

## What EXISTS and WORKS

### âœ… TimeRoot Block Definitions (COMPLETE)
**File**: `src/editor/blocks/time-root.ts` (lines 1-183)

All three TimeRoot types defined with correct ports and param schemas:

| Block | Outputs | Params | Status |
|-------|---------|--------|--------|
| FiniteTimeRoot | systemTime, progress | durationMs (100-30000ms) | âœ… COMPLETE |

| InfiniteTimeRoot | systemTime | windowMs (1000-60000ms) | âœ… COMPLETE |

**Evidence**: Block definitions use new input/output system with defaultSource (world: 'config'), ready for Phase 4 migration.

### âœ… TimeRoot Compilers (COMPLETE)
**File**: `src/editor/compiler/blocks/domain/TimeRoot.ts` (lines 1-121)

All three compilers implemented and registered:

1. **FiniteTimeRootBlock**: systemTime (identity), progress (clamped 0..1)

3. **InfiniteTimeRootBlock**: systemTime (identity)

**Mathematical Correctness**: Phase derivation via `(tMs / periodMs) % 1` applied to unbounded time - CORRECT approach.

**Registration**: All three exported in `src/editor/compiler/blocks/index.ts` (lines 22-24, 85-87).

### âœ… TimeModel Inference (COMPLETE)
**File**: `src/editor/compiler/compile.ts`

- **Inference function**: `inferTimeModelFromTimeRoot()` (lines 429-463)
- **Validation**: `validateTimeRootConstraint()` (lines 399-424)
  - Enforces exactly-one-TimeRoot when `requireTimeRoot=true`
  - Returns compile errors for 0 or >1 TimeRoots
- **Integration**: Called in main compile pipeline (line 348)

**Evidence**: Feature flag `requireTimeRoot: true` ENABLED (lines 52 in featureFlags.ts). Validation ACTIVE.

### âœ… Player TimeModel Integration (COMPLETE)
**File**: `src/editor/runtime/player.ts`

**Player.applyTimeModel()** (lines 406-429):
```typescript
switch (model.kind) {
  case 'finite': this.maxTime = model.durationMs; break;
  case 'cyclic': this.maxTime = model.periodMs; break;
  case 'infinite': this.maxTime = model.windowMs; break;
}
```

**Player time advancement** (lines 522-581):
- **Cyclic/Infinite**: Monotonic advancement, NEVER wraps tMs
- **Finite**: Optional looping via `finiteLoopMode` flag
- **Negative time clamping**: Prevents backward scrub past zero

**Evidence of Correctness**:
```typescript
case 'cyclic':
  // Monotonic - just clamp to non-negative
  if (this.tMs < 0) this.tMs = 0;
  break; // NO WRAPPING
```



### âœ… TimeModel Flow to Player (COMPLETE)
**File**: `src/editor/PreviewPanel.tsx`

Player receives TimeModel on initial load (line 144) and on recompile (line 204):
```typescript
player.applyTimeModel(compiledProgram.timeModel);
```

**Data Flow**:
1. Compiler infers TimeModel from TimeRoot block
2. CompilerService returns `{ program, timeModel }` in `getProgram()`
3. PreviewPanel calls `player.applyTimeModel(timeModel)`
4. Player configures `maxTime` for UI framing

### âœ… Auto-Insert Default TimeRoot (COMPLETE)
**File**: `src/editor/stores/RootStore.ts` (lines 262-270)


```typescript

  periodMs: 8000, // Matches Golden Patch spec
});
```

**Why This Matters**: With `requireTimeRoot=true`, every patch MUST have a TimeRoot. Auto-insertion prevents immediate compile error on new patch.

### âœ… TimeRoot Compiler Tests (COMPLETE)
**File**: `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` (259 lines)

**Coverage**:
- All three TimeRoot types
- Default parameter handling
- Negative time handling
- Phase wrapping at period boundary
- Pingpong triangle wave correctness
- Output type consistency

**Test Quality**: HIGH - tests verify mathematical correctness, not just "does it compile."

**Sample Evidence** (lines 146-160):
```typescript
it('should return phase as sawtooth wave (loop mode)', () => {
  const phase = getSignalValue<number>(result.phase, 'Signal:phase');
  expect(phase(0, mockRuntimeCtx)).toBeCloseTo(0, 5);
  expect(phase(1500, mockRuntimeCtx)).toBeCloseTo(0.5, 5);
  expect(phase(3000, mockRuntimeCtx)).toBeCloseTo(0, 5); // Wraps
  expect(phase(4500, mockRuntimeCtx)).toBeCloseTo(0.5, 5); // Second cycle
});
```

Tests verify phase WRAPS at period boundary via modulo math. âœ… CORRECT.

---

## What is MISSING (Per Spec)



**Spec Requirement** (`design-docs/3-Synthesized/02-Time-Architecture.md` lines 105-110):
```

- t: Signal<time> (unbounded)
- cycleT: Signal<time> (0..period or pingpong)
- phase: Signal<phase> (primary)
- wrap: Event (pulse)
- cycleIndex: Signal<number>
```

**Current Implementation** (`src/editor/blocks/time-root.ts` lines 100-103):
```typescript
outputs: [
  output('systemTime', 'System Time', 'Signal<time>'),
  output('phase', 'Phase', 'Signal<phase>'),
],
```

**MISSING**: `cycleT`, `wrap`, `cycleIndex`

**Impact**: Cannot detect wrap events for triggering animations, cannot track cycle count. Bus auto-publication of `wrap -> pulse` CANNOT WORK without wrap output.

**Severity**: HIGH - Breaks spec-defined bus auto-publication contract.

### âŒ Missing Bus Auto-Publication

**Spec Requirement** (`design-docs/3-Synthesized/02-Time-Architecture.md` lines 112-113):
```

- phase -> reserved bus phaseA
- wrap -> reserved bus pulse
```

**Current State**: NO auto-publication logic found in compiler.

**Searched**: `grep -rn "auto.*publish" src/editor/compiler/` - only composite bus publications found, NOT TimeRoot.



**Severity**: HIGH - Core bus system contract not implemented.

**Where It Should Happen**: Likely in `src/editor/compiler/compile.ts` after TimeRoot detection, OR in `compileBusAware.ts` during bus-aware compilation.



**Spec Requirement** (`design-docs/3-Synthesized/02-Time-Architecture.md` lines 99-103):
```

- period: Scalar<duration>
- mode: Scalar<enum('loop'|'pingpong')>
- phaseOffset: Signal<phase> (optional)
- drift: Signal<number> (optional)
```

**Current Implementation**: Only `periodMs` and `mode` as params, NO inputs for `phaseOffset` or `drift`.

**Impact**: Cannot scrub phase independently, cannot apply phase drift for organic motion. Scrubbing must modify player time directly instead of phase offset injection.

**Severity**: MEDIUM - Scrubbing still works via player time, but less elegant than spec intends.

### âŒ Missing FiniteTimeRoot Outputs

**Spec Requirement** (implied by Event system): FiniteTimeRoot should emit `end: Event` when progress reaches 1.0.

**Current Implementation**: Only `systemTime` and `progress` signals, NO events.

**Impact**: Cannot trigger animations on finish (e.g., "on completion, fade out").

**Severity**: LOW - Can detect via `progress >= 1.0` in downstream blocks, but less clean.

### âŒ TimeConsole UI Not Mode-Aware

**Spec Requirement** (`design-docs/3-Synthesized/07-UI-Spec.md`): TimeConsole should switch between Finite/Cycle/Infinite UI modes based on TimeModel.kind.

**Current State**: `TimeConsole.tsx` (lines 243-519) receives `timeModel: TimeModel` prop and has mode-switching logic.

**Verification Needed**: Need to visually test that UI actually switches modes. Code structure looks correct, but runtime behavior unverified.

**Severity**: LOW - UI exists, just needs runtime verification.

---

## What is INCOMPLETE (Implementation Gaps)

### âš ï¸ Legacy Inference Paths Still Present

**File**: `src/editor/compiler/compile.ts` (lines 484-528)

Legacy inference from PhaseMachine and PhaseClock still exists:
```typescript
// Legacy inference: Check for PhaseMachine (implies finite duration)
for (const block of patch.blocks.values()) {
  if (block.type === 'PhaseMachine') { ... }
}

// Legacy inference: Check for PhaseClock with loop mode
for (const block of patch.blocks.values()) {
  if (block.type === 'PhaseClock') { ... }
}

// Default: infinite time model
return { kind: 'infinite', windowMs: 10000 };
```

**Why It Exists**: Backward compatibility before `requireTimeRoot=true` enforcement.

**Why It Should Be Removed**:
1. With `requireTimeRoot=true`, these paths are NEVER reached (validation errors first)
2. Dead code creates confusion
3. PhaseClock is NOT a time topology declaration (per spec)

**Migration Path** (from eval-cache):
1. Flip flag to true âœ… DONE
2. Auto-insert default TimeRoot on patch creation âœ… DONE
3. Remove legacy inference code âŒ NOT DONE

**Severity**: LOW - Code works, but tech debt.

### âš ï¸ Deprecated Player Properties

**File**: `src/editor/runtime/player.ts`

Still present but deprecated:
- `loopMode: LoopMode` (line 90) - Deprecated, but still used in legacy fallback (lines 558-581)
- `playDirection: number` (line 92) - Only used in legacy pingpong mode
- `setLoopMode()` method still exists and works

**Why They Exist**: Backward compatibility for patches without TimeRoot.

**Why They Should Be Removed**: With `requireTimeRoot=true`, TimeModel ALWAYS exists. Legacy fallback is dead code.

**Severity**: LOW - Works correctly, just needs cleanup.

---

## Dependency Status

### âŒ WP0: Lock the Contracts [PROPOSED - NO WORK STARTED]

**Roadmap Entry** (`.agent_planning/ROADMAP.md` lines 37-41):
```
#### wp0-lock-contracts [PROPOSED]
Description: WP0: Lock the Contracts - TypeDesc validation,
             reserved bus enforcement, TimeRoot dependency rules
Dependencies: complete-time-authority
```

**Status**: PROPOSED, empty directory (`.agent_planning/wp0-lock-contracts/` is empty).

**What WP0 Should Deliver** (per spec):
1. TypeDesc validation enforcement (world, domain, busEligible)
2. Reserved bus name/type enforcement (phaseA, pulse, energy, palette)
3. TimeRoot upstream dependency validation (no inputs allowed)

**Current Gap**: None of these validations exist. Reserved bus types are NOT enforced.

**Impact on WP1**: WP1 implementation assumes these contracts but doesn't enforce them. Bus auto-publication CANNOT be implemented safely without reserved bus enforcement.

**Severity**: HIGH - WP1 cannot be fully completed until WP0 exists.

### âŒ bus-semantics-module [PROPOSED - NO WORK STARTED]

**Roadmap Entry** (`.agent_planning/ROADMAP.md` lines 17-22):
```
#### bus-semantics-module [PROPOSED]
Description: Create canonical busSemantics module to eliminate
             duplicate publisher ordering logic between BusStore
             and compiler (3-5 hours)
```

**Status**: PROPOSED, empty directory (`.agent_planning/bus-semantics-module/` is empty).

**Why It Matters**: Bus combination semantics (last, sum, or) and publisher ordering (sortKey) are needed for auto-publication to work correctly.

**Current State**: BusStore has bus semantics logic, but compiler doesn't use it for auto-publication (because auto-publication doesn't exist yet).

**Severity**: MEDIUM - Needed for correct bus auto-publication implementation.

---

## Ambiguities and Spec Gaps

### ðŸ¤” Ambiguity: When Does TimeModel Update?



**Options**:
1. Immediately on param change (hot-swap)
2. At next wrap event (scheduled hot-swap)
3. Only on explicit recompile

**Current Behavior**: Immediate recompile triggers TimeModel inference, player receives new maxTime immediately.

**Spec Says** (`design-docs/3-Synthesized/02-Time-Architecture.md` comment in time-root.ts line 11):
> "All TimeRoot params are Config world - changing them triggers TimeModel rebuild and hot-swap (crossfade/freeze-fade)."

**Spec Says** (`design-docs/3-Synthesized/10-Golden-Patch.md` acceptance criteria #4):
> "Period changes scheduled at pulse boundary"

**Conflict**: Spec says "immediate rebuild" AND "scheduled at pulse boundary." Which is it?

**Impact**: If we rebuild immediately, period change can cause visual jank. If we schedule, we need pulse event infrastructure.

**Severity**: MEDIUM - Needs clarification before implementing wrap event scheduling.

### ðŸ¤” Ambiguity: Default TimeRoot Type

**Question**: When auto-inserting TimeRoot on new patch, which type should be default?



**Alternatives**:
- FiniteTimeRoot (for logo stingers)
- InfiniteTimeRoot (for generative art)

**Rationale for Current Choice**: Matches Golden Patch spec (8s cyclic).

**But**: Most users probably want simpler finite animations first, not loops.

**Severity**: LOW - UX preference, not a bug. Current choice is reasonable.

### ðŸ¤” Spec Gap: How Does Scrubbing Work with Phase Offset?

**Spec Says** (lines 162-165 of time-architecture.md):
```
Scrubbing never resets state.
| Action | Effect |
| Scrub in cyclic | Sets phase offset |
```

**Implementation Reality**: Scrubbing sets `player.tMs` directly (PreviewPanel.tsx line 276-278). No phase offset injection exists.



**Workaround**: Setting `player.tMs` directly works because phase is derived via modulo. Mathematically equivalent but not as clean.

**Severity**: LOW - Works correctly, just less elegant than spec vision.

---

## Test Coverage Assessment

### Runtime Checks Available

**Existing Test Commands**:
```bash
just test                  # Run all unit tests (vitest)
just test-watch           # Watch mode
just check                # typecheck + lint + test
```

**TimeRoot-Specific Tests**:
- `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` (259 lines)
- Coverage: âœ… Excellent - all three types, phase math, edge cases

**Missing Runtime Checks**:

2. **TimeModel UI mode switching**: Need visual test that TimeConsole changes UI based on TimeModel.kind
3. **Wrap event emission**: Can't test until wrap output exists
4. **Phase offset injection**: Can't test until phaseOffset input exists

**Recommendation**: After implementing missing features, add integration tests verifying:

- Wrap event fires at period boundary
- TimeConsole UI switches modes

---

## Data Flow Verification

| Flow Step | Input | Process | Storage | Retrieval | Display |
|-----------|-------|---------|---------|-----------|---------|

| TimeRoot Compilation | BlockInstance | Compiler produces systemTime/phase signals | Compiled artifact | Player program.signal() | âœ… |
| TimeModel Inference | TimeRoot block params | inferTimeModelFromTimeRoot() | CompileResult.timeModel | compilerService.getProgram() | âœ… |
| Player TimeModel Application | TimeModel from compiler | player.applyTimeModel() | player.timeModel, player.maxTime | player.getTimeModel() | âœ… |
| Phase Signal Evaluation | player.tMs | phase = (tMs / period) % 1 | N/A (pure function) | Runtime ctx evaluation | âœ… |
| TimeConsole UI Update | TimeModel.kind | Mode-specific UI render | React state | TimeConsole component | âš ï¸ NEEDS VISUAL VERIFICATION |

**Data Integrity**: All transformations are deterministic and type-safe. No data loss in pipeline. âœ…

**Missing Data Flows**:
- Wrap event emission (TimeRoot -> Event system -> pulse bus)


---

## Recommendations (Priority Order)

### 1. Implement Missing TimeRoot Outputs [HIGH PRIORITY]

**Affected Files**:
- `src/editor/blocks/time-root.ts` - Add output definitions
- `src/editor/compiler/blocks/domain/TimeRoot.ts` - Implement wrap event and cycleIndex


```typescript
outputs: [
  output('systemTime', 'System Time', 'Signal<time>'),
  output('cycleT', 'Cycle Time', 'Signal<time>'),
  output('phase', 'Phase', 'Signal<phase>'),
  output('wrap', 'Wrap Pulse', 'Event'),
  output('cycleIndex', 'Cycle Index', 'Signal<number>'),
],
```

**Compiler Implementation**:
```typescript
const wrap: Event = (tMs, lastTMs) => {
  const currCycle = Math.floor(tMs / periodMs);
  const lastCycle = Math.floor(lastTMs / periodMs);
  return currCycle > lastCycle;
};

const cycleIndex: SignalNumber = (tMs) => Math.floor(tMs / periodMs);
```

**Rationale**: Enables bus auto-publication (spec requirement) and cycle-triggered animations.

### 2. Implement Bus Auto-Publication [HIGH PRIORITY]

**Prerequisite**: WP0 (reserved bus enforcement) OR accept risk of unvalidated bus types.

**Where**: `src/editor/compiler/compile.ts` or `compileBusAware.ts`

**Logic**:
```typescript
// After TimeRoot detection

  // Auto-create publisher: TimeRoot.phase -> phaseA bus
  publishers.push({
    id: generateAutoPublisherId(),
    fromBlockId: timeRootBlock.id,
    fromSlot: 'phase',
    busName: 'phaseA',
    sortKey: 0, // Highest priority
  });

  // Auto-create publisher: TimeRoot.wrap -> pulse bus
  publishers.push({
    id: generateAutoPublisherId(),
    fromBlockId: timeRootBlock.id,
    fromSlot: 'wrap',
    busName: 'pulse',
    sortKey: 0,
  });
}
```

**Rationale**: Core architectural contract from spec.

### 3. Add WP0 Prerequisite Validation [HIGH PRIORITY]

**Blocker**: Cannot safely implement auto-publication without reserved bus enforcement.

**Options**:
1. Implement WP0 first (proper dependency order)
2. Implement auto-publication with TODO for WP0 validation
3. Skip auto-publication until WP0 complete

**Recommendation**: Option 2 (pragmatic) - implement with validation TODO, mark WP1 as "provisional completion pending WP0."

### 4. Remove Legacy Inference Paths [MEDIUM PRIORITY]

**Why Now**: With `requireTimeRoot=true` enforced, dead code creates confusion.

**Files to Clean**:
- `src/editor/compiler/compile.ts` (lines 484-528) - Delete PhaseMachine/PhaseClock inference
- `src/editor/runtime/player.ts` (lines 558-581) - Delete legacy loopMode fallback

**Test Impact**: None - legacy paths are unreachable with current feature flags.

### 5. Visual Verification of TimeConsole [LOW PRIORITY]

**Action**: Manual test that TimeConsole UI switches between Finite/Cycle/Infinite modes.

**Test Cases**:
1. Load patch with FiniteTimeRoot - verify finite UI (progress bar, play-to-end)

3. Load patch with InfiniteTimeRoot - verify infinite UI (sliding window)

**Acceptance**: UI matches spec diagrams in `design-docs/3-Synthesized/07-UI-Spec.md`

### 6. Clarify TimeModel Update Timing [MEDIUM PRIORITY]

**Action**: Decide on spec conflict - immediate rebuild vs. scheduled at pulse boundary.

**Research Needed**:
1. Check WP6 (Hot Swap Scheduling) for guidance
2. Prototype both approaches
3. Measure jank impact of immediate rebuild

**Output**: Update spec with final decision, implement accordingly.

---

## Verdict

**Status**: PARTIAL COMPLETION

- [ ] CONTINUE - Core works, but missing spec features and dependency gaps
- [ ] PAUSE - Need clarification on TimeModel update timing and WP0 dependency

**Blocking Issues**:
1. Bus auto-publication cannot be safely implemented without WP0 (reserved bus enforcement)
2. Spec conflict on TimeModel update timing needs resolution

**Non-Blocking Gaps** (can be deferred):
- Missing optional inputs (phaseOffset, drift)
- Legacy code cleanup
- TimeConsole UI visual verification

**Recommendation**: PAUSE for planning clarification:
1. Should WP1 wait for WP0 completion?
2. Or proceed with "provisional" auto-publication + validation TODOs?
3. Resolve TimeModel update timing spec conflict

---

## Files in Scope

**Core Implementation** (23 files):
- `src/editor/blocks/time-root.ts` (183 lines) - Block definitions
- `src/editor/compiler/blocks/domain/TimeRoot.ts` (121 lines) - Compilers
- `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` (259 lines) - Tests
- `src/editor/compiler/compile.ts` (lines 374-528) - TimeModel inference
- `src/editor/runtime/player.ts` (lines 100, 406-429, 522-581) - Player integration
- `src/editor/stores/RootStore.ts` (lines 262-270) - Auto-insertion
- `src/editor/PreviewPanel.tsx` (lines 144, 204) - TimeModel application
- `src/editor/components/TimeConsole.tsx` - UI mode switching
- `src/editor/compiler/featureFlags.ts` (line 52) - requireTimeRoot flag
- `design-docs/3-Synthesized/02-Time-Architecture.md` - Spec reference

**Related Files** (not directly part of WP1 but needed for completion):
- `src/editor/compiler/blocks/index.ts` - Block registry
- `src/editor/compiler/integration.ts` - Compiler service
- `src/editor/stores/BusStore.ts` - Bus semantics (for auto-publication)

---

## Confidence Assessment

| Area | Confidence | Evidence |
|------|------------|----------|
| TimeRoot block definitions | HIGH | Reviewed code + tests |
| TimeRoot compilers | HIGH | Reviewed code + tests + math verification |
| TimeModel inference | HIGH | Reviewed code + integration |
| Player time advancement | HIGH | Reviewed code + cached eval (mathematically proven) |
| Player TimeModel integration | HIGH | Traced data flow PreviewPanel -> Player |
| Bus auto-publication | NONE | Feature doesn't exist |
| Missing outputs | HIGH | Spec vs implementation comparison |
| Dependency status | HIGH | Checked .agent_planning/ directories |

**Overall Confidence**: HIGH for what exists, HIGH for what's missing (clear spec gaps).

---

## Next Actions

### If CONTINUE:

2. Add bus auto-publication with validation TODOs
3. Write integration tests for auto-publication
4. Remove legacy inference code
5. Visual test TimeConsole UI modes

### If PAUSE:
1. Clarify dependency order: WP0 before WP1, or proceed with TODOs?
2. Resolve TimeModel update timing spec conflict
3. Create WP0 STATUS/PLAN if WP0 is next
4. Document "provisional completion" status for WP1
