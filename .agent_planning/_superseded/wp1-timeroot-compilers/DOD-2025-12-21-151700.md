# Definition of Done: WP1 TimeRoot Compilers

**Generated**: 2025-12-21-151700
**Plan**: PLAN-2025-12-21-151700.md
**Topic**: wp1-timeroot-compilers
**Source STATUS**: STATUS-20251221-133500.md

---

## Sprint Scope

This sprint delivers **complete TimeRoot compiler implementation** with:
1. TimeOutputs bundle (time, phaseA, wrap, energy) for all TimeRoot types
2. Auto-publication to canonical buses (phaseA, pulse, energy)
3. WP0 contract validation gates (reserved bus enforcement)

**Deferred**:
- Dynamic energy derivation (constant 1.0 baseline for now)
- Phase offset injection for scrubbing (WP6)
- Scheduled hot-swap at pulse boundary (WP6)

---

## Acceptance Criteria

### [P0] WP0 Contract Validation Gates

- [ ] `validateReservedBuses()` function in compile.ts ensures canonical buses exist
  - Validates: phaseA (Signal<phase>, last), pulse (Event, or), energy (Signal<number>, sum)
- [ ] Compile error returned if auto-publication targets non-existent bus
- [ ] Compile error returned if auto-publication type mismatches bus type
- [ ] Test: Reserved bus validation catches type mismatch (e.g., phaseA with wrong type)
- [ ] Test: Missing reserved bus triggers compile error with message: "Required bus 'phaseA' not found"

### [P0] TimeOutputs Bundle Interface

- [ ] `TimeOutputs` interface defined in src/editor/compiler/types.ts with fields:
  - time: Artifact (Signal<time>)
  - phaseA: Artifact (Signal<phase>)
  - wrap: Artifact (Event)
  - energy: Artifact (Signal<number>)

- [ ] FiniteTimeRoot compiler returns TimeOutputs-shaped object
- [ ] InfiniteTimeRoot compiler returns TimeOutputs-shaped object
- [ ] Test: All TimeRoot compile results conform to TimeOutputs shape
- [ ] Test: Energy values are >= 0 for all TimeRoots (typically 0..2 range)




  - systemTime (Signal<time>)
  - cycleT (Signal<time>)
  - phase (Signal<phase>)
  - wrap (Event)
  - cycleIndex (Signal<number>)
  - energy (Signal<number>)
- [ ] Compiler implements cycleT: `cycleT = tMs % periodMs`
- [ ] Compiler implements wrap event: fires when `floor(tMs/period) > floor(lastTMs/period)`
- [ ] Compiler implements cycleIndex: `cycleIndex = floor(tMs / periodMs)`
- [ ] Compiler implements energy: returns constant 1.0
- [ ] Pingpong mode: wrap fires on both forward→backward AND backward→forward transitions
- [ ] Test: Wrap event fires exactly once per period at t=0, period, 2*period (loop mode)
- [ ] Test: Wrap event fires twice per period in pingpong mode
- [ ] Test: cycleIndex increments correctly (0, 1, 2...) and stays stable between wraps
- [ ] Test: Negative time (tMs < 0) does NOT trigger wrap event

### [P0] FiniteTimeRoot End Event

- [ ] FiniteTimeRoot block definition adds `end` event output
- [ ] Compiler implements end event: fires when `progress >= 1 && lastProgress < 1`
- [ ] End event fires exactly once (not continuously while progress=1)
- [ ] TimeOutputs bundle: `wrap` field maps to end event for FiniteTimeRoot
- [ ] Test: End event fires at durationMs transition (e.g., t=5000 for 5s duration)
- [ ] Test: End event does NOT fire on subsequent frames after completion

### [P1] Auto-Publication to Canonical Buses


  - { busName: 'phaseA', artifactKey: 'phase', sortKey: 0 }
  - { busName: 'pulse', artifactKey: 'wrap', sortKey: 0 }
  - { busName: 'energy', artifactKey: 'energy', sortKey: 0 }
- [ ] FiniteTimeRoot compiler returns autoPublications:
  - { busName: 'progress', artifactKey: 'progress', sortKey: 0 }
  - { busName: 'pulse', artifactKey: 'end', sortKey: 0 }
  - { busName: 'energy', artifactKey: 'energy', sortKey: 0 }
- [ ] InfiniteTimeRoot compiler returns autoPublications:
  - { busName: 'energy', artifactKey: 'energy', sortKey: 0 }
- [ ] Bus Board visualizes auto-publications with distinct styling (e.g., "system" badge or icon)



### [P1] Update Block Definitions with All Outputs


- [ ] FiniteTimeRoot (time-root.ts) outputs array includes all 4 outputs
- [ ] InfiniteTimeRoot (time-root.ts) outputs array includes both outputs
- [ ] Block inspector UI displays all outputs with clear labels

- [ ] Manual wiring: Can connect FiniteTimeRoot.end output to arbitrary consumer

### [P1] Compiler Tests for New Outputs


  - t=0→period: wrap fires once
  - t=period→2*period: wrap fires once

  - Even→odd cycle: wrap fires
  - Odd→even cycle: wrap fires

  - t=0: cycleIndex=0
  - t=period+1: cycleIndex=1
  - t=2*period+1: cycleIndex=2
- [ ] Test: FiniteTimeRoot end event fires exactly once at durationMs
- [ ] Test: All TimeRoots emit energy signal >= 0

- [ ] Test: FiniteTimeRoot autoPublications array contains progress, pulse, energy
- [ ] Test: InfiniteTimeRoot autoPublications array contains energy
- [ ] Test: All autoPublications have sortKey=0
- [ ] Test: Negative time (tMs < 0) does not trigger wrap or end events

### [P2] Remove Legacy Inference Paths

- [ ] Delete PhaseMachine TimeModel inference (compile.ts lines ~484-505)
- [ ] Delete PhaseClock TimeModel inference (compile.ts lines ~510-528)
- [ ] Delete player.loopMode fallback logic (player.ts lines ~558-581)
- [ ] Delete player.playDirection property declaration (player.ts line ~92)
- [ ] All existing tests still pass after deletion
- [ ] No compile errors from removing legacy code
- [ ] Grep search confirms no live references to deleted code

### [P2] Visual Verification of TimeConsole UI

- [ ] Load patch with FiniteTimeRoot → TimeConsole shows progress bar UI (not phase ring)

- [ ] Load patch with InfiniteTimeRoot → TimeConsole shows sliding window UI (no phase ring)
- [ ] Scrubbing works in all three modes without UI errors or incorrect displays

- [ ] Screenshots captured for all three UI modes (saved to docs or test artifacts)

### [P3] Clarify TimeModel Update Timing

- [ ] Decision documented: Immediate vs. scheduled update approach chosen
- [ ] Spec updated (02-Time-Architecture.md) with final timing semantics
- [ ] If scheduled: Implementation plan added to WP6 roadmap
- [ ] If immediate: Rationale documented for accepting phase jump on period change
- [ ] Prototype tested (optional): Both approaches compared for jank severity

---

## Test Coverage Requirements

**Unit Tests** (TimeRoot.test.ts):
- Minimum 15 new test cases covering:
  - Wrap events (loop mode, pingpong mode, edge cases)
  - CycleIndex increments
  - End event firing
  - Energy signal values
  - AutoPublications array correctness

**Integration Tests** (bus-compilation.test.ts or new file):
- Minimum 3 integration tests:

  - Wrap events reach pulse bus
  - SortKey ordering (TimeRoot sortKey=0 < manual sortKey=100)

**Visual Tests** (manual):
- TimeConsole UI mode switching (3 modes verified)

---

## Quality Gates

**Before Merging**:
1. [ ] `just check` passes (typecheck + lint + tests)
2. [ ] All P0 and P1 acceptance criteria met
3. [ ] Integration tests prove auto-publication works end-to-end
4. [ ] No regression in existing TimeRoot tests
5. [ ] Code review: Auto-publication logic is clear and maintainable

**Optional (P2/P3)**:
6. [ ] Legacy code removed (tech debt cleanup)
7. [ ] TimeConsole UI verified visually
8. [ ] Spec docs updated for timing semantics

---

## Success Metrics

**Functional**:
- All TimeRoot types emit complete TimeOutputs bundles

- Wrap events fire at correct time boundaries
- Zero manual wiring needed for phase→phaseA connection

**Quality**:
- Test coverage: 90%+ of new code (wrap, energy, auto-pub logic)
- Zero compile errors or warnings
- No runtime crashes in TimeConsole UI

**Architectural**:
- Auto-publications NOT persisted in patch data (computed at compile time)
- Reserved bus validation prevents type mismatches
- WP0 contracts formalized (prerequisite for WP2)

---

## Known Limitations (Documented)

**Not Included in WP1**:
1. Dynamic energy signal (speed/acceleration modulation) → Future WP
2. Phase offset injection for scrubbing → WP6
3. Scheduled hot-swap at pulse boundary → WP6

5. Full WP0 contract enforcement (only reserved buses validated) → Parallel WP0

**Technical Debt Accepted**:
- Energy = constant 1.0 (placeholder for dynamic energy)
- Immediate TimeModel rebuild (may cause phase jump jank) → WP6 polish

---

## Handoff to Next Sprint

**WP2 Prerequisites Met**:
- ✅ Wrap events available for pulse bus
- ✅ Auto-publications provide baseline bus routing
- ✅ Reserved bus validation ensures type safety

**Artifacts for WP2**:
- TimeOutputs interface (standardized output shape)
- AutoPublications mechanism (template for other auto-routing)
- WP0 validation gates (expandable for full TypeDesc checks)

**Open Questions for WP2**:
- Should bus combination semantics (last, sum, or) be configurable? (Currently fixed per reserved bus)
