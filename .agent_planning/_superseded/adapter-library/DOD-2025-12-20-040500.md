# Definition of Done: Adapter Library

**Topic:** adapter-library
**Date:** 2025-12-20

## Acceptance Criteria

### Essential (Must Have)

- [ ] **AC1: Clamp lens implemented**
  - `clamp(min, max)` lens type added to `lenses.ts`
  - Bounds values to [min, max] range
  - Preset "Safe Unit" (0-1) added
  - Tests verify clamping behavior

- [ ] **AC2: Lens stack support**
  - `Listener.lensStack?: LensDefinition[]` replaces single `lens`
  - Compiler applies lenses in sequence
  - BusStore updated with stack manipulation actions
  - Backward compatible migration for existing patches

- [ ] **AC3: Additional shaping lenses**
  - `offset(amount)` - add constant to value
  - `deadzone(threshold)` - zero values below threshold
  - `mapRange(inMin, inMax, outMin, outMax)` - linear mapping
  - Each has corresponding presets

- [ ] **AC4: Stack UI in LensSelector**
  - Show ordered list of lenses in stack
  - Add lens button (from presets or custom)
  - Remove lens button per item
  - Clear visual of input→output type flow

- [ ] **AC5: Tests for new functionality**
  - Unit tests for each new lens type
  - Integration tests for lens stack chaining
  - Tests for edge cases (empty stack, error propagation)
  - All existing tests still pass

### High Value (Should Have)

- [ ] **AC6: Reduce adapters**
  - `fieldSum` - sum all field elements to signal
  - `fieldMean` - average all field elements
  - `fieldMax` - max of all field elements
  - Clear type change indication in UI

- [ ] **AC7: Lens metadata**
  - `LensMeta` type with stateful, changesWorld, costHint
  - Visual indicators in UI (memory dot, type badges)
  - Compiler uses metadata for validation

### Nice to Have (Could Have)

- [ ] **AC8: Advanced shaping lenses**
  - `softclip(drive)` - tanh-based soft clipping
  - `wavefold(threshold)` - wave folding
  - Presets for common use cases

- [ ] **AC9: Stack reordering**
  - Drag-and-drop reorder in LensSelector
  - Move up/down buttons as fallback

- [ ] **AC10: Live preview**
  - Show value before/after each lens step
  - Real-time update as parameters change

---

## Verification Steps

### Manual Testing
1. Add a block with bus listener
2. Add clamp lens → verify values bounded
3. Add second lens (scale) → verify both applied in order
4. Remove first lens → verify only second applies
5. Save/reload patch → verify lens stack persists

### Automated Testing
```bash
just test src/editor/__tests__/lenses.test.ts
just check  # Full validation
```

### Runtime Check
- Open dev server (`just dev`)
- Create patch with bus listener
- Apply lens stack
- Verify animation responds to lens transformations

---

## Exit Criteria

**Minimum viable:** AC1-AC5 complete
**Full implementation:** AC1-AC7 complete
**Stretch:** AC1-AC10 complete
