# PLAN: Full Adapter Library Implementation

**Date:** 2025-12-20
**Topic:** adapter-library
**Complexity:** Medium-High

## Overview

Extend the existing lens system to support the full adapter specification from `04-Adapters.md`. The foundation is solid - we're extending, not rewriting.

## Implementation Phases

### Phase 1: Core Lens Additions (Essential)

#### 1.1 Add Missing Lens Types to `lenses.ts`

**Clamp lens** (highest priority):
```typescript
case 'clamp':
  const { min, max } = params as { min: number; max: number };
  return Math.max(min, Math.min(max, value));
```

**Offset lens** (separate from scale):
```typescript
case 'offset':
  const { amount } = params as { amount: number };
  return value + amount;
```

**Deadzone lens**:
```typescript
case 'deadzone':
  const { threshold } = params as { threshold: number };
  return Math.abs(value) < threshold ? 0 : value;
```

**MapRange lens**:
```typescript
case 'mapRange':
  const { inMin, inMax, outMin, outMax } = params;
  const normalized = (value - inMin) / (inMax - inMin);
  return outMin + normalized * (outMax - outMin);
```

#### 1.2 Update Type Definitions (`types.ts`)

```typescript
// Extend LensType union
type LensType =
  | 'ease' | 'slew' | 'quantize' | 'scale' | 'warp'
  | 'broadcast' | 'perElementOffset'
  | 'clamp' | 'offset' | 'deadzone' | 'mapRange'  // NEW
  | 'softclip' | 'wavefold';                       // NEW

// Change Listener interface
interface Listener {
  id: string;
  busId: string;
  blockId: BlockId;
  port: string;
  // OLD: lens?: LensDefinition
  lensStack?: LensDefinition[];  // NEW: array for chaining
}
```

#### 1.3 Add Lens Presets for New Types

In `lens-presets.ts`:
```typescript
{ id: 'safe-unit', type: 'clamp', params: { min: 0, max: 1 }, label: 'Safe Unit' },
{ id: 'dead-5pct', type: 'deadzone', params: { threshold: 0.05 }, label: '5% Deadzone' },
```

### Phase 2: Lens Stack Support

#### 2.1 Update BusStore (`stores/BusStore.ts`)

```typescript
// Update Listener interface in store
interface Listener {
  ...
  lensStack?: LensDefinition[];  // Replaces lens
}

// Update addListener
addListener(busId, blockId, port, adapterChain?, lensStack?: LensDefinition[])

// Add stack manipulation
addLensToStack(listenerId: string, lens: LensDefinition, index?: number)
removeLensFromStack(listenerId: string, index: number)
reorderLensStack(listenerId: string, fromIndex: number, toIndex: number)
```

#### 2.2 Update Compiler (`compiler/compileBusAware.ts`)

```typescript
// Replace single lens application with stack loop
if (busListener.lensStack && busListener.lensStack.length > 0) {
  for (const lens of busListener.lensStack) {
    if (busArtifact.kind !== 'Error') {
      busArtifact = applyLens(busArtifact, lens);
    }
  }
}
```

#### 2.3 Migration Helper

Create backward-compat migration:
```typescript
// Convert old lens to lensStack
if (listener.lens && !listener.lensStack) {
  listener.lensStack = [listener.lens];
  delete listener.lens;
}
```

### Phase 3: Reduce Adapters

#### 3.1 Add Field→Signal Reducers (`lenses.ts`)

```typescript
case 'fieldSum':
  if (artifact.kind !== 'Field') return artifact;
  return {
    kind: 'Signal',
    type: 'Signal<number>',
    value: (t, ctx) => artifact.value.reduce((a, b) => a + b, 0)
  };

case 'fieldMean':
  // Similar, divide by length

case 'fieldMax':
  // Similar, use Math.max
```

#### 3.2 Add Type Metadata

Mark lenses that change world/domain:
```typescript
interface LensMeta {
  type: LensType;
  changesWorld: boolean;  // true for broadcast, fieldSum, etc.
  changesDomain: boolean; // true for phaseToNumber, etc.
  stateful: boolean;      // true for slew
  costHint: 'none' | 'light' | 'heavy';
}
```

### Phase 4: UI Enhancements

#### 4.1 Lens Stack Editor in `LensSelector.tsx`

- Show ordered list of lenses in stack
- Add/remove lens buttons
- Drag-to-reorder functionality
- Type preview at each step (input type → output type)

#### 4.2 Preset Categories

Group presets by function:
- Shaping: clamp, deadzone, scale
- Easing: ease, warp
- Timing: slew, quantize
- World: broadcast, fieldSum

#### 4.3 Visual Indicators

- Memory dot for stateful lenses (slew)
- Type change badges for world-changing lenses
- Cost hints (light/heavy)

### Phase 5: Testing

#### 5.1 Unit Tests (`lenses.test.ts`)

- All new lens types (clamp, offset, deadzone, mapRange, softclip, wavefold)
- Lens stack chaining (apply A then B)
- Reduce adapters (fieldSum, fieldMean, fieldMax)
- Edge cases (empty stack, error propagation)

#### 5.2 Integration Tests

- Compiler correctly chains stacks
- BusStore stack manipulation
- UI add/remove/reorder

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/editor/types.ts` | Add new LensTypes, change Listener.lens to Listener.lensStack |
| `src/editor/lenses.ts` | Add clamp, offset, deadzone, mapRange, softclip, wavefold, fieldSum, fieldMean, fieldMax |
| `src/editor/lens-presets.ts` | Add presets for new lens types |
| `src/editor/stores/BusStore.ts` | Update Listener model, add stack manipulation actions |
| `src/editor/compiler/compileBusAware.ts` | Loop through lensStack instead of single lens |
| `src/editor/components/LensSelector.tsx` | Stack UI, reorder, type preview |
| `src/editor/__tests__/lenses.test.ts` | Tests for all new lenses and stack chaining |

---

## Implementation Order

1. **types.ts** - Add new types first (foundation)
2. **lenses.ts** - Implement new lens functions
3. **lens-presets.ts** - Add presets for new types
4. **BusStore.ts** - Update Listener model with migration
5. **compileBusAware.ts** - Update compiler for stacks
6. **LensSelector.tsx** - Update UI for stacks
7. **lenses.test.ts** - Add comprehensive tests

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing patches | Migration helper converts old `lens` to `lensStack[0]` |
| Complex UI for stacks | Start simple (add/remove), add drag-reorder later |
| Reduce adapters change types | Clear type metadata, UI warnings |

---

## Complexity Estimate

| Phase | Complexity |
|-------|------------|
| Phase 1 (Core Additions) | Low - just adding cases |
| Phase 2 (Stack Support) | Medium - data model + compiler |
| Phase 3 (Reduce Adapters) | Medium - new artifact kinds |
| Phase 4 (UI) | Medium-High - stack management |
| Phase 5 (Testing) | Low - systematic coverage |

**Total:** Medium-High complexity, but incremental and testable
