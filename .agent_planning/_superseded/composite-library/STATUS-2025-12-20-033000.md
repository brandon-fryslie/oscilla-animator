# Composite Library - Status Report
**Timestamp:** 2025-12-20-033000
**Scope:** composite-library/full
**Confidence:** FRESH

---

## Executive Summary

The composite/macro system is in a fragmented state:
- **42 primitives exist**, only **8 used in composites** (19% utilization)
- **9 composites implemented**, spec calls for **17 composites** (53% coverage)
- **Legacy macro system exists** but is NOT INTEGRATED with current composite system
- **34 primitives are unused** in any composite (81% of primitives)

**Critical Finding:** The legacy macro system (15 macros) and the new composite system (9 composites) are completely separate code paths. No macros expand into composites or vice versa.

---

## Primitive Inventory

### All Primitives (42 total)

**Domain/Scene (4):**
- DomainN ✓ (used in composites)
- GridDomain
- StableIdHash
- ViewportInfo

**Spatial Arrangement (3):**
- PositionMapGrid ✓
- PositionMapCircle ✓
- PositionMapLine ✓

**Field Math (7):**
- FieldMapNumber ✓
- FieldMapVec2 ✓
- FieldZipNumber
- FieldZipSignal
- FieldFromSignalBroadcast
- FieldAddVec2
- JitterFieldVec2

**Field Generation (3):**
- FieldHash01ById ✓
- FieldConstNumber
- FieldConstColor

**Field Styling (2):**
- FieldColorize
- FieldOpacity

**Signal Processing (4):**
- Oscillator
- Shaper
- ColorLFO
- AddSignal

**Signal Math (4):**
- MulSignal
- MinSignal
- MaxSignal
- ClampSignal

**Rhythm/Events (2):**
- PulseDivider
- EnvelopeAD

**Render (9):**
- RenderInstances2D ✓
- ParticleRenderer
- CircleNode
- GroupNode
- RenderTreeAssemble
- PerElementCircles
- PathRenderer
- MaskReveal
- Canvas

**Time (3):**

- FiniteTimeRoot
- InfiniteTimeRoot

**FX (1):**
- GlowFilter

---

## Composite Implementation Status

### Implemented Composites (9)

| Composite | Primitives Used | Purpose |
|-----------|----------------|---------|
| GridPoints | DomainN, PositionMapGrid | Grid arrangement |
| CirclePoints | DomainN, PositionMapCircle | Circle arrangement |
| LinePoints | DomainN, PositionMapLine | Line arrangement |
| PerElementRandom | FieldHash01ById | Random values wrapper |
| PerElementPhaseOffset | FieldHash01ById, FieldMapNumber | Phase offsets |
| SizeScatter | FieldHash01ById, FieldMapNumber (3 nodes) | Size variation |
| OrbitMotion | FieldMapVec2 | Orbital rotation |
| WaveDisplace | FieldHash01ById, FieldMapNumber (4 nodes) | Wave displacement |
| DotsRenderer | RenderInstances2D | Complete render pipeline |

**Primitives Coverage:** 8/42 primitives (19%)

### Missing Composites (from design spec)

**From 11-starter-composites.md:**
1. ✅ Grid Points - IMPLEMENTED
2. ✅ Circle Points - IMPLEMENTED
3. ✅ Line Points - IMPLEMENTED
4. ❌ SVG Sample Points - NOT IMPLEMENTED (no SVGSample primitive exists)
5. ✅ Per-Element Random - IMPLEMENTED
6. ✅ Per-Element Phase Offset - IMPLEMENTED
7. ✅ Size Scatter - IMPLEMENTED
8. ❌ Rotation Scatter - NOT IMPLEMENTED
9. ✅ Orbit Motion - IMPLEMENTED
10. ✅ Wave Displace - IMPLEMENTED
11. ❌ Breathing Scale - NOT IMPLEMENTED
12. ❌ Palette Drift - NOT IMPLEMENTED
13. ❌ Per-Element Color Scatter - NOT IMPLEMENTED
14. ✅ Dots Renderer - IMPLEMENTED
15. ❌ Glyph/Path Instances Renderer - NOT IMPLEMENTED
16. ❌ Pulse → Envelope - NOT IMPLEMENTED
17. ❌ Phase Wrap Pulse - NOT IMPLEMENTED

**Status:** 9/17 composites implemented (53%)

---

## Legacy Macro System Analysis

### Location
`src/editor/blocks/legacy/macros.ts`

### Macro Inventory (15 macros)

**Animation Styles (9):**
- MacroLineDrawing
- MacroParticles
- MacroBouncingCircle
- MacroOscillator
- MacroRadialBurst
- MacroCascade
- MacroScatter
- MacroImplosion
- MacroSwarm
- MacroLoveYouBaby
- MacroNebula

**Effects (4):**
- MacroGlitchStorm
- MacroAurora
- MacroRevealMask
- MacroLiquid

### Critical Issues

**1. Macro Form vs Composite Form**
- Macros have `form: 'macro'` - expand immediately when added
- Composites have `form: 'composite'` - expand only at compile time
- Design spec conflates these: calls composites "macros"

**2. No Macro Expansion Implementation**
```typescript
// macros.ts defines blocks with form: 'macro'
// But no expansion logic exists anywhere
// createMacro() returns BlockDefinition with empty inputs/outputs
```

**3. Macro Registration**
- Macros are NOT registered via `registerComposite()`
- They return BlockDefinition directly
- No graph, no internal nodes, no expansion spec

**4. Design Spec Ambiguity**
The spec says "Ship with 10 macros" but also describes them as composites:
> "Why 'GridPoints' Should Be a Composite"
> "GridPoints (composite) = Domain(n) + GridMap(domain) + RenderDots(...)"

**This is a fundamental terminology/architecture mismatch.**

---

## Primitive Utilization Analysis

### Highly Composable Primitives (NOT in composites)

**Signal Processing (complete orphan category):**
- Oscillator - Core signal generator from phase
- Shaper - Signal waveshaping
- ColorLFO - Color from phase
- AddSignal, MulSignal, MinSignal, MaxSignal, ClampSignal

**Why orphaned?** No signal-based composites exist yet. The current 9 composites are field-only.

**Rhythm/Events (orphaned):**
- PulseDivider - Subdivide phase into ticks
- EnvelopeAD - Attack/Decay envelope

**Missing composite:** "Pulse → Envelope" from spec would use EnvelopeAD

**Field Styling (orphaned):**
- FieldColorize - Map Field<number> to Field<color>
- FieldOpacity - Map Field<number> to opacity

**Missing composite:** "Per-Element Color Scatter" from spec needs FieldColorize

**Field Math (partially orphaned):**
- FieldZipNumber - Combine two Field<number>
- FieldZipSignal - Combine Field with Signal
- FieldFromSignalBroadcast - Signal → Field broadcast
- FieldAddVec2 - Add two vec2 fields
- JitterFieldVec2 - Animated drift

**Only FieldMapNumber and FieldMapVec2 are used**

**Render (mostly orphaned):**
- ParticleRenderer, CircleNode, GroupNode, RenderTreeAssemble, etc.
- Only RenderInstances2D is used

**Why?** These are legacy render primitives from old system. RenderInstances2D is the new unified renderer.

---

## Genuinely Useful vs Contrived Composites

### Current Composites: Quality Assessment

**Genuinely Useful (7):**
1. GridPoints - Solves "I need a grid" in one step
2. CirclePoints - Solves "I need a circle" in one step
3. LinePoints - Solves "I need a line" in one step
4. PerElementPhaseOffset - Non-obvious combination (hash → scale)
5. SizeScatter - Non-obvious pipeline (hash → range mapping)
6. WaveDisplace - Complex 4-node pipeline (hash → radians → sin → amplitude)
7. DotsRenderer - Complete render pipeline

**Borderline (2):**
- PerElementRandom - Thin wrapper around FieldHash01ById (barely adds value)
- OrbitMotion - Thin wrapper around FieldMapVec2 with fn='rotate'

### Missing High-Value Composites

**From Design Spec (8 missing):**
1. **Breathing Scale** - Oscillator + map to [min,max] + publish to energy bus
2. **Palette Drift** - ColorLFO + publish to palette bus
3. **Per-Element Color Scatter** - FieldHash01ById + FieldColorize
4. **Rotation Scatter** - FieldHash01ById + map to [0, 2π]
5. **Pulse → Envelope** - EnvelopeAD wrapper subscribing to pulse bus
6. **Phase Wrap Pulse** - PulseDivider wrapper
7. **Glyph Renderer** - RenderInstances2D with path asset support
8. **SVG Sample Points** - BLOCKED (no SVGSample primitive)

**Why Missing?**
- Signal-based composites (Breathing Scale, Palette Drift) need bus-aware composite system
- Render composites need RenderInstances2D improvements
- SVG sampling needs new primitive

---

## Architecture Constraints

### Composite Expansion: Editor vs Compiler

**Current Implementation (domain-composites.ts):**
- Composites registered via `registerComposite()`
- Stored in `CompositeStore`
- Expansion happens at **compile time** via `expandComposites()` in compiler

**Design Spec (11-starter-composites.md):**
- Describes "macros" that expand into blocks
- Says "decomposable into primitives"
- Implies immediate UI expansion

**Conflict:** Spec terminology is ambiguous. Are these:
- **Composites** (single block in UI, expand at compile time)?
- **Macros** (expand immediately into visible blocks)?

**Current codebase supports both:**
- `form: 'composite'` - Compile-time expansion
- `form: 'macro'` - Immediate expansion (but no expansion logic exists)

### Bus-Aware Composites

**Current Limitation:**
Composites can wire internal nodes but cannot:
- Auto-subscribe to buses (e.g., "phaseA")
- Auto-publish to buses (e.g., "energy")

**Example:** "Breathing Scale" composite from spec:
```
Oscillator(phaseA from bus) → MapRange → Publish to energy bus
```

This requires composite graph to specify:
- `inputMap: { phase: { busSubscribe: 'phaseA' } }`
- `outputMap: { out: { busPublish: 'energy' } }`

**Status:** Not implemented. Composite system doesn't understand buses yet.

---

## Ambiguities Found

| Area | Question | Impact |
|------|----------|--------|
| **Terminology** | Are "macros" and "composites" the same thing? | Spec uses both terms for what seem to be composites |
| **Expansion Timing** | When should composites expand? | Spec implies immediate, code does compile-time |
| **Bus Integration** | Can composites auto-subscribe/publish to buses? | 5 missing composites need this |
| **Legacy Macros** | What's the migration path for 15 legacy macros? | They're defined but not functional |
| **Primitive Purpose** | Are legacy render blocks (CircleNode, etc.) deprecated? | Only RenderInstances2D is used |
| **Composite Goals** | Is the goal 2+ composites per primitive? | User said yes, but many primitives are low-level |

---

## Missing Primitives (for spec-defined composites)

| Composite | Missing Primitive | Workaround |
|-----------|-------------------|------------|
| SVG Sample Points | SVGSampleDomain | None - composite blocked |
| Glyph Renderer | (RenderInstances2D needs path support) | Extend existing primitive |

---

## Recommendations

### Immediate Priorities

**1. Clarify Terminology (PAUSE for user input)**
- Q: Are "macros" (immediate expansion) and "composites" (compile-time expansion) the same?
- Q: What's the intended behavior of the 15 legacy macros in macros.ts?
- Q: Should composites expand in UI or at compile time?

**2. Implement Missing High-Value Composites (8 composites)**
- Breathing Scale
- Palette Drift
- Per-Element Color Scatter
- Rotation Scatter
- Pulse → Envelope
- Phase Wrap Pulse
- Glyph Renderer
- (SVG Sample Points - blocked on new primitive)

**3. Add Bus-Aware Composite Support**
- Extend composite graph schema:
  - `busSubscriptions: { inputPort: busName }`
  - `busPublications: { outputPort: busName }`
- Update composite compiler to wire bus connections

**4. Primitive Coverage Strategy**

**Do NOT force composites for low-level math primitives:**
- AddSignal, MulSignal, MinSignal, MaxSignal, ClampSignal
- FieldZipNumber, FieldAddVec2
- These are building blocks, not composite targets

**Focus composites on:**
- Common workflows (GridPoints ✓)
- Non-obvious combinations (WaveDisplace ✓)
- Bus-driven patterns (Breathing Scale, Palette Drift)
- Complete pipelines (DotsRenderer ✓)

**5. Legacy Render Block Strategy**
- **Deprecate:** CircleNode, GroupNode, RenderTreeAssemble, PerElementCircles
- **Keep:** RenderInstances2D (unified renderer)
- **Extend:** RenderInstances2D to support paths (for Glyph Renderer)

---

## Primitive Utilization Target

**Realistic Goal:**
- 20 composites using 25-30 primitives (60-70% utilization)
- NOT every primitive needs 2+ composites
- Math operators are building blocks, not composite targets

**Current Gap:**
- 9 composites → 20 composites: **11 more composites needed**
- 8 primitives used → 25 primitives used: **17 more primitives needed**

**Path Forward:**
1. Implement 8 missing spec composites → 17 composites, ~15 primitives
2. Add 3 creative composites → 20 composites, ~25 primitives

---

## Data Flow Verification

**N/A** - Composites are metadata, not runtime code. Verification is at expansion time.

**What CAN be verified:**
- [ ] Do composite graphs reference valid primitive types?
- [ ] Do internal edges connect compatible ports?
- [ ] Do exposed ports map to valid internal nodes?

**Spot Check: GridPoints**
```typescript
nodes: {
  domain: { type: 'DomainN', ... },  // ✓ Valid primitive
  grid: { type: 'PositionMapGrid', ... }  // ✓ Valid primitive
},
edges: [
  { from: 'domain.domain', to: 'grid.domain' }  // ✓ Domain → Domain
],
outputMap: {
  domain: 'domain.domain',  // ✓ Valid node.port
  positions: 'grid.pos'     // ✓ Valid node.port
}
```

**Status:** GridPoints graph is well-formed. Other composites not spot-checked.

---

## Test Suite Assessment

**No tests found for:**
- Composite registration
- Composite expansion
- Composite graph validation
- Macro expansion (if macros exist)

**Search performed:**
```bash
find src -name "*.test.ts" -exec grep -l "composite\|macro" {} \;
```

**Result:** No composite/macro tests exist.

**Impact:** No way to verify composite graphs are valid without manual inspection or runtime errors.

---

## Workflow Recommendation

**PAUSE** - Clarification needed before proceeding:

### Clarification Questions

**1. Terminology and Architecture**
- Are "macros" (form: macro, immediate expansion) and "composites" (form: composite, compile-time expansion) the same concept, or distinct?
- What should happen to the 15 legacy macros in macros.ts?

**2. Expansion Timing**
- Should composites expand into visible blocks in the UI (macro-style)?
- Or remain as single blocks and expand only at compile time (current behavior)?

**3. Bus Integration**
- Should composites be able to auto-subscribe/publish to buses?
- If yes, this is a prerequisite for 5 missing composites (Breathing Scale, Palette Drift, etc.)

**4. Coverage Goals**
- Is "every primitive in 2+ composites" a strict goal?
- Or is it acceptable for low-level math primitives (AddSignal, FieldZipNumber, etc.) to remain building blocks?

---

## Verdict

**Status:** INCOMPLETE

**Blocking Issues:**
1. Terminology ambiguity (macro vs composite)
2. Bus-aware composite support missing
3. 8/17 spec composites not implemented (47% missing)
4. 34/42 primitives unused in composites (81% orphaned)

**Next Steps:**
1. Get user clarification on 4 questions above
2. Implement bus-aware composite support
3. Implement 8 missing spec composites
4. Add 3 creative composites for coverage
5. Add tests for composite system

**Confidence:** FRESH (just evaluated)
**Files Examined:** 15
**Primitives Cataloged:** 42
**Composites Analyzed:** 9
**Macros Found:** 15
