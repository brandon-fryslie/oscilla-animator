# Composite Library Sprint Plan
**Generated:** 2025-12-20-032425
**Source:** STATUS-2025-12-20-033000.md
**Topic:** composite-library

---

## Executive Summary

**Current State:**
- 9/17 composites implemented (53% of spec)
- 8/42 primitives used in composites (19% utilization)
- 34 primitives orphaned (81% unused)
- No bus-aware composite support (blocks 5 spec composites)

**Sprint Goal:**
Complete the 8 missing composites from design spec, establishing composite coverage for signal-based workflows and achieving realistic primitive utilization (60-70%).

**Sprint Deliverables:**
- 8 new composites (17/17 spec coverage = 100%)
- Bus-aware composite support for signal-based composites
- Primitive utilization increased from 19% to ~60%
- Test coverage for composite system

**Out of Scope for Sprint:**
- Macro expansion system (separate architecture work)
- Legacy macro migration (blocked on terminology clarification)
- SVG Sample Points composite (blocked on missing primitive)

---

## Dependencies and Blockers

### Prerequisites
✓ Composite registration system exists (composites.ts)
✓ Composite compiler expansion exists (compiler)
✓ 9 reference composites exist as templates

### Blockers Resolved
- **Bus-aware composites**: Will implement as part of this sprint (P0 item)
- **Signal-based composites**: Depends on bus support (sequential dependency)

### Deferred Blockers
- **SVG Sample Points**: Requires new SVGSampleDomain primitive (not in scope)
- **Macro/Composite terminology**: User clarification needed (doesn't block composites)

---

## Work Items by Priority

### P0 (Critical) - Foundation for Signal Composites

#### P0-1: Bus-Aware Composite Support

**Status:** Not Started
**Effort:** Medium (3-5 days)
**Dependencies:** None
**Spec Reference:** 11-starter-composites.md sections 11-12, 16-17 • **Status Reference:** STATUS-2025-12-20-033000.md "Bus-Aware Composites"

**Description:**
Extend the composite graph schema and compiler to support auto-subscribing to buses and auto-publishing to buses. This unblocks all signal-based composites that need to consume/produce bus values (Breathing Scale, Palette Drift, Pulse→Envelope, Phase Wrap Pulse).

**Acceptance Criteria:**
- [ ] CompositeGraph schema extended with `busSubscriptions: Record<string, string>` (inputPort → busName)
- [ ] CompositeGraph schema extended with `busPublications: Record<string, string>` (outputPort → busName)
- [ ] Composite compiler wires bus subscriptions during expansion
- [ ] Composite compiler wires bus publications during expansion
- [ ] Test: Composite with bus subscription compiles to correct graph with bus listener connection
- [ ] Test: Composite with bus publication compiles to correct graph with bus publisher connection

**Technical Notes:**
- Schema change in `src/editor/composites.ts`
- Compiler changes in composite expansion logic
- Reference the existing bus system in BusStore for connection patterns
- Bus subscriptions map composite input ports to bus listeners
- Bus publications map composite output ports to bus publishers

---

### P1 (High) - Complete Missing Spec Composites

#### P1-1: Rotation Scatter Composite

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** None
**Spec Reference:** 11-starter-composites.md section 8 • **Status Reference:** STATUS-2025-12-20-033000.md "Missing Composites"

**Description:**
Create RotationScatter composite that generates per-element rotation values in [0, 2π] range using FieldHash01ById + FieldMapNumber. Parallel to SizeScatter but for rotation.

**Acceptance Criteria:**
- [ ] RotationScatter composite registered with unique ID
- [ ] Graph: FieldHash01ById → FieldMapNumber(scale by amount, map to [0, 2π])
- [ ] Exposed input: domain (Domain)
- [ ] Exposed output: rotation (Field&lt;number&gt;)
- [ ] Exposed params: seed, amount
- [ ] Test: Generates stable rotation values per element ID
- [ ] Test: amount=1.0 produces full [0, 2π] range, amount=0.5 produces [0, π]

**Technical Notes:**
- Follow SizeScatter pattern in domain-composites.ts
- Use FieldMapNumber with fn='scale' and k=6.28318530718 (2π)
- Rotation semantics in radians, not degrees

---

#### P1-2: Breathing Scale Composite (Bus-Driven)

**Status:** Not Started
**Effort:** Medium (3-5 days)
**Dependencies:** P0-1 (bus-aware composite support)
**Spec Reference:** 11-starter-composites.md section 11 • **Status Reference:** STATUS-2025-12-20-033000.md "Bus-Aware Composites"

**Description:**
Create BreathingScale composite that consumes phase from phaseA bus, uses Oscillator to generate breathing signal, maps to [min, max] range, and publishes to energy bus. Core pattern for global pulse effects.

**Acceptance Criteria:**
- [ ] BreathingScale composite registered
- [ ] Graph: Oscillator(shape=sine) → MapRange [min, max]
- [ ] Bus subscription: phase input auto-subscribes to 'phaseA' bus
- [ ] Bus publication: output auto-publishes to 'energy' bus
- [ ] Exposed params: min, max, curve (oscillator shape)
- [ ] Test: Compiles with bus connections correctly wired
- [ ] Test: Different curve values produce different waveshapes

**Technical Notes:**
- First composite using bus subscription/publication
- Requires Oscillator primitive and signal math blocks
- MapRange implemented as FieldMapNumber or signal math combination
- Publishes to 'energy' bus using sum combination semantics

---

#### P1-3: Palette Drift Composite (Bus-Driven)

**Status:** Not Started
**Effort:** Medium (3-5 days)
**Dependencies:** P0-1 (bus-aware composite support)
**Spec Reference:** 11-starter-composites.md section 12 • **Status Reference:** STATUS-2025-12-20-033000.md "Signal Processing orphaned"

**Description:**
Create PaletteDrift composite using ColorLFO to generate slow color evolution from phase input, publishing to palette bus. Enables global color coherence across patch.

**Acceptance Criteria:**
- [ ] PaletteDrift composite registered
- [ ] Graph: ColorLFO(phaseIn from bus)
- [ ] Bus subscription: phase input auto-subscribes to 'phaseB' bus (secondary slow phase)
- [ ] Bus publication: color output auto-publishes to 'palette' bus
- [ ] Exposed params: baseColor, hueSpan, saturation, lightness
- [ ] Test: Compiles with correct bus connections
- [ ] Test: hueSpan parameter controls color range

**Technical Notes:**
- Uses ColorLFO primitive from block registry
- Publishes to 'palette' bus using last-value combination
- phaseB is secondary/slow phase clock (user creates via PhaseClock block)

---

#### P1-4: Per-Element Color Scatter Composite

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** None
**Spec Reference:** 11-starter-composites.md section 13 • **Status Reference:** STATUS-2025-12-20-033000.md "Field Styling orphaned"

**Description:**
Create PerElementColorScatter composite that takes base color and applies per-element hue offsets using FieldHash01ById + FieldColorize. Adds individuality while maintaining palette coherence.

**Acceptance Criteria:**
- [ ] PerElementColorScatter composite registered
- [ ] Graph: FieldHash01ById → FieldMapNumber(map to hue offset range) → FieldColorize
- [ ] Exposed input: domain (Domain), baseColor (Field&lt;color&gt; or Scalar&lt;color&gt;)
- [ ] Exposed output: fill (Field&lt;color&gt;)
- [ ] Exposed params: seed, hueShiftAmount
- [ ] Test: Same seed produces same color distribution
- [ ] Test: Different hueShiftAmount values produce different variance

**Technical Notes:**
- Uses FieldColorize primitive for color manipulation
- Hue offsets applied in HSL color space
- Can accept baseColor from palette bus via connection

---

#### P1-5: Pulse to Envelope Composite (Bus-Driven)

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** P0-1 (bus-aware composite support)
**Spec Reference:** 11-starter-composites.md section 16 • **Status Reference:** STATUS-2025-12-20-033000.md "Rhythm/Events orphaned"

**Description:**
Create PulseToEnvelope composite wrapping EnvelopeAD, subscribing to pulse bus for triggers, producing attack-decay envelope signal. Core pattern for accent-driven energy.

**Acceptance Criteria:**
- [ ] PulseToEnvelope composite registered
- [ ] Graph: EnvelopeAD(trigger from bus)
- [ ] Bus subscription: trigger input auto-subscribes to 'pulse' bus
- [ ] Bus publication: envelope output optionally publishes to 'energy' bus (or exposed as output)
- [ ] Exposed params: attack, decay, peak
- [ ] Test: Pulse events trigger envelope correctly
- [ ] Test: Attack/decay times control envelope shape

**Technical Notes:**
- Uses EnvelopeAD primitive from block registry
- Pulse bus uses 'or' combination semantics (any trigger fires)
- Output can publish to energy bus (sum) or be used directly

---

#### P1-6: Phase Wrap Pulse Composite (Bus-Driven)

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** P0-1 (bus-aware composite support)
**Spec Reference:** 11-starter-composites.md section 17 • **Status Reference:** STATUS-2025-12-20-033000.md "Rhythm/Events orphaned"

**Description:**
Create PhaseWrapPulse composite using PulseDivider to generate periodic triggers from phase, publishing to pulse bus. Converts continuous phase to discrete rhythm events.

**Acceptance Criteria:**
- [ ] PhaseWrapPulse composite registered
- [ ] Graph: PulseDivider(phase from bus, divisions)
- [ ] Bus subscription: phase input auto-subscribes to 'phaseA' bus
- [ ] Bus publication: tick output auto-publishes to 'pulse' bus
- [ ] Exposed params: divisions, mode (rising/wrap)
- [ ] Test: Generates correct number of pulses per cycle
- [ ] Test: divisions=4 produces 4 evenly-spaced triggers

**Technical Notes:**
- Uses PulseDivider primitive from block registry
- Publishes to pulse bus (or combination)
- divisions=1 produces wrap pulse, divisions>1 produces subdivisions

---

#### P1-7: Glyph Renderer Composite

**Status:** Not Started
**Effort:** Medium (3-5 days)
**Dependencies:** None (uses existing RenderInstances2D)
**Spec Reference:** 11-starter-composites.md section 15 • **Status Reference:** STATUS-2025-12-20-033000.md "Render orphaned"

**Description:**
Create GlyphRenderer composite similar to DotsRenderer but configured for path/glyph rendering. Uses RenderInstances2D with path asset support. Note: May require RenderInstances2D extension to support path shapes.

**Acceptance Criteria:**
- [ ] GlyphRenderer composite registered
- [ ] Graph: RenderInstances2D with path configuration
- [ ] Exposed inputs: domain, positions, rotation (Field&lt;number&gt;), scale (Field&lt;number&gt;)
- [ ] Exposed params: pathAsset, baseSize, opacity, color
- [ ] Test: Compiles successfully with path asset reference
- [ ] Test: Rotation and scale inputs affect rendered glyphs

**Technical Notes:**
- RenderInstances2D may need path shape support (check current implementation)
- If path support missing, this becomes a composite + primitive enhancement task
- Follow DotsRenderer pattern in domain-composites.ts
- Path asset references handled via asset system

---

#### P1-8: Jitter Motion Composite

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** None
**Spec Reference:** Implicit from JitterFieldVec2 primitive • **Status Reference:** STATUS-2025-12-20-033000.md "Field Math partially orphaned"

**Description:**
Create JitterMotion composite wrapping JitterFieldVec2 with convenient interface for animated drift. Adds gentle organic motion to positioned elements using per-element random seeds and phase-driven animation.

**Acceptance Criteria:**
- [ ] JitterMotion composite registered
- [ ] Graph: FieldHash01ById → JitterFieldVec2(idRand, phase, amount, frequency)
- [ ] Exposed inputs: domain, phase (Signal&lt;phase&gt;)
- [ ] Exposed output: drift (Field&lt;vec2&gt;)
- [ ] Exposed params: seed, amount (pixels), frequency (cycles)
- [ ] Test: Same seed produces same drift pattern
- [ ] Test: Phase input drives continuous animation
- [ ] Test: amount parameter scales drift magnitude

**Technical Notes:**
- Uses JitterFieldVec2 primitive currently orphaned
- Combines with FieldHash01ById for per-element variation
- Useful for subtle organic motion in ambient systems
- Drift adds to positions via FieldAddVec2 downstream

---

### P2 (Medium) - Quality and Testing

#### P2-1: Composite System Test Suite

**Status:** Not Started
**Effort:** Medium (3-5 days)
**Dependencies:** P1-1 through P1-8 (composite implementations)
**Spec Reference:** N/A • **Status Reference:** STATUS-2025-12-20-033000.md "Test Suite Assessment"

**Description:**
Create comprehensive test suite for composite system covering registration, graph validation, expansion, and compilation. Currently no tests exist for composite/macro system.

**Acceptance Criteria:**
- [ ] Test file created: `src/editor/__tests__/composite-library.test.ts`
- [ ] Test: All 17 composites registered correctly
- [ ] Test: Composite graphs reference valid primitive types
- [ ] Test: Internal edges connect compatible port types
- [ ] Test: Exposed ports map to valid internal nodes
- [ ] Test: Bus-aware composites expand with correct bus connections
- [ ] Test: Composite compilation produces valid program graphs
- [ ] Test: Parameter forwarding (__fromParam) works correctly
- [ ] Integration test: End-to-end composite→compilation→runtime for each composite

**Technical Notes:**
- Extend existing `composite.expansion.test.ts` and `composites.test.ts`
- Use vitest framework (already in project)
- Mock compiler context for isolated composite tests
- Validate TypeDesc compatibility for port connections

---

#### P2-2: Composite Documentation

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** P1-1 through P1-8 (composite implementations)
**Spec Reference:** N/A • **Status Reference:** N/A

**Description:**
Document all 17 composites with purpose, inputs/outputs, parameters, and usage examples. Update composite library documentation to reflect current state.

**Acceptance Criteria:**
- [ ] Documentation file created: `docs/composite-library.md` or inline JSDoc
- [ ] Each composite documented with: purpose, graph structure, exposed ports, parameters
- [ ] Usage examples for each composite category (domain, variation, motion, color, render, rhythm)
- [ ] Bus integration patterns documented
- [ ] Migration guide from legacy macros (if applicable)

**Technical Notes:**
- Follow format from 11-starter-composites.md spec
- Include visual diagrams of composite internal graphs (optional)
- Document bus-aware composite patterns for future composite authors

---

### P3 (Low) - Future Enhancements

#### P3-1: SVG Sample Points Composite (Blocked)

**Status:** Blocked
**Effort:** Large (blocked on primitive implementation)
**Dependencies:** New SVGSampleDomain primitive
**Spec Reference:** 11-starter-composites.md section 4 • **Status Reference:** STATUS-2025-12-20-033000.md "Missing Primitives"

**Description:**
BLOCKED: Requires SVGSampleDomain primitive which doesn't exist. Deferred to future sprint focused on SVG integration.

**Acceptance Criteria:**
- [ ] BLOCKED: Awaiting SVGSampleDomain primitive implementation

**Technical Notes:**
- This is spec item #4 but blocked on missing primitive
- SVG sampling is a significant feature requiring path parsing, sampling algorithm
- Consider separate sprint for SVG support

---

## Primitive Coverage Analysis

### Current Coverage (9 composites, 8 primitives)
**Used primitives:**
- DomainN (GridPoints, CirclePoints, LinePoints)
- PositionMapGrid, PositionMapCircle, PositionMapLine
- FieldHash01ById (PerElementRandom, PerElementPhaseOffset, SizeScatter, WaveDisplace)
- FieldMapNumber, FieldMapVec2
- RenderInstances2D

### After Sprint Coverage (17 composites, ~25 primitives)
**Newly covered primitives:**
- **Signal Processing:** Oscillator (BreathingScale), ColorLFO (PaletteDrift)
- **Rhythm/Events:** EnvelopeAD (PulseToEnvelope), PulseDivider (PhaseWrapPulse)
- **Field Styling:** FieldColorize (PerElementColorScatter)
- **Field Math:** JitterFieldVec2 (JitterMotion), FieldAddVec2 (color combining)
- **Signal Math:** MapRange/AddSignal/MulSignal (via BreathingScale signal chain)

**Still Orphaned (Acceptable):**
Low-level math operators that serve as building blocks:
- MinSignal, MaxSignal, ClampSignal (signal math utilities)
- FieldZipNumber, FieldFromSignalBroadcast (field utilities)
- FieldConstNumber, FieldConstColor (constant sources)
- Legacy render blocks (CircleNode, GroupNode, etc.) - deprecated

**Coverage Target:** 25/42 primitives = 60% (realistic goal achieved)

---

## Dependency Graph

```
P0-1: Bus-Aware Composite Support
  └─> P1-2: Breathing Scale
  └─> P1-3: Palette Drift
  └─> P1-5: Pulse to Envelope
  └─> P1-6: Phase Wrap Pulse

P1-1: Rotation Scatter (independent)
P1-4: Per-Element Color Scatter (independent)
P1-7: Glyph Renderer (independent)
P1-8: Jitter Motion (independent)

P1-1 through P1-8 (all composites)
  └─> P2-1: Test Suite
  └─> P2-2: Documentation
```

**Critical Path:** P0-1 → P1-2/P1-3/P1-5/P1-6 → P2-1

---

## Recommended Sprint Execution Order

### Week 1: Foundation
1. **P0-1:** Bus-aware composite support (unblocks signal composites)
2. **P1-1:** Rotation Scatter (simple, validates bus-free pattern)
3. **P1-4:** Per-Element Color Scatter (simple, validates field styling)

### Week 2: Signal-Based Composites
4. **P1-2:** Breathing Scale (validates bus subscription/publication)
5. **P1-3:** Palette Drift (validates ColorLFO integration)
6. **P1-5:** Pulse to Envelope (validates event-driven patterns)
7. **P1-6:** Phase Wrap Pulse (validates pulse generation)

### Week 3: Render & Motion
8. **P1-8:** Jitter Motion (validates JitterFieldVec2 usage)
9. **P1-7:** Glyph Renderer (may need RenderInstances2D extension)
10. **P2-1:** Test suite (validates all implementations)
11. **P2-2:** Documentation (capture patterns and usage)

---

## Risk Assessment

### High Risk Items

**P0-1: Bus-Aware Composite Support**
- **Risk:** Schema changes may break existing composites
- **Mitigation:** Ensure backward compatibility, test all 9 existing composites after change

**P1-7: Glyph Renderer**
- **Risk:** RenderInstances2D may not support path shapes yet
- **Mitigation:** Audit RenderInstances2D implementation first, scope as composite+primitive task if needed

### Medium Risk Items

**Bus-Driven Composites (P1-2, P1-3, P1-5, P1-6)**
- **Risk:** Bus connection semantics may differ from manual wiring
- **Mitigation:** Reference BusStore and existing bus compilation logic, add integration tests

### Low Risk Items

**Simple Field Composites (P1-1, P1-4, P1-8)**
- **Risk:** Minimal - follow established patterns from existing composites
- **Mitigation:** Use SizeScatter and WaveDisplace as templates

---

## Success Criteria

**Sprint Objectives Met:**
- [ ] 17/17 spec composites implemented (100% coverage)
- [ ] Bus-aware composite system functional
- [ ] Primitive utilization ≥60% (25+ primitives in use)
- [ ] All new composites have test coverage
- [ ] Composite library documented

**Quality Gates:**
- [ ] `just check` passes (typecheck + lint + test)
- [ ] All composites compile without errors
- [ ] Integration tests verify end-to-end composite→program flow
- [ ] No breaking changes to existing 9 composites

**Definition of Done:**
- [ ] All P0 and P1 items completed
- [ ] P2 items completed or explicitly deferred with rationale
- [ ] Code reviewed and merged
- [ ] Documentation updated
- [ ] Ready for /dev-loop:implement

---

## Deferred Items (Future Sprints)

**Not in Scope:**
1. **Macro Expansion System** - Requires architecture decision on macro vs composite forms
2. **Legacy Macro Migration** - Blocked on terminology clarification
3. **SVG Sample Points Composite** - Blocked on SVGSampleDomain primitive
4. **Advanced Composites** - User-requested patterns beyond spec (e.g., 3D rotation, path morphing)

**Rationale:**
- Focus sprint on completing spec-defined composites
- Macro/composite terminology needs user clarification before expansion work
- SVG support is a separate feature area requiring new primitives

---

## Notes

**Terminology Clarification Pending:**
The STATUS file identified ambiguity between "macros" (immediate expansion) and "composites" (compile-time expansion). This sprint assumes composites (compile-time expansion) as per current codebase implementation. If user clarifies macros should expand immediately, a separate sprint will handle conversion.

**Bus System Assumption:**
Assumes existing bus system (BusStore, publishers, listeners) is functional. Bus-aware composite support extends this to composite definitions but doesn't modify core bus semantics.

**Primitive Coverage Philosophy:**
Not every primitive needs multiple composites. Low-level math operators (AddSignal, ClampSignal, etc.) are building blocks for composite internals, not composite targets. 60% coverage is realistic and sufficient.
