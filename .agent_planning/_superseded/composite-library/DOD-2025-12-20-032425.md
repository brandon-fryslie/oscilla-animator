# Definition of Done: Composite Library Sprint
**Generated:** 2025-12-20-032425
**Plan:** PLAN-2025-12-20-032425.md

---

## Acceptance Criteria

### P0-1: Bus-Aware Composite Support

- [ ] CompositeGraph schema extended with `busSubscriptions: Record<string, string>` (inputPort → busName)
- [ ] CompositeGraph schema extended with `busPublications: Record<string, string>` (outputPort → busName)
- [ ] Composite compiler wires bus subscriptions during expansion
- [ ] Composite compiler wires bus publications during expansion

### P1-1: Rotation Scatter Composite

- [ ] RotationScatter composite registered with unique ID
- [ ] Graph: FieldHash01ById → FieldMapNumber(scale by amount, map to [0, 2π])
- [ ] Exposed input: domain (Domain)
- [ ] Exposed output: rotation (Field&lt;number&gt;)
- [ ] Exposed params: seed, amount
- [ ] Test: Generates stable rotation values per element ID
- [ ] Test: amount=1.0 produces full [0, 2π] range, amount=0.5 produces [0, π]

### P1-2: Breathing Scale Composite

- [ ] BreathingScale composite registered
- [ ] Graph: Oscillator(shape=sine) → MapRange [min, max]
- [ ] Bus subscription: phase input auto-subscribes to 'phaseA' bus
- [ ] Bus publication: output auto-publishes to 'energy' bus
- [ ] Exposed params: min, max, curve (oscillator shape)
- [ ] Test: Compiles with bus connections correctly wired
- [ ] Test: Different curve values produce different waveshapes

### P1-3: Palette Drift Composite

- [ ] PaletteDrift composite registered
- [ ] Graph: ColorLFO(phaseIn from bus)
- [ ] Bus subscription: phase input auto-subscribes to 'phaseB' bus (secondary slow phase)
- [ ] Bus publication: color output auto-publishes to 'palette' bus
- [ ] Exposed params: baseColor, hueSpan, saturation, lightness
- [ ] Test: Compiles with correct bus connections
- [ ] Test: hueSpan parameter controls color range

### P1-4: Per-Element Color Scatter Composite

- [ ] PerElementColorScatter composite registered
- [ ] Graph: FieldHash01ById → FieldMapNumber(map to hue offset range) → FieldColorize
- [ ] Exposed input: domain (Domain), baseColor (Field&lt;color&gt; or Scalar&lt;color&gt;)
- [ ] Exposed output: fill (Field&lt;color&gt;)
- [ ] Exposed params: seed, hueShiftAmount
- [ ] Test: Same seed produces same color distribution
- [ ] Test: Different hueShiftAmount values produce different variance

### P1-5: Pulse to Envelope Composite

- [ ] PulseToEnvelope composite registered
- [ ] Graph: EnvelopeAD(trigger from bus)
- [ ] Bus subscription: trigger input auto-subscribes to 'pulse' bus
- [ ] Bus publication: envelope output optionally publishes to 'energy' bus (or exposed as output)
- [ ] Exposed params: attack, decay, peak
- [ ] Test: Pulse events trigger envelope correctly
- [ ] Test: Attack/decay times control envelope shape

### P1-6: Phase Wrap Pulse Composite

- [ ] PhaseWrapPulse composite registered
- [ ] Graph: PulseDivider(phase from bus, divisions)
- [ ] Bus subscription: phase input auto-subscribes to 'phaseA' bus
- [ ] Bus publication: tick output auto-publishes to 'pulse' bus
- [ ] Exposed params: divisions, mode (rising/wrap)
- [ ] Test: Generates correct number of pulses per cycle
- [ ] Test: divisions=4 produces 4 evenly-spaced triggers

### P1-7: Glyph Renderer Composite

- [ ] GlyphRenderer composite registered
- [ ] Graph: RenderInstances2D with path configuration
- [ ] Exposed inputs: domain, positions, rotation (Field&lt;number&gt;), scale (Field&lt;number&gt;)
- [ ] Exposed params: pathAsset, baseSize, opacity, color
- [ ] Test: Compiles successfully with path asset reference
- [ ] Test: Rotation and scale inputs affect rendered glyphs

### P1-8: Jitter Motion Composite

- [ ] JitterMotion composite registered
- [ ] Graph: FieldHash01ById → JitterFieldVec2(idRand, phase, amount, frequency)
- [ ] Exposed inputs: domain, phase (Signal&lt;phase&gt;)
- [ ] Exposed output: drift (Field&lt;vec2&gt;)
- [ ] Exposed params: seed, amount (pixels), frequency (cycles)
- [ ] Test: Same seed produces same drift pattern
- [ ] Test: Phase input drives continuous animation
- [ ] Test: amount parameter scales drift magnitude

### P2-1: Composite System Test Suite

- [ ] Test file created: `src/editor/__tests__/composite-library.test.ts`
- [ ] Test: All 17 composites registered correctly
- [ ] Test: Composite graphs reference valid primitive types
- [ ] Test: Internal edges connect compatible port types
- [ ] Test: Exposed ports map to valid internal nodes
- [ ] Test: Bus-aware composites expand with correct bus connections
- [ ] Test: Composite compilation produces valid program graphs
- [ ] Test: Parameter forwarding (__fromParam) works correctly
- [ ] Integration test: End-to-end composite→compilation→runtime for each composite

### P2-2: Composite Documentation

- [ ] Documentation file created: `docs/composite-library.md` or inline JSDoc
- [ ] Each composite documented with: purpose, graph structure, exposed ports, parameters
- [ ] Usage examples for each composite category (domain, variation, motion, color, render, rhythm)
- [ ] Bus integration patterns documented
- [ ] Migration guide from legacy macros (if applicable)

---

## Sprint Scope

**This sprint delivers:**
- 8 new composites (RotationScatter, BreathingScale, PaletteDrift, PerElementColorScatter, PulseToEnvelope, PhaseWrapPulse, GlyphRenderer, JitterMotion)
- Bus-aware composite support (schema + compiler)
- Comprehensive test suite for composite system
- Complete composite library documentation

**Deferred to future sprints:**
- Macro expansion system (architecture decision needed)
- Legacy macro migration (terminology clarification needed)
- SVG Sample Points composite (blocked on SVGSampleDomain primitive)

**Success metrics:**
- 17/17 spec composites implemented (100% coverage)
- Primitive utilization ≥60% (25+ primitives in use)
- All composites have test coverage
- `just check` passes with no errors

---

## Quality Gates

- [ ] All P0 and P1 work items completed
- [ ] All acceptance criteria met for each work item
- [ ] `just check` passes (typecheck + lint + test)
- [ ] All composites compile without errors in test harness
- [ ] Integration tests verify composite→program compilation
- [ ] No breaking changes to existing 9 composites
- [ ] Documentation complete and accurate

---

## Ready for Implementation

- [ ] Plan reviewed and approved
- [ ] Dependencies understood and resolved
- [ ] Effort estimates acceptable
- [ ] Sprint scope clearly bounded
- [ ] Success criteria unambiguous
