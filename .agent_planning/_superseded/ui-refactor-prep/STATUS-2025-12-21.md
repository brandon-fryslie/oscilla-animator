# UI Refactor Prep - Consolidated Status
**Evaluation Date**: 2025-12-21 12:30
**Scope**: All 9 issues from design-docs/10-Refactor-for-UI-prep/1-Overview.md
**Evaluators**: 6 parallel project-evaluator agents

---

## Executive Summary

| Issue | Priority | Status | Completion | Blocker? |
|-------|----------|--------|------------|----------|
| #1 Port Identity | P0 | Quick fix DONE, arch deferred | 100% quick / 0% arch | ❌ 18 test failures (unrelated) |
| #2 Time Authority | P0 | Core DONE, flag off | 85% | No |
| #3 Layout as Projection | P1 | NOT STARTED | 0% | No |
| #4 Shared Validation | P1 | Almost DONE | 95% | No |
| #5 Bus Semantics | P1 | PARTIAL, divergence found | 40% | HIGH RISK |
| #6-9 Patch Ops/Tx | P2 | Foundations only | 15% | No |

**Critical Finding**: **18 test failures** blocking CI/CD (from Semantic Validator commit e4f3ee7, NOT from port identity work)

---

## Issue #1: Port Identity (P0)

**Spec**: `design-docs/10-Refactor-for-UI-prep/2-PortIdentity.md`
**Status**: Quick Fix COMPLETE, Architectural Foundation DEFERRED

### What's Done ✅
- BindingEndpoint migration (70+ files, `.port` → `.slotId + .dir`)

- Port validation in compileBusAware.ts (fail-fast with PortMissing diagnostics)
- 738/738 tests passing at sprint completion

### What's Deferred ⏳
- Composite port maps and boundary enforcement
- Type-based port resolution
- Stable slotId versioning system
- Two-phase compilation model

### Current Blocker ❌
18 test failures from subsequent Semantic Validator work (commit e4f3ee7).
- NOT a port identity regression
- Preflight validation rejecting valid test connections
- Needs investigation: validator vs test block structures

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/STATUS-port-identity-2025-12-21.md`

---

## Issue #2: Time Authority (P0)

**Spec**: `design-docs/10-Refactor-for-UI-prep/3-Time.md`
**Status**: 85% COMPLETE

### What's Done ✅
- Player time monotonic for cyclic/infinite (commit 1857bb8)
- TimeRoot compilers derive phase correctly via modulo
- TimeModel inference from TimeRoot exists
- Player.applyTimeModel() works correctly

### What Remains ❌
1. `requireTimeRoot: false` → needs to be `true` (featureFlags.ts:52)
2. Legacy PhaseClock/PhaseMachine inference fallbacks (delete from compileBusAware.ts:782-804)
3. Auto-insert default TimeRoot on patch creation

### Next Actions
1. Flip feature flag to true
2. Remove legacy fallbacks
3. Add auto-insert on patch creation
4. Update 3 test files that disable flag

**Complexity**: Low (1-2 hours, mechanical changes)

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/STATUS-time-authority-2025-12-21.md`
- `/Users/bmf/code/oscilla-animator/.agent_planning/eval-cache/time-architecture.md`

---

## Issue #3: Layout as Projection (P1)

**Spec**: `design-docs/10-Refactor-for-UI-prep/4-Layout-As-Projection.md`
**Status**: 0% (NOT STARTED)

### Problem
Lanes are embedded in patch semantics instead of being UI projections:
- `PatchStore.lanes: Lane[]` with `blockIds` arrays
- Lanes serialized in every patch file
- `advancedLaneMode` stored in patch settings
- Switching layouts mutates patch document

### Fix Required
1. Create ViewStateStore (migrate UI state out of patch)
2. Make lane assignment computed (from block semantics)
3. Remove lanes from PatchDocument (breaking change)

### Good News
Modulation table already demonstrates correct ViewState pattern at `src/editor/modulation-table/types.ts:210-270`

**Priority**: After Port Identity and Time Authority

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/EVAL-layout-projection-2025-12-21.md`

---

## Issue #4: Shared Validation Layer (P1)

**Spec**: `design-docs/10-Refactor-for-UI-prep/5-DivergentTypes.md`
**Status**: 95% COMPLETE

### What's Done ✅
- SemanticGraph with full indices (graph.ts)
- Validator with all core rules (validator.ts)
- Type compatibility via canonical isAssignable()
- Compiler uses Validator.validateAll() before codegen
- PatchStore uses Validator.canAddConnection() for preflight
- 24 tests, all passing

### What Remains ❌
- DiagnosticHub.runAuthoringValidators() doesn't call Validator (10 lines to fix)
- Only checks TimeRoot, misses other authoring errors

### Next Action
Replace DiagnosticHub.runAuthoringValidators() to call Validator.validateAll()

**Complexity**: Low (30 minutes)

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/EVAL-shared-validation-2025-12-21.md`

---

## Issue #5: Bus Semantics Module (P1) - HIGH RISK

**Spec**: `design-docs/10-Refactor-for-UI-prep/1-Overview.md` Issue #5
**Status**: PARTIALLY COMPLETE, CRITICAL DIVERGENCE FOUND

### Problem

**BusStore.ts** (UI):
```typescript
}
```

**compileBusAware.ts** (Compiler):
```typescript
    if (a.sortKey !== b.sortKey) return a.sortKey - b.sortKey;
    return a.id.localeCompare(b.id);  // HAS TIE-BREAKER
  });
}
```

**Impact**: Same sortKey = different ordering in UI vs runtime → invisible bugs

### Additional Issues
- Enabled/disabled filtering inconsistent (UI shows disabled, compiler ignores)
- Combine logic duplicated in compileBusAware and FieldExpr

### Fix Required
Create `src/editor/semantic/busSemantics.ts` with canonical:
- `combineSignalArtifacts()` / `combineFieldArtifacts()`

**Priority**: CRITICAL for multi-UI work

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/EVAL-bus-semantics-2025-12-21.md`

---

## Issues #6-9: Patch Semantics & Transactions (P2)

**Specs**:
- `design-docs/10-Refactor-for-UI-prep/7-PatchSemantics.md`
- `design-docs/10-Refactor-for-UI-prep/8-PatchOpsCompleteSet.md`
- `design-docs/10-Refactor-for-UI-prep/9-TransactionBuilderContract.md`
- `design-docs/10-Refactor-for-UI-prep/10-TxView-Query-Surface.md`

**Status**: 15% (Foundations only)

### What Exists (15%)
- SemanticGraph with indices ✅
- Validator with structural rules ⚠️
- PortKey canonical identity ✅
- PatchDocument adapter ✅

### What's Missing (85%)
- Transaction builder API (0%)
- Operation types and apply/invert (0%)
- TxView query surface (0%)
- History tree persistence (0%)
- Mutation through ops (PatchStore uses direct mutation)

### Implementation Roadmap
1. Phase 1: Op Types (2-3 days complexity)
2. Phase 2: Transaction Builder (3-4 days complexity)
3. Phase 3: History/Undo (2-3 days complexity)
4. Phase 4: TxView Surface (3-4 days complexity)
5. Phase 5: PatchStore Migration (2-3 days complexity)

**Total**: 12-17 days complexity

**Files**:
- `/Users/bmf/code/oscilla-animator/.agent_planning/ui-refactor-prep/STATUS-patch-semantics-transactions.md`

---

## Recommended Sprint Priority

### IMMEDIATE (Before new feature work)
1. **Fix 18 test failures** - Semantic Validator blocking CI/CD
2. **Complete Time Authority** - Flip flag, remove fallbacks (1-2 hours)
3. **Complete Shared Validation** - DiagnosticHub fix (30 min)
4. **Bus Semantics Unification** - Critical for multi-UI (2-4 hours)

### NEXT SPRINT
5. **Layout as Projection Phase 1** - Create ViewStateStore, non-breaking

### FUTURE SPRINTS
6. **Port Identity Arch** - Composite boundaries, type-based resolution
7. **Patch Ops/Tx System** - 12-17 days complexity

---

## Test Suite Status

**Current**: 744 passed / 765 total (18 failures)

**Failing Tests** (from Semantic Validator, NOT port identity):
- `PatchStore.events.test.ts` - Wire event emission (8 failures)
- `GraphCommitted.test.ts` - Event counts (7 failures)
- BlockReplaced events (3 failures)

**Root Cause**: Validator.canAddConnection() rejecting valid test connections

**Fix Needed**: Debug validator vs test block slot structures

---

## Dependencies

```
Port Identity Quick Fix ✅ ────┬──→ Time Authority Cleanup (85%)
                               ├──→ Shared Validation Cleanup (95%)
                               └──→ Bus Semantics Unification (40%)
                                         │
                                         ▼
                               Layout as Projection (0%)
                                         │
                                         ▼
                               Port Identity Arch (0%)
                               Patch Ops/Tx System (15%)
```

---

## Verdict

**Status**: CONTINUE with prioritized sprint

**Recommended Sprint Scope**:
1. Fix 18 broken tests (BLOCKER)
2. Complete Time Authority (2 small gaps)
3. Complete Shared Validation (1 small gap)
4. Create Bus Semantics module (HIGH RISK if deferred)

**Defer**: Layout projection, Port Identity arch, Patch Ops/Tx
