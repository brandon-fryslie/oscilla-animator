# Definition of Done: UI Refactor Prep - Sprint 2
**Generated**: 2025-12-21-123509
**Plan**: PLAN-2025-12-21-123509.md
**Source**: STATUS-2025-12-21.md, evaluation files in topic directory

---

## Sprint Scope

This sprint delivers **3 critical foundation pieces**:
1. Fix 18 test failures (BLOCKER)
2. Complete Time Authority (85% → 100%)
3. Create Bus Semantics Module (40% → 80%)

**Deferred**: DiagnosticHub fix, Layout as Projection, Port Identity arch, Patch Ops/Tx

---

## Acceptance Criteria

### Deliverable 1: Fix 18 Test Failures (P0 BLOCKER)

**Overall**:
- [ ] All 765 tests pass (`just test` shows 765 passed / 765 total)
- [ ] No tests use `suppressValidation` flag as workaround
- [ ] CI/CD pipeline green

**Wire Event Emission** (8 failures):
- [ ] WireAdded event emits when `PatchStore.connect()` succeeds
- [ ] WireRemoved event emits when `PatchStore.removeConnection()` succeeds
- [ ] Event payload includes correct `fromBlockId`, `fromSlotId`, `toBlockId`, `toSlotId`
- [ ] Test: `PatchStore.events.test.ts` - all wire event tests pass

**GraphCommitted Events** (7 failures):
- [ ] GraphCommitted event reports correct `bindingsChanged` count
- [ ] bindingsChanged increments when connection added
- [ ] bindingsChanged increments when connection removed
- [ ] Test: `GraphCommitted.test.ts` - all binding change count assertions pass

**BlockReplaced Events** (3 failures):
- [ ] BlockReplaced event includes `droppedConnections` array
- [ ] droppedConnections populated when replaced block has fewer ports
- [ ] droppedConnections includes all wire endpoints that became invalid
- [ ] Test: BlockReplaced event tests pass

**Validator Integration**:
- [ ] `Validator.canAddConnection()` correctly identifies valid test connections
- [ ] `Validator.canAddConnection()` uses correct slot ID format (`.slotId`, not `.port`)
- [ ] `patchAdapter.ts` correctly maps block slots to SemanticGraph format
- [ ] Validation errors have clear messages explaining why connection rejected

---

### Deliverable 2: Complete Time Authority (P0)

**Feature Flag Enforcement**:
- [ ] `src/editor/compiler/featureFlags.ts:52` - `requireTimeRoot: true` (default)
- [ ] Patches without TimeRoot fail compilation with `E_TIME_ROOT_MISSING` error
- [ ] Error message includes actionable suggestion: "Add a TimeRoot block (Finite, Cycle, or Infinite)"
- [ ] Test: Patch without TimeRoot triggers validation error

**Legacy Fallback Removal**:
- [ ] PhaseClock inference deleted from `compileBusAware.ts` (lines 782-798)
- [ ] PhaseMachine inference deleted from `compileBusAware.ts` (lines 762-779)
- [ ] Default infinite fallback deleted from `compileBusAware.ts` (lines 801-804)
- [ ] Only TimeRoot-based inference remains in `inferTimeModel()` function
- [ ] Grep confirms zero references to PhaseClock/PhaseMachine in time inference code

**Auto-Insert Default TimeRoot**:

- [ ] Auto-inserted TimeRoot appears in lane 0 (Time lane)
- [ ] Auto-inserted TimeRoot labeled "Main Clock" or similar
- [ ] Test: Create new patch → verify TimeRoot exists

**Test Updates**:
- [ ] All tests that disabled `requireTimeRoot` flag updated to use TimeRoot blocks
- [ ] Find: `grep -r "requireTimeRoot: false" src/` returns zero results in test files
- [ ] All 765 tests pass with flag enabled

**No Regressions**:
- [ ] Player.tick() still uses monotonic time for cyclic/infinite modes

- [ ] FiniteTimeRoot clamps progress at 1.0
- [ ] InfiniteTimeRoot provides unbounded time
- [ ] Existing animations run identically before/after changes

---

### Deliverable 3: Create Bus Semantics Module (P1)

**Module Creation**:
- [ ] New file created: `src/editor/semantic/busSemantics.ts`
- [ ] Header comment explains: "Canonical bus semantics - ONLY place bus logic lives"

- [ ] Sorts by `sortKey` ascending (primary)
- [ ] Uses `id.localeCompare(b.id)` as stable tie-breaker (secondary)
- [ ] Filters by `enabled` unless `includeDisabled = true`
- [ ] Returns same ordering for same input (deterministic)

**Combine Functions**:
- [ ] `combineSignalArtifacts(artifacts, mode, defaultValue)` supports `last`, `sum` modes
- [ ] `combineFieldArtifacts(artifacts, mode, defaultValue)` supports `last`, `sum`, `average`, `max`, `min` modes
- [ ] Returns correct ValueKind based on input artifacts
- [ ] Handles empty artifact array (returns default value)
- [ ] Test: Combine with `last` mode → returns last artifact
- [ ] Test: Combine with `sum` mode → returns sum of all artifacts

**BusStore Integration**:
- [ ] BusStore removes local sorting logic (delegates to module)
- [ ] BusStore results identical before/after refactor

**Compiler Integration**:
- [ ] Local `combineSignalArtifacts()` function deleted (lines 101-194)
- [ ] Local `combineFieldArtifacts()` function deleted (lines 207-325)
- [ ] All callers updated to use busSemantics imports
- [ ] Compiler results identical before/after refactor

**Cross-Layer Consistency Tests**:
- [ ] Test: Enabled/disabled filtering consistent (UI and compiler both filter disabled by default)
- [ ] Test: Combine modes produce identical results in UI preview and runtime

**Test Coverage**:
- [ ] New file: `src/editor/semantic/__tests__/busSemantics.test.ts`
- [ ] Tests for `combineSignalArtifacts`: all modes (last, sum)
- [ ] Tests for `combineFieldArtifacts`: all modes (last, sum, average, max, min)
- [ ] All new tests pass

**Documentation**:
- [ ] Comment in busSemantics.ts explains why single source of truth matters
- [ ] Comment in BusStore.ts references busSemantics module
- [ ] Comment in compileBusAware.ts warns: "CRITICAL: Use BusSemantics - do not duplicate logic"

---

## Sprint Completion Checklist

**Code Quality**:
- [ ] `just typecheck` passes with zero errors
- [ ] `just lint` passes with zero errors
- [ ] `just test` shows 765/765 tests passing
- [ ] `just check` (typecheck + lint + test) succeeds

**Functionality**:
- [ ] Existing patches load and compile without errors
- [ ] New patches auto-insert TimeRoot
- [ ] Patches without TimeRoot show clear validation error
- [ ] Bus ordering deterministic (UI matches runtime)
- [ ] No visual regressions in animations

**Documentation**:
- [ ] Code comments explain architectural decisions
- [ ] No TODOs left unresolved in modified files
- [ ] Plan and DOD files updated if scope changed

**No Regressions**:
- [ ] All animations from previous test sessions still work
- [ ] Player transport controls functional (play/pause/scrub)
- [ ] LogWindow displays validation errors clearly

---

## Out of Scope (Explicitly Deferred)

**Not in this sprint**:
- DiagnosticHub calling Validator.validateAll (trivial, non-blocking)
- Layout as Projection (ViewStateStore creation)
- Port Identity architectural pieces (composite boundaries, type resolution)
- Patch Operations/Transactions system
- Multi-UI support (depends on bus semantics completion)

**Rationale**: Sprint focuses on **3 critical blockers** only. Additional work deferred to future sprints to maintain focus and deliverability.

---

## Definition of Done (Meta)

This sprint is **DONE** when:
1. All acceptance criteria above are checked ✅
2. All tests pass (765/765)
3. No known regressions
4. Code ready for future UI refactor work
5. Summary file written

---

**DOD Complete** | status-planner | 2025-12-21-123509
