# Definition of Done: Dead Code Migration Sprint

**Generated**: 2026-01-04-005000
**Plan**: PLAN-20260104-v2.md
**Topic**: Dead Code Cleanup - Migration Focus

---

## Sprint Scope

This sprint delivers **2 critical migrations**:

1. **Adapter Migration** - Migrate ModulationTableStore from deprecated adapters module to TRANSFORM_REGISTRY
2. **compileBusAware Migration** - Migrate compilePatch from deprecated stub to pass-based compiler

**Deferred**: Backup file deletion, .gitignore cleanup, other dead code (see Deferred Work section)

---

## Deliverable 1: Adapter Migration

### Code Changes

- [ ] `ModulationTableStore.bindCell()` uses `TRANSFORM_REGISTRY.findAdapters(from, to)` instead of `findAdapterPath()`
- [ ] Adapter chain construction converted from `AdapterStep[]` to `TransformDef[]`
- [ ] Policy checking (AUTO/SUGGEST/EXPLICIT) reimplemented using `TransformDef.policy` field
- [ ] Context-specific filtering (wire/publisher/listener) preserved from old system
- [ ] Import of `findAdapterPath` from `adapters/autoAdapter` removed from ModulationTableStore

### Verification

- [ ] All existing modulation table bindings work identically (manual browser test)
- [ ] Type-compatible bindings succeed without adapters
- [ ] Type-incompatible bindings find correct adapter chain
- [ ] Multi-hop adapter chains work (if supported by old system)
- [ ] Policy restrictions respected (EXPLICIT adapters not auto-applied)

### Cleanup

- [ ] File deleted: `src/editor/adapters/autoAdapter.ts`
- [ ] File deleted: `src/editor/adapters/index.ts` (if it exists)
- [ ] Directory deleted: `src/editor/adapters/`
- [ ] Zero grep matches for `from.*adapters/` in `src/`

### Testing

- [ ] `just typecheck` passes
- [ ] `just lint` passes (no errors)
- [ ] `just test` passes
- [ ] Browser test: Open modulation table, bind cell with type mismatch, verify adapter applied

---

## Deliverable 2: compileBusAware Migration

### Code Changes

- [ ] `compilePatch()` in `compile.ts` implements full pass-based pipeline
- [ ] Pass 0: Materialize (default sources) - if exists as separate pass
- [ ] Pass 1: Normalize - `pass1Normalize()` called, errors collected
- [ ] Pass 2: Type Graph - `pass2TypeGraph()` called, errors collected
- [ ] Pass 3: Time Topology - `pass3TimeTopology()` called, errors collected
- [ ] Pass 4: Dependency Graph - `pass4DepGraph()` called, errors collected
- [ ] Pass 5: SCC Validation - `pass5CycleValidation()` called, errors collected
- [ ] Pass 6: Block Lowering - `pass6BlockLowering()` called with registry/seed/ctx
- [ ] Pass 8: Link Resolution - `pass8LinkResolution()` called, final IR produced
- [ ] Error aggregation: If any pass fails, return `{ ok: false, errors }`
- [ ] Success path: Build final Program object from linked IR
- [ ] IR emission: If `options.emitIR === true`, include IR in result
- [ ] Import of `compileBusAwarePatch` removed from `compile.ts`

### Verification

- [ ] Simple patch compiles successfully (manual browser test)
- [ ] Patch with TimeRoot compiles
- [ ] Patch with buses compiles
- [ ] Patch with type conversions compiles
- [ ] Invalid patch (no TimeRoot) returns correct error
- [ ] Invalid patch (cycle) returns correct error
- [ ] Invalid patch (type mismatch) returns correct error
- [ ] `CompileResult` structure matches expected signature

### Cleanup

- [ ] File deleted: `src/editor/compiler/compileBusAware.ts`
- [ ] Export removed: `compileBusAwarePatch` from `src/editor/compiler/index.ts`
- [ ] Zero grep matches for `compileBusAware` in `src/`

### Testing

- [ ] `just typecheck` passes
- [ ] `just lint` passes (no errors)
- [ ] `just test` passes (compiler tests run successfully)
- [ ] Browser test: Load editor, create patch with blocks, verify compilation
- [ ] Browser test: Open DevTools, verify no compilation errors in console
- [ ] Browser test: Scrub timeline, verify animation plays

---

## Sprint Success Criteria

### Code Metrics

- [ ] **565 lines** of deprecated code removed (196 adapters + 124 compileBusAware + files)
- [ ] **2 directories** removed: `src/editor/adapters/`, `src/editor/compiler/compileBusAware.ts`
- [ ] **Zero** references to deprecated modules in active code

### Quality Gates

- [ ] `just check` passes (typecheck + lint + test)
- [ ] No new TypeScript errors introduced
- [ ] No new linting warnings introduced
- [ ] All existing tests pass
- [ ] Git status clean (no unintended changes)

### Functional Verification

- [ ] Editor loads without errors
- [ ] Can create new patch
- [ ] Can add blocks to patch
- [ ] Can connect blocks with wires
- [ ] Can bind modulation table cells
- [ ] Patch compiles successfully
- [ ] Timeline scrubbing works
- [ ] Animation renders correctly

---

## Deferred Work

The following items from the original plan are **out of scope** for this sprint:

1. Backup file deletion (*.bak, *.backup)
2. .gitignore cleanup
3. Other dead code identified in EVALUATION-20260104.md
4. Test file cleanup
5. Documentation updates

**Rationale**: These are low-value chores that don't block core functionality. The user explicitly requested focus on adapter and compileBusAware migrations only.

---

## Blockers and Questions

**None** - Both migrations have clear replacement APIs:
- Adapters: `TRANSFORM_REGISTRY.findAdapters()` is documented and tested
- Compiler: Pass-based pipeline (passes 0-8) is documented in `design-docs/spec/`

If pass signatures or semantics differ from expectations, implementation may require investigation and adjustment.

---

## Sign-off Checklist

Before closing this sprint:

- [ ] Both deliverables complete (all checkboxes above checked)
- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Browser smoke test passed
- [ ] No regressions in existing functionality
- [ ] Code reviewed (if applicable)
- [ ] Changes committed with descriptive messages
- [ ] SUMMARY file updated with completion timestamp
