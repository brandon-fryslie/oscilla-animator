# Dead Code Cleanup Sprint Plan

**Generated**: 2026-01-04-004157
**Topic**: dead-code-cleanup
**Status Source**: EVALUATION-20260104.md
**Audit Source**: DEAD-CODE-AUDIT.md (2026-01-03)
**Git Commit**: 93b7e6e (as of generation)

---

## Executive Summary

This sprint focuses on **conservative, verified dead code removal**. Based on evaluation findings, we've scoped this to **safe deletions only** - removing files with zero external imports and backup artifacts that should never have been committed.

**Total Scope**: 4 deliverables (2 P0, 2 P1)
**Estimated Effort**: 1-2 days
**Risk Level**: LOW (all items verified as safe to delete)

### What We're NOT Doing (Deferred)

- ❌ compileBusAware.ts deletion (has 2 active imports - needs migration first)
- ❌ Full "103 unimported files" cleanup (audit methodology questionable)
- ❌ DefaultSource refactoring (optimization, not cleanup)
- ❌ Adapter module removal (1 active import in ModulationTableStore.ts)

---

## Backlog by Priority

### P0 (Critical) - Safe Immediate Cleanup

---

## P0-1: Delete Backup Files

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: None
**Spec Reference**: N/A (repository hygiene) • **Status Reference**: EVALUATION-20260104.md lines 42-58

### Description

Four backup files (.orig, .backup extensions) are committed to the repository. These are artifacts from merge conflicts or manual backups that should never be in version control. They contribute 3,661 lines and 120KB of bloat.

**Files to delete**:
- `src/editor/modulation-table/ModulationTableStore.ts.orig` (28,882 bytes)
- `src/editor/runtime/executor/RuntimeState.ts.orig` (21,422 bytes)
- `src/editor/stores/PatchStore.ts.orig` (25,094 bytes)
- `src/editor/compiler/compileBusAware.ts.backup` (45,389 bytes)

### Acceptance Criteria (REQUIRED)

- [ ] All 4 backup files deleted from repository
- [ ] `just check` passes (typecheck + lint + test)
- [ ] `just build` completes successfully
- [ ] Git status shows 4 deletions, no build errors

### Technical Notes

**Risk**: NONE - these are backup files with no imports. The real implementations exist without the .orig/.backup suffix.

**Verification**: Before deletion, verify the non-backup version exists:
- `ModulationTableStore.ts` exists (not just .orig)
- `RuntimeState.ts` exists
- `PatchStore.ts` exists
- `compileBusAware.ts` exists (though it's deprecated, it's not the backup)

---

## P0-2: Prevent Future Backup File Commits

**Status**: Not Started
**Effort**: Small (15 minutes)
**Dependencies**: P0-1 (Delete Backup Files)
**Spec Reference**: N/A (repository hygiene) • **Status Reference**: EVALUATION-20260104.md lines 52-54

### Description

The `.gitignore` file does not currently block backup file extensions. This allowed the 4 backup files to be committed. Add patterns to prevent this from happening again.

**Patterns to add**:
```
# Backup files from merge conflicts and manual edits
*.orig
*.backup
*.bak
```

### Acceptance Criteria (REQUIRED)

- [ ] `.gitignore` updated with `*.orig`, `*.backup`, `*.bak` patterns
- [ ] Create test backup file (e.g., `test.ts.orig`) and verify `git status` does NOT show it as untracked
- [ ] Delete test file after verification
- [ ] Changes committed with message documenting the prevention of backup file commits

### Technical Notes

**Risk**: NONE - this is additive protection only.

**Location**: Add to `.gitignore` in root directory, ideally in a section labeled "# Backup files" for clarity.

---

### P1 (High) - Low Risk Verified Cleanup

---

## P1-1: Delete Compositor Module (Dead Code)

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0-1, P0-2 (establish clean baseline first)
**Spec Reference**: N/A (dead code removal) • **Status Reference**: EVALUATION-20260104.md lines 121-123

### Description

The `src/editor/compositor/` directory contains 9 files that are not imported by any code outside the compositor module itself. Grep verification shows only internal imports (compositor files importing each other). This appears to be an abandoned or superseded approach to composition that was never wired into the application.

**Files to delete** (entire directory):
```
src/editor/compositor/
├── compositor.ts
├── index.ts
├── resources.ts
├── rewrite.ts
├── scoped.ts
├── selection.ts
├── selectors.ts
├── stack.ts
└── tree-adapter.ts
```

### Acceptance Criteria (REQUIRED)

- [ ] Entire `src/editor/compositor/` directory deleted
- [ ] `just typecheck` passes with zero errors
- [ ] `just test` passes all 2162+ tests (no new failures)
- [ ] `just build` completes successfully
- [ ] Grep verification: `grep -r "from.*compositor" src/` returns no results (except in deleted files context)
- [ ] Commit message documents what was removed and why (dead code, zero external imports)

### Technical Notes

**Risk**: LOW - verified zero external imports via grep.

**Verification Strategy**:
1. Before deletion: Run full test suite to establish baseline
2. Delete directory
3. Run typecheck - should pass (if fails, code was imported and audit was wrong)
4. Run tests - should pass (if fails, restore from git and investigate)
5. Run build - should pass

**Rollback Plan**: If any verification fails, `git restore src/editor/compositor/` and mark this item as blocked for investigation.

**Why Compositor Appears Dead**: No evidence in git history of recent usage. Likely superseded by other composition mechanisms (composites, macros, or transform pipeline).

---

## P1-2: Complete Adapter Module Migration and Cleanup

**Status**: Not Started (migration incomplete)
**Effort**: Medium (2-4 hours)
**Dependencies**: P0-1, P0-2
**Spec Reference**: N/A (migration to TRANSFORM_REGISTRY) • **Status Reference**: EVALUATION-20260104.md lines 60-86

### Description

The `src/editor/adapters/` module is marked deprecated with a notice pointing to `TRANSFORM_REGISTRY` as the replacement. However, one active import remains:

**Active Import**:
- `src/editor/modulation-table/ModulationTableStore.ts` imports from `adapters/AdapterRegistry`

**Migration Path**:
1. Investigate the ModulationTableStore usage - does it actually use the adapter API, or is it just an unused import?
2. If used: migrate to TRANSFORM_REGISTRY equivalent
3. If unused: remove the import
4. Verify no other imports exist (grep verification)
5. Delete the entire `src/editor/adapters/` directory

**Files in adapters module**:
- `AdapterRegistry.ts` (248 lines)
- `autoAdapter.ts` (193 lines)

### Acceptance Criteria (REQUIRED)

- [ ] ModulationTableStore.ts adapter import analyzed - usage determined (used vs. unused)
- [ ] If used: equivalent functionality migrated to TRANSFORM_REGISTRY
- [ ] If used: migration verified with tests (ModulationTableStore functionality intact)
- [ ] ModulationTableStore.ts import removed (no longer references adapters/)
- [ ] Grep verification: `grep -r "from.*adapters" src/` returns zero results
- [ ] Entire `src/editor/adapters/` directory deleted
- [ ] `just check` passes (typecheck + lint + test)
- [ ] `just build` completes successfully

### Technical Notes

**Risk**: MEDIUM - requires verification that ModulationTableStore doesn't rely on adapter functionality.

**Blockers**:
- If TRANSFORM_REGISTRY lacks feature parity with adapters, migration cannot proceed
- If ModulationTableStore tests are broken (marked TODO: BROKEN in audit), we lack safety net

**Mitigation**:
1. Before deleting adapters, create manual test of modulation table functionality
2. Test in dev server (`just dev`) - verify modulation table UI works
3. If migration is complex, defer to separate sprint and keep adapters module

**Migration Check**:
```typescript
// In ModulationTableStore.ts, look for:
import { ... } from '../adapters/AdapterRegistry';

// Check if imported symbols are actually used in the file
// If yes: find equivalent in TRANSFORM_REGISTRY
// If no: safe to delete import
```

---

## P2 (Medium) - Deferred to Future Sprint

These items are out of scope for this sprint but documented for future work:

### P2-1: Remove Unused npm Dependency (@dnd-kit/sortable)

**Reason for Deferral**: Low impact (just node_modules bloat), can batch with other dependency updates.

**Original Priority**: P2
**Spec Reference**: N/A
**Status Reference**: EVALUATION-20260104.md lines 188-199

### P2-2: DefaultSource Block Duplication Refactor

**Reason for Deferral**: This is optimization, not cleanup. Wrong abstraction could make code worse. Needs careful design.

**Original Priority**: P2
**Spec Reference**: N/A
**Status Reference**: EVALUATION-20260104.md lines 165-183

---

## Blockers and Questions

### Blocker B1: Adapter Migration Feature Parity

**Question**: Does TRANSFORM_REGISTRY have full feature parity with the deprecated AdapterRegistry? Can it handle all use cases in ModulationTableStore?

**Impact**: If no, P1-2 cannot proceed. We'd need to either:
- Complete TRANSFORM_REGISTRY implementation first
- Keep adapters module as "deprecated but functional"

**Resolution**: Analyze ModulationTableStore code and TRANSFORM_REGISTRY to verify parity.

---

### Question Q1: ModulationTableStore Test Status

**Question**: Audit notes `ModulationTableStore.test.ts` is empty with "TODO: BROKEN". Should we fix tests before attempting adapter migration, or proceed with manual verification?

**Impact**: Without tests, we have no automated safety net for adapter migration.

**Options**:
- A) Fix tests first, then migrate (safer, slower)
- B) Manual verification via dev server (faster, some risk)
- C) Defer adapter migration until tests are fixed

**Recommendation**: Option B (manual verification) for this sprint, file issue to fix tests.

---

## Dependency Graph

```
P0-1 (Delete Backup Files)
  ↓
P0-2 (Update .gitignore)
  ↓
P1-1 (Delete Compositor) ← Independent
  ↓
P1-2 (Adapter Migration) ← Requires ModulationTableStore analysis
```

**Critical Path**: P0-1 → P0-2 → P1-2 (if adapter migration proceeds)

**Parallel Work**: P1-1 can run in parallel with P1-2 (no dependency relationship)

---

## Recommended Sprint Execution

### Phase 1: Safe Foundation (P0) - 45 minutes

**Goal**: Establish clean baseline with zero risk.

1. **Verify backup files** (5 min):
   ```bash
   # Confirm real versions exist
   ls -la src/editor/modulation-table/ModulationTableStore.ts
   ls -la src/editor/runtime/executor/RuntimeState.ts
   ls -la src/editor/stores/PatchStore.ts
   ls -la src/editor/compiler/compileBusAware.ts
   ```

2. **Delete backup files** (5 min):
   ```bash
   git rm src/editor/modulation-table/ModulationTableStore.ts.orig
   git rm src/editor/runtime/executor/RuntimeState.ts.orig
   git rm src/editor/stores/PatchStore.ts.orig
   git rm src/editor/compiler/compileBusAware.ts.backup
   ```

3. **Verify build** (15 min):
   ```bash
   just check
   just build
   ```

4. **Update .gitignore** (5 min):
   ```bash
   # Add patterns to .gitignore
   echo -e "\n# Backup files from merge conflicts and manual edits\n*.orig\n*.backup\n*.bak" >> .gitignore
   ```

5. **Test .gitignore** (5 min):
   ```bash
   touch test.ts.orig
   git status  # Should not show test.ts.orig
   rm test.ts.orig
   ```

6. **Commit** (10 min):
   ```bash
   git add .gitignore
   git commit -m "chore: remove backup files and prevent future commits"
   ```

**Checkpoint**: At this point, repository is cleaner and protected. Safe to continue to P1.

---

### Phase 2: Compositor Cleanup (P1-1) - 1 hour

**Goal**: Remove verified dead code module.

1. **Pre-deletion verification** (10 min):
   ```bash
   just test  # Establish baseline
   grep -r "from.*compositor" src/  # Verify zero external imports
   ```

2. **Delete compositor** (5 min):
   ```bash
   git rm -r src/editor/compositor/
   ```

3. **Verify build** (15 min):
   ```bash
   just typecheck  # Should pass
   just test       # Should pass
   just build      # Should pass
   ```

4. **Commit** (5 min):
   ```bash
   git commit -m "chore: remove dead compositor module (zero external imports)"
   ```

**Checkpoint**: If any verification fails, rollback with `git restore src/editor/compositor/` and investigate.

---

### Phase 3: Adapter Migration (P1-2) - 2-4 hours

**Goal**: Complete migration to TRANSFORM_REGISTRY and remove deprecated adapters module.

1. **Analyze ModulationTableStore usage** (30 min):
   ```bash
   # Read the file and trace adapter usage
   grep -n "adapter" src/editor/modulation-table/ModulationTableStore.ts
   # Determine: is it used or just imported?
   ```

2. **If used - Migrate to TRANSFORM_REGISTRY** (1-2 hours):
   - Find equivalent API in TRANSFORM_REGISTRY
   - Update ModulationTableStore to use new API
   - Test in dev server: `just dev` → verify modulation table functionality

3. **If unused - Remove import** (5 min):
   - Delete import line from ModulationTableStore.ts

4. **Delete adapters module** (5 min):
   ```bash
   git rm -r src/editor/adapters/
   ```

5. **Verify build** (15 min):
   ```bash
   just check
   just build
   ```

6. **Manual verification** (30 min):
   ```bash
   just dev
   # In browser: test modulation table functionality
   # Verify no console errors related to adapters
   ```

7. **Commit** (5 min):
   ```bash
   git commit -m "chore: complete adapter migration and remove deprecated module"
   ```

**Checkpoint**: If migration is complex or risky, defer to future sprint and document findings.

---

## Risk Assessment

| Item | Risk Level | Mitigation |
|------|------------|------------|
| P0-1: Delete Backup Files | NONE | Backup versions exist without .orig suffix |
| P0-2: Update .gitignore | NONE | Additive change only |
| P1-1: Delete Compositor | LOW | Verified zero external imports via grep |
| P1-2: Adapter Migration | MEDIUM | Manual testing + rollback plan if issues found |

**Overall Sprint Risk**: LOW-MEDIUM

**Rollback Strategy**: All changes are git commits. If any issue arises, `git revert <commit>` or `git restore <path>`.

---

## Success Metrics

| Metric | Target | How to Measure |
|--------|--------|----------------|
| Lines of code removed | ~4,000+ | `git diff --stat` |
| Backup files in repo | 0 | `git ls-files | grep -E '\.(orig\|backup\|bak)$'` should be empty |
| Dead modules removed | 1-2 | Compositor deleted, possibly adapters |
| Build health | All checks passing | `just check` exits 0 |
| Test suite health | 2162+ passing | `just test` shows all pass |

---

## Post-Sprint Actions

After completing this sprint:

1. **Update dead code audit**: Mark completed items in DEAD-CODE-AUDIT.md
2. **File issues for deferred work**:
   - P2-1: Remove @dnd-kit/sortable dependency
   - P2-2: DefaultSource duplication refactor
   - Fix ModulationTableStore tests (if still broken)
3. **Re-run dead code analysis**: Use ts-prune or depcheck to get accurate list of remaining dead code
4. **Plan next cleanup sprint**: Focus on verified unimported files (using better tooling than original audit)

---

## Notes

**Conservative Scope Rationale**: The original audit claimed 103 unimported files, but evaluation verification found several claimed "dead" modules are actually actively used (unified compiler, lenses). This sprint focuses only on **verified safe deletions** to avoid breaking the application.

**Why Not More Aggressive**:
- compileBusAware.ts has 2 active imports (needs migration first)
- Many "unimported" files are actually imported by other modules
- Test coverage has gaps (29 skipped, 8 todo tests)
- Active development on type system (20 commits in 3 days) makes aggressive cleanup risky

**Future Cleanup**: After this sprint establishes a safe cleanup pattern, subsequent sprints can tackle larger modules with better verification tooling and more thorough testing.
