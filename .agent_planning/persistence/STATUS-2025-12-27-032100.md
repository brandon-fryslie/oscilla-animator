# Status Report: Persistence - Saving and Loading Patches
Timestamp: 2025-12-27-032100
Scope: module/persistence
Confidence: FRESH
Git Commit: abb894c

## Executive Summary

**Overall: 40% Complete** - Core serialization/deserialization infrastructure exists and works. UI for save/load is stubbed out but disabled. No localStorage auto-save for patches. File download/upload not implemented.

| Component | Status | Evidence |
|-----------|--------|----------|
| `RootStore.toJSON()` | COMPLETE | `src/editor/stores/RootStore.ts:194-209` - Serializes full Patch |
| `RootStore.loadPatch()` | COMPLETE | `src/editor/stores/RootStore.ts:211-276` - Deserializes and loads |
| Patch type definition | COMPLETE | `src/editor/types.ts:739-781` - Version 2 format |
| Save/Load UI buttons | STUB | `src/editor/SettingsToolbar.tsx:439-452` - Disabled, "Phase 6" |
| Export button | STUB | `src/editor/SettingsToolbar.tsx:453-459` - Disabled |
| localStorage auto-save | NOT_STARTED | No implementation found |
| File download | NOT_STARTED | No implementation in codebase |
| File upload | NOT_STARTED | No implementation in codebase |

## What Exists (FRESH)

### 1. Serialization Core - RootStore.toJSON()

**File**: `/Users/bmf/code/oscilla-animator_codex/.worktrees/full-system-design/src/editor/stores/RootStore.ts`

```typescript
toJSON(): Patch {
  return {
    version: 2,
    blocks: this.patchStore.blocks.map((b) => ({ ...b })),
    connections: this.patchStore.connections.map((c) => ({ ...c })),
    lanes: this.viewStore.lanes.map((l) => ({ ...l })),
    buses: this.busStore.buses.map((b) => ({ ...b })),
    publishers: this.busStore.publishers.map((p) => ({ ...p })),
    listeners: this.busStore.listeners.map((l) => ({ ...l })),
    defaultSources: Array.from(this.defaultSourceStore.sources.values()).map((s) => ({ ...s })),
    settings: {
      ...this.uiStore.settings,
      currentLayoutId: this.viewStore.currentLayoutId,
    },
  };
}
```

**Assessment**: Serialization is complete. All patch state is captured:
- Blocks with inputs/outputs/params
- Connections with lens stacks and adapter chains
- Lanes with blockIds and collapse state
- Buses with type descriptors and combine modes
- Publishers and listeners with full routing data
- DefaultSources for implicit bindings
- Settings including layout and compiler mode

### 2. Deserialization Core - RootStore.loadPatch()

**File**: `/Users/bmf/code/oscilla-animator_codex/.worktrees/full-system-design/src/editor/stores/RootStore.ts:211-276`

**Assessment**: Deserialization is complete with proper handling of:
- Version migration (defaults for missing fields)
- Lane state restoration
- Bus and routing restoration
- Default source loading
- Selection clearing
- ID counter adjustment for loaded blocks
- Event emission (PatchLoaded) for downstream reactions
- Legacy composite support

### 3. Patch Type Definition

**File**: `/Users/bmf/code/oscilla-animator_codex/.worktrees/full-system-design/src/editor/types.ts:739-781`

```typescript
export interface Patch {
  readonly version: number;
  blocks: Block[];
  connections: Connection[];
  lanes: Lane[];
  buses: Bus[];
  publishers: Publisher[];
  listeners: Listener[];
  defaultSources: DefaultSourceState[];
  settings: { seed, speed, currentLayoutId?, ... };
  composites?: CompositeDefinition[];
}
```

**Assessment**: Type is well-defined and captures all editor state. Version field enables future migrations.

### 4. Reference Implementation - PathLibrary Storage

**File**: `/Users/bmf/code/oscilla-animator_codex/.worktrees/full-system-design/src/editor/pathLibrary/storage.ts`

This provides a working pattern for localStorage persistence:
- Versioned storage format
- Load/save/clear operations
- Error handling for localStorage failures
- Validation on load
- Filtering of invalid entries

**This pattern should be reused for patch persistence.**

## What's Missing (FRESH)

### 1. UI for Save/Load - Disabled Buttons

**File**: `/Users/bmf/code/oscilla-animator_codex/.worktrees/full-system-design/src/editor/SettingsToolbar.tsx:438-459`

```typescript
{/* Action buttons - disabled until Phase 6 */}
<button className="toolbar-action-btn" disabled title="Save patch (Phase 6)">
  Save
</button>
<button className="toolbar-action-btn" disabled title="Load patch (Phase 6)">
  Load
</button>
<button className="toolbar-action-btn" disabled title="Export animation (Phase 6)">
  Export
</button>
```

**What's Needed**:
- Enable Save button - trigger `RootStore.toJSON()` + file download
- Enable Load button - file picker + `RootStore.loadPatch()`
- Define Export behavior (different from Save? - likely SVG/video export)

### 2. File Download Implementation

**Pattern from PathManagerModal.tsx (lines 295-308)**:
```typescript
const handleExport = (id: string) => {
  const json = pathLibrary.exportAsJSON(id);
  const filename = `path-${entry?.name ?? 'export'}-${Date.now()}.json`;
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};
```

**Patch save would be similar**:
```typescript
const handleSavePatch = () => {
  const patch = rootStore.toJSON();
  const json = JSON.stringify(patch, null, 2);
  const filename = `patch-${Date.now()}.oscilla.json`;
  // ... same blob/download pattern
};
```

### 3. File Upload Implementation

**Pattern from PathManagerModal.tsx (lines 83-106)**:
```typescript
const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  const reader = new FileReader();
  reader.onload = (event) => {
    const text = (event.target?.result as string) ?? '';
    // ... process text
  };
  reader.readAsText(file);
};
```

**Patch load would need**:
- File picker (hidden input)
- FileReader to read JSON
- JSON.parse + validation
- `rootStore.loadPatch(patch)`

### 4. localStorage Auto-Save (Optional)

Currently, patches are lost on refresh. Options:
1. **Auto-save on change** - debounced save to localStorage after edits
2. **Auto-save on unload** - save when leaving page (beforeunload)
3. **Auto-recover on load** - check for saved state on startup

**Storage key pattern** (from pathLibrary): `'loom99-current-patch'`

### 5. Tests for Serialization Round-Trip

**No dedicated tests found for toJSON/loadPatch round-trip.**

Should verify:
- Empty patch serializes/deserializes
- Full patch with all entity types round-trips
- Missing optional fields handled gracefully
- Version field respected

## Dependencies and Risks

### Dependencies
| Dependency | Status | Impact |
|------------|--------|--------|
| Patch type definition | COMPLETE | None - stable |
| RootStore serialization | COMPLETE | None - working |
| File APIs (Blob, URL, FileReader) | Browser native | None |
| localStorage | Browser native | Size limits (5-10MB) |

### Risks

1. **localStorage Size Limits**
   - Patches with many blocks/connections could exceed localStorage quota
   - Large embedded SVG paths in blocks compound the problem
   - Mitigation: File download primary, localStorage for recovery only

2. **Version Migration**
   - `version: 2` is current
   - No migration code for hypothetical v1 patches exists
   - Impact: LOW - no v1 patches exist in the wild yet

3. **Undo/Redo Relationship**
   - Design docs reference HistoryStore (design-docs/6-Transactions/6-HistoryStore.md)
   - Auto-save could interfere with undo history
   - Need to clarify: Does "Save" create a checkpoint? Or is it independent?

4. **CompositeDefinition Serialization**
   - `composites?: CompositeDefinition[]` in Patch type
   - Legacy support exists in loadPatch
   - CompositeDefinition type imported from `./composites.ts`
   - Round-trip not explicitly tested

## Ambiguities Found

| Area | Question | How LLM Would Guess | Impact |
|------|----------|---------------------|--------|
| Export vs Save | What does "Export" do that Save doesn't? | Assume SVG/video export | HIGH - Button exists, no spec |
| Auto-save trigger | When should auto-save fire? On every change? Debounced? | 2s debounce after change | MEDIUM - UX decision |
| File naming | What should patch files be named? | `patch-{timestamp}.json` | LOW - Can change later |
| Confirmation dialogs | Warn on overwrite? Warn before Load clears current? | Warn before Load clears | MEDIUM - UX decision |
| Storage key | What localStorage key for patches? | `loom99-current-patch` | LOW - Consistent with path lib |

## Recommendations

### Priority 1: Enable Basic Save/Load
1. Add file download on Save click (use PathManagerModal pattern)
2. Add file upload on Load click (use PathManagerModal pattern)
3. Add confirmation before Load (current patch will be cleared)
4. Remove "Phase 6" from button titles

### Priority 2: Add Auto-Recovery
1. Save to localStorage on significant changes (debounced 2s)
2. Check for saved state on app load
3. Offer to restore or discard

### Priority 3: Add Round-Trip Tests
1. Test empty patch
2. Test patch with blocks/connections
3. Test patch with buses/publishers/listeners
4. Test patch with defaultSources
5. Test version handling

### Priority 4: Clarify Export
1. Determine what Export does (SVG export? Video? Different from Save?)
2. Implement or remove the button

## Missing Persistent Checks (Implementer Should Create)

1. **Round-trip test** (`src/editor/stores/__tests__/RootStore.serialization.test.ts`)
   - Create patch, serialize, deserialize, verify equality
   - Test with blocks, connections, buses, publishers, listeners

2. **Smoke test for persistence** (`tests/e2e/persistence.test.ts`)
   - Save patch, reload page, load patch, verify state

## Verdict

- [x] CONTINUE - Issues are clear, implementation straightforward

**Next Action**: Enable Save button with file download, then Load button with file upload. Use PathManagerModal as implementation reference.

---

## Files Referenced

| File | Lines | Purpose |
|------|-------|---------|
| `src/editor/stores/RootStore.ts` | 194-209, 211-276 | toJSON, loadPatch |
| `src/editor/SettingsToolbar.tsx` | 438-459 | Disabled Save/Load/Export buttons |
| `src/editor/types.ts` | 739-781 | Patch type definition |
| `src/editor/pathLibrary/storage.ts` | All | Reference impl for localStorage |
| `src/editor/PathManagerModal.tsx` | 83-106, 295-308 | Reference impl for file upload/download |
