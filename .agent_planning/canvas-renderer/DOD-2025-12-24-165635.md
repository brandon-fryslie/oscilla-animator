# Definition of Done - Canvas Renderer Implementation

**Generated**: 2025-12-24 16:56:35
**Source Plan**: PLAN-2025-12-24-165635.md
**Topic**: Canvas 2D Renderer
**Sprint**: 1 (MVP Canvas Rendering)

---

## Sprint Scope

This sprint delivers: **Working Canvas 2D renderer with SVG/Canvas toggle**

**Deliverables**:
1. Canvas2DRenderer class
2. PreviewPanel renderer selection UI
3. Integration and verification

**Deferred to future sprints**:
- IR/VM system architecture
- Advanced effects (filters, blend modes beyond basic)
- Performance optimization (batching, caching)
- Additional geometries (rects, paths, text)
- New Canvas-specific blocks

---

## Acceptance Criteria

### P0-1: Canvas2DRenderer Class

#### Core Functionality
- [ ] `Canvas2DRenderer` class exists with constructor accepting `HTMLCanvasElement`
- [ ] `setViewport(w, h, dpr)` method correctly resizes canvas and sets DPR transform
- [ ] `render(tree: RenderTree)` method traverses tree and renders all node types
- [ ] Canvas clears properly between frames (no visual artifacts from previous frame)

#### Geometry Rendering
- [ ] Circle geometry renders with correct position, radius, fill color, and opacity
- [ ] Empty domain (n=0 elements) renders without errors
- [ ] Large domain (n≥100 elements) renders without dropping frames

#### Tree Traversal
- [ ] Group nodes recurse on children correctly
- [ ] Effect nodes (opacity, Transform2D) compose correctly via Canvas state stack

#### Testing
- [ ] Unit tests verify viewport resize and DPR scaling
- [ ] Unit tests verify circle rendering (mocked Canvas context)
- [ ] E2E test verifies Canvas renderer produces visually correct output for reference patch

---

### P0-2: PreviewPanel Renderer Selection

#### UI Elements
- [ ] Canvas element exists in PreviewPanel DOM alongside SVG element
- [ ] UI toggle exists in settings panel: "Renderer: [SVG | Canvas]"
- [ ] Only active renderer element is visible (CSS display/visibility toggle)
- [ ] Canvas element has same dimensions as SVG viewport

#### Functionality
- [ ] Renderer selection persists in UIStore settings
- [ ] Player callback correctly routes RenderTree to active renderer
- [ ] Switching renderers mid-playback works without errors

#### Testing
- [ ] Unit test verifies renderer switching logic
- [ ] E2E test verifies both renderers can render the same patch

---

### P0-3: Export and Integration

#### Integration
- [ ] `Canvas2DRenderer` exported from `src/editor/runtime/index.ts`
- [ ] PreviewPanel successfully imports and instantiates Canvas2DRenderer
- [ ] Canvas renderer handles RenderInstances2D block output correctly

#### Regression Prevention
- [ ] Existing SVG rendering still works (no regressions)
- [ ] No TypeScript errors in codebase after integration
- [ ] `just check` passes (typecheck + lint + test)

#### Validation
- [ ] Reference patch ("Breathing Constellation" from `07-golden-patch.md`) renders visually correctly in both SVG and Canvas modes
- [ ] Visual regression test compares SVG vs Canvas output (same patch, same frame)

---

## Sprint Success Criteria

**Sprint 1 is COMPLETE when ALL of the following are true**:

### Functional Requirements
1. ✅ User can open PreviewPanel and see renderer toggle in settings
2. ✅ User can select "Canvas" renderer and see patch render correctly
3. ✅ User can switch between SVG and Canvas mid-playback without errors
4. ✅ Reference patch ("Breathing Constellation") renders visually correctly in both modes
5. ✅ Empty patches (n=0) and large patches (n≥100) work without errors

### Quality Requirements
6. ✅ All unit tests pass (`just check` includes unit tests)
7. ✅ All E2E tests pass (renderer parity test included)
8. ✅ TypeScript strict mode passes (no `any`, no null errors)
9. ✅ No console errors or warnings during normal operation
10. ✅ No visual artifacts (previous frame bleeding, incorrect colors, wrong positions)

### Performance Requirements
11. ✅ Canvas renderer performance ≥ SVG renderer (no frame drops for n≤100 elements)
12. ✅ Renderer switching is instant (no visible lag)

### Code Quality Requirements
13. ✅ Code follows existing patterns (see SvgRenderer for reference)
14. ✅ Public methods are fully typed (no `any` types)
15. ✅ Non-obvious Canvas API usage is documented
16. ✅ Unit test coverage ≥80% for new code

---

## Non-Goals (Explicitly Out of Scope)

**The following are NOT required for Sprint 1 completion**:

### Architecture
- ❌ IR/VM system (NodeIR, OpCode, ValueStore, VM)
- ❌ RenderCmds artifact type (use RenderTree)
- ❌ Buffer pooling / field materialization optimization
- ❌ New Canvas-specific blocks (use existing RenderInstances2D)

### Features
- ❌ Advanced effects (complex filters, all blend modes, clip paths)
- ❌ Additional geometries (rectangles, paths, text)
- ❌ Performance optimization (batching, state change minimization, Path2D caching)
- ❌ Renderer performance metrics display
- ❌ Settings persistence to localStorage
- ❌ Frame export (download as PNG)
- ❌ WebGL/WebGPU renderer

### Testing Beyond MVP
- ❌ Performance benchmarks (beyond basic "no frame drops" check)
- ❌ Cross-browser compatibility testing (focus on modern Chrome/Firefox)
- ❌ Pixel-perfect visual parity (accept minor anti-aliasing differences)

---

## Known Limitations (Acceptable for Sprint 1)

These are documented limitations that do NOT block sprint completion:

1. **Transform3D not supported**: Canvas 2D cannot render 3D transforms. Log warning and skip.
2. **Limited filter support**: Canvas `ctx.filter` has different syntax than SVG filters. Some effects may not map.
3. **Visual differences**: Anti-aliasing and color rendering differ between SVG and Canvas. Accept "visually equivalent" not "pixel-perfect".
4. **Geometry support**: Only circles (from RenderInstances2D). Rects, paths, text deferred to P1-3.
5. **No batching**: Each circle rendered individually (inefficient but correct). Optimization in P1-2.

---

## Verification Checklist

**Before marking sprint complete, verify each item**:

### Development
- [ ] Code committed to feature branch
- [ ] No uncommitted changes (clean working directory)
- [ ] Branch rebased on latest main (no conflicts)

### Build
- [ ] `just dev` starts dev server without errors
- [ ] `just build` produces production build without errors
- [ ] `just check` passes all checks (typecheck + lint + test)

### Functionality
- [ ] Open app in browser
- [ ] Load "Breathing Constellation" patch (or similar reference)
- [ ] Open settings, find "Renderer: [SVG | Canvas]" toggle
- [ ] Switch to Canvas - patch renders correctly
- [ ] Play animation - smooth playback, no errors
- [ ] Switch back to SVG - still works correctly
- [ ] Scrub timeline - both renderers update correctly
- [ ] Resize viewport - both renderers resize correctly

### Regression Testing
- [ ] Load multiple patches (simple, complex, with effects)
- [ ] All work in SVG mode (no regressions)
- [ ] Most work in Canvas mode (known limitations acceptable)
- [ ] No console errors (warnings for unsupported effects OK)

### Code Review
- [ ] Code follows project style guide
- [ ] No unnecessary dependencies added
- [ ] Canvas API usage is correct (state management, DPR, etc.)
- [ ] Tests are clear and maintainable
- [ ] Documentation updated (if public API changed)

---

## Handoff to Next Sprint

**After Sprint 1 completes, the following should be ready for Sprint 2**:

### Artifacts
1. Working Canvas2DRenderer class (tested, documented)
2. PreviewPanel with renderer toggle (functional)
3. Test suite coverage for Canvas rendering
4. Known limitations documented

### Next Sprint Priorities
1. **P1-1**: Full effect support (filters, blend modes, clips)
2. **P1-2**: Performance optimization (batching, caching)
3. **P1-3**: Additional geometries (rects, paths)

### Open Questions for User
1. Should Canvas become default renderer? (Recommendation: SVG default, Canvas opt-in)
2. Renderer selection per-patch or global? (Recommendation: global)
3. Performance target (element count)? (Recommendation: 1000+ elements @ 60fps for Sprint 2)
4. Warnings for unsupported effects - silent or logged? (Recommendation: log once per type)

---

## Rollback Plan

**If sprint cannot be completed or introduces critical bugs**:

1. **Feature branch isolation**: All work on separate branch, main unaffected
2. **Revert path**: Delete feature branch, no changes to main
3. **SVG renderer untouched**: Existing SVG path continues working
4. **No schema changes**: No database or storage format changes
5. **Low risk**: Additive change only, no destructive modifications

**Rollback triggers**:
- Critical performance regression (>20% slower than SVG)
- Memory leaks in Canvas renderer
- Visual artifacts that cannot be resolved
- Browser compatibility issues that block majority of users

---

## Definition of Done: Summary

**Sprint 1 is DONE when**:

A user can:
1. Open the Oscilla Animator app
2. Navigate to settings
3. Switch from SVG to Canvas renderer
4. See their patch render correctly in Canvas mode
5. Experience smooth playback with no errors
6. Switch back to SVG and confirm it still works

AND all automated tests pass with ≥80% coverage for new code.

**Target Completion**: 4-5 days (1 developer)

**Sign-off Required From**:
- Developer: Code complete, tests passing
- User: Visual validation on reference patch
- QA: Regression testing complete (if applicable)

---

## Post-Sprint Review

**After sprint completes, capture**:
- Actual time spent vs. estimate
- Unexpected challenges encountered
- Technical debt introduced (if any)
- User feedback on Canvas vs SVG experience
- Performance measurements (FPS, element count limits)

This informs Sprint 2 planning and prioritization.
