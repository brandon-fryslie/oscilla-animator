# Definition of Done: Block & Edge Roles Type System
Generated: 2026-01-03-124630
Plan: PLAN-2026-01-03-124630.md
Source: EVALUATION-2026-01-03.md
Spec: design-docs/final-System-Invariants/15-Block-Edge-Roles.md

---

## Sprint Scope

This sprint delivers the foundational type system for Block & Edge Roles (§15). It does NOT include graph normalization (§16), which is a separate topic.

**Sprint delivers**: 3 core deliverables
**Deferred**: 3 additional deliverables (tracked separately)

---

## Acceptance Criteria

### Deliverable 1: Discriminated Union Type System

**Location**: src/editor/types.ts

#### Type Definitions

- [ ] BlockRole is a discriminated union (not string union)
- [ ] BlockRole has exactly 2 variants: `{ kind: "user" }` and `{ kind: "structural"; meta: StructuralMeta }`
- [ ] BlockRole uses `kind` as the discriminator field
- [ ] StructuralMeta is a discriminated union with 4 variants
- [ ] StructuralMeta variant 1: `{ kind: "defaultSource"; target: { kind: "port"; port: PortRef } }`
- [ ] StructuralMeta variant 2: `{ kind: "wireState"; target: { kind: "wire"; wire: WireId } }`
- [ ] StructuralMeta variant 3: `{ kind: "globalBus"; target: { kind: "bus"; busId: BusId } }`
- [ ] StructuralMeta variant 4: `{ kind: "lens"; target: { kind: "node"; node: NodeRef; port?: string } }`
- [ ] EdgeRole is a discriminated union (not string union)
- [ ] EdgeRole has exactly 4 variants: user, default, busTap, auto
- [ ] EdgeRole variant 1: `{ kind: "user" }`
- [ ] EdgeRole variant 2: `{ kind: "default"; meta: { defaultSourceBlockId: BlockId } }`
- [ ] EdgeRole variant 3: `{ kind: "busTap"; meta: { busId: BusId } }`
- [ ] EdgeRole variant 4: `{ kind: "auto"; meta: { reason: "portMoved" | "rehydrate" | "migrate" } }`
- [ ] All role types use closed unions (no `Record<string, unknown>`)

#### Migration

- [ ] Migration function `migrateLegacyRole()` exists
- [ ] Migration converts `'defaultSourceProvider'` → `{ kind: 'structural', meta: { kind: 'defaultSource', ... } }`
- [ ] Migration converts `'internal'` → appropriate structural variant
- [ ] Migration converts `undefined` → `{ kind: 'user' }`
- [ ] Migration function is pure (no side effects)

#### Validation

- [ ] TypeScript compilation succeeds with new types
- [ ] Unit tests verify user role shape compiles
- [ ] Unit tests verify structural role shape compiles
- [ ] Unit tests verify edge role shapes compile
- [ ] Tests verify old string roles do NOT compile as BlockRole/EdgeRole

---

### Deliverable 2: Required Role Fields with Migration

**Location**: src/editor/types.ts, src/editor/stores/PatchStore.ts

#### Interface Changes

- [ ] Block.role is required (type is `role: BlockRole`, not `role?: BlockRole`)
- [ ] Edge.role is required (type is `role: EdgeRole`, not `role?: EdgeRole`)
- [ ] TypeScript compilation enforces role presence at all block creation sites
- [ ] TypeScript compilation enforces role presence at all edge creation sites

#### Default Creation

- [ ] PatchStore.addBlock() sets `role: { kind: "user" }` by default
- [ ] PatchStore.connect() sets `role: { kind: "user" }` for edges by default
- [ ] No user-facing API allows creating blocks/edges without role

#### Patch Migration

- [ ] Patch deserialization migrates blocks without role to `{ kind: "user" }`
- [ ] Patch deserialization migrates edges without role to `{ kind: "user" }`
- [ ] Patch deserialization converts old string roles using `migrateLegacyRole()`
- [ ] Warning logged when migration occurs (for debugging)

#### Test Coverage

- [ ] All test fixtures have valid roles on blocks
- [ ] All test fixtures have valid roles on edges
- [ ] Integration test loads legacy patch without role fields
- [ ] Integration test verifies migrated patch has discriminated union roles
- [ ] Integration test verifies migrated patch compiles successfully
- [ ] Unit tests verify PatchStore.addBlock() creates user role
- [ ] Unit tests verify PatchStore.connect() creates user role on edges

---

### Deliverable 3: Structural Block Creation Updates

**Location**: src/editor/compiler/passes/pass0-materialize.ts

#### Default Source Blocks

- [ ] pass0-materialize.ts creates blocks with discriminated role
- [ ] Default source blocks have `role.kind === 'structural'`
- [ ] Default source blocks have `role.meta.kind === 'defaultSource'`
- [ ] Default source role includes target metadata (which port it targets)
- [ ] Target metadata includes blockId, slotId, and direction
- [ ] Target PortRef is correctly populated (not undefined or placeholder)

#### Default Source Edges

- [ ] pass0-materialize.ts creates edges with discriminated role
- [ ] Default edges have `role.kind === 'default'`
- [ ] Default edges include metadata: `{ defaultSourceBlockId: BlockId }`
- [ ] Metadata references the correct structural block ID

#### Cleanup

- [ ] No creation sites use old string role `'defaultSourceProvider'`
- [ ] No creation sites use old string role `'internal'`
- [ ] grep `'defaultSourceProvider'` returns only migration code or comments
- [ ] grep `'internal'` (as role value) returns only migration code or comments
- [ ] JSDoc comments updated to reflect discriminated union roles

#### Compilation Verification

- [ ] Compiler tests pass with new role shapes
- [ ] Default source blocks compile to correct IR
- [ ] Default source edges compile to correct IR
- [ ] Compiler output unchanged for same input patch (roles don't affect IR)
- [ ] Integration test verifies default source metadata is correct at runtime

---

## Sprint Completion Criteria

The sprint is complete when ALL of the following are true:

### Code Quality

- [ ] TypeScript compilation succeeds (`just typecheck`)
- [ ] Linting passes (`just lint-fix`)
- [ ] Full test suite passes (`just test`)
- [ ] No TypeScript errors related to role types
- [ ] No `any` types used to work around role strictness

### Functional Correctness

- [ ] Legacy patches load and migrate correctly
- [ ] Migrated patches compile successfully
- [ ] Compiler output matches expected IR (verified by tests)
- [ ] Default sources have correct metadata (verified by DevTools inspection)
- [ ] User blocks have correct role (verified by tests)

### Coverage

- [ ] All 3 deliverables meet their individual acceptance criteria
- [ ] All new code has unit tests
- [ ] Integration tests cover migration path
- [ ] No known blockers or broken functionality

### Documentation

- [ ] JSDoc comments explain discriminated union types
- [ ] JSDoc comments explain metadata fields
- [ ] Migration strategy documented in code comments
- [ ] README or CLAUDE.md updated if necessary

---

## Deferred Items

The following are **out of scope** for this sprint:

### Remove Hidden Field
- Remove `Block.hidden?: boolean` field
- Update PatchStore.userBlocks to filter by role
- Add isStructuralBlock() helper

**Reason**: Requires updating UI filtering logic; better to do after role-based creation is proven.

### Role Invariant Validation
- Implement `validateRoleInvariants(patch: Patch): Diagnostic[]`
- Check default edges reference structural blocks
- Check structural metadata targets exist
- Integrate into compile pipeline

**Reason**: Requires graph normalization architecture (§16) to be in place.

### Terminology Consistency
- Replace "hidden block" → "structural block" in comments
- Update variable names: `hiddenBlocks` → `structuralBlocks`
- Update JSDoc for consistency

**Reason**: Cosmetic change, can be done independently later.

---

## Verification Checklist

Run these commands to verify completion:

```bash
# Type checking
just typecheck

# Linting
just check

# Full test suite
just test

# Search for deprecated patterns
grep -r "'defaultSourceProvider'" src/
# Should return only migration code or comments

grep -r "'internal'" src/
# Should return only migration code or comments (not as role value)

# Verify role presence
grep -r "role?:" src/editor/types.ts
# Should return 0 results (role is required, not optional)
```

**Manual verification**:
1. Open DevTools in browser
2. Create a patch with unconnected input
3. Inspect block objects: verify role shape is discriminated union
4. Inspect edge objects: verify role field exists
5. Verify structural blocks have metadata populated

---

## Success Metrics

- **Type Safety**: 100% of blocks/edges have required role field
- **Migration**: 100% of legacy patches migrate successfully
- **Correctness**: Compiler output unchanged for same inputs
- **Coverage**: All new types covered by tests
- **Quality**: Zero TypeScript errors, full test suite passes

---

## Blockers

**None identified**. If issues arise:
- Consult §15 spec for authoritative type shapes
- Refer to EVALUATION-2026-01-03.md for gap details
- Check §16 for context on how roles will be used in normalization
