# Definition of Done: v2 Runtime Implementation

**Created**: 2026-01-05
**Topic**: v2-rewrite

---

## Acceptance Criteria

### 1. Architecture Docs Copied
- [ ] `~/code/oscilla-animator-v2/design-docs/final-System-Invariants/` exists
- [ ] Contains 1-Core-Laws.md, 2-Core-Checklist.md, 3-Agent-Checklist.md

### 2. BufferPool Implementation
- [ ] `src/runtime/BufferPool.ts` exists
- [ ] Can allocate typed arrays (Float32Array, Uint8Array)
- [ ] Can release and reuse buffers
- [ ] Unit test demonstrates allocation/release cycle

### 3. Time Resolution
- [ ] `src/runtime/timeResolution.ts` exists
- [ ] Computes EffectiveTime from PlayerTime + TimeRoot config
- [ ] Unit test verifies time calculation

### 4. Runtime State
- [ ] `src/runtime/RuntimeState.ts` exists
- [ ] ValueStore holds signal values by SigExprId
- [ ] FrameCache for per-frame memoization
- [ ] No hot-swap complexity (simplified)

### 5. Materializer
- [ ] `src/runtime/Materializer.ts` exists
- [ ] fillBuffer functions for each FieldExpr type
- [ ] NO signalBridge fallback - IR only
- [ ] Unit test materializes a simple field

### 6. Schedule Executor
- [ ] `src/runtime/ScheduleExecutor.ts` exists
- [ ] executeFrame() runs all steps in order
- [ ] Step dispatch for each Step type
- [ ] Unit test executes a simple program

### 7. Renderer Types
- [ ] `src/render/types.ts` exists
- [ ] RenderFrameIR, RenderPassIR types defined

### 8. Canvas2D Renderer
- [ ] `src/render/Canvas2DRenderer.ts` exists
- [ ] renderFrame(ctx, frame: RenderFrameIR) method
- [ ] NO RenderTree path - IR only

### 9. Integration Test
- [ ] End-to-end test: Patch -> compile -> execute -> RenderFrameIR
- [ ] All existing tests still pass
- [ ] `npm run typecheck` passes
- [ ] `npm test` passes

### 10. No Legacy Patterns
- [ ] No `signalBridge` references
- [ ] No `outputs` array (only `outputsById`)
- [ ] No closure-based evaluation
- [ ] No feature flags or dual modes

## Validation Commands

```bash
cd ~/code/oscilla-animator-v2
npm run typecheck  # Must pass
npm test           # Must pass
```

## Out of Scope

- UI components
- Hot-swap state migration
- 3D rendering
- Legacy RenderTree path
