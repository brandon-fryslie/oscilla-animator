# Plan: Oscilla v2 Runtime Implementation

**Created**: 2026-01-05
**Topic**: v2-rewrite
**Source**: HANDOFF-oscilla-v2-rewrite-2026-01-05.md

---

## Overview

Complete the v2 clean rewrite by implementing the runtime layer. The compiler is complete (11 tests passing). Now we need to execute compiled IR programs and render results.

## Background

The v2 rewrite escapes legacy patterns from v1 that caused AI agent churn:
- ONE block pattern (`outputsById` only)
- ONE compiler path (IR only, no closure fallback)
- Behavior tests only (not implementation tests)
- No legacy fallbacks (no `signalBridge`, no `RenderTree`)

## Implementation Steps

### Phase 1: Copy Architecture Docs
Copy `design-docs/final-System-Invariants/` from v1 to v2 for reference.

### Phase 2: Runtime Foundation
1. **BufferPool.ts** - Field buffer allocation pool
2. **timeResolution.ts** - EffectiveTime calculation

### Phase 3: Runtime Core
3. **RuntimeState.ts** - ValueStore, FrameCache (simplified, no hot-swap initially)
4. **Materializer.ts** - Field expression to buffer (NO signalBridge)
5. **ScheduleExecutor.ts** - Step-by-step frame execution

### Phase 4: Renderer
6. **types.ts** - RenderFrameIR, RenderPassIR types
7. **Canvas2DRenderer.ts** - renderFrame() method only

### Phase 5: Integration
8. **Integration test** - End-to-end: Patch -> compile -> execute -> render

## Key Constraints

- **ONE pattern per concept** - No feature flags, no dual modes
- **Port by understanding** - Read v1, implement fresh (don't copy code blocks)
- **No legacy patterns** - If unsure, ask
- **Keep v1 as reference only** - Don't import from v1

## V1 Files to Reference (NOT copy)

| V1 File | What to Extract |
|---------|-----------------|
| `src/editor/runtime/field/BufferPool.ts` | Pool allocation logic |
| `src/editor/runtime/executor/timeResolution.ts` | Time resolution algorithm |
| `src/editor/runtime/executor/RuntimeState.ts` | Core state structure |
| `src/editor/runtime/field/Materializer.ts` | Fill buffer logic (skip signalBridge) |
| `src/editor/runtime/executor/ScheduleExecutor.ts` | Step dispatch |
| `src/editor/runtime/canvasRenderer.ts` | renderFrame() method only |

## Success Criteria

- All v2 tests pass
- Can compile a simple patch (TimeRoot + Oscillator + Domain + Renderer)
- Can execute compiled program to produce RenderFrameIR
- Can render RenderFrameIR to canvas
- No legacy patterns in codebase
