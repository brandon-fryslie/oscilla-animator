# Debug + Export Workstream - Completion Sprint

**Generated**: 2025-12-31-014004
**Source**: STATUS-2025-12-31-013400.md
**Scope**: Workstream 7 - Debug + Export (Final Verification)
**Total Effort**: 2-4 hours
**Current Status**: 85% complete (major deliverables COMPLETE, minor test fixture bug)

---

## Executive Summary

This workstream is **85% complete** with all 4 major deliverables fully implemented. The remaining work focuses on:

1. **Fixing broken test fixtures** (trivial - add `debugProbes: []` field)
2. **Verifying deterministic replay** works in practice
3. **End-to-end validation** that debug probe flow is functional

**Critical Findings from STATUS**:
- ✅ DebugDisplay IR lowering COMPLETE (fully implemented with registerDebugProbe)
- ✅ Debug infrastructure COMPLETE (StepDebugProbe, executeDebugProbe, TraceController all working)
- ✅ Export pipeline COMPLETE (ImageSequenceExporter, VideoExporter, GifExporter, StandaloneExporter all exist with tests)
- ✅ Deterministic replay COMPLETE (Seeded PRNG in core/rand.ts, Math.random() usage is safe)
- ❌ Test suite BROKEN (6 TypeScript errors in state-offset-resolution.test.ts - missing debugProbes field)

**Strategy**: Single focused sprint to fix test fixtures, verify determinism, and validate end-to-end debug flow.

---

## Sprint: Completion and Verification

**Goal**: Fix remaining issues and validate workstream is truly complete
**Effort**: 2-4 hours
**Priority**: P0 (Critical - blocks workstream completion)

---

### Work Item 1: Fix Test Fixtures

**Status**: Broken (6 TypeScript compilation errors)
**Effort**: 15-30 minutes
**Dependencies**: None
**Spec Reference**: N/A (test infrastructure) • **Status Reference**: STATUS-2025-12-31-013400.md § Test Suite Assessment

#### Description
Fix broken test fixtures in `state-offset-resolution.test.ts` by adding missing `debugProbes: []` field to 6 mock BuilderProgramIR objects.

**Current Issue** (from STATUS):
```typescript
// src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts
// Lines 84, 143, 206, 249, 307, 371

const builderIR = {
  signalIR: { nodes: [...] },
  fieldIR: { nodes: [] },
  eventIR: { nodes: [] },
  constants: [],
  stateLayout: [...],
  transformChains: [],
  renderSinks: [],
  domains: [],
  cameras: [],
  debugIndex: { ... },
  timeModel: { ... },
  slotMetadata: [],
  nextValueSlot: 10,
  // MISSING: debugProbes: []  <-- Add this line
};
```

**Error Message**:
```
src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts(84,9): error TS2345
Property 'debugProbes' is missing in type '{ signalIR: ...; }' but required in type 'BuilderProgramIR'.
```

#### Acceptance Criteria
- [ ] Add `debugProbes: []` to all 6 mock BuilderProgramIR objects (lines 84, 143, 206, 249, 307, 371)
- [ ] TypeScript compiles without errors (`just typecheck` passes)
- [ ] Tests run successfully (`just test` passes)
- [ ] No runtime behavior changes (fixtures now match expected type shape)

#### Technical Notes
- This is purely a test fixture issue - the actual runtime code is correct
- The `debugProbes` field was added to BuilderProgramIR for debug support
- Each mock object needs: `debugProbes: []` (empty array)
- Zero runtime impact - this just makes test fixtures type-safe

**Files to Modify**:
1. `src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts` - Add debugProbes field to 6 mock objects

---

### Work Item 2: Verify Deterministic Replay

**Status**: Needs Verification (infrastructure exists, needs validation)
**Effort**: 30-60 minutes
**Dependencies**: Work Item 1 (tests must pass)
**Spec Reference**: SPEC-10 § Determinism • **Status Reference**: STATUS-2025-12-31-013400.md § Deliverable 4

#### Description
Verify that the seeded PRNG is actually used in exporters and produces deterministic output. Validate Math.random() audit is correct and no problematic usage exists.

**From STATUS**:
- ✅ Seeded PRNG implemented (src/core/rand.ts - Mulberry32 algorithm)
- ✅ Math.random() audit shows NO problematic usage (3 locations all safe)
- ⚠️ Need to verify exporters actually use seeded PRNG in practice

**Math.random() Usage Locations** (all verified safe):
1. `core/rand.ts` - Comment explaining why NOT to use Math.random() ✅
2. `controlSurface/store.ts` - Uses PRNG, NOT Math.random() (comment documenting replacement) ✅
3. `pathLibrary/index.ts` - User path ID generation (compile-time, non-deterministic IDs OK) ✅

#### Acceptance Criteria
- [ ] Read ImageSequenceExporter.ts and verify it creates RuntimeState with program seed
- [ ] Read VideoExporter.ts and verify seeded PRNG usage
- [ ] Read GifExporter.ts and verify seeded PRNG usage
- [ ] Read StandaloneExporter.ts and verify seeded PRNG usage
- [ ] Confirm Math.random() is ONLY used for compile-time ID generation (not runtime)
- [ ] Document findings: "Deterministic replay verified - all exporters use seeded PRNG"

#### Technical Notes
- Look for `createRuntimeState(program, config)` - this should use program seed
- Verify NO Math.random() calls in export frame loops
- Check that RuntimeState receives explicit seed, not Date.now() or random
- This is a **verification task**, not implementation (code already exists)

**Files to Review**:
1. `src/editor/export/ImageSequenceExporter.ts` - Check RuntimeState creation
2. `src/editor/export/VideoExporter.ts` - Check RuntimeState creation
3. `src/editor/export/GifExporter.ts` - Check RuntimeState creation
4. `src/editor/export/StandaloneExporter.ts` - Check RuntimeState creation

---

### Work Item 3: Validate End-to-End Debug Probe Flow

**Status**: Needs Validation (components exist, need integration check)
**Effort**: 1-2 hours
**Dependencies**: Work Item 1 (tests must pass)
**Spec Reference**: SPEC-11 § Debug Infrastructure • **Status Reference**: STATUS-2025-12-31-013400.md § Deliverable 1, § Data Flow Verification

#### Description
Validate that the complete debug probe flow works end-to-end: DebugDisplay block → IR lowering → StepDebugProbe emission → executeDebugProbe → TraceController → ProbeCard UI.

**From STATUS**:
All components exist and are wired together:
1. ✅ DebugDisplay.ts calls registerDebugProbe() (lines 40-73)
2. ✅ IRBuilder stores probes in builderIR.debugProbes
3. ✅ buildSchedule() emits StepDebugProbe steps
4. ✅ ScheduleExecutor dispatches to executeDebugProbe() (line 224)
5. ✅ executeDebugProbe() writes to TraceController (line 72)
6. ✅ ProbeCard reads from TraceController

**Confidence from STATUS**: HIGH - All components exist and are wired together.

#### Acceptance Criteria
- [ ] Trace through code path from DebugDisplay.ts → IRBuilder → buildSchedule
- [ ] Verify StepDebugProbe is included in StepIR discriminated union
- [ ] Verify ScheduleExecutor case "debugProbe" dispatches correctly
- [ ] Verify executeDebugProbe reads slots and writes to TraceController
- [ ] Check ProbeCard.tsx for TraceController integration (may need update)
- [ ] Document: "End-to-end debug probe flow validated" OR "ProbeCard needs TraceController integration"

#### Technical Notes
- This is a **code inspection task** to validate the data flow
- If ProbeCard doesn't read from TraceController, create follow-up work item
- Focus on confirming the wiring is correct, not runtime testing
- STATUS indicates all components exist, but ProbeCard may need updates

**Files to Review**:
1. `src/editor/compiler/blocks/debug/DebugDisplay.ts` - Confirm registerDebugProbe calls
2. `src/editor/compiler/ir/IRBuilderImpl.ts` - Confirm debugProbes collection
3. `src/editor/compiler/ir/schedule.ts` - Confirm StepDebugProbe in StepIR union
4. `src/editor/runtime/executor/ScheduleExecutor.ts` - Confirm case "debugProbe" dispatch
5. `src/editor/runtime/executor/steps/executeDebugProbe.ts` - Confirm TraceController write
6. `src/editor/debug-ui/ProbeCard.tsx` - Check TraceController integration

---

## Dependency Graph

```
Work Item 1 (Fix Tests) ──┬──> Work Item 2 (Verify Determinism)
                          │
                          └──> Work Item 3 (Validate Debug Flow)
```

**Critical Path**: Work Item 1 must complete first (tests must pass)
**Parallel Work**: Work Items 2 and 3 can proceed in parallel after Item 1

---

## Risk Assessment

| Risk | Severity | Likelihood | Work Item | Mitigation |
|------|----------|------------|-----------|------------|
| **Test fixtures have more issues** | LOW | LOW | 1 | Run tests after each fix, check for new errors |
| **Exporters don't use seeded PRNG** | MEDIUM | LOW | 2 | If found, create follow-up work item (not critical) |
| **ProbeCard not connected to TraceController** | MEDIUM | MEDIUM | 3 | Create follow-up work item if gap found |
| **Debug flow has missing steps** | LOW | LOW | 3 | Document gaps, create follow-up work items |

---

## Success Criteria

### Work Item 1 Success
- ✅ TypeScript compiles without errors
- ✅ Tests pass (`just test` succeeds)
- ✅ No new errors introduced

### Work Item 2 Success
- ✅ All 4 exporters verified to use seeded PRNG
- ✅ Math.random() usage confirmed safe (compile-time only)
- ✅ Deterministic replay documented as complete

### Work Item 3 Success
- ✅ End-to-end debug probe flow validated through code inspection
- ✅ Any gaps documented with follow-up work items
- ✅ ProbeCard integration status confirmed

### Overall Sprint Success
- ✅ Test suite passing (no TypeScript errors)
- ✅ Deterministic replay verified
- ✅ Debug probe flow validated or gaps documented
- ✅ Workstream marked as COMPLETE or follow-up items created

---

## Files to Modify/Review

### Modified Files (1 total)
- `src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts` - Add debugProbes field (Work Item 1)

### Files to Review (10 total)
**Work Item 2 (4 files)**:
- `src/editor/export/ImageSequenceExporter.ts`
- `src/editor/export/VideoExporter.ts`
- `src/editor/export/GifExporter.ts`
- `src/editor/export/StandaloneExporter.ts`

**Work Item 3 (6 files)**:
- `src/editor/compiler/blocks/debug/DebugDisplay.ts`
- `src/editor/compiler/ir/IRBuilderImpl.ts`
- `src/editor/compiler/ir/schedule.ts`
- `src/editor/runtime/executor/ScheduleExecutor.ts`
- `src/editor/runtime/executor/steps/executeDebugProbe.ts`
- `src/editor/debug-ui/ProbeCard.tsx`

---

## Follow-Up Work Items (If Gaps Found)

**If ProbeCard Not Connected**:
- Create work item: "Connect ProbeCard to TraceController for IR mode"
- Priority: P1 (High - completes debug UI)
- Effort: 2-3 hours

**If Exporters Don't Use Seeded PRNG**:
- Create work item: "Update exporters to use seeded PRNG for determinism"
- Priority: P2 (Medium - nice to have, not critical)
- Effort: 1-2 hours

**If Debug Flow Has Gaps**:
- Create work items for each missing integration point
- Prioritize based on impact to debug functionality

---

## Verification Checklist

After completing all work items:

- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] `just check` passes (typecheck + lint + test)
- [ ] All 4 exporters verified to use seeded PRNG OR follow-up created
- [ ] Debug probe flow validated OR follow-up created
- [ ] No regressions in existing features
- [ ] Workstream marked as COMPLETE in .agent_planning/

---

## Next Steps

1. **Execute Work Item 1** (fix test fixtures) - IMMEDIATE
2. **Run test suite** to verify fix
3. **Execute Work Items 2 & 3** in parallel (verification tasks)
4. **Document findings** and create follow-up work items if gaps found
5. **Mark workstream COMPLETE** or schedule follow-up sprint

---

## Specification References

- **SPEC-10**: Export Pipeline (assumed - debug-export workstream)
- **SPEC-11**: Debug Infrastructure (assumed - debug-export workstream)
- **STATUS-2025-12-31-013400.md**: Current implementation status (85% complete)

---

**End of Plan** - Ready for execution ✅
