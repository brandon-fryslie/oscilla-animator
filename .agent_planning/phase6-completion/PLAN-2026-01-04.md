# Plan: Phase 6 Completion - Full Scheduled Runtime

**Generated**: 2026-01-04
**Topic**: phase6-completion
**Scope**: Complete schedule-executor + Remove legacy runtime (aggressive)

---

## Executive Summary

**Goal**: Complete the IR-driven scheduled runtime and remove all legacy closure-based runtime code.

**User Direction**:
- Complete schedule-executor (executeNodeEval, executeRenderAssemble)
- Remove legacy runtime regardless of whether IR passes all tests
- Aggressive cleanup - no dual-emit preservation

---

## Current State

### COMPLETED (Phase 6)
- âœ… value-store - typed arrays for slots
- âœ… state-buffer-system - stateful op storage
- âœ… runtime-state-integration - real stores wired in
- âœ… frame-cache-system - per-frame memoization
- âœ… execute-bus-eval - bus combine step
- âœ… execute-materialize - field materialization step

### PARTIAL
- ðŸ”„ schedule-executor - Frame loop works, executeTimeDerive + executeBusEval + executeMaterialize done
  - **Missing**: executeNodeEval, executeRenderAssemble

### NOT STARTED
- âŒ hot-swap-semantics (DEFERRED per user)
- âŒ determinism-enforcement (DEFERRED per user)
- ðŸŽ¯ legacy-runtime-removal (IN SCOPE)

---

## Sprint 1: Complete Schedule Executor

### Task 1.1: Implement executeNodeEval

**Location**: `src/editor/runtime/executor/steps/executeNodeEval.ts`

**Purpose**: Execute a single block's computation, reading inputs from ValueStore, writing outputs to ValueStore.

**Implementation**:
```typescript
export function executeNodeEval(
  step: StepNodeEval,
  state: RuntimeState
): void {
  const { nodeIndex, inputSlots, outputSlots } = step;

  // 1. Gather input values from ValueStore
  const inputs = inputSlots.map(slot => state.valueStore.read(slot));

  // 2. Look up the node's evaluator function
  const evaluator = state.nodeEvaluators.get(nodeIndex);

  // 3. Execute evaluator
  const outputs = evaluator(inputs, state.env);

  // 4. Write outputs to ValueStore
  outputSlots.forEach((slot, i) => state.valueStore.write(slot, outputs[i]));
}
```

**Acceptance Criteria**:
- [ ] executeNodeEval reads inputs from correct slots
- [ ] executeNodeEval calls node evaluator with inputs
- [ ] executeNodeEval writes outputs to correct slots
- [ ] Unit tests for executeNodeEval pass

### Task 1.2: Implement executeRenderAssemble

**Location**: `src/editor/runtime/executor/steps/executeRenderAssemble.ts`

**Purpose**: Assemble render output from field buffers, producing the final RenderTree.

**Implementation**:
```typescript
export function executeRenderAssemble(
  step: StepRenderAssemble,
  state: RuntimeState
): RenderTree {
  const { renderSinkIndex, fieldSlots, outputSpec } = step;

  // 1. Read materialized field buffers
  const buffers = fieldSlots.map(slot => state.valueStore.readField(slot));

  // 2. Assemble render output per outputSpec
  const renderTree = assembleRenderTree(buffers, outputSpec);

  // 3. Return render tree (or write to designated output)
  return renderTree;
}
```

**Acceptance Criteria**:
- [ ] executeRenderAssemble reads field buffers from slots
- [ ] executeRenderAssemble produces valid RenderTree
- [ ] Integration with existing render pipeline
- [ ] Unit tests for executeRenderAssemble pass

### Task 1.3: Wire Step Executors into Frame Loop

**Location**: `src/editor/runtime/executor/FrameExecutor.ts` (or similar)

**Purpose**: The main frame execution loop dispatches to step executors.

**Implementation**:
```typescript
export function executeFrame(schedule: ScheduleIR, state: RuntimeState): void {
  for (const step of schedule.steps) {
    switch (step.kind) {
      case 'timeDerive': executeTimeDerive(step, state); break;
      case 'nodeEval': executeNodeEval(step, state); break;
      case 'busEval': executeBusEval(step, state); break;
      case 'materialize': executeMaterialize(step, state); break;
      case 'renderAssemble': executeRenderAssemble(step, state); break;
      case 'debugProbe': /* skip for now */ break;
    }
  }
}
```

**Acceptance Criteria**:
- [ ] Frame loop dispatches to all step executors
- [ ] Full schedule executes without errors
- [ ] Output matches expected for golden patch

---

## Sprint 2: Remove Legacy Runtime

### Task 2.1: Identify Legacy Runtime Code

Search for:
- Closure-based artifact evaluation
- Direct closure execution in render loop
- Dual-emit code paths
- Legacy `compile()` vs IR `compileIR()` branches

**Files to audit**:
- `src/editor/compiler/compile.ts`
- `src/editor/compiler/compileBusAware.ts`
- `src/editor/runtime/` (all files)
- `src/editor/Player.ts` or equivalent

### Task 2.2: Remove Dual-Emit Infrastructure

**Changes**:
1. Remove `emitClosures` option from compiler
2. Remove closure artifact types from CompileResult
3. Remove closure execution paths from runtime
4. Update all callers to use IR-only path

### Task 2.3: Delete Legacy Runtime Files

**Candidates for deletion**:
- Any file that only handles closure execution
- Backup files (*.backup, *.orig)
- Deprecated evaluator code

### Task 2.4: Clean Up Exports and Imports

- Remove exports of deleted types/functions
- Update index files
- Fix any broken imports

**Acceptance Criteria**:
- [ ] No closure-based evaluation code remains
- [ ] Compiler only emits IR
- [ ] Runtime only executes IR schedule
- [ ] TypeScript compiles without errors
- [ ] Tests that relied on closures are updated or removed

---

## Validation

### Machine Validation
- [ ] `pnpm typecheck` passes
- [ ] `pnpm test run` - document results (some tests may fail due to aggressive removal)
- [ ] `pnpm build` succeeds

### Runtime Validation
- [ ] Golden patch compiles with IR-only compiler
- [ ] Golden patch executes with IR runtime
- [ ] Visual output is correct (Chrome DevTools MCP)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| IR runtime doesn't handle all cases | Medium | High | Comprehensive testing before removal |
| Tests depend on closure internals | High | Medium | Update/delete affected tests |
| Missing step executors | Low | High | Sprint 1 addresses this |
| Performance regression | Low | Medium | Profile after removal |

---

## Files Summary

### CREATE
- `src/editor/runtime/executor/steps/executeNodeEval.ts`
- `src/editor/runtime/executor/steps/executeRenderAssemble.ts`

### MODIFY
- `src/editor/runtime/executor/FrameExecutor.ts` (or equivalent)
- `src/editor/compiler/compile.ts` (remove dual-emit)
- Various runtime files (remove closure paths)

### DELETE
- Legacy closure execution files
- Backup files (*.backup, *.orig)
- Deprecated code

---

**End of Plan**
