# Sprint Plan: Fix Compiler Input Resolution Errors

**Generated:** 2026-01-04

## Sprint Goal

Fix all IR lowering functions to properly accept inputs via `inputsById` and return outputs via `outputsById`, eliminating "Unresolved input" compiler errors.

## Scope

**In scope (this sprint):**
1. GridDomain - Add input parameters and migrate to outputsById
2. FieldStringToColor - Use inputsById and outputsById patterns
3. RenderInstances2D - Fix input handling for all 7 inputs
4. TimeRoot (Infinite + Finite) - Migrate to outputsById pattern

**Explicitly out of scope:**
- FieldFromExpression - Intentionally not IR-compatible (uses `Function()`)
- Oscillator - Already correct

## Work Items

### P0: Fix InfiniteTimeRoot and FiniteTimeRoot outputsById

**File:** `src/editor/compiler/blocks/domain/TimeRoot.ts`

**Acceptance Criteria:**
- [ ] InfiniteTimeRoot returns `outputsById` with keys: systemTime, phase, pulse, energy
- [ ] FiniteTimeRoot returns `outputsById` with keys: systemTime, phase, pulse, energy
- [ ] Both functions have `outputs: []` (empty legacy array)
- [ ] Patch with TimeRoot compiles without errors

**Technical Notes:**
- Change from: `return { outputs: [ref1, ref2, ref3, ref4], declares }`
- Change to: `return { outputs: [], outputsById: { systemTime: ref1, phase: ref2, pulse: ref3, energy: ref4 }, declares }`

---

### P1: Fix GridDomain input handling

**File:** `src/editor/compiler/blocks/domain/GridDomain.ts`

**Acceptance Criteria:**
- [ ] Function signature includes `inputs` and `inputsById` parameters
- [ ] All 5 inputs accessed via `inputsById?.portId ?? inputs[index]`: rows, cols, spacing, originX, originY
- [ ] Returns `outputsById` with keys: domain, pos0
- [ ] GridDomain block compiles without "Unresolved input" errors

**Technical Notes:**
- Current function ignores inputs entirely, reads from config
- Must extract scalar values from inputs (rows, cols are Scalar:int)
- spacing, originX, originY are Signal:float

---

### P2: Fix FieldStringToColor pattern

**File:** `src/editor/compiler/blocks/domain/FieldStringToColor.ts`

**Acceptance Criteria:**
- [ ] Uses `inputsById?.strings ?? inputs[0]` instead of `inputs[0]`
- [ ] Returns `{ outputs: [], outputsById: { colors: ... } }`
- [ ] Patch with FieldStringToColor compiles without errors

**Technical Notes:**
- Simple passthrough block (Field<string> -> Field<color>)
- Just needs pattern migration, logic stays the same

---

### P3: Fix RenderInstances2D input handling

**File:** `src/editor/compiler/blocks/domain/RenderInstances2D.ts`

**Acceptance Criteria:**
- [ ] All 7 inputs handled: domain, positions, radius, color, opacity, glow, glowIntensity
- [ ] Uses `inputsById` pattern for each input
- [ ] No array destructuring `const [a, b, c] = inputs`
- [ ] Render sink compiles without "Unresolved input" errors

**Technical Notes:**
- Current code destructures only 5 inputs, misses glow and glowIntensity
- glow is Scalar:boolean (on/off)
- glowIntensity is Signal:float

## Dependencies

- All changes are independent and can be done in parallel
- TimeRoot fix should be done first (blocks the whole pipeline)

## Risks

1. **Input type mismatches** - Each input has specific world (Scalar/Signal/Field). Must validate kind properly.
2. **Missing default handling** - If input not connected, defaultSource should provide value. Verify defaults work.

## Verification

After all fixes:
```bash
just typecheck   # No TypeScript errors
just test        # IR lowering tests pass
```

Then verify in browser with Chrome DevTools MCP that patches compile and render correctly.
