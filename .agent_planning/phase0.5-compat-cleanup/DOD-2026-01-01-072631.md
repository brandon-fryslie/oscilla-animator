# Definition of Done: Track A Completion

**Generated:** 2026-01-01-072631
**Plan:** PLAN-2026-01-01-072631.md
**Source STATUS:** STATUS-2026-01-01-track-a-completion.md
**Topic:** Complete Track A - Lens/Adapter Transform Unification

---

## Sprint Scope

**This sprint delivers:**
- Unified transform application function in Pass 8
- Removal of legacy transform fields from Edge and related types

**Deferred:**
- Unifying LensApplyFn and AdapterApplyFn signatures (determined unnecessary - kind branching is appropriate)
- Sprints 1-5 bus unification work (separate track)
- Track B registry cleanup (separate parallel track)

---

## Acceptance Criteria

### P0: Complete A.4 - Unified applyTransforms() Function

**Function Implementation:**
- [ ] `applyTransforms(valueRef, transforms, builder, errors, context)` function exists in pass8-link-resolution.ts
- [ ] Function iterates through `TransformStep[]` array once
- [ ] Function branches on `step.kind` to dispatch to correct handler
- [ ] `applyAdapterStep()` helper function handles adapter transforms correctly
- [ ] `applyLensStep()` helper function handles lens transforms correctly
- [ ] Error handling preserved from original functions (registry lookup, compileToIR failures)
- [ ] Error messages remain clear and actionable

**Call Site Updates:**
- [ ] Line ~606 updated to use `applyTransforms()` (edge processing, adapters)
- [ ] Line ~617 updated to use `applyTransforms()` (edge processing, lenses)
- [ ] Line ~662 updated to use `applyTransforms()` (wire with listener, adapters)
- [ ] Line ~673 updated to use `applyTransforms()` (wire with listener, lenses)
- [ ] Line ~727 updated to use `applyTransforms()` (bus publishers, adapters)
- [ ] Line ~738 updated to use `applyTransforms()` (bus publishers, lenses)
- [ ] All call sites use `getEdgeTransforms(edge)` to retrieve transforms

**Cleanup:**
- [ ] Old `applyAdapterChain()` function removed (was lines 351-413)
- [ ] Old `applyLensStack()` function removed (was lines 421-489)
- [ ] TODO comments about Phase 0.5 removed from Pass 8

**Testing:**
- [ ] All 2796+ existing tests pass
- [ ] New test: Mixed adapter+lens transform chain executes correctly
- [ ] New test: Execution order preserved (matches legacy behavior)
- [ ] New test: Error handling for unknown transform ID
- [ ] New test: Error handling for wrong transform kind
- [ ] New test: Error handling for compileToIR returning null
- [ ] Golden patch compiles without errors
- [ ] No regression in compiled IR output (compare before/after)

---

### P1: Complete A.5 - Remove Legacy Transform Fields

**Type Definitions (src/editor/types.ts):**
- [ ] Edge interface has ONLY `transforms?: TransformStep[]` field
- [ ] No `lensStack?: LensInstance[]` on Edge (line 309 removed)
- [ ] No `adapterChain?: AdapterStep[]` on Edge (line 315 removed)
- [ ] Publisher interface: legacy fields removed (lines 354, 357)
- [ ] Listener interface: legacy fields removed (lines 386, 392)
- [ ] Connection interface: legacy fields removed (lines 796, 799)
- [ ] Endpoint union updated if needed (lines 232-233)

**Binding Types (src/editor/bindings/types.ts):**
- [ ] NormalizedBinding uses only transforms field
- [ ] No references to lensStack or adapterChain

**Edge Migration (src/editor/edgeMigration.ts):**
- [ ] Dual-write logic removed from `connectionToEdge()`
- [ ] Dual-write logic removed from `publisherToEdge()`
- [ ] Dual-write logic removed from `listenerToEdge()`
- [ ] Factory functions populate only transforms field
- [ ] `convertLegacyTransforms()` may remain (for backward compat/debugging)
- [ ] `convertToLegacyTransforms()` calls removed

**PatchStore (src/editor/stores/PatchStore.ts):**
- [ ] No legacy field handling in edge creation
- [ ] All edge mutations use transforms only

**Verification:**
- [ ] `rg "lensStack" src/ --type ts` finds ZERO results
- [ ] `rg "adapterChain" src/ --type ts` finds ZERO results
- [ ] (Exception: comments, deprecation notes, or conversion utilities if kept)

**Compilation & Tests:**
- [ ] TypeScript compilation succeeds with zero errors
- [ ] All 2796+ tests pass
- [ ] Test files updated to use transforms field (not legacy fields)
- [ ] Golden patch compiles without errors
- [ ] Dev server (`just dev`) starts without runtime errors
- [ ] Visual output matches expected (scrub timeline, verify animation)

---

## Final Verification

**Before marking Track A complete, verify ALL of the following:**

**Code Quality:**
- [ ] No ESLint warnings related to changes
- [ ] `just check` passes (typecheck + lint + test)
- [ ] All functions have clear, documented signatures
- [ ] Error messages are helpful and actionable

**Functional:**
- [ ] Edge interface simplified: 3 fields → 1 field (67% reduction)
- [ ] Pass 8 application functions: 2 → 1 (50% reduction)
- [ ] Pass 8 call sites: 12 → 6 (50% reduction)
- [ ] Transform metadata preserved through migration
- [ ] No regressions in transform execution behavior

**Documentation:**
- [ ] PROGRESS-Track-A.md updated to mark Track A 100% complete
- [ ] Git commits have clear, descriptive messages
- [ ] Any architectural decisions documented in code comments

**Safety:**
- [ ] Full test suite passes
- [ ] Golden patch verified working
- [ ] Dev server manual testing completed
- [ ] No console errors or warnings in dev server
- [ ] Timeline scrubbing works correctly
- [ ] Animation output visually correct

---

## Sprint Deliverables

**Deliverable 1: Unified Transform Application (A.4)**
- Single `applyTransforms()` function replacing dual-path logic
- Helper functions for adapter and lens application
- 6 call sites updated to use unified function
- Tests verifying correct execution and error handling
- **Estimated:** 5-10 new tests added

**Deliverable 2: Legacy Field Removal (A.5)**
- Edge interface simplified to single transforms field
- Related types cleaned up (Publisher, Listener, Connection, NormalizedBinding)
- Dual-write logic removed from edge factories
- All references to lensStack/adapterChain eliminated
- **Estimated:** 3-5 test updates

---

## Success Criteria Summary

**Track A is complete when:**

1. ✅ Edge has unified transforms array (A.1-A.3, already complete)
2. ✅ Conversion utilities exist and work (A.2, already complete)
3. ✅ All edge creation populates transforms (A.3, already complete)
4. ⬜ Single applyTransforms() function in Pass 8 (A.4, this sprint)
5. ⬜ No lensStack/adapterChain fields remain (A.5, this sprint)
6. ⬜ All tests passing (maintained throughout)
7. ⬜ No regressions in transform execution (verified)

**Total deliverables:** 2 (A.4 + A.5)
**Acceptance criteria:** 60+ checkboxes across both deliverables
**Estimated effort:** 2-4 days focused work

---

**Generated by:** status-planner
**Timestamp:** 2026-01-01-072631
**Status:** Ready for implementation
**Next Step:** Begin A.4 implementation - create unified applyTransforms function
