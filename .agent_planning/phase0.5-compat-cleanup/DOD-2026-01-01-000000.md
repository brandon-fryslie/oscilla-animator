# Definition of Done: Phase 0.5 Compatibility Layer Cleanup

**Generated**: 2026-01-01-000000
**Plan**: PLAN-2026-01-01-000000.md
**Source Evaluation**: STATUS-2026-01-01.md

---

## Sprint 1: Make Edges Authoritative

This sprint delivers edges as the single source of truth for all connection data.

### Deliverable 1.1: Patch Migration on Load

- [ ] Migration function `migratePatchToEdges(patch: Patch): Patch` created
- [ ] Detects patches with empty/missing `edges` array
- [ ] Converts connections/publishers/listeners to unified edges
- [ ] Preserves all edge metadata (weight, sortKey, enabled, transforms)
- [ ] Handles patches that already have edges (no-op)
- [ ] Called automatically when loading patches from storage
- [ ] Unit tests verify roundtrip conversion (legacy → edges → legacy)
- [ ] Integration test loads old patch format and verifies compilation succeeds

### Deliverable 1.2: Edges Required in Patch Type

- [ ] Patch interface updated: `edges: Edge[]` (not `edges?: Edge[]`)
- [ ] All Patch creation sites provide edges array (may be empty for fresh patches)
- [ ] TypeScript compilation succeeds with no errors
- [ ] PatchStore.edges initialized to `[]` by default
- [ ] All tests pass with required edges field
- [ ] No runtime errors from missing edges property

### Deliverable 1.3: PatchStore Always Populates Edges

- [ ] `addConnection()` also adds equivalent edge via `addEdge()`
- [ ] `addPublisher()` also adds equivalent edge
- [ ] `addListener()` also adds equivalent edge
- [ ] `removeConnection()` also removes equivalent edge
- [ ] Edge mutations trigger UI updates (MobX reactivity preserved)
- [ ] All PatchStore tests pass
- [ ] No duplicate edges created from dual writes

### Deliverable 1.4: Transaction Ops for Edges

- [ ] All `ops.ts` functions handle Edge type
- [ ] Undo/redo works for edge creation
- [ ] Undo/redo works for edge deletion
- [ ] Undo/redo works for edge modification (enabled, weight)
- [ ] Transaction history tests pass
- [ ] No memory leaks in transaction stack
- [ ] Kernel ops in `src/editor/kernel/ops.ts` verified to work with edges

### Deliverable 1.5: Validation Tests

- [ ] Test: Patch with edges-only (no legacy arrays) compiles successfully
- [ ] Test: Warning emitted if edges is empty but connections are filled
- [ ] Test: Migration converts all legacy edge types correctly
- [ ] Test: Dual-write maintains consistency between edges and legacy arrays
- [ ] Test: Golden patch compilation with edges-only format
- [ ] All new tests pass

### Sprint 1 Acceptance

- [ ] All patches loaded through the system have edges populated
- [ ] PatchStore maintains edges array in sync with legacy arrays
- [ ] Transaction system works with Edge type
- [ ] 2796+ tests passing (no regressions)
- [ ] Golden patch compiles with edges-only format
- [ ] Documentation updated with migration notes

---

## Sprint 2: Compiler Edges-Only Execution

This sprint delivers compiler passes that use edges exclusively, eliminating dual-path execution.

### Deliverable 2.1: Pass 1 Edges-Only

- [ ] Lines 99-122 (dual format handling) removed from pass1-normalize.ts
- [ ] Lines 140-156 (dual connectivity checks) simplified to edges-only
- [ ] `convertFromEdges()` import removed
- [ ] Single edge-based connectivity check: `hasEdgeToInput(edges, blockId, inputId)`
- [ ] All Pass 1 tests pass
- [ ] Compile time for golden patch unchanged (±5%)

### Deliverable 2.2: Pass 2 Edges-Only

- [ ] Single edge iteration loop (no separate wire/publisher/listener loops)
- [ ] Legacy wire format handling removed (line 460)
- [ ] All type error detection preserved
- [ ] Pass 2 tests updated and passing
- [ ] No new type errors on golden patch

### Deliverable 2.3: Pass 7 Edges-Only

- [ ] Lines 164-177 (dual publisher retrieval) removed from pass7-bus-lowering.ts
- [ ] `getPublishersFromEdges()` function deleted (lines 88-119)
- [ ] Publisher sorting preserved (weight, sortKey)
- [ ] Bus combine node creation unchanged
- [ ] All bus lowering tests pass
- [ ] Multi-bus patches compile correctly

### Deliverable 2.4: Pass 8 Verification

- [ ] Code audit confirms edges-only usage
- [ ] No references to connections/publishers/listeners arrays
- [ ] All link resolution tests pass
- [ ] No broken connections in compiled IR
- [ ] Fragment linking works for all edge types

### Deliverable 2.5: NormalizedPatch Cleanup

- [ ] `NormalizedPatch` interface has only `edges: Edge[]`
- [ ] No `connections`, `publishers`, `listeners` fields in IR types
- [ ] All compiler passes compile without errors
- [ ] IR serialization/deserialization works
- [ ] No test failures from IR changes

### Sprint 2 Acceptance

- [ ] Zero dual-path execution in compiler passes
- [ ] All passes use edges exclusively
- [ ] NormalizedPatch has no legacy arrays
- [ ] 2796+ tests passing (no regressions)
- [ ] Compile time unchanged (±5%)
- [ ] Golden patch compiles correctly

---

## Sprint 3: Remove Migration Helpers

This sprint delivers a cleaner codebase by removing migration helper code no longer needed.

### Deliverable 3.1: Audit Migration Helper Usage

- [ ] Grep confirms no imports of `convertFromEdges` (except tests)
- [ ] Grep confirms no imports of `convertToEdges` (except tests)
- [ ] Grep confirms no imports of migration helper functions
- [ ] All identified imports are in test files or migration-on-load code
- [ ] Safe-to-delete confirmation documented

### Deliverable 3.2: Delete Migration Helper Module

- [ ] File deleted: `src/editor/edgeMigration.ts` (315 lines)
- [ ] File deleted: `src/editor/__tests__/edgeMigration.test.ts`
- [ ] TypeScript compilation succeeds
- [ ] All remaining tests pass
- [ ] No broken imports
- [ ] Git history preserves deleted code for future reference

### Sprint 3 Acceptance

- [ ] edgeMigration.ts deleted
- [ ] No imports of deleted module
- [ ] 2796+ tests passing
- [ ] Codebase ~315 lines smaller

---

## Sprint 4: Clean Type Definitions & Patch Interface

This sprint delivers a clean type system by removing deprecated types and legacy Patch fields.

### Deliverable 4.1: Remove Deprecated Type Definitions

- [ ] `Connection` interface removed (lines 744-779 of types.ts)
- [ ] `Publisher` interface removed (lines 302-330)
- [ ] `Listener` interface removed (lines 334-356)
- [ ] TypeScript compilation attempted (will have errors - expected)
- [ ] All compile errors documented for fixing in 4.2
- [ ] No test files directly reference deleted types

### Deliverable 4.2: Remove Legacy Arrays from Patch

- [ ] Patch interface updated: remove `connections`, `publishers`, `listeners`
- [ ] Patch interface updated: remove `defaultSources`, `defaultSourceAttachments`
- [ ] `edges: Edge[]` is the only connection field
- [ ] Patch version bumped to 2
- [ ] Migration-on-load code handles old version gracefully
- [ ] TypeScript compilation succeeds
- [ ] All tests pass

### Deliverable 4.3: Fix Remaining Compile Errors

- [ ] Zero TypeScript errors
- [ ] All affected files updated
- [ ] No `@ts-ignore` or `@ts-expect-error` added (fix properly)
- [ ] All tests pass
- [ ] No runtime errors in dev server

### Sprint 4 Acceptance

- [ ] Connection/Publisher/Listener types removed
- [ ] Patch interface has no legacy arrays
- [ ] Patch version bumped to 2
- [ ] Zero TypeScript errors
- [ ] 2796+ tests passing
- [ ] Migration-on-load handles version 1 patches

---

## Sprint 5: Remove PatchStore Legacy Arrays

This sprint delivers a PatchStore that uses edges exclusively.

### Deliverable 5.1: Remove Legacy Observables

- [ ] `connections: Connection[]` observable removed
- [ ] `publishers: Publisher[]` observable removed
- [ ] `listeners: Listener[]` observable removed
- [ ] MobX makeObservable config updated
- [ ] Computed getters preserved: `wireEdges`, `publisherEdges`, `listenerEdges`
- [ ] TypeScript compilation succeeds

### Deliverable 5.2: Remove Legacy Mutation Methods

- [ ] `addConnection()` method removed
- [ ] `removeConnection()` method removed
- [ ] `updateConnection()` method removed
- [ ] Equivalent publisher/listener methods removed
- [ ] All method calls replaced with `addEdge()`/`removeEdge()`/`updateEdge()`
- [ ] UI components updated to use edge methods
- [ ] All tests pass

### Deliverable 5.3: Update UI Components

- [ ] Canvas connection rendering uses edges
- [ ] Inspector edge editor uses edges
- [ ] No UI references to connections/publishers/listeners
- [ ] UI tests pass
- [ ] Manual testing confirms no visual regressions
- [ ] Connection creation/deletion works in dev server

### Sprint 5 Acceptance

- [ ] PatchStore has no legacy arrays
- [ ] All mutation methods use edges
- [ ] UI components work with edges
- [ ] 2796+ tests passing
- [ ] Dev server fully functional
- [ ] No MobX reactivity issues

---

## Track A: Transform Storage Unification

This track delivers unified transform storage on Edge (parallel to main sprints).

### Deliverable A.1: Add Transforms Field

- [ ] Edge interface has `transforms?: TransformStep[]` field
- [ ] Legacy fields marked deprecated: `lensStack`, `adapterChain`
- [ ] TypeScript compilation succeeds
- [ ] No runtime changes yet (field is optional)
- [ ] TransformStep type already exists (confirmed)

### Deliverable A.2: Transform Conversion Utility

- [ ] Function: `convertLegacyTransforms(lensStack?, adapterChain?) → TransformStep[]`
- [ ] Function: `convertToLegacyTransforms(transforms) → { lensStack, adapterChain }`
- [ ] Preserves transform order and metadata
- [ ] Handles empty/undefined inputs
- [ ] 100% test coverage
- [ ] Roundtrip conversion verified: legacy → new → legacy

### Deliverable A.3: Edge Creation Populates Transforms

- [ ] All `addEdge()` calls populate transforms field
- [ ] All edge factory functions use transforms
- [ ] Legacy fields still populated during migration period
- [ ] No edges created with only legacy fields (transforms always present)
- [ ] Tests verify transforms field is populated

### Deliverable A.4: Compiler Reads Transforms

- [ ] Pass 2 (Type Checking) reads transforms field
- [ ] Pass 6 (Block Lowering) reads transforms field
- [ ] Pass 7 (Bus Lowering) reads transforms field
- [ ] Pass 8 (Link Resolution) reads transforms field
- [ ] Falls back to legacy fields if transforms is empty (during migration)
- [ ] All compiler tests pass

### Deliverable A.5: Remove Legacy Transform Fields

- [ ] Edge interface: `lensStack` removed
- [ ] Edge interface: `adapterChain` removed
- [ ] Only `transforms: TransformStep[]` remains
- [ ] TypeScript compilation succeeds
- [ ] All tests pass
- [ ] No references to removed fields in codebase

### Track A Acceptance

- [ ] Edge uses unified transforms array
- [ ] Legacy lensStack/adapterChain removed
- [ ] All compiler passes use transforms
- [ ] 2796+ tests passing
- [ ] Transform metadata preserved

---

## Track B: Registry Cleanup

This track delivers compiler using TRANSFORM_REGISTRY exclusively (parallel to main sprints).

### Deliverable B.1: Compiler Uses TRANSFORM_REGISTRY

- [ ] Pass 2 imports from TRANSFORM_REGISTRY
- [ ] Pass 6 imports from TRANSFORM_REGISTRY
- [ ] Pass 7 imports from TRANSFORM_REGISTRY
- [ ] Pass 8 imports from TRANSFORM_REGISTRY
- [ ] No imports from old registries in compiler code
- [ ] All compiler tests pass
- [ ] Transform lookups work correctly

### Deliverable B.2: Update Non-Compiler Imports

- [ ] `src/editor/transforms/catalog.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/compiler/ir/transforms.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/lenses/lensInstances.ts` uses TRANSFORM_REGISTRY
- [ ] `src/editor/adapters/autoAdapter.ts` uses TRANSFORM_REGISTRY
- [ ] All imports from old registries removed
- [ ] TypeScript compilation succeeds

### Deliverable B.3: (Optional) Implement Facade Pattern

- [ ] LensRegistry exports facade that delegates to TRANSFORM_REGISTRY
- [ ] AdapterRegistry exports facade that delegates to TRANSFORM_REGISTRY
- [ ] Console warnings emitted when using old registries
- [ ] Existing code continues to work (with warnings)
- [ ] Migration guide in CHANGELOG references warnings

### Deliverable B.4: Delete Old Registry Files

- [ ] File deleted: `src/editor/lenses/LensRegistry.ts`
- [ ] File deleted: `src/editor/adapters/AdapterRegistry.ts`
- [ ] Migration files deleted: `src/editor/transforms/migrateLenses.ts`
- [ ] Migration files deleted: `src/editor/transforms/migrateAdapters.ts`
- [ ] TypeScript compilation succeeds
- [ ] All tests pass
- [ ] No broken imports

### Track B Acceptance

- [ ] Compiler uses TRANSFORM_REGISTRY exclusively
- [ ] Old registries deleted
- [ ] Migration helpers deleted
- [ ] 2796+ tests passing
- [ ] No console warnings from deprecated registry usage

---

## Overall Phase 0.5 Completion

### Minimum Viable Cleanup (Can Ship)

- [ ] Edges array is authoritative in all compiler passes (Sprint 2)
- [ ] No dual-path execution in Pass 1, 2, 7, 8 (Sprint 2)
- [ ] TRANSFORM_REGISTRY in use (Track B.1)
- [ ] Migration helpers can be safely removed (Sprint 3)

### Full Cleanup (Ideal State)

- [ ] Patch interface has no legacy arrays (Sprint 4)
- [ ] PatchStore has no legacy observables (Sprint 5)
- [ ] Connection/Publisher/Listener types removed (Sprint 4)
- [ ] edgeMigration.ts deleted (Sprint 3)
- [ ] LensRegistry/AdapterRegistry deleted (Track B.4)
- [ ] Edge has transforms field (no lensStack/adapterChain) (Track A.5)

### Quality Gates

- [ ] All 2796+ tests passing (no regressions from 18 pre-existing failures)
- [ ] Zero TypeScript compilation errors
- [ ] Golden patch compiles successfully
- [ ] Compile time within ±5% of baseline
- [ ] Dev server fully functional (verified with manual testing)
- [ ] No memory leaks in edge management
- [ ] No MobX reactivity issues
- [ ] Undo/redo works correctly
- [ ] UI components render edges correctly

### Documentation

- [ ] CHANGELOG.md updated with breaking changes
- [ ] Migration guide created for version 1 → 2 patches
- [ ] API documentation updated (PatchStore, Edge)
- [ ] Architecture docs updated (remove Connection/Publisher/Listener references)
- [ ] README.md updated if connection examples exist

### Version Bump

- [ ] Patch.version bumped to 2 (breaking change)
- [ ] Migration-on-load code handles version 1 patches
- [ ] Migration code documented to remain for 2-3 releases

---

## Sprint Scope Summary

**Sprint 1** delivers: Migration infrastructure, edges required, transaction ops
**Sprint 2** delivers: Compiler edges-only, no dual-path execution
**Sprint 3** delivers: Migration helpers deleted
**Sprint 4** delivers: Clean type system, Patch v2
**Sprint 5** delivers: PatchStore edges-only, UI updated

**Track A** delivers: Unified transform storage
**Track B** delivers: TRANSFORM_REGISTRY adoption, old registries deleted

**Deferred**: None - all cleanup work is in scope

**Estimated Timeline**: 4-5 weeks (parallel execution) or 3-4 weeks (focused sequential)
