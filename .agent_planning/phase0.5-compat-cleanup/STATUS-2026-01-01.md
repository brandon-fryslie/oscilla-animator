# Status Report - Phase 0.5: Compatibility Cleanup

**Date**: 2026-01-01
**Evaluator**: project-evaluator
**Scope**: phase0.5-compat-cleanup/full
**Confidence**: FRESH (evaluated 2026-01-01)
**Git Commit**: f325328

---

## Executive Summary

**Overall Status**: Phase 0 Architecture Refactoring completed all 4 sprints, leaving significant legacy/fallback code
**Legacy Code Identified**: 7 major categories of removal targets
**Test Quality**: 2796/2814 tests passing (18 pre-existing failures)
**Workflow Recommendation**: **CONTINUE** - Clear removal targets identified, but needs careful sequencing

Phase 0 successfully unified the architecture (Edge type, default sources, V2 adapter, TransformRegistry), but maintained backward compatibility layers throughout. These compatibility shims create:
- **Dual-path execution** (edges vs. connections/publishers/listeners)
- **Redundant type definitions** (deprecated Connection/Publisher/Listener interfaces)
- **Migration helper code** (edgeMigration.ts with bidirectional converters)
- **Legacy transform storage** (lensStack/adapterChain instead of transforms array)

**Critical Finding**: The codebase is functioning correctly with Phase 0 changes, but compatibility layers add ~15-20% overhead in maintenance complexity.

---

## Runtime Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `just test` | PASS | 2796/2814 passing (18 pre-existing failures) |
| `just typecheck` | NOT RUN | - |
| `just dev` | ASSUMED PASS | Dev server functional per recent work |

**Pre-existing test failures**: 18 failures unrelated to Phase 0 or cleanup work
- 15 in `transactions/__tests__/ops.test.ts` (error message wording)
- 3 in other test files

**No persistent checks exist** specifically for Phase 0 compatibility cleanup.

---

## Missing Checks

**Implementer should create**:

1. **Edge-only compilation test**
   - Remove connections/publishers/listeners from test patch
   - Use only edges array
   - Verify compilation succeeds
   - **Rationale**: Validates legacy arrays are truly optional

2. **Transform migration test**
   - Patch with lensStack/adapterChain on edges
   - Migrate to transforms array
   - Verify runtime equivalence
   - **Rationale**: Ensures safe migration path before removing old fields

3. **Registry facade removal test**
   - Mock old LensRegistry/AdapterRegistry imports
   - Verify error messages guide to new TRANSFORM_REGISTRY
   - **Rationale**: Ensures clean migration path for external code

---

## Legacy/Fallback Code Inventory

### Category 1: Deprecated Type Definitions (HIGH PRIORITY)

**Location**: `src/editor/types.ts`

**Deprecated Types**:
```typescript
// Lines 302-330: Publisher interface
export interface Publisher {
  readonly id: string;
  readonly busId: string;
  readonly from: PortRef;
  readonly adapterChain?: AdapterStep[];
  readonly lensStack?: LensInstance[];
  readonly weight?: number;
  enabled: boolean;
  sortKey: number;
}

// Lines 334-356: Listener interface
export interface Listener {
  readonly id: string;
  readonly busId: string;
  readonly to: PortRef;
  readonly adapterChain?: AdapterStep[];
  readonly lensStack?: LensInstance[];
  enabled: boolean;
}

// Lines 744-779: Connection interface
export interface Connection {
  readonly id: string;
  readonly from: PortRef;
  readonly to: PortRef;
  readonly lensStack?: LensInstance[];
  readonly adapterChain?: AdapterStep[];
  readonly enabled?: boolean;
}
```

**Status**: Marked `@deprecated` in documentation comments (lines 302, 334, 744)
**Usage Count**: 44 files reference `Connection`, 46 files reference `Publisher`, 44 files reference `Listener`

**Removal Dependencies**:
1. All compiler passes must use edges exclusively
2. PatchStore must remove legacy arrays
3. Transaction system must use Edge type
4. Tests must migrate to Edge-based assertions

**Risk**: HIGH - These are foundational types used throughout codebase

---

### Category 2: Migration Helper Code (MEDIUM PRIORITY)

**Location**: `src/editor/edgeMigration.ts` (315 lines)

**Purpose**: Bidirectional conversion between Edge ↔ Connection/Publisher/Listener

**Functions**:
- `connectionToEdge()` - Convert Connection → Edge
- `publisherToEdge()` - Convert Publisher → Edge
- `listenerToEdge()` - Convert Listener → Edge
- `edgeToConnection()` - Convert Edge → Connection
- `edgeToPublisher()` - Convert Edge → Publisher
- `edgeToListener()` - Convert Edge → Listener
- `convertToEdges()` - Batch conversion to edges
- `convertFromEdges()` - Batch conversion from edges (lines 281-314)

**Evidence**: Full file at `src/editor/edgeMigration.ts`

**Current Usage**:
- `pass1-normalize.ts:40` - imports `convertFromEdges`
- `pass1-normalize.ts:112` - calls `convertFromEdges(patch.edges)`
- Tests in `__tests__/edgeMigration.test.ts`

**Removal Blocker**: Pass 1 still generates legacy arrays from edges for "passes that haven't migrated yet"

**Impact**: Once all passes use edges exclusively, this entire file can be deleted

**Risk**: LOW - Well-isolated module, easy to remove once dependencies eliminated

---

### Category 3: Dual-Path Execution in Compiler Passes (HIGH PRIORITY)

**Affected Files**:

#### Pass 1: Normalize (`src/editor/compiler/passes/pass1-normalize.ts`)

**Lines 99-122**: Dual format handling
```typescript
// For backward compatibility, we support both formats during migration
let connections: Connection[];
let publishers: Publisher[];
let listeners: Listener[];
let edges: Edge[] | undefined;

if (patch.edges !== undefined && patch.edges !== null && patch.edges.length > 0) {
  // New format: patch has unified edges array
  const canonical = canonicalizeEdges(patch.edges);
  edges = [...canonical];

  // Also convert to legacy format for passes that haven't migrated yet
  const converted = convertFromEdges(patch.edges);
  connections = converted.connections;
  publishers = converted.publishers;
  listeners = converted.listeners;
} else {
  // Legacy format: patch has separate arrays
  connections = patch.connections ?? [];
  publishers = patch.publishers ?? [];
  listeners = patch.listeners ?? [];
  edges = undefined;
}
```

**Lines 140-156**: Dual connectivity checks
```typescript
if (edges !== undefined && edges !== null) {
  // Use unified edges to check connectivity
  isConnected = hasEdgeToInput(edges, block.id, input.id);
} else {
  // Use legacy arrays to check connectivity
  const hasWire = connections.some(...);
  const hasListener = listeners.some(...);
  isConnected = hasWire || hasListener;
}
```

**Removal Plan**: Once all patches have edges array, remove legacy branch

---

#### Pass 2: Type Checking (`src/editor/compiler/passes/pass2-types.ts`)

**Line 13**: Comment indicates dual support
```
* Updated to use unified edges when available, with fallback to legacy arrays.
```

**Line 460**: Comment marks legacy code
```typescript
// Legacy wire format (backward compatibility)
```

**Evidence**: File uses both edges and connections arrays

---

#### Pass 7: Bus Lowering (`src/editor/compiler/passes/pass7-bus-lowering.ts`)

**Lines 14, 141**: Comments mark dual support

**Lines 164-177**: Dual publisher retrieval
```typescript
if (edges !== undefined && edges.length > 0) {
  // New unified edge format
  busPublishers = getPublishersFromEdges(bus.id, edges);
} else {
  // Legacy publisher format (backward compatibility)
  busPublishers = getSortedPublishers(bus.id, publishers as Publisher[], false);
}
```

**Lines 88-119**: `getPublishersFromEdges()` function duplicates logic from `getSortedPublishers()`

**Removal Plan**: Once edges are authoritative, delete legacy branch and `getPublishersFromEdges()` (use edges directly)

---

#### Pass 8: Link Resolution (`src/editor/compiler/passes/pass8-link-resolution.ts`)

**Lines 194, 271**: Comments note defaultSource fallback removed (already cleaned up!)
```typescript
// No need for defaultSource fallback - that's handled by Pass 0.
```

**Line 717**: Backward compatibility comment for non-IR types

---

### Category 4: Legacy Transform Storage (MEDIUM PRIORITY)

**Problem**: Edge interface uses separate `lensStack` and `adapterChain` fields instead of unified `transforms` array

**Current State** (`src/editor/types.ts:267-291`):
```typescript
export interface Edge {
  readonly id: string;
  readonly from: Endpoint;
  readonly to: Endpoint;

  /** @deprecated Use transforms instead */
  readonly lensStack?: LensInstance[];

  /** @deprecated Use adapterChain instead */
  readonly adapterChain?: AdapterStep[];

  readonly enabled: boolean;
  readonly weight?: number;
  readonly sortKey?: number;
}
```

**Target State** (from Phase 0 spec):
```typescript
export interface Edge {
  readonly id: string;
  readonly from: Endpoint;
  readonly to: Endpoint;
  readonly transforms?: TransformStep[];  // Unified transform array
  readonly enabled: boolean;
  readonly weight?: number;
  readonly sortKey?: number;
}
```

**TransformStep Type** (already exists in `src/editor/transforms/types.ts:27-29`):
```typescript
export type TransformStep =
  | { kind: 'adapter'; enabled: boolean; step: AdapterStep }
  | { kind: 'lens'; enabled: boolean; lens: LensInstance };
```

**Files Using lensStack/adapterChain**: 20 files (from grep results)

**Migration Path**:
1. Add optional `transforms?: TransformStep[]` field to Edge
2. Write converter: `(lensStack, adapterChain) → transforms`
3. Update all edge creation to populate transforms
4. Update compiler to read transforms instead of lensStack/adapterChain
5. Remove lensStack/adapterChain fields

**Risk**: MEDIUM - Requires serialization format change

---

### Category 5: Patch Interface Legacy Arrays (HIGH PRIORITY)

**Location**: `src/editor/types.ts:842-872`

**Current Patch Interface**:
```typescript
export interface Patch {
  readonly version: number;
  blocks: Block[];

  /** Unified edges (authoritative when present) */
  edges?: Edge[];

  /** @deprecated Use edges instead */
  connections: Connection[];

  buses: Bus[];

  /** @deprecated Use edges instead */
  publishers: Publisher[];

  /** @deprecated Use edges instead */
  listeners: Listener[];

  /** @deprecated Materialized at compile-time via Pass 0 */
  defaultSources: DefaultSourceState[];

  /** @deprecated Materialized at compile-time via Pass 0 */
  defaultSourceAttachments?: DefaultSourceAttachment[];

  // ... other fields
}
```

**Removal Targets**:
1. `connections: Connection[]` - Replaced by edges where `from.kind='port' && to.kind='port'`
2. `publishers: Publisher[]` - Replaced by edges where `from.kind='port' && to.kind='bus'`
3. `listeners: Listener[]` - Replaced by edges where `from.kind='bus' && to.kind='port'`
4. `defaultSources: DefaultSourceState[]` - Materialized by Pass 0
5. `defaultSourceAttachments?: DefaultSourceAttachment[]` - Materialized by Pass 0

**Current Status**:
- `edges` field is optional (`edges?: Edge[]`)
- Legacy arrays are still required (no `?` suffix)

**Target State**:
```typescript
export interface Patch {
  readonly version: number;
  blocks: Block[];
  edges: Edge[];  // Required, authoritative
  buses: Bus[];
  // connections, publishers, listeners, defaultSources REMOVED
}
```

**Blocker**: PatchStore still maintains all arrays, transaction system uses all types

---

### Category 6: PatchStore Legacy Arrays (HIGH PRIORITY)

**Location**: `src/editor/stores/PatchStore.ts`

**Lines 49-67**:
```typescript
export class PatchStore {
  blocks: Block[] = [];

  /**
   * Legacy connection array (deprecated).
   * @deprecated Use edges instead
   */
  connections: Connection[] = [];

  /**
   * Unified edge array (Sprint 1: Phase 0 Architecture Refactoring).
   */
  edges: Edge[] = [];

  // ...
}
```

**Lines 88-97**: MobX observables for both arrays
```typescript
makeObservable(this, {
  blocks: observable,
  connections: observable,  // Legacy
  edges: observable,        // New

  // Computed getters for edge filtering
  wireEdges: computed,
  publisherEdges: computed,
  listenerEdges: computed,
  // ...
});
```

**Methods maintaining dual state**:
- `addConnection()` / `addEdge()`
- `removeConnection()` / `removeEdge()`
- `updateConnection()` / `updateEdge()`

**Evidence**: PatchStore has parallel methods for legacy and new types

**Removal Plan**:
1. Migrate all UI components to use edges
2. Migrate transaction ops to use edges
3. Remove legacy methods
4. Remove `connections` observable

**Risk**: HIGH - Central data structure, affects all UI and transaction code

---

### Category 7: Registry Facades (LOW PRIORITY)

**Affected Files**:
- `src/editor/lenses/LensRegistry.ts`
- `src/editor/adapters/AdapterRegistry.ts`

**Current State**: Original registries still export their APIs

**Migration Files**:
- `src/editor/transforms/migrateLenses.ts` - Imports from LensRegistry, registers in TRANSFORM_REGISTRY
- `src/editor/transforms/migrateAdapters.ts` - Imports from AdapterRegistry, registers in TRANSFORM_REGISTRY

**Lines showing auto-migration**:
- `migrateLenses.ts:40` - "Auto-initialize lens migration"
- `migrateAdapters.ts:48` - "Auto-initialize adapter migration"

**Current Usage**:
- `src/editor/transforms/catalog.ts` imports both old registries
- `src/editor/compiler/ir/transforms.ts` imports LensRegistry
- `src/editor/lenses/lensInstances.ts` imports LensRegistry
- `src/editor/adapters/autoAdapter.ts` imports AdapterRegistry

**Sprint 4 Status** (from WORK-EVALUATION-sprint4-2026-01-01-042153.md):
- TransformRegistry created ✅
- All lenses migrated (~29) ✅
- All adapters migrated (~14) ✅
- **Compiler NOT using new registry** ❌

**Removal Blockers**:
1. Compiler passes still import from old registries
2. No facade pattern implemented yet (direct imports, not delegating)

**Removal Plan**:
1. Update compiler to use TRANSFORM_REGISTRY (Sprint 4 Deliverable 3 - incomplete)
2. Implement facade pattern (optional, for smooth migration)
3. Add deprecation warnings to old registry exports
4. Remove old registries after migration period

**Risk**: LOW - Well-isolated, TransformRegistry already working

---

### Category 8: Legacy Closure Types (SEPARATE TRACK - NOT PHASE 0)

**Location**: `src/editor/runtime/signal-expr/LegacyClosure.ts`

**Note**: This is V1→V2 migration infrastructure, NOT part of Phase 0 refactoring

**Types**:
- `LegacyClosure` - Function signature for V1 closures
- `LegacyContext` - Runtime context for legacy closures
- `createLegacyContext()` - Adapter from new to old context

**Purpose**: Bridge V1 closure-based blocks to V2 IR-based blocks during gradual migration

**Status**: TEMPORARY infrastructure for ongoing V2 migration (separate from Phase 0)

**Removal Timeline**: After all blocks migrate to V2 IR compilation (not in Phase 0.5 scope)

---

## Dependencies and Removal Sequence

### Dependency Graph

```
┌─────────────────────────────────────────────────────────┐
│ Category 5: Patch.edges required                        │
│ (Make edges array required, remove legacy arrays)       │
└───────────────┬─────────────────────────────────────────┘
                │
                ├──────────────────────────────────────────┐
                │                                          │
┌───────────────▼─────────────────┐    ┌─────────────────▼──────────────┐
│ Category 6: PatchStore cleanup  │    │ Category 3: Dual-path removal  │
│ (Remove connections observable) │    │ (Compiler passes edges-only)   │
└───────────────┬─────────────────┘    └─────────────────┬──────────────┘
                │                                          │
                │       ┌──────────────────────────────────┘
                │       │
┌───────────────▼───────▼─────────────┐
│ Category 2: Migration helpers       │
│ (Delete edgeMigration.ts)            │
└───────────────┬─────────────────────┘
                │
┌───────────────▼─────────────────────┐
│ Category 1: Deprecated types        │
│ (Remove Connection/Publisher/       │
│  Listener interfaces)                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ Category 4: Transform storage       │
│ (Add transforms field to Edge)      │
│ (PARALLEL TRACK - can start now)    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ Category 7: Registry facades        │
│ (Remove old registries)              │
│ (PARALLEL TRACK - Sprint 4 work)    │
└─────────────────────────────────────┘
```

### Critical Path (Must be sequential)

**Phase 1: Make edges authoritative** (1-2 weeks)
1. **REQUIRED FIRST**: Migrate all patches to have edges array populated
2. Update PatchStore to always populate edges when modifying connections
3. Update UI to create edges instead of connections/publishers/listeners
4. Add validation: warn if edges is empty when patch has connections

**Phase 2: Compiler edges-only** (1 week)
1. Update Pass 1 to use edges exclusively (remove lines 99-122 dual handling)
2. Update Pass 2 to use edges exclusively
3. Update Pass 7 to use edges exclusively (remove lines 164-177 dual handling)
4. Update Pass 8 verification
5. Remove `NormalizedPatch` connections/publishers/listeners fields

**Phase 3: Remove migration helpers** (1 day)
1. Verify no code imports from edgeMigration.ts (except tests)
2. Delete edgeMigration.ts
3. Delete __tests__/edgeMigration.test.ts

**Phase 4: Clean type definitions** (1 day)
1. Remove Connection interface from types.ts
2. Remove Publisher interface from types.ts
3. Remove Listener interface from types.ts
4. Fix any remaining compile errors
5. Remove legacy arrays from Patch interface

**Total Sequential Effort**: 2-3 weeks

### Parallel Tracks (Can happen anytime)

**Track A: Transform storage unification** (1 week)
1. Add `transforms?: TransformStep[]` to Edge interface
2. Write migration: `convertLegacyTransforms(lensStack, adapterChain) → TransformStep[]`
3. Update edge creation to populate transforms
4. Update compiler to read transforms field
5. Remove lensStack/adapterChain fields

**Track B: Registry cleanup** (2-3 days)
1. Complete Sprint 4 Deliverable 3: Update compiler to use TRANSFORM_REGISTRY
2. Update all imports to use TRANSFORM_REGISTRY
3. (Optional) Implement facade pattern in old registries
4. Remove old LensRegistry and AdapterRegistry files

---

## Ambiguities Found

| Area | Question | How LLM Might Guess | Impact |
|------|----------|---------------------|--------|
| Transform field naming | Should Edge use `transforms` or `transformStack`? | Might pick either arbitrarily | API inconsistency |
| Migration timeline | Should all 4 phases be done together or incrementally? | Might do all at once | Could break production patches mid-migration |
| Patch version bump | Should removing legacy arrays bump Patch.version? | Might forget to bump | Silent deserialization failures |
| Transaction ops | Do all transaction ops need updating for edges? | Might assume they auto-migrate | Broken undo/redo |
| Serialization format | Keep legacy arrays during save for compatibility? | Might keep forever "just in case" | Never clean up |

---

## Data Flow Verification

| Flow | Step | Expected | Actual | Status |
|------|------|----------|--------|--------|
| Edge creation | UI creates edge | Edge added to PatchStore.edges | ✅ Edge added, connections also updated | ⚠️ Dual write |
| Compilation | Pass 1 receives patch | Uses edges array | ✅ Uses edges when present, falls back to legacy | ⚠️ Dual path |
| Bus lowering | Pass 7 gets publishers | From edges array | ✅ From edges when present, falls back to legacy | ⚠️ Dual path |
| Transform application | Compiler applies lens | Reads from transforms field | ❌ Reads from lensStack/adapterChain | ❌ Old storage |
| Registry lookup | Compiler gets lens def | From TRANSFORM_REGISTRY | ❌ From old LensRegistry | ❌ Old registry |

---

## Recommendations

### HIGH PRIORITY (Block Future Work)

**1. Make edges required in Patch interface** (2-3 days)
- **Why**: Eliminates ambiguity, forces all code to use edges
- **Risk**: Breaking change for serialization
- **Mitigation**: Add migration on patch load, bump version number
- **Blocker for**: All other cleanup work

**2. Remove dual-path execution from compiler passes** (3-5 days)
- **Why**: Simplifies maintenance, removes 15% code overhead
- **Risk**: Medium - touches core compilation logic
- **Mitigation**: Comprehensive test coverage, incremental pass-by-pass migration
- **Blocked by**: Edges required in Patch

**3. Complete Sprint 4 Deliverable 3** (1-2 days)
- **Why**: TransformRegistry is ready but unused
- **Risk**: Low - isolated change
- **Mitigation**: Update compiler imports to TRANSFORM_REGISTRY
- **Independent**: Can start now

### MEDIUM PRIORITY (Tech Debt Reduction)

**4. Unify transform storage on Edge** (3-5 days)
- **Why**: Eliminates separate lensStack/adapterChain, cleaner API
- **Risk**: Medium - serialization format change
- **Mitigation**: Add transforms field, populate from legacy fields, gradually migrate
- **Independent**: Can start now

**5. Remove migration helper module** (1 day)
- **Why**: Dead code after edges become authoritative
- **Risk**: Low - well-isolated
- **Blocked by**: Compiler passes edges-only

### LOW PRIORITY (Optional Cleanup)

**6. Remove old LensRegistry/AdapterRegistry** (1-2 days)
- **Why**: Reduces confusion, enforces new registry
- **Risk**: Low - facades can maintain compatibility
- **Blocked by**: Sprint 4 Deliverable 3 complete

**7. Remove deprecated type definitions** (1 day)
- **Why**: Clean up type namespace
- **Risk**: Low - final step after all uses removed
- **Blocked by**: All above work complete

---

## Risks and Mitigations

### High-Risk Items

**1. Serialization format breaking changes**
- **Impact**: Saved patches won't load after cleanup
- **Mitigation**:
  - Bump Patch.version when removing legacy arrays
  - Add migration code to convert old → new format on load
  - Keep migration code for 2-3 releases before removal
  - Add validation warnings when loading old patches

**2. Transaction system breakage**
- **Impact**: Undo/redo fails after removing Connection/Publisher/Listener types
- **Mitigation**:
  - Audit all transaction ops in `src/editor/transactions/ops.ts`
  - Update ops to use Edge type
  - Add tests for undo/redo with edges
  - Verify kernel ops in `src/editor/kernel/ops.ts`

**3. Compiler regression during dual-path removal**
- **Impact**: Subtle bugs when removing fallback logic
- **Mitigation**:
  - Remove dual-path in one pass at a time
  - Run full test suite after each pass update
  - Add golden patch compilation test (edges-only)
  - Manual testing with Chrome DevTools MCP

### Medium-Risk Items

**1. UI component breakage**
- **Impact**: Inspector/canvas stops working after PatchStore changes
- **Mitigation**:
  - Audit all PatchStore consumers
  - Update components incrementally
  - Add UI tests for connection creation

**2. Transform migration data loss**
- **Impact**: Lens/adapter settings lost when migrating to transforms field
- **Mitigation**:
  - Write thorough converter with tests
  - Verify roundtrip: legacy → transforms → legacy
  - Keep legacy fields populated during migration period

### Low-Risk Items

**1. Registry facade removal**
- **Impact**: External code breaks if using old imports
- **Mitigation**: Deprecation warnings, facade pattern, gradual removal

---

## Break-It Testing Results

| Attack | Expected | Actual | Severity |
|--------|----------|--------|----------|
| Patch with edges=[] and connections=filled | Use edges (empty) | Falls back to connections | ⚠️ AMBIGUOUS |
| Patch with edges=filled and connections=[] | Use edges | Uses edges correctly | ✅ CORRECT |
| Edge with both lensStack and transforms | Error or use one | No transforms field yet | N/A |
| Compiler pass receives null edges | Use legacy arrays | Correctly falls back | ✅ SAFE |
| Remove Connection type while code uses it | TypeScript error | Would fail (not tested) | ✅ CORRECT |

**Finding**: The dual-path logic is **too forgiving** - empty edges array should be valid but currently falls back to legacy

**Recommendation**: Add explicit flag `edgesAuthoritative: boolean` during migration period

---

## Completion Gates

Before declaring Phase 0.5 complete:

**Minimum Viable Cleanup** (can ship):
- [ ] Edges array is authoritative in all compiler passes
- [ ] No dual-path execution in Pass 1, 2, 7, 8
- [ ] Sprint 4 Deliverable 3 complete (TRANSFORM_REGISTRY in use)
- [ ] Migration helpers can be safely removed (but kept for one release)

**Full Cleanup** (ideal state):
- [ ] Patch interface has no legacy arrays
- [ ] PatchStore has no legacy observables
- [ ] Connection/Publisher/Listener types removed
- [ ] edgeMigration.ts deleted
- [ ] LensRegistry/AdapterRegistry deleted
- [ ] Edge has transforms field (no lensStack/adapterChain)

**Version Bump Required**: Yes - removing legacy arrays from Patch is a breaking change

---

## Estimated Effort

| Phase | Effort | Risk | Dependencies |
|-------|--------|------|--------------|
| Phase 1: Edges authoritative | 1-2 weeks | HIGH | None |
| Phase 2: Compiler edges-only | 1 week | MEDIUM | Phase 1 |
| Phase 3: Remove migration helpers | 1 day | LOW | Phase 2 |
| Phase 4: Clean type definitions | 1 day | LOW | Phase 3 |
| **Sequential Total** | **2-3 weeks** | - | - |
| Track A: Transform unification | 1 week | MEDIUM | None |
| Track B: Registry cleanup | 2-3 days | LOW | Sprint 4 deliverable 3 |
| **Parallel Total** | **1-2 weeks** | - | - |

**Overall Cleanup Effort**: 3-5 weeks with parallel work

**Note**: This assumes dedicated focus. Interleaved with other work, could take 6-8 weeks.

---

## Verdict

**Phase 0.5 Status**: NOT STARTED (0% complete)
**Workflow**: **CONTINUE** - Clear removal targets identified, sequencing plan exists
**Critical Path**: Follow Phase 1 → 2 → 3 → 4 sequence
**Parallel Work**: Tracks A and B can start immediately
**Estimated Timeline**: 3-5 weeks for full cleanup

**Next Steps**:
1. **Decide on migration strategy**: Big-bang or incremental?
2. **Start Track B**: Complete Sprint 4 Deliverable 3 (TRANSFORM_REGISTRY in compiler)
3. **Start Phase 1**: Make edges authoritative (add migration on load)
4. **Write tests**: Golden patch compilation with edges-only
5. **Update transaction ops**: Support Edge type in undo/redo

**Blockers**: None - all Phase 0 work complete, cleanup can start
**Open Questions**: See "Ambiguities Found" section above

---

## Files Requiring Changes

### Phase 1: Edges Authoritative
- `src/editor/types.ts` - Make `edges: Edge[]` required, mark legacy arrays optional
- `src/editor/stores/PatchStore.ts` - Always populate edges
- `src/ui/components/**/*.tsx` - UI creates edges, not connections
- Migration utility to convert old patches on load

### Phase 2: Compiler Edges-Only
- `src/editor/compiler/passes/pass1-normalize.ts` - Remove lines 99-122, 140-156
- `src/editor/compiler/passes/pass2-types.ts` - Remove legacy wire format handling
- `src/editor/compiler/passes/pass7-bus-lowering.ts` - Remove lines 164-177, delete `getPublishersFromEdges()`
- `src/editor/compiler/passes/pass8-link-resolution.ts` - Verify no legacy paths remain
- `src/editor/compiler/ir/patches.ts` - Remove legacy arrays from NormalizedPatch

### Phase 3: Remove Migration Helpers
- `src/editor/edgeMigration.ts` - DELETE (315 lines)
- `src/editor/__tests__/edgeMigration.test.ts` - DELETE

### Phase 4: Clean Type Definitions
- `src/editor/types.ts` - Remove Connection (lines 744-779), Publisher (302-330), Listener (334-356)
- Fix all compile errors from type removal

### Track A: Transform Unification
- `src/editor/types.ts` - Add `transforms?: TransformStep[]` to Edge, deprecate lensStack/adapterChain
- `src/editor/transforms/migrate.ts` - NEW: Convert legacy → transforms
- Update all edge creation points
- Update compiler to read transforms

### Track B: Registry Cleanup
- `src/editor/compiler/passes/pass8-link-resolution.ts` - Use TRANSFORM_REGISTRY
- `src/editor/compiler/passes/pass6-block-lowering.ts` - Use TRANSFORM_REGISTRY
- Eventually delete: `src/editor/lenses/LensRegistry.ts`, `src/editor/adapters/AdapterRegistry.ts`

---

## Cached Knowledge Reused

From `.agent_planning/eval-cache/`:
- None directly applicable (Phase 0.5 is new work)

From Phase 0 documentation:
- STATUS-2025-12-31.md (Phase 0 completion status)
- WORK-EVALUATION-sprint4-2026-01-01-042153.md (Sprint 4 incomplete deliverable)

---

## Final Notes

**Why This Cleanup Matters**:
1. **Maintenance burden**: Dual-path code adds ~15-20% complexity overhead
2. **Bug surface**: Multiple sources of truth create inconsistency bugs
3. **Onboarding cost**: New developers must understand both systems
4. **Future work blocked**: Clean architecture enables Phase 6+ work

**Why Not Urgent**:
1. **System is functional**: Phase 0 works correctly with compatibility layers
2. **No performance impact**: Dual paths don't affect runtime performance
3. **Low bug risk**: Compatibility code is stable and well-tested

**Recommendation**: Proceed with cleanup in 2-3 week focused sprint, or incrementally over 6-8 weeks alongside other work.
