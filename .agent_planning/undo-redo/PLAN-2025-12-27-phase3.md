# Undo-Redo Phase 3: Complex Operations Migration
**Generated**: 2025-12-27-110000
**Source**: STATUS-2025-12-27-phase3.md
**Agent**: status-planner

---

## Executive Summary

**Phase 2 Achievement**: 15/22 methods migrated to runTx(), 87 tests passing (66 unit + 21 integration)

**Phase 3 Scope**: Migrate 8 remaining methods across 3 complexity tiers:
- **P0-Critical**: replaceBlock() (1 method, HIGH complexity) - currently broken with nested transaction bug
- **P0-High**: Lens operations (7 methods, MEDIUM complexity) - straightforward pattern application
- **P1-Medium**: addBlockAtIndex() (1 method, MEDIUM complexity) - atomicity improvement

**Total Gap**: Phase 3 completes core undo-redo for all user-facing operations except macro expansion and block positioning.

**Recommended Focus**:
1. Fix replaceBlock() nested transaction bug (blocks quick-swap workflow)
2. Enable lens editing undo (7 methods using consistent pattern)
3. Complete atomic addBlockAtIndex()
4. Remove suppressGraphCommitted pattern entirely

**Risk Assessment**:
- **replaceBlock()**: HIGH - complex coordination, event ordering constraints
- **Lens operations**: LOW - well-defined pattern, minimal dependencies
- **addBlockAtIndex()**: MEDIUM - requires lane transaction support

---

## Backlog by Priority

### P0 (Critical): replaceBlock() Migration

**Status**: Not Started (Currently BROKEN)
**Effort**: Large (3-5 days)
**Dependencies**: None (blocks other work)
**Spec Reference**: Design Docs - Block Quick-Swap • **Status Reference**: STATUS-2025-12-27-phase3.md lines 77-111

#### Description

Migrate replaceBlock() from direct mutations + suppressGraphCommitted to a single atomic transaction. Currently broken: nested transaction bug causes undo to leave orphaned new blocks.

**Current Issues** (from STATUS analysis):
1. **Double transaction problem**: removeBlock() now uses runTx(), but replaceBlock() doesn't wrap the full operation
   - Result: Undo of replaceBlock leaves orphaned new block in patch
2. **Mixed transaction modes**: Some sub-operations (addPublisher/addListener) use runTx, creating separate history entries
3. **Event ordering constraint**: BlockReplaced event must fire BEFORE removeBlock for selection UI to update correctly
4. **Direct mutations**:
   - Line 783: `this.blocks.push(newBlock)` - not transactional
   - Line 796: `lane.blockIds = [...]` - direct lane modification
   - createDefaultSourcesForBlock() not transaction-aware

**Migration Strategy**:
```typescript
runTx(this.root, { label: 'Replace Block' }, tx => {
  // 1. Add new block to blocks collection
  tx.add('blocks', newBlock);

  // 2. Update lane to insert new block at old block position
  const updatedLane = { ...lane };
  updatedLane.blockIds = [...lane.blockIds];
  updatedLane.blockIds.splice(oldIndex, 0, newBlockId);
  tx.replace('lanes', lane.id, updatedLane);

  // 3. Add preserved connections
  for (const preserved of mapping.preserved) {
    const conn = createConnection(fromId, preserved.fromSlot, toId, preserved.toSlot);
    tx.add('connections', conn);
  }

  // 4. Add bus publishers
  for (const newPub of compatiblePublishers) {
    tx.add('publishers', newPub);
  }

  // 5. Add bus listeners
  for (const newLis of compatibleListeners) {
    tx.add('listeners', newLis);
  }

  // 6. Remove old block cascade (connections, publishers, listeners, default sources)
  tx.removeBlockCascade(oldBlockId);
});
```

**Event Ordering Solution**:
- Emit BlockReplaced in post-commit hook or as part of GraphCommitted metadata
- Alternative: Pass oldBlockId/newBlockId in GraphCommitted event data for selection listeners

**Default Sources Handling**:
- createDefaultSourcesForBlock() needs transaction-aware variant OR
- Defer to post-commit callback (safe since defaults are recreated on undo anyway)

#### Acceptance Criteria (REQUIRED)

**Atomicity**:
- [ ] replaceBlock() wraps entire operation in single runTx() call
- [ ] Undo of replaceBlock fully restores old block with all connections
- [ ] Redo recreates new block with preserved connections
- [ ] No orphaned blocks left in patch after undo

**Connection Preservation**:
- [ ] Compatible connections preserved using tx.add('connections', ...)
- [ ] Dropped connections reported in result object
- [ ] Connection lens stacks preserved for compatible connections

**Bus Routing**:
- [ ] Old block's compatible publishers migrated to new block via tx.add('publishers', ...)
- [ ] Old block's compatible listeners migrated to new block via tx.add('listeners', ...)
- [ ] Incompatible bus routing removed via cascade

**Lane Management**:
- [ ] New block inserted at same lane position as old block using tx.replace('lanes', ...)
- [ ] Old block removed from lane via removeBlockCascade

**Event Integrity**:
- [ ] BlockReplaced event contains correct oldBlockId, newBlockId, preserved/dropped counts
- [ ] GraphCommitted emitted once per operation (not per sub-op)
- [ ] Selection UI updates correctly (BlockReplaced visible before old block gone)

**Cleanup**:
- [ ] suppressGraphCommitted parameter removed from connect() signature
- [ ] suppressGraphCommitted parameter removed from disconnect() signature
- [ ] suppressGraphCommitted logic deleted from lines 994, 1044 in PatchStore.ts
- [ ] All 4 suppress=true call sites removed (lines 804, 853, 912)

#### Technical Notes

**Cascade Logic**: tx.removeBlockCascade() must handle:
- All connections where block is from or to
- All publishers where block is source
- All listeners where block is destination
- Default sources owned by block
- Lane blockIds entry

**Testing Strategy**:
- Unit test: replaceBlock transaction creates correct ops sequence
- Integration test: undo/redo with connections preserved
- Integration test: undo/redo with bus routing preserved
- Integration test: undo/redo with incompatible dropped connections
- Manual test: quick-swap in live editor, undo, verify selection

**Risk Mitigation**:
- If event ordering proves complex, add BlockReplaced to GraphCommitted metadata
- If default sources complicate transaction, use post-commit hook

---

### P0 (High): updateConnection() Migration

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: Lens System Docs • **Status Reference**: STATUS-2025-12-27-phase3.md lines 159-178

#### Description

Migrate updateConnection() from direct array mutation to runTx() with tx.replace(). This is the foundation for all lens operation undo.

**Current Implementation** (lines 1088-1115):
- Direct mutation: `this.connections[index] = updated`
- Emits GraphCommitted manually

**Migration Pattern**:
```typescript
updateConnection(connectionId: string, updates: Partial<...>): void {
  const connection = this.connections.find(c => c.id === connectionId);
  if (!connection) return;

  const updated = { ...connection, ...updates };

  runTx(this.root, { label: 'Update Connection' }, tx => {
    tx.replace('connections', connectionId, updated);
  });
}
```

**Impact**: addLensToConnection, removeLensFromConnection, updateConnectionLens all call updateConnection, so they automatically become undoable.

#### Acceptance Criteria (REQUIRED)

- [ ] updateConnection() uses runTx() with tx.replace('connections', ...)
- [ ] Manual GraphCommitted emission removed (handled by runTx)
- [ ] Undo restores previous connection lensStack/adapterChain/enabled state
- [ ] Redo reapplies connection updates
- [ ] All 3 lens methods (add/remove/update) produce undoable operations

#### Technical Notes

**Simplicity**: This is the simplest migration in Phase 3. Should take <2 hours.

**Downstream Effect**: Once updateConnection uses runTx, the 3 lens helper methods (addLensToConnection, removeLensFromConnection, updateConnectionLens) automatically gain undo support with zero changes.

---

### P0 (High): BusStore Lens Operations Migration

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: None
**Spec Reference**: Bus Lens System • **Status Reference**: STATUS-2025-12-27-phase3.md lines 168-178

#### Description

Migrate 3 BusStore lens methods from direct listener array mutations to runTx() with tx.replace('listeners', ...).

**Methods to Migrate**:
1. **addLensToStack()** (lines 406-429): Inserts lens into listener.lensStack
2. **removeLensFromStack()** (lines 437-456): Removes lens from listener.lensStack
3. **clearLensStack()** (lines 463-474): Clears entire listener.lensStack

**Current Pattern** (all 3 methods):
```typescript
this.listeners[listenerIndex] = { ...existing, lensStack: newStack };
```

**Migration Pattern**:
```typescript
runTx(this.root, { label: 'Add Lens to Stack' }, tx => {
  const updated = { ...existing, lensStack: newStack };
  tx.replace('listeners', listenerId, updated);
});
```

**Key Difference from PatchStore**:
- BusStore works with listeners array (indexed access)
- Must use tx.replace('listeners', listenerId, ...) NOT index-based

#### Acceptance Criteria (REQUIRED)

**addLensToStack()**:
- [ ] Uses runTx() with tx.replace('listeners', listenerId, ...)
- [ ] Undo removes added lens from stack
- [ ] Redo re-adds lens at correct index
- [ ] createLensInstanceFromDefinition() integration preserved

**removeLensFromStack()**:
- [ ] Uses runTx() with tx.replace('listeners', listenerId, ...)
- [ ] Undo restores removed lens with original params
- [ ] Redo removes lens again
- [ ] sortKey recalculation works correctly

**clearLensStack()**:
- [ ] Uses runTx() with tx.replace('listeners', listenerId, ...)
- [ ] Undo restores entire previous stack (all lenses, order, params)
- [ ] Redo clears stack again

**Error Handling**:
- [ ] "Listener not found" errors still thrown before runTx
- [ ] "Invalid lens index" errors still thrown before runTx

#### Technical Notes

**Testing Strategy**:
- Unit tests: Each method produces correct tx.replace op
- Integration tests: Undo/redo for each method
- Integration test: Undo after multiple lens stack operations (add, remove, update)

**Lens Instance Creation**: createLensInstanceFromDefinition() creates default sources - may need transaction awareness in future, but safe to defer (re-created on undo).

---

### P1 (Medium): addBlockAtIndex() Atomicity

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: Lane transaction support
**Spec Reference**: Block Creation Workflow • **Status Reference**: STATUS-2025-12-27-phase3.md lines 140-154

#### Description

Migrate addBlockAtIndex() to use runTx() for atomic block addition with lane assignment. Currently uses direct push + lane mutation + auto-bus connections (which call runTx, creating nested transactions).

**Current Issues** (lines 396-470):
- Line 429: `this.blocks.push(block)` - direct mutation
- Line 444: `lane.blockIds = [...]` - direct lane mutation
- processAutoBusConnections() calls addPublisher/addListener (which use runTx - nested!)
- createDefaultSourcesForBlock() not transaction-aware

**Migration Strategy**:
```typescript
runTx(this.root, { label: 'Add Block at Index' }, tx => {
  // 1. Add block to collection
  tx.add('blocks', block);

  // 2. Update lane to insert block at specified index
  const updatedLane = { ...lane };
  updatedLane.blockIds = [...lane.blockIds];
  updatedLane.blockIds.splice(laneIndex, 0, block.id);
  tx.replace('lanes', lane.id, updatedLane);

  // 3. Add auto-bus connections
  for (const autoPub of autoPublishers) {
    tx.add('publishers', autoPub);
  }
  for (const autoLis of autoListeners) {
    tx.add('listeners', autoLis);
  }
});
```

**Auto-Bus Connection Logic**: Extract from processAutoBusConnections into pure function that returns arrays of publishers/listeners to create.

#### Acceptance Criteria (REQUIRED)

**Atomicity**:
- [ ] addBlockAtIndex() wraps all mutations in single runTx()
- [ ] Undo removes block from both blocks collection and lane
- [ ] Redo adds block back at same lane index

**Lane Integration**:
- [ ] Block inserted at specified lane index using tx.replace('lanes', ...)
- [ ] Lane blockIds updated atomically with block creation

**Auto-Bus Connections**:
- [ ] Auto-connected publishers added via tx.add('publishers', ...) in same transaction
- [ ] Auto-connected listeners added via tx.add('listeners', ...) in same transaction
- [ ] Undo removes auto-connections

**Default Sources**:
- [ ] createDefaultSourcesForBlock() called (transaction awareness deferred)
- [ ] Default sources recreated on redo

**Event Emission**:
- [ ] Single GraphCommitted event emitted (not one per auto-connection)
- [ ] BlockAdded event still emitted with correct metadata

#### Technical Notes

**Refactoring Need**: processAutoBusConnections() currently calls store methods. Extract to pure function:
```typescript
function computeAutoBusConnections(
  block: Block,
  buses: Bus[],
  existingPublishers: Publisher[],
  existingListeners: Listener[]
): { publishers: Publisher[], listeners: Listener[] }
```

**Testing Strategy**:
- Unit test: addBlockAtIndex transaction ops sequence
- Integration test: undo/redo with lane position preserved
- Integration test: undo/redo with auto-bus connections
- Manual test: Add block in middle of lane, undo, verify position

---

## Dependency Graph

```
Phase 3 Dependencies:

replaceBlock()
  └─> (independent - no deps, blocks other work)

updateConnection()
  └─> (independent - enables lens operations automatically)
      ├─> addLensToConnection (auto-enabled)
      ├─> removeLensFromConnection (auto-enabled)
      └─> updateConnectionLens (auto-enabled)

BusStore Lens Operations
  ├─> addLensToStack (independent)
  ├─> removeLensFromStack (independent)
  └─> clearLensStack (independent)

addBlockAtIndex()
  └─> (requires lane transaction support - same as replaceBlock)

Cleanup (after replaceBlock):
  └─> Remove suppressGraphCommitted from connect/disconnect
```

**Recommended Order**:
1. updateConnection() (1 day, enables 3 lens methods)
2. BusStore lens operations (2-3 days, parallel with replaceBlock)
3. replaceBlock() (3-5 days, most complex)
4. addBlockAtIndex() (2-3 days, uses patterns from replaceBlock)

**Parallel Work Opportunities**:
- updateConnection + BusStore lens ops can be done in parallel
- replaceBlock + BusStore lens ops can be done in parallel
- addBlockAtIndex should wait for replaceBlock (similar lane tx pattern)

---

## Recommended Sprint Planning

### Sprint 1: Foundation + Lens Operations (5-7 days)

**Goal**: Enable undo for all lens editing workflows

**Deliverables**:
1. updateConnection() migration (1 day)
   - Acceptance: 3 lens methods auto-enabled
2. BusStore lens operations (2-3 days)
   - Acceptance: All 3 methods undoable
3. Integration tests for lens operations (1-2 days)
   - Acceptance: 10+ tests passing

**Definition of Done**:
- [ ] updateConnection() uses runTx()
- [ ] All 6 lens methods (3 PatchStore + 3 BusStore) undoable
- [ ] 10+ integration tests passing
- [ ] Manual test: Lens editor undo/redo works in live editor

---

### Sprint 2: Complex Operations (6-8 days)

**Goal**: Fix replaceBlock nested transaction bug, complete atomic block operations

**Deliverables**:
1. replaceBlock() migration (3-5 days)
   - Acceptance: Single atomic transaction, no orphaned blocks
2. addBlockAtIndex() migration (2-3 days)
   - Acceptance: Atomic lane insertion
3. suppressGraphCommitted cleanup (1 day)
   - Acceptance: Pattern completely removed
4. Integration tests (1-2 days)
   - Acceptance: 15+ new tests

**Definition of Done**:
- [ ] replaceBlock() atomic transaction
- [ ] addBlockAtIndex() atomic transaction
- [ ] suppressGraphCommitted pattern removed entirely
- [ ] 15+ integration tests passing
- [ ] Manual test: Quick-swap undo/redo works in live editor

---

## Test Coverage Plan

### Unit Tests (15+ new tests)

**replaceBlock()**:
- [ ] Transaction creates correct op sequence (add block, update lane, add connections, remove old)
- [ ] Compatible connections identified correctly
- [ ] Dropped connections reported in result
- [ ] Bus publishers migrated for compatible slots
- [ ] Bus listeners migrated for compatible slots

**updateConnection()**:
- [ ] Transaction creates tx.replace('connections', ...) op
- [ ] Partial updates merged correctly

**BusStore Lens Operations**:
- [ ] addLensToStack creates tx.replace('listeners', ...) op
- [ ] removeLensFromStack creates tx.replace('listeners', ...) op
- [ ] clearLensStack creates tx.replace('listeners', ...) op

**addBlockAtIndex()**:
- [ ] Transaction creates correct op sequence (add block, update lane, add auto-connections)
- [ ] Auto-bus connections computed correctly

---

### Integration Tests (20+ new tests)

**replaceBlock() Undo/Redo**:
- [ ] Undo restores old block with all connections intact
- [ ] Redo creates new block with preserved connections
- [ ] Undo restores old block's bus publishers
- [ ] Undo restores old block's bus listeners
- [ ] Dropped connections not restored on undo
- [ ] Lane position preserved through undo/redo

**Connection Lens Operations**:
- [ ] addLensToConnection -> undo removes lens
- [ ] removeLensFromConnection -> undo restores lens with params
- [ ] updateConnectionLens -> undo restores original params
- [ ] Multiple lens ops -> undo each in reverse order

**Bus Listener Lens Operations**:
- [ ] addLensToStack -> undo removes lens
- [ ] removeLensFromStack -> undo restores lens
- [ ] clearLensStack -> undo restores entire stack (3+ lenses)
- [ ] Lens stack order preserved through undo/redo

**addBlockAtIndex() Undo/Redo**:
- [ ] Undo removes block from collection and lane
- [ ] Redo adds block back at same lane index
- [ ] Auto-bus connections removed on undo
- [ ] Auto-bus connections restored on redo

**Edge Cases**:
- [ ] replaceBlock with no compatible connections
- [ ] replaceBlock with mixed compatible/incompatible
- [ ] Lens operations on connection with no existing stack
- [ ] addBlockAtIndex at lane start (index 0)
- [ ] addBlockAtIndex at lane end (index = length)

---

## Manual Testing Checklist

**Pre-Phase 3** (verify Phase 2 still works):
- [ ] Add block -> undo -> block removed
- [ ] Remove block -> undo -> block restored with connections
- [ ] Connect -> undo -> connection removed
- [ ] Disconnect -> undo -> connection restored

**Post-Sprint 1** (lens operations):
- [ ] Open lens editor for connection
- [ ] Add lens (e.g., Scale) -> undo -> lens removed
- [ ] Remove lens -> undo -> lens restored with params
- [ ] Edit lens params -> undo -> params restored
- [ ] Open listener lens editor -> add lens -> undo

**Post-Sprint 2** (complex operations):
- [ ] Quick-swap block (right-click -> Replace With) -> undo -> original block restored
- [ ] Quick-swap with connections -> undo -> connections restored
- [ ] Quick-swap with bus routing -> undo -> routing restored
- [ ] Add block in middle of lane -> undo -> block removed, lane intact
- [ ] Verify no suppressGraphCommitted in codebase (grep)

---

## Risk Assessment

### High Risk: replaceBlock() Event Ordering

**Issue**: BlockReplaced event must fire BEFORE removeBlock for selection UI to update correctly.

**Mitigation**:
1. Option A: Emit BlockReplaced in post-commit hook with oldBlockId/newBlockId
2. Option B: Pass replacement metadata in GraphCommitted event data
3. Option C: Have selection listener subscribe to GraphCommitted and infer replacement

**Recommendation**: Option A (cleanest separation of concerns)

**Verification**: Manual test in live editor - verify selection updates correctly during quick-swap

---

### Medium Risk: Default Source Transaction Awareness

**Issue**: createDefaultSourcesForBlock() directly mutates default sources, not transaction-aware.

**Mitigation**:
1. Short-term: Call in post-commit hook (safe - recreated on undo anyway)
2. Long-term: Make DefaultSourceStore transaction-aware (Phase 4+)

**Recommendation**: Use post-commit for Phase 3, defer full tx support to Phase 4

**Verification**: Integration tests verify default sources exist after redo

---

### Medium Risk: Lane Transaction Support

**Issue**: ViewStateStore.lanes not yet in transaction system (needed for replaceBlock, addBlockAtIndex).

**Mitigation**:
1. Add 'lanes' collection to transaction system
2. Implement tx.replace('lanes', laneId, updatedLane)
3. Add applyReplaceLane to applyOps.ts

**Recommendation**: Add as part of replaceBlock() work (required dependency)

**Verification**: Unit tests for lane replace ops

---

### Low Risk: Nested Transaction Detection

**Issue**: If runTx-aware method called inside replaceBlock before migration, creates nested transactions.

**Mitigation**: Already identified in STATUS - migrate replaceBlock to NOT call runTx methods, use tx.add directly.

**Verification**: Unit tests verify single transaction created, no nested entries

---

## Deferred to Phase 4+

| Item | Complexity | Reason |
|------|------------|--------|
| expandMacro() | VERY HIGH | Needs clearPatch atomicity decision (architectural question) |
| Block positions (ViewStateStore) | MEDIUM | Needs gesture buffer design (separate feature) |
| Gesture buffer | MEDIUM | Needed for smooth drag undo (avoid 100s of steps) |
| IndexedDB persistence | LOW | Nice-to-have, not blocking core undo |
| History map view | LOW | Nice-to-have UI enhancement |
| Variations chooser | LOW | Nice-to-have UI enhancement |

**Architectural Question for expandMacro()**:
- Should macro expansion be undoable as atomic operation?
- If yes: Need to make clearPatch() transaction-aware (affects entire patch state)
- If no: Mark expandMacro as "checkpoint" operation (cannot undo past it)
- **Recommendation**: Defer to Phase 4, discuss with user

---

## Blockers and Questions

**None identified**. STATUS report is comprehensive, all gaps are clear, implementation patterns are well-established from Phase 2.

**If blockers arise during implementation**:
1. Lane transaction support not working -> Add lanes collection to tx system
2. Event ordering proves complex -> Use post-commit hooks
3. Default sources cause issues -> Move to post-commit callback

---

## Success Metrics

**Phase 3 Complete When**:
- [ ] 8/8 methods migrated to runTx()
- [ ] replaceBlock() undo leaves no orphaned blocks
- [ ] All lens operations undoable
- [ ] suppressGraphCommitted pattern removed (0 occurrences in codebase)
- [ ] 35+ new tests passing (15 unit + 20 integration)
- [ ] Manual testing confirms all workflows undoable
- [ ] Methods Migrated: 23/22 (Phase 2: 15, Phase 3: 8)

**Phase 3 DOD** (from STATUS):
- [ ] replaceBlock() uses single runTx() - atomic undo
- [ ] suppressGraphCommitted removed from connect/disconnect
- [ ] updateConnection() uses runTx()
- [ ] All lens operations undoable via updateConnection/updateListener
- [ ] addBlockAtIndex() uses runTx() with lane assignment
- [ ] 20+ new integration tests
- [ ] Manual testing confirms undo works for all migrated operations

---

## Provenance

- **Source Evaluation**: STATUS-2025-12-27-phase3.md
- **Agent**: status-planner
- **Generated**: 2025-12-27-110000
- **Git Commit**: f4cb96f (Value Slots)
- **Phase**: 3 of 4+ (Core Operations Complete)
