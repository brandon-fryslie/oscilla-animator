# Definition of Done: Phases C+D - Instances2D and Paths2D Runtime
**Generated:** 2025-12-26-173641
**Plan:** PLAN-PHASE-CD-2025-12-26-173641.md
**Sprint Scope:** 4 sprints (2 for Phase C, 2 for Phase D)

---

## Acceptance Criteria

### Phase C: Instances2D Runtime

#### Deliverable C1: MaterializeColor Scheduled Step

**P0.C1: Implement MaterializeColor Step Executor**
- [ ] `executeMaterializeColor.ts` created in `src/editor/runtime/executor/steps/`
- [ ] Handles signal&lt;color&gt; (single value) and field&lt;color&gt; (instanceCount values)
- [ ] Calls `quantizeColorRGBA()` for signal, `quantizeColorRGBABatch()` for field
- [ ] Writes Uint8Array to bufferSlot in ValueStore
- [ ] Emits performance counters: cpuMs, bytesWritten, sourceEvalMs
- [ ] Unit test: signal&lt;color&gt; → u8x4 buffer produces correct bytes
- [ ] Unit test: field&lt;color&gt; with 100 instances → u8x4 buffer (400 bytes)

**P0.C2: Define StepMaterializeColor IR Type**
- [ ] `StepMaterializeColor` interface defined in `src/editor/compiler/ir/schedule.ts`
- [ ] Fields: `kind: "materializeColor"`, `sourceSlot`, `bufferSlot`, `instanceCount?`, `bufferDesc: ColorBufferDesc`
- [ ] Added to `StepIR` union type
- [ ] ScheduleExecutor dispatch handles "materializeColor" case
- [ ] TypeScript compilation passes
- [ ] Unit test: StepMaterializeColor type guards work

#### Deliverable C2: InstanceBufferSetIR Assembly

**P0.C3: Implement InstanceBufferSetIR Assembly**
- [ ] Function `assembleInstanceBuffers()` created in runtime executor
- [ ] Handles required buffer: posXY (Float32Array, length=count*2)
- [ ] Handles optional buffers: size, rot, colorRGBA, opacity (BufferRefIR or ScalarF32IR/ScalarU32IR)
- [ ] Allocates dense bufferIds from ValueStore
- [ ] Produces BufferRefIR with correct type ("f32", "u32", etc.) and length
- [ ] Unit test: 10 instances with posXY, size, colorRGBA → valid InstanceBufferSetIR
- [ ] Unit test: Scalar broadcast (all instances same size) → ScalarF32IR, no buffer allocation
- [ ] E2E test: Materialize colors → assemble instance buffers → read buffers from ValueStore

#### Deliverable C3: Instances2D Rendering

**P0.C4: Extend Canvas Renderer for Instances2DPassIR**
- [ ] `renderInstances2DPass()` function created in Canvas renderer
- [ ] Reads buffers from ValueStore via BufferRefIR
- [ ] Handles scalar broadcasts (ScalarF32IR/ScalarU32IR) as constant values
- [ ] Draws shape2d material: circles, squares, stars (shapeId selection)
- [ ] Applies per-instance posXY, size, rot, colorRGBA from buffers
- [ ] Respects RenderPassHeaderIR: z-order, clip, view transform, blend
- [ ] Unit test: Mock Instances2DPassIR with 5 circles → 5 Canvas arc() calls
- [ ] E2E test: Compile simple patch → RenderFrameIR → Canvas draws correctly
- [ ] Visual smoke test: 1000 circles with random colors render at 60fps

#### Deliverable C4: Instance Sorting Infrastructure

**P1.C5: Implement Instance Sorting**
- [ ] `sortInstances()` function created in runtime executor
- [ ] Handles InstanceSortIR.kind="byKey" with Float32 sort key buffer
- [ ] Sorts indices (not buffers) to preserve buffer stability
- [ ] Order: "asc" or "desc" as specified
- [ ] Stable sort (deterministic for equal keys)
- [ ] Canvas renderer draws in sorted order
- [ ] Unit test: 10 instances with random keys → sorted draw order
- [ ] E2E test: Overlapping semi-transparent circles sort correctly by z-key

**P1.C6: End-to-End Instances2D Pipeline Test**
- [ ] E2E test: Simple patch with Instances2D block compiles to RenderFrameIR
- [ ] Test verifies: ScheduleIR includes materializeColor, renderAssemble steps
- [ ] Test verifies: RenderFrameIR contains Instances2DPassIR with correct buffers
- [ ] Test verifies: Canvas renderer draws instances correctly
- [ ] Visual smoke test: 1000 circles with gradient colors, rotation, varying sizes
- [ ] Performance check: 1000 instances render in <16ms (60fps)
- [ ] Determinism check: Same patch → identical RenderFrameIR on repeat compile

---

### Phase D: Paths2D Runtime

#### Deliverable D1: MaterializePath Scheduled Step

**P0.D1: Implement MaterializePath Step Executor**
- [ ] `executeMaterializePath.ts` created in `src/editor/runtime/executor/steps/`
- [ ] Handles path expressions with curves (MoveTo, LineTo, QuadTo, CubicTo, Close)
- [ ] Encodes commands to Uint16Array with canonical opcodes (0=M, 1=L, 2=Q, 3=C, 4=Z)
- [ ] Packs control points to Float32Array (interleaved xy pairs)
- [ ] Writes commandsSlot (Uint16Array) and pointsSlot (Float32Array) to ValueStore
- [ ] FlattenPolicy.off: Preserves curves (default)
- [ ] FlattenPolicy.on: Flattens curves to polylines with CANONICAL_FLATTEN_TOL_PX
- [ ] Emits performance counters: cpuMs, bytesCommands, bytesPoints, flattenedSegments
- [ ] Unit test: Simple path (M, L, L, Z) → correct command/point buffers
- [ ] Unit test: Path with quad curve → Q command consumes 2 points
- [ ] Unit test: Path with cubic curve → C command consumes 3 points

**P0.D2: Define StepMaterializePath IR Type**
- [ ] `StepMaterializePath` interface defined in `src/editor/compiler/ir/schedule.ts`
- [ ] Fields: `kind: "materializePath"`, `sourceSlot`, `commandsSlot`, `pointsSlot`, `flattenPolicy`, `commandDesc`
- [ ] Added to `StepIR` union type
- [ ] ScheduleExecutor dispatch handles "materializePath" case
- [ ] TypeScript compilation passes
- [ ] Unit test: StepMaterializePath type guards work

#### Deliverable D2: PathGeometryBufferIR Assembly

**P0.D3: Implement PathGeometryBufferIR Assembly**
- [ ] Function `assemblePathGeometry()` created in runtime executor
- [ ] Handles multiple paths (pathCount > 1)
- [ ] Generates pathCommandStart, pathCommandLen arrays (Uint32Array, length=pathCount)
- [ ] Generates pathPointStart, pathPointLen arrays (Uint32Array, length=pathCount)
- [ ] Concatenates all path commands into single Uint16Array
- [ ] Concatenates all path points into single Float32Array
- [ ] Produces PathGeometryBufferIR with correct BufferRefIR references
- [ ] Unit test: 2 simple paths → correct indexing (path 0: cmd[0..2], path 1: cmd[3..5])
- [ ] Unit test: Path with no commands (empty) → zero-length slice
- [ ] E2E test: Materialize 3 paths → assemble geometry → read buffers from ValueStore

#### Deliverable D3: Paths2D Rendering

**P0.D4: Extend Canvas Renderer for Paths2DPassIR**
- [ ] `renderPaths2DPass()` function created in Canvas renderer
- [ ] Reads command/point buffers from ValueStore via BufferRefIR
- [ ] Decodes u16 commands to Canvas path operations (moveTo, lineTo, quadraticCurveTo, bezierCurveTo, closePath)
- [ ] Applies PathStyleIR: fill (fillStyle, fillRule), stroke (strokeStyle, lineWidth, lineCap, lineJoin, dash)
- [ ] Handles per-path or global styling (scalar vs buffer)
- [ ] Respects RenderPassHeaderIR: z-order, clip, view transform, blend
- [ ] Unit test: Mock Paths2DPassIR with simple path → Canvas moveTo/lineTo calls
- [ ] E2E test: Compile path block → RenderFrameIR → Canvas draws correctly
- [ ] Visual smoke test: Simple path with quad and cubic curves renders accurately

#### Deliverable D4: Path Flattening Infrastructure (Optional)

**P1.D5: Implement Path Flattening Kernel (Optional)**
- [ ] `flattenPathKernel()` function created in `src/editor/runtime/kernels/`
- [ ] Accepts path with curves (Q, C commands)
- [ ] Outputs flattened path (M, L, Z commands only)
- [ ] Tolerance: CANONICAL_FLATTEN_TOL_PX (0.75px in screen space)
- [ ] Uses adaptive subdivision (recursive midpoint or de Casteljau)
- [ ] Produces deterministic output (same curve → same polyline)
- [ ] Unit test: Quad curve → polyline with max deviation <0.75px
- [ ] Unit test: Cubic curve → polyline with max deviation <0.75px
- [ ] Unit test: Straight line (L) → unchanged (no subdivision)

**P1.D6: End-to-End Paths2D Pipeline Test**
- [ ] E2E test: Simple patch with path block compiles to RenderFrameIR
- [ ] Test verifies: ScheduleIR includes materializePath, renderAssemble steps
- [ ] Test verifies: RenderFrameIR contains Paths2DPassIR with correct geometry
- [ ] Test verifies: Canvas renderer draws paths correctly
- [ ] Visual smoke test: Path with M, L, Q, C commands renders accurately
- [ ] Visual smoke test: Multiple paths with different fill/stroke styles
- [ ] Determinism check: Same patch → identical PathGeometryBufferIR on repeat compile

---

### Integration Work Items (Shared Between C and D)

**P0.I1: Extend ScheduleExecutor Dispatch**
- [ ] ScheduleExecutor switch statement handles "materializeColor" case
- [ ] ScheduleExecutor switch statement handles "materializePath" case
- [ ] Both cases call correct executor functions
- [ ] Performance counters collected and reported
- [ ] Unit test: Schedule with materializeColor step executes correctly
- [ ] Unit test: Schedule with materializePath step executes correctly

**P0.I2: Implement executeRenderAssemble for RenderFrameIR**
- [ ] `executeRenderAssemble()` in `steps/executeRenderAssemble.ts` assembles RenderFrameIR
- [ ] Creates RenderPassHeaderIR for each pass (z, enabled, clip, view, blend)
- [ ] Assembles Instances2DPassIR from instance buffer sets
- [ ] Assembles Paths2DPassIR from path geometry buffers
- [ ] Writes RenderFrameIR to output slot in ValueStore
- [ ] Handles ClearSpecIR (color or none)
- [ ] Handles optional overlays (future work, stubbed)
- [ ] Unit test: Assemble RenderFrameIR with 1 Instances2D pass
- [ ] Unit test: Assemble RenderFrameIR with 1 Paths2D pass
- [ ] Unit test: Assemble RenderFrameIR with mixed passes (Instances2D + Paths2D)

**P1.I3: Dual-Emit Pattern for Migration Safety**
- [ ] Feature flag: `USE_RENDER_FRAME_IR` (default false for safety)
- [ ] When true: emit RenderFrameIR path
- [ ] When false: emit legacy RenderCmd path
- [ ] Both paths can coexist in same build
- [ ] Runtime switches based on flag
- [ ] Unit test: Flag=true → RenderFrameIR path used
- [ ] Unit test: Flag=false → legacy path used
- [ ] Visual regression: Both paths produce identical output for simple patches

---

## Sprint Scope

### Sprint 1-2 (Phase C): Instances2D
**Delivers:**
- MaterializeColor step executor and IR type
- InstanceBufferSetIR assembly logic
- Canvas renderer Instances2DPassIR support
- Instance sorting infrastructure
- E2E pipeline test with 1000 circles

**Deferred:**
- Path rendering (Phase D)
- Caching (Phase E)
- Performance optimization (Phase F)

### Sprint 3-4 (Phase D): Paths2D
**Delivers:**
- MaterializePath step executor and IR type
- PathGeometryBufferIR assembly logic
- Canvas renderer Paths2DPassIR support
- Optional path flattening kernel
- E2E pipeline test with curves

**Deferred:**
- Caching (Phase E)
- Full Canvas renderer rewrite (Phase F)
- 3D support (Phases G-H)

---

## Success Metrics

**Functional (REQUIRED):**
- [ ] Instances2D: 1000 circles render correctly via RenderFrameIR
- [ ] Paths2D: Path with curves renders correctly via RenderFrameIR
- [ ] MaterializeColor step executes and produces u8x4 buffers
- [ ] MaterializePath step executes and produces command/point buffers
- [ ] Canvas renderer consumes both pass types
- [ ] ScheduleExecutor integrates new step types cleanly

**Performance (REQUIRED):**
- [ ] Instances2D: ≥90% of legacy RenderCmd performance
- [ ] Color quantization: <1ms for 1000 instances
- [ ] Path encoding: <5ms for 1000-point path
- [ ] Visual smoke tests render at 60fps

**Quality (REQUIRED):**
- [ ] All unit tests pass
- [ ] Visual smoke tests pass
- [ ] Zero TypeScript errors
- [ ] Deterministic output (same patch → same buffers)

---

## Verification Commands

```bash
# Phase C
just test:instances2d        # Unit tests for instance pipeline
just smoke:instances2d       # Visual smoke test: 1000 circles
just bench:instances2d       # Performance: instances2d vs legacy

# Phase D
just test:paths2d            # Unit tests for path pipeline
just smoke:paths2d           # Visual smoke test: path with curves
just test:path-flatten       # Path flattening correctness

# Integration
just test:render-ir          # Combined Instances2D + Paths2D tests
just smoke:render-ir         # Visual: mixed passes render correctly

# Persistent
just check                   # Typecheck + lint + test (must pass)
just test:field              # Field materialization (dependency)
just test:signal             # Signal evaluation (dependency)
```
