# Sprint Plan: Wire Lens Support
**Generated**: 2025-12-26-102411
**Source**: STATUS-2025-12-26.md
**Topic**: wire-lenses

---

## Executive Summary

**Current State**: Wire connections (block-to-block) lack lens and adapter support, creating an inconsistent user experience where transformations are available on bus connections but not on direct wires.

**Goal**: Enable lenses on wire connections to achieve feature parity with bus listeners, allowing users to apply transformations (scale, clamp, ease, etc.) on any connection type.

**Sprint Scope** (2-3 deliverables):
1. **Core Capability**: Add lensStack/adapterChain fields to Connection interface and implement compiler support
2. **Store Operations**: Add PatchStore methods for lens/adapter management on wires
3. **Basic UI**: Add lens section to WireConnectionView in ConnectionInspector

**Deferred to Future Sprints**:
- LensChainEditor component (shared across all connection types) - use placeholder/badge for now
- Publisher lens UI (publishers have lensStack in types but no UI)
- Advanced lens reordering and parameter binding UI

**Complexity**: MEDIUM
- Type system: LOW (optional fields, backward compatible)
- Compiler: MEDIUM (reuse existing lens infrastructure)
- UI: LOW (reuse ListenerConnectionView pattern)

---

## Design Decisions

### D1: Lens Scope for Wires
**Decision**: Treat wires as 'listener' scope equivalent
**Rationale**: Wires consume values (like listeners). Most lenses specify `allowedScopes: ['publisher', 'listener']`. No lens definition changes needed.
**Status Reference**: STATUS-2025-12-26.md section 4.1

### D2: Adapter Support
**Decision**: Include adapters on wires for consistency
**Rationale**: Adapters handle type conversions. Full parity with bus connections provides uniform capabilities.
**Status Reference**: STATUS-2025-12-26.md section 4.2

### D3: UI Strategy
**Decision**: Use lens badge placeholder (same as current ListenerConnectionView)
**Rationale**: LensChainEditor is a separate deliverable benefiting all connection types. Don't block wire lenses on it.
**Status Reference**: STATUS-2025-12-26.md section 1.6

---

## P0 (Critical): Type System Foundation

### P0-1: Extend Connection Interface with Lens/Adapter Fields

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None
**Spec Reference**: Core Concepts (type hierarchy) • **Status Reference**: STATUS-2025-12-26.md section 2.1

#### Description
Add optional `lensStack` and `adapterChain` fields to the `Connection` interface in `src/editor/types.ts`. These fields make wires first-class transformation participants.

#### Acceptance Criteria (REQUIRED)
- [ ] Connection interface includes `readonly lensStack?: LensInstance[]`
- [ ] Connection interface includes `readonly adapterChain?: AdapterStep[]`
- [ ] Fields are optional (backward compatible with existing patches)
- [ ] TypeScript compilation succeeds with no errors
- [ ] Existing connection creation code compiles without modification

#### Technical Notes
**File**: `src/editor/types.ts:551-560`

Current:
```typescript
export interface Connection {
  readonly id: string;
  readonly from: PortRef;
  readonly to: PortRef;
}
```

Target:
```typescript
export interface Connection {
  readonly id: string;
  readonly from: PortRef;
  readonly to: PortRef;
  readonly adapterChain?: AdapterStep[];
  readonly lensStack?: LensInstance[];
}
```

Fields are optional to maintain backward compatibility with saved patches that don't have these fields.

---

## P0 (Critical): Store Operations

### P0-2: Add PatchStore Methods for Wire Lens Management

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0-1 (Connection interface extended)
**Spec Reference**: Core Concepts (connection management) • **Status Reference**: STATUS-2025-12-26.md section 2.2

#### Description
Add MobX actions to PatchStore for creating, updating, and removing lenses on wire connections. These mirror the patterns used for listener lens management.

#### Acceptance Criteria (REQUIRED)
- [ ] `updateConnection(connectionId, updates)` method accepts `lensStack` and `adapterChain` in updates parameter
- [ ] `addLensToConnection(connectionId, lensDefinition, index?)` method adds lens to wire's lensStack
- [ ] `removeLensFromConnection(connectionId, index)` method removes lens from wire's lensStack
- [ ] `updateConnectionLens(connectionId, index, updates)` method updates lens params/enabled state
- [ ] All methods trigger MobX reactivity and emit 'graphCommitted' event
- [ ] Unit tests verify lens operations maintain stack order and enabled state

#### Technical Notes
**File**: `src/editor/stores/PatchStore.ts`

Follow the pattern established for listener lens management. Key methods:
```typescript
updateConnection(connectionId: string, updates: Partial<{
  adapterChain: AdapterStep[],
  lensStack: LensInstance[]
}>): void

addLensToConnection(connectionId: string, lensId: string, index?: number): void
removeLensFromConnection(connectionId: string, index: number): void
updateConnectionLens(connectionId: string, index: number, updates: Partial<LensInstance>): void
```

Ensure all operations:
1. Preserve immutability (create new array for lensStack)
2. Trigger MobX reactions via `@action` decorator
3. Emit `graphCommitted` event for compiler re-run
4. Handle missing connection gracefully (warn + return)

---

## P0 (Critical): Compiler Integration

### P0-3: Apply Lenses/Adapters During Wire Resolution

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: P0-1, P0-2
**Spec Reference**: 05-Compilation.md • **Status Reference**: STATUS-2025-12-26.md section 2.3

#### Description
Modify the wire resolution logic in `compileBusAware.ts` to apply adapter chains and lens stacks before assigning wire artifacts to block inputs. This mirrors the existing bus listener flow.

#### Acceptance Criteria (REQUIRED)
- [ ] Wire resolution applies `applyAdapterChain()` when `wireConn.adapterChain` exists
- [ ] Wire resolution applies `applyLensStack()` when `wireConn.lensStack` exists
- [ ] Application order is: adapter chain → lens stack (matches listener pattern)
- [ ] Disabled lenses (enabled: false) are skipped during application
- [ ] Lens errors are captured in CompileErrors with clear port references
- [ ] Unit test: Wire with scale lens (factor=2.0) produces scaled artifact value
- [ ] Unit test: Wire with disabled lens passes artifact unchanged
- [ ] Unit test: Wire with multiple lenses applies them in sortKey order

#### Technical Notes
**File**: `src/editor/compiler/compileBusAware.ts` lines 596-608

Current wire resolution (simplified):
```typescript
const wireConn = incoming.get(keyOf(blockId, p.name))?.[0];
if (wireConn !== null && wireConn !== undefined) {
  const srcKey = keyOf(wireConn.from.blockId, wireConn.from.port);
  const src = compiledPortMap.get(srcKey);
  inputs[p.name] = src ?? errorArtifact;  // <-- NO transformation
}
```

Target pattern (match listener flow at lines 615-637):
```typescript
const wireConn = incoming.get(keyOf(blockId, p.name))?.[0];
if (wireConn !== null && wireConn !== undefined) {
  const srcKey = keyOf(wireConn.from.blockId, wireConn.from.port);
  let artifact = compiledPortMap.get(srcKey) ?? errorArtifact;

  // Apply adapter chain if present
  if (wireConn.adapterChain && wireConn.adapterChain.length > 0) {
    artifact = applyAdapterChain(artifact, wireConn.adapterChain, ctx, errors);
  }

  // Apply lens stack if present
  if (wireConn.lensStack && wireConn.lensStack.length > 0) {
    artifact = applyLensStack(
      artifact,
      wireConn.lensStack,
      ctx,
      defaultSources,
      buses,
      publishers,
      compiledPortMap,
      errors
    );
  }

  inputs[p.name] = artifact;
}
```

**Challenge**: The `incoming` map currently stores `CompilerConnection` type which may not include lens/adapter fields. Options:
1. Change `incoming` map to store full `Connection` objects
2. Create a lookup map from connectionId to full Connection
3. Pass connections alongside incoming map

Recommend option 2 for minimal impact: Build `Map<connectionId, Connection>` early in compilation and lookup when needed.

---

## P1 (High): UI Integration

### P1-4: Add Lens Section to WireConnectionView

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: P0-2 (PatchStore methods)
**Spec Reference**: 07-UI-Spec.md • **Status Reference**: STATUS-2025-12-26.md section 2.4

#### Description
Extend `WireConnectionView` in ConnectionInspector to display lens stacks with add/remove/enable controls. Use the same badge placeholder pattern as `ListenerConnectionView` until LensChainEditor is implemented.

#### Acceptance Criteria (REQUIRED)
- [ ] WireConnectionView shows "Lenses" section when connection has lensStack
- [ ] Badge displays lens count (e.g., "2 lenses") with preview of lens names
- [ ] "Add Lens" button opens lens picker (reuse existing lens picker component)
- [ ] Each lens has enable/disable toggle (calls PatchStore.updateConnectionLens)
- [ ] Each lens has remove button (calls PatchStore.removeLensFromConnection)
- [ ] UI matches ListenerConnectionView styling and layout
- [ ] Manual test: Add scale lens to wire, verify badge updates
- [ ] Manual test: Disable lens, verify preview shows "disabled" state

#### Technical Notes
**File**: `src/editor/components/panels/ConnectionInspector.tsx` lines 121-183

Current WireConnectionView structure:
```typescript
function WireConnectionView({ connection }: { connection: Connection }) {
  return (
    <div>
      <ConnectionEndpoints from={connection.from} to={connection.to} />
      <DisconnectButton connectionId={connection.id} />
    </div>
  );
}
```

Add lens section matching ListenerConnectionView (lines 269-361) pattern:
```typescript
function WireConnectionView({ connection }: { connection: Connection }) {
  const lensCount = connection.lensStack?.length ?? 0;

  return (
    <div>
      <ConnectionEndpoints from={connection.from} to={connection.to} />

      {/* Lens Section */}
      {lensCount > 0 && (
        <div className="lens-section">
          <LensBadge lensStack={connection.lensStack!} />
          {/* Per-lens enable/remove controls */}
        </div>
      )}

      <Button onClick={() => showLensPicker(connection.id)}>Add Lens</Button>
      <DisconnectButton connectionId={connection.id} />
    </div>
  );
}
```

**Reusable Components**:
- LensBadge (if exists, otherwise create simple placeholder)
- Lens picker modal (check if exists for listeners)
- Enable/disable toggle (standard UI component)

**Future Work**: Replace badge placeholder with full LensChainEditor when available.

---

## P2 (Medium): Testing Infrastructure

### P2-5: Add Wire Lens Test Coverage

**Status**: Not Started
**Effort**: Medium (4-5 hours)
**Dependencies**: P0-3 (compiler integration)
**Spec Reference**: Testing best practices • **Status Reference**: STATUS-2025-12-26.md section 6

#### Description
Create comprehensive test coverage for wire lens functionality across unit, integration, and E2E layers. Ensure lens application, error handling, and UI interactions are validated.

#### Acceptance Criteria (REQUIRED)
- [ ] Unit test: Wire with single lens (scale) correctly transforms artifact value
- [ ] Unit test: Wire with multiple lenses applies them in sortKey order
- [ ] Unit test: Wire with disabled lens skips transformation
- [ ] Unit test: Wire lens with invalid param type produces compile error
- [ ] Integration test: Patch with lensed wire compiles and renders correctly
- [ ] Integration test: Lens param bound to defaultSource resolves correctly
- [ ] E2E test (manual/automated): Add lens via ConnectionInspector updates compilation
- [ ] Test coverage for wire lens operations matches listener lens coverage

#### Technical Notes
**Test Files**:
- `src/editor/__tests__/wire-lenses.test.ts` (new file for wire-specific tests)
- `src/editor/compiler/__tests__/compileBusAware.test.ts` (extend existing compiler tests)
- Manual E2E checklist in test plan

**Reference Pattern**:
Check `src/editor/__tests__/composite.expansion.test.ts:365` for listener lens preservation test. Similar pattern for wire lens serialization.

**Test Patch Example**:
```typescript
// Block A outputs Signal<number>
// Wire from A.output -> B.input with scale lens (factor=2.0)
// Expected: B receives artifact with value * 2.0
```

Golden test approach:
1. Create patch with lensed wire
2. Compile
3. Verify compiled artifact value matches expected transformation
4. Save and reload patch
5. Verify lens stack preserved

---

## Dependency Graph

```
P0-1: Extend Connection interface
  └─> P0-2: Add PatchStore methods
        └─> P0-3: Compiler integration
              └─> P2-5: Testing
        └─> P1-4: UI integration
```

Linear dependency chain with P1-4 and P2-5 parallelizable after P0-2.

---

## Sprint Execution Order

### Sprint 1: Core Infrastructure (P0 items)
**Duration**: 1-2 days
**Deliverables**: Types, store methods, compiler integration

1. **P0-1**: Extend Connection interface (1 hour)
2. **P0-2**: Add PatchStore methods (2-3 hours)
3. **P0-3**: Compiler integration (4-6 hours)
4. **Verify**: Run existing tests, check no regressions

**Exit Criteria**: Wire lenses work programmatically (no UI yet)

### Sprint 2: UI and Testing (P1 + P2)
**Duration**: 1 day
**Deliverables**: User-facing lens controls, test coverage

1. **P1-4**: Add lens section to WireConnectionView (3-4 hours)
2. **P2-5**: Add test coverage (4-5 hours)
3. **Verify**: Manual smoke test + automated test suite

**Exit Criteria**: Users can add/remove lenses on wires via ConnectionInspector

---

## Risk Assessment

### R1: Compiler Complexity (MEDIUM)
**Issue**: Wire resolution currently uses simplified `CompilerConnection` type without lens fields.
**Mitigation**: Build connection lookup map early in compilation. Minimal impact to existing flow.
**Contingency**: If lookup proves complex, defer adapters to future sprint and implement lenses only.

### R2: Serialization Backward Compatibility (LOW)
**Issue**: Adding fields to Connection could break old patches.
**Mitigation**: Fields are optional. Existing patches load with undefined lensStack/adapterChain.
**Verification**: Load existing golden patches, verify no errors.

### R3: UI Consistency (LOW)
**Issue**: Three connection types (wire, publisher, listener) need uniform lens editing.
**Mitigation**: Use same badge placeholder pattern. LensChainEditor is future work.
**Acceptance**: Sprint delivers working lens UI, not perfect lens UI.

### R4: Lens Scope Ambiguity (RESOLVED)
**Issue**: LensRegistry defines 'publisher' | 'listener' scopes. Wires aren't listed.
**Resolution**: Treat wires as 'listener' equivalent (decision D1). No lens definition changes needed.

---

## Out of Scope (Future Sprints)

1. **LensChainEditor Component**: Full drag-to-reorder, inline parameter editing UI. Benefits all connection types. Separate deliverable.
2. **Publisher Lens UI**: Publishers have lensStack in types but no UI editing. Lower priority than wires.
3. **Advanced Lens Features**: Lens param binding to wires/buses (not just defaultSources), conditional lenses, lens groups.
4. **Semantic Validation**: Extend Validator to check lens type compatibility on wires. Nice-to-have.
5. **Lens Presets**: Save/load common lens combinations as presets.

---

## Verification Checklist

### Before Merge
- [ ] All P0 acceptance criteria met
- [ ] Existing test suite passes (no regressions)
- [ ] TypeScript compilation clean (no new errors)
- [ ] Manual test: Add scale lens to wire via UI, verify transformed output
- [ ] Manual test: Disable lens, verify original output restored
- [ ] Manual test: Save/reload patch with lensed wire, verify lens preserved

### After Merge
- [ ] Update documentation (if wire lenses are user-visible feature)
- [ ] Add entry to changelog
- [ ] Monitor for user reports of lens-related bugs

---

## Success Metrics

**Functional**:
- Wire connections support lensStack and adapterChain fields
- Compiler applies lenses during wire resolution
- UI allows adding/removing lenses on wires
- Test coverage validates lens application correctness

**User Experience**:
- Users can apply same transformations to wires as they can to bus listeners
- Lens behavior is consistent across all connection types
- UI is discoverable (lens section visible when connection is selected)

**Technical Quality**:
- No performance regression in compilation
- Backward compatible with existing patches
- Code reuses existing lens infrastructure (no duplication)

---

## Notes

- **Lens Infrastructure Status**: LensRegistry (30+ lenses), applyLensStack(), lensResolution.ts all complete. Reuse for wires.
- **Reference Implementation**: Listener lens support (types.ts:223-241, compileBusAware.ts:615-637) provides proven pattern.
- **UI Pattern**: ListenerConnectionView (ConnectionInspector.tsx:269-361) shows lens badge placeholder. Copy for wires.
- **Test Reference**: composite.expansion.test.ts:365 tests listener lens preservation. Similar approach for wires.

---

**Generated with status-planner agent**
**Ready for**: /dev-loop:implement or manual implementation
