# Definition of Done: Sprint 0 - Foundation Stability
**Generated**: 2025-12-28-035835
**Plan**: PLAN-2025-12-28-035835.md
**Sprint Goal**: Unblock all work by fixing test failures, wiring debug backend, and fixing critical undo bug

---

## Sprint Scope

This sprint delivers **3 critical blockers** that prevent all other work from proceeding:

1. **Test Failures Fix** (79 tests) - Unblocks CI/CD and deployment
2. **Debug HUD Backend Wiring** - Unblocks Phase 7 debug infrastructure
3. **replaceBlock() Undo Fix** - Unblocks Phase 9 undo-redo completion

**Deferred to Later Sprints**: All enhancement work (renderer-ir, hot-swap, lens operations, UI architecture)

---

## Acceptance Criteria

### Deliverable 1: Test Failures Fixed (79 → 0 Failures)

#### TimeRoot Output Specification Resolved
- [ ] User has clarified if TimeRoot output spec is authoritative OR implementation is authoritative
- [ ] Decision documented in `.agent_planning/comprehensive-sprint-planning/DECISION-timeroot-outputs.md`
- [ ] If spec authoritative: Implementation refactored to match spec (remove extra outputs from FiniteTimeRoot, InfiniteTimeRoot)
- [ ] If implementation authoritative: Test expectations updated to match current implementation

#### Missing Function Exports Fixed (9 Tests)
- [ ] `extractTimeRootPorts` exported from `src/editor/compiler/blocks/domain/time-root-ports.ts`
- [ ] `extractTimeRootAutoPublications` exported from `src/editor/compiler/blocks/domain/time-root-ports.ts`
- [ ] `validateTimeRootDependencies` exported from appropriate validation module
- [ ] All 9 tests using these functions now pass

#### TimeRoot Test Expectations Updated (21 Tests)
- [ ] `CycleTimeRoot returns correct auto-publications` test updated to expect all actual publications
- [ ] `FiniteTimeRoot returns correct auto-publications` test updated for phase → phaseA publication
- [ ] `InfiniteTimeRoot returns correct auto-publications` test updated for actual outputs
- [ ] All TimeRoot port extraction tests pass (6 tests)
- [ ] All TimeRoot dependency validation tests pass (3 tests)
- [ ] `TimeRoot.test.ts` output validation tests pass (6 tests)

#### DiagnosticHub Logic Fixed (8 Tests)
- [ ] `DiagnosticHub.dispose()` calls `unsubscribe()` on event subscriptions
- [ ] `GraphCommitted` events trigger authoring validators (validator callback invoked)
- [ ] DiagnosticHub does NOT create missing TimeRoot diagnostic when TimeRoot exists
- [ ] Muted diagnostic filtering works in `getActive()` (returns only unmuted diagnostics)
- [ ] Muted diagnostic filtering works in `getAll()` (respects muted status)
- [ ] Unmute logic restores diagnostic to active set
- [ ] All 8 DiagnosticHub tests pass

#### Compiler Validation Implemented (3 Tests)
- [ ] Exactly-one-TimeRoot validation implemented in compiler integration
- [ ] Validation error raised for patch with 2+ TimeRoots
- [ ] TimeRoot upstream dependency validation implemented
- [ ] Validation error raised for TimeRoot with input connections
- [ ] Time topology correctly identified from TimeRoot type

#### Remaining Test Fixes (4+ Tests)
- [ ] ActionExecutor returns false when no connection exists (insertAdapter fix)
- [ ] ColorLFO compiles correctly (fix type error or implementation)
- [ ] Compositor frameReady state updates correctly
- [ ] Any truncated test errors investigated and fixed

#### Test Suite Health
- [ ] All 1956 tests passing (100% pass rate)
- [ ] Zero skipped tests (or skips documented with TODO)
- [ ] Test execution time < 5 seconds

#### Lint Errors Reduced
- [ ] Lint errors reduced below 100 (from 826)
- [ ] All unused imports removed from affected files
- [ ] Critical type errors fixed (blocking compilation)

---

### Deliverable 2: Debug HUD Backend Wired

#### Bus Value Source Determined
- [ ] Decision documented: BusStore.currentValue OR ScheduleExecutor slots
- [ ] If BusStore: `currentValue` field added to Bus model type
- [ ] If ScheduleExecutor: Slot ID → Bus ID mapping created

#### Player Backend Implementation
- [ ] BusStore has mechanism to track current bus values (either field or query)
- [ ] ScheduleExecutor (or runtime) updates bus values after executeBusEval
- [ ] `Player.emitHealthSnapshot()` populates `busValues` field with `Record<string, ValueSummary>`
- [ ] `busValues` uses `summarize()` function from `debug/types.ts` for value conversion
- [ ] RuntimeHealthSnapshotEvent includes populated busValues (verified in DevTools event log)

#### Probe Mode Hover Integration
- [ ] `BusChannel.tsx` has `onMouseEnter` handler calling `debugUIStore.setProbeTarget({ type: 'bus', busId })`
- [ ] `BusChannel.tsx` has `onMouseLeave` handler calling `debugUIStore.setProbeTarget(null)`
- [ ] Hover handlers only active when `debugUIStore.probeMode === true`
- [ ] Document-level `mousemove` event listener added when probe mode active
- [ ] `debugUIStore.updateCursorPosition(x, y)` called on mousemove (throttled to 60fps max)
- [ ] Mousemove listener removed when probe mode disabled

#### UI Rendering Verification
- [ ] Debug HUD shows live bus values (not "No value") when buses have data
- [ ] BusesTab displays bus value meters with correct values
- [ ] BusValueMeter renders number/phase/color/trigger/bool types correctly
- [ ] Probe mode highlights BusChannel on hover with cursor position tracking
- [ ] ProbeCard appears near cursor when hovering bus in probe mode
- [ ] ProbeCard shows correct bus value and type information

#### Unit Tests Created
- [ ] DebugHUD component test: renders 4 status lights
- [ ] DebugDrawer component test: tab switching works
- [ ] BusesTab component test: shows "No value" when no busValues, shows value when present
- [ ] ProbeCard component test: returns null for null target, renders bus info correctly
- [ ] DebugUIStore test: toggleProbeMode() works, setProbeTarget() works, updateHealthSnapshot() updates state
- [ ] Minimum 6 unit tests added for debug-ui components

---

### Deliverable 3: replaceBlock() Undo Fixed

#### Transaction Migration
- [ ] `replaceBlock()` uses single `runTx()` transaction (no nested transactions)
- [ ] New block added via `tx.add('blocks', newBlock)`
- [ ] Lane blockIds updated within same transaction (replaces direct mutation)
- [ ] Preserved connections added via `tx.add('connections', ...)` for each wire
- [ ] Preserved publishers added via `tx.add('publishers', ...)` for each
- [ ] Preserved listeners added via `tx.add('listeners', ...)` for each
- [ ] Old block removed via `tx.removeBlockCascade(oldBlockId)` within same transaction

#### Event Ordering Preserved
- [ ] `BlockReplaced` event emitted BEFORE removeBlock logic (for UI selection)
- [ ] May use post-transaction event emission if needed
- [ ] Event ordering verified: BlockReplaced → BlockRemoved → GraphCommitted

#### suppressGraphCommitted Removed
- [ ] `PatchStore.connect()` no longer has suppressGraphCommitted parameter (or ignores it)
- [ ] `PatchStore.disconnect()` no longer has suppressGraphCommitted parameter (or ignores it)
- [ ] All calls to connect/disconnect from replaceBlock use standard behavior
- [ ] Code search confirms NO remaining suppressGraphCommitted usage

#### Undo/Redo Verification
- [ ] Undo replaceBlock → original block fully restored
- [ ] Undo replaceBlock → all original connections restored (wires, publishers, listeners)
- [ ] Undo replaceBlock → NO orphaned new block remains in patch
- [ ] Redo replaceBlock → new block restored with copied connections
- [ ] Redo replaceBlock → old block removed cleanly

#### Integration Tests Added
- [ ] Test: replaceBlock → undo → original block restored with all wires
- [ ] Test: replaceBlock → undo → bus publishers restored
- [ ] Test: replaceBlock → undo → bus listeners restored
- [ ] Test: replaceBlock → undo → verify no orphaned blocks in patch.blocks
- [ ] Test: replaceBlock → redo → new block present with copied connections
- [ ] Minimum 5 integration tests added for replaceBlock undo/redo

#### Manual Testing Verification
- [ ] Manual test: Create patch with block A connected to block B
- [ ] Manual test: Replace block A with block C (should preserve connection to B)
- [ ] Manual test: Undo replace → block A restored, connection to B intact
- [ ] Manual test: Inspect patch.blocks → verify no orphaned blocks
- [ ] Manual test: Redo replace → block C present, connection to B intact

---

## Out of Scope (Deferred to Later Sprints)

### NOT in Sprint 0:
- Renderer-IR pipeline completion (Sprint 1)
- Hot-swap state preservation (Sprint 1)
- NodeEval investigation (Sprint 1)
- Lens operations migration (Sprint 2)
- addBlockAtIndex migration (Sprint 2)
- Kernel implementation (Sprint 3)
- TimeRoot auto-publish (Sprint 3)
- Validator integration (Sprint 3)
- 3D config UI (Sprint 4)
- Wire lenses (Sprint 4)
- Connection inspector (Sprint 4)
- Primitives enforcement (Sprint 4)
- Determinism enforcement (Sprint 5)
- Legacy runtime removal (Sprint 5)

---

## Definition of "Done"

Sprint 0 is complete when:

1. ✅ **All 1956 tests passing** (zero failures)
2. ✅ **Lint errors < 100** (from 826)
3. ✅ **Debug HUD shows live bus values** in BusesTab (verified in Chrome DevTools)
4. ✅ **Probe mode hover works** on BusChannel with cursor tracking
5. ✅ **replaceBlock undo leaves no orphans** (manual test + integration tests pass)
6. ✅ **CI pipeline passes** (typecheck, lint, test all green)

---

## Verification Checklist

### Pre-Merge Verification
- [ ] Run `just check` - all checks pass
- [ ] Run `just test` - all 1956 tests pass
- [ ] Open app in Chrome DevTools
- [ ] Add CycleTimeRoot to patch
- [ ] Verify Debug HUD shows phase/pulse bus values (not "No value")
- [ ] Enable probe mode (toggle button)
- [ ] Hover over bus in BusBoard - verify ProbeCard appears
- [ ] Create block, replace it, undo - verify no orphaned blocks

### Post-Merge Verification
- [ ] CI build passes on main branch
- [ ] No regressions in other test suites
- [ ] Chrome DevTools runtime verification confirms functionality

---

## Estimated Effort

| Deliverable | Estimated Hours | Complexity |
|-------------|----------------|------------|
| Test Failures Fix | 2-3 hours (after user clarification) | SMALL |
| Debug HUD Backend | 4-6 hours | MEDIUM |
| replaceBlock() Undo | 6-8 hours | MEDIUM |
| **TOTAL** | **12-17 hours** | **1.5-2 days** |

**Critical Path**: Test failures MUST be resolved first (blocks all other work)

---

## Dependencies

### External Dependencies
- **User Decision**: TimeRoot output specification (spec vs implementation)
- **User Decision**: Bus value source (BusStore.currentValue vs ScheduleExecutor slots)

### Internal Dependencies
- Test failures fix enables all other work (CI must pass)
- Debug HUD backend standalone (no dependencies)
- replaceBlock() undo standalone (no dependencies)

### No Blockers After Sprint 0
- Sprint 1 can begin immediately after Sprint 0 complete
- Sprint 2 and Sprint 3 can run in parallel after Sprint 0

---

## Risk Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| TimeRoot spec decision takes > 1 day | MEDIUM | HIGH | Prepare both implementation paths in parallel |
| Debug HUD bus value source unclear | LOW | MEDIUM | Default to BusStore.currentValue (simplest) |
| replaceBlock() has hidden edge cases | MEDIUM | MEDIUM | Thorough integration tests + manual testing |
| Test fixes break other tests | LOW | HIGH | Run full test suite after each fix |

---

## Success Metrics

**Sprint 0 is successful if**:
1. Project is deployable (tests pass, lint acceptable)
2. Debug infrastructure usable (HUD shows data)
3. Undo-redo reliable (no orphans on complex operations)
4. Team can proceed to Sprint 1 without blockers

**Key Indicators**:
- Test pass rate: 96% → 100%
- Lint errors: 826 → <100
- Debug HUD usability: 0% → 100% (shows data)
- Undo-redo reliability: BROKEN → WORKING
