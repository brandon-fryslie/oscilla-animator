# Definition of Done: Legacy Code Removal Sprint (Revised)

**Generated:** 2025-12-27-031255
**Plan:** PLAN-2025-12-27-031255.md
**Topic:** paramSchema removal + legacy type/lens alias cleanup

---

## Sprint Scope

**This sprint delivers:**
1. Complete paramSchema removal (27 blocks + Inspector.tsx + type definition)
2. Legacy type alias cleanup (audit and remove unused aliases)
3. Lens alias documentation (preserve for backward compatibility)

**Deferred to future sprints:**
- Feature Flags removal (when IR compiler is production-ready)
- DebugStore API migration (actively in use, no removal needed)
- Legacy Events migration (actively in use, no removal needed)

---

## Acceptance Criteria

### Deliverable 1: Inspector.tsx paramSchema Removal

**Work Item:** P1-1

- [ ] Inspector.tsx lines 607-619 no longer reference `definition.paramSchema`
- [ ] **Either:** Parameter preview section removed entirely (if redundant), **OR**
- [ ] **Or:** Parameter preview updated to use `definition.inputs.filter(s => s.defaultSource)` to show parameter-like inputs
- [ ] TypeScript compilation passes: `just typecheck` exits 0
- [ ] Chrome DevTools verification:
  - [ ] Navigate to Inspector panel
  - [ ] Select a block with parameters (e.g., Oscillator, PhaseClock)
  - [ ] Inspector displays block info correctly without errors
  - [ ] No console errors related to paramSchema

---

### Deliverable 2: Remove paramSchema from 27 Blocks

**Work Item:** P1-2

- [ ] All 27 `paramSchema` arrays removed from block definitions:
  - [ ] `src/editor/blocks/signal.ts` - 4 blocks (lines 70, 164, 251, 474)
  - [ ] `src/editor/blocks/domain.ts` - 16 blocks
  - [ ] `src/editor/blocks/time-root.ts` - 3 blocks (lines 46, 114, 184)
  - [ ] `src/editor/blocks/field-primitives.ts` - 2 blocks (lines 100, 185)
  - [ ] `src/editor/blocks/rhythm.ts` - 2 blocks (lines 43, 113)
- [ ] All 27 TODO comments removed (format: `// TODO: Remove paramSchema after compiler updated (Phase 4)`)
- [ ] Each modified block verified to have `defaultSource` on corresponding input slots
- [ ] TypeScript compilation passes: `just typecheck` exits 0
- [ ] All tests pass: `just test` exits 0
- [ ] Chrome DevTools verification:
  - [ ] Create a new block from each modified category (Signal, Domain, TimeRoot, Field, Rhythm)
  - [ ] Block renders correctly in patch bay
  - [ ] Block compiles without errors
  - [ ] Block executes correctly (check preview panel)

---

### Deliverable 3: Remove paramSchema from Type System

**Work Item:** P1-3

- [ ] `readonly paramSchema: ParamSchema[];` removed from `BlockDefinition` interface (`src/editor/blocks/types.ts` line 59)
- [ ] `ParamSchema` type definition removed (if no other references exist)
- [ ] TypeScript compilation passes: `just typecheck` exits 0
- [ ] All tests pass: `just test` exits 0
- [ ] Grep verification confirms no references remain:
  ```bash
  # Should return 0 hits (or only docs/comments)
  grep -r "paramSchema" src/ --include="*.ts" --include="*.tsx"
  grep -r "ParamSchema" src/ --include="*.ts" --include="*.tsx"
  ```
- [ ] No TypeScript errors in IDE/editor

---

### Deliverable 4: Legacy Type Alias Cleanup

**Work Item:** P2-1

- [ ] **BlockCategory alias** (`src/editor/types.ts` line 455):
  - [ ] Audit completed: `grep -r "BlockCategory" src/` to find all usages
  - [ ] If only used in type exports → alias removed
  - [ ] If used in implementation code → alias kept (document why)
  - [ ] Decision documented in commit message

- [ ] **'Field<Point>' alias** (`src/editor/types.ts` line 274):
  - [ ] Audit completed: `grep -r "Field<Point>" src/` to find all usages
  - [ ] If only in HelpCenter.tsx docs → either keep for clarity OR update docs to use `'Field<vec2>'`
  - [ ] If used in slot type definitions → migrate to canonical `'Field<vec2>'`
  - [ ] Decision documented in commit message

- [ ] **'RenderTree' type** (`src/editor/types.ts` line 292):
  - [ ] Audit completed: `grep -r "RenderTree" src/` (52 files found in STATUS)
  - [ ] If heavily used → keep with comment: `// Internal legacy slot type - still in active use`
  - [ ] If rarely used → consider migration to `'Render'` canonical type
  - [ ] Decision documented

- [ ] **'Other' subcategory** (`src/editor/types.ts` line 447):
  - [ ] KEPT (actively used in 11 locations per STATUS)
  - [ ] No changes needed

- [ ] TypeScript compilation passes: `just typecheck` exits 0
- [ ] All tests pass: `just test` exits 0

---

### Deliverable 5: Lens Alias Documentation

**Work Item:** P2-2

- [ ] Comment block added above line 761 in `src/editor/lenses/LensRegistry.ts`:
  ```typescript
  /**
   * Legacy Lens Aliases (Backward Compatibility)
   *
   * These aliases map old PascalCase lens IDs to canonical camelCase IDs.
   * They exist to support loading saved patches that reference the old IDs.
   *
   * Status: Safe to keep indefinitely - additive aliases that don't block anything.
   * Migration: Can be removed after all production patches use camelCase IDs.
   *
   * Canonical IDs: Always use camelCase in new code (e.g., 'polarity' not 'Polarity')
   */
  ```
- [ ] Verify no new code uses PascalCase lens IDs:
  ```bash
  # Should only find LensRegistry.ts itself
  grep -r "Polarity\|Softclip\|Hysteresis" src/ --include="*.ts" --exclude="LensRegistry.ts"
  ```
- [ ] Documentation-only change, no functional modifications
- [ ] TypeScript compilation passes: `just typecheck` exits 0

---

## Final Verification Checklist

**All of these must pass before sprint is considered complete:**

### Build & Test
- [ ] `just typecheck` - TypeScript compilation succeeds with 0 errors
- [ ] `just lint-fix` - Linting passes (auto-fix applied if needed)
- [ ] `just test` - All test suites pass

### Code Quality
- [ ] No `paramSchema` references remain (except in archived files or external docs):
  ```bash
  grep -r "paramSchema" src/ --include="*.ts" --include="*.tsx"
  # Expected: 0 hits or only comments/archived code
  ```
- [ ] No `ParamSchema` type references remain (except if intentionally kept for other purposes):
  ```bash
  grep -r "ParamSchema" src/ --include="*.ts" --include="*.tsx"
  # Expected: 0 hits or clearly documented usage
  ```
- [ ] Git status shows only intended file modifications (no accidental changes)

### Chrome DevTools Verification
- [ ] **Block Creation Test:**
  - [ ] Open Chrome DevTools MCP
  - [ ] Create blocks from modified categories: Signal, Domain, TimeRoot, Field, Rhythm
  - [ ] Each block appears in patch bay correctly
  - [ ] No console errors during block creation

- [ ] **Inspector Test:**
  - [ ] Select a block with defaultSource inputs (e.g., Oscillator)
  - [ ] Inspector panel displays block information
  - [ ] Inputs with defaultSource show correctly
  - [ ] No console errors or missing sections

- [ ] **Compilation Test:**
  - [ ] Create a simple patch with modified blocks
  - [ ] Compile the patch (add TimeRoot → connect to render)
  - [ ] Compilation succeeds without errors
  - [ ] Preview panel shows rendered output

- [ ] **Runtime Test:**
  - [ ] Play the patch
  - [ ] Blocks execute correctly
  - [ ] No runtime errors in console
  - [ ] Scrubbing timeline works correctly

### Documentation
- [ ] Commit messages clearly explain what was removed and why
- [ ] If any type aliases were kept, reason is documented in code comments
- [ ] Lens alias purpose documented in LensRegistry.ts

---

## Rollback Criteria

**If any of these occur, STOP and rollback:**

1. TypeScript compilation fails after changes
2. Test suite has NEW failures (not pre-existing ones)
3. Chrome DevTools shows blocks failing to render/compile
4. Runtime errors appear in console during patch execution
5. Inspector panel breaks or shows errors

**Rollback procedure:**
```bash
git status  # Verify which files changed
git diff    # Review changes
git restore <file>  # Restore specific files, or
git reset --hard HEAD  # Full rollback if needed
```

---

## Sprint Completion Criteria

**This sprint is DONE when:**

1. ✅ All 5 deliverables have their acceptance criteria checked off
2. ✅ Final verification checklist is 100% complete
3. ✅ Chrome DevTools testing confirms no regressions
4. ✅ Git commit history is clean with clear messages
5. ✅ No blocking issues or rollback criteria triggered

**Estimated completion time:** 4-6 hours total (can be split across 2 sessions)

**Deliverables:**
- P1 items (paramSchema removal): 3-4 hours
- P2 items (type alias cleanup): 1-2 hours

---

## Post-Sprint Actions

After sprint completion:

1. **Monitor for issues:**
   - Watch for any bug reports related to Inspector or block definitions
   - Check if any saved patches fail to load (unlikely, but possible)

2. **Update documentation:**
   - If design docs reference paramSchema, update them to reflect removal
   - Note in changelog: "Removed legacy paramSchema from block definitions"

3. **Communicate changes:**
   - If working with team, notify that paramSchema is gone
   - Point to defaultSource as the canonical parameter mechanism

4. **Plan next steps:**
   - Feature Flags removal (future sprint when IR compiler stable)
   - Continue main development priorities
   - Legacy cleanup is now minimal

---

## Notes

- **User Feedback:** DebugStore API and Legacy Events are actively in use - they remain untouched
- **Verification Tool:** Chrome DevTools MCP is the authoritative test (not just test suite)
- **Risk Level:** LOW - compiler doesn't use paramSchema, clear migration path via defaultSource
- **Breaking Changes:** None expected - paramSchema was already unused by compiler
