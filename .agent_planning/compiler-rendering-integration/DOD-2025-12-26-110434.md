# Definition of Done: Compiler Rendering Integration

**Generated:** 2025-12-26-110434
**Plan:** PLAN-2025-12-26-110434.md
**Topic:** Wire IR Compiler to Player for Rendering

---

## Sprint Scope

**This sprint delivers:** IR compiler → Player rendering integration (3 core deliverables)

**Deferred to future sprints:**
- RuntimeCtx propagation (P3-1)
- Performance optimization (P3-2)
- Legacy compiler removal
- Debug infrastructure (Phase 7)
- Golden patch parity testing

---

## Acceptance Criteria

### Deliverable 1: Fix ScheduleExecutor Render Tree Extraction (P0-1)

**File:** `src/editor/runtime/executor/ScheduleExecutor.ts`

- [ ] `extractRenderOutput()` method signature changed from `(runtime) -> RenderOutput` to `(program, runtime) -> RenderTree`
- [ ] Method reads from `program.outputs[0].slot` using ValueStore
- [ ] Method returns actual `RenderTree` type (not stub `RenderOutput`)
- [ ] Method validates slot contains a RenderTree using type guard
- [ ] Method throws descriptive error if output slot is empty or wrong type
- [ ] Method handles empty `program.outputs` array by returning empty group: `{ kind: 'group', id: 'empty', children: [] }`
- [ ] `executeFrame()` signature updated to return `RenderTree` instead of `RenderOutput`
- [ ] All existing ScheduleExecutor unit tests still pass
- [ ] No TypeScript errors

### Deliverable 2: Create IRRuntimeAdapter (P0-2)

**File:** `src/editor/runtime/executor/IRRuntimeAdapter.ts` (new)

**Class Structure:**
- [ ] Class `IRRuntimeAdapter` exported from new file
- [ ] Constructor accepts `CompiledProgramIR` parameter
- [ ] Constructor initializes `ScheduleExecutor` instance
- [ ] Constructor initializes `RuntimeState` via `createRuntimeState(program)`
- [ ] Private fields: `executor`, `program`, `runtime` properly typed

**createProgram() Method:**
- [ ] Returns `Program<RenderTree>` compatible with Player interface
- [ ] Returned program's `signal(tMs, runtimeCtx)` calls `executor.executeFrame(program, runtime, tMs)`
- [ ] Returned program's `signal()` returns `RenderTree` (not `RenderOutput`)
- [ ] Returned program's `event()` returns empty array (stub implementation)
- [ ] RuntimeState is preserved across multiple `signal()` calls (not recreated)

**swapProgram() Method:**
- [ ] Accepts `CompiledProgramIR` parameter
- [ ] Calls `executor.swapProgram(newProgram, runtime)` to get new RuntimeState
- [ ] Updates internal `program` and `runtime` references
- [ ] Preserves frameId and time continuity (verified by hot-swap test)

**Testing:**
- [ ] Unit test: `IRRuntimeAdapter.test.ts` created
- [ ] Test: adapter construction succeeds with valid program
- [ ] Test: createProgram() returns valid Program interface
- [ ] Test: signal(0) executes frame and returns RenderTree
- [ ] Test: multiple signal() calls preserve runtime state
- [ ] Test: swapProgram() preserves state cells (matching nodeId)
- [ ] Test: swapProgram() initializes new state cells with defaults
- [ ] All tests pass
- [ ] No TypeScript errors

### Deliverable 3: Wire Player to Use IR Path (P0-3)

**File:** `src/editor/runtime/player.ts` (modified)

**New Method:**
- [ ] `setIRProgram(program: CompiledProgramIR): void` method added to Player class
- [ ] Method creates `IRRuntimeAdapter` instance
- [ ] Method calls `adapter.createProgram()` and assigns to `this.program`
- [ ] Method calls `this.renderOnce()` to show new program at current time
- [ ] Method does NOT reset `tMs` (preserves scrubbing continuity)

**Integration:**
- [ ] IRRuntimeAdapter imported at top of player.ts
- [ ] CompiledProgramIR type imported from ir/program
- [ ] No changes to existing `setFactory()`, `renderOnce()`, or playback methods
- [ ] Legacy path still works (existing `setFactory` behavior unchanged)

**Testing:**
- [ ] Existing Player tests still pass (legacy path unaffected)
- [ ] New test: Player with IR program renders frame
- [ ] New test: Player.setIRProgram() preserves time during hot-swap
- [ ] No TypeScript errors
- [ ] No runtime errors when calling setIRProgram

### Deliverable 4: End-to-End Integration Test (P1-1)

**File:** `src/editor/runtime/__tests__/IRRuntimeIntegration.test.ts` (new)

**Test: Basic IR Rendering**
- [ ] Test compiles minimal patch using IR compiler to produce CompiledProgramIR
- [ ] Test creates Player instance with onFrame callback
- [ ] Test calls `player.setIRProgram(compiledProgram)`
- [ ] Test calls `player.scrubTo(1000)` to trigger frame
- [ ] Test verifies onFrame callback was called with RenderTree argument
- [ ] Test verifies RenderTree has expected structure (kind, id, children/geom)
- [ ] Test passes

**Test: Hot-Swap Behavior**
- [ ] Test compiles initial patch → program1
- [ ] Test sets program1 on Player and captures first frame
- [ ] Test modifies patch (e.g., change parameter)
- [ ] Test compiles modified patch → program2
- [ ] Test calls `player.setIRProgram(program2)` (hot-swap)
- [ ] Test verifies time is preserved (tMs unchanged)
- [ ] Test captures second frame and verifies it reflects new program
- [ ] Test passes

**Test Structure:**
- [ ] Test uses minimal patch (TimeRoot + simple output block)
- [ ] Test does not require complex bus wiring or field materialization
- [ ] Test assertions are specific (not just "tree exists")
- [ ] Test is readable and maintainable

### Deliverable 5: Feature Flag Toggle Test (P1-2)

**File:** `src/editor/runtime/__tests__/FeatureFlagToggle.test.ts` (new) or add to existing test file

**Test: Flag Behavior**
- [ ] Test verifies `getFeatureFlags().useUnifiedCompiler` defaults to `false`
- [ ] Test sets flag to `true` via `setFeatureFlags({ useUnifiedCompiler: true })`
- [ ] Test verifies flag value changed to `true`
- [ ] Test sets flag back to `false`
- [ ] Test verifies flag value changed to `false`
- [ ] Test passes

**Test: Legacy Path Still Works**
- [ ] Test with `useUnifiedCompiler: false` uses legacy compiler path
- [ ] Test verifies existing legacy rendering still works
- [ ] Test passes

**Test: IR Path Works**
- [ ] Test with `useUnifiedCompiler: true` can use IR path
- [ ] Test verifies IR rendering works (re-uses P1-1 test)
- [ ] Test passes

---

## Integration Verification Checklist

**End-to-End Smoke Test:**
- [ ] Compile simple patch with IR compiler
- [ ] Create Player and set IR program
- [ ] Call play() - no errors
- [ ] Call scrubTo(1000) - no errors
- [ ] Verify onFrame receives valid RenderTree
- [ ] Call pause() - no errors
- [ ] Swap program (hot-swap) - no errors
- [ ] Verify new frame reflects new program

**Regression Testing:**
- [ ] All existing compiler tests pass (1839+ tests)
- [ ] All existing Player tests pass
- [ ] All existing ScheduleExecutor tests pass
- [ ] No new TypeScript errors introduced
- [ ] No new console warnings during test runs

**Code Quality:**
- [ ] All new code follows project style guide
- [ ] All new exports properly typed (no `any`)
- [ ] All error paths throw descriptive errors
- [ ] No dead code or commented-out blocks
- [ ] No TODOs left in critical paths (P0 items)

---

## Definition of Done Criteria

**A work item is DONE when:**

1. **All acceptance criteria are checked** (green checkmarks)
2. **All tests pass** (existing + new)
3. **Code review complete** (if applicable)
4. **No regressions** (legacy path still works)
5. **Documentation updated** (inline comments + plan docs)

**The SPRINT is DONE when:**

1. **All P0 and P1 items are DONE** (per above definition)
2. **Integration smoke test passes** (see checklist above)
3. **Feature flag enables IR rendering** without errors
4. **Simple patch renders correctly** using IR path
5. **Hot-swap works** (state preserved, no visual jank)

---

## Non-Goals (Explicitly Out of Scope)

**This sprint does NOT deliver:**
- ❌ RuntimeCtx propagation to blocks (P3-1, deferred)
- ❌ Performance optimization or benchmarking (P3-2, deferred)
- ❌ Legacy compiler removal (future sprint)
- ❌ Golden patch parity testing (requires all blocks working)
- ❌ Debug infrastructure (Phase 7 - trace events, debugger)
- ❌ Error reporting UI (separate sprint)
- ❌ Documentation beyond inline comments (P2-1 is optional)

**Why deferred:**
- RuntimeCtx: Not needed for basic rendering, most blocks don't use viewport
- Performance: Premature optimization - get correctness first
- Legacy removal: Requires full feature parity and confidence
- Golden patch: Complex patch testing is separate verification sprint
- Debug tools: Phase 7 infrastructure, not blocking rendering

---

## Success Metrics

**Quantitative:**
- ✅ 0 new test failures
- ✅ 5+ new tests passing (integration tests)
- ✅ 0 TypeScript errors
- ✅ 3 new files created, 2 files modified
- ✅ <100 lines of code changed in Player (minimal invasive change)

**Qualitative:**
- ✅ Feature flag toggle switches rendering paths cleanly
- ✅ Developer can use IR path without understanding internals
- ✅ Error messages are helpful (not cryptic stack traces)
- ✅ Code is readable and maintainable

---

## Sign-Off Checklist

**Before marking sprint complete:**

- [ ] All P0 acceptance criteria checked off
- [ ] All P1 acceptance criteria checked off
- [ ] Integration verification checklist complete
- [ ] All tests passing in CI (if applicable)
- [ ] No console errors during manual smoke test
- [ ] Feature flag documented (if not already)
- [ ] Plan and STATUS files updated with outcomes

**Final Verification:**

- [ ] Can flip `useUnifiedCompiler: true` and see a patch render
- [ ] Can hot-swap a program without visual artifacts
- [ ] Can scrub timeline and see smooth rendering
- [ ] No memory leaks observed (frames don't accumulate)

---

**Once all boxes are checked, the sprint is DONE and ready for review/merge.**
