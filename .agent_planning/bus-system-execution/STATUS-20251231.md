# Status Report - Bus System Execution
Timestamp: 2025-12-31-014500
Scope: workstream/bus-system-execution
Confidence: FRESH

## Executive Summary
Overall: **20% complete** | Critical issues: **2** | Tests reliable: yes (2646/2667 pass)

**Verdict**: PAUSE - Critical infrastructure gaps prevent bus system execution

---

## Evaluation Reuse Summary
- Carried forward: 0 RECENT findings (no prior evaluation)
- Spot-checked: 0 RISKY findings
- Re-evaluated: 0 STALE findings
- Fresh evaluation: All findings are FRESH

---

## Runtime Check Results
| Check | Status | Output |
|-------|--------|--------|
| `just check` | PASS | 2646/2667 tests pass, 11 skipped, 10 todo |
| `pnpm typecheck` | PASS | No type errors |
| `pnpm lint` | (not run separately) | Included in check |

---

## Critical Gaps (MUST FIX)

### Gap 1: Bus Evaluation Steps NOT Emitted [CRITICAL]
**Status**: NOT_STARTED
**Location**: `src/editor/compiler/ir/buildSchedule.ts:14`
**Evidence**:
```typescript
// KNOWN GAPS:
// - StepBusEval is NOT emitted (busRoots from pass7 not threaded through BuilderProgramIR)
```

**Root Cause**:
1. Pass7 (`pass7BusLowering`) creates `busRoots: Map<BusIndex, ValueRefPacked>`
2. Pass8 (`pass8LinkResolution`) threads `busRoots` through `LinkedGraphIR`
3. **BUG**: `IRBuilderImpl.build()` does NOT include `busRoots` in `BuilderProgramIR` output (line 764-799)
4. `buildCompiledProgram()` receives `BuilderProgramIR` WITHOUT bus information
5. Schedule builder has NO bus roots to emit StepBusEval

**Impact**:
- **Buses DO NOT evaluate in IR mode** - entire bus system non-functional
- Bus listeners receive stale/undefined values
- Any patch relying on buses silently fails

**Files to Modify**:
1. `src/editor/compiler/ir/builderTypes.ts` - Add `busRoots` to `BuilderProgramIR` interface
2. `src/editor/compiler/ir/IRBuilderImpl.ts` - Include `busRoots` in `build()` output
3. `src/editor/compiler/passes/pass7-bus-lowering.ts` - Store busRoots in IRBuilder
4. `src/editor/compiler/ir/buildSchedule.ts` - Emit StepBusEval for each busRoot

---

### Gap 2: busRoots Not Stored in IRBuilder [CRITICAL]
**Status**: NOT_STARTED
**Location**: `src/editor/compiler/ir/IRBuilderImpl.ts`

**Evidence**:
- `IRBuilderImpl` has NO `busRoots` field (checked lines 56-100)
- `IRBuilderImpl.build()` returns `BuilderProgramIR` without busRoots (lines 764-799)
- Pass7 creates busRoots but has NO way to store them in the builder

**Root Cause**: IRBuilder API missing bus storage methods

**Solution**: Add to IRBuilder:
```typescript
class IRBuilderImpl {
  private busRoots: Map<BusIndex, ValueRefPacked> = new Map();

  // API method
  registerBusRoot(busIndex: BusIndex, ref: ValueRefPacked): void {
    this.busRoots.set(busIndex, ref);
  }

  // Include in build()
  build(): BuilderProgramIR {
    return {
      // ... existing fields
      busRoots: Array.from(this.busRoots.entries()),
    };
  }
}
```

---

## Workstream Assessment by Area

### 1. Thread bus roots into schedule [NOT_STARTED]
**Goal**: Emit StepBusEval in schedule
**Status**: 0% - Blocked by Gap 1 and Gap 2

**What Exists**:
- ✅ Pass7 creates busRoots with combine nodes (`pass7-bus-lowering.ts:94-146`)
- ✅ Pass8 threads busRoots through LinkedGraphIR (`pass8-link-resolution.ts:64`)
- ✅ StepBusEval type defined (`src/editor/compiler/ir/schedule.ts:268-288`)
- ✅ executeBusEval runtime exists (`src/editor/runtime/executor/steps/executeBusEval.ts:42-179`)
- ✅ ScheduleExecutor dispatches busEval steps (`ScheduleExecutor.ts:196-198`)

**What's Missing**:
- ❌ busRoots NOT in BuilderProgramIR (Gap 1)
- ❌ busRoots NOT in IRBuilder (Gap 2)
- ❌ buildSchedule does NOT emit StepBusEval

**Dependencies**: Must fix Gap 1 and Gap 2 first

---

### 2. Support non-numeric bus combine [PARTIAL]
**Goal**: Combine vec2/vec3/color bus values
**Status**: 33% - Runtime supports numeric only, IR schema incomplete

**What Works**:
- ✅ `executeBusEval` implements numeric combine modes: sum, average, min, max, last, product (`executeBusEval.ts:147-179`)
- ✅ Silent value policies for empty buses (zero/default/const) (`executeBusEval.ts:85-127`)

**What's Missing**:
- ❌ No vec2/vec3 component-wise combine in runtime
- ❌ No color alpha composite/blend in runtime
- ❌ TypeDesc domain not checked - always uses numeric combine
- ❌ No tests for non-numeric buses

**Code Location**:
`src/editor/runtime/executor/steps/executeBusEval.ts:147-179` - combineValues only handles numbers

**Proposed Solution** (from SPEC-07):
```typescript
function combineValues(values: unknown[], mode: string, type: TypeDesc) {
  if (type.domain === "vec2") {
    return combineVec2(values as Vec2[], mode);
  }
  if (type.domain === "vec3") {
    return combineVec3(values as Vec3[], mode);
  }
  if (type.domain === "color") {
    return combineColor(values as Color[], mode);
  }
  // Existing numeric path
  return combineNumeric(values as number[], mode);
}
```

---

### 3. Event bus evaluation [COMPLETE]
**Goal**: Event buses combine triggers with edge detection
**Status**: 100% - Fully implemented

**What Exists**:
- ✅ StepEventBusEval type defined (`schedule.ts:349-363`)
- ✅ executeEventBusEval runtime (`executeEventBusEval.ts:54-137`)
- ✅ Event combine modes: merge, first, last (`executeEventBusEval.ts:103-136`)
- ✅ Empty bus handled with empty event stream (`executeEventBusEval.ts:63-65`)
- ✅ ScheduleExecutor dispatches eventBusEval (`ScheduleExecutor.ts:200-202`)

**Evidence**: Tests pass, implementation complete

**Caveat**: Same Gap 1 issue - event bus steps NOT emitted in schedule

---

### 4. Field buses [PARTIAL]
**Goal**: Combine field values element-wise
**Status**: 40% - IR layer ready, runtime stub only

**What Exists**:
- ✅ Pass7 emits fieldCombine nodes (`pass7-bus-lowering.ts:230-243`)
- ✅ Field bus type support in Pass7 (`pass7-bus-lowering.ts:229-243`)
- ✅ fieldCombine IR node in builder (IRBuilderImpl has fieldCombine method)

**What's Missing**:
- ❌ No StepFieldBusEval in schedule IR
- ❌ No executeFieldBusEval runtime step
- ❌ Field materialization happens AFTER bus eval - incorrect ordering

**Complexity**: Field buses require:
1. Materialize each publisher field → buffer
2. Combine element-wise across buffers
3. Write to output buffer
4. Requires domain count (from domain slot)

---

### 5. Publisher ordering [COMPLETE]
**Goal**: Deterministic "layer/last" semantics
**Status**: 100% - Canonical ordering enforced

**What Exists**:
- ✅ `busSemantics.getSortedPublishers` is single source of truth (`busSemantics.ts:41-60`)
- ✅ Sorting: primary by sortKey, secondary by id.localeCompare
- ✅ Used in Pass7 bus lowering (`pass7-bus-lowering.ts:159-162`)
- ✅ Used in runtime executeBusEval (`executeBusEval.ts:48`, publishers pre-sorted)
- ✅ Used in executeEventBusEval (`executeEventBusEval.ts:60`, publishers pre-sorted)

**Evidence**:
- Tests pass (`busSemantics.test.ts`: 41 tests)
- Single canonical implementation in semantic layer
- No duplicate sorting in compiler or runtime

---

## Data Flow Verification

| Flow | Status | Notes |
|------|--------|-------|
| Pass7 creates busRoots | ✅ VERIFIED | Map<BusIndex, ValueRefPacked> |
| Pass8 threads busRoots | ✅ VERIFIED | In LinkedGraphIR.busRoots |
| builder.build() includes busRoots | ❌ BROKEN | NOT in BuilderProgramIR |
| buildSchedule receives busRoots | ❌ BROKEN | BuilderProgramIR missing field |
| Schedule emits StepBusEval | ❌ BROKEN | Cannot emit without busRoots |
| Runtime executes bus eval | ✅ READY | executeBusEval implemented |
| ValueStore writes bus value | ✅ READY | Standard slot write |

---

## Test Suite Assessment
**Quality Score**: 4/5 (very good coverage, missing bus execution tests)

### Coverage Gaps
- ✅ Publisher sorting (41 tests in busSemantics.test.ts)
- ✅ Bus compile lowering (7 tests in pass7-bus-lowering.test.ts)
- ✅ Link resolution (6 tests in pass8-link-resolution.test.ts)
- ✅ Bus combine semantics (8 tests in field-bus-compilation.test.ts)
- ❌ **Missing**: End-to-end IR bus execution tests (no tests verify StepBusEval emission)
- ❌ **Missing**: Non-numeric bus combine tests (vec2/vec3/color)

### Test Reliability
- All tests passing (2646/2667)
- Tests use legacy closure-based compilation (IR not enabled in tests)
- Tests would NOT catch Gap 1 (busRoots threading) because IR not tested

**Blind Spot**: Tests exercise legacy bus compilation, NOT IR bus execution

---

## Implementation Red Flags

**Fake Completeness**:
- ❌ `buildSchedule.ts:14` has KNOWN GAPS comment but no TODO/FIXME
- ❌ executeBusEval only supports numeric (line 42-179) but no runtime check for type

**Missing Error Handling**:
- No compile error when bus has non-numeric type (vec2/vec3/color)
- executeBusEval would crash with non-number values (uncaught TypeError)

**Over-engineering**:
- None detected - implementation is appropriately minimal

---

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| busRoots threading | Should busRoots be in BuilderProgramIR or passed separately? | Assumed BuilderProgramIR (spec says so) | CRITICAL - blocks all bus execution |
| Non-numeric combine | What's the combine semantic for color "layer" mode? | Not implemented (spec incomplete) | MEDIUM - feature incomplete |
| Field bus timing | Should field buses eval before or after materialize? | Deferred decision | LOW - can be fixed in schedule order |

---

## Recommendations

### Priority 1: Fix Critical Infrastructure (Gaps 1 & 2)
**Effort**: 4-6 hours
**Steps**:
1. Add `busRoots: readonly [BusIndex, ValueRefPacked][]` to `BuilderProgramIR` interface
2. Add `private busRoots: Map<BusIndex, ValueRefPacked>` to `IRBuilderImpl`
3. Add `registerBusRoot(busIndex, ref)` method to IRBuilder API
4. Call `builder.registerBusRoot()` in pass7 for each bus (line ~134)
5. Include `busRoots: Array.from(this.busRoots.entries())` in `build()` output
6. In `buildSchedule.ts`, emit StepBusEval for each busRoot BEFORE signal eval

**Validation**:
- Create IR execution test that publishes to bus and reads from listener
- Verify StepBusEval appears in schedule.steps
- Verify bus value changes when publisher changes

### Priority 2: Non-numeric Bus Combine
**Effort**: 2-3 hours
**Steps**:
1. Branch on `TypeDesc.domain` in `combineValues()`
2. Implement `combineVec2()`, `combineVec3()`, `combineColor()`
3. Add silent value policies for non-numeric domains
4. Add tests for vec2/vec3/color buses

### Priority 3: Field Bus Execution
**Effort**: 6-8 hours (complex)
**Steps**:
1. Define StepFieldBusEval in schedule IR
2. Implement executeFieldBusEval (materialize → combine → write)
3. Emit StepFieldBusEval in buildSchedule
4. Add integration test

---

## Workflow Recommendation
- [X] PAUSE - Critical ambiguities and infrastructure gaps
- [ ] CONTINUE

### Clarification Needed Before Proceeding

#### Question 1: busRoots Storage in IRBuilder
**Context**: Pass7 creates busRoots but IRBuilder has no API to store them
**How it was guessed**: Assumed they'd be stored in builder (not documented)
**Options**:
- **Option A**: Add busRoots to IRBuilder (stores Map, converts to array in build())
- **Option B**: Thread busRoots separately alongside BuilderProgramIR
- **Option C**: Modify pass7 to emit StepBusEval directly (bypass builder)

**Impact of wrong choice**:
- Option A: Standard approach, consistent with other IR data
- Option B: Extra parameter threading, inconsistent with other passes
- Option C: Breaks separation of concerns (pass7 shouldn't emit schedule steps)

**Recommendation**: Option A (add to IRBuilder) - most consistent with architecture

#### Question 2: Non-numeric Combine Semantics
**Context**: executeBusEval only handles numbers, but buses can have vec2/vec3/color types
**How it was guessed**: Deferred to "future work" (not implemented)
**Options**:
- **Option A**: Component-wise arithmetic (vec2.sum = {x: sum(xs), y: sum(ys)})
- **Option B**: Type-specific semantics (color uses alpha composite for "layer")
- **Option C**: Emit compile error for non-numeric buses

**Impact of wrong choice**:
- Option A: Works for math types, wrong for color
- Option B: Correct but requires spec clarification for each domain
- Option C: Safest but blocks feature

**Recommendation**: Option C for now, then Option B once spec is complete

---

## Files Analyzed

### FRESH Assessment
- `src/editor/compiler/ir/buildSchedule.ts` (gap documented at line 14)
- `src/editor/compiler/ir/builderTypes.ts` (BuilderProgramIR has NO busRoots field)
- `src/editor/compiler/ir/IRBuilderImpl.ts` (build() does not include busRoots)
- `src/editor/compiler/passes/pass7-bus-lowering.ts` (creates busRoots Map)
- `src/editor/compiler/passes/pass8-link-resolution.ts` (threads busRoots)
- `src/editor/compiler/compileBusAware.ts` (calls builder.build())
- `src/editor/runtime/executor/steps/executeBusEval.ts` (numeric only)
- `src/editor/runtime/executor/steps/executeEventBusEval.ts` (complete)
- `src/editor/runtime/executor/ScheduleExecutor.ts` (dispatches bus eval)
- `src/editor/semantic/busSemantics.ts` (canonical ordering)

### Test Coverage
- `src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts` (7 tests, pass)
- `src/editor/runtime/executor/__tests__/executeBusEval.test.ts` (assumed to exist based on file listing)
- `src/editor/semantic/__tests__/busSemantics.test.ts` (41 tests, pass)

---

## Git Commit Context
Recent bus-related commits (2025-12-20 onwards):
- `9d6ccd6` feat(default-sources): Add cycle detection and edge case validation
- `c1d1367` feat(default-sources): Add allowlist and bus validation
- `7139829` fix(compiler): Emit compile-time errors for unsupported adapters/lenses in IR mode

No recent commits directly address bus execution gaps.

---

## Verdict Summary
**Bus system execution is 20% complete.**

✅ **What Works**:
- Pass7 bus lowering creates combine nodes
- Pass8 link resolution threads connections
- Runtime executors implemented (numeric buses and events)
- Publisher ordering is deterministic and canonical
- Tests pass (but don't exercise IR bus execution)

❌ **What's Broken**:
- **CRITICAL**: busRoots lost between Pass8 and buildSchedule
- **CRITICAL**: No StepBusEval emitted in schedule
- **HIGH**: Non-numeric buses not supported in runtime
- **MEDIUM**: Field buses have no execution step

**Next Action**: Fix Gap 1 and Gap 2 (add busRoots to IRBuilder and BuilderProgramIR), then emit StepBusEval in buildSchedule.
