# Lint Warning Cleanup - Sprint Plan
Generated: 2025-12-25-120000
Source: STATUS-2025-12-25.md
Topic: lint-cleanup

## Executive Summary

**Current State**: 973 lint issues (252 errors, 721 warnings) across the codebase.

**Gap Analysis**:
- 77 errors (31% of all errors) can be auto-fixed mechanically
- 695 warnings (96% of all warnings) are `functional/immutable-data` violations flagging intentional MobX mutations
- TransactionBuilder.ts has 29 `any`-related type errors concentrated in one file
- 107 `strict-boolean-expressions` errors require explicit null/undefined checks

**This Sprint Focus**: Three deliverables that clear the majority of mechanical issues and establish policy for architectural patterns.

**Total Items**: 3 high-priority deliverables + 1 documentation task

**Risk Assessment**:
- **Low Risk**: Auto-fix operations (verified by test suite)
- **Medium Risk**: ESLint configuration changes (requires team alignment on MobX mutation patterns)
- **High Risk**: TransactionBuilder typing (touches critical kernel code)

---

## Sprint Deliverables

### [P0] Deliverable 1: Auto-Fix Mechanical Issues

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None
**Spec Reference**: N/A (quality/tooling)
**Status Reference**: STATUS-2025-12-25.md § "Priority 1: Auto-fixable Errors"

#### Description
Run `eslint --fix` to mechanically resolve 77 auto-fixable errors:
- 67 unnecessary type assertions (mostly in test files)
- 10 class members that should be readonly

This is a safe mechanical operation that will reduce the error count from 252 to 175 with zero behavior changes.

#### Acceptance Criteria
- [ ] Run `pnpm exec eslint . --fix` successfully
- [ ] Verify error count reduced from 252 to ~175 by running `pnpm exec eslint .`
- [ ] Run `just test` - all tests must pass
- [ ] Run `just typecheck` - no new TypeScript errors introduced
- [ ] Commit changes with message: "chore: apply auto-fixable ESLint fixes (type assertions, readonly)"
- [ ] Verify `git diff` shows only the expected changes (type assertions removed, readonly added)

#### Technical Notes
- Most changes will be in test files (`__tests__/RadialOrigin.test.ts`, `__tests__/FlowFieldOrigin.test.ts`)
- The readonly changes affect class properties that are never reassigned
- This is a prerequisite for accurate metrics on remaining manual work

---

### [P0] Deliverable 2: ESLint Configuration Policy Decision

**Status**: Not Started
**Effort**: Small (2-3 hours including discussion)
**Dependencies**: Deliverable 1 (clean baseline)
**Spec Reference**: N/A (tooling policy)
**Status Reference**: STATUS-2025-12-25.md § "Priority 4: Immutability Warnings", § "Ambiguities and Questions #1"

#### Description
Resolve the `functional/immutable-data` rule configuration that currently generates 695 warnings. The rule conflicts with the codebase's architectural patterns:

1. **MobX stores** (`ViewStateStore.ts`, `UIStateStore.ts`, `DebugStore.ts`) use mutations for reactivity
2. **Compiler/runtime** (`compileBusAware.ts`, `DependencyGraph.ts`) use mutation for performance
3. **Kernel algorithms** (`diff.ts`, `applyOp.ts`) use standard graph traversal patterns with mutation

The rule was added with `TODO: Enable after reviewing violations` - this is that review.

**Recommended Approach**: Disable `functional/immutable-data` entirely OR scope it to exclude stores/compiler/kernel directories.

#### Acceptance Criteria
- [ ] Review top 10 files with most `functional/immutable-data` violations (listed in STATUS)
- [ ] Make policy decision: disable entirely, exclude directories, or keep as-is
- [ ] Update `eslint.config.js` with chosen approach and clear comment explaining rationale
- [ ] Run `pnpm exec eslint .` - if disabled/excluded, warning count should drop from ~721 to <50
- [ ] Document decision in `eslint.config.js` comment referencing MobX/compiler architecture
- [ ] Run `just check` to verify no unintended side effects
- [ ] Commit changes with message: "config: resolve functional/immutable-data rule policy"

#### Technical Notes
Example exclusion pattern if scoping instead of disabling:
```javascript
{
  files: ['**/stores/**', '**/compiler/**', '**/kernel/**', '**/runtime/**'],
  rules: {
    'functional/immutable-data': 'off'
  }
}
```

Or disable entirely:
```javascript
'functional/immutable-data': 'off', // Disabled: MobX stores and compiler use intentional mutations
```

---

### [P1] Deliverable 3: Fix TransactionBuilder.ts Type Safety

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: Deliverable 1, Deliverable 2 (clear metrics baseline)
**Spec Reference**: N/A (type safety improvement)
**Status Reference**: STATUS-2025-12-25.md § "Priority 2: Type Safety Errors", § "Ambiguities and Questions #2"

#### Description
TransactionBuilder.ts has 29 `any`-related type errors concentrated in one file (45% of all type safety errors). This indicates either:
- Type definitions degraded during refactoring
- Intentional escape hatches that need proper typing
- Missing generic constraints or type guards

This file is in the critical kernel path and should have strong type safety.

**Approach**:
1. Audit each `any` usage to understand intent
2. Replace with proper types, generics, or type guards
3. Add type assertions only where unavoidable (with comments explaining why)
4. Ensure no behavior changes

#### Acceptance Criteria
- [ ] Read `kernel/TransactionBuilder.ts` and document each `any` usage category
- [ ] Replace `any` with proper types (target: eliminate at least 20 of 29 errors)
- [ ] Add type guards where dynamic typing is unavoidable
- [ ] Run `just typecheck` - no new errors
- [ ] Run `just test` - all tests pass, especially `kernel/__tests__/` tests
- [ ] Run `pnpm exec eslint kernel/TransactionBuilder.ts` - verify error count reduced
- [ ] Add inline comments for any remaining `any` usage explaining necessity
- [ ] Commit with message: "fix: improve type safety in TransactionBuilder (kernel)"

#### Technical Notes
- This file likely uses `any` for dynamic operation types or field access patterns
- May need to introduce union types or discriminated unions for operations
- Consider generic constraints like `<T extends Operation>` instead of `any`
- Verify against kernel tests: `pnpm test kernel/` to ensure no behavior regression
- This is the highest-impact single file for type safety improvement

---

### [P2] Documentation: Update Lint Cleanup Progress

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: Deliverable 1, Deliverable 2, Deliverable 3
**Spec Reference**: N/A (documentation)
**Status Reference**: N/A (end-of-sprint activity)

#### Description
After completing deliverables, update project documentation to reflect lint cleanup progress and new ESLint policy.

#### Acceptance Criteria
- [ ] Run `pnpm exec eslint . --format json > lint-report.json` to capture final state
- [ ] Update `.agent_planning/lint-cleanup/STATUS-2025-12-25.md` with "Sprint 1 Completion" section
- [ ] Document remaining work (strict-boolean-expressions, other type safety issues)
- [ ] Add note in `eslint.config.js` header linking to this plan for context
- [ ] Commit with message: "docs: update lint cleanup progress after sprint 1"

#### Technical Notes
This provides a clear checkpoint for future work and explains policy decisions to other developers.

---

## Dependency Graph

```
Deliverable 1 (Auto-fix)
    ↓
Deliverable 2 (ESLint Policy) ←-┐
    ↓                            |
Deliverable 3 (TransactionBuilder) ← (can run in parallel)
    ↓
Documentation Update
```

Deliverables 2 and 3 can partially overlap, but Deliverable 1 should complete first for clean metrics.

---

## Recommended Sprint Execution Order

**Day 1**:
1. Execute Deliverable 1 (auto-fix) - should take <2 hours
2. Review results and verify tests
3. Begin Deliverable 2 (policy decision) - review files, make decision

**Day 2-3**:
4. Complete Deliverable 2 (update config, verify)
5. Start Deliverable 3 (audit TransactionBuilder.ts)

**Day 4-5**:
6. Complete Deliverable 3 (type replacements, testing)
7. Final verification across all deliverables

**Day 6**:
8. Complete documentation update
9. Final `just check` verification

---

## Out of Scope (Deferred to Future Sprints)

The following issues are **not** addressed in this sprint:

1. **107 `strict-boolean-expressions` errors** - Require manual null checks
   - Deferred: Medium effort (1-2 weeks), lower priority than type safety
   - Affects: DebugStore.ts (23), canvasRenderer.ts (20), TransactionBuilder.ts (19)

2. **Remaining type safety errors** (after TransactionBuilder cleanup) - ~16 errors in other files
   - Deferred: Each requires individual analysis
   - Affects: UnifiedCompiler.ts (7), RuntimeAdapter.ts (6), others (3)

3. **Test file type assertions** (if any remain after auto-fix)
   - Deferred: Lower priority, tests are passing

4. **React Hooks exhaustive-deps warnings** (5 warnings)
   - Deferred: UI-only, not critical path

5. **Pre-commit hook setup** - Prevent new violations
   - Deferred: Requires clean baseline first

---

## Success Metrics

**Before Sprint**:
- Total issues: 973 (252 errors, 721 warnings)
- Auto-fixable: 77
- Type safety errors: 64 (29 in TransactionBuilder.ts alone)
- Immutability warnings: 695

**After Sprint Target**:
- Total issues: <250 (target ~175 errors, ~25 warnings)
- Auto-fixable: 0
- Type safety errors: <45 (eliminate 20+ from TransactionBuilder.ts)
- Immutability warnings: <50 (policy decision applied)
- ESLint policy: Documented and aligned with MobX architecture

**Reduction**: ~74% reduction in total issues (973 → ~250)

---

## Risk Assessment

### High-Risk Items

**Deliverable 3 (TransactionBuilder typing)**:
- **Risk**: Behavior changes in critical kernel code
- **Mitigation**: Comprehensive test coverage in `kernel/__tests__/`, verify against existing tests before/after
- **Fallback**: If typing proves too complex, add `eslint-disable` comments with TODO for future work

### Medium-Risk Items

**Deliverable 2 (ESLint policy)**:
- **Risk**: Team disagreement on mutation patterns
- **Mitigation**: Document rationale clearly, reference MobX architecture patterns
- **Fallback**: Keep as warnings instead of disabling (status quo)

### Low-Risk Items

**Deliverable 1 (Auto-fix)**:
- **Risk**: Minimal - mechanical transformations
- **Mitigation**: Test suite verification
- **Fallback**: Easy to revert via git

---

## Blockers and Questions

**None identified** - The STATUS report provides clear evidence and the path forward is actionable.

If during execution we discover:
1. TransactionBuilder typing requires kernel architecture changes → pause and reassess
2. Test failures after auto-fix → investigate root cause before proceeding
3. Team disagreement on ESLint policy → escalate for alignment

Otherwise, proceed with implementation.

---

## Notes

- All file paths in STATUS are relative to repo root `/Users/bmf/code/oscilla-animator_codex/`
- ESLint config is at `/Users/bmf/code/oscilla-animator_codex/eslint.config.js`
- Test command: `just test` (uses pnpm under the hood)
- The codebase uses MobX for state management - mutations are architectural, not bugs
- TransactionBuilder is in the kernel layer - high correctness requirements
