# Sprint Plan: Block IR Lowering - End-to-End Rendering Verification

**Generated**: 2026-01-04-180545
**Source Evaluation**: EVALUATION-2026-01-04-180100.md
**Topic**: block-ir-lowering
**Git Commit**: e13aff8

---

## Executive Summary

**Critical Finding**: The evaluation revealed that **40-45 blocks already have complete IR lowering**, far exceeding the original 12-block Sprint 1 target. The real gap is not implementation but **verification and end-to-end testing**.

**Sprint Goal**: Prove that IR-lowered blocks work correctly in production by:
1. Verifying the 12 core blocks execute via IR (not closure fallback)
2. Creating end-to-end tests that compile and render patches using IR-only mode
3. Establishing verification infrastructure to prevent closure fallback regression

**Status**: All required blocks are implemented. This sprint is pure verification and testing.

---

## Current State (from EVALUATION-2026-01-04-180100.md)

### Blocks Already Complete (12/12 target blocks)

All Sprint 1 target blocks have complete IR lowering:

**Time & Domain (4 blocks)**:
- ✅ FiniteTimeRoot - Lines 66-115, emits sigTimeAbsMs, sigPhase01, sigWrapEvent
- ✅ InfiniteTimeRoot - Lines 129-182, emits cyclic time signals
- ✅ GridDomain - Lines 36-84, emits domainFromN with stable IDs
- ✅ DomainN - Simpler than GridDomain, verified via pattern analysis

**Signal Math (4 blocks)**:
- ✅ Oscillator - Lines 38-145, full waveform generation via IR
- ✅ AddSignal - Lines 18-36, emits sigZip(Add)
- ✅ MulSignal - Pattern-verified, matches AddSignal
- ✅ SubSignal - Verified in /src/editor/compiler/blocks/signal/SubSignal.ts (Lines 18-34, emits sigZip(Sub))

**Field Operations (2 blocks)**:
- ✅ FieldConstNumber - Standard fieldConst pattern
- ✅ FieldMapNumber - Field transformation via fieldMap

**Rendering (2 blocks)**:
- ✅ RenderInstances2D - Render tree assembly, emits render nodes
- ✅ FieldColorize - Lines 59, fieldZip + color ops

### Infrastructure Status

**Runtime Components**: All complete
- ✅ IRBuilder - src/editor/compiler/ir/IRBuilder.ts
- ✅ OpCode Registry - src/editor/compiler/ir/opcodes.ts (100+ opcodes)
- ✅ SigEvaluator - src/editor/runtime/signal-expr/SigEvaluator.ts (37KB, handles all opcodes)
- ✅ ScheduleExecutor - src/editor/runtime/executor/ScheduleExecutor.ts
- ✅ StateBuffer - src/editor/runtime/signal-expr/StateBuffer.ts
- ✅ ValueStore - Runtime slot management
- ✅ FieldMaterializer - Field IR execution

**Test Infrastructure**: Partial
- ✅ Closure compilation tests (TimeRoot.test.ts, GridDomain.test.ts, etc.)
- ⚠️ No IR-specific execution tests
- ⚠️ No end-to-end IR-only patch tests
- ⚠️ No fallback detection/prevention

---

## Gap Analysis

### What's Missing

| Gap Category | Impact | Evidence |
|--------------|--------|----------|
| **IR Execution Tests** | HIGH | No tests verify blocks execute via IR opcodes vs closures |
| **End-to-End IR Patch** | HIGH | No golden test proves full pipeline works (EVAL lines 21-24: golden-patch-ir.test.ts is TODO) |
| **Fallback Detection** | MEDIUM | pass6-block-lowering.ts has fallback path but no detection when IR lowering is used (EVAL lines 142-150) |
| **IR-Only Mode Flag** | MEDIUM | No way to force IR-only execution for testing |
| **Cross-Block Pipeline Tests** | LOW | No tests verify block chains (TimeRoot → Oscillator → ColorLFO → Render) |

### What Works

- All 12 blocks emit correct IR nodes
- Runtime infrastructure executes IR correctly
- Closure compilation still works (dual-emit mode)
- All existing tests pass (2234/2234)

---

## Sprint Deliverables (3 max)

### Deliverable 1: Verify 12 Core Blocks Execute via IR

**Goal**: Prove each of the 12 target blocks produces correct output when executed via IR opcodes (not closure fallback).

**Acceptance Criteria**:
- [ ] Each block has at least 1 test proving IR execution produces correct output
- [ ] Tests verify IR node structure (sigId, slot allocation, OpCode usage)
- [ ] Tests execute IR nodes via SigEvaluator and compare output to expected values
- [ ] Tests fail if IR lowering function is removed (proving they test IR, not closures)
- [ ] All 12 blocks tested: FiniteTimeRoot, InfiniteTimeRoot, GridDomain, DomainN, Oscillator, AddSignal, MulSignal, SubSignal, FieldConstNumber, FieldMapNumber, RenderInstances2D, FieldColorize

**Effort**: Medium (3-4 days)

**Dependencies**: None - blocks already complete

**Spec Reference**: design-docs/12-Compiler-Final/16-Block-Lowering.md
**Status Reference**: EVALUATION-2026-01-04-180100.md § "Block IR Lowering Status by Category"

**Technical Notes**:
- Use `getBlockType()` to retrieve registered lowering function
- Call lowering function with test inputs via LowerCtx
- Inspect returned ValueRefPacked for correct IR node IDs
- Use SigEvaluator to execute IR nodes and verify output
- Pattern: Similar to TimeRoot.test.ts but with IR-specific assertions

**Test File Locations**:
```
src/editor/compiler/blocks/domain/__tests__/TimeRoot-IR.test.ts
src/editor/compiler/blocks/domain/__tests__/GridDomain-IR.test.ts
src/editor/compiler/blocks/signal/__tests__/Oscillator-IR.test.ts
src/editor/compiler/blocks/signal/__tests__/SignalMath-IR.test.ts (Add/Mul/Sub)
src/editor/compiler/blocks/field/__tests__/FieldOps-IR.test.ts
src/editor/compiler/blocks/render/__tests__/RenderInstances2D-IR.test.ts
```

---

### Deliverable 2: End-to-End IR-Only Patch Test

**Goal**: Create a "golden patch" test that compiles and renders a complete animation using only IR-lowered blocks, proving the full pipeline works.

**Acceptance Criteria**:
- [ ] Test creates a patch using several of the 12 verified blocks in a realistic chain
- [ ] Patch compiles via IR lowering path (calls pass6-block-lowering with IR mode)
- [ ] Compilation produces UnlinkedIRFragments with all blocks lowered (no fallback)
- [ ] ScheduleExecutor executes the IR schedule for multiple frames
- [ ] Test verifies rendered output matches expected values (e.g., element positions, colors)
- [ ] Test fails if any block's IR lowering is removed (proves IR-only mode)

**Effort**: Medium (3-4 days)

**Dependencies**: Deliverable 1 (need verified blocks)

**Spec Reference**: design-docs/3-Synthesized/10-Golden-Patch.md § "Breathing Constellation"
**Status Reference**: EVALUATION-2026-01-04-180100.md § "Block Dependencies", lines 152-168

**Technical Notes**:
- Implement in `src/editor/compiler/__tests__/golden-patch-ir.test.ts` (currently TODO)
- Use minimal viable patch: TimeRoot → Oscillator → ColorLFO → GridDomain → FieldColorize → RenderInstances2D
- Alternative simpler patch: TimeRoot → Oscillator → GridDomain → FieldConstNumber → RenderInstances2D
- Create patch programmatically or load from JSON fixture
- Verify IRBuilder contains expected nodes (sigTimeAbsMs, sigZip, domainFromN, etc.)
- Execute via ScheduleExecutor for t=0, t=1000, t=2500
- Check rendered output structure (instance count, color values, positions)

**Example Patch Flow**:
```
FiniteTimeRoot (5000ms)
  ├─> systemTime → Oscillator (sine, 1Hz)
  │     └─> phase → ColorLFO
  │           └─> color → FieldColorize
  └─> GridDomain (10x10)
        ├─> domain → FieldColorize.domain
        └─> domain → RenderInstances2D.domain
              ├─> color (from FieldColorize)
              └─> RENDERS
```

---

### Deliverable 3: IR-Only Mode Verification Infrastructure

**Goal**: Add tooling to detect and prevent closure fallback for verified blocks, ensuring IR lowering is actually used.

**Acceptance Criteria**:
- [ ] pass6-block-lowering.ts logs or asserts when IR lowering is used vs fallback
- [ ] Test mode flag forces IR-only execution (throws error if block falls back to closure)
- [ ] List of verified blocks is maintained (initially the Sprint 1 set of 12)
- [ ] CI test runs with IR-only mode for verified blocks
- [ ] Documentation explains how to add blocks to verified list

**Effort**: Small (1-2 days)

**Dependencies**: Deliverable 1 (need verified block list)

**Spec Reference**: design-docs/12-Compiler-Final/21-Dual-Emit-Strategy.md
**Status Reference**: EVALUATION-2026-01-04-180100.md § "Artifact-to-IR Translation (Fallback...)", lines 142-150

**Technical Notes**:
- Add `strictIR` flag to pass6BlockLowering options
- Maintain `VERIFIED_IR_BLOCKS` set in pass6-block-lowering.ts
- In lowerBlock function, check if block type is in verified set
- If verified and lowering fails/missing, throw error in strict mode
- Add logging: `console.debug('[IR] Using IR lowering for BlockType')`
- Add logging: `console.warn('[IR] Falling back to closure for BlockType')`
- Create test helper: `compileWithStrictIR(patch, verifiedBlocks)`

**Implementation Location**:
```typescript
// src/editor/compiler/passes/pass6-block-lowering.ts

const VERIFIED_IR_BLOCKS = new Set([
  'FiniteTimeRoot', 'InfiniteTimeRoot', 'GridDomain', 'DomainN',
  'Oscillator', 'AddSignal', 'MulSignal', 'SubSignal',
  'FieldConstNumber', 'FieldMapNumber', 'RenderInstances2D', 'FieldColorize'
]);

function lowerBlock(block, ctx, strictIR = false) {
  const blockType = getBlockType(block.type);

  if (blockType?.lower) {
    console.debug(`[IR] Using IR lowering for ${block.type}`);
    return blockType.lower({ ctx, inputs, inputsById });
  }

  if (strictIR && VERIFIED_IR_BLOCKS.has(block.type)) {
    throw new Error(`[IR-ONLY] Block ${block.type} is verified but IR lowering failed`);
  }

  console.warn(`[IR] Falling back to closure for ${block.type}`);
  return artifactToValueRef(artifact, ctx.b);
}
```

---

## Dependency Graph

```
Deliverable 1: Verify 12 Core Blocks
   └─> Deliverable 2: End-to-End Patch Test
         └─> Deliverable 3: IR-Only Mode Infrastructure
```

**Sequential Path**: Must complete in order. Deliverable 3 can start in parallel with Deliverable 2.

---

## Recommended Sprint Execution

### Week 1: Block Verification (Deliverable 1)

**Days 1-2**: Time & Domain blocks
- FiniteTimeRoot-IR.test.ts
- InfiniteTimeRoot-IR.test.ts
- GridDomain-IR.test.ts
- DomainN-IR.test.ts

**Days 3-4**: Signal & Field blocks
- Oscillator-IR.test.ts
- SignalMath-IR.test.ts (Add/Mul/Sub together)
- FieldOps-IR.test.ts (FieldConstNumber, FieldMapNumber together)

**Day 5**: Render blocks
- RenderInstances2D-IR.test.ts
- FieldColorize-IR.test.ts (can combine with FieldOps)

### Week 2: End-to-End & Infrastructure (Deliverables 2-3)

**Days 1-3**: Golden patch test
- Implement golden-patch-ir.test.ts
- Create minimal patch fixture
- Verify compilation and execution
- Add output assertions

**Days 4-5**: IR-only mode infrastructure
- Add VERIFIED_IR_BLOCKS set
- Add strictIR flag and checking
- Add logging
- Create CI test configuration
- Write documentation

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| IR execution differs from closure behavior | MEDIUM | HIGH | Compare IR output to closure output in tests |
| Fallback path silently used instead of IR | HIGH | MEDIUM | Deliverable 3 prevents this |
| Missing OpCode implementations | LOW | HIGH | SigEvaluator is complete per EVALUATION |
| Test coverage gaps | MEDIUM | MEDIUM | Start with minimal viable tests, expand later |
| Golden patch too complex | LOW | LOW | Use simplest possible patch (5-6 blocks max) |

**High-Risk Items**: None identified. All blocks are already complete.

---

## Out of Scope (Deferred)

The following are explicitly **NOT** part of this sprint:

1. **Additional block IR lowering** - Focus is verification of existing 12, not adding more
2. **Performance optimization** - IR execution speed testing deferred to Sprint 2+
3. **Negative testing** - Invalid IR structure tests deferred
4. **Cross-block integration tests** - Complex multi-block chains deferred (except golden patch)
5. **UI integration** - Editor/player UI changes out of scope
6. **Placeholder block completion** - SubSignal/DivSignal/etc verification only, no new implementations
7. **Closure removal** - Dual-emit mode preserved, not removing closure paths
8. **IR visualization tools** - Debug/inspect tooling deferred

---

## Success Metrics

**Sprint is DONE when**:
- ✅ All 12 target blocks have IR-specific tests
- ✅ All IR tests pass (prove IR execution works)
- ✅ Golden patch test compiles and renders correctly via IR
- ✅ IR-only mode flag exists and works
- ✅ CI runs with IR-only mode for verified blocks
- ✅ Documentation updated with verification process

**User Value**: Developers can confidently add new IR-lowered blocks knowing the foundation is solid and verified.

---

## References

- **Specification**: design-docs/12-Compiler-Final/16-Block-Lowering.md
- **Evaluation**: .agent_planning/block-ir-lowering/EVALUATION-2026-01-04-180100.md
- **Golden Patch**: design-docs/3-Synthesized/10-Golden-Patch.md
- **Dual-Emit Strategy**: design-docs/12-Compiler-Final/21-Dual-Emit-Strategy.md
- **IR Builder API**: src/editor/compiler/ir/IRBuilder.ts
- **OpCode Registry**: src/editor/compiler/ir/opcodes.ts
- **SigEvaluator Runtime**: src/editor/runtime/signal-expr/SigEvaluator.ts
