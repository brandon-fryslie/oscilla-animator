# Definition of Done: Block IR Lowering Verification Sprint

**Generated**: 2026-01-04-180545
**Plan**: PLAN-2026-01-04-180545.md
**Source Evaluation**: EVALUATION-2026-01-04-180100.md

---

## Sprint Scope

This sprint delivers **VERIFICATION** of existing IR-lowered blocks, not new implementations.

**Delivers**: 3 deliverables proving 12 core blocks work in IR-only mode
**Deferred**: Additional block implementations, performance testing, UI integration

---

## Acceptance Criteria

### Deliverable 1: Verify 12 Core Blocks Execute via IR

**Block Coverage (12 blocks total)**:
- [ ] FiniteTimeRoot has IR execution test in `src/editor/compiler/blocks/domain/__tests__/TimeRoot-IR.test.ts`
- [ ] InfiniteTimeRoot has IR execution test in `src/editor/compiler/blocks/domain/__tests__/TimeRoot-IR.test.ts`
- [ ] GridDomain has IR execution test in `src/editor/compiler/blocks/domain/__tests__/GridDomain-IR.test.ts`
- [ ] DomainN has IR execution test in `src/editor/compiler/blocks/domain/__tests__/DomainN-IR.test.ts`
- [ ] Oscillator has IR execution test in `src/editor/compiler/blocks/signal/__tests__/Oscillator-IR.test.ts`
- [ ] AddSignal has IR execution test in `src/editor/compiler/blocks/signal/__tests__/SignalMath-IR.test.ts`
- [ ] MulSignal has IR execution test in `src/editor/compiler/blocks/signal/__tests__/SignalMath-IR.test.ts`
- [ ] SubSignal has IR execution test in `src/editor/compiler/blocks/signal/__tests__/SignalMath-IR.test.ts`
- [ ] FieldConstNumber has IR execution test in `src/editor/compiler/blocks/field/__tests__/FieldOps-IR.test.ts`
- [ ] FieldMapNumber has IR execution test in `src/editor/compiler/blocks/field/__tests__/FieldOps-IR.test.ts`
- [ ] RenderInstances2D has IR execution test in `src/editor/compiler/blocks/render/__tests__/RenderInstances2D-IR.test.ts`
- [ ] FieldColorize has IR execution test in `src/editor/compiler/blocks/field/__tests__/FieldOps-IR.test.ts`

**Test Quality**:
- [ ] Each test calls `getBlockType(blockName)` to retrieve registered lowering function
- [ ] Each test creates a LowerCtx with IRBuilder and calls the lowering function
- [ ] Each test verifies returned ValueRefPacked has correct IR node structure (sigId/domainId/fieldId/renderId)
- [ ] Each test verifies IRBuilder contains expected nodes (e.g., sigZip with OpCode.Add for AddSignal)
- [ ] Each test uses SigEvaluator/FieldMaterializer to execute IR nodes and verify output values
- [ ] Each test fails if the block's IR lowering function is removed (proves it tests IR, not closures)

**Test Execution**:
- [ ] All 12 block IR tests pass when run via `just test`
- [ ] No test warnings or skipped tests
- [ ] Tests run in under 5 seconds total

---

### Deliverable 2: End-to-End IR-Only Patch Test

**Patch Implementation**:
- [ ] Test implemented in `src/editor/compiler/__tests__/golden-patch-ir.test.ts` (replaces TODO)
- [ ] Test creates patch with minimal viable block chain (5-6 blocks from verified set)
- [ ] Patch includes: TimeRoot → Signal generator → Domain → Field operations → Render
- [ ] Example: FiniteTimeRoot → Oscillator → GridDomain → FieldColorize → RenderInstances2D

**Compilation Verification**:
- [ ] Test calls pass6-block-lowering to compile patch into UnlinkedIRFragments
- [ ] Test verifies all blocks in patch have IR lowering (no fallback to closures)
- [ ] Test inspects IRBuilder to confirm presence of expected IR nodes:
  - [ ] sigTimeAbsMs (from TimeRoot)
  - [ ] sigZip with OpCode.Sin/Cos (from Oscillator)
  - [ ] domainFromN (from GridDomain)
  - [ ] fieldZip (from FieldColorize)
  - [ ] renderNode (from RenderInstances2D)

**Execution Verification**:
- [ ] Test creates ScheduleExecutor from compiled IR
- [ ] Test executes schedule for at least 3 time points (e.g., t=0ms, t=1000ms, t=2500ms)
- [ ] Test verifies execution completes without errors
- [ ] Test verifies output values are correct at each time point:
  - [ ] Domain element count matches expected (e.g., 100 elements for 10x10 grid)
  - [ ] Field values are in valid range (e.g., colors are 0-1, positions are correct)
  - [ ] Signal values change over time as expected (e.g., oscillator phase advances)

**IR-Only Enforcement**:
- [ ] Test removes one block's IR lowering function and verifies test fails
- [ ] Test confirms no closure artifacts are executed (only IR nodes)

---

### Deliverable 3: IR-Only Mode Verification Infrastructure

**Code Changes**:
- [ ] `VERIFIED_IR_BLOCKS` set added to `src/editor/compiler/passes/pass6-block-lowering.ts`
- [ ] Set contains all 12 Sprint 1 blocks initially
- [ ] `strictIR` flag added to `pass6BlockLowering()` options parameter
- [ ] When `strictIR=true` and block is in VERIFIED_IR_BLOCKS, throw error if IR lowering is missing/fails

**Logging**:
- [ ] `console.debug('[IR] Using IR lowering for <BlockType>')` emitted when IR lowering is used
- [ ] `console.warn('[IR] Falling back to closure for <BlockType>')` emitted when fallback occurs
- [ ] Logs include block type and block ID for debugging

**Test Helpers**:
- [ ] Test helper function `compileWithStrictIR(patch, verifiedBlocks)` created
- [ ] Helper sets `strictIR=true` and validates compilation
- [ ] Helper used in golden-patch-ir.test.ts
- [ ] Helper exports from `src/editor/compiler/__tests__/test-helpers.ts` or similar

**CI Integration**:
- [ ] New test file `src/editor/compiler/__tests__/ir-only-mode.test.ts` created
- [ ] Test runs golden patch with strictIR mode enabled
- [ ] Test verifies all VERIFIED_IR_BLOCKS compile without fallback
- [ ] Test passes in CI (run via `just test`)

**Documentation**:
- [ ] README or inline comment explains VERIFIED_IR_BLOCKS set
- [ ] Instructions for adding blocks to verified set documented
- [ ] Example shows how to use strictIR flag in tests

---

## Sprint Deliverables Summary

This sprint delivers:

1. **12 verified IR-lowered blocks** - Each has a test proving IR execution works correctly
2. **End-to-end golden patch test** - Proves full pipeline compiles and renders via IR
3. **IR-only mode infrastructure** - Prevents regression and enforces IR usage for verified blocks

---

## Deferred Work

The following are **NOT** in this sprint (captured for future):

1. **Additional block IR lowering** - Only verify existing 12, don't implement more
2. **Performance benchmarks** - IR vs closure execution speed testing
3. **Negative testing** - Invalid IR structure, malformed opcodes
4. **Complex cross-block tests** - Multi-block pipelines beyond golden patch
5. **Placeholder block completion** - DivSignal, MaxSignal, FieldFromExpression, etc.
6. **Closure removal** - Keep dual-emit mode, don't remove closure paths
7. **IR visualization tools** - Debug/inspect UI for IR graphs
8. **Incremental compilation** - Patch hot-swapping with IR

---

## Definition of DONE

**Sprint is DONE when ALL of the following are true**:

✅ **Tests Pass**:
- [ ] All 12 block IR tests pass (`just test`)
- [ ] Golden patch IR test passes
- [ ] IR-only mode test passes
- [ ] No skipped or failing tests
- [ ] CI is green

✅ **Code Quality**:
- [ ] All acceptance criteria checked above
- [ ] No TypeScript errors (`just typecheck`)
- [ ] No lint errors (`just lint-fix`)
- [ ] Code reviewed (self-review at minimum)

✅ **Documentation**:
- [ ] VERIFIED_IR_BLOCKS set documented
- [ ] strictIR flag usage documented
- [ ] Test patterns documented (how to write IR block tests)

✅ **Verification**:
- [ ] Manually run golden patch test and inspect output
- [ ] Manually run IR-only mode test with strictIR=true
- [ ] Verify logs show "[IR] Using IR lowering" for all 12 blocks
- [ ] Verify no "[IR] Falling back to closure" warnings for verified blocks

---

## User-Facing Success

**What the user can do after this sprint**:
1. Run `just test` and see all 12 IR blocks verified
2. Compile patches knowing IR lowering works for core blocks
3. Add new IR-lowered blocks and verify them using the same test pattern
4. Enable strictIR mode to catch IR lowering bugs early

**What the user can see**:
- Test output shows 12+ new IR tests passing
- Golden patch test output shows end-to-end rendering working
- Console logs show which blocks use IR vs fallback
- CI dashboard shows IR-only mode tests passing

---

## Next Steps (After Sprint)

Once this sprint is DONE, the next logical steps are:

1. **Sprint 2**: Add IR lowering for remaining 30-35 blocks (ColorLFO, Shaper, EnvelopeAD, etc.)
2. **Sprint 3**: Performance optimization (benchmark IR execution speed)
3. **Sprint 4**: Remove closure fallback (IR-only mode becomes default)
4. **Sprint 5**: IR visualization and debugging tools

**Prerequisite for all future work**: This sprint's verification infrastructure must be in place.
