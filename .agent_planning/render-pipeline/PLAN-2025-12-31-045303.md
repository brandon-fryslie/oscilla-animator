# Sprint Plan: Render Pipeline Completion
**Generated**: 2025-12-31-045303
**Source**: STATUS-20251231.md
**Plan Ref**: plans/ir-compiler-backlog-streams/06-render-pipeline.md

---

## Executive Summary

**Current State**: 90% complete (5.5/6 gaps functional)
**Remaining Work**: 3 critical items blocking COMPLETE status
**Sprint Goal**: Deliver fully functional, tested render pipeline with zero stubs

The render pipeline implementation has made substantial progress with 6/6 gaps implemented at the code level. However, based on the updated COMPLETE definition (requires full implementation, passing tests, no stubs), **3 critical gaps remain**:

1. **Type errors block test execution** (6 mock objects missing `debugProbes` field)
2. **ClipGroup rendering is stubbed** (logs warning, doesn't render children)
3. **ColorGrade effect is stubbed** (requires pixel manipulation via ImageData)
4. **No automated tests exist** for any of the 6 render features

**Recommended Sprint Scope**: 2 deliverables over 2-3 days
- **Deliverable 1**: Fix blockers (type errors + complete ClipGroup + complete ColorGrade)
- **Deliverable 2**: Automated test suite for all 6 gaps

---

## Gap Analysis

### Comparison: STATUS vs Specification

| Feature | Spec Requirement | Current Reality | Gap |
|---------|-----------------|-----------------|-----|
| Z-Order | Render passes sorted by z-index | ✅ Implemented, untested | Tests missing |
| Curve Flattening | Bezier curves flatten to line segments | ✅ Implemented, untested | Tests missing |
| Clipping/Masking | Rect/circle/path clipping regions | ⚠️ Rect/circle OK, ClipGroup stubbed | ClipGroup rendering + tests |
| Per-Instance Attrs | Rotation, scaleXY per instance | ✅ Implemented, untested | Tests missing |
| PostFX | Blur, bloom, vignette, colorGrade | ⚠️ 3/4 effects, ColorGrade stubbed | ColorGrade impl + tests |
| Gradient Materials | Linear/radial gradients with stops | ✅ Implemented, untested | Tests missing |

**Critical Gaps**:
1. **ClipGroup rendering** (canvasRenderer.ts:253-255) - stubbed with warning
2. **ColorGrade effect** (renderPostFX.ts:180-188) - stubbed with warning
3. **Test suite** - zero automated tests for render features
4. **Type errors** - block running any tests

---

## Prioritized Backlog

### P0 (Critical): Fix Type Errors

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: None
**Spec Reference**: N/A (build hygiene) • **Status Reference**: STATUS-20251231.md § Test Suite Assessment

#### Description

TypeScript compilation fails before tests can run due to missing `debugProbes` field in 6 mock `BuilderProgramIR` objects in `state-offset-resolution.test.ts`. This is **unrelated to render pipeline work** but is a **blocking issue** that prevents validating any implementation.

**Root Cause**: Mock objects in test file don't match current `BuilderProgramIR` type schema.

**Fix**: Add `debugProbes: []` to each mock object at lines (exact lines from type error output).

#### Acceptance Criteria

- [ ] All 6 mock objects in `state-offset-resolution.test.ts` include `debugProbes: []` field
- [ ] TypeScript compilation succeeds (`just typecheck` passes)
- [ ] All existing tests pass (`just test` passes with no failures)
- [ ] No new type errors introduced

#### Technical Notes

- This is a simple mechanical fix: find each mock `BuilderProgramIR` and add the missing field
- Verify with `just check` (runs typecheck + lint + test)
- **Must be completed first** - unblocks all other validation work

---

### P0 (Critical): Implement ClipGroup Rendering

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0 type errors (for test execution)
**Spec Reference**: plans/SPEC-04-render-pipeline.md § Clipping/Masking • **Status Reference**: STATUS-20251231.md § Gap 3

#### Description

ClipGroup passes are defined in IR types and dispatched correctly, but **rendering is stubbed**. The renderer logs "ClipGroup pass rendering not implemented" and returns without rendering children. This means **any patch using ClipGroup will silently fail** to render clipped content.

**Current Stub** (canvasRenderer.ts:253-255):
```typescript
case 'ClipGroup':
  console.warn('ClipGroup pass rendering not implemented');
  return;
```

**Required Implementation**:
1. Apply clipping region from `pass.clip` spec (rect, circle, or path)
2. Recursively render all child passes in `pass.children`
3. Restore canvas state after children render

#### Acceptance Criteria

- [ ] ClipGroup case in canvasRenderer.ts implements full rendering logic (no stub)
- [ ] Canvas state saved before applying clip (`ctx.save()`)
- [ ] Clip applied via `applyPassHeader()` for rect/circle specs
- [ ] All child passes rendered recursively via `this.renderPass()` for each child
- [ ] Canvas state restored after children (`ctx.restore()`)
- [ ] Path-based clipping implemented or documented as deferred (see Technical Notes)

#### Technical Notes

**Rect and Circle Clipping**: Already implemented in `renderPassExecutors.ts:178-206` via `applyPassHeader()`. Just need to call it and then render children.

**Path-based Clipping**: Currently marked as unimplemented (line 196). Two options:
- **Option A**: Implement path decoding and `ctx.clip(path2d)` (adds 1-2 hours)
- **Option B**: Document as limitation, throw error if path clip is used (faster, defer to future sprint)

**Recommended**: Option B for this sprint - path clipping is rarely used, rect/circle covers 95% of use cases.

**Implementation Pattern** (pseudocode):
```typescript
case 'ClipGroup': {
  ctx.save();
  applyPassHeader(ctx, pass.header); // applies clip
  for (const child of pass.children) {
    this.renderPass(child, ctx); // recursive
  }
  ctx.restore();
  break;
}
```

---

### P1 (High): Implement ColorGrade Effect

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: P0 type errors (for test execution)
**Spec Reference**: plans/SPEC-04-render-pipeline.md § PostFX • **Status Reference**: STATUS-20251231.md § Gap 5

#### Description

ColorGrade effect is the only PostFX variant that's stubbed. It requires pixel-level manipulation via `ImageData` API to apply a color transformation matrix. Without this, patches using ColorGrade will **log warnings instead of rendering the effect**.

**Current Stub** (renderPostFX.ts:180-188):
```typescript
case 'ColorGrade': {
  console.warn('ColorGrade effect not implemented (requires ImageData)');
  // TODO: implement pixel manipulation
  break;
}
```

**Required Implementation**:
1. Get `ImageData` from source canvas
2. Apply color matrix to each pixel's RGB channels
3. Put modified `ImageData` back to destination canvas

#### Acceptance Criteria

- [ ] ColorGrade case in renderPostFX.ts implements pixel manipulation (no stub)
- [ ] Source canvas converted to ImageData via `ctx.getImageData()`
- [ ] Color matrix applied to RGB channels for each pixel
- [ ] Alpha channel preserved or transformed correctly
- [ ] Modified ImageData written to destination via `ctx.putImageData()`
- [ ] Color matrix parameters read from `effect.matrix` field (or default identity matrix)

#### Technical Notes

**Color Matrix Format**: Typically 4x4 or 5x4 matrix applied as:
```
R' = m[0]*R + m[1]*G + m[2]*B + m[3]*A + m[4]
G' = m[5]*R + m[6]*G + m[7]*B + m[8]*A + m[9]
B' = m[10]*R + m[11]*G + m[12]*B + m[13]*A + m[14]
A' = m[15]*R + m[16]*G + m[17]*B + m[18]*A + m[19]
```

**Simplification**: If `effect.matrix` is undefined, use **3x3 identity matrix** (no transformation) for testing.

**Performance**: `ImageData` pixel manipulation is CPU-bound and slow for large canvases. Consider:
- Clamping output to 0-255 range
- Using `Uint8ClampedArray` directly for faster access
- Deferring GPU-based implementation to future sprint

**Edge Cases**:
- Empty canvas → no-op
- Invalid matrix → fallback to identity or throw error
- Out of bounds → clamp to [0, 255]

**Reference Implementation**: MDN ImageData API docs, common color grading algorithms (sepia, grayscale, contrast, etc.)

---

### P2 (Medium): Create Automated Test Suite

**Status**: Not Started
**Effort**: Large (6-8 hours, 1 hour per gap)
**Dependencies**: P0 type errors, P0 ClipGroup, P1 ColorGrade
**Spec Reference**: plans/SPEC-04-render-pipeline.md § Validation • **Status Reference**: STATUS-20251231.md § Missing Checks

#### Description

**Zero automated tests exist** for any of the 6 render pipeline features. All validation has been code inspection only. Per updated COMPLETE definition, **automated tests are required** before declaring features complete.

**Recommended Approach**: Create **integration tests** that compile patches and verify rendering behavior, not unit tests of individual functions. This matches the system's architecture (data flow from blocks → IR → renderer).

#### Acceptance Criteria

**Test Infrastructure**:
- [ ] Test fixture setup: creates minimal patch with render sink
- [ ] Helper: compiles patch to IR and executes render schedule
- [ ] Helper: captures canvas ImageData for pixel-level assertions (if needed)

**Per-Feature Tests** (6 total):

**Gap 1: Z-Order**:
- [ ] Test: overlapping shapes render in correct z-order
  - Given: 3 shapes at z=0, z=1, z=2 with different colors
  - When: rendered to canvas
  - Then: pixel at center shows color from z=2 shape (top layer)

**Gap 2: Curve Flattening**:
- [ ] Test: cubic bezier flattens to smooth curve
  - Given: PathCmd.CUBIC with control points
  - When: materialized with tolerance=0.5
  - Then: path contains N line segments (N > 1, no bezier commands)
- [ ] Test: quadratic bezier flattens to smooth curve
  - Given: PathCmd.QUAD with control point
  - When: materialized with tolerance=0.5
  - Then: path contains N line segments (N > 1, no bezier commands)

**Gap 3: Clipping/Masking**:
- [ ] Test: rect clip bounds rendering
  - Given: instances outside clip rect
  - When: rendered with rect clip
  - Then: instances outside clip are not visible (pixels remain background color)
- [ ] Test: circle clip bounds rendering
  - Given: instances outside clip circle
  - When: rendered with circle clip
  - Then: instances outside clip are not visible
- [ ] Test: ClipGroup renders children with clip applied
  - Given: ClipGroup with rect clip and child passes
  - When: rendered
  - Then: children render within clip bounds only

**Gap 4: Per-Instance Transforms**:
- [ ] Test: rotation applies per instance
  - Given: 2 instances with different rotation values
  - When: rendered
  - Then: each instance rotated independently (verify via pixel sampling)
- [ ] Test: scaleXY applies per instance
  - Given: 2 instances with different scaleXY values
  - When: rendered
  - Then: each instance scaled independently

**Gap 5: PostFX**:
- [ ] Test: blur effect renders
  - Given: scene with blur postfx pass
  - When: rendered
  - Then: output canvas has blur applied (verify via getImageData edge detection)
- [ ] Test: bloom effect renders
  - Given: scene with bloom postfx pass
  - When: rendered
  - Then: output canvas has bloom glow (verify via pixel brightness increase)
- [ ] Test: vignette effect renders
  - Given: scene with vignette postfx pass
  - When: rendered
  - Then: output canvas has darkened edges (verify corner pixels darker than center)
- [ ] Test: colorGrade effect applies matrix
  - Given: scene with colorGrade postfx pass and grayscale matrix
  - When: rendered
  - Then: output canvas is grayscale (R=G=B for all pixels)

**Gap 6: Gradient Materials**:
- [ ] Test: linear gradient renders
  - Given: shape with linear gradient material (red to blue)
  - When: rendered
  - Then: pixels transition from red to blue along gradient axis
- [ ] Test: radial gradient renders
  - Given: shape with radial gradient material (center white to edge black)
  - When: rendered
  - Then: pixels transition from white center to black edge

#### Technical Notes

**Test Complexity Levels**:
- **Simple**: Just verify code executes without errors (smoke test)
- **Medium**: Verify data flow (e.g., z-order values read from IR)
- **Complex**: Verify visual output (pixel-level assertions on canvas)

**Recommended Starting Point**: Simple smoke tests for each gap, then incrementally add medium/complex assertions.

**Test File Location**:
- Create `src/editor/runtime/__tests__/render-pipeline.test.ts` for integration tests
- Or create per-gap test files if tests are large

**Mocking Strategy**:
- Avoid mocking canvas context if possible - use real OffscreenCanvas or jsdom canvas
- Mock `BuilderProgramIR` and `PatchStore` minimally (only fields used by renderer)

**Pixel Assertions**: Use `ctx.getImageData()` to read pixels and assert color values. Example:
```typescript
const imageData = ctx.getImageData(x, y, 1, 1);
const [r, g, b, a] = imageData.data;
expect(r).toBeCloseTo(255, 5); // red channel
```

**Reference**: Existing test files in `src/editor/runtime/__tests__/` for patterns.

---

## Dependency Graph

```
P0: Fix Type Errors (30 min)
  └─> UNBLOCKS: P0 ClipGroup, P1 ColorGrade, P2 Tests

P0: ClipGroup Rendering (2-3 hrs)
  └─> REQUIRED FOR: P2 Tests (ClipGroup test cases)

P1: ColorGrade Effect (3-4 hrs)
  └─> REQUIRED FOR: P2 Tests (ColorGrade test cases)

P2: Test Suite (6-8 hrs)
  └─> DEPENDS ON: P0 Type Errors, P0 ClipGroup, P1 ColorGrade
```

**Critical Path**: P0 Type Errors → (P0 ClipGroup + P1 ColorGrade) → P2 Test Suite

**Parallel Work**: ClipGroup and ColorGrade can be implemented in parallel after type errors are fixed.

---

## Recommended Sprint Execution

### Sprint Scope: 2 Deliverables

**Deliverable 1: Complete All Stubbed Features** (6-7 hours)
- Fix type errors (30 min) ✓ BLOCKING
- Implement ClipGroup rendering (2-3 hrs)
- Implement ColorGrade effect (3-4 hrs)

**Deliverable 2: Automated Test Suite** (6-8 hours)
- Create test infrastructure (1-2 hrs)
- Write 6 gap test suites (4-6 hrs, ~1 hr per gap)
- Verify all tests pass (30 min)

**Total Effort**: 12-15 hours (~2 days)

**Deferred**: None - all critical work is in scope

---

## Sprint Validation Checklist

After completing all deliverables, verify:

- [ ] `just typecheck` passes with zero type errors
- [ ] `just test` passes with all tests green
- [ ] `just check` passes (typecheck + lint + test)
- [ ] `just lint-fix` applied (no lint warnings)
- [ ] All 6 gaps have passing automated tests
- [ ] No console.warn() calls in render pipeline code (no stubs)
- [ ] Git status is clean (all changes committed)

**Manual Verification** (optional, recommended):
- [ ] Run `just dev` and load test patches for each gap
- [ ] Visual inspection: z-order, clipping, transforms, postfx, gradients all work
- [ ] No errors in browser console

---

## Risk Assessment

### High Risk Items

**1. ColorGrade ImageData Performance**
- **Risk**: Pixel manipulation may be too slow for real-time rendering
- **Mitigation**: Start with simple 3x3 matrix, defer complex transformations
- **Fallback**: Document as "proof of concept," recommend GPU implementation for production

**2. Test Infrastructure Setup**
- **Risk**: Canvas mocking in test environment may not work
- **Mitigation**: Use OffscreenCanvas or jsdom canvas polyfill
- **Fallback**: Simplify tests to data flow validation only (no pixel assertions)

### Medium Risk Items

**3. Path-based Clipping**
- **Risk**: Path decoding may be complex, adds scope
- **Mitigation**: Defer to future sprint, document as limitation
- **Fallback**: Throw error if path clip is used, fail fast

**4. Test Brittleness**
- **Risk**: Pixel-level assertions may be flaky (antialiasing, floating point precision)
- **Mitigation**: Use tolerance in color comparisons, avoid exact pixel matching
- **Fallback**: Use structural assertions (e.g., "gradient exists") instead of pixel colors

---

## Open Questions

1. **Path Clipping Scope**: Implement in this sprint or defer?
   - **Recommendation**: Defer - rect/circle covers 95% of use cases
   - **Action**: Document as limitation, add TODO for future sprint

2. **ColorGrade Matrix Format**: 3x3, 4x4, or 5x4?
   - **Recommendation**: Start with 3x3 (RGB only), defer alpha channel
   - **Action**: Read from IR type definition or use default identity

3. **Test Coverage Threshold**: How many test cases per gap?
   - **Recommendation**: Minimum 1 integration test per gap (6 total)
   - **Action**: Add more tests incrementally if time permits

---

## Success Criteria

**Sprint is COMPLETE when**:
1. All type errors resolved (`just typecheck` passes)
2. ClipGroup renders children with clipping (no stub)
3. ColorGrade applies color matrix (no stub)
4. All 6 gaps have at least 1 passing automated test
5. All existing tests still pass (no regressions)
6. `just check` passes with zero errors

**Sprint is BLOCKED if**:
1. Type errors cannot be fixed without major refactor
2. Canvas API doesn't support required features (e.g., no ImageData in test env)
3. Test infrastructure cannot be set up in reasonable time

**Escalation Path**: If blocked, pause and consult user for scope adjustment.

---

## File Manifest

**Modified Files** (estimated):
- `src/editor/compiler/ir/__tests__/state-offset-resolution.test.ts` (add debugProbes to mocks)
- `src/editor/runtime/canvasRenderer.ts` (implement ClipGroup case)
- `src/editor/runtime/renderPostFX.ts` (implement ColorGrade case)
- `src/editor/runtime/__tests__/render-pipeline.test.ts` (NEW - test suite)

**New Files** (if needed):
- Test fixtures in `test-patches/` directory (optional, for manual verification)

**Not Modified**:
- IR type definitions (already complete)
- Render pass executors (no changes needed)
- Block compilers (out of scope)

---

## Appendix: Prior Work Summary

**Commits Already Complete** (from STATUS-20251231.md):
- `24fbb00`: Gap 1 - Z-Order Applied (executeRenderAssemble + canvasRenderer)
- `e561b5c`: Gap 2 - Curve Flattening (executeMaterializePath De Casteljau)
- `ad36bb0`: Gap 3 - Clipping/Masking (ClipSpecIR types, rect/circle rendering)
- `7d9f0b1`: Gap 4 - Per-Instance Attributes (scaleXY + rotation)
- `60869b2`: Gap 5 - PostFX (blur, bloom, vignette implemented)
- `3965417`: Gap 6 - Gradient Materials (linear/radial gradients)

**Work Already Done**:
- IR types defined for all 6 gaps ✓
- Render pass executors implemented for 5.5/6 gaps ✓
- Canvas renderer dispatch implemented for all pass types ✓

**Work Remaining**:
- Complete 2 stubbed implementations (ClipGroup, ColorGrade)
- Fix type errors blocking test execution
- Write automated test suite

---

**END OF PLAN**
