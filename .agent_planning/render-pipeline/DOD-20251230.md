# Definition of Done: Render Pipeline Primitives

## Acceptance Criteria

### Gap 1: Z-Order Applied (COMPLETE)
- [x] `executeRenderAssemble.ts` reads z-order from batch descriptor (static or slot)
- [x] RenderSinkIR includes `zOrder?: number` and `zOrderSlot?: ValueSlot`
- [x] Passes are sorted by z-order before rendering
- [x] Test: overlapping elements render in correct z-order

### Gap 2: Curve Flattening Implemented (COMPLETE)
- [x] De Casteljau algorithm implemented in `executeMaterializePath.ts`
- [x] Cubic bezier commands (PathCmd.CUBIC) flatten to line segments
- [x] Quadratic bezier commands (PathCmd.QUAD) flatten to line segments
- [x] Tolerance parameter controls segment density
- [x] Test: bezier path renders as smooth curve

### Gap 3: Clipping/Masking Supported (COMPLETE)
- [x] ClipRegionIR type defined (rect, path, circle)
- [x] ClipGroupPassIR type defined with children
- [x] Canvas renderer applies clip before rendering children
- [x] Test: instances clip to rectangular region

### Gap 4: Extended Per-Instance Attributes (COMPLETE)
- [x] Instance2DBatch supports `rotation?: ValueSlot`
- [x] Instance2DBatch supports `scaleXY?: ValueSlot`
- [x] assembleInstanceBuffers extracts rotation/scale buffers
- [x] Canvas renderer applies rotation/scale per instance
- [x] Test: instances rotate and scale independently

### Gap 5: PostFX Implemented (COMPLETE)
- [x] PostFXPassIR type defined with effect variants
- [x] Blur effect implemented using canvas filter
- [x] Bloom effect implemented (multi-pass)
- [x] Canvas renderer handles postfx pass type
- [x] Vignette effect implemented
- [x] ColorGrade effect stubbed (requires ImageData pixel manipulation)

### Gap 6: Material System Extended (COMPLETE)
- [x] MaterialIR supports gradient type with stops
- [x] Canvas renderer creates linear/radial gradients
- [x] Gradient stops support offset and color
- [x] Gradient coordinates support (start/end for linear, center/radius for radial)

## Validation

- [x] All existing tests pass (1 known failure unrelated to render pipeline)
- [x] TypeScript compiles without errors
- [x] ESLint passes
- [ ] Manual verification in dev server for each gap (TBD - requires VM integration)

## Summary

All 6 gaps in the render pipeline primitives have been implemented:

1. **Z-Order Applied**: Render passes now respect z-order for correct layering
2. **Curve Flattening**: Bezier curves flatten to line segments using De Casteljau algorithm
3. **Clipping/Masking**: Rect and circle clipping regions supported
4. **Extended Per-Instance Attributes**: Rotation and scaleXY per-instance attributes
5. **PostFX**: Blur, bloom, vignette effects implemented; colorGrade stubbed
6. **Material System**: Linear and radial gradients with color stops

## Commits

- `c934541`: feat(render): Add z-order support to render pipeline (Gap 1)
- `b3b9391`: feat(render): Implement curve flattening with De Casteljau algorithm (Gap 2)
- `21cae9f`: feat(render): Add ClipGroup pass type and circle clipping support (Gap 3)
- `d69ea14`: feat(render): Add scaleXY per-instance attribute support (Gap 4)
- `a91d15c`: feat(render): Implement PostFX pass rendering (Gap 5)
- `fea19c5`: feat(render): Add gradient material support (Gap 6)
