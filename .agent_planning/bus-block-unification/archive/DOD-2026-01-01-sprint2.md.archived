# Definition of Done: Bus-Block Unification Sprint 2
**Generated**: 2026-01-01
**Plan**: PLAN-2026-01-01-sprint2.md

---

## P0: Compiler BusBlock Recognition

### Acceptance Criteria

- [ ] **Utility exists**: `src/editor/compiler/bus-block-utils.ts` with `getBusBlocks()` and `getBusById()`
- [ ] **Recognizes BusBlocks**: `getBusBlocks()` returns all blocks with `type === 'BusBlock'`
- [ ] **Lookup by ID**: `getBusById(patch, busId)` returns correct BusBlock
- [ ] **Params access**: Compiler reads `block.params.combine` for combine policy
- [ ] **Default value**: Compiler reads `block.params.defaultValue` for fallback
- [ ] **Tests pass**: 5+ unit tests for bus block utilities

### Verification

```bash
pnpm test src/editor/compiler/__tests__/bus-block-utils.test.ts
```

---

## P1: Pass 7 Simplification

### Acceptance Criteria

- [ ] **getPublishersFromEdges deleted**: No function by this name in pass7
- [ ] **Edges to BusBlock.in**: Pass 7 uses `getEdgesToPort(patch, busBlock.id, 'in')`
- [ ] **Edges from BusBlock.out**: Pass 7 uses `getEdgesFromPort(patch, busBlock.id, 'out')`
- [ ] **Combine via standard path**: Uses `createCombineNode()` for BusBlock combine
- [ ] **Sorting works**: Edge weight/sortKey still determines publisher order
- [ ] **Multi-bus works**: Patches with multiple buses compile correctly
- [ ] **All tests pass**: Pass 7 test suite passes
- [ ] **No legacy refs**: No references to `patch.publishers` or `patch.listeners`

### Verification

```bash
pnpm test src/editor/compiler/passes/__tests__/pass7-bus-lowering.test.ts
grep -r "getPublishersFromEdges" src/editor/compiler/  # Should return nothing
```

---

## P2: Pass 8 Edge Unification

### Acceptance Criteria

- [ ] **Uniform processing**: All edges processed without edge-kind checks
- [ ] **No Endpoint.kind checks**: No `if (edge.from.kind === 'bus')` patterns
- [ ] **Transforms work**: applyAdapterChain/applyLensStack work on BusBlock edges
- [ ] **Fragment linking**: BusBlock ports link correctly
- [ ] **All tests pass**: Pass 8 test suite passes
- [ ] **No Endpoint refs**: No references to Endpoint type in Pass 8

### Verification

```bash
pnpm test src/editor/compiler/passes/__tests__/pass8-link-resolution.test.ts
grep -r "kind.*bus" src/editor/compiler/passes/pass8-link-resolution.ts  # Should return nothing
```

---

## Sprint 2 Overall Acceptance

### All Tests Pass

```bash
pnpm test --run
# Expected: All compiler tests pass
```

### TypeScript Compiles

```bash
pnpm exec tsc --noEmit
# Expected: No errors
```

### Code Reduction Verified

```bash
# Pass 7 should be ~100 lines smaller
wc -l src/editor/compiler/passes/pass7-bus-lowering.ts
# Pass 8 should be ~50 lines smaller
wc -l src/editor/compiler/passes/pass8-link-resolution.ts
```

### Golden Patch Compiles

```bash
# Manual: compile the golden patch and verify no errors
```
