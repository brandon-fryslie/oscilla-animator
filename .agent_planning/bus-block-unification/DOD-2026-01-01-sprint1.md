# Definition of Done: Bus-Block Unification Sprint 1
**Generated**: 2026-01-01
**Plan**: PLAN-2026-01-01-sprint1.md

---

## P0: BusBlock Definition

### Acceptance Criteria

- [ ] **BusBlock type exists**: File `src/editor/blocks/bus-block.ts` contains `BusBlock` block definition
- [ ] **Multi-input port**: BusBlock has input port with `multi: true` and `combine` from params
- [ ] **Single output port**: BusBlock has output port with type from `params.busType`
- [ ] **Hidden tag**: BusBlock has `tags: { hidden: true, bus: true }`
- [ ] **Bus metadata**: BusBlock params include `busId`, `busName`, `busType`, `combine`, `defaultValue`
- [ ] **Registered**: BusBlock appears in `BLOCK_DEFS_BY_TYPE` after registration
- [ ] **Filtered from UI**: BlockLibrary does not show blocks with `tags.hidden === true`
- [ ] **Compiles**: `pnpm exec tsc --noEmit` succeeds

### Verification Commands

```bash
# Check file exists
ls src/editor/blocks/bus-block.ts

# Check registration
grep -r "BusBlock" src/editor/blocks/registry.ts

# Check filtering
grep -r "hidden" src/editor/BlockLibrary.tsx

# TypeScript compiles
pnpm exec tsc --noEmit
```

---

## P1: Busâ†’BusBlock Conversion Utility

### Acceptance Criteria

- [ ] **Forward conversion**: `convertBusToBlock(bus: Bus): Block` function exists
- [ ] **Reverse conversion**: `convertBlockToBus(block: Block): Bus` function exists
- [ ] **ID preserved**: `convertBusToBlock(bus).id === bus.id`
- [ ] **Name preserved**: `convertBusToBlock(bus).params.busName === bus.name`
- [ ] **Type preserved**: `convertBusToBlock(bus).params.busType === bus.type`
- [ ] **Combine preserved**: `convertBusToBlock(bus).params.combine === bus.combine`
- [ ] **Roundtrip**: `convertBlockToBus(convertBusToBlock(bus))` equals original bus
- [ ] **Tests pass**: 8+ unit tests in `conversion.test.ts` all pass

### Verification Commands

```bash
# Run specific tests
pnpm test src/editor/bus-block/__tests__/conversion.test.ts

# Check test count
grep -c "it\(" src/editor/bus-block/__tests__/conversion.test.ts
```

---

## P2: Edge Migration - Remove Endpoint Union

### Acceptance Criteria

- [ ] **Migration function**: `migrateEdgesToPortOnly(patch): Patch` function exists
- [ ] **Publisher migration**: Edge with `from.kind='port', to.kind='bus'` becomes `from: PortRef, to: BusBlock.in`
- [ ] **Listener migration**: Edge with `from.kind='bus', to.kind='port'` becomes `from: BusBlock.out, to: PortRef`
- [ ] **Wire unchanged**: Edge with `from.kind='port', to.kind='port'` remains unchanged
- [ ] **No bus endpoints**: After migration, no edge has `from.kind='bus'` or `to.kind='bus'`
- [ ] **Buses converted**: After migration, `patch.buses` is empty and BusBlocks are in `patch.blocks`
- [ ] **Compilation works**: Migrated patch compiles successfully
- [ ] **Tests pass**: 10+ unit tests in `migration.test.ts` all pass

### Verification Commands

```bash
# Run specific tests
pnpm test src/editor/bus-block/__tests__/migration.test.ts

# Check test count
grep -c "it\(" src/editor/bus-block/__tests__/migration.test.ts
```

---

## Sprint 1 Overall Acceptance

### All Tests Pass

```bash
pnpm test --run
# Expected: All tests pass (including 18+ new tests)
```

### TypeScript Compiles

```bash
pnpm exec tsc --noEmit
# Expected: No errors
```

### Manual Verification

1. Start dev server: `just dev`
2. Create a new bus "TestBus" of type Signal<float>
3. Add a block that publishes to TestBus
4. Add a block that listens to TestBus
5. Compile the patch
6. Verify no errors

### File Checklist

New files created:
- [ ] `src/editor/blocks/bus-block.ts`
- [ ] `src/editor/bus-block/conversion.ts`
- [ ] `src/editor/bus-block/__tests__/conversion.test.ts`
- [ ] `src/editor/bus-block/migration.ts`
- [ ] `src/editor/bus-block/__tests__/migration.test.ts`

Modified files:
- [ ] `src/editor/blocks/index.ts` - exports BusBlock
- [ ] `src/editor/blocks/registry.ts` - registers BusBlock
- [ ] `src/editor/BlockLibrary.tsx` - filters hidden blocks
- [ ] `src/editor/kernel/migration.ts` - calls edge migration on load

---

## Not in Scope (Sprint 2+)

The following are explicitly NOT acceptance criteria for Sprint 1:

- Removing BusStore
- Removing Bus interface
- Removing Endpoint type
- Removing Publisher/Listener interfaces
- Updating compiler passes to use BusBlock
- Updating UI components (BusBoard, BusInspector, etc.)

These will be addressed in subsequent sprints after the foundation is proven.
