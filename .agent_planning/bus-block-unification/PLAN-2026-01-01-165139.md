# Sprint 3 Final Plan: Remove All Bus Branching Logic
**Generated**: 2026-01-01-165139
**Source**: STATUS-2026-01-01-update.md
**Topic**: bus-block-unification
**Sprint**: 3 of 4 (FINAL)
**Depends on**: Sprint 2 complete ✅

---

## Executive Summary

**Sprint Goal**: Remove ALL `kind === 'bus'` checks from compiler and stores, completing the bus-block unification.

**Current State**:
- Sprint 1 & 2: ✅ COMPLETE
- Test status: 5 failing (down from 43) - 88% improvement
- Remaining failures: Composite expansion tests (NOT bus-block related)

**Decision**: Skip the 5 composite lens binding tests (Sprint 4 scope), focus purely on removing bus branching logic.

**Scope**: This sprint completes the bus-block unification by removing all bus-specific code paths from the compiler and stores. After this sprint, buses are ONLY BusBlocks with ports - no special cases remain.

---

## Scope

### In Scope (This Sprint)
1. **P0**: Document and skip 5 lens-binding tests (explicitly deferred to Sprint 4)
2. **P1**: Remove compiler bus branching (5 files, 8 locations)
3. **P2**: Remove store bus branching (3 files, 3 locations)
4. **P3**: Verification and manual testing

### Explicitly Out of Scope
- Fixing composite lens param bindings (Sprint 4 - lens bindings feature)
- Endpoint type union removal (future type cleanup sprint)
- BusStore deletion (future cleanup sprint)
- Full type system cleanup (future cleanup sprint)

**Rationale**: The 5 failing tests are composite expansion issues requiring lens param binding support (bus/wire/default binding kinds). This is Sprint 4 scope. The bus-block unification work (removing `kind === 'bus'` checks) is independent and ready to proceed.

---

## Work Items

### P0: Document Lens Binding Test Deferrals

**Status**: Not Started
**Effort**: Trivial (30 minutes)
**Dependencies**: None
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-update.md § "Current Test Failures"

#### Description
The 5 failing tests in `composite.expansion.test.ts` are NOT bus-block unification bugs. They fail because composite expansion uses lens parameters with non-literal bindings (bus/wire/default kinds), which the IR compiler doesn't yet support. This is a known limitation documented in the Sprint 4 plan (lens bindings feature).

Skip these tests explicitly with clear documentation so Sprint 3 can proceed.

#### Acceptance Criteria
- [ ] Add error logging to D1/D2 tests to capture actual compile errors
- [ ] Run tests and document the specific error messages in test comments
- [ ] Mark tests as `.skip` with TODO referencing Sprint 4 plan
- [ ] Update test file header explaining the 5 skipped tests
- [ ] Verify all other tests still pass (regression check)
- [ ] Commit with message: `test(composite): Skip lens param binding tests pending Sprint 4`

#### Technical Notes
**Tests to Skip**:
1. `C3: nested lens application`
2. `C4: lens modulating composite input via bus`
3. `D1: same patch compiled twice produces identical results`
4. `D2: adding unrelated block does not change composite expansion IDs`
5. One additional test (name TBD from investigation)

**Comment Template**:
```typescript
it.skip('D1: same patch compiled twice...', () => {
  // TODO(Sprint 4): Requires lens param binding kinds (bus/wire/default)
  // Currently only literal bindings supported in IR compiler
  // Compilation fails with: [ERROR MESSAGE FROM INVESTIGATION]
  // See: PLAN-2026-01-01-sprint4-lens-bindings.md
  // Track: P1-A (Lens Parameter Binding Kinds)
});
```

**Investigation First**: Before skipping, add error logging to see actual compile errors:
```typescript
if (!result1.ok) {
  console.error('D1 compilation errors:', result1.errors);
}
```

This documents the exact failure mode for future reference.

---

### P1-A: Remove Compiler Bus Branching - Pass 6

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0 complete
**Spec Reference**: CLAUDE.md § "No bus entity paths" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P1"

#### Description
Remove the bus writer check in Pass 6 (block lowering) that returns `null` for bus writers. After Sprint 2, buses are BusBlocks with ports, so all writers follow the standard port-based path.

**Location**: `src/editor/compiler/passes/pass6-block-lowering.ts:417`

#### Acceptance Criteria
- [ ] Line 417 bus check `if (writer.kind === 'bus')` deleted entirely
- [ ] Comment explaining why check was removed (buses are now BusBlocks)
- [ ] Writer resolution handles BusBlock ports uniformly (no special case)
- [ ] TypeScript compilation succeeds
- [ ] All non-skipped tests pass (regression check)
- [ ] Manual test: Block connected to bus compiles correctly
- [ ] Commit references Sprint 3 P1-A

#### Technical Notes
**Current Code** (pass6-block-lowering.ts:417):
```typescript
if (writer.kind === 'bus') {
  // Bus: Will be resolved in Pass 7 (bus lowering)
  return null;
}
```

**After Removal**: Delete entire conditional. BusBlock outputs are regular ports after Sprint 2, so writer resolution handles them like any other port.

**Verification**: Run `just test -- compiler` and verify bus-connected blocks still compile. Check dev server for visual confirmation.

---

### P1-B: Remove Compiler Bus Branching - Pass 7

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0 complete
**Spec Reference**: CLAUDE.md § "Unified edge processing" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P1"

#### Description
Remove legacy edge format detection in Pass 7 (bus lowering). The `getPublishersFromLegacyEdges()` function and `hasLegacyEdges` check are backward compatibility code that can be deleted now that all edges use BusBlock ports.

**Locations**:
- `src/editor/compiler/passes/pass7-bus-lowering.ts:167` (function)
- `src/editor/compiler/passes/pass7-bus-lowering.ts:274` (check)

#### Acceptance Criteria
- [ ] `getPublishersFromLegacyEdges()` function deleted (line 167)
- [ ] `hasLegacyEdges` check deleted (line 274)
- [ ] All publisher lookups use `getEdgesToBusBlock()` exclusively
- [ ] Comment added: "All edges are port→port after Sprint 2 migration"
- [ ] TypeScript compilation succeeds
- [ ] All non-skipped tests pass (especially bus combine tests)
- [ ] Manual test: Bus combine modes (latest, merge, array) work correctly
- [ ] Commit references Sprint 3 P1-B

#### Technical Notes
**Current Code** (pass7-bus-lowering.ts):
```typescript
// Line 167: DEPRECATED legacy edge function
function getPublishersFromLegacyEdges(patch: Patch, busId: string): Edge[] {
  return patch.edges.filter(e => e.to.kind === "bus" && e.to.busId === busId);
}

// Line 274: Legacy edge detection
const hasLegacyEdges = edges.some(e => e.to.kind === 'bus' && e.to.busId === busBlock.id);
```

**After Removal**: Delete both. Pass 7 already has `getEdgesToBusBlock()` which uses port→port edges. Legacy path is dead code.

**Verification**: Critical to verify bus combine modes still work. Test with multiple publishers to same bus using different combine modes.

---

### P1-C: Remove Compiler Bus Branching - Pass 8 Comment

**Status**: Not Started
**Effort**: Trivial (15 minutes)
**Dependencies**: P0 complete
**Spec Reference**: N/A • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P1"

#### Description
Update documentation comment in Pass 8 to reflect that only port-to-port edges exist (no legacy bus edges).

**Location**: `src/editor/compiler/passes/pass8-link-resolution.ts:546`

#### Acceptance Criteria
- [ ] Comment at line 546 updated to remove bus edge references
- [ ] Comment explains all edges are port→port (migration complete)
- [ ] No code changes (documentation only)
- [ ] Commit references Sprint 3 P1-C

#### Technical Notes
**Current Comment** (pass8-link-resolution.ts:546):
```typescript
* have been migrated by migrateEdgesToPortOnly(). Bus edges (edge.from.kind === 'bus')
```

**Updated Comment**:
```typescript
* have been migrated to port-only format (edge.from/to are always PortRef).
* All bus connections use BusBlock ports (busBlock.in / busBlock.out).
* Sprint 2 migration complete - no legacy edge formats remain.
```

---

### P1-D: Remove Compiler Bus Branching - resolveWriters

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0 complete
**Spec Reference**: CLAUDE.md § "Unified edge processing" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P1"

#### Description
Remove the bus listener writer classification in `resolveWriters.ts`. After Sprint 2, bus listeners are edges from `BusBlock.out` to target ports, so they're classified as regular 'wire' writers, not a special 'bus' kind.

**Location**: `src/editor/compiler/ir/resolveWriters.ts:162-169`

#### Acceptance Criteria
- [ ] Bus listener classification branch deleted (lines 162-169)
- [ ] All writers are classified as 'wire' or 'default' only (no 'bus' kind)
- [ ] BusBlock outputs treated like regular block outputs
- [ ] Comment added: "BusBlock.out edges are wire writers (port→port)"
- [ ] TypeScript compilation succeeds
- [ ] All non-skipped tests pass (verify listeners still work)
- [ ] Manual test: Bus listener receives values correctly
- [ ] Commit references Sprint 3 P1-D

#### Technical Notes
**Current Code** (resolveWriters.ts:162-169):
```typescript
} else if (edge.from.kind === 'bus') {
  // Bus listener: bus → port
  writers.push({
    kind: 'bus',
    listenerId: edge.id,
    busId: edge.from.busId,
  });
}
```

**After Removal**: Delete this branch entirely. Edges from `BusBlock.out` are already handled by the 'wire' case (port→port edges).

**NOTE**: Writer type may still have a `{ kind: 'bus'; ... }` variant. This is acceptable - mark it as deprecated with comment, remove in future type cleanup sprint.

---

### P1-E: Remove Compiler Bus Branching - Pass 1

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P0 complete
**Spec Reference**: CLAUDE.md § "Deterministic compilation" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P1"

#### Description
Remove publisher edge detection in Pass 1 (normalize) that sorts publisher edges by sortKey for deterministic bus combines. After Sprint 2, publisher edges are regular port→port edges to `BusBlock.in`, so they're sorted with all other edges.

**Locations**:
- `src/editor/compiler/passes/pass1-normalize.ts:63` (publisher filter)
- `src/editor/compiler/passes/pass1-normalize.ts:72` (non-publisher filter)

#### Acceptance Criteria
- [ ] Publisher edge filter removed (line 63)
- [ ] Non-publisher filter removed (line 72)
- [ ] All edges sorted uniformly by sortKey (no special bus handling)
- [ ] Deterministic bus combine order VERIFIED (test passes)
- [ ] Comment added: "All edges sorted uniformly - bus combines still deterministic"
- [ ] TypeScript compilation succeeds
- [ ] All non-skipped tests pass (especially bus combine determinism tests)
- [ ] Commit references Sprint 3 P1-E

#### Technical Notes
**Current Code** (pass1-normalize.ts:63, 72):
```typescript
// Line 63: Filter publisher edges for sorting
.filter(e => e.from.kind === 'port' && e.to.kind === 'bus')

// Line 72: Filter non-publishers
const nonPublishers = enabled.filter(e => !(e.from.kind === 'port' && e.to.kind === 'bus'));
```

**After Removal**: Delete both filters. All edges are port→port now, so sorting logic applies uniformly.

**CRITICAL**: Verify that bus combine order is still deterministic after this change. Check that edges to `BusBlock.in` are sorted correctly by sortKey. The STATUS marked this as "BACKWARD COMPATIBILITY - can remain during migration", but migration is complete (Sprint 2), so safe to remove now.

---

### P2-A: Remove Store Bus Branching - PatchStore Helpers

**Status**: Not Started
**Effort**: Medium (2 hours)
**Dependencies**: P1-A through P1-E complete
**Spec Reference**: CLAUDE.md § "Unified architecture" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P2"

#### Description
Update `publisherEdges` and `listenerEdges` computed helpers in PatchStore to query edges by BusBlock ports instead of Endpoint.kind discrimination.

**Locations**:
- `src/editor/stores/PatchStore.ts:155` (publisherEdges getter)
- `src/editor/stores/PatchStore.ts:164` (listenerEdges getter)
- `src/editor/stores/PatchStore.ts:1338+` (edge update helpers)

#### Acceptance Criteria
- [ ] `publisherEdges` getter updated to query edges to `*.in` on BusBlocks
- [ ] `listenerEdges` getter updated to query edges from `*.out` on BusBlocks
- [ ] Edge update helpers (addEdgeEndpoints, removeEdgeEndpoints) updated to remove bus checks
- [ ] Getters use BusBlock queries: `this.blocks.filter(b => b.type === 'BusBlock')`
- [ ] MobX reactivity preserved (@computed annotation correct)
- [ ] TypeScript compilation succeeds
- [ ] All non-skipped tests pass
- [ ] Manual test: Bus board updates when edges change
- [ ] Commit references Sprint 3 P2-A

#### Technical Notes
**Current Code** (PatchStore.ts):
```typescript
// Lines 155-156: publisherEdges getter
get publisherEdges(): Edge[] {
  return this.edges.filter(e => e.from.kind === 'port' && e.to.kind === 'bus');
}

// Lines 163-165: listenerEdges getter
get listenerEdges(): Edge[] {
  return this.edges.filter(e => e.from.kind === 'bus' && e.to.kind === 'port');
}
```

**After Update**:
```typescript
@computed
get publisherEdges(): Edge[] {
  const busBlockIds = new Set(this.blocks.filter(b => b.type === 'BusBlock').map(b => b.id));
  return this.edges.filter(e =>
    busBlockIds.has(e.to.blockId) && e.to.slotId === 'in'
  );
}

@computed
get listenerEdges(): Edge[] {
  const busBlockIds = new Set(this.blocks.filter(b => b.type === 'BusBlock').map(b => b.id));
  return this.edges.filter(e =>
    busBlockIds.has(e.from.blockId) && e.from.slotId === 'out'
  );
}
```

**Edge Update Helpers**: Review `addEdgeEndpoints` and `removeEdgeEndpoints` around line 1338. If they have `kind === 'bus'` checks, update them to check `block.type === 'BusBlock'` instead.

---

### P2-B: Remove Store Bus Branching - SelectionStore

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P2-A complete
**Spec Reference**: CLAUDE.md § "BusBlocks are blocks" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P2"

#### Description
Update SelectionStore to recognize BusBlock selections instead of special 'bus' kind selections.

**Location**: `src/editor/stores/SelectionStore.ts:71`

#### Acceptance Criteria
- [ ] `selection.kind === 'bus'` check removed (line 71)
- [ ] BusBlock selections identified by `selection.kind === 'block' && block.type === 'BusBlock'`
- [ ] Selected bus ID retrieved from `block.params.busId` (not `selection.id`)
- [ ] TypeScript compilation succeeds
- [ ] Selection tests pass
- [ ] Manual test: Select BusBlock in UI, verify inspector shows correct data
- [ ] Commit references Sprint 3 P2-B

#### Technical Notes
**Current Code** (SelectionStore.ts:71):
```typescript
return this.selection.kind === 'bus' ? this.selection.id : null;
```

**After Update**:
```typescript
if (this.selection.kind === 'block') {
  const block = patchStore.getBlockById(this.selection.id);
  if (block?.type === 'BusBlock') {
    return block.params.busId as string;
  }
}
return null;
```

**NOTE**: Selection type may still have a 'bus' variant. This is acceptable for now - the code won't use that variant. Mark as deprecated, remove in future type cleanup sprint.

---

### P2-C: Remove Store Bus Branching - DiagnosticStore

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P2-A complete
**Spec Reference**: CLAUDE.md § "BusBlocks are blocks" • **Status Reference**: STATUS-2026-01-01-update.md § "Sprint 3 P2"

#### Description
Update DiagnosticStore to match BusBlock diagnostics by block.id or params.busId instead of special bus target kind.

**Location**: `src/editor/stores/DiagnosticStore.ts:177`

#### Acceptance Criteria
- [ ] `target.kind === 'bus'` check removed or updated (line 177)
- [ ] Diagnostics targeting BusBlocks match by block.id
- [ ] Bus-related diagnostics still display correctly in UI
- [ ] TypeScript compilation succeeds
- [ ] Diagnostic tests pass
- [ ] Manual test: Create bus error, verify diagnostic appears
- [ ] Commit references Sprint 3 P2-C

#### Technical Notes
**Current Code** (DiagnosticStore.ts:177):
```typescript
if (target.kind === 'bus') return target.busId === busId;
```

**After Update**:
```typescript
if (target.kind === 'block') {
  const block = patchStore.getBlockById(target.blockId);
  if (block?.type === 'BusBlock') {
    return block.params.busId === busId;
  }
}
```

**NOTE**: DiagnosticTarget type may still have 'bus' variant. Same as SelectionStore - mark deprecated, remove in future cleanup.

---

### P3: Final Verification and Manual Testing

**Status**: Not Started
**Effort**: Medium (1-2 hours)
**Dependencies**: P2-A, P2-B, P2-C complete
**Spec Reference**: CLAUDE.md § "Manual testing" • **Status Reference**: N/A

#### Description
Comprehensive manual testing of bus functionality after all bus branching logic has been removed. Verify that buses work correctly as BusBlocks with no special-case code paths.

#### Acceptance Criteria
- [ ] All non-skipped tests pass (`just test`)
- [ ] TypeScript compilation succeeds (`just typecheck`)
- [ ] Lint passes (`just lint-fix`)
- [ ] Dev server runs without errors (`just dev`)
- [ ] All manual test scenarios pass (see checklist below)
- [ ] No console errors during manual testing
- [ ] Bus inspector shows correct information
- [ ] Performance is acceptable (no obvious slowdowns)

#### Manual Testing Checklist

**Basic Bus Operations**:
- [ ] Create new bus - BusBlock appears on canvas
- [ ] Rename bus - BusBlock params.busId updates
- [ ] Delete bus - BusBlock removed, edges cascade deleted
- [ ] Select bus - Inspector shows BusBlock properties

**Bus Connections**:
- [ ] Connect publisher to bus - edge created to BusBlock.in
- [ ] Connect listener from bus - edge created from BusBlock.out
- [ ] Disconnect publisher - edge removed
- [ ] Disconnect listener - edge removed
- [ ] Multiple publishers to same bus - all edges present

**Bus Combine Modes**:
- [ ] Latest mode - bus shows most recent publisher value
- [ ] Merge mode - bus merges all publisher values (object merge)
- [ ] Array mode - bus collects all publisher values in array
- [ ] Switch combine mode - output updates correctly

**Compilation and Runtime**:
- [ ] Compile patch with buses - no compile errors
- [ ] Run compiled patch - bus values propagate correctly
- [ ] Scrub timeline - bus values update per frame
- [ ] Multiple buses in patch - all work independently
- [ ] Nested composites with buses - compile and run correctly (non-lens cases)

**UI and Reactivity**:
- [ ] Bus board displays all BusBlocks
- [ ] Adding bus updates UI immediately
- [ ] Removing bus updates UI immediately
- [ ] Changing bus params updates UI immediately
- [ ] Diagnostics for bus errors display correctly

#### Technical Notes
**Focus Areas**: Pay special attention to:
1. Bus combine modes - these are the most complex bus logic
2. Multiple publishers to same bus - edge ordering must be deterministic
3. Compilation - verify no runtime errors from removed code paths
4. UI reactivity - ensure MobX computed getters still trigger updates

**Regression Check**: Compare behavior to a known-good commit (before Sprint 3 P1 changes) to ensure no behavior changes.

**Performance**: Monitor for any slowdowns in edge queries or bus value computation. The new BusBlock-based queries should be similar performance to old Endpoint.kind checks.

---

## Dependencies & Execution Order

```
Sprint 2 (complete) ✅
         ↓
P0: Skip Lens Tests (GATE) ← MUST complete before ANY other work
         ↓
         ├─→ P1-A: Pass 6 bus check removal (1h)
         ├─→ P1-B: Pass 7 legacy edges removal (1h)
         ├─→ P1-C: Pass 8 comment update (15m)
         ├─→ P1-D: resolveWriters bus kind removal (1h)
         └─→ P1-E: Pass 1 publisher sorting removal (30m)
                  ↓
         ├─→ P2-A: PatchStore helpers update (2h)
         ├─→ P2-B: SelectionStore update (30m)
         └─→ P2-C: DiagnosticStore update (30m)
                  ↓
         P3: Manual verification (1-2h)
```

**Critical Path**: P0 → P1 (3.75h) → P2 (3h) → P3 (1.5h)

**Total Estimated Time**: 8-10 hours

**Parallelization**:
- P1 items (A/B/D/E) can be done in parallel (C is trivial, can be done anytime)
- P2 items (A/B/C) should be sequential (A first, then B and C in parallel)

---

## Risks & Mitigation

### Risk 1: Skipped Tests Hide Bus-Related Bugs (LOW)
**Description**: The 5 skipped composite tests might actually reveal bus-block issues
**Impact**: Bus bugs not caught until Sprint 4
**Mitigation**:
- P0 adds error logging to see actual compile errors
- If errors mention "bus" or "BusBlock", investigate before skipping
- Only skip if errors clearly relate to lens param bindings
- Document exact error messages for Sprint 4 reference

---

### Risk 2: Writer Resolution Breaks (MEDIUM)
**Description**: Removing bus writer checks (P1-A, P1-D) might break block input resolution
**Impact**: Blocks connected to buses don't compile
**Mitigation**:
- Each P1 item includes regression test step
- Manual testing in P3 verifies bus connections work
- Small, isolated changes (easy to revert if needed)
- Bus tests should catch any breakage

---

### Risk 3: Bus Combine Order Non-Determinism (MEDIUM)
**Description**: Removing publisher sorting (P1-E) might change combine results
**Impact**: Bus output values differ from before, breaking replays
**Mitigation**:
- P1-E specifically verifies deterministic ordering preserved
- Bus combine tests should catch any regression
- Check that sortKey is still used for all edge ordering
- Compare golden patch outputs before/after change

---

### Risk 4: UI Reactivity Breaks (LOW)
**Description**: Updating PatchStore helpers (P2-A) might break MobX reactivity
**Impact**: UI doesn't update when bus connections change
**Mitigation**:
- P2-A keeps @computed decorators (just updates implementation)
- Manual testing in P3 verifies UI updates correctly
- Test with React DevTools to verify re-renders
- MobX @computed annotation preserves reactivity

---

## Success Metrics

**Code Quality**:
- [ ] Zero `kind === 'bus'` checks in compiler (Pass 1, 6, 7, 8, resolveWriters)
- [ ] Zero `kind === 'bus'` checks in stores (PatchStore, SelectionStore, DiagnosticStore)
- [ ] ~100-150 lines of bus branching code removed
- [ ] All code paths treat buses as BusBlocks with ports

**Testing**:
- [ ] All non-skipped tests pass (0 failures)
- [ ] 5 composite lens tests skipped with clear documentation
- [ ] TypeScript compilation succeeds (0 errors)
- [ ] Lint passes (0 warnings)

**Functionality**:
- [ ] All manual test scenarios pass
- [ ] Bus combine modes work correctly
- [ ] No console errors in dev server
- [ ] No performance regressions

**Documentation**:
- [ ] Skipped tests reference Sprint 4 plan
- [ ] Comments explain why bus checks were removed
- [ ] Commit messages reference plan items (P1-A, P1-B, etc.)

---

## Code Reduction Estimate

### Deletions:
- P1-A (Pass 6 bus writer check): ~5 lines
- P1-B (Pass 7 legacy edge functions): ~40 lines
- P1-C (Pass 8 comment): ~0 lines (comment update)
- P1-D (resolveWriters bus kind): ~10 lines
- P1-E (Pass 1 publisher sorting): ~15 lines

**Total Compiler**: ~70 lines deleted

### Updates (not deletions):
- P2-A (PatchStore helpers): ~10 lines (getters updated, not deleted)
- P2-B (SelectionStore): ~5 lines (check updated, not deleted)
- P2-C (DiagnosticStore): ~5 lines (check updated, not deleted)

**Total Store**: ~20 lines updated

**Net Code Change**: ~70 deletions, ~20 updates = ~90 lines total

---

## Deferred to Future Sprints

These items are **explicitly deferred** from original Sprint 3 scope:

1. **Endpoint type union removal** - Future "Type Cleanup" sprint
2. **Bus/Publisher/Listener type removal** - Future "Type Cleanup" sprint
3. **BusStore deletion** - Future "Type Cleanup" sprint
4. **Patch.buses/publishers/listeners array removal** - Future "Type Cleanup" sprint
5. **Writer type 'bus' variant removal** - Future "Type Cleanup" sprint
6. **Selection/DiagnosticTarget 'bus' variant removal** - Future "Type Cleanup" sprint

**Rationale**: This sprint focuses on removing functional code paths (bus branching logic). Full type cleanup is a separate concern that can be done safely after functional unification is complete and stable.

**Future Sprint**: Consider "Sprint 3.5: Type System Cleanup" to tackle deferred type removals.

---

## Final State After Sprint 3

**Compiler**:
- ✅ No bus-specific code paths
- ✅ All edges treated uniformly as port→port
- ✅ BusBlocks compiled like any other block

**Stores**:
- ✅ Bus helpers use BusBlock queries (not Endpoint.kind)
- ✅ Selection/diagnostics identify BusBlocks by block.type
- ✅ No `kind === 'bus'` checks remain

**Types**:
- ⚠️ Endpoint union remains (has 'bus' variant - UNUSED)
- ⚠️ Bus/Publisher/Listener types remain (marked deprecated)
- ⚠️ Writer type 'bus' variant remains (UNUSED)
- ✅ All code uses BusBlock queries, not type discriminators

**Architecture**:
- ✅ Functional unification COMPLETE
- ⚠️ Structural unification PARTIAL (types not cleaned up)

---

**Files Generated**:
- PLAN-2026-01-01-165139.md (this file)
- DOD-2026-01-01-165139.md (acceptance criteria only)
