# Definition of Done: Event System Implementation
Generated: 2025-12-20-143632
Plan: PLAN-2025-12-20-143632.md
Design Doc: design-docs/4-Event-System/1-Events.md

## Sprint Scope
This sprint delivers:
1. Typed event system infrastructure (EventDispatcher + type definitions)
2. LogStore integration into RootStore (breaking singleton pattern)
3. 7 Phase A lifecycle events emitted at correct points
4. MacroExpanded → auto-clear logs listener working
5. Comprehensive test coverage

Deferred to Phase B:
- Additional events (CompileStarted, PlaybackStarted/Stopped, BusCreated, etc.)
- Event-driven refactoring of existing direct coupling
- React hooks for event subscriptions

---

## Acceptance Criteria

### Deliverable 1: Event System Foundation (P0 Items)

#### Event Type Definitions
- [ ] File `src/editor/events/types.ts` created
- [ ] `EditorEvent` discriminated union defined with 7 event types:
  - `MacroExpanded: { type: 'MacroExpanded'; macroType: string; createdBlockIds: string[] }`
  - `PatchLoaded: { type: 'PatchLoaded'; blockCount: number; connectionCount: number }`
  - `PatchCleared: { type: 'PatchCleared' }`
  - `CompileSucceeded: { type: 'CompileSucceeded'; durationMs: number }`
  - `CompileFailed: { type: 'CompileFailed'; errorCount: number }`
  - `BlockAdded: { type: 'BlockAdded'; blockId: string; blockType: string; laneId: string }`
  - `BlockRemoved: { type: 'BlockRemoved'; blockId: string; blockType: string }`
- [ ] All event types have JSDoc comments explaining when they're emitted
- [ ] TypeScript strict mode compilation succeeds

#### EventDispatcher Implementation
- [ ] File `src/editor/events/EventDispatcher.ts` created
- [ ] Class `EventDispatcher` implements three methods:
  - `emit<T extends EditorEvent>(event: T): void`
  - `on<T extends EditorEvent['type']>(type: T, handler: EventHandler<EventOfType<T>>): () => void`
  - `subscribe(handler: EventHandler<EditorEvent>): () => void`
- [ ] Handler errors are isolated (try/catch per handler)
- [ ] Handler errors logged to `console.error` but don't break emit flow
- [ ] Unsubscribe functions returned from `on()` and `subscribe()` work correctly
- [ ] Handlers called in registration order (deterministic)
- [ ] No async handler support (synchronous-only)
- [ ] File `src/editor/events/index.ts` exports public API
- [ ] JSDoc with usage examples added

#### RootStore Integration
- [ ] `EventDispatcher` imported in `src/editor/stores/RootStore.ts`
- [ ] `events: EventDispatcher` property added to RootStore class
- [ ] EventDispatcher instantiated in RootStore constructor before other stores
- [ ] All child stores can access via `this.root.events`
- [ ] TypeScript compilation succeeds
- [ ] No runtime errors on editor initialization

#### LogStore Singleton Removal
- [ ] Singleton export removed from `src/editor/logStore.ts` (delete `export const logStore = new LogStore()`)
- [ ] `logStore: LogStore` property added to RootStore
- [ ] LogStore instantiated in RootStore constructor
- [ ] All imports updated that referenced singleton:
  - `src/editor/LogWindow.tsx` updated to use store instance
  - `src/editor/compiler/integration.ts` updated to use `store.logStore`
  - Any other files importing singleton updated
- [ ] React context created for RootStore access if needed
- [ ] TypeScript compilation succeeds
- [ ] All existing log functionality works (logs appear, filters work, clear works)

---

### Deliverable 2: Event Emissions (P1 Items)

#### Patch Lifecycle Events
- [ ] `RootStore.loadPatch()` emits `PatchLoaded` after patch loaded with correct blockCount and connectionCount
- [ ] `RootStore.clearPatch()` emits `PatchCleared` after patch cleared
- [ ] `PatchStore.expandMacro()` emits `MacroExpanded` with:
  - `macroType` set to first block type (expansion.blocks[0]?.type ?? 'unknown')
  - `createdBlockIds` containing all block IDs created from refToId map
- [ ] All emissions happen AFTER state changes committed
- [ ] TypeScript type checking passes for all event payloads

#### Compilation Events
- [ ] `CompilerService.compile()` emits `CompileSucceeded` on success with durationMs
- [ ] `CompilerService.compile()` emits `CompileFailed` on failure (not empty patch) with errorCount
- [ ] Events emitted for both unified and legacy compiler paths
- [ ] CompilerService receives RootStore to access events dispatcher
- [ ] Existing logStore calls remain (not removed in this sprint)
- [ ] TypeScript type checking passes

#### Block Lifecycle Events
- [ ] `PatchStore.addBlock()` emits `BlockAdded` before returning with blockId, blockType, and laneId
- [ ] `PatchStore.removeBlock()` emits `BlockRemoved` after removal with blockId and blockType
- [ ] BlockRemoved captures block type before deletion
- [ ] Events emitted AFTER state changes
- [ ] TypeScript type checking passes

---

### Deliverable 3: Event Listener Integration (P2 Items)

#### MacroExpanded → LogStore Auto-Clear
- [ ] RootStore constructor sets up MacroExpanded listener
- [ ] Listener calls `this.logStore.clear()` if `this.logStore.autoClearOnMacro` is true
- [ ] PatchStore does NOT import logStore (decoupling achieved)
- [ ] Manual test: Load macro with auto-clear ON → logs cleared
- [ ] Manual test: Load macro with auto-clear OFF → logs preserved
- [ ] Manual test: Toggle setting → behavior changes correctly

---

### Deliverable 4: Test Coverage (P2 Items)

#### EventDispatcher Unit Tests
- [ ] File `src/editor/events/__tests__/EventDispatcher.test.ts` created
- [ ] Test: `emit()` calls registered handlers
- [ ] Test: `on()` returns working unsubscribe function
- [ ] Test: `subscribe()` receives all event types
- [ ] Test: Multiple handlers for same event type all called
- [ ] Test: Handler errors are isolated (other handlers still run)
- [ ] Test: Handler errors logged to console.error
- [ ] Test: Handlers called in registration order
- [ ] Test: Unsubscribing works correctly
- [ ] Test: No handlers registered → emit succeeds (no-op)
- [ ] Test coverage >90% for EventDispatcher
- [ ] All tests pass with `just test`

#### Integration Tests
- [ ] File `src/editor/__tests__/event-integration.test.ts` created
- [ ] Test: Loading patch emits PatchLoaded with correct counts
- [ ] Test: Clearing patch emits PatchCleared
- [ ] Test: Expanding macro emits MacroExpanded with correct data
- [ ] Test: Adding block emits BlockAdded
- [ ] Test: Removing block emits BlockRemoved
- [ ] Test: Successful compile emits CompileSucceeded
- [ ] Test: Failed compile emits CompileFailed
- [ ] File `src/editor/__tests__/macro-log-clear.test.ts` created
- [ ] Test: MacroExpanded clears logs when autoClearOnMacro = true
- [ ] Test: MacroExpanded preserves logs when autoClearOnMacro = false
- [ ] Test: Toggling autoClearOnMacro changes behavior
- [ ] All tests pass with `just test`
- [ ] Overall test coverage for event system >80%

---

## Quality Gates

### Code Quality
- [ ] `just typecheck` passes with no errors
- [ ] `just lint` passes with no warnings
- [ ] `just test` passes with all tests green
- [ ] `just check` passes (full check: typecheck + lint + test)
- [ ] No console errors during normal operation
- [ ] No circular dependencies introduced

### Architectural Correctness
- [ ] Events emitted AFTER state changes committed (never before)
- [ ] Handler errors don't crash the application
- [ ] EventDispatcher is synchronous-only (no async handlers)
- [ ] Event system is scoped per RootStore instance (not global singleton)
- [ ] Event payloads are minimal data objects (no methods, no side effects)
- [ ] Type safety enforced (discriminated union exhaustiveness checking works)

### Documentation
- [ ] JSDoc comments on all event types explaining when they're emitted
- [ ] JSDoc on EventDispatcher methods with usage examples
- [ ] Event type union properly exported from `src/editor/events/index.ts`
- [ ] Comments in code explaining why events emitted at specific points

### User-Facing Verification
- [ ] Manual test: Open editor, load macro → logs auto-clear (if setting ON)
- [ ] Manual test: Disable auto-clear setting → logs preserved when loading macro
- [ ] Manual test: Toggle auto-clear setting → behavior changes immediately
- [ ] Manual test: Add/remove blocks → no console errors
- [ ] Manual test: Load/clear patch → no console errors
- [ ] Manual test: Compile success and failure → no console errors
- [ ] No performance degradation observed (event system is fast)

---

## Regression Testing

### Existing Functionality Must Still Work
- [ ] LogWindow displays logs correctly
- [ ] Log filters (level, component) work
- [ ] Manual clear button works
- [ ] Auto-scroll toggle works
- [ ] Patch loading/saving works
- [ ] Macro expansion creates correct blocks and connections
- [ ] Compilation succeeds/fails as before
- [ ] Block add/remove works normally
- [ ] Bus publishers/listeners created during macro expansion

### No Breaking Changes
- [ ] All existing tests pass (no regressions)
- [ ] TypeScript compilation with strict mode succeeds
- [ ] No new warnings in console during normal operations
- [ ] UI remains responsive during event emissions

---

## Definition of Done Checklist

### Phase 1: Foundation Complete
- [ ] All P0 items completed
- [ ] EventDispatcher working
- [ ] LogStore integrated into RootStore
- [ ] Basic manual test: Can emit and receive events

### Phase 2: Emissions Complete
- [ ] All P1 items completed
- [ ] 7 lifecycle events emitted at correct points
- [ ] Global subscriber logs all events during operations

### Phase 3: Integration Complete
- [ ] All P2 items completed
- [ ] MacroExpanded listener working
- [ ] Logs auto-clear when macro loaded (setting ON)
- [ ] Logs preserved when macro loaded (setting OFF)

### Phase 4: Testing Complete
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Test coverage goals met (>80% for event code)
- [ ] Manual testing completed successfully

### Sprint Done
- [ ] All acceptance criteria met
- [ ] All quality gates passed
- [ ] All regression tests passed
- [ ] Code reviewed (if applicable)
- [ ] Documentation complete
- [ ] Ready for /dev-loop:implement

---

## Success Criteria Summary

This sprint is considered successful when:

1. **Event system is functional**: Can emit 7 Phase A events, handlers receive them, errors are isolated
2. **LogStore integrated**: No longer a singleton, owned by RootStore, accessible to all stores
3. **MacroExpanded listener works**: Auto-clear logs feature working correctly based on user setting
4. **Tests comprehensive**: >80% coverage on event code, all tests green
5. **No regressions**: All existing functionality works, no new errors
6. **Code quality maintained**: All checks pass (typecheck, lint, test)
7. **Architecture clean**: Events emitted after state changes, proper scoping, type safety

**The primary user-facing outcome**: Loading a macro clears the log console automatically (if auto-clear setting enabled), providing a clean slate for debugging the new animation.
