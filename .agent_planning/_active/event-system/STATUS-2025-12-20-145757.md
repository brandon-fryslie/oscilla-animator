# Event System Phase B - Current Status

**Generated**: 2025-12-20-145757
**Phase**: B (Cross-store decoupling and UI coordination)
**Previous Phase**: A (Event spine implementation)

---

## Phase A Completion Summary

Phase A successfully established the event infrastructure:

### Implemented Components

1. **EventDispatcher** (`src/editor/events/EventDispatcher.ts`)
   - Synchronous, non-blocking event emission
   - Type-safe event subscriptions via `on(type, handler)`
   - Global event subscriptions via `subscribe(handler)`
   - Error isolation per handler
   - Deterministic handler execution order

2. **Event Types** (`src/editor/events/types.ts`)
   - Discriminated union of all events
   - Type-safe event extraction via `EventOfType<T>`
   - Currently defined events:
     - `MacroExpanded`
     - `PatchLoaded`
     - `PatchCleared`
     - `CompileSucceeded`
     - `CompileFailed`
     - `BlockAdded`
     - `BlockRemoved`

3. **Event Integration**
   - `RootStore` owns `EventDispatcher` instance
   - Events emitted AFTER state changes committed
   - Example integration: `MacroExpanded` → auto-clear logs

4. **Event Emission Points**
   - `PatchStore.addBlock()` → `BlockAdded`
   - `PatchStore.removeBlock()` → `BlockRemoved`
   - `PatchStore.expandMacro()` → `MacroExpanded`
   - `RootStore.loadPatch()` → `PatchLoaded`
   - `RootStore.clearPatch()` → `PatchCleared`
   - `CompilerService.compile()` → `CompileSucceeded` / `CompileFailed`

---

## Current Cross-Store Coupling Analysis

### Store-to-Store Coupling Instances

**Category 1: Selection Management** (BusStore → UIStateStore)
- `BusStore.deleteBus()` (line 153-154): Directly modifies `uiStore.uiState.selectedBusId`
- `PatchStore.removeBlock()` (line 400-401): Directly modifies `uiStore.uiState.selectedBlockId`

**Category 2: Bus Routing** (PatchStore → BusStore)
- `PatchStore.processAutoBusConnections()` (line 133-135, 142-144, 157-159, 166-168): Calls `busStore.addListener()` and `busStore.addPublisher()`
- `PatchStore.expandMacro()` (line 293, 300, 311, 321): Creates bus publishers/listeners
- `PatchStore.removeBlock()` (line 396-397): Directly filters `busStore.publishers` and `busStore.listeners`
- `PatchStore.replaceBlock()` (line 483-512): Creates new bus publishers/listeners for replacement block

**Category 3: Layout Switching** (UIStateStore → PatchStore)
- `UIStateStore.setAdvancedLaneMode()` (line 158-162): Calls `patchStore.switchLayout()` directly

**Category 4: Logging** (Multiple stores → LogStore)
- `PreviewPanel.tsx` (line 148, 152, 157): Direct `logStore.info()` calls
- `compiler/integration.ts` (line 675, 695, 697, 714): Direct `logStore` calls for compilation lifecycle

---

## Missing Events from Design Doc

The design doc (`design-docs/4-Event-System/1-Events.md`) specifies these additional events:

### Bus Lifecycle
- **BindingAdded** (bus listener created)
- **BindingRemoved** (bus listener removed)
- **BusCreated** (new bus created)
- **BusDeleted** (bus removed)

### Runtime Lifecycle
- **TimeRootChanged** (TimeRoot block added/updated)
- **PlaybackStarted** (player started)
- **PlaybackStopped** (player paused)

### Diagnostics
- **DiagnosticAdded** (compilation error/warning)
- **DiagnosticCleared** (errors cleared)

### Additional Patch Events
- **ConnectionAdded** (blocks connected)
- **ConnectionRemoved** (blocks disconnected)
- **BlockParamsUpdated** (block parameters changed)

---

## UI Coordination Opportunities

### Console/Log Panel
- Currently: Direct `logStore.info/warn/error()` calls from various components
- Target: UI components subscribe to domain events and log accordingly
- Example: Compiler emits `CompileSucceeded`, log panel listens and logs

### Diagnostics Panel
- Currently: Pulls decorations from `CompilerService.getDecorations()`
- Target: Subscribe to `DiagnosticAdded` / `DiagnosticCleared` events

### Selection State
- Currently: Direct mutation of `uiStore.selectedBlockId` / `selectedBusId`
- Target: Emit `BlockSelected` / `BusSelected` events (optional - may be too fine-grained)

### Toasts/Notifications
- Not currently implemented
- Future: Subscribe to high-severity events (`CompileFailed`, `BlockRemoved`, etc.)

---

## Known Constraints

1. **Event Synchronicity**: All events must remain synchronous (design requirement)
2. **Non-blocking**: Event handlers cannot affect control flow
3. **Post-commit**: Events must be emitted AFTER state changes are committed
4. **No Reentrancy**: Events cannot trigger state mutations in domain stores

---

## Test Coverage

Current test files:
- No dedicated event system tests yet
- Events tested implicitly via integration tests

Needed:
- Unit tests for new event types
- Integration tests for cross-store decoupling
- Event emission verification tests

---

## Technical Debt

1. **Direct Store Mutations**: Multiple stores directly mutate other stores' state
2. **Logging Coupling**: Components directly call `logStore` instead of emitting events
3. **Missing Granularity**: Some state changes (connections, params) don't emit events

---

## Metrics

- **Total Events Defined**: 7
- **Event Listeners**: 1 (MacroExpanded → auto-clear logs)
- **Emission Points**: 6 (across PatchStore, RootStore, CompilerService)
- **Cross-Store Coupling Sites**: ~15 identified instances
- **Direct LogStore Calls**: ~10 identified instances
