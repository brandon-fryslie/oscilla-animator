# Status Report: Debug HUD Implementation
**Timestamp**: 2025-12-27-040000
**Scope**: initiative/debugger (Debug HUD subsystem)
**Confidence**: FRESH

## Executive Summary

| Metric | Value |
|--------|-------|
| Overall Completion | ~55% |
| Critical Blockers | 1 (TypeScript errors in codebase prevent full test run) |
| Test Coverage | 0% for debug-ui components |
| Backend Wiring | 0% (busValues never populated by Player) |
| Hover Handlers | 0% (no event handlers for probe mode) |

The Debug HUD UI structure is complete and integrated into Editor.tsx. However, the **critical data path is completely broken**: Player.ts emits `RuntimeHealthSnapshotEvent` but never populates `busValues`, so all value displays show "No value" / "No live value available".

---

## Reused From Previous Evaluations

| Finding | Source | Confidence | Action |
|---------|--------|------------|--------|
| Debug infrastructure (ring buffers, types) | STATUS-20251226.md | RECENT | Carried forward |
| executeDebugProbe implementation | DOD-2025-12-27-005641.md | RECENT | Carried forward |
| Schedule probe insertion | DOD-2025-12-27-005641.md | RECENT | Carried forward |

---

## Runtime Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `just check` | FAIL | 16 TypeScript errors (unrelated to debug-ui, but blocks test run) |
| `just test run` | NOT RUN | Blocked by typecheck failure |
| Debug UI unit tests | NOT FOUND | No `__tests__/` directory in `src/editor/debug-ui/` |

### TypeScript Errors (not debug-ui related, but blocking)
```
- src/editor/blocks/domain.ts(1270): "Signal<path>" not assignable to SlotType
- src/editor/BusChannel.tsx(66,67): getPublishersByBus/getListenersByBus missing
- src/editor/compiler/blocks/domain/PathConst.ts: path type errors
- src/editor/compiler/ir/buildSchedule.ts(142,422): StepMeshMaterialize missing 'id'
- src/editor/stores/BusStore.ts(18): unused import
```

---

## What Exists

### 1. Debug UI Components [COMPLETE - UI Only]

| Component | File | Status | Evidence |
|-----------|------|--------|----------|
| DebugHUD | `src/editor/debug-ui/DebugHUD.tsx` | COMPLETE | Shows 4 status lights (Clock, Health, Perf, Stability) |
| DebugDrawer | `src/editor/debug-ui/DebugDrawer.tsx` | COMPLETE | Slide-up panel with tab navigation |
| OverviewTab | `src/editor/debug-ui/OverviewTab.tsx` | COMPLETE | Shows time model, bus heatmap, top issues |
| BusesTab | `src/editor/debug-ui/BusesTab.tsx` | COMPLETE | Lists buses with meters (but no values) |
| BusValueMeter | `src/editor/debug-ui/BusValueMeter.tsx` | COMPLETE | Visualizes number/phase/color/trigger/bool |
| ProbeToggle | `src/editor/debug-ui/ProbeToggle.tsx` | COMPLETE | Toggle button for probe mode |
| ProbeCard | `src/editor/debug-ui/ProbeCard.tsx` | COMPLETE | Floating popup for hovered elements |

### 2. DebugUIStore [COMPLETE]
**File**: `src/editor/stores/DebugUIStore.ts`

- Drawer state management (open/close, active tab)
- Probe mode state (active, target, cursor position)
- Health snapshot caching (subscribes to RuntimeHealthSnapshot events)
- Computed health/stability status

### 3. Editor Integration [COMPLETE]
**File**: `src/editor/Editor.tsx:56,508-518,1127-1133`

- Imports debug-ui components
- Renders DebugHUD, DebugDrawer, ProbeToggle, ProbeCard
- Adds `probe-mode-active` class to body when probe mode enabled

### 4. Event Types [COMPLETE]
**File**: `src/editor/events/types.ts:468-469`

```typescript
/** Current bus values for debug UI (sampled at snapshot time) */
busValues?: Record<string, import('../debug/types').ValueSummary>;
```

The type exists but is never populated.

---

## What's Missing

### 1. Player Backend Wiring [CRITICAL - NOT STARTED]

**File**: `src/editor/runtime/player.ts:436-451`

The `emitHealthSnapshot()` method emits RuntimeHealthSnapshotEvent but NEVER populates `busValues`:

```typescript
this.events.emit({
  type: 'RuntimeHealthSnapshot',
  // ... other fields ...
  evalStats: {
    nanCount: this.nanCount,
    infCount: this.infCount,
    fieldMaterializations: 0, // Not tracked yet
  },
  // busValues: NOT INCLUDED
});
```

**Required Changes**:
1. Sample current bus values from BusStore or runtime state
2. Convert to ValueSummary using `summarize()` from `debug/types.ts`
3. Include in `busValues` field of emitted event

**Ambiguity**: Where do bus values live at runtime?
- Option A: Query BusStore.buses[].currentValue (if such a field exists)
- Option B: Query IR runtime state (ScheduleExecutor value slots)
- Option C: Maintain separate bus value cache in Player

### 2. Probe Mode Hover Handlers [NOT STARTED]

**BusBoard Integration**
- BusBoard.tsx has no hover event handlers
- BusChannel.tsx has no hover event handlers
- Need to add onMouseEnter/onMouseLeave to BusChannel rows
- Should call `debugUIStore.setProbeTarget({ type: 'bus', busId })` on hover

**Block Hover Integration**
- PatchBay blocks have no probe-mode-aware hover handlers
- Need to add similar handlers to block components
- ProbeCard already supports `{ type: 'block', blockId }` targets

**Cursor Position Tracking**
- DebugUIStore has `updateCursorPosition()` method
- Need to wire document-level mousemove event when probe mode active

### 3. Unit Tests [NOT STARTED]

No `__tests__/` directory exists under `src/editor/debug-ui/`.

**Recommended Tests**:
| Component | Test Cases |
|-----------|------------|
| DebugHUD | Renders 4 lights; status colors correct; opens drawer on click |
| DebugDrawer | Opens/closes; tab switching works; renders correct tab content |
| BusesTab | Shows "No buses" when empty; renders bus rows; shows "No value" when no busValues |
| ProbeCard | Returns null for null target; renders bus info; renders block info |
| ProbeToggle | Toggles probe mode; shows active state |
| DebugUIStore | toggleProbeMode(); setProbeTarget(); updateHealthSnapshot() |

---

## Data Flow Verification

| Step | Status | Notes |
|------|--------|-------|
| Player runs at 60fps | WORKS | RAF loop confirmed |
| Player emits health snapshot at 4Hz | WORKS | `HEALTH_EMIT_INTERVAL_MS = 250` |
| Health snapshot includes busValues | BROKEN | Field never populated |
| DebugUIStore receives snapshot | WORKS | Event subscription at line 235 |
| BusesTab reads busValues | WORKS | `snapshot?.busValues?.[bus.id]` at line 28 |
| BusValueMeter displays value | WORKS | Renders correctly when value provided |

**The gap**: Step 3 - Player never populates busValues.

---

## Ambiguities Found

| Area | Question | How LLM Might Guess | Impact |
|------|----------|---------------------|--------|
| Bus value source | Where do runtime bus values come from? | Query BusStore | Wrong if values live in ScheduleExecutor |
| Sampling frequency | Sample all buses or only "active" ones? | Sample all | Performance impact if 100+ buses |
| Block port values | How to get current value for a block's output port? | Query compiled program | May not work with IR path |
| Probe mode scope | Does probe mode work in table view? | No special handling | Inconsistent UX |

### Clarification Needed: Bus Value Source

**Context**: Player needs to sample bus values, but it's unclear where they live.

**Options**:
1. **BusStore.buses**: Add `currentValue` field to Bus model, updated by runtime
   - Pro: Simple, MobX-observable
   - Con: Requires runtime → store coupling

2. **ScheduleExecutor.runtime.values**: Query slot values directly
   - Pro: Accurate to actual runtime state
   - Con: Requires slot ID → bus ID mapping

3. **Separate ValueCache**: Player maintains its own bus value snapshot
   - Pro: Decoupled, easy to throttle
   - Con: Duplication, sync issues

**Recommendation**: Option 1 is simplest for MVP. The BusStore already exists and is observable by UI.

---

## Implementation Assessment

| Component | Status | Confidence | Evidence | Issues |
|-----------|--------|------------|----------|--------|
| DebugHUD UI | COMPLETE | FRESH | Renders in Editor | None |
| DebugDrawer UI | COMPLETE | FRESH | Tab switching works | None |
| BusesTab UI | COMPLETE | FRESH | Renders bus list | Shows "No value" (expected until wired) |
| ProbeCard UI | COMPLETE | FRESH | Code inspection | Not testable (no hover handlers) |
| DebugUIStore | COMPLETE | FRESH | Store exists, subscribes to events | None |
| Player bus sampling | NOT STARTED | FRESH | `busValues` never set | CRITICAL GAP |
| BusBoard hover | NOT STARTED | FRESH | No onMouseEnter handlers | Required for probe mode |
| Block hover | NOT STARTED | FRESH | No onMouseEnter handlers | Required for probe mode |
| Unit tests | NOT STARTED | FRESH | No `__tests__/` directory | 0% coverage |

---

## Recommendations

### Priority 1: Fix TypeScript Errors (Prerequisite)
The codebase has 16 TypeScript errors that block `just check`. These should be fixed before any debug work.

### Priority 2: Wire Player Backend (Critical Path)
1. Determine bus value source (recommend: add `currentValue` to BusStore)
2. Update ScheduleExecutor or runtime to update BusStore.buses[].currentValue
3. In Player.emitHealthSnapshot(), iterate buses and build busValues map
4. Use `summarize()` from debug/types.ts for ValueSummary conversion

### Priority 3: Add Hover Handlers
1. Add onMouseEnter/onMouseLeave to BusChannel component
2. When probe mode active and hovering, call `debugUIStore.setProbeTarget()`
3. Add document-level mousemove listener for cursor position (throttled)
4. Repeat for block components in PatchBay

### Priority 4: Unit Tests
Create `src/editor/debug-ui/__tests__/` with tests for all components.

---

## Workflow Recommendation

- [x] CONTINUE - Next steps are clear, no blocking ambiguities

**Immediate Actions**:
1. Decide bus value source (recommend: BusStore.currentValue)
2. Fix TypeScript errors (blocking tests)
3. Implement Player.emitHealthSnapshot() busValues population
4. Add BusChannel hover handlers
5. Write unit tests incrementally

---

## Files Summary

### Debug UI Components (All Complete - UI Only)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/DebugHUD.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/DebugDrawer.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/OverviewTab.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/BusesTab.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/BusValueMeter.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/ProbeCard.tsx`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/ProbeToggle.tsx`

### Backend Files Requiring Changes
- `/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/player.ts:436-451` - Add busValues to emitHealthSnapshot()
- `/Users/bmf/code/oscilla-animator_codex/src/editor/BusChannel.tsx` - Add hover handlers
- `/Users/bmf/code/oscilla-animator_codex/src/editor/stores/BusStore.ts` - Potentially add currentValue field

### Supporting Files (Complete)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/stores/DebugUIStore.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/events/types.ts:468-469` - busValues type
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug/types.ts` - ValueSummary, summarize()
