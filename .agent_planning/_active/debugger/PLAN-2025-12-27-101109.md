# Debug HUD Completion - Sprint Plan
**Generated**: 2025-12-27-101109
**Source**: STATUS-2025-12-27-040000.md
**Topic**: Debug HUD backend wiring and Probe Mode interactions

---

## Executive Summary

**Current State**: Debug HUD UI is complete (DebugHUD, DebugDrawer, ProbeCard, BusesTab, OverviewTab), but the critical data path is broken. Player emits health snapshots but never populates `busValues`, so all value displays show "No value". Probe Mode UI exists but has no hover handlers. No unit tests exist for debug-ui components.

**Completion**: ~55% (UI complete, backend 0%, hover handlers 0%, tests 0%)

**Sprint Scope**:
1. Wire Player backend to populate `busValues` in health snapshots (P0)
2. Add hover event handlers to BusBoard rows and block ports for Probe Mode (P1)
3. Add unit tests for Debug UI components (P2)

**Out of Scope**:
- Fixing TypeScript errors in other parts of codebase (separate issue)
- Block port value inspection (deferred to next sprint)
- Advanced probe features (sparklines, historical data)

---

## Gap Analysis

### Architecture Components
| Component | Current State | Required State | Gap |
|-----------|---------------|----------------|-----|
| Player.emitHealthSnapshot() | Emits event without busValues | Must populate busValues field | CRITICAL - zero backend wiring |
| BusStore | Has buses array, no currentValue | Need runtime value access | Missing value source |
| ScheduleExecutor | Runs IR, stores values in ValueStore | Need to expose bus values | No query interface |
| BusChannel.tsx | Renders bus rows | Needs onMouseEnter/onMouseLeave | No hover handlers |
| DebugUIStore | Stores probe target | Ready for hover integration | No consumers |

### Data Flow Requirements
**Target Flow**:
1. ScheduleExecutor executes frame → values stored in RuntimeState.values (ValueStore)
2. Player samples bus values from ValueStore after execution
3. Player converts values to ValueSummary using `summarize()`
4. Player includes busValues map in RuntimeHealthSnapshotEvent
5. DebugUIStore receives event and caches busValues
6. BusesTab reads busValues from DebugUIStore and displays

**Current Reality**:
- Steps 1, 5, 6 work
- Steps 2-4 are COMPLETELY MISSING

---

## P0: Wire Player Backend to Populate busValues

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None
**Spec Reference**: design-docs/11-Debugger/3-NonTech-LowLevel.md §ValueSummary • **Status Reference**: STATUS-2025-12-27-040000.md §What's Missing #1

### Description
The Player.emitHealthSnapshot() method currently emits RuntimeHealthSnapshotEvent but never populates the `busValues` field. This is the critical missing link that breaks all debug value displays. We need to sample current bus values from the runtime and include them in the health snapshot.

**Technical Approach**:
1. **Value Source Decision**: Query RuntimeState.values (ValueStore) to get slot values
2. **Bus-to-Slot Mapping**: Use compiled program's bus mapping to find which slots correspond to buses
3. **Sampling Logic**: After frame execution, before emitting health snapshot, iterate buses and sample values
4. **Value Conversion**: Use `summarize(kind, value)` from debug/types.ts to convert to ValueSummary
5. **Event Emission**: Include busValues map in emitted event

**Implementation Plan**:
1. Add helper method to Player: `private sampleBusValues(): Record<string, ValueSummary>`
2. Query rootStore.busStore.buses to get all bus IDs
3. For each bus, determine the correct slot ID from the compiled program
4. Read slot value from this.runtime.values
5. Convert value to ValueSummary using bus type (signal:phase, signal:number, etc.)
6. Return map of busId → ValueSummary
7. Call sampleBusValues() in emitHealthSnapshot() and include in event payload

### Acceptance Criteria (REQUIRED)
- [ ] Player.emitHealthSnapshot() includes non-empty busValues field when buses exist
- [ ] busValues contains entries for all active buses in the patch
- [ ] Each ValueSummary has correct type tag (t: 'num', 'phase', 'bool', etc.) matching bus domain
- [ ] BusesTab displays actual values instead of "No value" when running
- [ ] Health snapshot sampling does not cause frame drops (verify 60fps maintained)
- [ ] Unit test: Player.emitHealthSnapshot() populates busValues for phase/number/color buses
- [ ] Unit test: summarize() correctly converts phase/number/trigger values to ValueSummary
- [ ] Integration test: Full frame execution → health snapshot → busValues populated

### Technical Notes

**Bus-to-Slot Mapping Strategy**:
The compiled program likely has a mapping from bus IDs to slot IDs in the schedule. We need to:
1. Check `CompiledProgramIR.schedule` for bus-related metadata
2. Look for busEval steps that write to specific slots
3. Use those slots to query RuntimeState.values

**Alternative Approach** (if bus mapping is unavailable):
1. Add a `currentValue` field to the Bus model in BusStore
2. Have ScheduleExecutor update BusStore.buses[].currentValue after each busEval step
3. Player samples from BusStore.buses[].currentValue instead of ValueStore

**Recommendation**: Prefer direct ValueStore sampling (approach 1) to avoid tight coupling between runtime and stores. Only fall back to BusStore.currentValue if slot mapping is unavailable.

**Error Handling**:
- If a bus has no publishers, use bus.defaultValue
- If a slot read fails, return { t: 'none' }
- Handle NaN/Infinity with { t: 'err', code: 'nan' | 'inf' }

---

## P1: Add Hover Event Handlers for Probe Mode

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None (P0 enables value display, but hover works independently)
**Spec Reference**: design-docs/11-Debugger/3-NonTech-LowLevel.md §Probe • **Status Reference**: STATUS-2025-12-27-040000.md §What's Missing #2

### Description
Probe Mode is a hover-based inspection mode that displays live values in a floating ProbeCard. The UI exists but has no event handlers. When probe mode is active, hovering over bus rows in BusBoard should call `debugUIStore.setProbeTarget({ type: 'bus', busId })` and update cursor position.

**Scope for This Sprint**:
- BusBoard hover handlers (bus rows in side panel)
- Cursor position tracking
- ProbeCard positioning

**Deferred to Next Sprint**:
- Block port hover handlers (more complex, requires PatchBay integration)
- Block output value inspection (requires block-to-slot mapping)

### Acceptance Criteria (REQUIRED)
- [ ] BusChannel component has onMouseEnter/onMouseLeave handlers
- [ ] When probe mode active, hovering over bus row calls debugUIStore.setProbeTarget({ type: 'bus', busId })
- [ ] When probe mode inactive, hover handlers are no-ops (don't call setProbeTarget)
- [ ] ProbeCard appears at cursor position when hovering over bus in probe mode
- [ ] ProbeCard displays bus name, type, and current value (from busValues)
- [ ] Document-level mousemove listener updates cursor position (throttled to 16ms/60fps)
- [ ] Cursor position listener is added when probe mode enabled, removed when disabled
- [ ] Unit test: BusChannel onMouseEnter calls debugUIStore.setProbeTarget when probe mode active
- [ ] Unit test: BusChannel onMouseEnter does nothing when probe mode inactive
- [ ] Integration test: Hover over bus in probe mode → ProbeCard appears with correct data

### Technical Notes

**Hover Handler Pattern**:
```tsx
// In BusChannel.tsx
const { debugUIStore } = useStore();
const isProbeMode = debugUIStore.probeModeActive;

const handleMouseEnter = (e: React.MouseEvent) => {
  if (!isProbeMode) return;
  debugUIStore.setProbeTarget({ type: 'bus', busId: bus.id });
};

const handleMouseLeave = () => {
  if (!isProbeMode) return;
  debugUIStore.setProbeTarget(null);
};

return (
  <div
    className="bus-channel"
    onMouseEnter={handleMouseEnter}
    onMouseLeave={handleMouseLeave}
  >
    {/* ... */}
  </div>
);
```

**Cursor Position Tracking**:
Add to DebugUIStore or Editor.tsx:
```tsx
useEffect(() => {
  if (!debugUIStore.probeModeActive) return;

  const handleMouseMove = throttle((e: MouseEvent) => {
    debugUIStore.updateCursorPosition(e.clientX, e.clientY);
  }, 16); // 60fps throttle

  document.addEventListener('mousemove', handleMouseMove);
  return () => document.removeEventListener('mousemove', handleMouseMove);
}, [debugUIStore.probeModeActive]);
```

**ProbeCard Data Source**:
ProbeCard already supports `{ type: 'bus', busId }` targets. When target is set:
1. Look up bus in busStore
2. Look up value in latestHealthSnapshot.busValues[busId]
3. Display using BusValueMeter component

**Performance Considerations**:
- Throttle mousemove to 16ms (60fps) to avoid excessive updates
- Only attach mousemove listener when probe mode is active
- Remove listener when probe mode disabled

---

## P2: Add Unit Tests for Debug UI Components

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None (can run in parallel with P0/P1)
**Spec Reference**: CLAUDE.md §Critical Rules (Tests are NOT a reliable indicator) • **Status Reference**: STATUS-2025-12-27-040000.md §What's Missing #3

### Description
Currently there are zero unit tests for debug-ui components. We need to create a test suite covering component rendering, user interactions, and store integration. Focus on testable logic, not visual regression.

**Test Coverage Goals**:
- DebugHUD: Status light rendering and drawer toggle
- DebugDrawer: Open/close and tab switching
- BusesTab: Bus list rendering and value display
- ProbeCard: Target rendering (bus/block/binding)
- ProbeToggle: Probe mode toggle
- DebugUIStore: State management and snapshot handling

### Acceptance Criteria (REQUIRED)
- [ ] Test directory created: `src/editor/debug-ui/__tests__/`
- [ ] DebugHUD.test.tsx: Renders 4 status lights, opens drawer on click, shows correct status colors
- [ ] DebugDrawer.test.tsx: Opens/closes, tab switching works, renders correct tab content
- [ ] BusesTab.test.tsx: Shows "No buses" when empty, renders bus rows, shows "No value" when busValues empty
- [ ] ProbeCard.test.tsx: Returns null for null target, renders bus info, renders block info
- [ ] ProbeToggle.test.tsx: Toggles probe mode, shows active state
- [ ] DebugUIStore.test.tsx: toggleProbeMode(), setProbeTarget(), updateHealthSnapshot() work correctly
- [ ] All tests pass with `just test`
- [ ] Test coverage report shows >80% coverage for debug-ui components
- [ ] Tests use React Testing Library for component tests
- [ ] Tests use Vitest for unit tests

### Technical Notes

**Test Structure**:
```
src/editor/debug-ui/__tests__/
├── DebugHUD.test.tsx
├── DebugDrawer.test.tsx
├── BusesTab.test.tsx
├── ProbeCard.test.tsx
├── ProbeToggle.test.tsx
├── BusValueMeter.test.tsx
└── DebugUIStore.test.tsx
```

**Test Patterns**:

**Component Tests** (React Testing Library):
```tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { DebugHUD } from '../DebugHUD';

test('DebugHUD renders 4 status lights', () => {
  render(<DebugHUD />);
  expect(screen.getByTitle(/Clock/)).toBeInTheDocument();
  expect(screen.getByTitle(/Health/)).toBeInTheDocument();
  // ...
});

test('DebugHUD opens drawer on click', () => {
  const store = createMockStore();
  render(<DebugHUD />);
  fireEvent.click(screen.getByRole('button'));
  expect(store.debugUIStore.toggleDrawer).toHaveBeenCalled();
});
```

**Store Tests** (Vitest):
```tsx
import { describe, test, expect } from 'vitest';
import { DebugUIStore } from '../stores/DebugUIStore';

describe('DebugUIStore', () => {
  test('toggleProbeMode() switches state', () => {
    const store = new DebugUIStore(mockRootStore);
    expect(store.probeModeActive).toBe(false);
    store.toggleProbeMode();
    expect(store.probeModeActive).toBe(true);
  });

  test('setProbeTarget() updates target', () => {
    const store = new DebugUIStore(mockRootStore);
    store.setProbeTarget({ type: 'bus', busId: 'bus-123' });
    expect(store.probeTarget).toEqual({ type: 'bus', busId: 'bus-123' });
  });
});
```

**Mock Store Setup**:
Create `src/editor/debug-ui/__tests__/helpers/mockStore.ts`:
```tsx
export function createMockStore() {
  return {
    debugUIStore: {
      drawerOpen: false,
      activeTab: 'overview',
      probeModeActive: false,
      probeTarget: null,
      toggleDrawer: vi.fn(),
      setActiveTab: vi.fn(),
      toggleProbeMode: vi.fn(),
      setProbeTarget: vi.fn(),
    },
    busStore: {
      buses: [],
    },
    // ... other stores
  };
}
```

**Testing Priority**:
1. DebugUIStore (highest priority - core state management)
2. ProbeCard (critical for probe mode)
3. BusesTab (value display verification)
4. DebugHUD, DebugDrawer, ProbeToggle (UI state)
5. BusValueMeter (visualization component)

**Note on "Tests are NOT a reliable indicator"**:
Per CLAUDE.md, we should verify behavior with Chrome DevTools MCP, not just tests. After tests pass, manually verify in browser that:
- Hovering over buses in probe mode shows ProbeCard
- Bus values update at 4Hz
- Probe mode toggle works
- Drawer opens/closes smoothly

---

## Dependency Graph

```
P0: Wire Player Backend (busValues population)
  ├─→ Enables: Value display in BusesTab
  └─→ Enables: ProbeCard value display

P1: Add Hover Handlers (Probe Mode)
  ├─→ Depends on: None (works independently)
  └─→ Enhanced by: P0 (values display when hovering)

P2: Add Unit Tests
  ├─→ Depends on: None (can run in parallel)
  └─→ Verifies: P0 and P1 implementations
```

**Recommended Sprint Flow**:
1. **Week 1**: P0 (busValues wiring) - CRITICAL PATH
2. **Week 2**: P1 (hover handlers) + P2 (tests in parallel)
3. **Week 3**: Integration testing + manual verification with DevTools

---

## Risk Assessment

### High-Risk Items

**1. Bus-to-Slot Mapping Unavailable (P0)**
- **Risk**: CompiledProgramIR may not have explicit bus-to-slot mapping
- **Impact**: Cannot sample bus values from ValueStore
- **Mitigation**: Fall back to adding `currentValue` field to BusStore model, updated by ScheduleExecutor
- **Detection**: Inspect CompiledProgramIR structure in debugger or unit tests

**2. TypeScript Errors Block Test Execution**
- **Risk**: STATUS reports 16 TypeScript errors that prevent `just check` from passing
- **Impact**: Cannot run unit tests until fixed
- **Mitigation**: Fix TypeScript errors as prerequisite (separate issue, not in this sprint scope)
- **Detection**: Run `just check` before starting sprint

**3. Performance Degradation from Health Snapshot Sampling**
- **Risk**: Iterating all buses at 4Hz may cause frame drops
- **Impact**: Debug overhead impacts playback smoothness
- **Mitigation**: Profile with Chrome DevTools, sample only "active" buses if needed
- **Detection**: Monitor frame time with Player.calculateWorstFrameTime()

### Medium-Risk Items

**4. ProbeCard Positioning Edge Cases**
- **Risk**: ProbeCard may render off-screen near viewport edges
- **Impact**: User cannot see probe values
- **Mitigation**: Implement boundary detection and flip positioning
- **Detection**: Manual testing with probe mode near screen edges

**5. Hover Handler Event Propagation**
- **Risk**: Bus row clicks may conflict with probe mode hover
- **Impact**: Confusing UX where clicking selects bus instead of probing
- **Mitigation**: Use stopPropagation() for probe mode interactions
- **Detection**: Manual testing with probe mode enabled

---

## Out of Scope (Deferred)

### Block Port Inspection (Next Sprint)
**Reason**: Requires PatchBay integration and block-to-slot mapping, which is more complex than bus inspection. Split into separate sprint to limit scope.

**Requirements for Future Sprint**:
- Add hover handlers to block components in PatchBay
- Map block output ports to ValueStore slots
- Display block port values in ProbeCard
- Handle Field outputs (show "lazy expression, not materialized")

### Advanced Probe Features (Future)
**Deferred Features**:
- Historical value sparklines (requires ring buffer sampling)
- Probe pinning (persistent probes that don't disappear on hover)
- Multi-probe comparison (side-by-side value inspection)
- Probe breakpoints (pause execution when value meets condition)

### TypeScript Error Fixes (Separate Issue)
**Not in Sprint Scope**:
The STATUS report lists 16 TypeScript errors in unrelated files:
- src/editor/blocks/domain.ts (Signal<path> type errors)
- src/editor/BusChannel.tsx (missing getPublishersByBus/getListenersByBus - **NOTE: These methods DO exist, this may be a stale error**)
- src/editor/compiler/blocks/domain/PathConst.ts (path type errors)
- src/editor/compiler/ir/buildSchedule.ts (StepMeshMaterialize missing 'id')

These should be fixed as a prerequisite, but are NOT part of this sprint's scope.

---

## Definition of Done

**Sprint is complete when**:
1. Player.emitHealthSnapshot() populates busValues field with actual runtime values
2. BusesTab displays live values for all buses (verified in browser)
3. Hovering over bus rows in probe mode shows ProbeCard with bus info
4. All unit tests pass (`just check` succeeds)
5. Manual verification with Chrome DevTools confirms:
   - Bus values update at 4Hz
   - Probe mode hover works smoothly
   - No frame drops during debug sampling
6. Documentation: Add code comments explaining bus sampling logic
7. Code review: All PRs approved and merged

**Acceptance Testing**:
1. Load "Breathing Constellation" patch (golden reference)
2. Enable probe mode
3. Hover over "phaseA" bus in BusBoard
4. Verify ProbeCard shows: name="phaseA", type="signal:phase", value=(animated 0-100%)
5. Disable probe mode
6. Verify ProbeCard disappears
7. Open Debug Drawer → Buses tab
8. Verify all buses show live values (not "No value")

---

## Files Requiring Changes

### Backend Files (P0)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/player.ts:436-451` - Add busValues to emitHealthSnapshot()
- `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/ir/program.ts` - Verify bus-to-slot mapping availability
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug/types.ts` - Already complete (summarize function exists)

### UI Files (P1)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/BusChannel.tsx` - Add onMouseEnter/onMouseLeave handlers
- `/Users/bmf/code/oscilla-animator_codex/src/editor/Editor.tsx` - Add mousemove listener for cursor tracking
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/ProbeCard.tsx` - Already complete (supports bus targets)

### Test Files (P2)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/DebugHUD.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/DebugDrawer.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/BusesTab.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/ProbeCard.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/ProbeToggle.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/BusValueMeter.test.tsx` - NEW
- `/Users/bmf/code/oscilla-animator_codex/src/editor/stores/__tests__/DebugUIStore.test.tsx` - NEW (if doesn't exist)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/debug-ui/__tests__/helpers/mockStore.ts` - NEW (test helpers)

### Supporting Files (Reference Only)
- `/Users/bmf/code/oscilla-animator_codex/src/editor/stores/DebugUIStore.ts` - Already complete
- `/Users/bmf/code/oscilla-animator_codex/src/editor/events/types.ts:468-469` - busValues type already exists
- `/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/executor/RuntimeState.ts` - Reference for ValueStore access
- `/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/executor/ScheduleExecutor.ts` - Reference for frame execution

---

## Blockers and Questions

### Blocker: TypeScript Errors
**Context**: STATUS reports 16 TypeScript errors that block `just check`
**Question**: Should we fix these as part of this sprint or as a prerequisite?
**Recommendation**: Fix as prerequisite (separate issue) before starting this sprint

### Question: Bus-to-Slot Mapping
**Context**: Player needs to sample bus values from ValueStore
**Question**: Does CompiledProgramIR have explicit bus-to-slot mapping metadata?
**Investigation Needed**:
1. Inspect CompiledProgramIR.schedule.steps (look for busEval steps)
2. Check if busEval.outSlot corresponds to bus ID
3. If mapping unavailable, implement BusStore.currentValue fallback

**Recommendation**: Start with ValueStore sampling, fall back to BusStore.currentValue if needed

### Question: Probe Mode Scope
**Context**: User requested "block port inspection" but this is complex
**Question**: Is block port hover in scope for this sprint?
**Clarification**: STATUS and user constraints say "Maximum 2-3 deliverables per sprint"
**Recommendation**: Defer block port inspection to next sprint, focus on bus hover only

---

## Sprint Backlog Summary

| Priority | Item | Effort | Dependencies | Deliverable |
|----------|------|--------|--------------|-------------|
| P0 | Wire Player backend busValues | Medium | None | Player samples and emits bus values |
| P1 | Add BusBoard hover handlers | Small | None | Probe mode shows ProbeCard on bus hover |
| P2 | Add unit tests for debug-ui | Medium | None | 80%+ test coverage for debug-ui |

**Total Effort**: 2-3 weeks for 1 developer
**Sprint Goal**: Make Debug HUD fully functional with live bus values and basic probe mode
