# Definition of Done: Debug HUD Completion
**Generated**: 2025-12-27-101109
**Plan**: PLAN-2025-12-27-101109.md
**Topic**: Debug HUD backend wiring and Probe Mode interactions

---

## Sprint Scope

This sprint delivers:
1. **Player Backend Wiring** - busValues populated in health snapshots
2. **Probe Mode Hover** - Bus row hover handlers and ProbeCard display
3. **Unit Tests** - Test coverage for all debug-ui components

Deferred:
- Block port inspection (next sprint)
- TypeScript error fixes in unrelated files (separate issue)
- Advanced probe features (sparklines, pinning, breakpoints)

---

## Acceptance Criteria

### Deliverable 1: Player Backend Wiring (P0 - CRITICAL)

**Functionality**:
- [ ] Player.emitHealthSnapshot() includes non-empty busValues field when buses exist
- [ ] busValues contains entries for all active buses in the patch
- [ ] Each ValueSummary has correct type tag (t: 'num', 'phase', 'bool', etc.) matching bus domain
- [ ] BusesTab displays actual values instead of "No value" when running
- [ ] Health snapshot sampling does not cause frame drops (verify 60fps maintained)

**Testing**:
- [ ] Unit test: Player.emitHealthSnapshot() populates busValues for phase/number/color buses
- [ ] Unit test: summarize() correctly converts phase/number/trigger values to ValueSummary
- [ ] Integration test: Full frame execution → health snapshot → busValues populated

**Code Quality**:
- [ ] Code comments explain bus-to-slot mapping logic
- [ ] Error handling for missing buses, NaN/Infinity values
- [ ] Performance profiling shows <1ms overhead per health snapshot

---

### Deliverable 2: Probe Mode Hover Handlers (P1)

**Functionality**:
- [ ] BusChannel component has onMouseEnter/onMouseLeave handlers
- [ ] When probe mode active, hovering over bus row calls debugUIStore.setProbeTarget({ type: 'bus', busId })
- [ ] When probe mode inactive, hover handlers are no-ops (don't call setProbeTarget)
- [ ] ProbeCard appears at cursor position when hovering over bus in probe mode
- [ ] ProbeCard displays bus name, type, and current value (from busValues)
- [ ] Document-level mousemove listener updates cursor position (throttled to 16ms/60fps)
- [ ] Cursor position listener is added when probe mode enabled, removed when disabled

**Testing**:
- [ ] Unit test: BusChannel onMouseEnter calls debugUIStore.setProbeTarget when probe mode active
- [ ] Unit test: BusChannel onMouseEnter does nothing when probe mode inactive
- [ ] Integration test: Hover over bus in probe mode → ProbeCard appears with correct data

**Code Quality**:
- [ ] Mousemove listener properly cleaned up on unmount
- [ ] Throttling prevents excessive re-renders
- [ ] Event handlers use stopPropagation() to prevent conflicts

---

### Deliverable 3: Unit Tests (P2)

**Test Coverage**:
- [ ] Test directory created: `src/editor/debug-ui/__tests__/`
- [ ] DebugHUD.test.tsx: Renders 4 status lights, opens drawer on click, shows correct status colors
- [ ] DebugDrawer.test.tsx: Opens/closes, tab switching works, renders correct tab content
- [ ] BusesTab.test.tsx: Shows "No buses" when empty, renders bus rows, shows "No value" when busValues empty
- [ ] ProbeCard.test.tsx: Returns null for null target, renders bus info, renders block info
- [ ] ProbeToggle.test.tsx: Toggles probe mode, shows active state
- [ ] DebugUIStore.test.tsx: toggleProbeMode(), setProbeTarget(), updateHealthSnapshot() work correctly
- [ ] All tests pass with `just test`
- [ ] Test coverage report shows >80% coverage for debug-ui components

**Testing Infrastructure**:
- [ ] Tests use React Testing Library for component tests
- [ ] Tests use Vitest for unit tests
- [ ] Mock store helper created in __tests__/helpers/mockStore.ts

**Code Quality**:
- [ ] Tests follow AAA pattern (Arrange, Act, Assert)
- [ ] Test descriptions are clear and descriptive
- [ ] No flaky tests (all tests pass consistently)

---

## Manual Acceptance Testing

**Pre-requisites**:
- [ ] TypeScript errors fixed (run `just check` successfully)
- [ ] All unit tests passing

**Test Scenario: Bus Value Display**
1. Load "Breathing Constellation" patch (or any patch with buses)
2. Verify Debug Drawer → Buses tab shows live values for all buses
3. Verify values update at ~4Hz (250ms intervals)
4. Verify phaseA bus shows animated percentage (0-100%)
5. Verify numeric buses show decimal values with 4 decimal places
6. Verify color buses show hex color codes (#RRGGBB)

**Test Scenario: Probe Mode Hover**
1. Enable probe mode (click ProbeToggle button)
2. Verify body has `probe-mode-active` class
3. Hover over "phaseA" bus in BusBoard
4. Verify ProbeCard appears near cursor
5. Verify ProbeCard shows:
   - Bus name: "phaseA"
   - Bus type: "signal:phase"
   - Current value: (animated 0-100%)
6. Move mouse away from bus row
7. Verify ProbeCard disappears
8. Disable probe mode
9. Hover over bus row
10. Verify ProbeCard does NOT appear

**Test Scenario: Performance**
1. Load patch with 20+ buses
2. Open Performance tab in Chrome DevTools
3. Record while animation runs
4. Verify frame time <16.67ms (60fps)
5. Verify health snapshot overhead <1ms per sample
6. Verify no excessive re-renders in React DevTools

**Test Scenario: Edge Cases**
1. Load patch with zero buses
2. Verify BusesTab shows "No buses" message
3. Create new bus
4. Verify BusesTab immediately shows new bus with value
5. Delete bus while probe mode active and hovering
6. Verify ProbeCard gracefully disappears (no crash)

---

## Code Review Checklist

**Player.ts Changes**:
- [ ] Bus sampling logic is clear and well-commented
- [ ] Error handling covers all edge cases (null buses, missing slots, NaN/Inf)
- [ ] No performance regressions (profiling data included)
- [ ] ValueSummary conversion matches bus domain types

**BusChannel.tsx Changes**:
- [ ] Hover handlers only active when probe mode enabled
- [ ] Event propagation handled correctly
- [ ] No memory leaks (event listeners cleaned up)

**Test Files**:
- [ ] All tests have clear descriptions
- [ ] Mock data is realistic and minimal
- [ ] Tests are independent (no shared state)
- [ ] Coverage includes happy path and edge cases

**General**:
- [ ] No console.log() statements left in code
- [ ] TypeScript strict mode compliance
- [ ] No new ESLint warnings
- [ ] Git commits follow conventional commit format

---

## Documentation Requirements

**Code Comments**:
- [ ] Player.sampleBusValues() has JSDoc explaining bus-to-slot mapping
- [ ] BusChannel hover handlers have inline comments explaining probe mode check
- [ ] Test helpers have JSDoc explaining mock store setup

**Inline Documentation**:
- [ ] Complex logic has explanatory comments
- [ ] TODOs removed or converted to issues
- [ ] No dead code left in files

---

## Sprint Complete When

1. ✓ All acceptance criteria checkboxes marked
2. ✓ All manual test scenarios pass
3. ✓ `just check` passes (typecheck + lint + test)
4. ✓ Code review approved
5. ✓ Manual verification with Chrome DevTools confirms:
   - Bus values update at 4Hz
   - Probe mode hover works smoothly
   - No frame drops during debug sampling
6. ✓ Documentation complete
7. ✓ All PRs merged to main branch

---

## Success Metrics

**Quantitative**:
- Test coverage: >80% for debug-ui components
- Frame time: <16.67ms (60fps maintained)
- Health snapshot overhead: <1ms per sample
- Zero TypeScript errors
- Zero ESLint warnings in debug-ui files

**Qualitative**:
- Debug HUD is "production ready" for daily use
- Probe mode feels responsive and intuitive
- Bus values are accurate and update in real-time
- Code is maintainable and well-documented

---

## Known Limitations (Accepted for This Sprint)

1. **Block port inspection not included** - Deferred to next sprint due to scope constraints
2. **No historical value sparklines** - Future feature, requires ring buffer sampling
3. **No probe pinning** - Future feature, requires persistent probe state
4. **ProbeCard may clip at viewport edges** - Basic positioning only, boundary detection in future sprint
5. **Only bus values sampled** - Block output values require additional block-to-slot mapping work
