# Status Report - Phase 7 Debug Infrastructure Integration

**Timestamp**: 2025-12-25-232500
**Scope**: module/debug-infrastructure
**Confidence**: FRESH
**Git Commit**: 3dc3e2a (compiler_rewrite branch)

## Executive Summary

**Overall**: 75% complete - Core infrastructure files present and tests pass. **Integration with compiler/runtime is NOT implemented**.

**Critical Gaps**:
- No compiler integration (index.ts does not export new modules)
- No runtime integration (instrumentClosure wrappers not connected)
- Missing compilation-time DebugIndex population
- Missing CompileResult.debugIndex field

**Test Quality**: 4/5 - Tests are comprehensive and test real functionality, but test isolation of debug from runtime.

## Evaluation Reuse

- **architecture.md** (STALE, 2 days): Used as context only; compiler has changed significantly with 8-pass pipeline
- No prior debug-specific evaluations found

## Runtime Check Results

| Check | Status | Output Summary |
|-------|--------|----------------|
| `pnpm test -- 'debug'` | PASS | 121 tests across 8 test files in debug/ |
| `just typecheck` | PASS | Clean TypeScript compilation |
| `just check` | NOT_RUN | Would run full test suite |

## What Exists (FRESH)

### Core Infrastructure Files (All Present, All Working)

| File | LOC | Purpose | Test Coverage | Status |
|------|-----|---------|---------------|--------|
| `DebugIndex.ts` | 200 | String interning for ports/buses/blocks | 7 tests | COMPLETE |
| `SpanRing.ts` | 179 | Ring buffer for span records | 12 tests | COMPLETE |
| `ValueRing.ts` | 156 | Ring buffer for value records | 13 tests | COMPLETE |
| `TypeKeyEncoding.ts` | 147 | TypeKey to TypeKeyId mapping | 13 tests | COMPLETE |
| `TraceController.ts` | 125 | Mode switching (off/timing/full) | 17 tests | COMPLETE |
| `SpanTypes.ts` | 146 | SpanKind enum, SpanFlags, SpanData | 8 tests | COMPLETE |
| `ValueRecord.ts` | 374 | ValueRecord32 encoding (scalars, vec2, color, FieldStats) | 21 tests | COMPLETE |
| `instrumentClosure.ts` | 241 | wrapSignalForDebug, wrapFieldForDebug, wrapBusCombineForDebug | 30 tests | COMPLETE |

### Pre-existing Files (Unchanged)

| File | Purpose | Status |
|------|---------|--------|
| `types.ts` | Base debug types (ValueSummary, Probe, Sample) | UNCHANGED |
| `RingBuffer.ts` | Generic ring buffer base class | UNCHANGED |
| `index.ts` | **ONLY exports types.ts and RingBuffer.ts** | INCOMPLETE |

### Test Quality Assessment (FRESH)

| Criterion | Result | Notes |
|-----------|--------|-------|
| Tests fail if implementation deleted? | YES | Tests exercise real logic, not stubs |
| Tests catch obvious bugs? | YES | NaN/Inf detection, ring wrap, encoding roundtrips |
| Tests cover user flows? | PARTIAL | Tests wrappers in isolation, not integrated flow |
| Tests use real systems? | NO | Mock RuntimeCtx, no actual compiler/runtime |
| Tests cover error conditions? | YES | Invalid indices, overwrites, mode switches |

**Test Score**: 4/5 - Solid unit tests but missing integration tests

## What's Missing (Critical)

### M1: index.ts Does Not Export New Modules

**File**: `/Users/bmf/code/oscilla-animator_codex/src/editor/debug/index.ts`

**Current**:
```typescript
export * from './types';
export * from './RingBuffer';
```

**Should Be**:
```typescript
export * from './types';
export * from './RingBuffer';
export * from './DebugIndex';
export * from './SpanRing';
export * from './ValueRing';
export * from './TypeKeyEncoding';
export * from './TraceController';
export * from './SpanTypes';
export * from './ValueRecord';
export * from './instrumentClosure';
```

**Impact**: All new debug infrastructure is inaccessible from outside the debug/ directory

### M2: CompileResult Missing DebugIndex Field

**File**: `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/types.ts`

**Current** `CompileResult` interface (lines 474-490):
```typescript
export interface CompileResult {
  ok: boolean;
  program?: Program<RenderTree>;
  canvasProgram?: CanvasProgram;
  timeModel?: TimeModel;
  errors: readonly CompileError[];
  compiledPortMap?: Map<string, Artifact>;
  ir?: LinkedGraphIR;
  irWarnings?: readonly CompileError[];
}
```

**Missing**:
```typescript
  debugIndex?: DebugIndex;      // String interning for debug traces
  typeKeyTable?: TypeKeyTable;  // TypeKey to ID mapping
```

**Impact**: No way to attach debug index to compiled programs

### M3: DebugIndex Not Populated During Compilation

**Location**: Compiler passes (passes 1-8) do not create or populate DebugIndex

**Required Integration Points**:
1. **Pass 1 (Normalize)**: Create DebugIndex with compileId + patchRevision
2. **Pass 6 (Block Lowering)**: Intern block IDs via `debugIndex.internBlock()`
3. **Pass 7 (Bus Lowering)**: Intern bus IDs via `debugIndex.internBus()`
4. **Pass 8 (Link Resolution)**: Intern port keys via `debugIndex.internPort()`

**Impact**: DebugIndex will be empty even if attached to CompileResult

### M4: Instrumentation Wrappers Not Connected

**Location**: `instrumentClosure.ts` provides wrappers, but:
- No code path calls `wrapSignalForDebug()` on compiled signal closures
- No code path calls `wrapFieldForDebug()` on field closures
- No code path calls `wrapBusCombineForDebug()` on bus combine closures

**Integration Point**: `compileBusAware.ts` (45K LOC) - would need to wrap closures when TraceController.mode !== 'off'

**Impact**: No spans/values will be emitted even with wrappers present

### M5: RuntimeCtx Missing frameId

**File**: `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/types.ts` lines 30-34

**Current**:
```typescript
export interface RuntimeCtx {
  viewport: { w: number; h: number; dpr: number };
  reducedMotion?: boolean;
}
```

**Required**:
```typescript
export interface RuntimeCtx {
  viewport: { w: number; h: number; dpr: number };
  reducedMotion?: boolean;
  frameId?: number;  // For debug span attribution
  tMs?: number;      // Animation time for span recording
}
```

**Note**: `instrumentClosure.ts` already handles missing frameId (defaults to 0), but proper integration requires populating these fields in the Player

### M6: SpanRing/ValueRing Singleton Not Created

**No global or program-attached ring buffers exist**. The design expects:
- SpanRing attached to CompileResult or global singleton
- ValueRing attached to CompileResult or global singleton
- Lifecycle management on hot-reload

**Impact**: Wrappers have nowhere to write spans

## Dependencies and Risks

### Dependency Graph

```
TraceController (singleton)
       |
       v
DebugIndex <---- Pass 1 creates
       |
       +--- internBlock() <---- Pass 6 calls
       +--- internBus()   <---- Pass 7 calls
       +--- internPort()  <---- Pass 8 calls
       |
       v
instrumentClosure
       |
       +--- wrapSignalForDebug() <---- compileBusAware wraps signals
       +--- wrapFieldForDebug()  <---- compileBusAware wraps fields
       +--- wrapBusCombineForDebug() <---- compileBusAware wraps buses
       |
       v
SpanRing / ValueRing <---- Write spans/values
       |
       v
[Future: Debug UI consumption]
```

### Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Performance overhead when tracing enabled | MEDIUM | Fast-path check in wrappers already implemented |
| Ring buffer memory (200K spans default) | LOW | Configurable capacity |
| Hot-reload invalidates DebugIndex IDs | MEDIUM | compileId already tracks this |
| TypeWorld/Domain type mismatch | LOW | TypeKeyEncoding imports from `../types` correctly |

## Ambiguities Found

| Area | Question | How LLM Guessed | Impact |
|------|----------|-----------------|--------|
| Ring buffer lifecycle | Who owns SpanRing/ValueRing? | Not addressed | Must decide: per-compile, global, or Player-owned |
| Integration timing | Wrap closures at compile time or intercept at runtime? | Design says compile-time | Affects where wrappers are applied |
| causalEdge/EdgeRing | Design doc mentions EdgeRing for causal links | Not implemented | Phase 2 of debugger? Or cut? |

## Data Flow Verification

**Intended Flow (NOT WORKING)**:
```
Input: Patch data
   |
   v (Pass 1-8)
Compilation creates DebugIndex with interned IDs
   |
   v (compileBusAware)
Closures wrapped with debug wrappers
   |
   v (Program.signal(tMs, ctx))
Wrappers write spans to SpanRing
   |
   v (if mode='full')
Wrappers write values to ValueRing
   |
   v (Future: Debug UI)
UI reads from rings
```

**Current State**:
- Compilation: DebugIndex NOT created
- Wrapping: Closures NOT wrapped
- Runtime: No spans emitted
- Storage: No rings instantiated

## Implementation Assessment (FRESH)

| Component | Status | Evidence |
|-----------|--------|----------|
| DebugIndex | COMPLETE | 200 LOC, 7 tests, JSON import/export |
| SpanRing | COMPLETE | 179 LOC, 12 tests, columnar storage |
| ValueRing | COMPLETE | 156 LOC, 13 tests, fixed 32-byte records |
| TypeKeyEncoding | COMPLETE | 147 LOC, 13 tests, canonical serialization |
| TraceController | COMPLETE | 125 LOC, 17 tests, localStorage persistence |
| SpanTypes | COMPLETE | 146 LOC, 8 tests, all span kinds defined |
| ValueRecord | COMPLETE | 374 LOC, 21 tests, all encode/decode functions |
| instrumentClosure | COMPLETE | 241 LOC, 30 tests, all three wrappers |
| **Compiler Integration** | NOT_STARTED | No code connects debug to passes |
| **Runtime Integration** | NOT_STARTED | No code wraps closures |
| **index.ts exports** | STUB | Only exports old types |

## Recommendations

### P0 (Blockers)

1. **Update index.ts** - Add exports for all new debug modules (5 min)
2. **Add debugIndex to CompileResult** - Type definition change (10 min)
3. **Create DebugIndex in Pass 1** - Initialize with compileId (30 min)
4. **Populate DebugIndex in Passes 6-8** - Intern IDs during lowering (2 hours)

### P1 (Integration)

5. **Add global SpanRing/ValueRing** - Or attach to CompileResult (1 hour)
6. **Wrap closures in compileBusAware** - When trace mode enabled (4 hours)
7. **Add frameId/tMs to RuntimeCtx** - Player must populate (1 hour)

### P2 (Future)

8. **EdgeRing for causal links** - Per design doc, not implemented
9. **Debug UI consumption** - Not in scope for Phase 7
10. **Performance testing** - Verify overhead in timing mode

## Verdict

- [X] **CONTINUE** - Issues are clear, integration work is well-defined

The core infrastructure is solid and tested. The missing piece is purely integration work connecting the debug system to the compiler passes and runtime. All design decisions have been made per the design docs; implementation is straightforward wiring.

## Missing Checks (Implementer Should Create)

1. **Integration test** - Compile a patch, verify DebugIndex is populated
2. **End-to-end trace test** - Enable tracing, run patch, verify spans in SpanRing
3. **Hot-reload test** - Verify DebugIndex/spans reset on recompile
