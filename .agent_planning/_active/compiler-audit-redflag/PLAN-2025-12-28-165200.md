# Sprint Plan: Compiler IR-Only Blockers - Sprint 0

**Generated:** 2025-12-28-165200
**Source:** STATUS-2025-12-28-154700.md
**Topic:** compiler-audit-redflag
**Scope:** ONE sprint - Fix critical path blockers only

---

## Executive Summary

**Current State:** Test infrastructure is completely broken due to block registry validation failures. 27 test files fail at import before any tests run, blocking all runtime verification of IR compiler fixes.

**Root Cause:** Block definitions created via `createBlock()` factory in `/src/editor/blocks/domain.ts` and other files do NOT set the required `capability` field. The `BlockDefinition` type union requires either:
- `KernelBlockDefinition` with `capability: KernelCapability` and `kernelId: KernelId`
- `PureBlockDefinition` with `capability: 'pure'` and `compileKind: PureCompileKind`

But `createBlock()` factory doesn't set capability, resulting in `capability: undefined` for all blocks.

**Sprint Goal:** Unblock test infrastructure and enable basic IR-only execution for trivial patches.

**Deliverables (2 only):**
1. **Fix block registry validation** - Make all tests runnable
2. **Make IR compilation mandatory** - No silent fallback to legacy

**Deferred:** All other red flags (TimeModel threading, bus lowering, block lowering, etc.) are explicitly out of scope for THIS sprint.

---

## Sprint Scope: What We're Doing

### Deliverable 1: Fix Block Registry Capability Propagation

**Priority:** P0 (CRITICAL - BLOCKING EVERYTHING)
**Effort:** Small (4-6 hours)
**Status:** Not Started
**Dependencies:** None

**Spec Reference:** design-docs/7-Primitives/3-Registry-Gating.md
**Status Reference:** STATUS-2025-12-28-154700.md § "CRITICAL: Test Infrastructure Blocker"

#### Description

The block registry validation runs at module load and expects ALL blocks to have a `capability` field matching their KERNEL_PRIMITIVES entry (or 'pure' if not in the list). Currently, all blocks have `capability: undefined` because:

1. `createBlock()` factory (`src/editor/blocks/factory.ts`) doesn't set capability
2. Block definitions (`src/editor/blocks/domain.ts`, etc.) don't provide capability
3. Validation expects exact match per `KERNEL_PRIMITIVES` allowlist

**The Fix:**

Option A: Enhance `createBlock()` factory to infer capability from KERNEL_PRIMITIVES
Option B: Require all block definitions to explicitly declare capability
**RECOMMENDED: Option A** - less invasive, leverages existing allowlist as source of truth

#### Implementation Steps

1. **Update `createBlock()` factory** (`src/editor/blocks/factory.ts`):
   - Import `isKernelPrimitive()` and `getKernelCapability()` from `kernel-primitives.ts`
   - After validating `type`, check if block is in KERNEL_PRIMITIVES
   - If yes: set `capability` and `kernelId` from allowlist
   - If no: set `capability: 'pure'` and `compileKind: 'expression'` (default)
   - Allow explicit override via definition parameter

2. **Add PureCompileKind default** for pure blocks:
   - Check BlockDefinition interface for required fields
   - Set `compileKind: 'expression'` as safe default (most blocks are expression-based)
   - Document that specialized blocks (macros, composites) can override

3. **Run validation** and verify all 21 mismatched blocks now pass:
   ```bash
   just typecheck  # Should pass
   just test       # All 27 previously-failing files should now load
   ```

4. **Baseline test results**:
   - Document which tests pass/fail AFTER registry fix
   - Identify any NEW failures caused by IR compiler state
   - Create test output snapshot for comparison

#### Acceptance Criteria (REQUIRED)

- [ ] `createBlock()` factory automatically sets `capability` field based on KERNEL_PRIMITIVES
- [ ] All 21 blocks with capability mismatch now validate correctly
- [ ] All 27 test files that failed at import now load successfully
- [ ] TypeScript compilation passes with no type errors
- [ ] Full test suite runs (tests may fail, but files must load)
- [ ] Test baseline documented showing which tests pass/fail after fix

#### Technical Notes

**Files to Modify:**
- `/Users/bmf/code/oscilla-animator_codex/src/editor/blocks/factory.ts`
- Possibly update type imports in factory.ts

**Testing:**
- Watch for blocks that should be pure but are accidentally in KERNEL_PRIMITIVES
- Verify composites and macros correctly get `capability: 'pure'`
- Check that explicit capability in definition overrides inference

---

### Deliverable 2: Make IR Compilation Mandatory

**Priority:** P0 (CRITICAL)
**Effort:** Small (2-4 hours)
**Status:** Not Started
**Dependencies:** Deliverable 1 (tests must run to verify)

**Spec Reference:** Core.md § "IR build is optional and failure is non-fatal"
**Status Reference:** STATUS-2025-12-28-154700.md § "Tier 1: Critical IR-Only Blockers" item 1

#### Description

Currently, IR compilation is optional and can silently fall back to legacy closure-based execution. This violates IR-only expectations and masks regressions.

**Problem Code** (`src/editor/compiler/compileBusAware.ts:777-796`):
```typescript
if (!emitIR) {
  console.log('[IR Debug] emitIR is false, skipping IR compilation');
  return result;
}
// IR failure produces warning, not error
```

**The Fix:**

1. Remove the `emitIR === false` early return path
2. Make IR build failures throw fatal errors instead of warnings
3. Ensure CompiledProgram ALWAYS includes IR, or compilation fails hard

This forces the compiler to confront IR issues rather than hiding behind legacy fallback.

#### Implementation Steps

1. **Remove optional IR build** (`compileBusAware.ts:777-796`):
   - Delete the `if (!emitIR)` early return
   - Make `attachIR()` always execute
   - Remove any conditional IR compilation logic

2. **Convert IR errors from warnings to failures**:
   - Find all `console.warn` calls in IR build path
   - Change to `throw new Error(...)` for compilation failures
   - Keep debug logs for successful operations

3. **Update feature flag semantics** (`featureFlags.ts`):
   - Document that `useUnifiedCompiler` controls which passes run
   - IR emission is ALWAYS on when unified compiler is active
   - Legacy-only mode is explicitly NOT SUPPORTED in IR-only migration

4. **Update tests** to expect hard failures:
   - Find tests that rely on IR fallback behavior
   - Update assertions to expect errors instead of warnings
   - Add tests verifying IR-only mode rejects legacy patterns

5. **Verify with trivial patch**:
   - Create minimal test: FiniteTimeRoot → Render2dCanvas
   - Confirm it compiles to IR without fallback
   - Confirm IR execution produces expected output

#### Acceptance Criteria (REQUIRED)

- [ ] `compileBusAware.ts` has no conditional IR emission logic
- [ ] IR build failures throw errors, not warnings
- [ ] Attempting to compile without IR enabled fails compilation
- [ ] Feature flag parsing correctly interprets `useUnifiedCompiler`
- [ ] Trivial patch (TimeRoot + Render) compiles and executes in IR-only mode
- [ ] Tests verify hard failure when IR compilation encounters errors

#### Technical Notes

**Files to Modify:**
- `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/compileBusAware.ts`
- Possibly `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/featureFlags.ts` (documentation only)

**Known Limitations After This Fix:**
- IR still uses placeholder block lowering (Pass 6)
- TimeModel still hardcoded to infinite
- Buses not evaluated
- Most patches will fail compilation due to missing lowering

**This is EXPECTED and CORRECT** - we want to see failures, not silent fallback.

---

## What We're NOT Doing (Deferred to Future Sprints)

### Explicitly Out of Scope for Sprint 0

The following issues are documented in STATUS but are **NOT** included in this sprint:

#### Tier 1 Issues (Deferred to Sprint 1+)

- **TimeModel Threading** (STATUS item 2) - 2 days, Sprint 1
- **Pass 6 Block Lowering** (STATUS item 3) - 1-2 weeks, Sprint 2
- **Default Sources Lowering** (STATUS item 4) - 3 days, Sprint 1
- **Bus Evaluation Steps** (STATUS item 5) - 1 week, Sprint 3
- **timeDerive tAbsMs Write** (STATUS item 6) - 1 day, Sprint 1
- **Event Bus Lowering** (STATUS item 7) - 1 week, Sprint 3

#### Tier 2 Issues (Deferred to Sprint 4+)

- Type conversion paths
- Field transform chains
- Field reduce implementation
- Bus type support (vec2/color)

#### Tier 3 Issues (Deferred to Sprint 5+)

- Type system unification
- Feature flag parsing bug (minor - doesn't block IR-only)
- Legacy/IR semantic alignment

#### Block-Specific Issues (Deferred)

- ColorLFO HSL→RGB kernel
- DebugDisplay lowering/removal decision
- SVGSampleDomain initialization
- Legacy-only blocks migration

---

## Dependencies and Sequencing

```
Sprint 0 (THIS SPRINT):
  Deliverable 1: Block Registry Fix
    ↓
  Deliverable 2: IR Mandatory
    ↓
  Outcome: Tests run, IR mode fails visibly (expected)

Sprint 1 (NEXT):
  - TimeModel threading
  - timeDerive tAbsMs
  - Default sources lowering
  - Feature flag parsing
  ↓
  Outcome: Basic time topology works

Sprint 2:
  - Pass 6 block lowering (core signal blocks)
  - ColorLFO kernel
  - SVGSampleDomain fix
  ↓
  Outcome: Signal math patches work

Sprint 3:
  - Bus eval steps
  - Event bus lowering
  - Bus type support
  ↓
  Outcome: Bus-driven patches work

Sprint 4+:
  - Type conversions
  - Transform chains
  - Advanced features
```

---

## Risk Assessment

### Low Risk (Deliverable 1)

**Block Registry Fix** is mechanical:
- Well-understood problem
- Clear fix (enhance factory)
- No semantic changes
- Easy to verify (tests load)

**Mitigation:** None needed - straightforward implementation.

### Medium Risk (Deliverable 2)

**IR Mandatory** will expose many failures:
- Lots of tests may fail due to missing IR features
- Developers may be surprised by hard failures
- Need clear communication about expected state

**Mitigation:**
- Document expected failure modes in PLAN
- Create clear error messages for missing lowering
- Baseline test results so we know what's regression vs. expected

### Ambiguities Requiring User Decision

#### Question 1: Block Lowering Strategy (NOT for Sprint 0, but affects Sprint 2+)

**Context:** Pass 6 uses placeholders for most blocks. Should we:

**Options:**
- **A:** Incremental migration (current approach - recommended)
- **B:** Block IR mode until all blocks lowered
- **C:** Allow mixed closure/IR execution

**Impact:** Determines Sprint 2+ scope and timeline

**Recommendation:** Option A - continue incremental, fail visibly for unlowered blocks

#### Question 2: PureCompileKind Default

**Context:** Pure blocks need a `compileKind` field. Options:

**Options:**
- **A:** Default to `'expression'` (most blocks)
- **B:** Require explicit declaration
- **C:** Infer from block structure

**Impact:** How verbose block definitions need to be

**Recommendation:** Option A - safe default, allow override

**DECISION NEEDED:** Confirm Option A before implementing Deliverable 1.

---

## Validation Plan

### After Deliverable 1 (Block Registry)

1. **Validation passes:**
   ```bash
   just typecheck  # No errors
   ```

2. **Tests load:**
   ```bash
   just test  # 127 test files load (may have failures)
   ```

3. **Specific verification:**
   - Inspect BLOCK_DEFS_BY_TYPE for DomainN, GridDomain, etc.
   - Verify capability matches KERNEL_PRIMITIVES
   - Check composites have capability: 'pure'

### After Deliverable 2 (IR Mandatory)

1. **Trivial patch compiles:**
   - Create test: FiniteTimeRoot → Render2dCanvas
   - Verify CompiledProgramIR is populated
   - Verify no legacy closure fallback

2. **IR failures are fatal:**
   - Create test with unlowered block
   - Verify compilation throws error (not warning)
   - Verify error message indicates missing lowering

3. **Baseline test results:**
   - Run full test suite
   - Document pass/fail counts
   - Identify which failures are expected vs. regressions

---

## Success Metrics

**Sprint 0 is successful if:**

1. ✅ All 27 previously-failing test files now load
2. ✅ Block registry validation passes for all blocks
3. ✅ IR compilation is mandatory (no silent fallback)
4. ✅ Test baseline established showing current IR compiler state
5. ✅ Clear path forward documented for Sprint 1

**NOT success metrics:**
- Most tests passing (expected to fail due to missing IR features)
- IR compiler feature-complete (that's Sprint 2-4)
- All blocks lowered (that's Sprint 2)

---

## Timeline Estimate

**Deliverable 1:** 4-6 hours
**Deliverable 2:** 2-4 hours
**Testing/Baseline:** 2 hours
**Total:** 8-12 hours (1-1.5 days)

This is a **SHORT sprint** focused ONLY on unblocking the critical path.

---

## Next Steps After Sprint 0

**Immediate (Sprint 1):**
1. Fix TimeModel threading (Pass 3 → IRBuilder → schedule)
2. Fix timeDerive tAbsMs slot write
3. Implement default source lowering
4. Fix feature flag parsing bug

**Then (Sprint 2):**
5. Implement Pass 6 block lowering for core signal blocks
6. Add ColorLFO HSL→RGB kernel
7. Fix SVGSampleDomain initialization

**References for Future Sprints:**
- STATUS-2025-12-28-154700.md § "Sprint Scope Recommendations"
- Core.md (all critical items)
- Passes.md (Pass 6, Pass 8 issues)
- Blocks.md (ColorLFO, DebugDisplay, SVGSampleDomain)

---

## Files to Modify (Summary)

**Sprint 0 Changes:**

1. `/Users/bmf/code/oscilla-animator_codex/src/editor/blocks/factory.ts`
   - Enhance `createBlock()` to set capability

2. `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/compileBusAware.ts`
   - Remove optional IR emission
   - Make IR failures fatal

**Potentially:**
3. Test files that expect warnings instead of errors

**That's it.** No other files should be modified in Sprint 0.

---

## Documentation Updates

**After Sprint 0:**

1. Update STATUS file with:
   - Block registry fix confirmed
   - IR mandatory confirmed
   - Test baseline results

2. Create SPRINT-1-PLAN.md with:
   - TimeModel threading
   - timeDerive fix
   - Default sources

3. Update compiler docs with:
   - IR-only mode is now mandatory
   - Legacy fallback removed
   - Expected failure modes documented
