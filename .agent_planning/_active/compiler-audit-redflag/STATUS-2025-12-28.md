# Compiler Audit Red Flags - Status Report

**Timestamp:** 2025-12-28-154700
**Scope:** project/full (compiler IR-only blockers)
**Confidence:** FRESH

---

## Executive Summary

**CRITICAL BLOCKER FOUND:** Test suite is completely broken due to block registry validation failures. 27 test files fail before any tests run. This blocks evaluation of the documented IR compiler red flags.

**Overall Status:**
- **Tests Passing:** 99/127 test files (1855 tests) - but ONLY because 27 files fail at import
- **Tests Failing:** 27 files (0% run - fail at module load)
- **IR Compiler State:** Cannot be runtime-verified due to test infrastructure failure
- **Documentation Quality:** Red flags documentation is comprehensive and well-structured

**Root Cause:** Block capability declarations in `/src/editor/compiler/blocks/` do not match `KERNEL_PRIMITIVES` allowlist in `/src/editor/blocks/kernel-primitives.ts`.

---

## CRITICAL: Test Infrastructure Blocker

### Issue: Registry Validation Failure at Module Load

**Location:** All test files that import from `src/editor/blocks/registry.ts`

**Error:**
```
Error: Registry validation failed during initialization:
Block definition validation failed with 21 error(s):
  - Block "DomainN": Capability mismatch. Block is listed in KERNEL_PRIMITIVES
    with capability 'identity', but BlockDefinition claims capability 'undefined'.
```

**Impact:**
- **27 test files** cannot run
- **Entire compiler test suite** blocked
- **Cannot verify red flag fixes** through runtime testing
- **IR compilation path** untestable

**Files Affected:**
- All store tests (BusStore, PatchStore, RootStore, SelectionStore, etc.)
- Compiler integration tests
- Bus compilation tests
- Composite/macro tests

### Root Cause Analysis

**The Problem:** Two block registration systems exist:

1. **Legacy System** (`src/editor/blocks/`):
   - `KERNEL_PRIMITIVES` in `kernel-primitives.ts` (lines 21-67)
   - Defines blocks with capabilities: `time`, `identity`, `state`, `render`, `io`
   - Used by registry validation

2. **New Compiler System** (`src/editor/compiler/blocks/`):
   - Block compilers with `registerBlockType()` calls
   - Example: `DomainN.ts` line 47: `capability: 'identity'`
   - BUT: BlockDefinition interface may not be setting capability correctly

**The Mismatch:**
```typescript
// KERNEL_PRIMITIVES expects (kernel-primitives.ts:35-37)
'DomainN': 'identity',
'SVGSampleDomain': 'identity',
'GridDomain': 'identity',

// But BlockDefinition claims (per error message)
capability: undefined  // For all 21 blocks!
```

**Blocks with Capability Mismatch (21 total):**
```
Identity (3):     DomainN, GridDomain, SVGSampleDomain
Render (3):       RenderInstances2D, RenderPaths2D, Render2dCanvas
State (5):        IntegrateBlock, HistoryBlock, TriggerOnWrap, PulseDivider, EnvelopeAD
Pure blocks (10): JitterFieldVec2, FieldFromSignalBroadcast, FieldZipSignal,
                  BroadcastSignalColor, PathConst, and 5 others
```

**Why This Happened:**
- Compiler migration (`src/editor/compiler/blocks/`) created new block definitions
- These use `registerBlockType()` which may not properly propagate to BlockDefinition
- Registry validation (`src/editor/blocks/registry-validation.ts:122`) runs at module load
- Validation expects capabilities to match KERNEL_PRIMITIVES exactly

### Quick Win: Fix This First

**This MUST be fixed before evaluating any IR red flags.**

**Options:**

1. **Update BlockDefinition capability field** in compiler block registrations
2. **Fix `registerBlockType()` to propagate capability** to BlockDefinition
3. **Bypass validation temporarily** (NOT RECOMMENDED - masks real issues)

**Recommendation:** Option 2 - fix the registration system to propagate capabilities correctly.

---

## Red Flags Documentation Analysis

### Summary by File

| File | Critical | High | Medium | Total |
|------|----------|------|--------|-------|
| Core.md | 2 | 2 | 0 | 4 |
| Blocks.md | 2 | 2 | 1 | 5 |
| Bus-System.md | 2 | 4 | 2 | 8 |
| Passes.md | 2 | 3 | 1 | 6 |
| Schedule-and-Runtime.md | 3 | 2 | 2 | 7 |
| TypeSystem-and-Conversions.md | 2 | 2 | 2 | 6 |
| Field-Runtime.md | 3 | 2 | 2 | 7 |
| **TOTAL** | **16** | **17** | **10** | **43** |

---

## Critical Path Analysis

### Tier 0: Test Infrastructure (BLOCKING EVERYTHING)

**MUST FIX FIRST - blocks all runtime verification:**

1. **Block Registry Validation Failure**
   - **File:** `src/editor/blocks/registry-validation.ts`
   - **Impact:** 27 test files fail at import
   - **Sprint Scope:** Single day fix
   - **Dependencies:** None
   - **Risk:** Low - mechanical fix

---

### Tier 1: Critical IR-Only Blockers

**These make IR mode fundamentally non-functional:**

#### 1. IR Build is Optional and Failure is Non-Fatal
- **File:** `src/editor/compiler/compileBusAware.ts:777-796`
- **Issue:** `attachIR()` only runs when `emitIR === true`, IR errors produce warnings while returning closure-based program
- **Impact:** Compiler can silently fall back to legacy execution
- **Evidence:**
  ```typescript
  if (!emitIR) {
    console.log('[IR Debug] emitIR is false, skipping IR compilation');
    return result;
  }
  // IR failure produces warning, not error
  ```
- **Fix Scope:** 1 day - make IR compilation mandatory, fail hard on errors
- **Dependencies:** None

#### 2. TimeModel Hardcoded to Infinite
- **File:** `src/editor/compiler/ir/IRBuilderImpl.ts:605`
- **Issue:** `build()` doesn't return timeModel, schedule builder hardcodes infinite
- **Impact:** All time topologies broken - finite/cyclic patches behave as infinite
- **Evidence:** `buildSchedule.ts` uses hardcoded `{ kind: 'infinite', windowMs: 30000 }`
- **Fix Scope:** 2 days - thread TimeModel from Pass 3 to IRBuilder to schedule
- **Dependencies:** None
- **Ambiguity:** Pass 3 extracts TimeModel (pass3-time.ts:170) but IRBuilder doesn't use it

#### 3. Pass 6 Emits Placeholder IR
- **File:** `src/editor/compiler/passes/pass6-block-lowering.ts:117`
- **Issue:** Signals replaced with `sigTimeAbsMs`, fields with `fieldConst(0)` placeholders
- **Impact:** Generated IR doesn't correspond to patch logic - ALL outputs wrong
- **Evidence:**
  ```typescript
  // Strategy: For Sprint 2, this creates "skeleton" IR nodes
  // without full semantic equivalence
  ```
- **Fix Scope:** Major - 1-2 weeks per block category
- **Dependencies:** Block lowering functions for each block type

#### 4. Default Sources Not Lowered
- **File:** `src/editor/compiler/passes/pass8-link-resolution.ts:258`
- **Issue:** `buildBlockInputRoots` only records errors for missing inputs, doesn't wire defaults
- **Impact:** Required inputs with defaults left unresolved - runtime failures
- **Fix Scope:** 3 days - implement default source lowering
- **Dependencies:** Understanding of defaultSource mechanism

#### 5. Bus Evaluation Absent from Schedule
- **File:** `src/editor/compiler/ir/buildSchedule.ts:337`
- **Issue:** No `busEval` steps emitted in schedule
- **Impact:** Bus values never materialize - all bus-driven graphs incorrect
- **Evidence:** Schedule only includes `timeDerive`, `signalEval`, `materialize`, `renderAssemble`
- **Fix Scope:** 1 week - design and implement busEval step execution
- **Dependencies:** Bus lowering (Pass 7)

#### 6. timeDerive Doesn't Write tAbsMs
- **File:** `src/editor/runtime/executor/steps/executeTimeDerive.ts:36-56`
- **Issue:** Step has `tAbsMsSlot` but executor only writes derived outputs
- **Impact:** Downstream signal nodes reading `tAbsMs` get stale/uninitialized data
- **Evidence:** Function writes `tModelMs`, `phase01`, `wrapEvent`, `progress01` but NOT `tAbsMs`
- **Fix Scope:** 1 day - add slot write for tAbsMs
- **Dependencies:** Verify tAbsMs is in EffectiveTime

#### 7. Event Buses Not Lowered
- **File:** `src/editor/compiler/passes/pass7-bus-lowering.ts:231`
- **Issue:** `createDefaultBusValue()` only handles signal/field, events fall through to null
- **Impact:** Reserved `pulse` bus cannot be lowered - event listeners missing values
- **Fix Scope:** 1 week - design event bus lowering semantics
- **Dependencies:** Event representation in IR

---

### Tier 2: High Priority - Incorrect Behavior

**These cause wrong results but don't crash:**

#### 8. Type Conversion Paths Unimplemented
- **File:** `src/editor/compiler/passes/pass2-types.ts:240`
- **Issue:** `computeConversionPath()` only accepts exact equality
- **Impact:** All implicit conversions fail (signal→field, adapters, lenses)
- **Fix Scope:** 2 weeks - implement conversion path computation
- **Dependencies:** Type compatibility logic exists (TypeDesc.ts:206) but not used

#### 9. Publisher Transform Chains Ignored
- **File:** `src/editor/compiler/passes/pass7-bus-lowering.ts:177`
- **Issue:** TODO for applying publisher transform chains
- **Impact:** Bus values incorrect when publishers use adapters/lenses
- **Fix Scope:** 1 week
- **Dependencies:** Transform chain representation

#### 10. Field Transform Chains Not Implemented
- **File:** `src/editor/runtime/field/Materializer.ts:1136`
- **Issue:** `fillBufferTransform` throws "not implemented"
- **Impact:** Any field-level adapter/lens crashes at runtime
- **Fix Scope:** 2 weeks
- **Dependencies:** Transform chain semantics

#### 11. Field Reduce Placeholder
- **File:** `src/editor/compiler/ir/IRBuilderImpl.ts:535`
- **Issue:** `reduceFieldToSig` emits map node with `src: 0` placeholder
- **Impact:** ReduceField disconnected from input
- **Fix Scope:** 3 days
- **Dependencies:** Field expression wiring

#### 12. Bus Evaluation Only Supports Numbers
- **File:** `src/editor/runtime/executor/steps/executeBusEval.ts:24`
- **Issue:** Only reads number values, doesn't handle vec2/color/field buses
- **Fix Scope:** 1 week
- **Dependencies:** Bus type representation

---

### Tier 3: Medium Priority - Inconsistencies

**These cause confusion but may not break current patches:**

#### 13. Dual TypeDesc Definitions
- **Files:** `src/editor/compiler/ir/types.ts` vs `src/editor/ir/types/TypeDesc.ts`
- **Issue:** Compiler IR has own TypeDesc (world: signal|field|scalar|event|special), editor has different one
- **Impact:** Type comparisons can silently diverge
- **Fix Scope:** 1 week - unify type systems
- **Dependencies:** Major refactor

#### 14. Feature Flag Parsing Bug
- **File:** `src/editor/compiler/featureFlags.ts:121`
- **Issue:** `VITE_USE_UNIFIED_COMPILER !== undefined` forces true regardless of value
- **Impact:** Cannot explicitly disable unified compiler
- **Evidence:**
  ```typescript
  if (env.VITE_USE_UNIFIED_COMPILER !== undefined) {
    currentFlags.useUnifiedCompiler = true;  // ALWAYS true if var exists
  }
  ```
- **Fix Scope:** 1 hour - check for `=== 'true'`
- **Dependencies:** None

#### 15. Legacy/IR Bus Semantic Mismatch
- **File:** `src/editor/semantic/busSemantics.ts:210` vs `pass7-bus-lowering.ts:217`
- **Issue:** Legacy doesn't implement `layer` for fields, IR maps it to `last`
- **Impact:** Same patch behaves differently in legacy vs IR
- **Fix Scope:** 2 days - align semantics
- **Dependencies:** Decide which behavior is correct

---

## Block-Level Issues

### Critical Blocks Not IR-Ready

1. **ColorLFO** - Missing HSL→RGB opcode (Blocks.md:7-12)
   - **Impact:** Any patch using ColorLFO fails in IR-only mode
   - **Fix:** Implement ColorHSLToRGB kernel
   - **Scope:** 2 days

2. **DebugDisplay** - Cannot be lowered (Blocks.md:13-18)
   - **Impact:** Incompatible with IR-only compilation
   - **Fix:** Rework as debug sink or remove
   - **Scope:** 3 days - requires design decision

3. **SVGSampleDomain** - Missing runtime initialization (Blocks.md:27-32)
   - **Impact:** Invalid domain slots at runtime
   - **Fix:** Register domain in `domainFromSVG()`
   - **Scope:** 1 day

---

## Dependencies Graph (Conceptual)

```
Tier 0 (BLOCKING):
  Block Registry Fix
    ↓
    ├─→ All tests can run
    └─→ Runtime verification possible

Tier 1 (CRITICAL - can parallelize):
  IR Mandatory
  TimeModel Threading ────┐
  Default Sources         │
  Bus Eval Steps          ├─→ Basic IR execution works
  timeDerive tAbsMs       │
  Event Bus Lowering      │
  Pass 6 Block Lowering ──┘
    ↓
  Tier 2 (HIGH):
    Type Conversions ──┐
    Transform Chains   ├─→ Full type system works
    Field Reduce       │
    Bus Type Support ──┘
      ↓
    Tier 3 (MEDIUM):
      Type Unification
      Semantic Alignment
      Feature Flags
```

---

## Sprint Scope Recommendations

### Sprint 0: Unblock Testing (1 day)
**Goal:** Make tests run

- [ ] Fix block registry capability propagation
- [ ] Verify all 27 test files can load
- [ ] Run full test suite and baseline

**Deliverable:** Green test suite (or at least tests that RUN)

---

### Sprint 1: Core IR Execution (1 week)
**Goal:** Make IR mode mandatory and functional for simple patches

**Must Have:**
- [ ] IR compilation mandatory (no fallback)
- [ ] TimeModel threaded from Pass 3 to schedule
- [ ] timeDerive writes tAbsMs slot
- [ ] Feature flag parsing fixed

**Validation:**
- IR-only mode can execute trivial patches (TimeRoot + Render)
- Time topology respected (finite vs infinite)
- Tests verify hard failure on IR errors

**Known Gaps:** Blocks still use placeholders, buses don't work

---

### Sprint 2: Block Lowering Foundation (2 weeks)
**Goal:** Real block semantics in IR

**Must Have:**
- [ ] Pass 6 lowering for core signal blocks (math, LFO, etc.)
- [ ] Default source lowering
- [ ] ColorLFO HSL→RGB kernel
- [ ] SVGSampleDomain runtime initialization

**Validation:**
- Patches with signal math compile to real IR
- Default inputs wire correctly
- Color blocks work

**Known Gaps:** Buses, events, complex field operations

---

### Sprint 3: Bus System (2 weeks)
**Goal:** Bus-driven graphs work

**Must Have:**
- [ ] Bus eval step implementation
- [ ] Event bus lowering design + impl
- [ ] Bus type support (vec2, color)
- [ ] Publisher transform chains

**Validation:**
- Patches publishing/listening to buses work
- Reserved buses (pulse, energy) functional
- Event-driven logic executes

**Known Gaps:** Transform chains, advanced type conversions

---

### Sprint 4: Type System & Transforms (2 weeks)
**Goal:** Full type compatibility

**Must Have:**
- [ ] Type conversion path computation
- [ ] Field transform chains
- [ ] Adapter/lens pipeline
- [ ] Field reduce implementation

**Validation:**
- Implicit conversions work (signal→field broadcast)
- Adapter chains apply correctly
- Field operations fully functional

**Known Gaps:** Edge cases, optimization

---

### Sprint 5+: Hardening (ongoing)
- Type system unification
- Legacy/IR semantic alignment
- Performance optimization
- Advanced features

---

## Ambiguities Found

### 1. Pass 6 Block Lowering Strategy

**Question:** Should Pass 6 lower ALL blocks to IR, or incrementally migrate?

**Context:** Current code has Sprint 2 placeholders. Comment says "skeleton IR nodes without full semantic equivalence."

**Options:**
- **A:** Continue placeholder approach, migrate block-by-block
- **B:** Block IR compilation until all blocks are lowered
- **C:** Hybrid - allow closure fallback for unlowered blocks

**Impact:** Determines migration timeline and testing strategy

**Recommendation:** Need user decision - affects Sprint 2 scope

---

### 2. Event Bus Representation

**Question:** How should event buses be represented in IR?

**Context:** Events are discrete triggers, not continuous values. Current IR has no event type.

**Options:**
- **A:** Add Event type to IR schema
- **B:** Represent events as signal<boolean> with edge detection
- **C:** Separate event channel outside slot system

**Impact:** Affects bus lowering, schedule execution, and runtime model

**Recommendation:** Needs design decision before Sprint 3

---

### 3. DebugDisplay Block Fate

**Question:** Should DebugDisplay be removed, reworked, or kept legacy-only?

**Context:** Red flag says "cannot be lowered to IR" and "must be reworked as debug sink or removed"

**Options:**
- **A:** Remove entirely - use browser console instead
- **B:** Rework as render sink (side-effect node)
- **C:** Keep legacy-only, block in IR mode

**Impact:** Developer debugging workflow

**Recommendation:** User decision needed - affects Sprint 2

---

### 4. Type System Unification Priority

**Question:** Should dual TypeDesc systems be unified before or after IR-only mode works?

**Context:** Two different type representations exist. HANDOFF notes this as a problem.

**Options:**
- **A:** Unify now (Sprint 1-2) - delays IR functionality
- **B:** Unify later (Sprint 5+) - technical debt accumulates
- **C:** Incremental unification during Sprints 2-4

**Impact:** Code clarity vs velocity tradeoff

**Recommendation:** Option C - unify incrementally as we touch each system

---

## Runtime Check Results

**BLOCKED:** Cannot run runtime checks due to test infrastructure failure.

**Once Tier 0 is fixed, run:**
```bash
just test                    # Full test suite
just test-file <compiler-test>  # Specific compiler tests
```

**Expected checks:**
- Compiler integration tests
- IR lowering tests
- Schedule execution tests
- Field materialization tests

---

## Missing Checks (Implementers Should Create)

Once test infrastructure is fixed, add:

1. **IR-only mode smoke test** (`tests/compiler/ir-only-smoke.test.ts`)
   - Compile trivial patch (TimeRoot + Render) in IR-only mode
   - Verify no closure fallback
   - Should run in <5 seconds

2. **TimeModel validation test** (`tests/compiler/timemodel.test.ts`)
   - Test finite/cyclic/infinite patches
   - Verify TimeModel in CompiledProgramIR matches TimeRoot type
   - Assert schedule uses correct time semantics

3. **Bus lowering integration test** (`tests/compiler/bus-lowering.test.ts`)
   - Test signal bus, field bus, event bus
   - Verify busEval steps in schedule
   - Validate bus values at runtime

4. **Block lowering coverage test** (`tests/compiler/block-coverage.test.ts`)
   - For each block type, verify IR lowering exists or throws clear error
   - Track coverage metric (% blocks IR-ready)

---

## Workflow Recommendation

**[X] PAUSE** - Test infrastructure blocker needs immediate attention

**Clarification Needed:**

### Question 1: Block Lowering Migration Strategy

**Context:** Pass 6 uses placeholders for most blocks. Should we:

**Options:**
- **A:** Fix registry issue, then continue incremental migration (recommended)
- **B:** Block IR mode entirely until all blocks lowered
- **C:** Allow mixed closure/IR execution for unlowered blocks

**How it was guessed:** Current code suggests Option A (incremental)

**Impact of wrong choice:** Option B delays IR-only by months; Option C creates semantic inconsistencies

---

### Question 2: Event Bus Lowering Design

**Context:** Events have no IR representation. Need design before implementing.

**Options:**
- **A:** Extend IR schema with Event type
- **B:** Represent as signal<boolean> with edge semantics
- **C:** Separate event channel system

**Impact:** Affects Sprint 3 timeline and bus system architecture

---

### Question 3: DebugDisplay Block Decision

**Context:** Cannot be lowered to IR. Need user decision on fate.

**Options:**
- **A:** Remove (use browser DevTools)
- **B:** Rework as render sink
- **C:** Keep legacy-only

**Impact:** Developer workflow and debugging experience

---

## Evaluation Cache Update

**Created:**
- `.agent_planning/compiler-audit-redflag/STATUS-2025-12-28.md` (this file)

**Should Cache (for future evaluations):**
- Block registry validation rules → `eval-cache/block-registry-rules.md`
- Compiler pass structure → `eval-cache/compiler-passes.md`
- IR schedule semantics → `eval-cache/ir-schedule.md`

**Not caching yet:** Waiting for test infrastructure fix to baseline actual behavior

---

## Recommendations by Priority

### P0 (Do Immediately):
1. Fix block registry capability propagation
2. Verify test suite runs

### P1 (Sprint 1 - This Week):
3. Make IR compilation mandatory (no fallback)
4. Thread TimeModel from Pass 3 to schedule
5. Fix timeDerive tAbsMs write
6. Fix feature flag parsing

### P2 (Sprint 2 - Next 2 Weeks):
7. Implement block lowering for core signal blocks
8. Implement default source lowering
9. Add ColorLFO HSL→RGB kernel
10. Fix SVGSampleDomain initialization

### P3 (Sprint 3 - Following 2 Weeks):
11. Design + implement bus eval steps
12. Design + implement event bus lowering
13. Add bus type support (vec2, color)

### P4 (Sprint 4+):
14. Type conversion paths
15. Transform chain implementation
16. Type system unification

---

## Verdict

**Test Infrastructure:** BROKEN - blocks all evaluation
**Red Flags Documentation:** EXCELLENT - comprehensive, well-structured
**IR Compiler State:** CANNOT VERIFY - tests don't run

**Next Action:** Fix block registry validation, then re-evaluate with runtime checks.

---

**Files Referenced:**
- `/Users/bmf/code/oscilla-animator_codex/src/editor/blocks/kernel-primitives.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/blocks/registry-validation.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/compileBusAware.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/ir/IRBuilderImpl.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/compiler/passes/pass6-block-lowering.ts`
- `/Users/bmf/code/oscilla-animator_codex/src/editor/runtime/executor/steps/executeTimeDerive.ts`
- `/Users/bmf/code/oscilla-animator_codex/design-docs/12-Compiler-Final/*.md` (all red flags files)
