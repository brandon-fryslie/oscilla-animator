# Definition of Done: Sprint 1 - Core IR Execution

**Generated:** 2025-12-28-122552
**Plan:** PLAN-2025-12-28-122552.md
**Sprint Goal:** Make IR mode functional for simple patches with correct time topology

---

## Sprint Scope

**This sprint delivers:** 2 deliverables (TimeModel threading + Feature flag fix)
**Deferred to Sprint 2:** Default sources, block lowering, ColorLFO kernel
**Deferred to Sprint 3:** Bus evaluation, event buses

---

## Acceptance Criteria

### P0 (Critical) - TimeModel Threading

#### Implementation Requirements
- [ ] `IRBuilder` interface has `setTimeModel(timeModel: TimeModel): void` method signature
- [ ] `IRBuilderImpl` implements `setTimeModel()` method that stores timeModel in instance field
- [ ] `IRBuilderImpl.build()` uses stored timeModel field (not hardcoded value)
- [ ] `IRBuilderImpl.build()` throws error if `setTimeModel()` was never called (defensive check)
- [ ] `pass6BlockLowering()` threads `input.timeModel` from Pass 3 to IRBuilder instance
- [ ] `FiniteTimeRoot` block compiler calls `builder.setTimeModel()` during lowering
- [ ] `InfiniteTimeRoot` block compiler calls `builder.setTimeModel()` during lowering

#### Compilation Verification
- [ ] Test: Compile finite patch (FiniteTimeRoot with durationMs=5000)
  - `compiledProgram.ir.timeModel.kind === 'finite'`
  - `compiledProgram.ir.timeModel.durationMs === 5000`
  - Compilation succeeds without error

- [ ] Test: Compile infinite patch (InfiniteTimeRoot)
  - `compiledProgram.ir.timeModel.kind === 'infinite'`
  - Compilation succeeds without errors

#### Code Quality
- [ ] TypeScript compilation passes with no new errors
- [ ] No regressions in test suite (≥126/128 files still pass)
- [ ] No console warnings about missing timeModel
- [ ] Implementation follows existing pattern for `setTimeSlots()`

---

### P1 (High) - Feature Flag Parsing Fix

#### Implementation Requirements
- [ ] Line 121-123 of `featureFlags.ts` updated to check value equality (not just existence)
- [ ] Logic matches pattern used by other flags (lines 125, 128)

#### Functional Verification
- [ ] Test: Set `VITE_USE_UNIFIED_COMPILER='false'` in env
  - `getFeatureFlags().useUnifiedCompiler === false`
  - Compiler uses legacy mode (not IR)

- [ ] Test: Set `VITE_USE_UNIFIED_COMPILER='true'` in env
  - `getFeatureFlags().useUnifiedCompiler === true`
  - Compiler uses IR mode

- [ ] Test: `VITE_USE_UNIFIED_COMPILER` undefined in env
  - Default behavior preserved (no change from current)
  - No errors or warnings

#### Developer Workflow
- [ ] Manual test: Run `VITE_USE_UNIFIED_COMPILER=false just dev`
  - Dev server starts successfully
  - Browser console shows legacy compiler logs (not IR logs)
  - Application functions correctly

- [ ] Manual test: Run `VITE_USE_UNIFIED_COMPILER=true just dev`
  - Dev server starts successfully
  - Browser console shows IR compiler logs
  - Application functions correctly

#### Code Quality
- [ ] TypeScript compilation passes
- [ ] No regressions in test suite
- [ ] Code change is minimal (1-2 lines)

---

## Quality Gates

### Pre-Merge Checklist
- [ ] All P0 acceptance criteria met (TimeModel threading)
- [ ] All P1 acceptance criteria met (Feature flag fix)
- [ ] `just typecheck` passes with no errors
- [ ] `just test` shows ≥126/128 files pass (no new failures)
- [ ] No new console errors or warnings in dev mode
- [ ] Git commits have clear messages explaining changes

### Test Coverage
- [ ] Unit test added: `tests/compiler/timemodel.test.ts`
  - Tests finite, cyclic, infinite patch compilation
  - Verifies timeModel kind and parameters
  - All tests passing

- [ ] Unit test added: `tests/compiler/feature-flags.test.ts`
  - Tests `=false`, `=true`, `undefined` cases
  - Verifies flag parsing logic
  - All tests passing

### Runtime Validation (Chrome DevTools MCP)
- [ ] Manual test: Finite patch runtime behavior
  - Create patch: FiniteTimeRoot(5000ms) + Render2dCanvas
  - Player shows progress 0→1 over 5 seconds
  - Playback stops at 5 seconds (does not loop)
  - Scrubbing respects duration boundary

- [ ] Manual test: Infinite patch runtime behavior
  - Create patch: InfiniteTimeRoot() + time-driven animation
  - Player runs indefinitely
  - No wrap events or progress boundaries
  - Scrubbing works without limits

---

## Known Limitations After Sprint 1

**These will remain broken (explicitly out of scope):**
- Default sources not lowered → required inputs without connections will fail
- Block lowering uses placeholders → most blocks output wrong values
- Bus evaluation absent → bus-driven graphs do not work
- Event buses not lowered → event listeners fail
- Field operations incomplete → field transforms fail

**These are Sprint 2+ scope and do NOT block Sprint 1 completion.**

---

## Rollback Plan

**If critical issues found after merge:**

1. Revert TimeModel threading commits
2. Revert feature flag fix commit
3. File issue documenting the problem
4. Re-plan Sprint 1 with fixes

**Rollback is safe because:**
- Changes are isolated to compiler passes
- No schema migrations or data changes
- Test suite provides regression coverage

---

## Sprint Complete When

**All of the following are true:**

1. All P0 acceptance criteria checked (9 checkboxes)
2. All P1 acceptance criteria checked (11 checkboxes)
3. All quality gates passed (7 checkboxes)
4. Test coverage requirements met (2 new test files)
5. Runtime validation complete (3 manual tests)
6. No new regressions in existing test suite
7. TypeScript compilation clean

**Total Checkboxes:** 29 (all must be checked)

**Estimated Completion Time:** 2 days

---

**Definition of Done Complete - Ready for Implementation**
