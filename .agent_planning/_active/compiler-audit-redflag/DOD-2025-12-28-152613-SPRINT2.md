# Definition of Done: Sprint 2 - Block Lowering Foundation

**Generated:** 2025-12-28-152613
**Plan:** PLAN-2025-12-28-152613-SPRINT2.md
**Sprint Goal:** Real block semantics in IR

---

## Sprint Scope

This sprint delivers real block semantics for core signal operations, default input resolution, color animation support, and SVG domain initialization.

**Deliverables:** 4 work items
- P0-1: Core Signal Math Block IR Lowering (8 blocks)
- P0-2: Default Source Lowering in Pass 8
- P1-1: ColorLFO HSL→RGB Kernel
- P1-2: SVGSampleDomain Runtime Initialization

**Deferred to Sprint 3:**
- Bus evaluation
- Event bus lowering
- Field transform chains
- Type conversion paths

---

## Acceptance Criteria

### P0-1: Core Signal Math Block IR Lowering

**Goal:** Replace placeholder IR nodes with real block semantics for 8 core signal math blocks.

#### Block Implementation
- [ ] **AddSignal**: Verified to use OpCode.Add (already implemented)
- [ ] **SubSignal**: Implements `lower` function using OpCode.Sub
- [ ] **MulSignal**: Implements `lower` function using OpCode.Mul
- [ ] **DivSignal**: Implements `lower` function using OpCode.Div
- [ ] **MinSignal**: Implements `lower` function using OpCode.Min
- [ ] **MaxSignal**: Implements `lower` function using OpCode.Max
- [ ] **ClampSignal**: Implements `lower` function using OpCode.Clamp with min/max bounds
- [ ] **Oscillator**: Implements `lower` function using OpCode.Sin/Tri/Saw/Square based on waveform config

#### Validation
- [ ] Each block's `lower` function emits proper IR nodes (not placeholders like `sigTimeAbsMs`)
- [ ] Each block's `lower` function allocates output value slots correctly
- [ ] Each block's `lower` function validates input types and throws clear errors on mismatch
- [ ] Unit test exists for each block's IR lowering path
- [ ] Test suite passes: `just test` shows 0 regressions
- [ ] TypeScript compiles: `just typecheck` passes without errors

#### Integration Test
- [ ] Simple patch compiles to IR: `Const(10) → Mul(2) → Add(5)` produces output value 25
- [ ] Oscillator patch produces correct waveform: `phase → Oscillator(sine)` outputs sine wave values
- [ ] All 8 blocks work in combined patch without falling back to legacy compiler

---

### P0-2: Default Source Lowering in Pass 8

**Goal:** Wire default input values when blocks have unconnected optional inputs.

#### Interface Changes
- [ ] `InputPort` interface in `lowerTypes.ts` includes `defaultSource?: Artifact` field
- [ ] `BlockDefinition` type supports optional default sources on input ports

#### Block Registration Updates
- [ ] ColorLFO registers default sources for `base`, `hueSpan`, `sat`, `light` inputs
- [ ] All blocks with optional inputs register appropriate default sources
- [ ] Default sources use correct artifact types (Scalar:color, Scalar:number, etc.)

#### Pass 8 Implementation
- [ ] `buildBlockInputRoots()` function checks for default sources after wires and bus listeners
- [ ] Default sources are lowered to IR using `artifactToValueRef()` helper
- [ ] Missing required inputs (no wire, no bus, no default) produce compile errors with clear messages
- [ ] Optional inputs (no wire, no bus, but has default) compile successfully
- [ ] Lowered default values are stored in correct slots for runtime access

#### Validation
- [ ] Patch with unconnected ColorLFO optional inputs compiles without errors
- [ ] Runtime receives correct default values (e.g., base='#3B82F6', hueSpan=180)
- [ ] Unit test verifies default source lowering for scalar inputs
- [ ] Unit test verifies compile error for missing required inputs
- [ ] Test suite passes: `just test` shows 0 regressions

#### Integration Test
- [ ] Patch using ColorLFO with only `phase` input connected compiles and runs
- [ ] Color output matches expected default (blue base, 180-degree hue span)
- [ ] Explicitly connecting default inputs overrides defaults correctly

---

### P1-1: ColorLFO HSL→RGB Kernel

**Goal:** Enable ColorLFO block to compile to IR by implementing HSL-to-RGB color conversion.

#### OpCode Addition
- [ ] `OpCode.ColorHSLToRGB` exists in `src/editor/compiler/ir/opcodes.ts` enum
- [ ] OpCode is documented with signature: `(h: number, s: number, l: number) => string`

#### Kernel Implementation
- [ ] Color kernel file created: `src/editor/runtime/executor/kernels/color.ts`
- [ ] `colorHSLToRGB(h, s, l)` function implemented using ColorLFO.ts algorithm (lines 51-90)
- [ ] Kernel handles hue wrapping: `h % 360`
- [ ] Kernel outputs hex string format: `'#RRGGBB'`
- [ ] Kernel is registered in executor/evaluator for runtime execution

#### ColorLFO Lowering Update
- [ ] ColorLFO `lower` function constructs HSL signal from inputs (baseHue + phase * hueSpan)
- [ ] ColorLFO `lower` function uses `ctx.b.sigMap()` with OpCode.ColorHSLToRGB
- [ ] ColorLFO `lower` function removes `throw new Error()` line
- [ ] ColorLFO `lower` function allocates output slot correctly
- [ ] ColorLFO `lower` function returns proper color signal ValueRef

#### Validation
- [ ] Unit test: `colorHSLToRGB(240, 0.8, 0.5)` returns blue color `'#1966e6'` or similar
- [ ] Unit test: ColorLFO block compiles to IR without throwing errors
- [ ] Integration test: Patch with `phase → ColorLFO` compiles and executes
- [ ] Integration test: Color output changes correctly as phase varies (0.0 → base, 0.5 → +90° hue, 1.0 → +180° hue)
- [ ] TypeScript compiles: `just typecheck` passes
- [ ] Test suite passes: `just test` shows 0 regressions

#### Runtime Verification
- [ ] Manual test in browser: ColorLFO animation plays smoothly
- [ ] Manual test: Scrubbing time slider updates color correctly
- [ ] Chrome DevTools MCP verification: Color values match expected HSL→RGB conversion

---

### P1-2: SVGSampleDomain Runtime Initialization

**Goal:** Fix SVGSampleDomain to properly register domains for runtime initialization.

#### IRBuilder Fix
- [ ] `IRBuilderImpl.domainFromSVG()` registers domain in `this.domains` array
- [ ] Domain registration includes slot, count, and svgPath fields
- [ ] Registration matches pattern from `domainFromN()` implementation

#### Type Updates
- [ ] `DomainDefinition` interface includes optional `svgPath?: string` field
- [ ] Type definition allows both count-based and SVG-based domains

#### Runtime Support
- [ ] Executor/runtime reads `svgPath` from domain definitions during initialization
- [ ] SVG domains are initialized with correct element count
- [ ] Invalid or missing SVG paths fall back to count-based domain initialization

#### Validation
- [ ] Unit test verifies `domainFromSVG()` registers in domains array
- [ ] Unit test verifies domain definition includes svgPath field
- [ ] Integration test: Patch with SVGSampleDomain compiles to IR
- [ ] Integration test: SVGSampleDomain produces domain with expected count
- [ ] Integration test: `SVGSampleDomain → RenderInstances` renders correct number of instances
- [ ] TypeScript compiles: `just typecheck` passes
- [ ] Test suite passes: `just test` shows 0 regressions

#### Runtime Verification
- [ ] Manual test: SVG domain with 50 samples renders 50 instances
- [ ] Manual test: Instances positioned along SVG path (diagonal line test)
- [ ] Chrome DevTools MCP verification: Domain count matches sampleCount parameter

---

### P2-1: Block Lowering Coverage Tests

**Goal:** Document and verify which blocks are IR-ready vs legacy-only.

#### Test File Creation
- [ ] `tests/compiler/block-lowering.test.ts` exists and tracks coverage
- [ ] `tests/compiler/signal-math.test.ts` exists with integration tests
- [ ] `tests/compiler/color-blocks.test.ts` exists with ColorLFO tests
- [ ] `tests/compiler/domain-blocks.test.ts` exists with SVGSampleDomain tests
- [ ] `tests/helpers/compiler-test-utils.ts` provides test utilities

#### Coverage Test
- [ ] Coverage test lists all IR-ready blocks (AddSignal, SubSignal, MulSignal, DivSignal, MinSignal, MaxSignal, ClampSignal, Oscillator, ColorLFO, SVGSampleDomain, DomainN, GridDomain)
- [ ] Coverage test verifies each IR-ready block has defined `lower` function
- [ ] Coverage test documents legacy-only blocks (DebugDisplay, etc.)
- [ ] Coverage test calculates and reports IR-readiness percentage
- [ ] Coverage test fails if expected blocks are missing lowering functions

#### Integration Tests
- [ ] Signal math test: AddSignal produces correct sum (Const(2) + Const(3) = 5)
- [ ] Signal math test: SubSignal produces correct difference
- [ ] Signal math test: MulSignal produces correct product
- [ ] Signal math test: DivSignal produces correct quotient
- [ ] Signal math test: MinSignal produces correct minimum
- [ ] Signal math test: MaxSignal produces correct maximum
- [ ] Signal math test: ClampSignal produces correct clamped value
- [ ] Oscillator test: Sine waveform produces expected values
- [ ] ColorLFO test: Phase=0.0 produces base color
- [ ] ColorLFO test: Phase=0.5 produces hue-shifted color
- [ ] ColorLFO test: Phase=1.0 produces fully-shifted color
- [ ] SVGSampleDomain test: Domain has expected element count
- [ ] SVGSampleDomain test: Positions array has expected length

#### Test Quality
- [ ] All new tests pass: `just test` shows 0 failures
- [ ] Test coverage >80% for modified files
- [ ] Tests use clear, descriptive names
- [ ] Tests include comments explaining expected behavior
- [ ] Tests follow existing project test patterns

---

## Sprint-Level Validation

### End-to-End Test Cases

#### Test 1: Simple Signal Math
- [ ] Patch: `Const(10) → Mul(2) → Add(5) → output`
- [ ] Compiles to IR without errors
- [ ] Produces output value = 25 at all times
- [ ] No fallback to legacy compiler

#### Test 2: Oscillator Animation
- [ ] Patch: `FiniteTimeRoot(5000ms) → phase → Oscillator(sine) → output`
- [ ] Compiles to IR without errors
- [ ] Produces sine wave: output = sin(phase * 2π)
- [ ] Smooth oscillation over 5-second duration
- [ ] No visual artifacts or discontinuities

#### Test 3: Color Animation with Defaults
- [ ] Patch: `CycleTimeRoot(2000ms) → phase → ColorLFO → output`
- [ ] Compiles to IR without errors (no explicit base/hueSpan connections)
- [ ] Uses default base color (#3B82F6 blue)
- [ ] Uses default hueSpan (180 degrees)
- [ ] Color cycles smoothly through hue wheel
- [ ] Repeats every 2 seconds (cyclic time)

#### Test 4: SVG Domain Rendering
- [ ] Patch: `SVGSampleDomain(path="M 0 0 L 100 100", count=50) → domain → RenderInstances → canvas`
- [ ] Compiles to IR without errors
- [ ] Renders exactly 50 instances
- [ ] Instances positioned along diagonal line
- [ ] No missing or duplicate instances

#### Test 5: Combined Signal and Color
- [ ] Patch: `TimeRoot → phase → [Oscillator, ColorLFO] → [position, color] → RenderInstances`
- [ ] Compiles to IR without errors
- [ ] Instances animate with oscillating positions
- [ ] Instances animate with cycling colors
- [ ] Position and color animations synchronized to phase

### Infrastructure Validation
- [ ] TypeScript compilation: `just typecheck` passes with 0 errors
- [ ] Test suite: `just test` passes with 128/128 files (up from 126/128)
- [ ] Linting: `just lint-fix` passes with 0 warnings
- [ ] Build: `just build` succeeds without errors
- [ ] Dev server: `just dev` starts and serves app correctly

### Code Quality
- [ ] All new code follows project style guidelines
- [ ] All new code has clear comments explaining purpose
- [ ] All modified files have updated documentation if needed
- [ ] No console warnings or errors during compilation
- [ ] No TODO comments without issue tracking

---

## Success Metrics

### Quantitative Goals
- [ ] **8/8** core signal math blocks have proper IR lowering (100%)
- [ ] **100%** of blocks with optional inputs support default sources
- [ ] **1/1** color blocks (ColorLFO) are IR-ready
- [ ] **1/1** SVG domain blocks (SVGSampleDomain) are IR-ready
- [ ] **128/128** test files pass (0 failures)
- [ ] **>20** new integration tests added
- [ ] **>80%** block lowering coverage for common blocks

### Qualitative Goals
- [ ] Patches using signal math compile to IR and produce correct numeric outputs
- [ ] Unconnected optional inputs work seamlessly (default sources resolve)
- [ ] Color animations play smoothly in IR-only mode without visual artifacts
- [ ] SVG-based domains render correctly with expected element counts
- [ ] Developer experience: Clear error messages for missing required inputs
- [ ] Code maintainability: Block lowering pattern is consistent and well-documented

---

## Known Limitations (Out of Scope)

These are expected to NOT work after Sprint 2:

- [ ] **Bus-driven graphs**: No busEval steps in schedule (Sprint 3)
- [ ] **Event buses**: Pulse/wrap events not lowered (Sprint 3)
- [ ] **Field transform chains**: Adapters/lenses not implemented (Sprint 4)
- [ ] **Type conversions**: Signal→field broadcast not implemented (Sprint 4)
- [ ] **Complex field operations**: Reduce, zip still use placeholders (Sprint 4)
- [ ] **DebugDisplay**: Remains legacy-only (deferred)

---

## Sign-Off Criteria

Sprint 2 is complete when:

1. **All P0 and P1 work items** have all acceptance criteria checked ✓
2. **All sprint-level validation tests** pass ✓
3. **Test suite** shows 128/128 files passing ✓
4. **Manual verification** in browser confirms animations work ✓
5. **STATUS-SPRINT2.md** file is created documenting completion ✓
6. **User approval** is obtained for Sprint 2 deliverables ✓

---

**Ready for Sprint 3:** After sign-off, the codebase is ready for bus system implementation. Simple signal-driven patches work end-to-end, providing a stable foundation for adding bus evaluation and event handling.

---

**End of Definition of Done**
