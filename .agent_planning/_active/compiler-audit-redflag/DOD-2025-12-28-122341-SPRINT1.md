# Definition of Done: Sprint 1 - Core IR Execution

**Generated:** 2025-12-28-122341
**Plan:** PLAN-2025-12-28-122341-SPRINT1.md
**Sprint Goal:** Make IR mode functional for simple patches
**Duration:** 1 week

---

## Acceptance Criteria

### Deliverable 1: TimeModel Threading (P0-1)

**AC1: IRBuilder returns TimeModel**
- [ ] `IRBuilderImpl.build()` returns `{ schedule, signalExprs, ..., timeModel }`
- [ ] `ProgramIR` interface includes `timeModel: TimeModel` field
- [ ] TimeModel is extracted from Pass 3 results and stored in IRBuilder state

**AC2: Schedule builder uses provided TimeModel**
- [ ] `buildSchedule()` accepts `timeModel: TimeModel` parameter
- [ ] Remove hardcoded infinite time model from buildSchedule.ts
- [ ] Schedule generation respects time topology (finite/cyclic/infinite)

**AC3: Compiled program exposes TimeModel**
- [ ] `CompiledProgramIR` interface includes `timeModel: TimeModel`
- [ ] `compileBusAware()` passes timeModel from IRBuilder to program wrapper
- [ ] Player can read timeModel from compiled program

**AC4: Tests verify topology preservation**
- [ ] Add test: finite TimeRoot produces `{ kind: 'finite', durationMs: N }`
- [ ] Add test: cyclic TimeRoot produces `{ kind: 'cyclic', periodMs: N }`
- [ ] Add test: infinite TimeRoot produces `{ kind: 'infinite', windowMs: N }`
- [ ] Verify schedule step semantics differ per topology

---

### Deliverable 2: timeDerive Writes tAbsMs Slot (P0-2)

**AC1: Executor writes tAbsMs slot**
- [ ] `executeTimeDerive()` writes `state.slots[step.tAbsMsSlot] = tAbsMs`
- [ ] Write occurs BEFORE derived outputs (tAbsMs is input to derivation)
- [ ] Value written is the input absolute time from executor context

**AC2: tAbsMs source is correct**
- [ ] Verify tAbsMs comes from `EffectiveTime` interface
- [ ] Confirm EffectiveTime includes tAbsMs field
- [ ] Value matches player's current time position

**AC3: Tests verify slot write**
- [ ] Add test: executeTimeDerive writes tAbsMsSlot
- [ ] Verify written value equals input tAbsMs
- [ ] Test that downstream signal reads get correct value

**AC4: Integration test with signal consumer**
- [ ] Create patch with block that reads tAbsMs
- [ ] Verify value updates each frame
- [ ] Confirm scrubbing updates tAbsMs

---

### Deliverable 3: Feature Flag Parsing Fixed (P0-3)

**AC1: Parse string value correctly**
- [ ] Check `env.VITE_USE_UNIFIED_COMPILER === 'true'` (not `!== undefined`)
- [ ] Setting `VITE_USE_UNIFIED_COMPILER=false` disables compiler
- [ ] Setting `VITE_USE_UNIFIED_COMPILER=true` enables compiler
- [ ] Omitting variable uses default value (verify current default documented)

**AC2: Tests verify flag behavior**
- [ ] Add test: `VITE_USE_UNIFIED_COMPILER=true` sets flag true
- [ ] Add test: `VITE_USE_UNIFIED_COMPILER=false` sets flag false
- [ ] Add test: undefined variable uses default
- [ ] Add test: invalid value (not 'true'/'false') uses default or errors

**AC3: Documentation updated**
- [ ] Update .env.example with correct usage (or create if missing)
- [ ] Add comment in featureFlags.ts explaining string comparison
- [ ] Document default value clearly

---

## Sprint Scope

This sprint delivers **exactly 3 deliverables**:

1. **TimeModel Threading** - Time topology flows from Pass 3 to schedule execution
2. **timeDerive tAbsMs** - Absolute time slot written correctly each frame
3. **Feature Flag Parsing** - Unified compiler can be explicitly disabled

**Deferred to Sprint 2:**
- Pass 6 block lowering (still uses placeholders)
- Default source lowering
- ColorLFO HSL→RGB kernel
- SVGSampleDomain initialization

**Deferred to Sprint 3:**
- Bus evaluation steps
- Event bus lowering

**Deferred to Sprint 4+:**
- Type conversion paths
- Transform chains
- Type system unification

---

## Validation Commands

### Unit Tests
```bash
just test-file src/editor/compiler/ir/__tests__/IRBuilderImpl.test.ts
just test-file src/editor/runtime/executor/steps/__tests__/executeTimeDerive.test.ts
just test-file src/editor/compiler/__tests__/featureFlags.test.ts
```

### Integration Tests
```bash
just test-file tests/compiler/time-topology.test.ts  # Create this
just test-file tests/runtime/absolute-time-flow.test.ts  # Create this
```

### Full Test Suite
```bash
just test  # Should pass 118+ files, 2362+ tests
```

### Manual Validation
```bash
just dev  # Start dev server
# Open Chrome DevTools MCP
# Test finite, cyclic, infinite patches
# Verify timeModel in compiled program
# Toggle VITE_USE_UNIFIED_COMPILER and verify behavior
```

---

## Success Metrics

**Quantitative:**
- Test suite: 118+ files passing (Sprint 0 baseline: 118/126)
- Test count: 2362+ tests passing (Sprint 0 baseline: 2362/2411)
- New tests: 8 unit tests + 3 integration tests
- Code changes: ~100 lines modified/added
- Time spent: 3-4 days

**Qualitative:**
- IR-only patches execute with correct time semantics
- Finite patches complete and stop
- Cyclic patches wrap and fire wrap events
- Infinite patches run continuously
- Developer can toggle compiler on/off
- Foundation ready for Sprint 2 block lowering

---

## Definition of "Done"

Sprint 1 is considered DONE when:

1. **All 12 acceptance criteria above are checked off** (4 + 4 + 3 + 1 meta)
2. **All new tests written and passing**
3. **Full test suite stable** (no regressions from Sprint 0 baseline)
4. **Manual browser verification complete** (Chrome DevTools confirms time topology works)
5. **Feature flag toggle verified** (can disable compiler, verified in dev server)
6. **Code committed** (clean commits, no debug code, commit messages reference Sprint 1)

---

## Files Modified (Expected)

**Core Implementation:**
- `src/editor/compiler/ir/IRBuilderImpl.ts` - Return timeModel from build()
- `src/editor/compiler/ir/builderTypes.ts` - Add timeModel to ProgramIR interface
- `src/editor/compiler/ir/buildSchedule.ts` - Accept timeModel parameter, remove hardcode
- `src/editor/compiler/ir/program.ts` - Add timeModel to CompiledProgramIR
- `src/editor/compiler/compileBusAware.ts` - Thread timeModel to wrapper
- `src/editor/runtime/executor/steps/executeTimeDerive.ts` - Write tAbsMsSlot
- `src/editor/compiler/featureFlags.ts` - Fix string comparison

**Tests Created:**
- `src/editor/compiler/ir/__tests__/IRBuilderImpl.test.ts` (or add to existing)
- `src/editor/runtime/executor/steps/__tests__/executeTimeDerive.test.ts` (or add to existing)
- `src/editor/compiler/__tests__/featureFlags.test.ts` (or add to existing)
- `tests/compiler/time-topology.test.ts` (NEW integration test)
- `tests/runtime/absolute-time-flow.test.ts` (NEW integration test)

**Documentation:**
- `.env.example` - Add VITE_USE_UNIFIED_COMPILER example
- `src/editor/compiler/featureFlags.ts` - Add comment explaining parsing

**Total:** 7 implementation files + 5 test files + 2 docs = ~14 files

---

## Handoff to Sprint 2

**What Sprint 2 Receives:**
- Working time system (finite/cyclic/infinite all functional)
- Absolute time flowing correctly to signal nodes
- Ability to toggle compiler for debugging
- Stable test baseline
- Clean codebase ready for block lowering

**What Sprint 2 Must Do:**
- Implement real block lowering (replace placeholders in Pass 6)
- Lower default sources (wire missing inputs)
- Add ColorLFO HSL→RGB kernel
- Fix SVGSampleDomain initialization

**Sprint 2 Can Assume:**
- TimeModel is available in schedule
- tAbsMs is written correctly
- Tests can be disabled if needed for comparison

---

## Risk Mitigation

**If TimeModel Threading Fails:**
- Fallback: Hardcode infinite for Sprint 1, defer to Sprint 2
- Still delivers: tAbsMs write + feature flag fix
- Impact: Finite/cyclic patches won't work until Sprint 2

**If tAbsMs Source Unclear:**
- Fallback: Trace through Player → ScheduleExecutor carefully
- Consult: core/types.ts, runtime/executor/
- Escalate: If EffectiveTime doesn't have tAbsMs, design decision needed

**If Feature Flag Has Broader Issues:**
- Fallback: Fix just VITE_USE_UNIFIED_COMPILER, defer others
- Check: Other flags may have same bug (fix all if trivial)

---

**Ready for Implementation:** Yes
**Blockers:** None
**Next Action:** Begin with P0-3 (feature flags, 1 hour) then parallel P0-1 and P0-2
