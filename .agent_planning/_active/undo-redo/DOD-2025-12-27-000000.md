# Definition of Done: Undo/Redo Feature
**Generated**: 2025-12-27-000000
**Plan**: PLAN-2025-12-27-000000.md
**Spec**: design-docs/6-Transactions/

---

## Sprint Scope

This sprint delivers: **Core undo/redo functionality with keyboard shortcuts and basic history UI**

Deferred to future sprints:
- Gesture buffer with working state overlay
- Advanced history UI (map view, variation chooser)
- IndexedDB persistence across sessions

---

## Phase 1: Transaction Foundation

### Deliverable: Op Types and Inverses (P0-1)

- [ ] Op union type defined with 8 variants: Add, Remove, Update, SetBlockPosition, SetTimeRoot, SetTimelineHint, Many, and their respective fields
- [ ] `computeInverse(op: Op): Op` function correctly inverts each op type
- [ ] Remove ops capture full entity state in `removed` field for restoration
- [ ] Update ops store both `prev` and `next` states for bidirectional changes
- [ ] Many op handles nested ops and reverses order when inverted
- [ ] All ops are JSON-serializable (no functions, classes, or MobX observables)
- [ ] Unit tests verify round-trip: apply op + apply inverse = original state
- [ ] TypeScript discriminated union enforces type safety

### Deliverable: TxBuilder Core (P0-2)

- [ ] `TxBuilder` class implemented with methods: add(), remove(), replace(), setTimeRoot(), many()
- [ ] `runTx(store, spec, build)` function is the only way to mutate patch state
- [ ] TxBuilder.commit() applies ops to stores atomically
- [ ] Inverse ops are computed correctly at commit time
- [ ] MobX reactivity is preserved (Update ops mutate observables in place)
- [ ] GraphCommitted event fires after successful commit with correct diff summary
- [ ] Transaction label is captured and returned for history display
- [ ] Failed transactions rollback without partial state mutations
- [ ] runTx returns `{ ops, inverseOps }` for history tracking

### Deliverable: Cascade Helpers (P0-3)

- [ ] `TxBuilder.removeBlockCascade(blockId)` removes block and all dependencies
- [ ] Cascade removes connections, bus bindings, default sources, and lane membership
- [ ] `TxBuilder.removeBusCascade(busId)` removes bus and all routing
- [ ] Cascade operations generate Many op containing all sub-ops in correct order
- [ ] Inverse ops correctly recreate entire cascade in reverse order
- [ ] No orphaned connections or bindings remain after cascade
- [ ] Cascade helpers work correctly when invoked during runTx() build phase
- [ ] Unit tests verify cascades with real dependencies

---

## Phase 2: History System

### Deliverable: HistoryStore (P0-4)

- [ ] HistoryStore maintains revision tree with parent/child links
- [ ] RevisionNode type includes: id, parentId, ops, inverseOps, label, timestamp, snapshotData?
- [ ] New revisions are added automatically after each runTx() commit
- [ ] Snapshots are created every 25 revisions using RootStore.toJSON()
- [ ] Each revision stores complete ops and inverseOps arrays
- [ ] Revision tree supports multiple children per parent (for variations)
- [ ] currentRevisionId tracks active revision at all times
- [ ] Tree is queryable: getRevision(id), getChildren(id) work correctly
- [ ] Revision IDs match patchRevision counter for correlation
- [ ] Tree is never truncated (history is forever)

### Deliverable: Undo/Redo Operations (P0-5)

- [ ] `HistoryStore.undo()` applies inverse ops and moves to parent revision
- [ ] `HistoryStore.redo()` applies forward ops and moves to child revision
- [ ] Undo/redo correctly updates patchRevision counter
- [ ] Multiple sequential undo calls navigate up the tree correctly
- [ ] Redo after undo restores exact state (verified with snapshots)
- [ ] Undo at root revision (no parent) does nothing gracefully
- [ ] Redo at leaf revision (no children) does nothing gracefully
- [ ] Works with branching history (multiple children, variations)
- [ ] Snapshot replay works when navigating to distant revisions
- [ ] No new GraphCommitted events during undo/redo (navigation, not mutation)

---

## Phase 3: Store Migration

### Deliverable: PatchStore Migration (P0-6)

- [ ] All PatchStore action methods use runTx() exclusively
- [ ] No direct array mutations (push/filter) remain in PatchStore code
- [ ] addBlock() generates correct Add op with full block state
- [ ] removeBlock() uses removeBlockCascade() helper
- [ ] updateBlock() and updateBlockParams() generate Update ops
- [ ] connect() and disconnect() generate correct Add/Remove ops for connections
- [ ] replaceBlock() uses removeBlockCascade + Add ops
- [ ] expandMacro() creates single Many op for entire macro expansion
- [ ] All existing PatchStore tests pass with new transaction system
- [ ] GraphCommitted events still fire correctly for all operations
- [ ] Manual GraphCommitted emissions removed (handled by runTx)

### Deliverable: BusStore Migration (P0-7)

- [ ] All BusStore action methods use runTx() exclusively
- [ ] createBus() and deleteBus() generate correct Add/Remove ops
- [ ] updateBus() generates Update op with prev/next states
- [ ] addPublisher() and removePublisher() generate correct ops
- [ ] addListener() and removeListener() generate correct ops
- [ ] Lens stack operations (add/remove/clear) generate Update ops for listener entity
- [ ] deleteBus() uses removeBusCascade() helper
- [ ] Publisher reordering (updatePublisher with sortKey) generates Update op
- [ ] All existing BusStore tests pass
- [ ] Bus-related events (BusCreated, BusDeleted, BindingAdded, BindingRemoved) still fire correctly

---

## Phase 4: Basic Undo/Redo UI

### Deliverable: Keyboard Shortcuts (P1-1)

- [ ] Cmd+Z (Ctrl+Z on Windows) triggers undo operation
- [ ] Cmd+Shift+Z (Ctrl+Shift+Z on Windows) triggers redo operation
- [ ] Shortcuts work when editor has focus (not input-focused)
- [ ] Visual feedback shows undo/redo occurred (toast notification or status message)
- [ ] Shortcuts disabled/no-op when no undo/redo available
- [ ] Works correctly with current block selection system
- [ ] Prevents default browser behavior (no browser undo/redo)

### Deliverable: History Panel Component (P1-2)

- [ ] History panel displays all revisions in reverse chronological order (newest first)
- [ ] Current revision is visually highlighted/marked
- [ ] Clicking a revision navigates to that state (loads snapshot or replays ops)
- [ ] Each revision shows: label, timestamp, and revision ID
- [ ] Panel can be toggled open/closed via UI button
- [ ] Panel updates reactively when new revisions are added (MobX observer)
- [ ] Scrollable when revision list is long (handles 100+ revisions)
- [ ] Panel is accessible and keyboard-navigable

---

## Phase 5: Testing & Integration

### Deliverable: Transaction System Tests (P0-8)

- [ ] Op inversion tests: all 8 op types correctly invert (8+ unit tests)
- [ ] Round-trip tests: apply op + apply inverse = original state (8+ tests)
- [ ] Many op handles nested ops and order reversal (3+ tests)
- [ ] TxBuilder commit logic unit tests (5+ tests)
- [ ] Cascade helpers tested with real dependencies (4+ tests)
- [ ] HistoryStore tree navigation tests (6+ tests)
- [ ] Undo/redo integration tests cover all entity types: blocks, connections, buses, publishers, listeners (10+ tests)
- [ ] Snapshot creation and replay tested (3+ tests)
- [ ] Edge cases tested: undo at root, redo at leaf, multiple children (5+ tests)
- [ ] All tests pass in CI before merging
- [ ] Test coverage >80% for transaction system code

### Deliverable: Manual Testing & Edge Cases (P0-9)

- [ ] Basic operations verified: add block, connect blocks, delete block → all undo/redo correctly
- [ ] Complex operations verified: replace block (preserves connections), expand macro (removes all created blocks) → undo/redo correctly
- [ ] Bus routing changes (add/remove publisher/listener) → undo/redo preserves bindings
- [ ] Edge cases tested: undo at patch start (no-op), multiple undo then redo, create variation after undo
- [ ] Performance acceptable: undo/redo with large patch (100+ blocks) completes in <500ms
- [ ] History panel usable: 100+ revisions load and render without lag
- [ ] No memory leaks during extended undo/redo session (verified with Chrome DevTools)
- [ ] All scenarios tested with "Breathing Constellation" golden patch
- [ ] Any discovered issues documented as P2 follow-up items

---

## Overall Sprint Completion Criteria

### User-Facing Functionality
- [ ] User can undo any edit operation with Cmd+Z
- [ ] User can redo any undone operation with Cmd+Shift+Z
- [ ] History panel shows all revisions chronologically
- [ ] Clicking revision in history panel restores that state
- [ ] Complex operations (replace block, expand macro, bus routing) undo correctly
- [ ] Visual feedback confirms undo/redo actions

### Code Quality
- [ ] No direct store mutations remain (all mutations via runTx)
- [ ] All existing tests pass (no regressions)
- [ ] New transaction tests pass (30+ tests minimum)
- [ ] Code reviewed and approved
- [ ] No console errors or warnings in normal usage

### Architecture
- [ ] Transaction system enforces command-based pattern
- [ ] All edits are reversible via undo
- [ ] History is persistent in memory during session
- [ ] MobX reactivity preserved through transaction system
- [ ] Foundation ready for gesture buffer implementation

### Documentation
- [ ] Transaction system architecture documented in code comments
- [ ] Op types have clear JSDoc descriptions
- [ ] runTx() usage examples in developer docs
- [ ] Known limitations documented (e.g., no cross-session persistence yet)

---

## Success Metrics

**Before Sprint**:
- Undo capability: 0%
- Mutations through transactions: 0%
- History tracking: 0%

**After Sprint**:
- Undo capability: 100% (all operations reversible)
- Mutations through transactions: 100% (no direct mutations)
- History tracking: 100% (full revision tree)
- Test coverage: >80% for transaction code
- User satisfaction: Can safely experiment with patches

**Post-Sprint Capabilities**:
- Safe experimentation (undo any change)
- Foundation for Path-Focused Composition UX
- Ready for auto-layout, auto-connect, quick-swap features
- Prepared for gesture buffer enhancement
