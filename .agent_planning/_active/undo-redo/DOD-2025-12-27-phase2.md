# Definition of Done: Undo-Redo Phase 2 - Complete Store Migration
**Generated**: 2025-12-27-103000
**Plan**: PLAN-2025-12-27-phase2.md
**Source**: STATUS-2025-12-27-phase2.md

## Sprint Scope
This sprint delivers: Complete PatchStore migration, Complete BusStore migration, Integration testing
Deferred: replaceBlock, expandMacro, lens operations, block positions, gesture buffer

---

## Acceptance Criteria

### P0-1: Migrate addBlock() to runTx()

- [ ] `addBlock()` uses `runTx()` for all block creation
- [ ] No direct push to `this.blocks` array
- [ ] User can add block → undo → redo successfully
- [ ] GraphCommitted event fires with correct diff summary
- [ ] MobX reactivity preserved (UI updates when block added)
- [ ] All existing tests pass after migration
- [ ] New test: "undoes addBlock operation" passes

### P0-2: Migrate removeBlock() to use removeBlockCascade()

- [ ] `removeBlock()` uses `tx.removeBlockCascade()` exclusively
- [ ] No direct array filtering on `this.blocks`
- [ ] `suppressGraphCommitted` option removed from signature
- [ ] User can remove block → undo → redo successfully
- [ ] Lane membership restored on undo
- [ ] GraphCommitted event fires with correct diff (blocks, connections, bindings)
- [ ] All existing tests pass after migration

### P0-3: Migrate updateBlock() and updateBlockParams()

- [ ] `updateBlock()` uses `tx.replace()` for all updates
- [ ] `updateBlockParams()` uses `tx.replace()` for param updates
- [ ] No direct Object.assign mutations on blocks
- [ ] User can drag param slider → undo → redo successfully
- [ ] Undo restores previous param value exactly
- [ ] MobX reactivity preserved (UI updates immediately on param change)
- [ ] GraphCommitted event fires after param update
- [ ] All existing tests pass after migration

### P0-4: Migrate setTimeRoot()

- [ ] `setTimeRoot()` uses `tx.setTimeRoot()` exclusively
- [ ] No direct assignment to `this.timeRootBlockId`
- [ ] User can set time root → undo → redo successfully
- [ ] Undo restores previous time root (or null)
- [ ] GraphCommitted event fires with `timeRootChanged: true`
- [ ] Player reacts correctly to time root changes
- [ ] All existing tests pass after migration

### P0-5: Remove suppressGraphCommitted Pattern

- [ ] `suppressGraphCommitted` option removed from connect() signature
- [ ] `suppressGraphCommitted` option removed from disconnect() signature
- [ ] All mutations flow through runTx() (no dual paths)
- [ ] GraphCommitted always fires after connect/disconnect
- [ ] All callers updated (or deferred to Phase 3)
- [ ] All existing tests pass after migration
- [ ] No regression in replaceBlock behavior (if called)

### P1-1: Migrate BusStore.deleteBus() to removeBusCascade()

- [ ] `deleteBus()` uses `tx.removeBusCascade()` exclusively
- [ ] User can delete bus → undo → redo successfully
- [ ] GraphCommitted event fires with correct diff
- [ ] All existing tests pass after migration

### P1-2: Migrate BusStore.updateBus()

- [ ] `updateBus()` uses `tx.replace()` for all updates
- [ ] No direct property assignments on bus objects
- [ ] User can update bus name → undo → redo successfully
- [ ] User can update combine mode → undo → redo successfully
- [ ] MobX reactivity preserved (UI updates immediately)
- [ ] GraphCommitted event fires after update
- [ ] All existing tests pass after migration


- [ ] No direct array index assignments
- [ ] Lens stack updates (adapterChain, lensStack) undoable
- [ ] MobX reactivity preserved
- [ ] GraphCommitted event fires after update
- [ ] All existing tests pass after migration

### P0-6: Write Integration Tests

- [ ] All block operations (add, remove, update) have undo/redo integration tests
- [ ] All bus operations (create, delete, update) have undo/redo integration tests
- [ ] Cascade operations (removeBlock, deleteBus) verified to restore all dependencies
- [ ] MobX reactivity verified (autorun triggers on undo/redo)
- [ ] Multi-step undo (undo → undo → redo → redo) works correctly
- [ ] Undo at root / redo at leaf handled gracefully
- [ ] All integration tests pass
- [ ] Test coverage: 20+ integration tests

### P0-7: Manual Testing with Chrome DevTools MCP

- [ ] All 8 test scenarios pass visual verification
- [ ] No regressions in existing UI behavior
- [ ] Undo/redo feels smooth and predictable to user
- [ ] History Panel is usable and informative
- [ ] No memory leaks during extended undo/redo session (DevTools Memory tab)

---

## Sprint Success Criteria (Overall)

### Functional Requirements
- [ ] User can undo: addBlock, removeBlock, updateBlockParams, connect, disconnect
- [ ] All operations restore exact previous state (no data loss)
- [ ] Undo after cascade operations (removeBlock, deleteBus) restores all dependencies
- [ ] Multi-step undo/redo works correctly (undo → undo → redo → redo)

### Code Quality
- [ ] All PatchStore mutations use runTx() (no direct mutations remain)
- [ ] All BusStore mutations use runTx() (no direct mutations remain)
- [ ] `suppressGraphCommitted` pattern eliminated from connect/disconnect
- [ ] All store methods have consistent transaction-based API
- [ ] No dual-path mutations (one code path for all operations)

### Testing
- [ ] All existing tests pass (66 transaction tests + store tests)
- [ ] 20+ new integration tests pass (undo/redo for all operations)
- [ ] Manual testing with Chrome DevTools MCP verifies UI behavior
- [ ] No regressions in existing functionality

### Events & Reactivity
- [ ] GraphCommitted events fire correctly for all operations
- [ ] Fine-grained events (BlockAdded, WireAdded) still fire for UI
- [ ] MobX reactivity preserved (UI updates immediately)
- [ ] Compiler recompiles after undo/redo

---

## Verification Steps (Manual Testing)

### Basic Operations
1. [ ] Add Block → Undo → Redo (block appears/disappears/reappears)
2. [ ] Connect Blocks → Undo → Redo (wire appears/disappears/reappears)
3. [ ] Remove Block with Connections → Undo (block AND connections restored)

### Parameter Updates
4. [ ] Drag Param Slider → Undo (value restored to previous state)

### Bus Operations
6. [ ] Delete Bus → Undo (bus + routing restored)

### Complex Workflows
7. [ ] Multi-step Undo (add block 1 → add block 2 → connect → undo 3x → redo 3x)
8. [ ] History Panel Navigation (click revisions, canvas updates)

---

## Deferred Items (Explicitly Out of Scope)

### Operations (Phase 3)
- [ ] DEFERRED: replaceBlock() - complex, needs multi-step transaction
- [ ] DEFERRED: expandMacro() - very complex, needs macro snapshot
- [ ] DEFERRED: addBlockAtIndex() - edge case, low priority
- [ ] DEFERRED: Lens stack operations on connections - needs lens snapshot design
- [ ] DEFERRED: addLensToConnection, removeLensFromConnection, updateConnectionLens
- [ ] DEFERRED: addLensToStack, removeLensFromStack, clearLensStack

### Features (Future)
- [ ] DEFERRED: Block position undo (drag operations) - needs ViewStateStore
- [ ] DEFERRED: Gesture buffer - UX enhancement, not required for basic undo
- [ ] DEFERRED: IndexedDB persistence - nice-to-have
- [ ] DEFERRED: Advanced history UI (map view, variations chooser)

---

## Done Definition

Sprint 2 is DONE when:
1. All acceptance criteria above are checked ✓
2. All tests pass (existing + new integration tests)
3. Manual verification with Chrome DevTools MCP confirms UI works
4. User can undo ALL in-scope operations (add/remove/update blocks, buses, routing)
5. No direct store mutations remain (grep confirms all use runTx)
6. Code review approved
7. Documentation updated (if needed)
