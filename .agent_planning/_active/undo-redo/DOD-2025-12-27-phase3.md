# Definition of Done: Undo-Redo Phase 3
**Generated**: 2025-12-27-110000
**Plan**: PLAN-2025-12-27-phase3.md
**Source**: STATUS-2025-12-27-phase3.md

---

## Acceptance Criteria

### 1. replaceBlock() Atomic Transaction

**Atomicity**:
- [ ] replaceBlock() wraps entire operation in single runTx() call
- [ ] Undo of replaceBlock fully restores old block with all connections
- [ ] Redo recreates new block with preserved connections
- [ ] No orphaned blocks left in patch after undo

**Connection Preservation**:
- [ ] Compatible connections preserved using tx.add('connections', ...)
- [ ] Dropped connections reported in result object
- [ ] Connection lens stacks preserved for compatible connections

**Bus Routing**:
- [ ] Incompatible bus routing removed via cascade

**Lane Management**:
- [ ] New block inserted at same lane position as old block using tx.replace('lanes', ...)
- [ ] Old block removed from lane via removeBlockCascade

**Event Integrity**:
- [ ] BlockReplaced event contains correct oldBlockId, newBlockId, preserved/dropped counts
- [ ] GraphCommitted emitted once per operation (not per sub-op)
- [ ] Selection UI updates correctly (BlockReplaced visible before old block gone)

**Cleanup**:
- [ ] suppressGraphCommitted parameter removed from connect() signature
- [ ] suppressGraphCommitted parameter removed from disconnect() signature
- [ ] suppressGraphCommitted logic deleted from lines 994, 1044 in PatchStore.ts
- [ ] All 4 suppress=true call sites removed (lines 804, 853, 912)

---

### 2. updateConnection() Migration

- [ ] updateConnection() uses runTx() with tx.replace('connections', ...)
- [ ] Manual GraphCommitted emission removed (handled by runTx)
- [ ] Undo restores previous connection lensStack/adapterChain/enabled state
- [ ] Redo reapplies connection updates
- [ ] All 3 lens methods (add/remove/update) produce undoable operations

---

### 3. BusStore Lens Operations

**addLensToStack()**:
- [ ] Undo removes added lens from stack
- [ ] Redo re-adds lens at correct index
- [ ] createLensInstanceFromDefinition() integration preserved

**removeLensFromStack()**:
- [ ] Undo restores removed lens with original params
- [ ] Redo removes lens again
- [ ] sortKey recalculation works correctly

**clearLensStack()**:
- [ ] Undo restores entire previous stack (all lenses, order, params)
- [ ] Redo clears stack again

**Error Handling**:
- [ ] "Invalid lens index" errors still thrown before runTx

---

### 4. addBlockAtIndex() Atomicity

**Atomicity**:
- [ ] addBlockAtIndex() wraps all mutations in single runTx()
- [ ] Undo removes block from both blocks collection and lane
- [ ] Redo adds block back at same lane index

**Lane Integration**:
- [ ] Block inserted at specified lane index using tx.replace('lanes', ...)
- [ ] Lane blockIds updated atomically with block creation

**Auto-Bus Connections**:
- [ ] Undo removes auto-connections

**Default Sources**:
- [ ] createDefaultSourcesForBlock() called (transaction awareness deferred)
- [ ] Default sources recreated on redo

**Event Emission**:
- [ ] Single GraphCommitted event emitted (not one per auto-connection)
- [ ] BlockAdded event still emitted with correct metadata

---

## Test Coverage (35+ New Tests)

### Unit Tests (15+)

**replaceBlock()**:
- [ ] Transaction creates correct op sequence (add block, update lane, add connections, remove old)
- [ ] Compatible connections identified correctly
- [ ] Dropped connections reported in result

**updateConnection()**:
- [ ] Transaction creates tx.replace('connections', ...) op
- [ ] Partial updates merged correctly

**BusStore Lens Operations**:

**addBlockAtIndex()**:
- [ ] Transaction creates correct op sequence (add block, update lane, add auto-connections)
- [ ] Auto-bus connections computed correctly

---

### Integration Tests (20+)

**replaceBlock() Undo/Redo**:
- [ ] Undo restores old block with all connections intact
- [ ] Redo creates new block with preserved connections
- [ ] Dropped connections not restored on undo
- [ ] Lane position preserved through undo/redo

**Connection Lens Operations**:
- [ ] addLensToConnection -> undo removes lens
- [ ] removeLensFromConnection -> undo restores lens with params
- [ ] updateConnectionLens -> undo restores original params
- [ ] Multiple lens ops -> undo each in reverse order

- [ ] addLensToStack -> undo removes lens
- [ ] removeLensFromStack -> undo restores lens
- [ ] clearLensStack -> undo restores entire stack (3+ lenses)
- [ ] Lens stack order preserved through undo/redo

**addBlockAtIndex() Undo/Redo**:
- [ ] Undo removes block from collection and lane
- [ ] Redo adds block back at same lane index
- [ ] Auto-bus connections removed on undo
- [ ] Auto-bus connections restored on redo

**Edge Cases**:
- [ ] replaceBlock with no compatible connections
- [ ] replaceBlock with mixed compatible/incompatible
- [ ] Lens operations on connection with no existing stack
- [ ] addBlockAtIndex at lane start (index 0)
- [ ] addBlockAtIndex at lane end (index = length)

---

## Manual Testing

**Pre-Phase 3 Regression** (verify Phase 2 still works):
- [ ] Add block -> undo -> block removed
- [ ] Remove block -> undo -> block restored with connections
- [ ] Connect -> undo -> connection removed
- [ ] Disconnect -> undo -> connection restored

**Post-Sprint 1** (lens operations):
- [ ] Open lens editor for connection
- [ ] Add lens (e.g., Scale) -> undo -> lens removed
- [ ] Remove lens -> undo -> lens restored with params
- [ ] Edit lens params -> undo -> params restored

**Post-Sprint 2** (complex operations):
- [ ] Quick-swap block (right-click -> Replace With) -> undo -> original block restored
- [ ] Quick-swap with connections -> undo -> connections restored
- [ ] Quick-swap with bus routing -> undo -> routing restored
- [ ] Add block in middle of lane -> undo -> block removed, lane intact
- [ ] Verify no suppressGraphCommitted in codebase (grep)

---

## Sprint Scope

### Sprint 1: Lens Operations (5-7 days)

**Delivers**:
1. updateConnection() migration (1 day)
2. BusStore lens operations (2-3 days)
3. Integration tests (1-2 days)

**Success**: 10+ tests, all lens operations undoable

---

### Sprint 2: Complex Operations (6-8 days)

**Delivers**:
1. replaceBlock() migration (3-5 days)
2. addBlockAtIndex() migration (2-3 days)
3. suppressGraphCommitted cleanup (1 day)
4. Integration tests (1-2 days)

**Success**: 15+ tests, replaceBlock atomic, pattern removed

---

## Deferred to Phase 4+

| Item | Reason |
|------|--------|
| expandMacro() | Needs design decision on clearPatch atomicity |
| Block positions | Needs gesture buffer (separate feature) |
| IndexedDB persistence | Nice-to-have, not blocking |
| Advanced history UI | Nice-to-have, not blocking |

---

## Phase 3 Complete Definition

Phase 3 is COMPLETE when ALL of the following are true:

1. **Code Changes**:
   - [ ] 8/8 methods migrated to runTx() (replaceBlock, updateConnection, 3 BusStore lens ops, addBlockAtIndex)
   - [ ] suppressGraphCommitted pattern removed entirely (0 grep matches)
   - [ ] Lane transaction support added (tx.replace('lanes', ...))

2. **Test Coverage**:
   - [ ] 35+ new tests passing (15 unit + 20 integration)
   - [ ] All integration tests verify undo/redo for migrated operations
   - [ ] just check passes with no regressions

3. **Manual Verification**:
   - [ ] Quick-swap undo/redo works in live editor (no orphaned blocks)
   - [ ] Lens editor undo/redo works for all 6 operations
   - [ ] addBlockAtIndex undo/redo preserves lane position

4. **Metrics**:
   - [ ] Methods Migrated: 23/22 (100% of planned scope)
   - [ ] Tests Passing: 122+ (87 existing + 35 new)
   - [ ] Confidence: FRESH (verified on git commit post-Phase 3)

---

## Success Metrics Summary

| Metric | Phase 2 | Phase 3 Target | Phase 3 Complete |
|--------|---------|----------------|------------------|
| Methods Migrated | 15/22 | 23/22 | ☑ 23/22 |
| Tests Passing | 87 | 122+ | ☑ 122+ |
| Nested Tx Bugs | 1 (replaceBlock) | 0 | ☑ 0 |
| suppressGraphCommitted Uses | 4 | 0 | ☑ 0 |
| Undo Coverage | Basic ops | Complex ops + lens | ☑ Complete |

---

**Provenance**:
- Source: STATUS-2025-12-27-phase3.md
- Agent: status-planner
- Generated: 2025-12-27-110000
- Git Commit: f4cb96f (Value Slots)
