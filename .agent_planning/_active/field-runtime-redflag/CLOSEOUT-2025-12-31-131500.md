# Sprint Closeout: Field Runtime Workstream 3

**Completed:** 2025-12-31
**Branch:** `ir-backlog-03-field-runtime`

---

## Deliverables Summary

### ✅ P0: Stable Domain Element IDs - COMPLETE

**Implementation:**
- Added `elementIds?: readonly string[]` to `DomainDefIR` in `builderTypes.ts`
- Updated `IRBuilder.domainFromN()` interface and implementation to accept element IDs
- Added `seededId()` helper function that generates 8-character alphanumeric IDs from a deterministic seed
- Updated `GridDomain` IR lowering to emit stable seeded IDs (seed = rows * 10000 + cols + index)
- Updated `DomainN` IR lowering to emit stable seeded IDs (seed = userSeed * 100000 + n + index)
- Domain handles in schedule now include `elementIds` field
- `executeMaterialize.ts` extracts and threads `domainElements` to `MaterializerEnv`
- `hash01ById` in Materializer uses `env.domainElements?.[i]` for stable hashing

**ID Format:**
- Short 8-character alphanumeric strings (base36)
- Deterministic: same configuration produces same IDs
- No encoded metadata (position, index, etc.)

**Key Files Changed:**
- `src/editor/compiler/ir/builderTypes.ts`
- `src/editor/compiler/ir/IRBuilder.ts`
- `src/editor/compiler/ir/IRBuilderImpl.ts`
- `src/editor/compiler/blocks/domain/GridDomain.ts`
- `src/editor/compiler/blocks/domain/DomainN.ts`
- `src/editor/runtime/executor/steps/executeMaterialize.ts`

---

### ✅ P0: FieldExprMapIndexed IR Node + Runtime - COMPLETE

**Implementation:**
- Added `FieldExprMapIndexed` to IR schema in `fieldExpr.ts`
- Added `fieldMapIndexed()` to IRBuilder interface and implementation
- Added `MapIndexed` handle type to runtime `FieldHandle` union
- Added `fillBufferMapIndexed()` in Materializer with kernels:
  - `linearInterp`: Linear interpolation between start/end values
  - `normalizedIndex`: Returns i/(n-1) for each element
  - `hueGradient`: Generates hue gradient with offset and spread

**Schema:**
```typescript
export interface FieldExprMapIndexed {
  kind: "mapIndexed";
  type: TypeDesc;
  domainSlot: ValueSlot;  // Domain for N
  fn: PureFnRef;          // fn(i, n, ...sigValues) → T
  signals?: SigExprId[];  // Optional signals evaluated once
}
```

---

### ✅ P0: FieldExprZipSig IR Node + Runtime - COMPLETE

**Implementation:**
- Added `FieldExprZipSig` to IR schema in `fieldExpr.ts`
- Added `fieldZipSig()` to IRBuilder interface and implementation
- Added `ZipSig` handle type to runtime `FieldHandle` union
- Added `fillBufferZipSig()` in Materializer with kernels:
  - Scalar: `Add`, `Mul`, `Sub`, `Div`
  - Vec2: `jitterVec2`, `vec2Rotate`, `vec2Scale`, `vec2Translate`

**Schema:**
```typescript
export interface FieldExprZipSig {
  kind: "zipSig";
  type: TypeDesc;
  field: FieldExprId;      // Per-element input
  signals: SigExprId[];    // Signals evaluated once
  fn: PureFnRef;           // fn(fieldValue, sig1, sig2, ...) → T
}
```

---

## Workstream Status

### Hidden Providers Work (Sprints 1-18): COMPLETE
- Default source system fully implemented
- 381 files changed over 103 commits
- See sprint summaries in `.agent_planning/ir-primitives-complete/`

### Red-Flag Plan Status:
- P0 (defaults emit correctly): COMPLETE
- P0.5 (schedule consistency): COMPLETE
- P1 (hidden providers): COMPLETE
- P2 (params audit): MOOT - separate system from FieldHandle.params
- P3 (type system): Initial review complete

### Original 03-field-runtime-primitives Plan:
- ✅ Stable domain element IDs: COMPLETE
- ✅ FieldExprMapIndexed: COMPLETE
- ✅ FieldExprZipSig: COMPLETE
- ⏳ Transform chain evaluation: DEFERRED
- ⏳ Field reduce (reduceFieldToSig): DEFERRED
- ⏳ Non-numeric field combine: DEFERRED

---

## Test Status

- **Tests:** 2646 passing
- **Typecheck:** Passing
- **Skipped:** 11 (expected)

---

## Files Changed in This Sprint

1. `src/editor/compiler/ir/fieldExpr.ts` - Added FieldExprMapIndexed, FieldExprZipSig
2. `src/editor/compiler/ir/IRBuilder.ts` - Added fieldMapIndexed(), fieldZipSig()
3. `src/editor/compiler/ir/IRBuilderImpl.ts` - Implemented new methods
4. `src/editor/compiler/ir/builderTypes.ts` - Added elementIds to DomainDefIR
5. `src/editor/compiler/blocks/domain/GridDomain.ts` - Emit stable element IDs
6. `src/editor/compiler/blocks/domain/DomainN.ts` - Emit stable element IDs
7. `src/editor/runtime/field/types.ts` - Added MapIndexed, ZipSig handle types
8. `src/editor/runtime/field/FieldHandle.ts` - Handle mapIndexed, zipSig IR nodes
9. `src/editor/runtime/field/Materializer.ts` - fillBufferMapIndexed, fillBufferZipSig
10. `src/editor/runtime/executor/steps/executeMaterialize.ts` - Thread elementIds, convert new nodes

---

## Remaining Work (for future sprints)

1. **Transform Chain Evaluation**: Implement field transform chain runtime
2. **Field Reduce**: Proper field-to-signal reduction (currently uses closure bridge placeholder)
3. **Non-Numeric Combine**: vec2/vec3/color field combine support
4. **Additional Kernels**: More indexed and zipSig kernels as blocks require them
