# Definition of Done: Field Runtime Implementation Sprint

**Generated:** 2025-12-31-110500
**Plan:** PLAN-2025-12-31-110500.md

---

## Acceptance Criteria

### Deliverable 1: Stable Domain Element IDs

**Goal:** hash01ById and related ops use stable element IDs, not index fallback

- [ ] Domain element IDs traced from builder to runtime
  - [ ] GridDomain emits stable IDs (e.g., `grid:r{row}:c{col}`)
  - [ ] DomainN emits stable IDs (seed-based, deterministic)
- [ ] `MaterializerEnv.domainElements` populated correctly from domain handles
- [ ] `src/editor/runtime/field/Materializer.ts:288` no longer falls back to `String(index)`
- [ ] Hard error if element IDs are missing (no silent fallback)
- [ ] Hash operations produce identical results when domain order changes

**Runtime Validation:**
- [ ] Create patch with GridDomain (5x5) + hash01ById op
- [ ] Change grid to 6x6, verify existing element hashes unchanged
- [ ] Reorder domain elements, verify hashes follow elements not indices

---

### Deliverable 2: FieldExprMapIndexed IR Node

**Goal:** Field ops can access element index and count

- [ ] Node type added to `src/editor/compiler/ir/fieldExpr.ts`:
  ```typescript
  export interface FieldExprMapIndexed {
    kind: "mapIndexed";
    type: TypeDesc;
    src: FieldExprId;
    fn: PureFnRef;
    params?: Record<string, unknown>;
  }
  ```
- [ ] Node added to `FieldExprIR` union type
- [ ] `IRBuilderImpl.fieldMapIndexed()` helper implemented
- [ ] FieldHandle variant added: `OpIndexed` in `FieldHandle.ts`
- [ ] `fillBufferOpIndexed()` implemented in Materializer
- [ ] Index (`i`) and count (`N`) accessible in op evaluation

**Runtime Validation:**
- [ ] Create test field op that uses element index
- [ ] Verify index values are correct (0 to N-1)
- [ ] Verify N matches domain size

---

### Deliverable 3: FieldExprZipSig IR Node

**Goal:** Combine field elements with multiple signal values

- [ ] Node type added to `src/editor/compiler/ir/fieldExpr.ts`:
  ```typescript
  export interface FieldExprZipSig {
    kind: "zipSig";
    type: TypeDesc;
    src: FieldExprId;
    signals: SigExprId[];
    fn: PureFnRef;
    params?: Record<string, unknown>;
  }
  ```
- [ ] Node added to `FieldExprIR` union type
- [ ] `IRBuilderImpl.fieldZipSig()` helper implemented
- [ ] FieldHandle variant added: `ZipSig` in `FieldHandle.ts`
- [ ] `fillBufferZipSig()` implemented in Materializer
- [ ] Signals evaluated once per frame, applied to each element

**Runtime Validation:**
- [ ] Create field with two signal modulators
- [ ] Verify both signals affect field output
- [ ] Verify signals are evaluated once (not per-element)

---

### Deliverable 4: Brief Closeout Documentation

**Goal:** Update planning docs to reflect completed work

- [ ] `.agent_planning/audit/field-runtime-redflags-resolved.md` updated:
  - [ ] P2 marked as MOOT with rationale (FieldHandle.params are correct)
  - [ ] Hidden providers work noted
- [ ] This sprint's deliverables marked COMPLETE
- [ ] Remaining items (transform chains, field reduce, non-numeric combine) marked DEFERRED

---

## Test Requirements

- [ ] `just typecheck` passes
- [ ] `just test` passes (2646+ tests)
- [ ] No new lint errors

---

## Files Modified/Created

**IR Layer:**
- `src/editor/compiler/ir/fieldExpr.ts` - Add FieldExprMapIndexed, FieldExprZipSig
- `src/editor/compiler/ir/IRBuilderImpl.ts` - Add builder helpers

**Runtime Layer:**
- `src/editor/runtime/field/FieldHandle.ts` - Add OpIndexed, ZipSig handles
- `src/editor/runtime/field/Materializer.ts` - Implement fillBuffer functions, fix element ID fallback

**Domain Builders (if needed):**
- `src/editor/compiler/blocks/domain/GridDomain.ts` - Emit stable element IDs
- `src/editor/compiler/blocks/domain/DomainN.ts` - Emit stable element IDs

**Documentation:**
- `.agent_planning/audit/field-runtime-redflags-resolved.md` - Update

---

## Success Criteria

**Sprint COMPLETE when:**
1. All checkboxes above are checked
2. Runtime validation confirms features work
3. All tests pass
4. User can use indexed field ops and multi-signal field ops
