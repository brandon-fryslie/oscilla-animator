# Field Runtime Red Flags - Status Report (Updated)

**Timestamp:** 2025-12-28-220000
**Scope:** Field Runtime (FieldExpr, FieldHandle, Materializer)
**Source:** `plans/field-runtime-plan-v2.md`, `plans/field-runtime-implementation-checklist.md`

---

## Executive Summary

**Session Progress:** 4 of 6 planned items completed; 2 blocked by architectural gap.

| Priority | Item | Status |
|----------|------|--------|
| P0 | Hard error on signal fallback | ✅ DONE (already implemented) |
| P0.5 | No silent default source fallback | ✅ DONE |
| P0-bug | Params not propagated to FieldHandle | ✅ DONE |
| TypeScript | Build errors fixed | ✅ DONE |
| P1 | Compiler default source handling | ⏳ BLOCKED (needs IR primitives) |
| P2 | Remove legacy params code | ⏳ BLOCKED (depends on P1) |

---

## Completed Fixes

### 1. TypeScript Errors Fixed

**Files Modified:**
- `src/editor/compiler/ir/index.ts` - Export `LinkedGraphIR`
- `src/editor/debug-ui/IRTab.tsx` - Fix `Bus.valueType` → `Bus.type.world:domain`
- `src/editor/stores/DebugStore.ts` - Import `CompileError` type

### 2. P0: Hard Error on Signal Fallback ✅

**Location:** `src/editor/runtime/field/Materializer.ts:182-188`

**Already Implemented:**
```typescript
throw new Error(
  `Cannot evaluate signal ${sigId}: no irEnv or signalBridge available. ` +
  `This usually means a field expression references a signal that wasn't wired ` +
  `by the compiler. Check that all signal inputs are connected.`
);
```

**Status:** No change needed - already throws with actionable message.

### 3. FieldHandle Params Bug Fixed ✅

**Location:** `src/editor/runtime/field/FieldHandle.ts:118-141`

**Change:**
```typescript
// Before:
handle = { kind: 'Op', op, args: [node.src], type: node.type };

// After:
handle = { kind: 'Op', op, args: [node.src], type: node.type, params: { ...node.fn.params, ...node.params } };
```

**Also fixed:** Added `params?` field to `FieldExprIR` map/zip variants in `runtime/field/types.ts`.

### 4. P0.5: No Silent Default Source Fallback ✅

**Location:** `src/editor/compiler/passes/pass6-block-lowering.ts:268-295`

**Before:** Silently injected `sigConst(0)` for missing inputs.

**After:**
1. Check if port has registered `defaultSource` → use it
2. Otherwise → throw compile error with actionable message

```typescript
throw new Error(
  `Missing input "${inputPort.id}" for block "${block.type}" (${block.id}). ` +
  `No wire, bus listener, or defaultSource provides a value. ` +
  `Fix: Connect a wire, add a bus listener, or define a defaultSource for this port.`
);
```

---

## Blocked Items

### P1: Compiler Default Source Handling for Field Ops

**Status:** BLOCKED - Requires new IR primitives.

**Problem:** Field operations (JitterVec2, FieldMapVec2, FieldHueGradient) need to combine:
- **Fields** (per-element values)
- **Signals** (time-varying scalars)
- With custom per-element logic

**Current IR has:**
- `FieldExprMap` - unary field op
- `FieldExprZip` - binary field op
- `FieldExprBroadcastSig` - broadcast signal to field

**Current IR lacks:**
- `FieldExprZipSig` - combine field with signals per-element
- `FieldExprMapIndexed` - access element index/count

**Workaround attempt:** `FieldZipSignal` uses broadcast-then-zip, but this only works for simple binary ops, not complex multi-param operations like JitterVec2.

**Spec Created:** `plans/SPEC-field-signal-combination-primitives.md`

### P2: Remove Legacy Params Code

**Status:** BLOCKED - Depends on P1.

**Reason:** If we remove params now, the closure-mode implementations (which currently work) would break. P1 must provide an alternative path before P2 can proceed.

---

## Verification

```bash
just typecheck  # ✅ Passes
pnpm test --run # ✅ 2442/2442 tests pass
```

---

## Next Steps

**Immediate (no blockers):**
1. P3: Update audit document with accurate status

**Requires architecture work:**
2. Implement `FieldExprZipSig` IR node (see spec)
3. Migrate field ops to use new primitive
4. Then remove legacy params (P2)

**Estimated effort for P1+P2:** 2-3 focused sessions.

---

## Artifacts Created

| File | Purpose |
|------|---------|
| `plans/SPEC-field-signal-combination-primitives.md` | Detailed spec for missing IR primitives |
| This status file | Progress tracking |

---

## Verdict

**Sprint 1 Status:** PARTIALLY COMPLETE

- Core fixes (P0, P0.5, params bug) are done
- P1/P2 require architectural extension (not bug fixing)
- Spec is written for the architectural work
- All tests pass, build works

**Recommendation:** Close Sprint 1 as successful for its scope. P1/P2 should be a separate initiative ("Field-Signal IR Primitives").
