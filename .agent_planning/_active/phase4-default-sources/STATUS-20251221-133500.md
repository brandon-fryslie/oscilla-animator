# Phase 4: Default Sources - Compiler Migration STATUS

**Evaluated**: 2025-12-21-133500
**Evaluator**: project-evaluator
**Scope**: phase4-default-sources topic area
**Confidence**: FRESH
**Git Commit**: 24ba70d

---

## Executive Summary

**Overall Status**: READY TO START (Prerequisites 80% Complete)
**Critical Blockers**: None (Type system ready, migration helpers needed)
**Estimated Effort**: 3-5 days (36 block compilers √ó 15-30 min each + integration)
**Risk Level**: MEDIUM (large surface area, but straightforward mechanical refactor)

**Verdict**: ‚úÖ **CONTINUE** - Prerequisites nearly complete, clear path forward

---

## Current State Assessment

### 1. What Exists ‚úÖ

#### Type System (Phase 1: COMPLETE)
Location: `src/editor/types.ts:361-520`

**Slot interface extended with Default Source support:**
```typescript
export interface Slot {
  readonly id: string;
  readonly label: string;
  readonly type: SlotType;
  readonly direction: 'input' | 'output';

  // NEW: Default Source support (Phase 1)
  readonly defaultSource?: DefaultSource;  // Lines 519
  readonly tier?: SlotTier;                // Lines 531
}

export interface DefaultSource {
  readonly value: unknown;              // The constant value
  readonly uiHint: UIControlHint;       // UI control metadata
  readonly world: SlotWorld;            // Evaluation timing
}

export type SlotWorld = 'signal' | 'field' | 'scalar' | 'config';
```

**Status**: ‚úÖ Type definitions are complete and in production code.

#### Block Definitions (Phase 2: PARTIAL - 91 defaults, ~50 blocks remaining)

**Files with defaultSource implementations:**
- `src/editor/blocks/domain.ts` - 51 defaultSource definitions
- `src/editor/blocks/field-primitives.ts` - 10 defaultSource definitions
- `src/editor/blocks/signal.ts` - 18 defaultSource definitions
- `src/editor/blocks/rhythm.ts` - 8 defaultSource definitions
- `src/editor/blocks/time-root.ts` - 4 defaultSource definitions

**Total blocks with defaultSource**: ~20 blocks (out of ~50 total blocks)
**Completion**: ~40% of block definitions migrated

**Example (GridDomain):**
```typescript
inputs: [
  input('rows', 'Rows', 'Scalar:number', {
    tier: 'primary',
    defaultSource: {
      value: 10,
      world: 'scalar',
      uiHint: { kind: 'slider', min: 1, max: 100, step: 1 },
    },
  }),
  // ... more inputs
],
// TODO: Remove paramSchema after compiler updated (Phase 4)
paramSchema: [ /* ... dual mode support ... */ ],
```

**Key Finding**: Block definitions are using DUAL MODE - both defaultSource AND paramSchema coexist for backward compatibility.

#### Block Compilers (Phase 4: NOT STARTED)

**Total block compiler files**: 36 implementation files
- Domain compilers: 23 files
- Signal compilers: 8 files
- Rhythm compilers: 2 files
- Test files: 3 files
- Helper files: 2 files

**All 36 compilers still use `params` access:**
```typescript
// Example: src/editor/compiler/blocks/domain/GridDomain.ts:27-31
const rows = Math.max(1, Math.floor(Number(params.rows ?? 10)));
const cols = Math.max(1, Math.floor(Number(params.cols ?? 10)));
const spacing = Number(params.spacing ?? 20);
const originX = Number(params.originX ?? 100);
const originY = Number(params.originY ?? 100);
```

**Params access count**: 80 total `params.` references across 28 compiler files
- Most common pattern: `Number(params.key ?? defaultValue)`
- Range: 1-8 params per block compiler
- Average: ~3 params per block

**BlockCompiler interface signature** (src/editor/compiler/types.ts:411-416):
```typescript
compile(args: {
  id: BlockId;
  params: Record<string, unknown>;  // ‚¨ÖÔ∏è REMOVE IN PHASE 4
  inputs: Record<string, Artifact>;
  ctx: CompileCtx;
}): CompiledOutputs;
```

---

## 2. What's Missing ‚ùå

### Critical Missing Pieces

#### 2.1 Default Source Resolution Logic (NEW CODE REQUIRED)
**Location**: `src/editor/compiler/compileBusAware.ts:364-415` (current input resolution)

**Current logic**: Wire ‚Üí Bus ‚Üí Error (if required)
**Target logic**: Wire ‚Üí Bus ‚Üí **Default Source** ‚Üí Error

**Missing implementation:**
```typescript
// NEW: Resolve default source from slot metadata
function resolveDefaultSource(
  slot: Slot,
  ctx: CompileCtx
): Artifact | null {
  if (!slot.defaultSource) return null;

  // Convert defaultSource.value to typed Artifact based on world + SlotType
  return createConstantArtifact(
    slot.defaultSource.value,
    slot.type,
    slot.defaultSource.world,
    ctx
  );
}
```

#### 2.2 World-Specific Constant Artifact Constructors (NEW CODE REQUIRED)

**Missing functions** (to be created):
```typescript
// Signal world: (t, ctx) => constant
function createConstantSignal<T>(value: T): Artifact {
  return {
    kind: 'Signal:T',
    value: (t: number, ctx: RuntimeCtx) => value
  };
}

// Field world: (seed, n, ctx) => Array(n).fill(constant)
function createConstantField<T>(value: T): Artifact {
  return {
    kind: 'Field:T',
    value: (seed: number, n: number, ctx: CompileCtx) => Array(n).fill(value)
  };
}

// Scalar world: direct value passthrough
function createScalarValue<T>(value: T): Artifact {
  return { kind: 'Scalar:T', value };
}

// Config world: direct value + hot-swap trigger metadata
function createConfigValue<T>(value: T): Artifact {
  return { kind: 'Config:T', value, triggersTopologyChange: true };
}
```

#### 2.3 Migration Helpers (PARTIALLY EXISTS - needs completion)

**Exists in Phase 1 plan** (src/editor/migration/paramToSlot.ts - NOT IMPLEMENTED YET):
- `deriveDefaultSource()` - Convert ParamSchema ‚Üí DefaultSource
- `deriveSlotWorld()` - Heuristic for world classification
- `migrateBlockDefinition()` - Auto-migrate block definitions

**Status**: Documented in PLAN-2025-12-21-132956.md but not implemented.

**Gap**: No automated tooling exists yet to help migrate the remaining 28 block compilers.

#### 2.4 BlockCompiler Interface Update

**Current signature has `params`:**
```typescript
compile(args: { id, params, inputs, ctx }): CompiledOutputs;
```

**Target signature removes `params`:**
```typescript
compile(args: { id, inputs, ctx }): CompiledOutputs;
//              ^^^^^ params removed, defaults come from inputs
```

**Dual-mode transition strategy needed:**
1. Add optional `params?: Record<string, unknown>` (deprecated)
2. All compilers migrate to use inputs only
3. Remove params field entirely

---

## 3. What Needs Changes üîß

### 3.1 Block Compilers (36 files, mechanical refactor)

**Migration pattern for each block:**

**BEFORE:**
```typescript
compile({ params, inputs, ctx }) {
  const amplitude = Number(params.amplitude ?? 1);
  const bias = Number(params.bias ?? 0);
  const shape = String(params.shape ?? 'sine');

  const phaseSignal = inputs.phase.value;
  // ... use amplitude, bias, shape
}
```

**AFTER:**
```typescript
compile({ inputs, ctx }) {
  const amplitude = inputs.amplitude?.value ?? 1;  // From default source
  const bias = inputs.bias?.value ?? 0;            // From default source
  const shape = inputs.shape?.value ?? 'sine';     // From default source

  const phaseSignal = inputs.phase.value;
  // ... same logic
}
```

**Key Changes:**
1. Remove `params` destructuring
2. Read default values from `inputs.paramName.value` instead of `params.paramName`
3. Fallback values should match `slot.defaultSource.value`
4. NO LOGIC CHANGES - pure mechanical refactor

**Affected files** (28 block compilers with params usage):
- Domain: GridDomain, PositionMapGrid, PositionMapCircle, PositionMapLine, etc. (23 files)
- Signal: Oscillator, ColorLFO, ClampSignal, Shaper (8 files)
- Rhythm: EnvelopeAD, PulseDivider (2 files)
- Others: FieldMapNumber, FieldMapVec2, etc.

### 3.2 Compiler Input Resolution (1 file, core logic change)

**File**: `src/editor/compiler/compileBusAware.ts:364-415`

**Current flow:**
```typescript
for (const inputPort of compiler.inputs) {
  const wireConn = incoming.get(keyOf(blockId, inputPort.name))?.[0];
  if (wireConn) {
    inputs[inputPort.name] = artifacts.get(wireConn.from);
    continue;
  }

  const busListener = patch.listeners?.find(/* ... */);
  if (busListener) {
    inputs[inputPort.name] = resolveBusValue(/* ... */);
    continue;
  }

  // Currently: Error artifact if required
  if (inputPort.required) {
    inputs[inputPort.name] = { kind: 'Error', message: 'Unwired required input' };
  }
}
```

**New flow (add Default Source step):**
```typescript
for (const inputPort of compiler.inputs) {
  const wireConn = incoming.get(keyOf(blockId, inputPort.name))?.[0];
  if (wireConn) {
    inputs[inputPort.name] = artifacts.get(wireConn.from);
    continue;
  }

  const busListener = patch.listeners?.find(/* ... */);
  if (busListener) {
    inputs[inputPort.name] = resolveBusValue(/* ... */);
    continue;
  }

  // NEW: Try to resolve from Default Source
  const slot = block.inputs.find(s => s.id === inputPort.name);
  if (slot?.defaultSource) {
    inputs[inputPort.name] = resolveDefaultSource(slot, ctx);
    continue;
  }

  // Only error if no default source exists
  if (inputPort.required) {
    inputs[inputPort.name] = { kind: 'Error', message: 'No wire, bus, or default source' };
  }
}
```

### 3.3 TimeRoot TimeModel Inference (1 file, parameter access)

**File**: `src/editor/compiler/compile.ts` (TimeModel extraction)

**Current code** (likely reads `block.params.period` directly):
```typescript
function inferTimeModel(patch: CompilerPatch): TimeModel {
  const timeRootBlock = patch.blocks.find(b => isTimeRootBlock(b.type));
  if (!timeRootBlock) return defaultInfiniteModel;

  // PROBLEM: Reads params directly
  const period = Number(timeRootBlock.params.period ?? 3000);
  return { kind: 'cyclic', periodMs: period, phaseDomain: '0..1' };
}
```

**New approach** (read from compiled artifact or slot defaults):
```typescript
function inferTimeModel(patch: CompilerPatch, artifacts: Map<PortRef, Artifact>): TimeModel {
  const timeRootBlock = patch.blocks.find(b => isTimeRootBlock(b.type));
  if (!timeRootBlock) return defaultInfiniteModel;

  // Option A: Read from slot default
  const periodSlot = timeRootBlock.inputs.find(s => s.id === 'period');
  const period = Number(periodSlot?.defaultSource?.value ?? 3000);

  // Option B: TimeRoot compiler emits TimeModel metadata
  // (better long-term solution)
  const timeModelArtifact = artifacts.get({ blockId: timeRootBlock.id, slotId: 'timeModel' });
  return timeModelArtifact?.value ?? defaultInfiniteModel;
}
```

---

## 4. Dependencies and Risks ‚ö†Ô∏è

### 4.1 Prerequisites (Phases 1-3)

| Phase | Status | Blocker? | Notes |
|-------|--------|----------|-------|
| Phase 1: Type Definitions | ‚úÖ COMPLETE | No | Slot.defaultSource exists in types.ts |
| Phase 2: Block Definitions | üü° 40% DONE | **Yes** | Need remaining 30 blocks migrated |
| Phase 3: Inspector UI | ‚ùì UNKNOWN | **Maybe** | UI may still write to block.params |

**CRITICAL BLOCKER**: Phase 2 must complete first. Compiler migration depends on all blocks having `defaultSource` metadata.

**Action Required**: Check Phase 2 and Phase 3 status in their respective topic directories.

### 4.2 Risks

#### Risk 1: Incomplete Block Definition Migration (HIGH)
**Problem**: If Phase 2 is incomplete, compilers can't read defaultSource
**Impact**: Compilation errors, missing default values
**Mitigation**:
- Dual-mode support (read defaultSource first, fall back to params)
- Validation pass before Phase 4: "All blocks MUST have defaultSource"

#### Risk 2: World Misclassification (MEDIUM)
**Problem**: Incorrect SlotWorld assignment (e.g., 'scalar' should be 'signal')
**Impact**: Incorrect hot-swap behavior, potential performance issues
**Mitigation**:
- Manual review of all world assignments during Phase 2
- Runtime validation: "Config inputs trigger topology change"
- Test suite: "Changing param X triggers expected hot-swap mode"

#### Risk 3: Breaking Existing Patches (LOW)
**Problem**: Saved patches have block.params, but compiler expects defaultSource
**Impact**: Old patches won't load correctly
**Mitigation**:
- Dual-mode compiler (Phase 4 transition period)
- Patch migration on load: "Copy params to slot defaults"
- Version flag in Patch format: `version: 3` (post-params era)

#### Risk 4: TimeRoot Special Case (MEDIUM)
**Problem**: TimeModel inference currently reads params directly
**Impact**: Compiler may not know time topology without params
**Mitigation**:
- TimeRoot compilers emit TimeModel as artifact (architectural fix)
- Fallback: Read from slot defaults during transition

### 4.3 Unknown Dependencies

**Inspector UI state** (Phase 3 unknowns):
- Does Inspector edit `block.params` or `slot.defaultSource.value`?
- Are there UI components that assume params exist?
- Is there a transaction layer that needs updating?

**Patch serialization**:
- Do we serialize slot defaults in patches?
- Or do defaults come from BlockDefinition only?
- Migration strategy for existing saved patches?

**Hot-swap integration**:
- How does Config world integrate with existing hot-swap?
- Is there a change detection system that watches params?

---

## 5. Ambiguities and Open Questions ü§î

### Q1: Dual-Mode Transition Strategy
**Question**: How long should we support both params AND defaultSource?

**Options**:
- A) Big-bang cutover (remove params immediately after migration)
- B) Deprecation period (6 months dual support)
- C) Permanent dual support (backwards compatibility forever)

**Recommendation**: Option B - 1-2 release cycles of dual support
- Allows testing without breaking existing patches
- Clear migration path for users with custom blocks
- Can remove params cleanly after validation period

### Q2: Default Source Serialization
**Question**: Should `slot.defaultSource.value` be serialized in patch files?

**Current behavior**: Params ARE serialized in patches
**Target behavior**: ???

**Options**:
- A) Never serialize (defaults come from BlockDefinition only)
- B) Serialize overrides only (if user changed from block default)
- C) Always serialize (patch contains all parameter state)

**Impact**:
- Option A: Smaller patches, but changing BlockDefinition defaults breaks old patches
- Option B: Complex (need "dirty" flag tracking)
- Option C: Same as current params behavior (safest)

**Recommendation**: Defer to Phase 3 - Inspector team decides based on UX needs

### Q3: SlotWorld Derivation
**Question**: Should world be derived from SlotType, or explicit field?

**Current**: Explicit `world` field in DefaultSource
**Alternative**: Derive from SlotType string parsing

```typescript
// Current (explicit)
defaultSource: { value: 10, world: 'scalar', uiHint: {...} }

// Alternative (implicit)
defaultSource: { value: 10, uiHint: {...} }
// world derived from SlotType 'Scalar:number'
```

**Pros of explicit**: Clear, no ambiguity, easier to read
**Cons of explicit**: Redundant information, can get out of sync

**Recommendation**: Keep explicit for Phase 4, revisit in Phase 5 cleanup

### Q4: Required vs Optional Inputs
**Question**: Do required inputs need defaultSource?

**Current assumption**: All inputs (required or not) can have defaults
**Alternative**: Required inputs MUST have wire/bus, defaults only for optional

**Example conflict**:
```typescript
input('phase', 'Phase', 'Signal<phase>', {
  defaultSource: { value: 0.0, world: 'signal', uiHint: {...} },
  // But compiler marks this input as required: true
})
```

**Recommendation**:
- Required inputs CAN have defaults (makes UI easier)
- Compiler uses default if no wire/bus (no error)
- "Required" becomes deprecated concept

---

## 6. Migration Strategy (Recommended Approach)

### Step 1: Complete Phase 2 (Block Definitions) [BLOCKING]
**Effort**: 2-3 days
**Owner**: Phase 2 implementer
**Deliverable**: All 50 blocks have defaultSource in inputs

**Exit Criteria**:
- Zero blocks with undefined defaultSource on input slots
- All paramSchema marked with `// TODO: Remove after Phase 4`
- Dual-mode validation: `slot.defaultSource.value === paramSchema.defaultValue`

### Step 2: Implement Default Source Resolution [Core Change]
**Effort**: 4-6 hours
**Files**: `src/editor/compiler/compileBusAware.ts`, new `constantArtifacts.ts`

**Tasks**:
1. Create `resolveDefaultSource()` function
2. Create world-specific constant constructors
3. Update input resolution loop (add Default Source step)
4. Add validation: "Error if no wire/bus/default for input"

**Exit Criteria**:
- Compiler resolves constants from slot.defaultSource
- Tests pass: "Unconnected input uses default value"
- No behavior change for wired/bussed inputs

### Step 3: Migrate Block Compilers (Mechanical Refactor) [Large Surface]
**Effort**: 1-2 days (36 compilers √ó 15-30 min each)
**Approach**: Scripted migration with manual review

**Per-compiler checklist**:
- [ ] Remove `params` from compile() destructuring
- [ ] Change `params.key` to `inputs.key?.value`
- [ ] Verify fallback matches slot.defaultSource.value
- [ ] Remove inline defaults (trust slot defaults)
- [ ] Test: Block compiles, produces same output

**Validation**:
- Grep for remaining `params\.` in compiler files (should be zero)
- Diff check: Output artifacts unchanged for test patches
- Visual check: Animations render identically

### Step 4: Remove params from BlockCompiler Interface [Breaking Change]
**Effort**: 2 hours
**Files**: `src/editor/compiler/types.ts`, call sites

**Tasks**:
1. Remove `params` from BlockCompiler.compile() signature
2. Update all compile() call sites (compileBusAware.ts, compile.ts)
3. Remove params from test mock data

**Exit Criteria**:
- TypeScript compiles without errors
- All compilers use signature: `compile({ id, inputs, ctx })`

### Step 5: Dual-Mode Validation Period [Testing]
**Effort**: 1 week (in parallel with other work)
**Scope**: Use in production, collect feedback

**Checks**:
- Old patches still load (params migrated to defaults)
- New patches don't serialize params
- Inspector edits slot.defaultSource, not params
- Hot-swap behavior correct per world classification

**Exit Criteria**:
- Zero reports of missing parameters
- Zero compilation errors related to defaults
- Visual regression tests pass (screenshots match)

### Step 6: Remove paramSchema from Block Definitions [Cleanup]
**Effort**: 2-3 hours
**Scope**: Delete deprecated dual-mode support

**Tasks**:
1. Remove all `paramSchema` arrays from block definitions
2. Remove `defaultParams` field from BlockDefinition interface
3. Remove ParamSchema type definition
4. Update documentation

**Exit Criteria**:
- Grep for `paramSchema` returns zero results
- Grep for `defaultParams` returns zero results
- All tests pass

---

## 7. Test Coverage Requirements

### Unit Tests (NEW)
```typescript
describe('Default Source Resolution', () => {
  it('resolves Signal default when input unwired', () => {
    // Block with amplitude input, defaultSource = 1.0
    // No wire, no bus
    // Expect: inputs.amplitude = constant signal (t, ctx) => 1.0
  });

  it('resolves Field default when input unwired', () => {
    // Block with spacing input, defaultSource = 20
    // No wire, no bus
    // Expect: inputs.spacing = constant field (seed, n) => [20, 20, ...]
  });

  it('resolves Scalar default when input unwired', () => {
    // Block with rows input, defaultSource = 10
    // Expect: inputs.rows = { kind: 'Scalar:number', value: 10 }
  });

  it('prefers wire over default source', () => {
    // Input has wire connection AND defaultSource
    // Expect: Use wire artifact, ignore default
  });

  it('prefers bus over default source', () => {
    // Input has bus listener AND defaultSource
    // Expect: Use bus value, ignore default
  });
});
```

### Integration Tests (UPDATE EXISTING)
```typescript
describe('Block Compilers', () => {
  it('Oscillator: compiles with all inputs unconnected', () => {
    // No wires, rely on defaults
    // Expect: Sine wave, amplitude=1, bias=0
  });

  it('GridDomain: compiles with default params', () => {
    // No wires
    // Expect: 10√ó10 grid, spacing=20
  });
});
```

### Visual Regression Tests (CRITICAL)
```typescript
describe('Visual Output Unchanged', () => {
  it('breathing-dots.json renders identically', () => {
    // Load patch, compile, render frame
    // Compare screenshot with baseline
    // Expect: Pixel-perfect match
  });
});
```

---

## 8. Success Criteria (Definition of Done)

### Functional Requirements ‚úÖ
- [ ] All 36 block compilers migrated (zero `params.` references)
- [ ] BlockCompiler interface has no `params` field
- [ ] Compiler resolves defaults from slot.defaultSource
- [ ] Unconnected inputs use default values correctly
- [ ] Wire/Bus connections take precedence over defaults

### Code Quality ‚úÖ
- [ ] Zero TypeScript compilation errors
- [ ] Zero ESLint errors in compiler files
- [ ] All new functions have JSDoc comments
- [ ] Code review completed (2+ reviewers)

### Testing ‚úÖ
- [ ] All existing tests pass
- [ ] New unit tests for default resolution (10+ tests)
- [ ] Integration tests updated (all block compilers)
- [ ] Visual regression tests pass (5+ patches)

### Performance ‚úÖ
- [ ] No compilation time regression (< 5% slower)
- [ ] No runtime performance impact
- [ ] Memory usage unchanged

### Documentation ‚úÖ
- [ ] Phase 4 PLAN updated with actual results
- [ ] Migration guide for custom blocks (if any)
- [ ] Changelog entry: "BREAKING: params removed from BlockCompiler"

---

## 9. File Change Summary

### New Files
| File | Purpose |
|------|---------|
| `src/editor/compiler/constantArtifacts.ts` | World-specific constant artifact constructors |
| `src/editor/compiler/__tests__/defaultSources.test.ts` | Default source resolution tests |

### Modified Files (Core)
| File | Change Type | Lines Changed (Est.) |
|------|-------------|---------------------|
| `src/editor/compiler/compileBusAware.ts` | Modify | +30 (add default resolution) |
| `src/editor/compiler/types.ts` | Modify | -1 (remove params from interface) |
| `src/editor/compiler/compile.ts` | Modify | +10 (TimeModel inference) |

### Modified Files (Block Compilers - 36 files)
| Pattern | Count | Change |
|---------|-------|--------|
| `src/editor/compiler/blocks/domain/*.ts` | 23 | Replace `params.X` ‚Üí `inputs.X?.value` |
| `src/editor/compiler/blocks/signal/*.ts` | 8 | Replace `params.X` ‚Üí `inputs.X?.value` |
| `src/editor/compiler/blocks/rhythm/*.ts` | 2 | Replace `params.X` ‚Üí `inputs.X?.value` |

**Total LOC changed**: ~300-500 lines (mostly mechanical find/replace)

---

## 10. Recommendations

### Immediate Actions (Before Starting Phase 4)
1. ‚úÖ **Verify Phase 2 completion** - Check all blocks have defaultSource
2. ‚úÖ **Verify Phase 3 status** - Ensure Inspector doesn't write to params
3. ‚ö†Ô∏è **Create migration script** - Automate params ‚Üí inputs refactor
4. ‚ö†Ô∏è **Baseline visual tests** - Capture screenshots before migration

### During Migration
1. üîÑ **One compiler at a time** - Don't batch, test incrementally
2. üîÑ **Dual-mode validation** - Keep params as fallback initially
3. üîÑ **Continuous testing** - Run tests after each compiler migration

### Post-Migration
1. üìù **Monitor production** - Watch for parameter-related errors
2. üìù **Collect feedback** - Ask users about missing parameters
3. üìù **Plan Phase 5** - Cleanup paramSchema after validation period

---

## 11. Next Steps

**Blocking on Phase 2**: ‚ö†Ô∏è Cannot start Phase 4 until block definitions complete

**Once unblocked:**
1. Review this STATUS with team (1 hour meeting)
2. Create migration script for block compilers (2-3 hours)
3. Implement default source resolution (4-6 hours)
4. Begin incremental compiler migration (1-2 days)
5. Remove params from interface (2 hours)
6. Validation period (1 week)
7. Cleanup (Phase 5)

**Estimated Total Time**: 3-5 days of focused work + 1 week validation

---

## Appendix A: Block Compiler Inventory

### Blocks WITH defaultSource (20 blocks, ~40%)
- DomainN, GridDomain, SVGSampleDomain (domain)
- FieldConstNumber, FieldConstColor, FieldMapNumber, FieldMapVec2 (fields)
- Oscillator, ColorLFO, ClampSignal, Shaper (signal)
- EnvelopeAD, PulseDivider (rhythm)
- FiniteTimeRoot (time)

### Blocks WITHOUT defaultSource (30 blocks, ~60%)
- PositionMapGrid, PositionMapCircle, PositionMapLine (domain)
- FieldOpacity, FieldReduce, FieldHash01ById, StableIdHash (fields)
- MulSignal, AddSignal, MaxSignal, MinSignal (signal)
- RenderInstances2D, TriggerOnWrap, ViewportInfo (domain)
- JitterFieldVec2, FieldZipNumber, FieldZipSignal, FieldAddVec2 (fields)
- FieldColorize, FieldFromSignalBroadcast (fields)
- PhaseClock, PhaseClockLegacy (time)
- Others (see full list in compiler/blocks/)

---

## Appendix B: Reused Knowledge (Eval Cache)

**From eval-cache/time-architecture.md** (RECENT, 9 hours ago):
- TimeModel is authoritative, player doesn't define topology
- No wrapping at player level, time is monotonic
- TimeRoot blocks auto-publish to canonical buses

**From eval-cache/layout-architecture.md** (RECENT, 9 hours ago):
- Dual-mode support pattern used elsewhere in codebase
- Feature flags for incremental rollouts
- Block-by-block migration strategy preferred

**From recent commits** (last 2 weeks):
- ea91562: busSemantics module created (canonical publisher ordering)
- 24ba70d: Editor improvements (may include Phase 2/3 work)
- f4097fe: requireTimeRoot flag exists (validation infrastructure)

---

**END OF STATUS REPORT**
