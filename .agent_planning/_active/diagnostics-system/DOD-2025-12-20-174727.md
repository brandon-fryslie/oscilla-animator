# Definition of Done: Diagnostics System Implementation (REVISED)

**Generated:** 2025-12-20-174727
**Plan:** PLAN-2025-12-20-174727.md
**Source Design Doc:** design-docs/4-Event-System/3.5-Events-and-Payloads-Schema.md

---

## Sprint Scope

This sprint delivers:
1. **Core diagnostic types** (Diagnostic, TargetRef, DiagnosticCode, Severity, Domain)
2. **5 minimal lifecycle events** (GraphCommitted, CompileStarted, CompileFinished, ProgramSwapped, RuntimeHealthSnapshot)
3. **DiagnosticHub** with snapshot-based state management
4. **Compiler integration** with diagnostic emission
5. **PatchStore integration** with patchRevision tracking and GraphCommitted emission

Deferred to future sprints:
- RuntimeHealthSnapshot implementation (if complex)
- FixAction execution system
- Diagnostic console UI
- Advanced polish (semantic addressing, grouping)

---

## Acceptance Criteria

### P0.1 - Core Diagnostic Types

- [ ] `Diagnostic` type defined with fields: code, severity, domain, primaryTarget, affectedTargets, message, payload, metadata
- [ ] `TargetRef` union type defined with variants: block, port, bus, binding, timeRoot, graphSpan
- [ ] `DiagnosticCode` enum defined with at least 5 codes: E_TIME_ROOT_MISSING, E_TIME_ROOT_MULTIPLE, E_TYPE_MISMATCH, W_BUS_EMPTY, W_GRAPH_UNUSED_OUTPUT
- [ ] `Severity` enum defined: hint, info, warn, error, fatal
- [ ] `Domain` enum defined: authoring, compile, runtime, perf
- [ ] All types exported from `src/editor/diagnostics/types.ts`

### P0.2 - GraphCommitted Event Type

- [ ] `GraphCommitted` event type defined with payload: patchId, patchRevision, reason, diffSummary, affectedBlockIds, affectedBusIds
- [ ] `reason` enum defined: userEdit, macroExpand, compositeSave, migration, import, undo, redo
- [ ] `diffSummary` type defined with counts: blocksAdded, blocksRemoved, busesAdded, busesRemoved, bindingsChanged, timeRootChanged
- [ ] Event type added to `EditorEvent` union in `src/editor/events/types.ts`
- [ ] 8 deprecated event types marked for removal (BlockAdded, BlockRemoved, WireAdded, WireRemoved, BindingAdded, BindingRemoved, BusCreated, BusDeleted)

### P0.3 - Compile Lifecycle Event Types

- [ ] `CompileStarted` event type defined with payload: compileId (UUID), patchId, patchRevision, trigger (graphCommitted|manual|startup|hotReload)
- [ ] `CompileFinished` event type defined with payload: compileId, patchId, patchRevision, status (ok|failed), durationMs, diagnostics (Diagnostic[]), programMeta (optional)
- [ ] `programMeta` type defined with fields: timelineHint, timeRootKind, busUsageSummary (optional)
- [ ] Both event types added to `EditorEvent` union
- [ ] Deprecated events marked for removal: CompileSucceeded, CompileFailed

### P0.4 - patchRevision Counter in PatchStore

- [ ] `patchRevision` observable property added to PatchStore (initialized to 0)
- [ ] `incrementRevision()` private method added to PatchStore
- [ ] All graph mutation methods (addBlock, removeBlock, addConnection, etc.) call incrementRevision()
- [ ] patchRevision is included in GraphCommitted event payload
- [ ] Unit test: patchRevision increments on addBlock, removeBlock, addConnection, removeConnection

### P0.5 - GraphCommitted Emission in PatchStore

- [ ] `emitGraphCommitted()` method added to PatchStore
- [ ] Method computes diffSummary (blocksAdded/Removed, busesAdded/Removed, bindingsChanged, timeRootChanged)
- [ ] Method tracks affectedBlockIds and affectedBusIds (best effort)
- [ ] All graph mutation methods call emitGraphCommitted() after successful mutation
- [ ] Unit test: GraphCommitted emitted on addBlock with correct diffSummary
- [ ] Unit test: GraphCommitted includes affectedBlockIds after removeBlock

### P0.6 - DiagnosticHub with Snapshot Semantics

- [ ] DiagnosticHub class defined in `src/editor/diagnostics/DiagnosticHub.ts`
- [ ] Subscribes to GraphCommitted: runs authoring validators, updates authoring snapshot
- [ ] Subscribes to CompileStarted: marks compile diagnostics "pending"
- [ ] Subscribes to CompileFinished: replaces compile snapshot with event payload diagnostics
- [ ] Implements stable ID generation: `hash(code + primaryTarget + signature)`
- [ ] Namespace separation: compile snapshot (keyed by patchRevision), authoring snapshot, runtime rolling window
- [ ] Query method: `getAll(filters?: { domain?, severity?, patchRevision? }): Diagnostic[]`
- [ ] Query method: `getByRevision(patchRevision: number): Diagnostic[]`
- [ ] Query method: `getActive(): Diagnostic[]` (diagnostics for current active revision)
- [ ] Unit test: CompileFinished replaces compile snapshot completely
- [ ] Unit test: Stable ID deduplication works across snapshots
- [ ] Unit test: getActive() returns diagnostics for active revision only

### P0.7 - DiagnosticStore (MobX Wrapper)

- [ ] DiagnosticStore class defined in `src/editor/stores/DiagnosticStore.ts`
- [ ] Receives DiagnosticHub instance in constructor
- [ ] Computed property: `activeDiagnostics: Diagnostic[]` (calls hub.getActive())
- [ ] Computed property: `errorCount: number` (count of severity=error diagnostics)
- [ ] Computed property: `warningCount: number` (count of severity=warn diagnostics)
- [ ] Integrated into RootStore: `this.diagnosticStore = new DiagnosticStore(hub)`
- [ ] Unit test: activeDiagnostics reacts to CompileFinished events

### P0.8 - Compiler Diagnostic Emission

- [ ] Compiler emits `CompileStarted` at beginning of `compilePatch()`
- [ ] Compiler builds diagnostics array during compilation (replaces logStore calls)
- [ ] Compiler emits `CompileFinished` with diagnostics snapshot (regardless of success/failure)
- [ ] Emit at least 3 diagnostic codes: E_TIME_ROOT_MISSING, E_TIME_ROOT_MULTIPLE, E_TYPE_MISMATCH
- [ ] CompileFinished includes programMeta (timelineHint, timeRootKind) on success
- [ ] Unit test: Missing TimeRoot produces E_TIME_ROOT_MISSING diagnostic
- [ ] Unit test: Type mismatch produces E_TYPE_MISMATCH diagnostic
- [ ] Unit test: CompileFinished event includes diagnostics array

### P1.1 - Bus-Related Diagnostic Codes

- [ ] Compiler emits `W_BUS_EMPTY` for buses with 0 listeners
- [ ] Compiler emits `W_GRAPH_UNUSED_OUTPUT` for block outputs not connected and not published to bus
- [ ] Both diagnostics include affectedTargets (bus/block references)
- [ ] Unit test: Empty bus produces W_BUS_EMPTY warning
- [ ] Unit test: Unused output produces W_GRAPH_UNUSED_OUTPUT warning

### P1.2 - Authoring Validators (Fast)

- [ ] Validator: Check for missing TimeRoot (authoring diagnostic)
- [ ] Validator: Check for disconnected blocks (island detection)
- [ ] Authoring diagnostics stored in separate namespace from compile diagnostics
- [ ] Authoring diagnostics cleared/recomputed on each GraphCommitted
- [ ] Unit test: Missing TimeRoot detected immediately on GraphCommitted
- [ ] Unit test: Disconnected block detected immediately on GraphCommitted

### P1.3 - Unit Tests for Event Refactoring

- [ ] Test: GraphCommitted payload includes patchRevision, reason, diffSummary
- [ ] Test: GraphCommitted emitted after addBlock, removeBlock, addConnection, removeConnection
- [ ] Test: CompileStarted payload includes compileId, patchRevision, trigger
- [ ] Test: CompileFinished payload includes diagnostics array (success and failure cases)
- [ ] Test: CompileFinished.status is 'ok' on success, 'failed' on failure
- [ ] Test: patchRevision increments monotonically

### P2.1 - ProgramSwapped and RuntimeHealthSnapshot Events (DEFERRED DECISION)

**Note:** Implement only if straightforward; otherwise defer to Phase 2.

- [ ] `ProgramSwapped` event type defined with payload: patchRevision, compileId, swapMode, swapLatencyMs
- [ ] Player emits ProgramSwapped when activating new program
- [ ] DiagnosticHub subscribes to ProgramSwapped: sets active revision pointer
- [ ] `RuntimeHealthSnapshot` event type defined with payload: frameBudget, evalStats, nanCount, infCount, fieldMaterializations, diagnosticsDelta
- [ ] Player emits RuntimeHealthSnapshot at 2-5Hz (throttled)
- [ ] DiagnosticHub subscribes to RuntimeHealthSnapshot: updates runtime diagnostics (dedupe/expire)
- [ ] Unit test: ProgramSwapped updates active revision in DiagnosticHub
- [ ] Unit test: RuntimeHealthSnapshot updates runtime diagnostics

---

## Integration Validation

### End-to-End Flow 1: Compile Error Diagnostics
- [ ] User creates patch without TimeRoot
- [ ] GraphCommitted event emitted (authoring validator may flag this)
- [ ] Compiler emits CompileStarted
- [ ] Compiler emits CompileFinished with E_TIME_ROOT_MISSING diagnostic
- [ ] DiagnosticHub receives CompileFinished, replaces compile snapshot
- [ ] DiagnosticStore.activeDiagnostics includes E_TIME_ROOT_MISSING
- [ ] DiagnosticStore.errorCount is 1

### End-to-End Flow 2: Type Mismatch Diagnostic
- [ ] User creates patch with Signal<number> -> Signal<color> connection
- [ ] GraphCommitted event emitted
- [ ] Compiler emits CompileStarted
- [ ] Compiler emits CompileFinished with E_TYPE_MISMATCH diagnostic
- [ ] Diagnostic includes primaryTarget (invalid connection) and affectedTargets (both blocks)
- [ ] DiagnosticStore.activeDiagnostics includes E_TYPE_MISMATCH

### End-to-End Flow 3: Empty Bus Warning
- [ ] User creates bus with 1 publisher, 0 listeners
- [ ] Compiler emits CompileFinished with W_BUS_EMPTY diagnostic
- [ ] Diagnostic includes primaryTarget (bus) and affectedTargets (publisher block)
- [ ] DiagnosticStore.warningCount is 1

### End-to-End Flow 4: Authoring Validator
- [ ] User removes TimeRoot block
- [ ] GraphCommitted event emitted
- [ ] DiagnosticHub authoring validator detects missing TimeRoot
- [ ] DiagnosticStore.activeDiagnostics includes authoring diagnostic
- [ ] User adds TimeRoot block
- [ ] GraphCommitted event emitted
- [ ] DiagnosticHub authoring validator clears missing TimeRoot diagnostic

---

## Performance Requirements

- [ ] Authoring validators complete in < 10ms for patches with < 100 blocks
- [ ] CompileFinished event payload size < 100KB for patches with < 50 diagnostics
- [ ] DiagnosticHub query methods (getAll, getByRevision) complete in < 5ms
- [ ] GraphCommitted diffSummary computation does not block UI (< 16ms)

---

## Code Quality Requirements

- [ ] All new files have TypeScript strict mode enabled
- [ ] All public methods have JSDoc comments
- [ ] All event payloads use readonly arrays/objects where appropriate
- [ ] No `any` types (use `unknown` and type guards)
- [ ] All DiagnosticCode values have descriptive names (E_*, W_*, P_* prefixes)

---

## Test Coverage Requirements

- [ ] DiagnosticHub unit tests: 100% coverage of snapshot semantics
- [ ] DiagnosticStore unit tests: 100% coverage of computed properties
- [ ] PatchStore GraphCommitted emission: 100% coverage of mutation methods
- [ ] Compiler diagnostic emission: 100% coverage of diagnostic codes (5 codes minimum)
- [ ] Event payload validation: 100% coverage of required fields

---

## Documentation Requirements

- [ ] DiagnosticHub class has JSDoc with usage examples
- [ ] Event payload types have JSDoc describing field semantics
- [ ] DiagnosticCode enum values have JSDoc describing when they're emitted
- [ ] README section added explaining diagnostic system architecture (snapshot semantics)

---

## Deprecation Requirements

- [ ] 8 deprecated events marked with `@deprecated` JSDoc tag
- [ ] 2 deprecated events marked with `@deprecated` JSDoc tag (CompileSucceeded, CompileFailed)
- [ ] LogStore diagnostic usage audited and migration plan documented
- [ ] No new code uses deprecated events

---

## Sprint Success Criteria

**This sprint is COMPLETE when:**

1. All P0 items (P0.1-P0.8) have 100% acceptance criteria met
2. All P1 items (P1.1-P1.3) have 100% acceptance criteria met
3. All 4 end-to-end flows pass integration validation
4. All performance requirements are met
5. Test coverage requirements are met
6. `just check` passes (typecheck + lint + test)

**Nice to Have (P2):**
- ProgramSwapped and RuntimeHealthSnapshot events implemented (if straightforward)

---

**Definition of Done Status:** Ready for implementation validation
