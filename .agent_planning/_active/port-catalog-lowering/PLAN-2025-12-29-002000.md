# Sprint Plan: Port Catalog + Lowering Migration
Generated: 2025-12-29-002000
Source: STATUS-2025-12-29-001500.md
Plan Reference: design-docs/_needs-review/Plan-Port-Catalog-Lowering-Migration.md

---

## Executive Summary

**Current State**: ~50% infrastructure complete, 4 blocks migrated, 3 critical type errors blocking compilation
**Sprint Goal**: Complete infrastructure (Steps 2-4), fix blockers, fully migrate 4 reference blocks
**Out of Scope**: Migrating remaining 53 blocks (future work)

**Critical Path**: Fix type errors â†’ Implement outputsById â†’ Complete reference blocks â†’ Flip strict-by-default

---

## P0 (Critical) - Blockers Must Be Fixed First

### P0-1: Fix TypeDomain Missing Values

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None
**Spec Reference**: TypeDesc.ts type system â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Critical Blockers #2

#### Description
TypeScript compilation fails because `'waveform'` domain is used in Oscillator port catalog but not defined in `InternalDomain` union. The type system needs this domain to support scalar waveform selection (sine, cosine, triangle, saw).

**Root Cause**: `src/editor/ir/types/TypeDesc.ts:64-88` defines `InternalDomain` but omits `'waveform'`. Meanwhile, `src/editor/ir/types/typeConversion.ts:273-276` attempts to map `'waveform'` and `'Waveform'` to domain values, and `src/editor/blocks/portCatalog.ts:38` uses `domain: 'waveform'` in OSCILLATOR_PORTS.

**Why This Matters**: Blocks entire test suite from running. Cannot verify any migration work until this is fixed.

#### Acceptance Criteria
- [ ] Add `'waveform'` to `InternalDomain` union in `src/editor/ir/types/TypeDesc.ts`
- [ ] Add `'waveform'` to `INTERNAL_DOMAINS` set in same file
- [ ] Verify `just typecheck` passes with zero TypeScript errors
- [ ] Verify `just test` runs (tests may fail, but compilation must succeed)
- [ ] Document in TypeDesc.ts what waveform domain represents (e.g., "Waveform shape selection for oscillators")

#### Technical Notes
- `'expression'` domain mentioned in STATUS is likely not needed (grep shows it's only in commented/legacy code)
- Focus on `'waveform'` only - that's the actual blocker
- Update `INTERNAL_DOMAINS` set at line ~138 to include `'waveform'`

---

### P0-2: Fix PortSpec Optional Property Access

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None
**Spec Reference**: oscillatorSpec.ts port catalog mapping â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Critical Blockers #1

#### Description
TypeScript error at `oscillatorSpec.ts:38` where code accesses `spec.optional` but `PortSpec` type doesn't guarantee this property exists on all port specs. The code maps port catalog to IR port declarations and needs safe optional property access.

**Root Cause**: Line 38 uses spread operator `...(spec.optional ? { optional: true } : {})` but TypeScript doesn't know `spec.optional` exists.

#### Acceptance Criteria
- [ ] Fix `oscillatorSpec.ts:38` to safely access `optional` property using optional chaining or type guard
- [ ] Apply same fix to line 39 for `defaultSource` property access if needed
- [ ] Verify `just typecheck` passes with zero TypeScript errors in oscillatorSpec.ts
- [ ] No runtime behavior change (output IR port declarations must match exactly)
- [ ] Pattern is safe for reuse in future port catalog implementations

#### Technical Notes
Recommended fix:
```typescript
...(spec.optional === true ? { optional: true } : {}),
```
Or if PortSpec type guarantees these properties exist, add them to the interface definition instead.

---

### P0-3: Implement outputsById Infrastructure

**Status**: Not Started
**Effort**: Medium (3-5 hours)
**Dependencies**: P0-1, P0-2 (must compile first)
**Spec Reference**: Plan Step 4 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 4

#### Description
Add `outputsById` support to match existing `inputsById` infrastructure. This completes the keyed port API, allowing blocks to return outputs by port ID instead of positional array. Pass 6 should accept both patterns during migration.

**Current State**:
- `inputsById` fully implemented and working in 4 blocks
- `outputsById` completely missing from `LowerResult` interface
- All blocks return positional `outputs: [...]` array

**Why This Matters**: Without this, reference blocks can't complete migration and we'll need to touch them again later.

#### Acceptance Criteria
- [ ] Add `outputsById?: Readonly<Record<string, ValueRefPacked>>` to `LowerResult` interface in `src/editor/compiler/ir/lowerTypes.ts:159-165`
- [ ] Update `src/editor/compiler/passes/pass6-block-lowering.ts` to check for `result.outputsById` when mapping outputs
- [ ] If `outputsById` present and non-empty, use it to build outputs array in port order from block port declarations
- [ ] If `outputsById` absent or empty, fall back to existing positional `result.outputs` behavior
- [ ] Add test in `signal-math.test.ts` verifying block can return `outputsById` and Pass 6 maps it correctly
- [ ] Both patterns work: blocks can return only `outputs`, only `outputsById`, or both (outputsById wins)

#### Technical Notes
Implementation location: `pass6-block-lowering.ts:348` (after lowering function call)

Mapping logic:
```typescript
// After const result = blockType.lower({ ctx, inputs, inputsById });

let outputs: ValueRefPacked[];
if (result.outputsById && Object.keys(result.outputsById).length > 0) {
  // Build outputs array from outputsById using port order
  const portOrder = blockDef.outputs.map(p => p.id);
  outputs = portOrder.map(portId => {
    const ref = result.outputsById![portId];
    if (!ref) {
      throw new IRValidationFailed(
        `Block ${ctx.blockType}#${ctx.instanceId} outputsById missing port '${portId}'`
      );
    }
    return ref;
  });
} else {
  // Legacy positional path
  outputs = [...result.outputs];
}
```

Port order source: Same as `inputsById` construction - use block definition's output port order.

---

## P1 (High) - Complete Infrastructure Before Further Migration

### P1-1: Implement definePortCatalog Helper

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0-1, P0-2 (must compile)
**Spec Reference**: Plan Step 2 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 2

#### Description
Create typed helper function that enforces port catalog contract at compile-time. Prevents drift between `inputs`/`outputs` objects and their corresponding `*Order` arrays by making TypeScript verify key consistency.

**Current State**: `OSCILLATOR_PORTS` uses inline `as const satisfies` pattern. No helper function exists. Manual port definitions can drift (order array has port not in object, or vice versa).

**Why This Matters**: As we scale to 57 blocks, manual catalog definitions will create maintenance burden and drift bugs.

#### Acceptance Criteria
- [ ] Create `definePortCatalog<const Inputs, const Outputs>(...)` helper in `src/editor/blocks/portCatalog.ts`
- [ ] Helper enforces `inputOrder` keys exactly match keys of `inputs` object (compile-time TypeScript error if mismatch)
- [ ] Helper enforces `outputOrder` keys exactly match keys of `outputs` object
- [ ] Helper returns properly typed catalog object with full const inference
- [ ] Migrate `OSCILLATOR_PORTS` to use helper: `export const OSCILLATOR_PORTS = definePortCatalog({ ... })`
- [ ] TypeScript compilation succeeds, runtime behavior unchanged
- [ ] Add JSDoc comment explaining helper's purpose and constraint enforcement

#### Technical Notes
Reference signature from Plan Step 2:
```typescript
export function definePortCatalog<
  const Inputs extends Record<string, PortSpec>,
  const Outputs extends Record<string, PortSpec>
>(catalog: {
  inputs: Inputs;
  inputOrder: readonly (keyof Inputs)[];
  outputs: Outputs;
  outputOrder: readonly (keyof Outputs)[];
}) {
  return catalog;
}
```

TypeScript will enforce that `inputOrder` and `outputOrder` only contain keys present in their respective objects. No runtime validation needed - this is a compile-time guard.

---

### P1-2: Complete Reference Block Migration to outputsById

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0-3 (outputsById infrastructure must exist)
**Spec Reference**: Plan Step 5 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 5

#### Description
Update the 4 reference blocks to use `outputsById` instead of positional `outputs` array. These blocks already use `inputsById` fallback pattern. Completing the migration makes them canonical examples for future work.

**Blocks to Update**:
- `src/editor/compiler/blocks/signal/Oscillator.ts`
- `src/editor/compiler/blocks/signal/AddSignal.ts`
- `src/editor/compiler/blocks/signal/MulSignal.ts`
- `src/editor/compiler/blocks/signal/SubSignal.ts`

**Current State**: All 4 blocks return `outputs: [{ k: 'sig', id: sigId, slot }]` (positional)

#### Acceptance Criteria
- [ ] Oscillator returns `{ outputs: [], outputsById: { out: { k: 'sig', id, slot } } }`
- [ ] AddSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] MulSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] SubSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] All 4 blocks use empty `outputs: []` to signal full migration (per Plan Step 5 example)
- [ ] `just test` passes - signal-math.test.ts and all other tests succeed
- [ ] IR output structure unchanged (Pass 6 maps outputsById to same positional array)

#### Technical Notes
Each block has single output port with ID `'out'`. Transformation is straightforward:

Before:
```typescript
return { outputs: [{ k: 'sig', id: sigId, slot }] };
```

After:
```typescript
return {
  outputs: [],  // Legacy - empty for fully migrated blocks
  outputsById: { out: { k: 'sig', id: sigId, slot } }
};
```

Port ID comes from block port definitions. For math blocks this is `'out'`, for Oscillator check OSCILLATOR_PORTS.outputOrder.

---

### P1-3: Flip Strict-by-Default Enforcement

**Status**: Not Started
**Effort**: Medium (4-5 hours - includes audit)
**Dependencies**: P0-1, P0-2, P1-2 (blocks must compile and reference blocks must be complete)
**Spec Reference**: Plan Step 3 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 3, Ambiguity #4

#### Description
Change port contract enforcement from opt-in (`=== 'strict'`) to opt-out (`!== 'relaxed'`). This makes validation the default, catching port order mismatches early. **Must audit all 57 block definitions first** to identify and fix any existing mismatches before flipping the default.

**Current Behavior**: Only Oscillator validates (1 of 57 blocks)
**After Fix**: All 57 blocks validate by default
**Risk**: Silent rollout may break compilation if any block has port order mismatch

#### Acceptance Criteria
- [ ] **AUDIT FIRST**: Check all 57 block port definitions against their lowering implementations for port order mismatches
- [ ] Document any mismatches found in audit (create list in this plan or separate file)
- [ ] Fix all mismatches OR add `tags: { irPortContract: 'relaxed' }` to blocks with valid reasons for mismatch
- [ ] Change `src/editor/compiler/passes/pass6-block-lowering.ts:256` from `=== 'strict'` to `!== 'relaxed'`
- [ ] Verify `just test` passes with all tests succeeding
- [ ] Verify error messages include block type, ID, and specific port mismatch details (already implemented)
- [ ] Zero blocks should fail validation (all either match or are tagged relaxed)

#### Technical Notes
**Audit Process**:
1. For each block in `src/editor/compiler/blocks/**/*.ts`:
   - Read block definition's input/output port order
   - Read lowering function's `inputsById` access patterns (which ports does it reference?)
   - Check if any `inputs[n]` positional access assumes wrong index
   - Verify output order matches block definition

2. Document findings - likely categories:
   - âœ… Clean (most blocks, pure positional or already using inputsById correctly)
   - âš ï¸ Mismatch (positional index doesn't match port definition order)
   - ðŸ” Complex (blocks with dynamic port behavior, may need 'relaxed')

**Change Location**: `pass6-block-lowering.ts:256`
```typescript
// Current
const enforcePortContract = blockDef?.tags?.irPortContract === 'strict';

// Change to
const enforcePortContract = blockDef?.tags?.irPortContract !== 'relaxed';
```

**Recommendation from STATUS**: Follow Option C (Audit â†’ Fix â†’ Flip) to avoid breakage.

---

## P2 (Medium) - Testing and Polish

### P2-1: Add Port Catalog Tests

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P1-1 (definePortCatalog must exist)
**Spec Reference**: None (new) â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Missing Checks #1

#### Description
Create test suite verifying `definePortCatalog` helper enforces constraints at compile-time. Tests should verify TypeScript catches common mistakes.

**Why This Matters**: Ensures the helper actually prevents drift as intended.

#### Acceptance Criteria
- [ ] Create `src/editor/blocks/__tests__/portCatalog.test.ts`
- [ ] Test: Valid catalog with matching keys compiles and returns correct type
- [ ] Test: Catalog with extra key in `inputOrder` fails TypeScript compilation
- [ ] Test: Catalog with missing key in `inputOrder` fails TypeScript compilation
- [ ] Test: Same constraints verified for `outputOrder`
- [ ] All tests in suite pass with `just test`
- [ ] Tests use `// @ts-expect-error` comments to verify compile-time failures

#### Technical Notes
Tests will be compile-time checks. Example structure:
```typescript
import { definePortCatalog } from '../portCatalog';

describe('definePortCatalog', () => {
  it('accepts valid catalog', () => {
    const catalog = definePortCatalog({
      inputs: { a: { id: 'a', ... }, b: { id: 'b', ... } },
      inputOrder: ['a', 'b'],
      outputs: { out: { id: 'out', ... } },
      outputOrder: ['out']
    });
    expect(catalog.inputOrder).toEqual(['a', 'b']);
  });

  it('rejects inputOrder with extra key', () => {
    // @ts-expect-error - 'c' not in inputs
    definePortCatalog({
      inputs: { a: {...}, b: {...} },
      inputOrder: ['a', 'b', 'c'],  // TypeScript error expected
      outputs: { out: {...} },
      outputOrder: ['out']
    });
  });
});
```

---

### P2-2: Add Port Contract Enforcement Tests

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P1-3 (strict-by-default must be flipped)
**Spec Reference**: None (new) â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Missing Checks #2

#### Description
Create test suite verifying strict-by-default enforcement works correctly. Tests should verify Pass 6 catches port order mismatches and respects opt-out tag.

#### Acceptance Criteria
- [ ] Create `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts`
- [ ] Test: Block with correct port order compiles successfully
- [ ] Test: Block with mismatched input order throws `IRValidationFailed` with clear error message
- [ ] Test: Block with mismatched output order throws `IRValidationFailed` with clear error message
- [ ] Test: Block with `tags: { irPortContract: 'relaxed' }` skips validation and compiles
- [ ] Error messages include block type, instance ID, and specific mismatch details
- [ ] All tests pass with `just test`

#### Technical Notes
Test structure:
- Create minimal test blocks with intentional port order mismatches
- Invoke Pass 6 lowering
- Expect specific error messages
- Verify relaxed tag bypasses check

Reference existing validation error format from `pass6-block-lowering.ts`.

---

### P2-3: Update Existing Tests for outputsById

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P1-2 (blocks must return outputsById)
**Spec Reference**: Plan Step 6 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 6

#### Description
Update `signal-math.test.ts` to use `inputsById` when calling lowering functions and verify `outputsById` is returned where appropriate. Tests currently pass because fallback pattern works, but they should test the new API explicitly.

#### Acceptance Criteria
- [ ] Update `src/editor/compiler/__tests__/signal-math.test.ts` to pass `inputsById` when calling `lower()`
- [ ] Add test verifying blocks return `outputsById` with correct port IDs
- [ ] Add test verifying Pass 6 correctly maps `outputsById` to positional outputs array
- [ ] Tests verify both legacy (positional) and new (keyed) patterns work
- [ ] All tests pass with `just test`
- [ ] Test coverage includes: only outputs, only outputsById, both (outputsById wins)

#### Technical Notes
Current test pattern (positional):
```typescript
const inputs: ValueRefPacked[] = [
  { k: "sig", id: sigA, slot: slotA },
  { k: "sig", id: sigB, slot: slotB },
];
const result = AddSignal.lower({ ctx, inputs });
```

Updated pattern (keyed):
```typescript
const inputsById = { a: { k: "sig", id: sigA, slot: slotA }, ... };
const result = AddSignal.lower({ ctx, inputs: [], inputsById });
expect(result.outputsById).toEqual({ out: expect.objectContaining({ k: 'sig' }) });
```

Tests should verify legacy path still works (backward compatibility).

---

## P3 (Low) - Documentation and Future Work

### P3-1: Create Port Catalogs for Math Blocks

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P1-1 (definePortCatalog must exist)
**Spec Reference**: None (consistency) â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Technical Debt

#### Description
Extract inline port definitions from AddSignal, MulSignal, SubSignal into proper port catalogs using `definePortCatalog` helper. This brings consistency with Oscillator pattern and reduces duplication.

**Current State**: Math blocks define ports inline in block definitions. No separate port catalog.

**Why This Matters**: Consistency across codebase. Sets pattern for future blocks.

#### Acceptance Criteria
- [ ] Create `ADD_SIGNAL_PORTS`, `MUL_SIGNAL_PORTS`, `SUB_SIGNAL_PORTS` in `portCatalog.ts`
- [ ] Each catalog uses `definePortCatalog` helper
- [ ] Update math block definitions to reference catalogs (like Oscillator does)
- [ ] Create `*_IR_INPUTS` and `*_IR_OUTPUTS` mappings for each (like oscillatorSpec.ts pattern)
- [ ] `just typecheck` and `just test` pass, runtime behavior unchanged
- [ ] Code reduction: eliminate duplicate port definitions

#### Technical Notes
Math blocks all have similar structure:
- Inputs: `a: Signal<number>`, `b: Signal<number>`
- Outputs: `out: Signal<number>`

Can potentially share catalog structure or create three separate catalogs. Decision is implementer's choice based on maintainability.

---

### P3-2: Document Migration Pattern

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P1-2, P1-3, P3-1 (complete migration must exist)
**Spec Reference**: Plan Step 7 â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 7

#### Description
Update `Oscillator-Single-Source.md` documentation with complete migration example showing port catalog, strict contract, `inputsById`, and `outputsById` usage. This becomes the "how-to" guide for migrating remaining 53 blocks.

**Current State**: Doc not yet updated with migration pattern.

#### Acceptance Criteria
- [ ] Update `design-docs/_needs-review/Oscillator-Single-Source.md` with full migration example
- [ ] Document port catalog creation using `definePortCatalog` helper
- [ ] Document `inputsById` / `outputsById` usage in lowering functions
- [ ] Document strict-by-default contract and opt-out tag (`irPortContract: 'relaxed'`)
- [ ] Document legacy pattern (positional arrays) and migration path
- [ ] Include complete working example from one of the 4 reference blocks
- [ ] Document when to use `outputs: []` (empty) to signal full migration

#### Technical Notes
Doc structure should include:
1. Overview of port catalog architecture
2. Step-by-step migration guide
3. Code examples (before/after)
4. Common pitfalls and solutions
5. Reference to this plan for context

Audience: Future implementers migrating remaining 53 blocks.

---

### P3-3: DEFERRED - Migrate Remaining 53 Blocks

**Status**: Out of Scope for This Sprint
**Effort**: XL (2+ weeks)
**Dependencies**: All P1 and P2 tasks complete
**Spec Reference**: None (future work) â€¢ **Status Reference**: STATUS-2025-12-29-001500.md Â§ Step 1

#### Description
Apply established migration pattern to remaining 53 blocks across domain/, rhythm/, and signal/ directories. This work is explicitly DEFERRED to future sprints.

**Remaining Blocks** (~53 files):
- Domain blocks (~20 files)
- Rhythm blocks (~5 files)
- Other signal blocks (~28 files)

**Migration Pattern** (established by this sprint):
1. Create port catalog using `definePortCatalog`
2. Update lowering function to use `inputsById`
3. Return `outputsById` with `outputs: []`
4. Add `tags: { irPortContract: 'strict' }` (or rely on default)
5. Test compilation and runtime behavior

#### Why Deferred
This sprint focuses on completing infrastructure and proving the pattern with 4 reference blocks. Migrating 53 blocks is mechanical but time-consuming work better suited for a dedicated sprint once the pattern is proven stable.

#### Future Sprint Planning Notes
- Estimate: ~1-2 hours per block = 53-106 hours total
- Can parallelize by block category (domain, rhythm, signal)
- Should batch-migrate related blocks to identify common patterns
- Consider tooling/automation for boilerplate generation

---

## Dependency Graph

```
P0-1 (Fix TypeDomain) â”€â”€â”¬â”€â”€> P0-3 (outputsById) â”€â”€> P1-2 (Migrate Blocks) â”€â”€â”¬â”€â”€> P2-3 (Test Updates)
                        â”‚                                                    â”‚
P0-2 (Fix Optional) â”€â”€â”€â”€â”´â”€â”€> P1-1 (Helper) â”€â”€â”€â”€â”€â”€â”€â”€> P2-1 (Catalog Tests)   â”‚
                         â”‚                                                   â”‚
                         â””â”€â”€> P1-3 (Strict Default) â”€â”€> P2-2 (Contract Tests)
                                                                              â”‚
                                                                              â””â”€â”€> P3-1 (Math Catalogs)
                                                                                   â””â”€â”€> P3-2 (Docs)
                                                                                        â””â”€â”€> P3-3 (DEFERRED)
```

**Critical Path**: P0-1 â†’ P0-3 â†’ P1-2 â†’ P1-3 â†’ P2-2

---

## Sprint Scope and Sequencing

### Sprint Goal
Complete the port catalog + lowering migration infrastructure and fully migrate 4 reference blocks to prove the pattern works end-to-end.

### In Scope
- All P0 items (blockers)
- All P1 items (infrastructure completion)
- All P2 items (testing and validation)
- P3-1, P3-2 (consistency and documentation)

### Out of Scope
- P3-3 (migrate remaining 53 blocks) - DEFERRED to future sprint

### Recommended Execution Order
**Week 1 Focus**: Unblock and build infrastructure
1. P0-1, P0-2 (fix type errors - must be first)
2. P0-3 (outputsById infrastructure)
3. P1-1 (definePortCatalog helper)

**Week 2 Focus**: Complete migration and test
4. P1-2 (migrate 4 reference blocks)
5. P1-3 (audit + flip strict-by-default)
6. P2-1, P2-2, P2-3 (test suites)

**Polish** (if time permits):
7. P3-1 (math block catalogs)
8. P3-2 (documentation)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Strict-by-default breaks unknown blocks** | MEDIUM | HIGH | Thorough audit before flip (P1-3), fix or tag relaxed |
| **outputsById breaks existing tests** | LOW | MEDIUM | Maintain backward compatibility, gradual rollout |
| **Type errors in other blocks** | LOW | MEDIUM | Fix waveform domain first, monitor for others |
| **Port catalog drift after helper** | LOW | LOW | TypeScript enforcement prevents drift at compile-time |
| **Scope creep to 53 blocks** | MEDIUM | HIGH | **Explicit DEFER** - do not migrate beyond 4 reference blocks |

---

## Success Metrics

### Must Achieve
- [ ] `just typecheck` passes with zero TypeScript errors
- [ ] `just test` passes with all tests succeeding
- [ ] 4 reference blocks fully migrated (inputsById + outputsById + port catalogs)
- [ ] Strict-by-default enforcement active with zero validation failures
- [ ] `definePortCatalog` helper implemented and used by at least 1 block (Oscillator)

### Should Achieve
- [ ] All P0, P1, P2 items complete
- [ ] Test coverage for new infrastructure (port catalogs, outputsById, contract enforcement)
- [ ] Math blocks have port catalogs (P3-1)

### Nice to Have
- [ ] Migration documentation complete (P3-2)
- [ ] Zero technical debt from this sprint (all patterns clean and reusable)

---

## Blockers and Questions

### Resolved
None yet - this is first planning iteration.

### Open Questions
1. **Type Domain Coverage**: Should `'expression'` domain be added alongside `'waveform'`? (STATUS mentions both, but only waveform appears in active code)
2. **Port Catalog Location**: Should catalogs live in `portCatalog.ts` (centralized) or alongside block compilers (colocated)?
3. **Math Block Catalogs**: Create 3 separate catalogs or 1 shared catalog for all math blocks?

### Next Steps for Implementer
1. Review this plan and STATUS report
2. Ask questions about open items above
3. Start with P0-1 (fix type domain) - this unblocks everything
4. Follow priority order (P0 â†’ P1 â†’ P2 â†’ P3)
5. Re-evaluate after P1 complete before proceeding to P2
