# Sprint Plan: Port Catalog + Lowering Migration (P2/P3 Continuation)
Generated: 2025-12-30-163000
Source: STATUS-2025-12-30.md
Prior Plan: PLAN-2025-12-29-002000.md
Sprint Context: P0+P1 COMPLETE, focusing P2/P3 testing and polish

---

## Executive Summary

**Prior State**: P0+P1 infrastructure complete (4 blocks migrated, strict-by-default active)
**Sprint Goal**: Add critical test coverage for infrastructure, document migration pattern, resolve audit ambiguity
**Sprint Scope**: 2-3 deliverables maximum

**Machine State**: ✅ TypeScript clean, all tests pass
**Risk**: 48 unmigrated blocks not audited before strict-by-default flip

---

## Critical Decision Point: Block Audit Strategy

**Context**: P1-3 flipped strict-by-default without performing the planned block audit (PLAN-2025-12-29-002000.md lines 237-241).

**Current State**:
- 52 total blocks
- 4 using outputsById (migrated)
- 48 not yet migrated
- Tests pass ✅ (suggests no blocks actively failing validation)
- **Unknown**: How many unmigrated blocks have port order mismatches?

**Options**:
1. **Audit All 52 Blocks Now** - Time-consuming, thorough, catches issues before production
2. **Tag Unmigrated Blocks as Relaxed** - Safe rollback, audit during future migration
3. **Trust Passing Tests** - Pragmatic, wait for failures and fix on-demand

**Recommendation**: This plan assumes **Option 3** (trust passing tests) for now. If user wants a different approach, this sprint can be adjusted.

**Rationale**:
- Tests pass ✅
- Enforcement infrastructure tested in P2-2
- Future block migrations will be incremental and testable
- If issues arise, P2-2 tests will help debug

---

## Sprint Scope: 2-3 Deliverables

This sprint focuses on:
1. **P2-2** (Port Contract Enforcement Tests) - HIGH priority, validates infrastructure
2. **P3-2** (Documentation) - MEDIUM priority, critical for future work
3. **P2-1** (Port Catalog Tests) - LOW priority, nice to have

**Deferred**:
- **P2-3** (Test Updates) - Tests already verify outputsById exists; full coverage is lower priority
- **P3-1** (Math Block Catalogs) - Likely unnecessary complexity (see STATUS § P3-1)

---

## P2-2: Add Port Contract Enforcement Tests (REQUIRED)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: None (infrastructure already exists)
**Spec Reference**: Plan Step 3 (strict-by-default) • **Status Reference**: STATUS-2025-12-30.md § P2-2

### Description
Create comprehensive test suite verifying strict-by-default enforcement works correctly. Tests validate that Pass 6 catches port order mismatches, respects opt-out tag, and provides clear error messages.

**Why This Is Critical**:
- Strict-by-default is active for 51 blocks
- No test coverage verifying enforcement catches mismatches
- Risk: Silent failures if enforcement doesn't work as expected
- **Before production deployment**, we need confidence the infrastructure works

**Current State**: `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts` does NOT exist

### Acceptance Criteria
- [ ] Create `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts`
- [ ] Test: Block with correct input port order compiles successfully
- [ ] Test: Block with correct output port order compiles successfully
- [ ] Test: Block with mismatched input order throws `IRValidationFailed` with block type, instance ID, port name
- [ ] Test: Block with mismatched output order throws `IRValidationFailed` with block type, instance ID, port name
- [ ] Test: Block with `tags: { irPortContract: 'relaxed' }` skips validation and compiles successfully
- [ ] Test: Block without tag uses strict-by-default (validates)
- [ ] All tests pass with `just test`
- [ ] Error messages match format from `pass6-block-lowering.ts:374-380`

### Technical Notes

**Test Structure**:
Create minimal test block definitions with known port configurations, invoke Pass 6 lowering, verify expected outcomes.

**Example Test Skeleton**:
```typescript
import { describe, it, expect } from 'vitest';
import { IRBuilderImpl } from '../../ir/IRBuilder';
import { IRValidationFailed } from '../../ir/errors';
import { registerBlockType } from '../../../blocks/blockRegistry';

describe('Pass 6: Port Contract Enforcement', () => {
  it('validates inputs in correct order', () => {
    // Create test block with 2 inputs: [a, b]
    // Lower with inputsById: { a: ..., b: ... }
    // Expect: No error
  });

  it('rejects inputs in wrong order', () => {
    // Create test block expecting [a, b]
    // Lower function accesses inputs[0] assuming 'b' (mismatch)
    // Expect: IRValidationFailed
  });

  it('validates outputs in correct order', () => {
    // Create test block with outputsById: { out: ... }
    // Port definition has output 'out' first
    // Expect: No error
  });

  it('rejects outputs in wrong order', () => {
    // Create test block with outputsById: { x: ..., y: ... }
    // Port definition order: [y, x] (mismatch)
    // Expect: IRValidationFailed
  });

  it('skips validation for relaxed tag', () => {
    // Create test block with tags: { irPortContract: 'relaxed' }
    // Use intentionally mismatched port order
    // Expect: No error (validation skipped)
  });

  it('enforces strict-by-default', () => {
    // Create test block WITHOUT tag
    // Use mismatched port order
    // Expect: IRValidationFailed (strict-by-default active)
  });
});
```

**Reference Implementation**:
- Validation logic: `src/editor/compiler/passes/pass6-block-lowering.ts:270` (strict-by-default check)
- Error format: `src/editor/compiler/passes/pass6-block-lowering.ts:374-380` (missing output port error)
- Existing tests: `src/editor/compiler/__tests__/signal-math.test.ts` (block lowering patterns)

---

## P3-2: Document Migration Pattern (REQUIRED)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: None (implementation already complete)
**Spec Reference**: Plan Step 7 • **Status Reference**: STATUS-2025-12-30.md § P3-2

### Description
Update `Oscillator-Single-Source.md` documentation with complete migration guide showing port catalog, `definePortCatalog`, `inputsById`, `outputsById`, strict-by-default, and step-by-step migration process. This becomes the authoritative reference for migrating the remaining 48 blocks.

**Why This Is Critical**:
- Remaining 48 blocks need migration eventually
- Without migration guide, implementers will reinvent patterns
- Documentation gap creates technical debt
- **High impact** for future work

**Current State**:
- Doc exists at `design-docs/_needs-review/Oscillator-Single-Source.md`
- Has port catalog structure and conventions ✅
- Missing `definePortCatalog`, `outputsById`, strict-by-default details ❌

### Acceptance Criteria
- [ ] Update `design-docs/_needs-review/Oscillator-Single-Source.md` with complete migration example
- [ ] Document `definePortCatalog<const Inputs, const Outputs>()` helper with TypeScript enforcement explanation
- [ ] Document `outputsById` usage in lowering functions with example: `{ outputs: [], outputsById: { out: {...} } }`
- [ ] Document strict-by-default contract: enforcement active by default, opt-out with `tags: { irPortContract: 'relaxed' }`
- [ ] Include complete before/after migration example from one of the 4 reference blocks (Oscillator, AddSignal, MulSignal, or SubSignal)
- [ ] Document step-by-step migration process (5-7 steps)
- [ ] Document when to use `outputs: []` empty pattern (signals full migration)
- [ ] Document backward compatibility: legacy positional pattern still works, both patterns supported during migration

### Technical Notes

**Doc Structure** (suggested):
1. **Overview**: Port catalog architecture and benefits
2. **Helper Function**: `definePortCatalog` usage and type safety
3. **Migration Pattern**: Step-by-step guide
4. **Complete Example**: Before/after code from reference block
5. **Common Pitfalls**: Port order mismatches, optional property access, domain coverage
6. **Testing**: How to verify migration worked

**Step-by-Step Migration Process** (suggested content):
1. Create port catalog using `definePortCatalog({ inputs, inputOrder, outputs, outputOrder })`
2. Update lowering function to use `inputsById?.portName ?? inputs[n]` fallback pattern
3. Return `outputsById: { portName: { k, id, slot } }` with `outputs: []`
4. Verify block definition matches catalog (or create editor block if missing)
5. Run `just typecheck` and `just test` to verify no errors
6. Add block-specific tests if complex behavior
7. Optional: Add `tags: { irPortContract: 'strict' }` for explicit documentation (or rely on default)

**Example Before/After** (use AddSignal or similar):
```typescript
// BEFORE (legacy positional pattern)
export const lowerAddSignal: LoweringFunction = ({ ctx, inputs }) => {
  const sigA = inputs[0];  // Assumes a is first
  const sigB = inputs[1];  // Assumes b is second
  // ...
  return { outputs: [{ k: 'sig', id: output, slot }] };
};

// AFTER (migrated with inputsById/outputsById)
export const lowerAddSignal: LoweringFunction = ({ ctx, inputs, inputsById }) => {
  const sigA = inputsById?.a ?? inputs[0];  // Safe fallback
  const sigB = inputsById?.b ?? inputs[1];  // Safe fallback
  // ...
  return {
    outputs: [],  // Legacy - empty for fully migrated blocks
    outputsById: { out: { k: 'sig', id: output, slot } }
  };
};
```

**Audience**: Future implementers migrating remaining 48 blocks

**Reference Files**:
- Migrated blocks: `src/editor/compiler/blocks/signal/{Oscillator,AddSignal,MulSignal,SubSignal}.ts`
- Port catalog: `src/editor/blocks/portCatalog.ts:46-61` (definePortCatalog)
- Enforcement: `src/editor/compiler/passes/pass6-block-lowering.ts:270` (strict-by-default)

---

## P2-1: Add Port Catalog Tests (OPTIONAL)

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: None (definePortCatalog already exists)
**Spec Reference**: Plan Step 2 • **Status Reference**: STATUS-2025-12-30.md § P2-1
**Priority**: LOW (nice to have, not critical)

### Description
Create test suite verifying `definePortCatalog` helper enforces compile-time type constraints. Tests verify TypeScript catches common mistakes like extra keys in order arrays or missing keys.

**Why This Is Optional**:
- Helper exists and works (used by OSCILLATOR_PORTS)
- TypeScript enforces constraints at compile-time
- Tests would verify enforcement works as intended
- **Not blocking** since compile-time checks are already active

**Current State**: `src/editor/blocks/__tests__/portCatalog.test.ts` does NOT exist

### Acceptance Criteria
- [ ] Create `src/editor/blocks/__tests__/portCatalog.test.ts`
- [ ] Test: Valid catalog with matching keys compiles and returns correct type
- [ ] Test: Catalog with extra key in `inputOrder` fails TypeScript compilation (use `// @ts-expect-error`)
- [ ] Test: Catalog with missing key in `inputOrder` fails TypeScript compilation (use `// @ts-expect-error`)
- [ ] Test: Same constraints verified for `outputOrder` (extra and missing keys)
- [ ] Test: Catalog preserves const inference (return type has literal types, not `string[]`)
- [ ] All tests pass with `just test`

### Technical Notes

**Test Approach**: Compile-time type checks using `// @ts-expect-error` annotations.

**Example Test Structure**:
```typescript
import { describe, it, expect } from 'vitest';
import { definePortCatalog } from '../portCatalog';

describe('definePortCatalog', () => {
  it('accepts valid catalog', () => {
    const catalog = definePortCatalog({
      inputs: {
        a: { id: 'a', domain: 'signal', type: 'number' },
        b: { id: 'b', domain: 'signal', type: 'number' }
      },
      inputOrder: ['a', 'b'] as const,
      outputs: {
        out: { id: 'out', domain: 'signal', type: 'number' }
      },
      outputOrder: ['out'] as const
    });
    expect(catalog.inputOrder).toEqual(['a', 'b']);
  });

  it('rejects inputOrder with extra key', () => {
    // @ts-expect-error - 'c' not in inputs
    definePortCatalog({
      inputs: { a: {...}, b: {...} },
      inputOrder: ['a', 'b', 'c'],
      outputs: { out: {...} },
      outputOrder: ['out']
    });
  });

  it('rejects inputOrder with missing key', () => {
    // @ts-expect-error - 'b' in inputs but not in inputOrder
    definePortCatalog({
      inputs: { a: {...}, b: {...} },
      inputOrder: ['a'],  // Missing 'b'
      outputs: { out: {...} },
      outputOrder: ['out']
    });
  });

  it('preserves const inference', () => {
    const catalog = definePortCatalog({
      inputs: { a: {...} },
      inputOrder: ['a'] as const,
      outputs: { out: {...} },
      outputOrder: ['out'] as const
    });
    // Type should be readonly ['a'], not string[]
    type InputOrder = typeof catalog.inputOrder;
    const _typeCheck: readonly ['a'] = catalog.inputOrder;
  });
});
```

**Reference Implementation**: `src/editor/blocks/portCatalog.ts:46-61` (definePortCatalog function)

---

## Deferred Items

### P2-3: Update Existing Tests for outputsById (DEFERRED)

**Why Deferred**:
- Tests already verify `outputsById` exists (lines 57-59, 96-98, 131-133, 318-320 in signal-math.test.ts)
- Missing coverage (inputsById usage, Pass 6 mapping, backward compatibility) is lower priority
- Tests pass ✅, basic validation working
- If test improvements are needed, they can be added incrementally

**If Re-Activated**: See PLAN-2025-12-29-002000.md § P2-3 for acceptance criteria

### P3-1: Create Port Catalogs for Math Blocks (DEFERRED)

**Why Deferred**:
- Math blocks are simple (2 inputs, 1 output, all same type)
- No editor block definitions currently consume these ports
- Creating catalogs would add complexity without clear benefit
- `definePortCatalog` is most useful when ports are shared across files
- Current inline pattern is acceptable for simple blocks

**Recommendation**: SKIP unless editor definitions are added for AddSignal/MulSignal/SubSignal

**If Re-Activated**: See PLAN-2025-12-29-002000.md § P3-1 for acceptance criteria

---

## Dependency Graph

```
STATUS-2025-12-30.md (Input)
            |
            |
            v
      ┌─────────────┐
      │   P2-2      │  (Port Contract Enforcement Tests - REQUIRED)
      │  Tests      │
      └─────────────┘
            |
            v
      ┌─────────────┐
      │   P3-2      │  (Documentation - REQUIRED)
      │   Docs      │
      └─────────────┘
            |
            v
      ┌─────────────┐
      │   P2-1      │  (Port Catalog Tests - OPTIONAL)
      │  Tests      │
      └─────────────┘
```

**Critical Path**: P2-2 → P3-2 (P2-1 can run in parallel or be skipped)

---

## Sprint Sequencing

### Recommended Execution Order

**Session 1** (2-3 hours):
1. **P2-2**: Create port contract enforcement tests
   - Highest priority, validates critical infrastructure
   - Tests strict-by-default, relaxed opt-out, error messages
   - Gives confidence before production deployment

**Session 2** (2-3 hours):
2. **P3-2**: Complete migration documentation
   - Critical for future work (48 blocks remaining)
   - Use P2-2 test patterns as examples
   - Reference complete implementation from 4 migrated blocks

**Session 3** (Optional, 2-3 hours):
3. **P2-1**: Add port catalog tests
   - Nice to have, not critical
   - Can be skipped if time is limited
   - Lower priority than P2-2 and P3-2

**Total Effort**: 4-6 hours for required items (P2-2 + P3-2), 6-9 hours if P2-1 included

---

## Success Metrics

### Must Achieve
- [ ] **P2-2 complete**: Port contract enforcement tests exist and pass
- [ ] **P3-2 complete**: Migration documentation updated with complete examples
- [ ] `just typecheck` passes with zero TypeScript errors
- [ ] `just test` passes with all tests succeeding
- [ ] Test coverage for strict-by-default enforcement (catches mismatches, respects relaxed tag)

### Should Achieve
- [ ] **P2-1 complete**: Port catalog tests exist and pass (compile-time enforcement verified)
- [ ] Documentation includes before/after examples from reference blocks
- [ ] Error message format documented for future debugging

### Nice to Have
- [ ] P2-3 test improvements (inputsById, Pass 6 mapping, backward compatibility)
- [ ] Zero technical debt from this sprint (all patterns documented)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Unmigrated blocks have port mismatches** | MEDIUM | HIGH | P2-2 tests validate enforcement; trust passing tests for now |
| **Documentation incomplete** | LOW | MEDIUM | P3-2 covers full migration pattern with examples |
| **Test coverage gaps** | LOW | LOW | P2-2 covers critical enforcement, P2-1/P2-3 are optional |
| **P3-1 unnecessary work** | N/A | N/A | DEFERRED - skip unless editor definitions added |

---

## Blockers and Questions

### None
All infrastructure is complete. This sprint is pure testing and documentation.

### If Block Audit Is Required
If user wants to audit all 52 blocks before proceeding, add this item:

**P1-3-AUDIT: Block Port Order Audit (OPTIONAL)**
- Audit all 52 block files for port order mismatches
- Document findings in `AUDIT-2025-12-30.md`
- Fix mismatches OR add `tags: { irPortContract: 'relaxed' }` to affected blocks
- Effort: Medium (4-6 hours)
- See STATUS § Ambiguity #1 for details

---

## Files Modified

### New Files (To Be Created)
- `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts` (P2-2)
- `src/editor/blocks/__tests__/portCatalog.test.ts` (P2-1, optional)

### Updated Files
- `design-docs/_needs-review/Oscillator-Single-Source.md` (P3-2)

### No Changes
- All implementation files (infrastructure complete)
- Existing test files (unless P2-3 is activated)

---

## Next Steps After Sprint

**If This Sprint Completes Successfully**:
1. Infrastructure is fully tested and documented ✅
2. Migration pattern is proven and ready for scale
3. Future work: Migrate remaining 48 blocks incrementally
4. Consider tooling/automation for migration (e.g., codemod)

**Future Sprint Candidates**:
- Migrate domain blocks (batch 1 of ~20 blocks)
- Migrate rhythm blocks (batch 2 of ~5 blocks)
- Migrate remaining signal blocks (batch 3 of ~23 blocks)
- Tooling: Create migration script to automate boilerplate

**Metrics for Future Sprints**:
- Estimate: 1-2 hours per block
- Total: 48 blocks = 48-96 hours
- Can parallelize by category (domain/rhythm/signal)

---

## Definition of Done

### Sprint Complete When:
- [ ] P2-2 tests created, all pass, cover strict-by-default and relaxed opt-out
- [ ] P3-2 documentation updated with complete migration guide and examples
- [ ] (Optional) P2-1 tests created, all pass, verify compile-time enforcement
- [ ] `just typecheck` passes
- [ ] `just test` passes
- [ ] No new technical debt introduced
- [ ] All files committed with clear commit message

### Ready for Next Phase When:
- [ ] Future implementers have clear migration guide (P3-2)
- [ ] Enforcement infrastructure validated (P2-2)
- [ ] Remaining 48 blocks can be migrated incrementally with confidence
