# Definition of Done: Port Catalog + Lowering Migration (P2/P3 Sprint)
Generated: 2025-12-30-163000
Plan: PLAN-2025-12-30-P2P3.md
Source: STATUS-2025-12-30.md

---

## Sprint Scope
This sprint delivers testing and documentation for the port catalog + lowering migration infrastructure. P0+P1 are complete; this sprint focuses on **2 required deliverables** (P2-2, P3-2) and **1 optional deliverable** (P2-1).

**Deferred**: P2-3 (test improvements), P3-1 (math block catalogs)

---

## Deliverable 1: Port Contract Enforcement Tests (P2-2 - REQUIRED)

### Acceptance Criteria

#### Test File Creation
- [ ] File `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts` exists
- [ ] File imports necessary types: `IRBuilderImpl`, `IRValidationFailed`, block registry functions
- [ ] File has describe block: `describe('Pass 6: Port Contract Enforcement', ...)`

#### Test Coverage - Inputs
- [ ] Test: Block with correct input port order compiles successfully (no error)
- [ ] Test: Block with mismatched input order throws `IRValidationFailed`
- [ ] Error message includes block type, instance ID, and specific port name that failed validation
- [ ] Error message matches format from `pass6-block-lowering.ts:374-380`

#### Test Coverage - Outputs
- [ ] Test: Block with correct output port order compiles successfully (no error)
- [ ] Test: Block with mismatched output order throws `IRValidationFailed`
- [ ] Error message includes block type, instance ID, and specific port name that failed validation

#### Test Coverage - Enforcement Modes
- [ ] Test: Block with `tags: { irPortContract: 'relaxed' }` skips validation and compiles (no error even with mismatch)
- [ ] Test: Block without tag uses strict-by-default (validates and throws error on mismatch)
- [ ] Test: Block with `tags: { irPortContract: 'strict' }` explicitly enables validation (throws error on mismatch)

#### Test Quality
- [ ] All tests in suite pass with `just test`
- [ ] Tests use real IRBuilderImpl, not mocks
- [ ] Tests create minimal but complete block definitions
- [ ] Tests verify both success and failure paths
- [ ] Test coverage includes at least 6 test cases (inputs match, inputs mismatch, outputs match, outputs mismatch, relaxed opt-out, strict-by-default)

---

## Deliverable 2: Migration Pattern Documentation (P3-2 - REQUIRED)

### Acceptance Criteria

#### Documentation Structure
- [ ] File `design-docs/_needs-review/Oscillator-Single-Source.md` updated
- [ ] Document has clear section structure: Overview, Helper Function, Migration Pattern, Complete Example, Common Pitfalls, Testing
- [ ] Document includes table of contents or clear navigation

#### Content - Helper Function
- [ ] `definePortCatalog<const Inputs, const Outputs>()` helper documented with TypeScript signature
- [ ] Explanation of compile-time type enforcement (how TypeScript catches mismatches)
- [ ] Example usage showing port catalog creation

#### Content - outputsById Pattern
- [ ] `outputsById` usage documented with example: `{ outputs: [], outputsById: { out: {...} } }`
- [ ] Explanation of `outputs: []` empty pattern (signals full migration)
- [ ] Port ID mapping explained (how outputsById keys correspond to port definition IDs)

#### Content - Strict-by-Default
- [ ] Strict-by-default contract documented: enforcement active by default
- [ ] Opt-out pattern documented: `tags: { irPortContract: 'relaxed' }`
- [ ] When to use relaxed tag explained (complex blocks, dynamic ports, legacy compatibility)

#### Content - Migration Guide
- [ ] Step-by-step migration process (5-7 steps minimum)
- [ ] Step 1: Create port catalog using `definePortCatalog`
- [ ] Step 2: Update lowering function to use `inputsById?.portName ?? inputs[n]` fallback
- [ ] Step 3: Return `outputsById: { portName: {...} }` with `outputs: []`
- [ ] Step 4: Verify block definition matches catalog
- [ ] Step 5: Run `just typecheck` and `just test`
- [ ] Steps 6-7: Block-specific tests and/or explicit strict tag

#### Content - Complete Example
- [ ] Before/after migration example from one of the 4 reference blocks (Oscillator, AddSignal, MulSignal, or SubSignal)
- [ ] Example shows complete lowering function (not just snippets)
- [ ] Example includes port catalog definition
- [ ] Example shows both inputsById and outputsById usage
- [ ] Code is runnable (copy-paste would compile)

#### Content - Backward Compatibility
- [ ] Legacy positional pattern documented: `inputs[0]`, `outputs: [...]`
- [ ] Fallback pattern explained: `inputsById?.portName ?? inputs[n]`
- [ ] Both patterns supported during migration (gradual rollout strategy)

#### Content - Common Pitfalls
- [ ] Port order mismatches documented (how to debug, what errors look like)
- [ ] Optional property access pitfalls (safe access patterns)
- [ ] Domain coverage issues (e.g., missing 'waveform' domain)

#### Content - Testing
- [ ] How to verify migration worked (typecheck, tests, runtime validation)
- [ ] Reference to P2-2 tests as examples
- [ ] Guidance on when to add block-specific tests

#### Quality
- [ ] All code examples use correct TypeScript syntax
- [ ] All code examples use correct Oscilla types and patterns
- [ ] Document is clear and readable for future implementers
- [ ] Document references source files (e.g., `src/editor/blocks/portCatalog.ts:46-61`)

---

## Deliverable 3: Port Catalog Tests (P2-1 - OPTIONAL)

### Acceptance Criteria

#### Test File Creation
- [ ] File `src/editor/blocks/__tests__/portCatalog.test.ts` exists
- [ ] File imports `definePortCatalog` from `../portCatalog`
- [ ] File has describe block: `describe('definePortCatalog', ...)`

#### Test Coverage - Valid Catalog
- [ ] Test: Valid catalog with matching keys compiles successfully
- [ ] Test: Valid catalog returns correctly typed object (preserves const inference)
- [ ] Test: Catalog properties accessible (inputOrder, outputOrder, inputs, outputs)

#### Test Coverage - Compile-Time Errors
- [ ] Test: Catalog with extra key in `inputOrder` fails TypeScript compilation (use `// @ts-expect-error`)
- [ ] Test: Catalog with missing key in `inputOrder` fails TypeScript compilation (use `// @ts-expect-error`)
- [ ] Test: Catalog with extra key in `outputOrder` fails TypeScript compilation (use `// @ts-expect-error`)
- [ ] Test: Catalog with missing key in `outputOrder` fails TypeScript compilation (use `// @ts-expect-error`)

#### Test Coverage - Type Inference
- [ ] Test: Catalog preserves const inference (return type has literal types, not `string[]`)
- [ ] Test: inputOrder has type `readonly ['a', 'b']` not `readonly string[]`
- [ ] Test: outputOrder has type `readonly ['out']` not `readonly string[]`

#### Test Quality
- [ ] All tests in suite pass with `just test`
- [ ] Tests verify compile-time enforcement (TypeScript errors)
- [ ] At least 5 test cases (valid catalog, extra input, missing input, extra output, missing output)

---

## Sprint Scope

### This sprint delivers:
1. **P2-2** (Port Contract Enforcement Tests) - Validates critical infrastructure
2. **P3-2** (Migration Documentation) - Enables future work
3. **P2-1** (Port Catalog Tests) - Optional, nice to have

### Deferred to future sprints:
- **P2-3** (Test Updates) - Tests already verify outputsById exists; full coverage lower priority
- **P3-1** (Math Block Catalogs) - Likely unnecessary complexity per STATUS ยง P3-1

---

## Global Acceptance Criteria

### All Deliverables
- [ ] `just typecheck` passes with zero TypeScript errors
- [ ] `just test` passes with all tests succeeding (including new tests)
- [ ] No new lint warnings introduced (pre-existing 53 warnings acceptable)
- [ ] All new test files follow existing test patterns and conventions
- [ ] All documentation follows existing markdown style

### Code Quality
- [ ] No commented-out code committed
- [ ] No debug console.log statements committed
- [ ] Tests are meaningful (not tautological)
- [ ] Tests verify real behavior (not implementation details)

### Git Hygiene
- [ ] All changes committed with clear commit messages
- [ ] Commit messages follow project conventions (no Claude attribution per CLAUDE.md)
- [ ] No unrelated changes included in commits

---

## Ready for Next Phase When

### Infrastructure Validated
- [ ] Port contract enforcement tested (P2-2 complete)
- [ ] Strict-by-default behavior verified (tests pass)
- [ ] Relaxed opt-out tag verified (tests pass)

### Documentation Complete
- [ ] Migration pattern fully documented (P3-2 complete)
- [ ] Future implementers have clear guide
- [ ] Before/after examples from reference blocks included

### Testing Mature
- [ ] Critical test coverage in place (P2-2)
- [ ] Optional test coverage considered (P2-1)
- [ ] Test suite runs green (all pass)

### Ready to Scale
- [ ] Remaining 48 blocks can be migrated incrementally with confidence
- [ ] Migration process documented and proven
- [ ] Enforcement infrastructure validated and trusted

---

## Definition of Complete

This sprint is **COMPLETE** when:
1. P2-2 (Port Contract Enforcement Tests) is fully implemented and all tests pass
2. P3-2 (Migration Documentation) is updated with complete migration guide and examples
3. P2-1 (Port Catalog Tests) is either completed OR explicitly deferred with rationale
4. `just check` passes (typecheck + lint + test)
5. All acceptance criteria above are met (checkboxes checked)

This sprint is **READY FOR NEXT PHASE** when:
- Future implementers can migrate blocks using documented pattern
- Enforcement infrastructure is proven reliable
- No blockers exist for incremental migration of remaining 48 blocks
