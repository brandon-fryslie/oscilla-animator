# Status Report: Port Catalog + Lowering Migration
**Generated**: 2025-12-30
**Evaluator**: project-evaluator
**Scope**: P2/P3 work items from PLAN-2025-12-29-002000.md
**Confidence**: FRESH (evaluated 2025-12-30)

---

## Executive Summary

**P0+P1 Status**: ‚úÖ COMPLETE (verified via code inspection and git history)
**P2 Status**: ‚ùå NOT STARTED (0/3 items complete)
**P3 Status**: üü° PARTIAL (0/2 items complete, but P3-1 may be unnecessary)

**Machine State**: ‚úÖ PASSING
- TypeScript: ‚úÖ Clean compilation
- Tests: ‚úÖ 100% pass (with 3 pre-existing composite test skips, unrelated to this work)
- Lint: ‚ö†Ô∏è 53 warnings (pre-existing, unrelated to port catalog work)

**Key Finding**: P0+P1 infrastructure is solid. P2 testing gaps exist but are not blocking. P3-1 (math block catalogs) may be unnecessary duplication.

---

## P0+P1 Verification (COMPLETE)

### Evidence of Completion

**Commit**: `62d35bf` - "Complete P1: Port Catalog + Lowering Migration Infrastructure" (2025-12-29)

#### P0-1: Fix TypeDomain Missing Values ‚úÖ
- **File**: `src/editor/ir/types/TypeDesc.ts:89`
- **Evidence**: `'waveform'` domain added to `InternalDomain` union
- **Evidence**: `'expression'` domain added to `InternalDomain` union
- **Status**: Both domains present, documented, TypeScript compiles cleanly

#### P0-2: Fix PortSpec Optional Property Access ‚úÖ
- **File**: `src/editor/blocks/oscillatorSpec.ts:38-39`
- **Evidence**: Code uses `spec.optional === true` safe access pattern
- **Evidence**: `spec.defaultSource` accessed safely
- **Status**: TypeScript compiles without errors

#### P0-3: Implement outputsById Infrastructure ‚úÖ
- **File**: `src/editor/compiler/ir/lowerTypes.ts:171`
- **Evidence**: `outputsById?: Readonly<Record<string, ValueRefPacked>>` added to `LowerResult`
- **File**: `src/editor/compiler/passes/pass6-block-lowering.ts:369-383`
- **Evidence**: Pass 6 checks for `result.outputsById`, maps to positional array using port order
- **Evidence**: Falls back to legacy `outputs` array if `outputsById` absent
- **Status**: Infrastructure complete and working

#### P1-1: Implement definePortCatalog Helper ‚úÖ
- **File**: `src/editor/blocks/portCatalog.ts:46-61`
- **Evidence**: `definePortCatalog<const Inputs, const Outputs>()` function exists
- **Evidence**: TypeScript enforces `inputOrder` keys match `inputs` keys
- **Evidence**: TypeScript enforces `outputOrder` keys match `outputs` keys
- **Evidence**: `OSCILLATOR_PORTS` migrated to use helper (line 63)
- **Evidence**: Comprehensive JSDoc documentation present
- **Status**: Complete with compile-time type safety

#### P1-2: Complete Reference Block Migration to outputsById ‚úÖ
- **Oscillator** (`src/editor/compiler/blocks/signal/Oscillator.ts:142-144`):
  ```typescript
  return {
    outputs: [], // Legacy - empty for fully migrated blocks
    outputsById: { out: { k: 'sig', id: output, slot } },
  };
  ```
- **AddSignal** (`src/editor/compiler/blocks/signal/AddSignal.ts:34-36`): ‚úÖ Same pattern
- **MulSignal** (`src/editor/compiler/blocks/signal/MulSignal.ts:31-33`): ‚úÖ Same pattern
- **SubSignal** (`src/editor/compiler/blocks/signal/SubSignal.ts:31-33`): ‚úÖ Same pattern
- **Status**: All 4 reference blocks fully migrated

#### P1-3: Flip Strict-by-Default Enforcement ‚úÖ
- **File**: `src/editor/compiler/passes/pass6-block-lowering.ts:270`
- **Evidence**: Line 270: `const enforcePortContract = blockDef?.tags?.irPortContract !== 'relaxed';`
- **Evidence**: Changed from `=== 'strict'` to `!== 'relaxed'` (opt-out pattern)
- **Status**: Enforcement active for all blocks by default
- **Audit Status**: ‚ö†Ô∏è **NO AUDIT PERFORMED** (see Ambiguity #1 below)

**P0+P1 Verdict**: ‚úÖ INFRASTRUCTURE COMPLETE AND WORKING

---

## P2 Assessment (Testing and Validation)

### P2-1: Add Port Catalog Tests ‚ùå NOT STARTED
**File**: `src/editor/blocks/__tests__/portCatalog.test.ts` - **DOES NOT EXIST**
**Evidence**: No tests for `definePortCatalog` helper

**Missing Coverage**:
1. Valid catalog with matching keys compiles
2. Extra key in `inputOrder` fails TypeScript compilation
3. Missing key in `inputOrder` fails TypeScript compilation
4. Same constraints for `outputOrder`

**Impact**: MEDIUM
- Helper exists and works (used by OSCILLATOR_PORTS)
- TypeScript enforces constraints at compile-time
- Tests would verify enforcement works as intended
- Not blocking since compile-time checks are already active

---

### P2-2: Add Port Contract Enforcement Tests ‚ùå NOT STARTED
**File**: `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts` - **DOES NOT EXIST**
**Evidence**: No tests for strict-by-default enforcement

**Missing Coverage**:
1. Block with correct port order compiles successfully
2. Block with mismatched input order throws `IRValidationFailed`
3. Block with mismatched output order throws `IRValidationFailed`
4. Block with `tags: { irPortContract: 'relaxed' }` skips validation
5. Error messages include block type, instance ID, mismatch details

**Impact**: HIGH
- Strict-by-default is active for 51 blocks (52 total - 1 with explicit tag)
- No test coverage verifying enforcement catches mismatches
- Unknown if any blocks have port order mismatches (audit not performed per P1-3)
- Risk: Silent failures if enforcement doesn't work as expected

**Recommendation**: Create tests BEFORE deploying to production

---

### P2-3: Update Existing Tests for outputsById üü° PARTIAL
**File**: `src/editor/compiler/__tests__/signal-math.test.ts`
**Evidence**: Tests updated to verify `outputsById` for migrated blocks

**What Exists**:
- Line 57-59: AddSignal test verifies `result.outputsById.out` exists
- Line 96-98: SubSignal test verifies `result.outputsById.out` exists
- Line 131-133: MulSignal test verifies `result.outputsById.out` exists
- Line 318-320: Oscillator test verifies `result.outputsById.out` exists

**What's Missing** (per plan acceptance criteria):
1. ‚ùå Tests don't use `inputsById` when calling `lower()` (still use positional `inputs` array)
2. ‚ùå No test verifying Pass 6 correctly maps `outputsById` to positional outputs array
3. ‚ùå No test for "both outputs and outputsById provided, outputsById wins" scenario
4. ‚ùå No test for legacy (positional only) backward compatibility

**Current Test Pattern** (lines 39-54):
```typescript
const inputs: ValueRefPacked[] = [
  { k: "sig", id: sigA, slot: slotA },
  { k: "sig", id: sigB, slot: slotB },
];
const result = irDecl!.lower({ ctx, inputs });
```

**Missing Pattern** (from plan):
```typescript
const inputsById = { a: { k: "sig", id: sigA, slot: slotA }, ... };
const result = irDecl!.lower({ ctx, inputs: [], inputsById });
expect(result.outputsById).toEqual({ out: expect.objectContaining({ k: 'sig' }) });
```

**Impact**: MEDIUM
- Tests verify `outputsById` is returned
- Tests don't verify `inputsById` path works
- Tests don't verify Pass 6 mapping logic
- Partial coverage is better than none, but gaps remain

---

## P3 Assessment (Documentation and Polish)

### P3-1: Create Port Catalogs for Math Blocks ‚ùå NOT STARTED
**Expected**: `ADD_SIGNAL_PORTS`, `MUL_SIGNAL_PORTS`, `SUB_SIGNAL_PORTS` in `portCatalog.ts`
**Evidence**: `grep` shows no such constants exist

**Current State**: Math blocks define ports inline in `registerBlockType()` calls:
- `AddSignal.ts:43-49`: Inline port definitions
- `MulSignal.ts:40-46`: Inline port definitions
- `SubSignal.ts:40-46`: Inline port definitions

**Analysis**: Is this necessary?

**Arguments FOR creating catalogs**:
- Consistency with Oscillator pattern
- Single source of truth for editor + IR
- Reduces duplication if editor needs port definitions

**Arguments AGAINST**:
- Math blocks are simple (2 inputs, 1 output, all same type)
- No editor block definitions currently consume these ports
- Creating catalogs would add complexity without clear benefit
- `definePortCatalog` is most useful when ports are shared across files

**Files Examined**:
- `src/editor/blocks/signal.ts`: No editor definitions for AddSignal/MulSignal/SubSignal
- `src/editor/compiler/blocks/signal/*.ts`: Inline IR port definitions work fine

**Recommendation**: **SKIP P3-1** unless editor block definitions are added
- Current inline pattern is acceptable for simple blocks
- If math blocks get editor UI definitions, revisit this work

---

### P3-2: Document Migration Pattern ‚ùå NOT STARTED
**File**: `design-docs/_needs-review/Oscillator-Single-Source.md`
**Evidence**: Doc exists but doesn't fully document migration pattern

**What Exists** (current content):
- Port catalog structure and conventions ‚úÖ
- `irPortContract: 'strict'` opt-in mentioned ‚úÖ
- defaultSource behavior documented ‚úÖ
- `inputsById` fallback pattern mentioned ‚úÖ

**What's Missing** (per plan acceptance criteria):
1. ‚ùå No `definePortCatalog` helper documentation
2. ‚ùå No `outputsById` usage examples
3. ‚ùå No strict-by-default (opt-out) documentation
4. ‚ùå No complete migration example (before/after code)
5. ‚ùå No step-by-step migration guide for remaining 48 blocks
6. ‚ùå No `outputs: []` empty pattern documentation

**Impact**: HIGH for future work
- Remaining 48 blocks need migration eventually
- Without migration guide, implementers will reinvent patterns
- Documentation gap creates technical debt

**Recommendation**: Complete this before migrating more blocks

---

## Ambiguities and Questions

### Ambiguity #1: Block Port Order Audit Not Performed ‚ö†Ô∏è CRITICAL

**Context**: P1-3 flipped strict-by-default enforcement without performing the audit specified in plan

**Plan Requirement** (PLAN-2025-12-29-002000.md lines 237-241):
```
AUDIT FIRST: Check all 57 block port definitions against their lowering
implementations for port order mismatches
Document any mismatches found in audit
Fix all mismatches OR add tags: { irPortContract: 'relaxed' } to blocks
```

**What Actually Happened**:
- Enforcement flipped to strict-by-default ‚úÖ
- No audit performed ‚ùå
- Zero blocks tagged with `irPortContract: 'relaxed'` (except possibly 1)
- Only 1 block has explicit `irPortContract: 'strict'` tag

**Current Situation**:
- 52 total block compiler files
- 4 blocks using `outputsById` (migrated)
- 48 blocks not yet migrated
- **Unknown**: How many blocks have port order mismatches?

**Risk Assessment**:
- **Tests pass**: ‚úÖ Suggests no blocks actively failing validation
- **But**: Tests may not exercise all 52 blocks through Pass 6
- **Unknown**: Are there blocks that would fail validation if used?

**Questions**:
1. **Did any blocks break when strict-by-default was enabled?**
   - Tests pass, suggesting no
   - But test coverage may not include all blocks

2. **Should we audit now or defer?**
   - Option A: Audit all 52 blocks for port order mismatches (time-consuming)
   - Option B: Wait for failures and fix on-demand (risky but pragmatic)
   - Option C: Add `irPortContract: 'relaxed'` to unmigrated blocks, audit during migration

3. **What's the enforcement coverage?**
   - Does test suite exercise all 52 blocks through Pass 6?
   - Or are some blocks only used in production?

**Recommendation**: Ask user how to proceed

---

### Ambiguity #2: Test Coverage Unknown

**Context**: Tests pass but coverage across 52 blocks is unclear

**Questions**:
1. How many of the 52 block types are exercised by test suite?
2. Are there blocks only used in production (not in tests)?
3. Should we add smoke tests for all 52 blocks before claiming P1 complete?

**Recommendation**: Run coverage report or audit test suite

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Port order mismatches in unmigrated blocks** | MEDIUM | HIGH | Audit blocks or add relaxed tags during migration |
| **P2 test gaps hide enforcement bugs** | LOW | HIGH | Create P2-2 tests before production deployment |
| **Migration pattern undocumented** | HIGH | MEDIUM | Complete P3-2 before migrating more blocks |
| **P3-1 unnecessary work** | N/A | LOW | Skip unless editor definitions added |

---

## Data Flow Verification

### outputsById Flow (P0-3 Infrastructure)

| Step | Component | Verification | Status |
|------|-----------|--------------|--------|
| **1. Block returns outputsById** | Block lowering function | Code inspection: 4 blocks return `outputsById: { out: {...} }` | ‚úÖ VERIFIED |
| **2. Pass 6 receives outputsById** | `pass6-block-lowering.ts:366` | Code inspection: `const result = blockType.lower(...)` | ‚úÖ VERIFIED |
| **3. Pass 6 checks outputsById** | `pass6-block-lowering.ts:369` | Code inspection: `if (result.outputsById !== undefined && Object.keys(...).length > 0)` | ‚úÖ VERIFIED |
| **4. Pass 6 maps to positional** | `pass6-block-lowering.ts:371-383` | Code inspection: Iterates `portOrder`, builds `outputRefs` map | ‚úÖ VERIFIED |
| **5. Missing port detected** | `pass6-block-lowering.ts:374-380` | Code inspection: Throws error with block type, ID, port name | ‚úÖ VERIFIED |
| **6. Fallback to legacy outputs** | `pass6-block-lowering.ts:384-391` | Code inspection: Uses `result.outputs` if `outputsById` absent | ‚úÖ VERIFIED |

**Verdict**: outputsById infrastructure is correctly implemented

### inputsById Flow (P0-3 + Reference Blocks)

| Step | Component | Verification | Status |
|------|-----------|--------------|--------|
| **1. Pass 6 builds inputsById** | `pass6-block-lowering.ts:340` | Code inspection: `inputsById[inputPort.id] = ref;` | ‚úÖ VERIFIED |
| **2. Block receives inputsById** | Block `lower()` function | Code inspection: `lowerOscillator: ({ ctx, inputs, inputsById })` | ‚úÖ VERIFIED |
| **3. Block uses inputsById** | Block implementation | Code inspection: `const phase = inputsById?.phase ?? inputs[0]` | ‚úÖ VERIFIED |
| **4. Fallback to positional** | Block implementation | Code inspection: `?? inputs[0]` fallback present | ‚úÖ VERIFIED |

**Verdict**: inputsById infrastructure working, but tests don't verify it (see P2-3)

---

## Test Suite Assessment

**Quality Score**: 3/5

| Criterion | Pass? | Evidence |
|-----------|-------|----------|
| **If I delete implementation and leave stubs, do tests fail?** | ‚ùì UNKNOWN | Would need to stub a block and re-run tests |
| **If I introduce an obvious bug, do tests catch it?** | üü° PARTIAL | Tests verify `outputsById` exists but not Pass 6 mapping |
| **Do tests exercise real user flows end-to-end?** | ‚ùå NO | No end-to-end test from patch ‚Üí Pass 6 ‚Üí outputsById ‚Üí positional array |
| **Do tests use real systems or mock everything?** | ‚úÖ YES | Tests use real IRBuilderImpl, real lowering functions |
| **Do tests cover error conditions users will hit?** | ‚ùå NO | No tests for port order mismatches, missing ports |

**Coverage Gaps**:
1. No test for port order mismatch detection (P2-2 missing)
2. No test for `outputsById` ‚Üí positional mapping in Pass 6 (P2-3 gap)
3. No test for `inputsById` usage (P2-3 gap)
4. No test for `definePortCatalog` TypeScript enforcement (P2-1 missing)

**Recommendation**: Complete P2 items before claiming "fully tested"

---

## Findings Summary

### ‚úÖ COMPLETE
- **P0-1**: TypeDomain missing values fixed
- **P0-2**: PortSpec optional property access fixed
- **P0-3**: outputsById infrastructure implemented
- **P1-1**: definePortCatalog helper created and in use
- **P1-2**: 4 reference blocks migrated to outputsById
- **P1-3**: Strict-by-default enforcement active

### ‚ùå NOT STARTED
- **P2-1**: Port catalog tests missing
- **P2-2**: Port contract enforcement tests missing
- **P2-3**: Test gaps for inputsById, Pass 6 mapping, backward compatibility
- **P3-2**: Migration pattern not fully documented

### ü§î QUESTIONABLE
- **P1-3 Audit**: Block audit not performed as specified (see Ambiguity #1)
- **P3-1**: Math block catalogs may be unnecessary work

---

## Recommendations

### High Priority (Do Before Production)
1. **Create P2-2 tests** for port contract enforcement
   - Verify validation catches mismatches
   - Verify error messages are helpful
   - Verify relaxed tag bypasses enforcement

2. **Resolve Ambiguity #1**: Decide on block audit strategy
   - Option A: Audit all 52 blocks now
   - Option B: Add `irPortContract: 'relaxed'` to unmigrated blocks
   - Option C: Wait for failures and fix on-demand

3. **Complete P3-2**: Document migration pattern
   - Future implementers need clear guide
   - Prevents reinventing patterns

### Medium Priority (Nice to Have)
4. **Improve P2-3 test coverage**
   - Add `inputsById` usage tests
   - Add Pass 6 mapping tests
   - Add backward compatibility tests

5. **Add P2-1 tests** for `definePortCatalog`
   - Low risk (TypeScript enforces at compile-time)
   - But tests verify enforcement works

### Low Priority (Defer or Skip)
6. **Skip P3-1** unless editor definitions are added
   - Inline ports work fine for simple blocks
   - Creating catalogs adds complexity without clear benefit

---

## Workflow Recommendation

### Verdict: üü° PAUSE FOR CLARIFICATION

**Reason**: Ambiguity #1 (block audit) needs resolution before proceeding

**Questions for User**:
1. **Block audit strategy**: How should we handle the 48 unmigrated blocks?
   - Audit all blocks now for port order mismatches?
   - Tag unmigrated blocks with `irPortContract: 'relaxed'` and audit during migration?
   - Wait for failures and fix on-demand?

2. **Test priority**: Should we complete P2 tests before moving forward?
   - P2-2 (contract enforcement tests) seems critical
   - P2-1 and P2-3 are lower priority

3. **P3-1 necessity**: Should we create math block catalogs?
   - Current inline pattern works fine
   - Only needed if editor definitions are added

**Next Steps After Clarification**:
- If audit required: Perform block audit (P1-3 completion)
- If tests required: Create P2-2 tests (contract enforcement)
- If documentation required: Complete P3-2 (migration guide)
- If ready to proceed: Move to next phase of work

---

## Machine Checks

### Runtime Check Results

| Check | Command | Status | Notes |
|-------|---------|--------|-------|
| TypeScript | `just typecheck` | ‚úÖ PASS | Zero errors |
| Lint | `just lint` | ‚ö†Ô∏è 53 warnings | Pre-existing, unrelated to port catalog work |
| Tests | `just test` | ‚úÖ PASS | 100% pass, 3 composite tests skipped (pre-existing) |

### Missing Checks (for Implementers)

**P2 Test Suite** (should be created):
1. `src/editor/blocks/__tests__/portCatalog.test.ts`
   - Test `definePortCatalog` TypeScript enforcement
   - Verify compile errors for mismatched keys

2. `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts`
   - Test strict-by-default enforcement
   - Test `irPortContract: 'relaxed'` opt-out
   - Test error messages for port order mismatches

3. `src/editor/compiler/__tests__/signal-math.test.ts` (improvements)
   - Test `inputsById` usage
   - Test Pass 6 mapping from `outputsById` to positional
   - Test backward compatibility (legacy outputs array)

---

## Git Evidence

**P0+P1 Completion Commit**: `62d35bf` (2025-12-29 04:03:01)
```
Complete P1: Port Catalog + Lowering Migration Infrastructure

P1-1: Implement definePortCatalog Helper
P1-2: Complete Reference Block Migration to outputsById
P1-3: Flip Strict-by-Default Enforcement

All tests passing, TypeScript compiles cleanly.
```

**Files Changed**:
- `src/editor/blocks/portCatalog.ts` (definePortCatalog added)
- `src/editor/compiler/__tests__/signal-math.test.ts` (tests updated)
- `src/editor/compiler/blocks/signal/*.ts` (4 blocks migrated)
- `src/editor/compiler/passes/pass6-block-lowering.ts` (strict-by-default)

**Branch**: `ir-backlog-01-type-contracts`
**Base**: `main` (5e2ffbc - "unified-transforms planning")

---

## Status Summary (One-Liner)

```
P0+P1: ‚úÖ COMPLETE | P2: ‚ùå 0/3 tests | P3: üü° 0/2 (P3-1 skip?) | üü° PAUSE: Block audit needed
```
