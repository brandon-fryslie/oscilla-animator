# Definition of Done: Port Catalog + Lowering Migration
Generated: 2025-12-29-002000
Plan: PLAN-2025-12-29-002000.md
Sprint Goal: Complete infrastructure and migrate 4 reference blocks

---

## P0 (Critical) - Blockers

### P0-1: Fix TypeDomain Missing Values
- [ ] Add `'waveform'` to `InternalDomain` union in `src/editor/ir/types/TypeDesc.ts`
- [ ] Add `'waveform'` to `INTERNAL_DOMAINS` set in same file
- [ ] Verify `just typecheck` passes with zero TypeScript errors
- [ ] Verify `just test` runs (tests may fail, but compilation must succeed)
- [ ] Document in TypeDesc.ts what waveform domain represents (e.g., "Waveform shape selection for oscillators")

### P0-2: Fix PortSpec Optional Property Access
- [ ] Fix `oscillatorSpec.ts:38` to safely access `optional` property using optional chaining or type guard
- [ ] Apply same fix to line 39 for `defaultSource` property access if needed
- [ ] Verify `just typecheck` passes with zero TypeScript errors in oscillatorSpec.ts
- [ ] No runtime behavior change (output IR port declarations must match exactly)
- [ ] Pattern is safe for reuse in future port catalog implementations

### P0-3: Implement outputsById Infrastructure
- [ ] Add `outputsById?: Readonly<Record<string, ValueRefPacked>>` to `LowerResult` interface in `src/editor/compiler/ir/lowerTypes.ts:159-165`
- [ ] Update `src/editor/compiler/passes/pass6-block-lowering.ts` to check for `result.outputsById` when mapping outputs
- [ ] If `outputsById` present and non-empty, use it to build outputs array in port order from block port declarations
- [ ] If `outputsById` absent or empty, fall back to existing positional `result.outputs` behavior
- [ ] Add test in `signal-math.test.ts` verifying block can return `outputsById` and Pass 6 maps it correctly
- [ ] Both patterns work: blocks can return only `outputs`, only `outputsById`, or both (outputsById wins)

---

## P1 (High) - Infrastructure Completion

### P1-1: Implement definePortCatalog Helper
- [ ] Create `definePortCatalog<const Inputs, const Outputs>(...)` helper in `src/editor/blocks/portCatalog.ts`
- [ ] Helper enforces `inputOrder` keys exactly match keys of `inputs` object (compile-time TypeScript error if mismatch)
- [ ] Helper enforces `outputOrder` keys exactly match keys of `outputs` object
- [ ] Helper returns properly typed catalog object with full const inference
- [ ] Migrate `OSCILLATOR_PORTS` to use helper: `export const OSCILLATOR_PORTS = definePortCatalog({ ... })`
- [ ] TypeScript compilation succeeds, runtime behavior unchanged
- [ ] Add JSDoc comment explaining helper's purpose and constraint enforcement

### P1-2: Complete Reference Block Migration to outputsById
- [ ] Oscillator returns `{ outputs: [], outputsById: { out: { k: 'sig', id, slot } } }`
- [ ] AddSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] MulSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] SubSignal returns `{ outputs: [], outputsById: { out: <ref> } }`
- [ ] All 4 blocks use empty `outputs: []` to signal full migration (per Plan Step 5 example)
- [ ] `just test` passes - signal-math.test.ts and all other tests succeed
- [ ] IR output structure unchanged (Pass 6 maps outputsById to same positional array)

### P1-3: Flip Strict-by-Default Enforcement
- [ ] **AUDIT FIRST**: Check all 57 block port definitions against their lowering implementations for port order mismatches
- [ ] Document any mismatches found in audit (create list in this plan or separate file)
- [ ] Fix all mismatches OR add `tags: { irPortContract: 'relaxed' }` to blocks with valid reasons for mismatch
- [ ] Change `src/editor/compiler/passes/pass6-block-lowering.ts:256` from `=== 'strict'` to `!== 'relaxed'`
- [ ] Verify `just test` passes with all tests succeeding
- [ ] Verify error messages include block type, ID, and specific port mismatch details (already implemented)
- [ ] Zero blocks should fail validation (all either match or are tagged relaxed)

---

## P2 (Medium) - Testing and Validation

### P2-1: Add Port Catalog Tests
- [ ] Create `src/editor/blocks/__tests__/portCatalog.test.ts`
- [ ] Test: Valid catalog with matching keys compiles and returns correct type
- [ ] Test: Catalog with extra key in `inputOrder` fails TypeScript compilation
- [ ] Test: Catalog with missing key in `inputOrder` fails TypeScript compilation
- [ ] Test: Same constraints verified for `outputOrder`
- [ ] All tests in suite pass with `just test`
- [ ] Tests use `// @ts-expect-error` comments to verify compile-time failures

### P2-2: Add Port Contract Enforcement Tests
- [ ] Create `src/editor/compiler/passes/__tests__/pass6-port-contract.test.ts`
- [ ] Test: Block with correct port order compiles successfully
- [ ] Test: Block with mismatched input order throws `IRValidationFailed` with clear error message
- [ ] Test: Block with mismatched output order throws `IRValidationFailed` with clear error message
- [ ] Test: Block with `tags: { irPortContract: 'relaxed' }` skips validation and compiles
- [ ] Error messages include block type, instance ID, and specific mismatch details
- [ ] All tests pass with `just test`

### P2-3: Update Existing Tests for outputsById
- [ ] Update `src/editor/compiler/__tests__/signal-math.test.ts` to pass `inputsById` when calling `lower()`
- [ ] Add test verifying blocks return `outputsById` with correct port IDs
- [ ] Add test verifying Pass 6 correctly maps `outputsById` to positional outputs array
- [ ] Tests verify both legacy (positional) and new (keyed) patterns work
- [ ] All tests pass with `just test`
- [ ] Test coverage includes: only outputs, only outputsById, both (outputsById wins)

---

## P3 (Low) - Polish and Documentation

### P3-1: Create Port Catalogs for Math Blocks
- [ ] Create `ADD_SIGNAL_PORTS`, `MUL_SIGNAL_PORTS`, `SUB_SIGNAL_PORTS` in `portCatalog.ts`
- [ ] Each catalog uses `definePortCatalog` helper
- [ ] Update math block definitions to reference catalogs (like Oscillator does)
- [ ] Create `*_IR_INPUTS` and `*_IR_OUTPUTS` mappings for each (like oscillatorSpec.ts pattern)
- [ ] `just typecheck` and `just test` pass, runtime behavior unchanged
- [ ] Code reduction: eliminate duplicate port definitions

### P3-2: Document Migration Pattern
- [ ] Update `design-docs/_needs-review/Oscillator-Single-Source.md` with full migration example
- [ ] Document port catalog creation using `definePortCatalog` helper
- [ ] Document `inputsById` / `outputsById` usage in lowering functions
- [ ] Document strict-by-default contract and opt-out tag (`irPortContract: 'relaxed'`)
- [ ] Document legacy pattern (positional arrays) and migration path
- [ ] Include complete working example from one of the 4 reference blocks
- [ ] Document when to use `outputs: []` (empty) to signal full migration

---

## Sprint Scope

### This sprint delivers:
1. **Complete infrastructure** - outputsById support, definePortCatalog helper, strict-by-default
2. **4 fully migrated reference blocks** - Oscillator, AddSignal, MulSignal, SubSignal
3. **Test coverage** - Port catalog tests, contract enforcement tests, outputsById tests
4. **Documentation** - Migration pattern guide for future work

### Explicitly deferred:
- **P3-3: Migrate remaining 53 blocks** - Future sprint, requires 1-2 weeks dedicated effort

---

## Sprint Success Criteria

### Must Achieve (Sprint Cannot Close Without These)
- [ ] `just typecheck` passes with zero TypeScript errors
- [ ] `just test` passes with all tests succeeding
- [ ] All P0 items complete (blockers resolved)
- [ ] All P1 items complete (infrastructure ready)
- [ ] 4 reference blocks fully migrated and working

### Should Achieve (High Value, Defer Only If Critical Issues)
- [ ] All P2 items complete (test coverage)
- [ ] P3-1 complete (math block catalogs for consistency)

### Nice to Have (Defer If Time Constrained)
- [ ] P3-2 complete (documentation - can finish async)

---

## Verification Checklist

After completing all work, verify:

### Compilation and Tests
- [ ] `just typecheck` - Zero TypeScript errors
- [ ] `just test` - All tests pass
- [ ] `just build` - Production build succeeds
- [ ] `just check` - Full check passes (typecheck + lint + test)

### Code Quality
- [ ] No TODO comments added without corresponding tracking (use bd tool if needed)
- [ ] No console.log or debug code left in
- [ ] All new code follows existing patterns and style
- [ ] No dead code or commented-out blocks

### Migration Completeness
- [ ] 4 reference blocks use inputsById (no positional inputs[n])
- [ ] 4 reference blocks return outputsById (outputs: [] empty)
- [ ] OSCILLATOR_PORTS uses definePortCatalog helper
- [ ] Strict-by-default active (pass6-block-lowering.ts line 256 changed)
- [ ] Zero validation failures when strict-by-default active

### Test Coverage
- [ ] Port catalog helper has tests
- [ ] Port contract enforcement has tests
- [ ] outputsById path has tests
- [ ] All new tests pass and are meaningful (not tautological)

### Documentation
- [ ] Migration pattern documented (if P3-2 completed)
- [ ] Any architectural decisions documented in plan or design docs
- [ ] Blockers and open questions resolved or documented

---

## Post-Sprint Handoff

If migrating remaining 53 blocks in future sprint:

### Prerequisites Verified
- [ ] All P0, P1, P2 items from this sprint complete
- [ ] Migration pattern documented and proven stable
- [ ] No regression issues from this sprint's changes

### Recommended Approach
1. Review P3-2 documentation (migration pattern guide)
2. Pick one category (domain/rhythm/signal) to batch-migrate
3. Test thoroughly after each category before moving to next
4. Consider automating port catalog generation if pattern is repetitive

### Resources
- **Reference implementations**: Oscillator, AddSignal, MulSignal, SubSignal
- **Helper function**: `definePortCatalog` in `portCatalog.ts`
- **Test examples**: All P2 test suites
- **Documentation**: `Oscillator-Single-Source.md` (after P3-2)
