# Bus System Red Flags - Implementation Plan

**Topic**: bus-system-redflags
**Created**: 2025-12-28
**Source**: design-docs/implementation/compiler/Compiler-Audit-RedFlags-Bus-System.md

## Executive Summary

The audit identified 7 issues across Critical, High, and Medium severity levels affecting the bus compilation and runtime system. The core problems are:

1. **Event buses silently fail** - `world: 'event'` buses (like `pulse`) cannot be lowered to IR
2. **Runtime only handles numeric types** - vec2, color, and field buses fail at runtime
3. **Legacy vs IR behavior inconsistencies** - Same patch can behave differently depending on which path is used

## Issue Analysis

### Critical Issues

| Issue | Location | Impact | Complexity |
|-------|----------|--------|------------|
| Event buses not lowered to IR | pass7-bus-lowering.ts:231 | Reserved `pulse` bus fails silently | Medium |
| Bus evaluation only supports numbers | executeBusEval.ts:24 | Non-number buses produce incorrect results | Medium |

### High Issues

| Issue | Location | Impact | Complexity |
|-------|----------|--------|------------|
| Field combine only Field<number> | Materializer.ts:1202 | vec2/color field buses can't materialize | Medium |
| Legacy vs IR `layer` mode | busSemantics.ts:210 vs pass7-bus-lowering.ts:217 | Inconsistent behavior | Low |
| Bus defaults inconsistent | busSemantics.ts:170 vs pass7-bus-lowering.ts:231 | Same patch may fail in one mode but work in another | Low |

### Medium Issues

| Issue | Location | Impact | Complexity |
|-------|----------|--------|------------|
| Feature flag `busCompilation` unused | featureFlags.ts:27 | No way to disable bus compilation | Low |
| Combine-mode compatibility broader than runtime | busContracts.ts:49 | Valid definitions fail at runtime | Low |

## Implementation Strategy

### Phase 1: Documentation & Validation Alignment (Low Risk)

Before changing behavior, align validation with runtime reality.

**1.1 Tighten busContracts.ts validation**
- Remove `layer` from color/vec2 domains since runtime doesn't support it
- Emit compile-time errors for unsupported bus configurations
- Ensures users get clear errors instead of silent failures

**1.2 Wire the `busCompilation` feature flag**
- Add checks in compilation pipeline to use this flag
- Enables graceful fallback/testing during migration

### Phase 2: Event Bus Handling (Critical)

**2.1 Design decision needed: How should event buses behave in IR?**

Options:
- **A) Compile-time rejection**: Event buses are not supported in IR mode (explicit error)
- **B) Runtime event dispatch**: Emit special event-combine nodes that route through event system
- **C) Skip silently**: Continue current behavior but document it (NOT recommended)

*Recommendation*: Option A for initial release, evolve to Option B when event system is mature.

**2.2 Implement chosen approach**
- Update pass7-bus-lowering.ts to handle event world explicitly
- Update compiler validation to emit clear errors for event buses

### Phase 3: Multi-Type Support (High)

**3.1 Extend executeBusEval for vec2/color**
- Add type-aware value reading
- Implement per-type combine operations
- vec2: component-wise sum/average/min/max
- color: blend modes, layer compositing

**3.2 Extend Materializer.fillBufferCombine for non-number fields**
- vec2 fields: operate on pairs of floats
- color fields: operate on RGBA quadruples
- Align buffer layouts with type requirements

### Phase 4: Legacy/IR Consistency (High)

**4.1 Resolve `layer` mode handling**
- Either add `layer` support to busSemantics.ts for fields
- Or explicitly reject `layer` in both paths with compile error

**4.2 Unify default value handling**
- Ensure both paths produce identical defaults
- Add tests that verify cross-mode consistency


**5.1 Wire transform chains in pass7-bus-lowering.ts**

## Phased Rollout

| Phase | Description | Scope | Risk |
|-------|-------------|-------|------|
| 1 | Validation alignment | Contracts + flags | Low |
| 2 | Event bus handling | IR compilation | Medium |
| 3 | Multi-type support | Runtime | Medium |
| 4 | Legacy/IR consistency | Both paths | Low |

## Open Questions

1. **Should we support event buses in IR at all?** The current architecture treats events differently from signals/fields. Maybe event buses should only work in legacy mode until a proper event IR is designed.

2. **What's the priority of multi-type support?** If no current patches use vec2/color field buses, this could be deferred.

3. **Is there an existing adapter/lens IR representation?** If not, Phase 5 requires additional IR design work.

## Success Criteria

- [ ] No silent failures for any bus configuration
- [ ] Clear compile-time errors for unsupported configurations
- [ ] Identical behavior in legacy vs IR mode for all supported configurations
- [ ] All existing tests continue to pass
- [ ] New tests covering edge cases added

## Files to Modify

**Phase 1:**
- `src/editor/semantic/busContracts.ts` - Tighten combine mode compatibility
- `src/editor/compiler/featureFlags.ts` - No change needed (already wired, just needs usage)
- Compilation entry points - Check and use `busCompilation` flag

**Phase 2:**
- `src/editor/compiler/passes/pass7-bus-lowering.ts` - Handle event world

**Phase 3:**
- `src/editor/runtime/executor/steps/executeBusEval.ts` - Multi-type support
- `src/editor/runtime/field/Materializer.ts` - Non-number field combine

**Phase 4:**
- `src/editor/semantic/busSemantics.ts` - Unify layer mode handling
- Both lowering paths for default value consistency

**Phase 5:**
- `src/editor/compiler/passes/pass7-bus-lowering.ts` - Transform chain application
