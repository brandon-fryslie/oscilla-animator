# UI Refactor Prep - Sprint 2 Plan
**Topic**: Post Port-Identity Foundation Work
**Generated**: 2025-12-21-123509
**Source**: STATUS-2025-12-21.md, EVAL-*.md files in topic directory

**Sprint Scope**: 3 deliverables (2-3 significant items per sprint policy)

---

## Executive Summary

This sprint addresses **the critical blocker** (18 test failures) and completes **three near-complete foundation pieces** to 100% before UI refactor work can safely proceed.

### Sprint Goals
1. **BLOCKER**: Fix 18 test failures from Semantic Validator
2. **Complete Time Authority** (85% → 100%): Flip flag, remove fallbacks
3. **Create Bus Semantics Module** (40% → 80%): Unify ordering/combine logic

### Deferred to Future Sprints
- Shared Validation DiagnosticHub fix (trivial, non-blocking)
- Layout as Projection (requires stable foundation)
- Port Identity architectural pieces (composite boundaries, type resolution)
- Patch Operations/Transactions system (large effort)

---

## Dependencies

```
Port Identity Quick Fix ✅ (DONE)
         │
         ├──→ Fix Test Failures (P0) ──┐
         │                              │
         ├──→ Time Authority (85%)  ────┼──→ Sprint Ready
         │                              │
         └──→ Bus Semantics (40%)   ────┘
                    │
                    └──→ Future: Layout as Projection
                              Multi-UI Support
```

---

## P0: Fix 18 Test Failures (CRITICAL BLOCKER)

**Status**: Not Started | **Effort**: Small (2-4 hours) | **Dependencies**: None

### Spec Reference
- STATUS-port-identity-2025-12-21.md (lines 144-178)
- STATUS-2025-12-21.md (lines 19, 40-44)

### Description

The Semantic Validator (commit e4f3ee7) introduced 18 test failures in the PatchStore wire event system. These are NOT regressions from port identity work—they are caused by overly strict preflight validation blocking valid test connections.

**Root Cause**: `Validator.canAddConnection()` rejects connections that test code expects to succeed, preventing WireAdded/WireRemoved events from firing.

**Failing Test Categories**:
1. Wire event emission (8 failures) - WireAdded/WireRemoved not emitted
2. GraphCommitted events (7 failures) - bindingsChanged count wrong
3. BlockReplaced events (3 failures) - droppedConnections empty

**Evidence**: Tests passed at 738/738 before semantic validator commit, now 744/765 passing.

### Acceptance Criteria

- [ ] All 765 tests pass (`just test` shows 765/765 passing)
- [ ] WireAdded events emit when `connect()` succeeds (PatchStore.events.test.ts)
- [ ] GraphCommitted events report correct bindingsChanged count
- [ ] BlockReplaced events include droppedConnections when ports disappear
- [ ] Validator.canAddConnection() correctly identifies valid test connections
- [ ] No test uses `suppressValidation` flag as workaround (proper fix, not hack)

### Technical Notes

**Debugging Strategy**:
1. Run single failing test with verbose output: `just test src/editor/stores/__tests__/PatchStore.events.test.ts`
2. Log `patchDoc` structure passed to validator in PatchStore.ts:832
3. Verify slot IDs in test blocks match what validator expects
4. Check if validator uses correct PortRef format (`.slotId` not `.port`)
5. Compare block creation in tests vs production code

**Likely Fixes**:
- Option A: Validator incorrectly reads slot structures from `patchAdapter.ts`
- Option B: Test blocks need slot structure updates to match validator expectations
- Option C: Preflight validation too strict for test scenarios (add test-only relaxation)

**Files to Investigate**:
- `src/editor/semantic/validator.ts:476-514` (canAddConnection implementation)
- `src/editor/semantic/patchAdapter.ts:34-35` (slot ID mapping)
- `src/editor/stores/PatchStore.ts:830-842` (preflight validation call)
- `src/editor/stores/__tests__/PatchStore.events.test.ts` (failing tests)

---

## P0: Complete Time Authority (85% → 100%)

**Status**: Not Started | **Effort**: Small (1-2 hours) | **Dependencies**: Fix test failures first

### Spec Reference
- design-docs/10-Refactor-for-UI-prep/3-Time.md
- design-docs/10-Refactor-for-UI-prep/3.5-PhaseClock-Fix.md
- STATUS-time-authority-2025-12-21.md (lines 54-76)

### Description

Time authority core mechanics are complete and working (monotonic time, TimeRoot compilers, TimeModel inference). Two small gaps remain before enforcement:

**Gap 1**: `requireTimeRoot` flag is OFF (featureFlags.ts:52)
- Flag controls whether patches MUST have a TimeRoot block
- Currently defaulted to `false` for backward compatibility
- Validation exists but is disabled

**Gap 2**: Legacy inference fallbacks still active (compileBusAware.ts:782-804)
- Falls back to PhaseClock inference (lines 782-798)
- Falls back to PhaseMachine inference (lines 762-779)
- Defaults to infinite if nothing found (lines 801-804)
- Violates "single authority" principle from spec

### Acceptance Criteria

- [ ] `requireTimeRoot: true` in src/editor/compiler/featureFlags.ts (default for all patches)
- [ ] Legacy PhaseClock/PhaseMachine inference code deleted from compileBusAware.ts (lines 762-804)
- [ ] Patches without TimeRoot fail compilation with clear error (E_TIME_ROOT_MISSING)
- [ ] New patch creation auto-inserts default CycleTimeRoot (8s period)
- [ ] All tests pass (update 3 test files that disable flag to use TimeRoot blocks instead)
- [ ] Player.tick() still uses monotonic time for cyclic/infinite (no regression)
- [ ] TimeRoot derives phase via modulo (verify CycleTimeRoot compiler unchanged)

### Technical Notes

**Files to Change**:
1. `src/editor/compiler/featureFlags.ts:52`
   - Change: `requireTimeRoot: false` → `requireTimeRoot: true`

2. `src/editor/compiler/compileBusAware.ts:762-804`
   - Delete: PhaseClock inference block (lines 782-798)
   - Delete: PhaseMachine inference block (lines 762-779)
   - Delete: Default infinite fallback (lines 801-804)
   - Keep: TimeRoot-based inference only

3. `src/editor/stores/PatchStore.ts` (or initialization logic)
   - Add: Auto-insert CycleTimeRoot on new patch creation
   - Default params: `{ periodMs: 8000 }` (matches Golden Patch)

4. Test files to update (find with: `grep -r "requireTimeRoot: false" src/`)
   - Update to create TimeRoot blocks instead of disabling flag

**Validation Steps**:
1. Create new patch → verify CycleTimeRoot auto-inserted
2. Delete TimeRoot → compile → verify E_TIME_ROOT_MISSING error
3. Run `just test` → all pass
4. Load legacy patch file → migration path or clear error message

**Risk Mitigation**:
- Core mechanics already proven (commit 1857bb8 tested)
- Flag flip is compile-time constraint (no runtime risk)
- Tests guide migration (if test breaks, add TimeRoot to that test)

---

## P1: Create Bus Semantics Module (40% → 80%)

**Status**: Not Started | **Effort**: Medium (3-5 hours) | **Dependencies**: None

### Spec Reference
- design-docs/10-Refactor-for-UI-prep/1-Overview.md (Issue #5)
- design-docs/10-Refactor-for-UI-prep/7-PatchSemantics.md (Section 5.3)
- design-docs/3-Synthesized/03-Buses.md (Publisher Ordering)
- EVAL-bus-semantics-2025-12-21.md (lines 10-151)

### Description

**Critical divergence found**: Publisher ordering logic is DUPLICATED with DIFFERENT implementations:

**BusStore.ts (UI)**:
```typescript
getPublishersByBus(busId) {
  return publishers.filter(...).sort((a, b) => a.sortKey - b.sortKey);  // NO TIE-BREAKER
}
```

**compileBusAware.ts (Compiler)**:
```typescript
sortPublishers(publishers) {
  return publishers.sort((a, b) => {
    if (a.sortKey !== b.sortKey) return a.sortKey - b.sortKey;
    return a.id.localeCompare(b.id);  // HAS TIE-BREAKER
  });
}
```

**Impact**: When multiple publishers have the same sortKey, UI and runtime show DIFFERENT orderings → invisible non-determinism.

**Additional Issues**:
- Enabled/disabled filtering inconsistent (UI shows disabled, compiler ignores)
- Combine logic duplicated in compileBusAware.ts and FieldExpr.ts
- No single source of truth for bus evaluation semantics

### Acceptance Criteria

- [ ] New file created: `src/editor/semantic/busSemantics.ts`
- [ ] `getSortedPublishers(busId, allPublishers)` function with stable tie-breaker (sortKey → id.localeCompare)
- [ ] `combineSignalArtifacts(artifacts, mode, defaultValue)` function (modes: last, sum)
- [ ] `combineFieldArtifacts(artifacts, mode, defaultValue)` function (modes: last, sum, average, max, min)
- [ ] `validateCombineMode(bus)` function for mode/type compatibility
- [ ] BusStore.getPublishersByBus() uses busSemantics.getSortedPublishers() (identical sorting)
- [ ] compileBusAware.ts uses busSemantics functions (delete local implementations)
- [ ] Tests verify UI and compiler return identical ordering for same input
- [ ] Test for tie-breaker behavior (3 publishers with same sortKey → stable ordering)
- [ ] Test for enabled/disabled filtering consistency
- [ ] Documentation comment explaining "CRITICAL: Single source of truth for bus semantics"

### Technical Notes

**Implementation Pattern**:

1. **Create module** (`src/editor/semantic/busSemantics.ts`):
```typescript
/**
 * Canonical bus semantics - ONLY place bus logic lives.
 * Used by UI, compiler, and diagnostics for identical results.
 */

export function getSortedPublishers(
  busId: string,
  allPublishers: Publisher[],
  includeDisabled = false
): Publisher[] {
  const busPublishers = allPublishers.filter(p =>
    p.busId === busId && (includeDisabled || p.enabled)
  );
  return [...busPublishers].sort((a, b) => {
    if (a.sortKey !== b.sortKey) {
      return a.sortKey - b.sortKey;
    }
    return a.id.localeCompare(b.id);  // Stable tie-breaker
  });
}

export function combineSignalArtifacts(
  artifacts: Artifact[],
  mode: 'last' | 'sum',
  defaultValue: unknown
): Artifact {
  // Extract from compileBusAware.ts:101-194
}

export function combineFieldArtifacts(
  artifacts: Artifact[],
  mode: 'last' | 'sum' | 'average' | 'max' | 'min',
  defaultValue: unknown
): Artifact {
  // Extract from compileBusAware.ts:207-325
}
```

2. **Update BusStore.ts**:
```typescript
import { getSortedPublishers } from '../semantic/busSemantics';

getPublishersByBus(busId: string): Publisher[] {
  return getSortedPublishers(busId, this.publishers, false);
}
```

3. **Update compileBusAware.ts**:
```typescript
import { getSortedPublishers, combineSignalArtifacts, combineFieldArtifacts } from '../semantic/busSemantics';

// Delete sortPublishers() function (lines 83-91)
// Delete combineSignalArtifacts() function (lines 101-194)
// Delete combineFieldArtifacts() function (lines 207-325)

// Use imports instead
```

4. **Add tests** (`src/editor/semantic/__tests__/busSemantics.test.ts`):
```typescript
describe('getSortedPublishers', () => {
  it('sorts by sortKey ascending', () => { /* ... */ });
  it('uses id tie-breaker when sortKey equal', () => {
    const publishers = [
      { id: 'b', sortKey: 0, /* ... */ },
      { id: 'a', sortKey: 0, /* ... */ },
      { id: 'c', sortKey: 0, /* ... */ },
    ];
    const sorted = getSortedPublishers('bus1', publishers);
    expect(sorted.map(p => p.id)).toEqual(['a', 'b', 'c']);
  });
  it('filters disabled publishers by default', () => { /* ... */ });
});

describe('UI and Compiler consistency', () => {
  it('BusStore and compiler return identical ordering', () => {
    // Same publishers → getSortedPublishers → compare results
  });
});
```

**Files to Modify**:
- NEW: `src/editor/semantic/busSemantics.ts` (~200 lines)
- NEW: `src/editor/semantic/__tests__/busSemantics.test.ts` (~150 lines)
- MODIFY: `src/editor/stores/BusStore.ts:499-503` (use busSemantics)
- MODIFY: `src/editor/compiler/compileBusAware.ts` (delete 200+ lines, import instead)
- REVIEW: `src/editor/compiler/unified/FieldExpr.ts:300-329` (decide if needs unification)

**Risk Assessment**:
- **Risk**: Medium (touching evaluation logic)
- **Mitigation**: Existing tests prove individual implementations work; new tests verify consistency
- **Benefit**: Critical for multi-UI, prevents invisible non-determinism

---

## Deferred Work (Future Sprints)

### Shared Validation: DiagnosticHub Integration (95% → 100%)

**Why Deferred**: Non-blocking, trivial fix (30 min), low impact

**Gap**: DiagnosticHub.runAuthoringValidators() manually checks TimeRoot instead of calling Validator.validateAll()

**Impact**: LogWindow only shows TimeRoot errors in authoring domain, not all validation errors

**Fix**: 10 lines in DiagnosticHub.ts:297-329
```typescript
private runAuthoringValidators(patchRevision: number): Diagnostic[] {
  const patchDoc = storeToPatchDocument(this.root);
  const validator = new Validator(patchDoc, patchRevision);
  const result = validator.validateAll(patchDoc);
  return [...result.errors, ...result.warnings];
}
```

**Complexity**: Low (30 minutes)

**Source**: EVAL-shared-validation-2025-12-21.md (lines 144-178, 286-310)

---

### Layout as Projection (0% → Phase 1)

**Why Deferred**: Requires stable foundation (port identity, time authority, bus semantics)

**Problem**: Lanes embedded in patch semantics instead of UI projections
- `PatchStore.lanes` with `blockIds` arrays
- Lanes serialized in patch files
- `advancedLaneMode` stored in patch settings

**Fix Required**:
1. Create ViewStateStore (migrate UI state out of patch)
2. Make lane assignment computed (from block semantics)
3. Remove lanes from PatchDocument (breaking change)

**Complexity**: Medium (6-10 hours)

**Source**: STATUS-2025-12-21.md (lines 81-105)

---

### Port Identity: Architectural Foundation (0%)

**Why Deferred**: Quick fix complete, arch pieces need dedicated sprint

**Remaining Work**:
- Composite port maps and boundary enforcement
- Type-based port resolution (match by compatibility, not just string ID)
- Stable slotId versioning system
- Two-phase compilation model

**Complexity**: Large (12-20 hours across multiple features)

**Source**: STATUS-port-identity-2025-12-21.md (lines 107-141)

---

### Patch Operations & Transactions System (15% → 100%)

**Why Deferred**: Large effort, requires stable semantic foundation

**Missing Components** (85%):
- Transaction builder API (0%)
- Operation types and apply/invert (0%)
- TxView query surface (0%)
- History tree persistence (0%)
- PatchStore migration to use ops (0%)

**Complexity**: Very Large (12-17 days complexity estimate)

**Source**: STATUS-2025-12-21.md (lines 179-212)

---

## Test Coverage Requirements

### P0: Test Failure Fix
- All existing tests pass (765/765)
- No new tests required (fixing existing test infrastructure)

### P0: Time Authority
- Existing TimeRoot tests continue passing
- Add test: Patch without TimeRoot fails with E_TIME_ROOT_MISSING
- Add test: New patch auto-inserts CycleTimeRoot
- Update 3 test files that disable requireTimeRoot flag

### P1: Bus Semantics
- New test file: `busSemantics.test.ts`
- Test: getSortedPublishers sorts by sortKey ascending
- Test: getSortedPublishers uses id tie-breaker
- Test: Disabled publishers filtered correctly
- Test: BusStore and compiler return identical ordering (cross-layer consistency)
- Test: combineSignalArtifacts matches expected values
- Test: combineFieldArtifacts matches expected values

---

## Success Criteria (Sprint Complete When...)

1. **All tests pass**: `just test` shows 765/765 passing
2. **Time authority enforced**: Patches require TimeRoot, no legacy fallbacks
3. **Bus semantics unified**: UI and compiler use identical ordering/combine logic
4. **No regressions**: Existing animations work identically
5. **Clear errors**: Compilation failures have actionable messages
6. **Documentation updated**: Comments explain architectural decisions

---

## Risk Mitigation

### Test Failures (P0)
- **Risk**: Validator changes break more things
- **Mitigation**: Debug single test first, verify fix before applying broadly
- **Rollback**: Revert to commit before e4f3ee7 if unfixable

### Time Authority (P0)
- **Risk**: Breaking change for legacy patches
- **Mitigation**: Auto-insert TimeRoot on load, clear error messages
- **Rollback**: Feature flag allows quick disable if needed

### Bus Semantics (P1)
- **Risk**: Changing evaluation order breaks existing animations
- **Mitigation**: Extract exact logic from compiler, add extensive tests
- **Rollback**: Module is isolated, easy to revert if issues found

---

## Estimated Complexity

| Deliverable | Complexity | Effort Hours |
|-------------|------------|--------------|
| Fix Test Failures | Small | 2-4 |
| Complete Time Authority | Small | 1-2 |
| Create Bus Semantics Module | Medium | 3-5 |
| **Total Sprint** | **Medium** | **6-11** |

**Sprint Scope Validation**: 3 deliverables, medium complexity, aligns with 2-3 significant items policy.

---

## Files Modified (Summary)

### New Files
- `.agent_planning/ui-refactor-prep/PLAN-2025-12-21-123509.md`
- `.agent_planning/ui-refactor-prep/DOD-2025-12-21-123509.md`
- `src/editor/semantic/busSemantics.ts`
- `src/editor/semantic/__tests__/busSemantics.test.ts`

### Modified Files
- `src/editor/semantic/validator.ts` (fix canAddConnection)
- `src/editor/semantic/patchAdapter.ts` (potential slot mapping fix)
- `src/editor/stores/PatchStore.ts` (preflight validation + auto-insert TimeRoot)
- `src/editor/compiler/featureFlags.ts` (flip requireTimeRoot flag)
- `src/editor/compiler/compileBusAware.ts` (delete legacy fallbacks + use busSemantics)
- `src/editor/stores/BusStore.ts` (use busSemantics.getSortedPublishers)
- Test files that disable requireTimeRoot flag (3 files, add TimeRoot blocks)

---

## Next Steps After Sprint

1. **Verify foundations stable**: Run extended manual testing
2. **Layout as Projection Phase 1**: Create ViewStateStore
3. **Shared Validation DiagnosticHub**: Quick 30-min fix
4. **Port Identity Arch Phase 1**: Composite port maps
5. **Begin Multi-UI exploration**: With stable bus semantics and layout projection

---

**Plan Complete** | status-planner | 2025-12-21-123509
