# WP2 Bus-Aware Compiler - Cleanup Plan

**Generated**: 2025-12-21-151654
**Source**: STATUS-2025-12-21-133500.md
**Topic**: wp2-bus-aware-compiler

---

## Executive Summary

WP2 Bus-Aware Compiler is **90-95% complete**. The core implementation (bus-aware compilation pipeline, lens system, deterministic publisher ordering, bus combination semantics) is fully functional with 797/800 tests passing (99.6%).

**Remaining Work**: Documentation cleanup to remove obsolete "UiSignalBindings" concept and fix 3 minor test expectation failures. Total estimated effort: **2-3 hours**.

**Current State Per STATUS**:
- Bus-aware compilation pipeline: COMPLETE (673 lines, compileBusAware.ts)
- Lens system: COMPLETE (506 lines, 55 passing tests)
- Bus semantics module: COMPLETE (canonical ordering/combination logic)
- Type validation: COMPLETE (TypeDesc enforcement)
- Test coverage: EXCELLENT (99.6% pass rate)

**Critical Finding**: The spec mentions "UiSignalBindings" as a WP2 deliverable, but per user specification this was an **obsolete pre-bus mechanism**. The current architecture correctly uses:
- BusStore with publishers/listeners
- Lens stacks for transformation
- `CompileResult.compiledPortMap` for UI introspection (not a separate binding system)

**No blockers for WP3** - bus-aware compilation works correctly end-to-end.

---

## Gap Analysis

### Documentation vs Implementation Mismatch

**Spec References to Remove**:
1. `design-docs/3-Synthesized/03-Buses.md` lines 115-137 - `UiSignalBindings` interface definition
2. `design-docs/3-Synthesized/05-Compilation.md` line 36 - `uiBindings: UiSignalBindings` in CompiledProgram
3. `design-docs/3-Synthesized/06-Runtime.md` line 94 - Reference to `UiSignalBindings.buses.pulse`
4. `design-docs/3-Synthesized/11-Roadmap.md` line 48 - "Compiler outputs timeModel + UiSignalBindings"
5. `design-docs/3-Synthesized/11-Roadmap.md` line 77 - "UiSignalBindings uses bus IDs, not ports"

**Replacement Pattern**:
- Where spec says "UiSignalBindings" → explain UI uses `BusStore` directly + `CompileResult.compiledPortMap`
- Clarify that UI controls publish to buses like any other publisher (no special binding system)
- Document that TimeModel is in `CompileResult.timeModel` (already implemented)

### Test Expectation Failures

**From STATUS Section**: 3 test failures (lines 41-47)

1. `composite-library.test.ts` - `breathingDots` macro structure expects `publishers` field
2. `composite-library.test.ts` - `goldenPatch` macro structure expects `CycleTimeRoot` block
3. `macro-validation.test.ts` - `goldenPatch` bus publication expects phaseA/pulse/energy buses

**Root Cause**: Tests written against old macro definitions that have since evolved.

### Terminology Consistency (Minor)

**From STATUS Ambiguity #2** (lines 312-329):
- Spec: `design-docs/3-Synthesized/04-Adapters.md` uses "Adapter"
- Code: Uses "Lens" (lenses.ts, LensDefinition, applyLens)
- Types: Have both `adapterChain` (legacy) and `lens`/`lensStack` (current)

**Decision**: Standardize on "Lens" (matches implementation, clearer naming).

---

## Prioritized Backlog

## [P0] Remove UiSignalBindings from Spec Docs

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: None
**Spec Reference**: 03-Buses.md, 05-Compilation.md, 06-Runtime.md, 11-Roadmap.md • **Status Reference**: STATUS-2025-12-21-133500.md lines 285-308

### Description

Remove all references to the obsolete "UiSignalBindings" concept from design documentation. This was a pre-bus mechanism where UI controls directly injected signals. Current architecture uses BusStore with publishers/listeners + lens stacks instead.

**Why This Matters**: Spec-code alignment. UiSignalBindings does not exist in codebase (grep returns zero results in src/) and was replaced by:
1. UI controls publish to buses (via BusStore.publishers)
2. UI reads bus values via `CompileResult.compiledPortMap`
3. TimeModel exposed via `CompileResult.timeModel`

### Acceptance Criteria

- [ ] Remove `UiSignalBindings` interface definition from `design-docs/3-Synthesized/03-Buses.md` (lines 115-137)
- [ ] Update `CompiledProgram` interface in `design-docs/3-Synthesized/05-Compilation.md` to remove `uiBindings` field (line 36)
- [ ] Replace with explanation: "UI introspects via CompileResult.compiledPortMap and reads bus values directly from BusStore"
- [ ] Remove reference in `design-docs/3-Synthesized/06-Runtime.md` line 94, replace with "pulse bus exists in BusStore"
- [ ] Update WP1 deliverables in `design-docs/3-Synthesized/11-Roadmap.md` line 48 to say "Compiler outputs TimeModel" (already done)
- [ ] Update WP2 deliverables in `design-docs/3-Synthesized/11-Roadmap.md` line 77 to remove UiSignalBindings reference
- [ ] Add clarifying section in 03-Buses.md: "UI Integration" explaining BusStore + compiledPortMap pattern
- [ ] Grep confirms zero remaining "UiSignalBindings" references in design-docs/3-Synthesized/

### Technical Notes

**Files to Edit**:
- `design-docs/3-Synthesized/03-Buses.md`
- `design-docs/3-Synthesized/05-Compilation.md`
- `design-docs/3-Synthesized/06-Runtime.md`
- `design-docs/3-Synthesized/11-Roadmap.md`

**Replacement Text Pattern**:
```markdown
## UI Integration

The UI layer interacts with compiled patches via:

1. **BusStore**: Direct access to bus registry, publishers, listeners
   - UI controls can publish to buses like any other publisher
   - Lens stacks transform published values

2. **CompileResult.compiledPortMap**: Map<PortRef, Artifact>
   - UI scopes/meters read compiled artifact values
   - Allows introspection of any block output port

3. **CompileResult.timeModel**: TimeModel
   - Drives Time Console UI (Finite/Cycle/Infinite modes)
   - Player transport configuration

No special "UI bindings" are needed - the bus system is the universal integration layer.
```

**Do NOT**:
- Remove concept from older design-docs/2-TimeRoot/ directory (historical archive)
- Add new code - this is spec cleanup only

---

## [P1] Fix Macro Test Expectations

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: None
**Spec Reference**: N/A (test maintenance) • **Status Reference**: STATUS-2025-12-21-133500.md lines 41-47

### Description

Update test expectations in composite-library.test.ts and macro-validation.test.ts to match current macro definitions in MACRO_REGISTRY. Tests are failing because they expect macro structure that has changed during implementation.

**Why This Matters**: Achieve 100% test pass rate (currently 99.6%). These are not runtime bugs - just stale test expectations.

### Acceptance Criteria

- [ ] Inspect `src/editor/macros.ts` MACRO_REGISTRY for `breathingDots` and `goldenPatch` actual structure
- [ ] Update `src/editor/__tests__/composite-library.test.ts` breathingDots test (line ~400) to match actual publishers field
- [ ] Update `src/editor/__tests__/composite-library.test.ts` goldenPatch test (line ~414) to match actual block list
- [ ] Update `src/editor/__tests__/macro-validation.test.ts` goldenPatch test (line ~204) to match actual bus publications
- [ ] Run `just test` - all 800 tests pass (100%)
- [ ] Document any intentional changes to macro definitions in test comments

### Technical Notes

**Investigation Steps**:
1. Read `src/editor/macros.ts` - find `MACRO_REGISTRY['macro:breathingDots']` and `MACRO_REGISTRY['macro:goldenPatch']`
2. Note actual structure: blocks array, publishers array, connections array
3. Update test expectations to match

**Likely Issues**:
- `publishers` field might be empty array vs undefined
- `goldenPatch` might have different TimeRoot type (Cycle vs Finite)
- Bus names might be phaseA vs phase

**Files to Edit**:
- `src/editor/__tests__/composite-library.test.ts`
- `src/editor/__tests__/macro-validation.test.ts`

---

## [P2] Standardize Lens Terminology in Spec

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: None
**Spec Reference**: 04-Adapters.md • **Status Reference**: STATUS-2025-12-21-133500.md lines 312-329

### Description

Update `design-docs/3-Synthesized/04-Adapters.md` to use "Lens" terminology consistently, matching the implementation. Currently spec uses "Adapter" as primary term with "Lens" as alias, but code settled on "Lens" everywhere.

**Why This Matters**: Spec-code terminology alignment. Reduces confusion for future implementers.

### Acceptance Criteria

- [ ] Rename `design-docs/3-Synthesized/04-Adapters.md` → `design-docs/3-Synthesized/04-Lenses.md`
- [ ] Update document title to "Lenses (Type Adapters)"
- [ ] Replace all instances of "Adapter" → "Lens" in body text (except historical context)
- [ ] Add note: "Previously called 'Adapters' in early design docs - implementation uses 'Lens' terminology"
- [ ] Update cross-references in other spec docs (03-Buses.md, 11-Roadmap.md) to use "Lens" terminology
- [ ] Types retain both `adapterChain` (legacy field) and `lensStack` (current) for backward compatibility - document this
- [ ] Grep confirms spec uses "Lens" as primary term, "Adapter" only in historical notes

### Technical Notes

**Key Points to Preserve**:
- The CONCEPT is unchanged (type transformation in bus flow)
- Implementation uses: `LensDefinition`, `applyLens()`, `lensStack`
- Legacy `adapterChain` field exists for backward compatibility but should be deprecated in docs

**Files to Modify**:
- `design-docs/3-Synthesized/04-Adapters.md` (rename + rewrite)
- `design-docs/3-Synthesized/03-Buses.md` (update cross-refs)
- `design-docs/3-Synthesized/11-Roadmap.md` (update WP2 deliverable text)

**Search/Replace Pattern**:
- "Adapter library" → "Lens library"
- "AdapterStep" → "Lens" (but note legacy type exists)
- "adapter chain" → "lens stack"

---

## [P3] Add UIControlPublisher Documentation (Optional)

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P0 (remove UiSignalBindings first)
**Spec Reference**: 03-Buses.md, 07-UI-Spec.md • **Status Reference**: N/A (user-specified clarification)

### Description

Document how UI controls (sliders, knobs, toggles) publish to buses. This is the REPLACEMENT for the obsolete "UiSignalBindings" concept. Clarify that UI controls are just privileged publishers with special UX.

**Why This Matters**: Fills documentation gap left by removing UiSignalBindings. Makes clear how user interaction flows into the patch.

### Acceptance Criteria

- [ ] Add section to `design-docs/3-Synthesized/03-Buses.md`: "UI Control Publishers"
- [ ] Explain: UI controls create BusPublisher records like any other publisher
- [ ] Document: UI controls have `sortKey = -1000` (high priority) so they override default sources
- [ ] Show example: User drags slider → publishes to "energy" bus → all listeners receive value via lens stack
- [ ] Clarify: No special "binding" system needed - unified bus architecture
- [ ] Link to `design-docs/3-Synthesized/07-UI-Spec.md` for UI control widget specs
- [ ] Add design note: Why UI-as-publisher is better than separate binding layer (consistency, introspection, undo/redo)

### Technical Notes

**Conceptual Model**:
```
UI Slider (user drags)
  ↓
BusStore.createPublisher({ blockId: 'ui-control-1', fromSlot: 'value', busId: 'energy', sortKey: -1000 })
  ↓
Bus compilation: UI publisher has highest priority (sortKey -1000)
  ↓
Listeners receive UI value via lens stack
  ↓
Runtime: slider changes propagate like any other publisher change
```

**Key Insight**: UI controls are NOT special - they're just publishers with:
1. Negative sortKey (high priority)
2. User-editable (vs block-generated)
3. Direct manipulation UX

**Files to Edit**:
- `design-docs/3-Synthesized/03-Buses.md` (new section)
- Possibly `design-docs/3-Synthesized/07-UI-Spec.md` (cross-reference)

---

## Dependency Graph

```
P0 (Remove UiSignalBindings) ← No dependencies
  ↓
P3 (Add UIControlPublisher docs) ← Optional, depends on P0

P1 (Fix macro tests) ← Independent

P2 (Standardize Lens terminology) ← Independent
```

**Recommended Execution Order**:
1. P1 (Fix tests - quick win, 100% pass rate)
2. P0 (Remove UiSignalBindings - core cleanup)
3. P2 (Lens terminology - polish)
4. P3 (UIControlPublisher docs - optional enhancement)

---

## Sprint Planning

### Sprint 1: Core Cleanup (2-3 hours)

**Goal**: Remove obsolete UiSignalBindings concept, achieve 100% test pass

**Items**:
- P1: Fix macro test expectations (30 min)
- P0: Remove UiSignalBindings from specs (1-2 hours)

**Acceptance**:
- All 800 tests pass
- Zero "UiSignalBindings" references in design-docs/3-Synthesized/

### Sprint 2: Polish (1-2 hours, optional)

**Goal**: Terminology alignment and enhanced documentation

**Items**:
- P2: Standardize Lens terminology (30 min)
- P3: Add UIControlPublisher documentation (1 hour)

**Acceptance**:
- Spec uses "Lens" as primary term
- UI control integration pattern documented

---

## Risk Assessment

### Low Risk Items
- **P1 (Fix macro tests)**: Test-only changes, no production code impact
- **P2 (Lens terminology)**: Documentation-only, no code changes
- **P0 (Remove UiSignalBindings)**: Documentation-only, concept never implemented

### No High-Risk Items
All remaining work is documentation cleanup. The bus-aware compiler implementation is complete and tested.

### Uncertainty Items
None. STATUS report confirms 99.6% test pass rate and all core functionality working.

---

## Definition of Done (WP2 Complete)

WP2 is **COMPLETE** when:

1. **Documentation Cleanup**:
   - [ ] Zero references to "UiSignalBindings" in design-docs/3-Synthesized/
   - [ ] Spec explains UI integration via BusStore + compiledPortMap
   - [ ] Lens terminology standardized (spec matches implementation)

2. **Test Quality**:
   - [ ] 100% test pass rate (800/800 tests)
   - [ ] All bus-compilation.test.ts tests passing (already done)
   - [ ] All lenses.test.ts tests passing (already done)
   - [ ] Macro tests match current macro definitions

3. **Core Functionality** (already complete per STATUS):
   - [x] Bus-aware compilation pipeline works end-to-end
   - [x] Deterministic publisher ordering (busSemantics module)
   - [x] Bus combination semantics (last, sum, average, max, min)
   - [x] Lens stack application in listeners
   - [x] Topological sort with bus dependencies
   - [x] Type validation (TypeDesc enforcement)

4. **WP3 Readiness**:
   - [ ] No blockers for field compilation work
   - [ ] Spec-code alignment sufficient for next phase

**Estimated Total Effort**: 2-3 hours (mostly P0 + P1)

---

## Files Referenced

### Implementation (Complete, No Changes Needed)
- `src/editor/compiler/compileBusAware.ts` (673 lines) - Bus-aware compilation
- `src/editor/lenses.ts` (506 lines) - Lens library
- `src/editor/semantic/busSemantics.ts` (200+ lines) - Canonical bus logic
- `src/editor/compiler/types.ts` - CompileResult interface (has compiledPortMap, no uiBindings)

### Tests (Need Fixes - P1)
- `src/editor/__tests__/composite-library.test.ts` (2 failures)
- `src/editor/__tests__/macro-validation.test.ts` (1 failure)

### Specs (Need Cleanup - P0, P2, P3)
- `design-docs/3-Synthesized/03-Buses.md` - Remove UiSignalBindings interface
- `design-docs/3-Synthesized/04-Adapters.md` - Rename to Lenses, update terminology
- `design-docs/3-Synthesized/05-Compilation.md` - Update CompiledProgram interface
- `design-docs/3-Synthesized/06-Runtime.md` - Remove UiSignalBindings reference
- `design-docs/3-Synthesized/11-Roadmap.md` - Update WP1/WP2 deliverables

---

## Recommendations

### Immediate Next Steps (after WP2 cleanup)

1. **WP3: Field Compilation** - STATUS confirms field bus compilation already works (8 tests passing), so WP3 may just need Golden Patch validation
2. **WP1 Completion** - TimeRoot compiler implementation + Player rewrite (higher priority than WP3)
3. **WP0 Validation** - Reserved bus enforcement, TypeDesc validation (foundational contracts)

### Long-term Maintenance

- Keep spec-code terminology aligned (use "Lens" consistently)
- Treat `design-docs/3-Synthesized/` as authoritative (update when implementation deviates)
- Consider adding spec-code alignment check to CI (grep for obsolete terms)

---

## Provenance

**Source Evaluation**: STATUS-2025-12-21-133500.md (FRESH, 476 lines)
**Planner**: status-planner
**Generated**: 2025-12-21-151654
**Scope**: WP2 Bus-Aware Compiler completion (documentation cleanup phase)
