# Definition of Done: Graph Normalization Layer

**Generated**: 2026-01-03-121815
**Plan**: PLAN-2026-01-03-121815.md
**Sprint Goal**: RawGraph/NormalizedGraph separation with eager normalization

---

## Acceptance Criteria

### Deliverable 1: Type System Foundation

- [ ] Create `src/editor/graph/types.ts` with RawGraph, NormalizedGraph, Anchor, StructuralMapping interfaces
- [ ] RawGraph contains: blocks (user only), edges (user only), attachments (default sources only - no wire-state)
- [ ] NormalizedGraph contains: blocks (user + structural), edges (user + structural), mapping (no attachments)
- [ ] Anchor type supports `{ kind: "defaultSource"; blockId: string; port: PortRef; direction: "in" | "out" }`
- [ ] StructuralMapping interface defines `anchorToIds: Map<>` and `idToAnchor: Map<>` bidirectional maps
- [ ] Add `role?: EdgeRole` field to Edge type in `src/editor/types.ts` where EdgeRole = "user" | "structural"
- [ ] DefaultSourceAttachment interface in types.ts for RawGraph attachments
- [ ] All types compile without errors (`just typecheck`)

### Deliverable 2: GraphNormalizer Module

- [ ] Create `src/editor/graph/GraphNormalizer.ts` with pure function `normalize(raw: RawGraph): NormalizedGraph`
- [ ] Migrate default source materialization logic from `src/editor/compiler/passes/pass0-materialize.ts` to GraphNormalizer
- [ ] GraphNormalizer creates provider blocks (DSConstSignalFloat, DomainN, etc.) for unconnected inputs
- [ ] GraphNormalizer generates deterministic IDs using `generateProviderId(blockId, slotId)` pattern (simple string concatenation)
- [ ] GraphNormalizer produces StructuralMapping with anchor-to-ID and ID-to-anchor bidirectional lookup
- [ ] All generated blocks have `role: "structural"` metadata
- [ ] All generated edges have `role: "structural"` metadata
- [ ] GraphNormalizer is pure: no mutations, no side effects, no global state access
- [ ] Helper functions migrated: `selectProviderType()`, `isInputDriven()`, `generateProviderId()`, `buildProviderParams()`
- [ ] Unit test: `normalize(raw)` returns identical output for identical inputs (determinism test)
- [ ] Unit test: Moving a block doesn't change its provider IDs (anchor stability test)
- [ ] Unit test: StructuralMapping bidirectional lookups work correctly (anchor ↔ ID)

### Deliverable 3: PatchStore Integration

- [ ] PatchStore internally maintains RawGraph representation (filter structural artifacts from current Patch)
- [ ] Add `PatchStore.getNormalizedGraph()` method that returns cached NormalizedGraph
- [ ] Cache invalidates when RawGraph changes: `addBlock()`, `connect()`, `deleteBlock()`, `disconnect()` all invalidate
- [ ] Compiler integration point calls `getNormalizedGraph()` instead of reading Patch directly
- [ ] Remove `src/editor/compiler/passes/pass0-materialize.ts` from compiler pipeline (or comment out)
- [ ] Update compiler pass chain: pass1-normalize receives NormalizedGraph (already has providers)
- [ ] Undo/redo operates on RawGraph only (structural artifacts regenerate automatically)
- [ ] All existing tests pass after integration (`just test`)
- [ ] Integration test: Create block with unwired input, verify provider block appears in compiled graph
- [ ] Integration test: Undo/redo preserves default source behavior (provider disappears/reappears with same ID)
- [ ] Manual test (Chrome DevTools MCP): Create Oscillator, leave `freq` unwired, inspect compiled graph, verify DSConstSignalFloat provider exists
- [ ] Manual test: Verify provider edge connects to unwired input
- [ ] Manual test: Verify structural blocks/edges have `role: "structural"` metadata

---

## Sprint Scope

This sprint delivers:
1. **Type system** for RawGraph/NormalizedGraph separation
2. **GraphNormalizer module** (pure editor-layer normalization function)
3. **PatchStore integration** (compiler receives NormalizedGraph, not RawGraph)

**Deferred** (out of scope per user clarifications):
- Wire-state blocks (removed from scope entirely)
- Bus junction normalization (buses are user-created, not structural)
- Incremental normalization (optimization - full normalization is fast enough)
- Cryptographic hash IDs (simple string concatenation sufficient)

---

## Validation Checklist

### Type System
- [ ] TypeScript compilation succeeds (`just typecheck`)
- [ ] No type errors in new `src/editor/graph/` module
- [ ] Edge.role field correctly typed as optional union `"user" | "structural"`
- [ ] RawGraph/NormalizedGraph types are distinct (not aliases)

### GraphNormalizer
- [ ] Determinism test passes: same input → same output (deep equality)
- [ ] ID stability test passes: anchor-based IDs don't change when blocks move
- [ ] Mapping test passes: bidirectional anchor ↔ ID lookup works correctly
- [ ] Provider selection logic correct (DSConstSignalFloat, DomainN, etc.)
- [ ] All provider blocks have valid params (DomainN gets `{ n, seed }`, DSConst* gets `{ value }`)

### Integration
- [ ] All existing unit tests pass (`just test`)
- [ ] Compiler receives NormalizedGraph (verified in debugger or logs)
- [ ] `pass0-materialize.ts` deleted or commented out (not in compiler pipeline)
- [ ] Undo/redo doesn't leak structural artifacts into history stack
- [ ] Existing patches load correctly (backward compatibility preserved)
- [ ] No regression: default sources still work as before

### Manual Testing (Required)
- [ ] Create Oscillator block, leave `freq` unwired → provider block appears in compiled graph
- [ ] Inspect compiled graph in Chrome DevTools → structural blocks have `role: "structural"`
- [ ] Inspect compiled graph → structural edges have `role: "structural"`
- [ ] Undo adding a block → provider disappears from normalized graph
- [ ] Redo → provider reappears with same ID (anchor stability)
- [ ] Load old patch file → normalizes correctly without errors

---

## Performance Requirements

- [ ] Normalization completes in <50ms for typical patch (10-20 blocks)
- [ ] Normalization completes in <200ms for large patch (100 blocks)
- [ ] No observable UI lag when editing (eager normalization is acceptable)
- [ ] Cache prevents redundant normalization during same frame

---

## Documentation Requirements

- [ ] Inline comments explain RawGraph vs NormalizedGraph distinction
- [ ] JSDoc comments on `normalize()` function explain pure transformation
- [ ] JSDoc comments on `getNormalizedGraph()` explain caching strategy
- [ ] Comment explaining eager normalization: "Recomputes on every RawGraph mutation, cached until next edit"
- [ ] Comment explaining anchor-based IDs: "Deterministic from structure, not creation order"

---

## Blockers and Known Issues

**RESOLVED** - All ambiguities clarified by user:
- ✓ Eager normalization (not lazy)
- ✓ No wire-state blocks (removed from scope)
- ✓ Simple string concatenation IDs (no cryptographic hashing)
- ✓ BusBlocks are user-created (normalization doesn't create buses)
- ✓ Undo/redo operates on RawGraph only

**No current blockers.**

---

## Success Criteria

Sprint **succeeds** if:
1. All acceptance criteria checkboxes above are checked
2. `just check` passes (typecheck + lint + test)
3. Manual testing confirms default sources work correctly
4. Compiler receives NormalizedGraph (verified in DevTools)
5. No regressions: existing patches compile identically

Sprint **fails** if:
- Default sources stop working (regression in existing functionality)
- Existing patches don't load correctly (breaking change)
- Normalization is non-deterministic (same input produces different outputs)
- Structural artifacts leak into undo history (architecture violation)
- Performance degrades (>200ms normalization for large patches)

---

## Files Modified/Created

### New Files
- `src/editor/graph/types.ts` (RawGraph, NormalizedGraph, Anchor, StructuralMapping)
- `src/editor/graph/GraphNormalizer.ts` (normalize function + helpers)
- `src/editor/graph/index.ts` (module exports)

### Modified Files
- `src/editor/types.ts` (add `role?: "user" | "structural"` to Edge interface)
- `src/editor/stores/PatchStore.ts` (add getNormalizedGraph(), cache invalidation)
- `src/editor/compiler/index.ts` (call getNormalizedGraph() instead of reading Patch)

### Deleted Files
- `src/editor/compiler/passes/pass0-materialize.ts` (logic migrated to GraphNormalizer)

---

## Test Coverage Requirements

### Unit Tests (GraphNormalizer)
- Determinism: `normalize(raw)` is idempotent
- ID stability: Anchor-based IDs don't change when blocks move
- Mapping correctness: Bidirectional lookups work
- Provider selection: Correct block types for each world+domain
- Purity: No mutations of input RawGraph

### Integration Tests (PatchStore)
- Cache invalidation: getNormalizedGraph() recomputes after mutations
- Compiler integration: Compiled graph contains structural artifacts
- Undo/redo: RawGraph-only operations regenerate structural artifacts

### Manual Tests (Chrome DevTools MCP)
- Visual verification: Provider blocks appear for unwired inputs
- Role metadata: Structural artifacts tagged correctly
- Undo/redo: Provider IDs stable across undo/redo cycles
