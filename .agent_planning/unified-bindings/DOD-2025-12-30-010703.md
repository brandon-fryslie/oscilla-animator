# Definition of Done: Unified Bindings UI Architecture Refactor
Generated: 2025-12-30-010703
Plan: PLAN-2025-12-30-010703.md

## Sprint 1: Binding Facade Foundation

**This sprint delivers**: Core binding abstraction (types, read facade, write facade)
**Deferred**: All UI changes (handled in Sprint 2-3)

### Deliverable: Binding Types Module
- [ ] File `src/editor/bindings/types.ts` exists
- [ ] `BindingKind` type defined: `'wire' | 'publisher' | 'listener'`
- [ ] `BindingRef` discriminated union defined with `kind` and `id` fields
- [ ] `EndpointRef` discriminated union defined for port vs bus endpoints
- [ ] `NormalizedBinding` defined with NO optional fields for all three variants (wire/publisher/listener)
- [ ] `ResolvedPortEndpoint` defined with block, slot, typeDesc fields
- [ ] `ResolvedBusEndpoint` defined with bus, typeDesc fields
- [ ] `ResolvedEndpoint` union type defined
- [ ] `ResolvedBinding` defined as success (binding + endpoints) or error variant

### Deliverable: Binding Read Facade
- [ ] File `src/editor/bindings/read.ts` exists
- [ ] `resolveBinding(root, ref)` function implemented
  - [ ] Returns `ResolvedBinding` with success (binding + from + to endpoints) or error
  - [ ] Handles wire kind: looks up in patchStore.connections
  - [ ] Handles publisher kind: looks up in busStore.publishers
  - [ ] Handles listener kind: looks up in busStore.listeners
  - [ ] Resolves port endpoints to block + slot + typeDesc
  - [ ] Resolves bus endpoints to bus + typeDesc
  - [ ] Normalizes optional fields (enabled, lensStack, adapterChain) to non-optional
- [ ] `getIncomingBindingForInputPort(root, blockId, slotId)` function implemented
  - [ ] Returns `NormalizedBinding | null`
  - [ ] Returns wire if connected via wire
  - [ ] Returns listener if connected via bus
  - [ ] Returns null if no connection (enforces single-writer invariant)
- [ ] `getOutgoingBindingsForOutputPort(root, blockId, slotId)` function implemented
  - [ ] Returns `NormalizedBinding[]`
  - [ ] Includes all wires from this output
  - [ ] Includes all publishers from this output
- [ ] `getPublishersForBus(root, busId)` function implemented
  - [ ] Returns `NormalizedBinding[]` with only publishers
- [ ] `getListenersForBus(root, busId)` function implemented
  - [ ] Returns `NormalizedBinding[]` with only listeners
- [ ] `isPortPublishingToBus(root, portRef, busId)` helper implemented
  - [ ] Returns boolean
  - [ ] Checks if output port has publisher to specified bus
- [ ] `isPortSubscribedToBus(root, portRef, busId)` helper implemented
  - [ ] Returns boolean
  - [ ] Checks if input port has listener from specified bus

### Deliverable: Binding Write Facade
- [ ] File `src/editor/bindings/write.ts` exists
- [ ] `disconnectBinding(root, ref)` function implemented
  - [ ] Handles wire kind: calls `root.patchStore.disconnect(id)`
  - [ ] Handles publisher kind: calls `root.busStore.removePublisher(id)`
  - [ ] Handles listener kind: calls `root.busStore.removeListener(id)`
- [ ] `setBindingEnabled(root, ref, enabled)` function implemented
  - [ ] Handles wire kind: calls `root.patchStore.updateConnection(id, { enabled })`
  - [ ] Handles publisher kind: calls `root.busStore.updatePublisher(id, { enabled })`
  - [ ] Handles listener kind: calls `root.busStore.updateListener(id, { enabled })`

### Deliverable: Binding Module Exports
- [ ] File `src/editor/bindings/index.ts` exists
- [ ] All public types re-exported from types.ts
- [ ] All public functions re-exported from read.ts
- [ ] All public functions re-exported from write.ts

### Deliverable: BusStore Fix
- [ ] `BusStore.updateListener()` signature updated in `src/editor/stores/BusStore.ts`
- [ ] Old signature removed: `updates: Partial<Pick<Listener, 'enabled' | 'lensStack'>>`
- [ ] New signature added: `updates: Partial<Pick<Listener, 'enabled' | 'lensStack' | 'adapterChain'>>`
- [ ] Implementation updated to handle `adapterChain` updates
- [ ] Existing tests for BusStore still pass

### Deliverable: Build and Test Validation
- [ ] TypeScript compiles with no new errors (`just typecheck`)
- [ ] All 1063 existing tests pass (`just test`)
- [ ] Facade can be imported in scratch file without crash
- [ ] `resolveBinding()` can be called with mock data and returns valid result

---

## Sprint 2: High-Value UI Migration

**This sprint delivers**: ConnectionInspector, Inspector port panel, PatchBay decorations using facade
**Deferred**: BusInspector, BusPicker, PublishMenu (handled in Sprint 3)

### Deliverable: ConnectionInspector Migration
- [ ] `ConnectionInspector.tsx` imports `resolveBinding` from `src/editor/bindings`
- [ ] Manual resolution logic (lines 703-867) replaced with single `resolveBinding(root, ref)` call
- [ ] Existing view components (WireConnectionView, PublisherConnectionView, ListenerConnectionView) unchanged
- [ ] Data flows: BindingRef → resolveBinding() → ResolvedBinding → view component
- [ ] TypeScript compiles clean
- [ ] Manual test: Open ConnectionInspector for wire → shows correct endpoints, type, metadata
- [ ] Manual test: Open ConnectionInspector for publisher → shows correct block output and bus
- [ ] Manual test: Open ConnectionInspector for listener → shows correct bus and block input
- [ ] Manual test: Enable/disable toggle works for wire
- [ ] Manual test: Enable/disable toggle works for publisher
- [ ] Manual test: Enable/disable toggle works for listener

### Deliverable: Inspector Port Panel Migration
- [ ] `Inspector.tsx` imports facade queries from `src/editor/bindings`
- [ ] `getConnectionsForPort()` helper removed or replaced with facade calls
- [ ] Direct scans of `busStore.publishers` removed
- [ ] Direct scans of `busStore.listeners` removed
- [ ] Input port rendering uses `getIncomingBindingForInputPort(root, blockId, slotId)`
- [ ] Output port rendering uses `getOutgoingBindingsForOutputPort(root, blockId, slotId)`
- [ ] Port panel renders bindings without branching on kind
- [ ] Clicking binding row calls `uiStore.selectConnection(kind, id)` with correct kind
- [ ] TypeScript compiles clean
- [ ] Manual test: Select block with wired input → Inspector shows wire in port panel
- [ ] Manual test: Select block with bus listener → Inspector shows listener in port panel
- [ ] Manual test: Select block with output publishing to bus → Inspector shows publisher in port panel
- [ ] Manual test: Select block with multiple output connections → Inspector shows all (wires + publishers)
- [ ] Manual test: Click binding row in Inspector → ConnectionInspector opens with correct binding

### Deliverable: PatchBay Port Decorations Migration
- [ ] `PatchBay.tsx` imports facade queries from `src/editor/bindings`
- [ ] `getConnectionInfo()` function (lines 475-510) replaced with facade calls
- [ ] Tri-scan logic (checking connections/publishers/listeners separately) removed
- [ ] Input port decoration uses `getIncomingBindingForInputPort(root, blockId, slotId)`
- [ ] Output port decoration uses `getOutgoingBindingsForOutputPort(root, blockId, slotId).length`
- [ ] Port glyph shows correct "connected vs disconnected" state
- [ ] Port tooltip shows correct destination (block name or bus name)
- [ ] TypeScript compiles clean
- [ ] Manual test: Wire two blocks → both ports show "connected" decoration
- [ ] Manual test: Publish output to bus → output port shows "bus connection" decoration
- [ ] Manual test: Subscribe input to bus → input port shows "bus connection" decoration
- [ ] Manual test: Hover over connected port → tooltip shows correct destination name
- [ ] Manual test: Disconnect binding → port decoration updates to "disconnected" state

### Deliverable: Sprint-Level Validation
- [ ] No manual tri-scans of connections/publishers/listeners in ConnectionInspector, Inspector, or PatchBay
- [ ] TypeScript compiles clean (`just typecheck`)
- [ ] All 1063 existing tests pass (`just test`)
- [ ] Manual test via `just dev` + Chrome DevTools MCP:
  - [ ] Connect wire between two blocks → Inspector and PatchBay show correct state
  - [ ] Disconnect wire → Inspector and PatchBay update correctly
  - [ ] Publish output to bus → Inspector and PatchBay show bus connection
  - [ ] Subscribe input to bus → Inspector and PatchBay show listener
  - [ ] Input writer invariant preserved: wire input then subscribe to bus → wire removed
  - [ ] Input writer invariant preserved: subscribe input then wire → listener removed

---

## Sprint 3: Complete UI Migration

**This sprint delivers**: BusInspector, BusPicker, PublishMenu using facade
**Deferred**: None (completes all UI migration)

### Deliverable: BusInspector Migration
- [ ] `BusInspector.tsx` imports facade queries from `src/editor/bindings`
- [ ] Publishers list uses `getPublishersForBus(root, busId)` instead of direct `busStore.publishers` access
- [ ] Listeners list uses `getListenersForBus(root, busId)` instead of direct `busStore.listeners` access
- [ ] Unified `BindingItem` component created (or existing component reused)
- [ ] `PublisherItem` component removed (lines 120-162)
- [ ] `ListenerItem` component removed (lines 168-210)
- [ ] Enable/disable logic unified in single implementation
- [ ] Jump-to-block logic unified in single implementation
- [ ] TypeScript compiles clean
- [ ] Manual test: Select bus → publishers list shows all publishers to that bus
- [ ] Manual test: Select bus → listeners list shows all listeners from that bus
- [ ] Manual test: Toggle enable on publisher → state changes, runtime reflects change
- [ ] Manual test: Toggle enable on listener → state changes, runtime reflects change
- [ ] Manual test: Click "jump to block" on publisher → selection jumps to source block
- [ ] Manual test: Click "jump to block" on listener → selection jumps to target block

### Deliverable: BusPicker Migration
- [ ] `BusPicker.tsx` imports facade helpers from `src/editor/bindings`
- [ ] Local `getCompatibleBuses()` function removed (lines 34-36)
- [ ] Local `isPortSubscribedToBus()` function removed (lines 38-48)
- [ ] Uses facade helper `isPortSubscribedToBus(root, portRef, busId)` instead
- [ ] Compatibility check uses existing `isDirectlyCompatible()` from types.ts (can be extracted to facade later)
- [ ] TypeScript compiles clean
- [ ] Manual test: Right-click input port → BusPicker opens and shows compatible buses
- [ ] Manual test: Already-subscribed bus shows "subscribed" indicator in picker
- [ ] Manual test: Select unsubscribed bus → subscribes port to bus
- [ ] Manual test: Select already-subscribed bus → unsubscribes or shows appropriate state

### Deliverable: PublishMenu Migration
- [ ] `PublishMenu.tsx` imports facade helpers from `src/editor/bindings`
- [ ] Local `getCompatibleBuses()` function removed (lines 32-38, exact duplicate of BusPicker)
- [ ] Local `getPortPublishers()` function removed (lines 40-48)
- [ ] Local `isPortPublishingToBus()` function removed (lines 50-57)
- [ ] Uses facade helper `isPortPublishingToBus(root, portRef, busId)` instead
- [ ] Uses `getOutgoingBindingsForOutputPort()` filtered by `kind === 'publisher'` for port publishers
- [ ] TypeScript compiles clean
- [ ] Manual test: Right-click output port → PublishMenu opens and shows compatible buses
- [ ] Manual test: Already-publishing bus shows "published" indicator in menu
- [ ] Manual test: Select unpublished bus → publishes port to bus
- [ ] Manual test: Select already-published bus → unpublishes or shows appropriate state

### Deliverable: Sprint-Level Validation
- [ ] No UI component directly accesses `patchStore.connections`, `busStore.publishers`, or `busStore.listeners`
- [ ] All connection queries go through binding facade
- [ ] Duplication count: 0 instances of "find compatible buses" (down from 5+)
- [ ] Duplication count: 0 instances of "is port connected to bus" (down from 3+)
- [ ] TypeScript compiles clean (`just typecheck`)
- [ ] All 1063 existing tests pass (`just test`)
- [ ] Manual test via `just dev` + Chrome DevTools MCP:
  - [ ] Select bus in BusInspector → shows correct publishers and listeners
  - [ ] Toggle enable in BusInspector → works for both publishers and listeners
  - [ ] Jump-to-block in BusInspector → works for both publishers and listeners
  - [ ] Open BusPicker on input → shows correct compatible buses and subscription state
  - [ ] Open PublishMenu on output → shows correct compatible buses and publish state

---

## Sprint 4: Validation Layer (Optional)

**This sprint delivers**: Preflight validation for bus edges
**Deferred**: Integration with facade write operations (can be added later)

### Deliverable: Publisher Validation
- [ ] `Validator.canAddPublisher(patchDoc, fromPortRef, busId)` method added to `src/editor/semantic/validator.ts`
- [ ] Returns `ValidationResult` with `valid`, `warnings`, `errors` fields
- [ ] Checks fromPort exists in patchDoc
- [ ] Checks bus exists in patchDoc
- [ ] Checks type compatibility using `areSlotTypesCompatible()` from semantic/index.ts
- [ ] If incompatible but adaptable (via `findAdapterPath()`), returns warning (not error)
- [ ] TypeScript compiles clean
- [ ] Unit test: canAddPublisher with compatible types → returns `{ valid: true }`
- [ ] Unit test: canAddPublisher with incompatible non-adaptable types → returns `{ valid: false, errors: [...] }`
- [ ] Unit test: canAddPublisher with missing port → returns `{ valid: false, errors: ['Port not found'] }`
- [ ] Unit test: canAddPublisher with missing bus → returns `{ valid: false, errors: ['Bus not found'] }`

### Deliverable: Listener Validation
- [ ] `Validator.canAddListener(patchDoc, busId, toPortRef)` method added to `src/editor/semantic/validator.ts`
- [ ] Returns `ValidationResult` with `valid`, `warnings`, `errors` fields
- [ ] Checks bus exists in patchDoc
- [ ] Checks toPort exists in patchDoc
- [ ] Checks type compatibility using `areSlotTypesCompatible()` from semantic/index.ts
- [ ] Checks single-writer invariant (input has no other listener or wire)
- [ ] If input already has connection, returns warning "will replace existing connection" (not error)
- [ ] TypeScript compiles clean
- [ ] Unit test: canAddListener with compatible types and no existing connection → returns `{ valid: true }`
- [ ] Unit test: canAddListener with existing listener → returns `{ valid: true, warnings: ['will replace'] }`
- [ ] Unit test: canAddListener with existing wire → returns `{ valid: true, warnings: ['will replace'] }`
- [ ] Unit test: canAddListener with incompatible non-adaptable types → returns `{ valid: false, errors: [...] }`
- [ ] Unit test: canAddListener with missing bus → returns `{ valid: false, errors: ['Bus not found'] }`

### Deliverable: Test Coverage
- [ ] All validation tests pass (`just test`)
- [ ] Test file exists: `src/editor/semantic/__tests__/validator-bus-edges.test.ts` (or added to existing validator.test.ts)
- [ ] At least 8 test cases total (4 for publisher, 4 for listener)

---

## Overall Project Acceptance

### Must Complete (All Sprints)
- [ ] Sprint 1 complete: Binding Facade exists and is functional
- [ ] Sprint 2 complete: ConnectionInspector, Inspector, PatchBay migrated
- [ ] Sprint 3 complete: BusInspector, BusPicker, PublishMenu migrated
- [ ] All branching on wire/publisher/listener isolated to `src/editor/bindings/` module
- [ ] No UI component performs manual tri-scans of connections/publishers/listeners
- [ ] Input writer invariant preserved in all scenarios
- [ ] TypeScript compiles clean with no new errors
- [ ] All 1063 existing tests pass
- [ ] Manual verification complete via `just dev` + Chrome DevTools MCP (all checkpoints in all sprints passed)

### Optional (Sprint 4)
- [ ] Validator.canAddPublisher implemented
- [ ] Validator.canAddListener implemented
- [ ] Unit tests for validation methods passing

### Explicitly Out of Scope
- ❌ setBindingLensStack implementation (per user instruction: skip lenses)
- ❌ setBindingAdapterChain implementation (per user instruction: skip adapters)
- ❌ Lens stack UI updates (per user instruction)
- ❌ Adapter chain UI updates (per user instruction)
- ❌ Numeric UI semantics registry (separate work)
- ❌ Renaming existing types (Connection, Publisher, Listener remain unchanged)

---

## Manual Verification Checklist (Final)

Run `just dev` and verify in Chrome DevTools MCP:

### Basic Operations
- [ ] Add two blocks, connect output → input → wire appears in PatchBay
- [ ] Click wire in Inspector → ConnectionInspector opens showing wire details
- [ ] Toggle wire enabled → state changes, decoration updates
- [ ] Disconnect wire → PatchBay and Inspector update correctly

### Bus Operations
- [ ] Create bus, publish output to bus → publisher appears in BusInspector
- [ ] Subscribe input to bus → listener appears in BusInspector
- [ ] Select bus → BusInspector shows all publishers and listeners
- [ ] Toggle publisher enabled → state changes
- [ ] Toggle listener enabled → state changes
- [ ] Jump to block from publisher → selects source block
- [ ] Jump to block from listener → selects target block

### Input Writer Invariant
- [ ] Wire input port, then subscribe to bus → wire removed automatically
- [ ] Subscribe input port to bus, then wire → listener removed automatically
- [ ] At no point does input port have both wire AND listener

### Inspector Consistency
- [ ] Select block with wire → Inspector port panel shows wire
- [ ] Select block with publisher → Inspector port panel shows publisher
- [ ] Select block with listener → Inspector port panel shows listener
- [ ] Click binding in Inspector → selects correct connection in ConnectionInspector
- [ ] PatchBay decorations match Inspector display (no mismatches)

### Picker/Menu Consistency
- [ ] Right-click input → BusPicker shows compatible buses
- [ ] BusPicker shows "subscribed" indicator on already-subscribed buses
- [ ] Right-click output → PublishMenu shows compatible buses
- [ ] PublishMenu shows "published" indicator on already-published buses

All checkpoints must pass for project to be considered complete.
