Agent: iterative-implementer | 2026-01-01-055121
Mode: manual
Completed: Bus interface updated, BusStore updated | Files: 2 | Commits: 0
Cache invalidated: None (pending)
Status: in_progress

====================================================================================================
TASK: Unify Bus and Slot to use single CombinePolicy type
====================================================================================================

GOAL:
Make Bus use `combine: CombinePolicy` instead of `combineMode: BusCombineMode` to unify with Slot's combine field.

COMPLETED WORK:
1. Updated Bus interface in src/editor/types.ts
   - Changed: combineMode: BusCombineMode → combine: CombinePolicy
   - Added comprehensive documentation explaining the change
   - Default value: { when: 'multi', mode: 'last' }
   - Noted that mode: 'error' is invalid for buses (caught by semantic validation)

2. Updated BusStore in src/editor/stores/BusStore.ts
   - createDefaultBuses(): Wraps BusCombineMode in CombinePolicy format
   - createBus(): Takes BusCombineMode param, wraps in { when: 'multi', mode: X }
   - updateBus(): Updated type signature to accept combine: CombinePolicy

REMAINING WORK (P1 - Core Compiler):
1. src/editor/compiler/passes/pass7-bus-lowering.ts
   - Line 277: Change `bus.combineMode` to `bus.combine.mode`

2. src/editor/compiler/compileBusAware.ts
   - Line 242: `bus.combineMode` → `bus.combine.mode`
   - Lines 489, 492, 498, 501: Update validation messages and checks
   - Lines 1088, 1090: `bus.combineMode` → `bus.combine.mode`

3. src/editor/compiler/unified/UnifiedCompiler.ts
   - Line 368: `combineMode: bus.combineMode` → `combineMode: bus.combine.mode`

REMAINING WORK (P1 - Semantic/Validation):
4. src/editor/semantic/busContracts.ts
   - Update RESERVED_BUS_CONTRACTS to use CombinePolicy format

5. src/editor/semantic/busSemantics.ts
   - Update helper functions that reference bus.combineMode

6. src/editor/semantic/validator.ts
   - Add validation: buses cannot use combine.mode === 'error'
   - Add validation: buses cannot use combine.mode === 'first'

REMAINING WORK (P2 - UI Components):
7. src/editor/BusInspector.tsx
   - Update UI to wrap/unwrap CombinePolicy when editing bus combine mode

8. src/editor/BusChannel.tsx
   - Update display of bus combine policy

9. src/editor/BusCreationDialog.tsx
   - Update dialog to create buses with CombinePolicy format

10. src/editor/ConnectionInspector.tsx
    - Update any bus combine mode displays

REMAINING WORK (P2 - Transactions):
11. src/editor/kernel/TransactionBuilder.ts
    - Update any bus update operations that reference combineMode

12. src/editor/kernel/ops.ts
    - Update operation types if they reference combineMode

REMAINING WORK (P2 - Tests):
13. All test files that create Bus objects need updating
    - Search for: combineMode in test files
    - Update to: combine: { when: 'multi', mode: X }

MIGRATION STRATEGY:
The change maintains backward compatibility at the API level:
- BusStore.createBus() still accepts BusCombineMode (wraps internally)
- UI components should use helper functions to extract/wrap mode
- Default policy: { when: 'multi', mode: 'last' }

HELPER FUNCTIONS NEEDED:
```typescript
// In a shared util file
export function extractCombineMode(policy: CombinePolicy): CombineMode {
  return typeof policy.mode === 'string' ? policy.mode : policy.mode;
}

export function createBusCombinePolicy(mode: BusCombineMode): CombinePolicy {
  return { when: 'multi', mode };
}
```

BLOCKERS:
- Existing type errors in codebase prevent full testing
- Need to run typecheck after compiler changes to verify
- UI changes will need manual testing

NEXT STEPS:
1. Update compiler passes (P1)
2. Update semantic validation (P1)
3. Run typecheck
4. Update UI components (P2)
5. Update tests (P2)
6. Commit changes with clear migration notes
