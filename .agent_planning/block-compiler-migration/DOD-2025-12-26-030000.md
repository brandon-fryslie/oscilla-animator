# Definition of Done: Block Compiler Migration (Phase 3)

**Generated**: 2025-12-26-030000
**Plan**: PLAN-2025-12-26-030000.md
**Source**: STATUS-2025-12-26-030000.md

---

## Sprint Scope

This sprint delivers:
1. IR lowering type infrastructure (3 deliverables)
2. Signal block IR migrations (13 blocks)
3. Domain IR design (1 design doc)

Deferred to next sprint:
- Field block migrations (15 blocks)
- Domain block migrations (3 blocks)
- Position map migrations (3 blocks)
- Time block migrations (3 blocks)
- Render block migrations (2 blocks)

---

## Acceptance Criteria

### P0-1: Create IR Lowering Types

- [ ] `BlockCapability` type created with all variants: 'time', 'identity', 'state', 'render', 'io', 'pure'
- [ ] `BlockPortDecl` interface created with portId, label, dir, type, optional fields
- [ ] `BlockTypeDecl` interface created with type, capability, inputs, outputs, lower function
- [ ] `BlockLowerFn` type alias created matching spec signature: `(args: { ctx: LowerCtx; inputs: ValueRefPacked[]; config?: unknown }) => LowerResult`
- [ ] `LowerCtx` interface created with blockIdx, blockType, instanceId, label, inTypes, outTypes, b (IRBuilder), seedConstId
- [ ] `LowerResult` interface created with outputs array and optional declares
- [ ] `BlockDeclarations` interface created with timeModel, domainOut, renderSink fields
- [ ] All types exported from `src/editor/compiler/ir/index.ts`
- [ ] TypeScript compilation succeeds with no errors

---

### P0-2: Extend ValueRefPacked Type

- [ ] `ValueRefPacked` type moved from `pass6-block-lowering.ts` to `lowerTypes.ts`
- [ ] Added `scalarConst` variant with `constId: number` field
- [ ] Added `special` variant with `tag: string` and `id: number` fields
- [ ] Import updated in `pass6-block-lowering.ts` from new location
- [ ] All existing usages continue to work (no breaking changes)
- [ ] TypeScript compilation succeeds

---

### P0-3: Create BlockTypeDecl Registry Infrastructure

- [ ] `blockTypeRegistry` Map created to store BlockTypeDecl by block type string
- [ ] `registerBlockType(decl: BlockTypeDecl): void` function created
- [ ] `getBlockType(type: string): BlockTypeDecl | undefined` function created
- [ ] `hasBlockType(type: string): boolean` function created
- [ ] Registry is separate from but compatible with existing BlockCompiler registry
- [ ] Exported from `src/editor/compiler/ir/index.ts`
- [ ] Unit test created verifying registration and retrieval
- [ ] TypeScript compilation succeeds

---

### P1-1: Migrate AddSignal Block

- [ ] `lowerAddSignal` function created implementing BlockLowerFn signature
- [ ] Function extracts two signal inputs from `inputs` array
- [ ] Creates IR node via `ctx.b.sigOp(OpCode.Add, [sig1, sig2], outType, prov)`
- [ ] Returns `LowerResult` with single output `{ k: 'sig', id: sigId }`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created comparing closure output vs IR output on same inputs
- [ ] Existing closure path still works (dual-emit mode)
- [ ] Unit test verifies IR emission produces correct node structure

---

### P1-2: Migrate SubSignal Block

- [ ] `lowerSubSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Sub, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created using same dual-emit pattern as P1-1
- [ ] Test validates subtraction at t=0, t=1000, t=5000
- [ ] Dual-emit mode verified working

---

### P1-3: Migrate MulSignal Block

- [ ] `lowerMulSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Mul, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating multiplication
- [ ] Test covers edge cases: 0 * x = 0, 1 * x = x
- [ ] Dual-emit mode verified

---

### P1-4: Migrate DivSignal Block

- [ ] `lowerDivSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Div, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating division
- [ ] Test covers edge case: divide by zero behavior matches closure
- [ ] Dual-emit mode verified

---

### P1-5: Migrate MinSignal Block

- [ ] `lowerMinSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Min, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating min operation
- [ ] Test validates: min(a, b) where a < b, a > b, a == b
- [ ] Dual-emit mode verified

---

### P1-6: Migrate MaxSignal Block

- [ ] `lowerMaxSignal` function created following P1-1 pattern
- [ ] Uses `ctx.b.sigOp(OpCode.Max, [a, b], outType, prov)`
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test created validating max operation
- [ ] Test validates: max(a, b) where a < b, a > b, a == b
- [ ] Dual-emit mode verified

---

### P1-7: Migrate ClampSignal Block

- [ ] `lowerClampSignal` function created
- [ ] Extracts value signal and min/max signals from inputs
- [ ] Creates clamp operation: `min(max(value, minVal), maxVal)`
- [ ] Uses nested `sigOp` calls or single `sigClamp` if available
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates clamping behavior at boundaries
- [ ] Test covers: value < min, min < value < max, value > max
- [ ] Dual-emit mode verified

---

### P1-8: Migrate Oscillator Block

- [ ] `lowerOscillator` function created
- [ ] Shape parameter converted to config field (or defaultSource if user-adjustable)
- [ ] Frequency and amplitude taken from inputs array
- [ ] Shape selection creates appropriate waveform IR node (sin/tri/square/saw)
- [ ] Each waveform kernel implemented as sigOp sequence
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates all 4 waveforms match closure output
- [ ] Test samples multiple time points and frequencies
- [ ] Dual-emit mode verified

---

### P1-9: Migrate Shaper Block

- [ ] `lowerShaper` function created
- [ ] Kind parameter handled as config or defaultSource
- [ ] Amount parameter taken from inputs
- [ ] All shaping functions implemented as IR node sequences
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates each shaping mode matches closure
- [ ] Test covers input range [0, 1] and edge cases
- [ ] Dual-emit mode verified

---

### P1-10: Migrate ColorLFO Block

- [ ] `lowerColorLFO` function created
- [ ] All 4 parameters handled appropriately (config vs inputs)
- [ ] HSL to RGB conversion implemented as IR node sequence
- [ ] Phase-driven color cycling logic preserved
- [ ] Output type is Signal:color
- [ ] BlockTypeDecl registered with capability: 'pure'
- [ ] Golden test validates color output at multiple time points
- [ ] Test verifies HSL interpolation matches closure exactly
- [ ] Dual-emit mode verified

---

### P1-11: Migrate PulseDivider Block

- [ ] `lowerPulseDivider` function created
- [ ] State layout defined for pulse division counter
- [ ] State allocated via `ctx.b.allocState(layout, prov)`
- [ ] `sigStateful` node created with SigStateOp.PulseDivider
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates pulse division across multiple cycles
- [ ] Test verifies state persistence between evaluations
- [ ] Dual-emit mode verified

---

### P1-12: Migrate TriggerOnWrap Block

- [ ] `lowerTriggerOnWrap` function created
- [ ] State layout defined for previous phase value (f32)
- [ ] State allocated via `ctx.b.allocState`
- [ ] `sigStateful` node created with SigStateOp.TriggerOnWrap
- [ ] Event detection logic preserved in IR
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates trigger timing on phase wraps
- [ ] Test verifies no false triggers on continuous phase
- [ ] Dual-emit mode verified

---

### P1-13: Migrate EnvelopeAD Block

- [ ] `lowerEnvelopeAD` function created
- [ ] State layout defined for envelope phase and level
- [ ] State allocated with slots for: phase (i32), level (f32), trigger timestamp (f64)
- [ ] `sigStateful` node created with SigStateOp.EnvelopeAD
- [ ] Attack and decay timing parameters handled correctly
- [ ] BlockTypeDecl registered with capability: 'state' and usesState: true
- [ ] Golden test validates envelope shape matches closure
- [ ] Test covers trigger, attack phase, decay phase, retriggering
- [ ] Dual-emit mode verified

---

### P2-1: Design Domain IR Representation

- [ ] Design document created: `design-docs/12-Compiler-Final/17-Domain-IR-Representation.md`
- [ ] Document answers: How is Domain represented in ValueRefPacked?
- [ ] Document specifies: Where is Domain data stored (special table vs ValueSlot)?
- [ ] Document clarifies: How do Field blocks reference Domain (domainRef parameter)?
- [ ] Document defines: DomainId type and allocation strategy
- [ ] Document explains: Domain position metadata (N, positions array)
- [ ] Ambiguity from STATUS ยง line 352 resolved with explicit decision
- [ ] Design reviewed against existing Domain producer blocks (DomainN, GridDomain)
- [ ] Integration points identified for `domainFromN` and `domainPositions` IRBuilder methods

---

### P2-2: Create SignalExpr Integration Test Suite

- [ ] Test file created: `src/editor/compiler/__tests__/signal-blocks-ir-equivalence.test.ts`
- [ ] Test compiles patch using ALL migrated signal blocks (P1-1 through P1-13)
- [ ] Test evaluates both closure and IR paths at t=0, t=1000, t=5000, t=10000
- [ ] Test asserts numeric equivalence with epsilon tolerance for floating point
- [ ] Test covers all waveform shapes in Oscillator
- [ ] Test covers all shaping modes in Shaper
- [ ] Test validates stateful blocks maintain state correctly
- [ ] Test validates ColorLFO produces identical RGB values
- [ ] All tests pass with dual-emit mode enabled

---

## Sprint Complete When

1. All P0 acceptance criteria checked (3/3 items)
2. All P1 acceptance criteria checked (13/13 items)
3. All P2 acceptance criteria checked (2/2 items)
4. TypeScript compilation succeeds with no errors
5. All tests pass (`just check`)
6. No regression in existing closure runtime behavior
7. Dual-emit mode works for all migrated blocks

**Total Checkboxes**: 138 acceptance criteria across 18 work items

---

## Workstream Assignment

**Workstream A** (Sequential - BLOCKING):
- P0-1, P0-2, P0-3 (27 checkboxes)

**Workstream B** (Parallel - after A):
- P1-1 through P1-7 (47 checkboxes)

**Workstream C** (Parallel - after A):
- P1-8 through P1-13 (55 checkboxes)

**Workstream D** (Parallel - after A):
- P2-1 (9 checkboxes)

**Integration** (Sequential - after B+C):
- P2-2 (9 checkboxes)
