# Phase 5: Remove Deprecated Parameter Types - Cleanup Plan

**Generated**: 2025-12-21-133029
**Source**: design-docs/10-Refactor-for-UI-prep/14-RemoveParams.md
**Status Reference**: .agent_planning/ui-refactor-prep/STATUS-time-authority-2025-12-21.md
**Phase**: 5 of 5 (Final Cleanup)

---

## Executive Summary

**Goal**: Remove deprecated `BlockParams` and `ParamSchema` types after all blocks have been migrated to use inputs with Default Sources.

**Current State**: Parameters concept still exists in the codebase across:
- Type definitions (2 locations)
- Block interfaces (2 properties)
- Compiler infrastructure (params argument)
- UI components (Inspector parameter editing)
- Store methods (updateBlockParams)
- ~42 test files (scope TBD)

**Complexity**: MEDIUM - Requires coordinated removal across type system, compiler, UI, and tests.

**Risk**: MEDIUM - Breaking change to core interfaces. Must verify all prior migration phases are complete.

---

## Scope Analysis

### Files with Deprecated Type Definitions

1. **`src/editor/types.ts`**
   - Line 420: `export type BlockParams = Record<string, unknown>;`
   - Line 443: `params: BlockParams;` (Block interface property)
   - **Impact**: Core type definition, imported by 3+ files

2. **`src/editor/blocks/types.ts`**
   - Lines 58, 61: `defaultParams`, `paramSchema` properties on BlockDefinition
   - Lines 136-147: `ParamSchema` interface definition
   - **Impact**: Block definition contract, used by factory and all block definitions

### Files Using Deprecated Types (17 occurrences across 10 files)

#### Critical Infrastructure
- `src/editor/compiler/types.ts` - `BlockCompiler.compile()` signature (line 413)
- `src/editor/compiler/compile.ts` - Passes `block.params` to compiler (line 293)
- `src/editor/compiler/compileBusAware.ts` - Passes `block.params` to compiler (line 434)
- `src/editor/stores/PatchStore.ts` - Multiple methods using params:
  - `addBlock()` - Accepts params argument
  - `updateBlockParams()` - Updates block.params
  - `migrateBlockParams()` - SVGPathSource migration (legacy)
- `src/editor/stores/RootStore.ts` - Imports BlockParams type

#### UI Layer
- `src/editor/Inspector.tsx` - Parameter editing panel (3 usages):
  - Line 197: Uses `def.defaultParams` when adding blocks
  - Line 536: Checks `paramSchema.length > 0`
  - Line 540: Maps `paramSchema` to UI controls
- `src/editor/BlockLibrary.tsx` - Uses `definition.defaultParams` (line 183)

#### Block System
- `src/editor/blocks/factory.ts` - `createBlock()` generates defaultParams from paramSchema
- `src/editor/blocks/utils.ts` - May use ParamSchema (needs verification)
- `src/editor/composite-bridge.ts` - May reference defaultParams
- `src/editor/replaceUtils.ts` - `copyCompatibleParams()` (2 usages)

#### Other
- `src/editor/controlSurface/store.ts` - Uses updateBlockParams

### Block Definitions Using paramSchema (47 occurrences across 11 files)

- `src/editor/blocks/signal.ts` - 9 usages
- `src/editor/blocks/domain.ts` - 17 usages
- `src/editor/blocks/rhythm.ts` - 2 usages
- `src/editor/blocks/time-root.ts` - 3 usages
- `src/editor/blocks/field-primitives.ts` - 4 usages
- `src/editor/blocks/macros.ts` - 1 usage
- Other files - 11 usages

### Compiler Block Usage (all blocks use params argument)

Every block compiler has this signature:
```typescript
compile({ id, params, inputs, ctx }) {
  const value = Number(params.someParam ?? defaultValue);
  // ...
}
```

**Estimated Count**: 50+ compiler blocks

---

## Prerequisites (Blocking - Must Verify First)

### Phase 1-4 Migration Status

**CRITICAL**: Before removing params types, verify ALL blocks have been migrated:

1. ✅ **Phase 1**: Default Sources infrastructure exists
   - Verify: Default Source system implemented in compiler
   - Verify: All inputs can have default values

2. ⏳ **Phase 2**: All block definitions updated (NEEDS VERIFICATION)
   - Verify: All `paramSchema` arrays are empty OR converted to inputs
   - Verify: All blocks have inputs with default values instead of params
   - **Action**: Run audit script to find any remaining paramSchema usage

3. ⏳ **Phase 3**: Compiler uses inputs instead of params (NEEDS VERIFICATION)
   - Verify: All BlockCompiler.compile() implementations read from `inputs` not `params`
   - Verify: No `params.xyz` access in any compiler block
   - **Action**: Grep for `params\.` in compiler/blocks directory

4. ⏳ **Phase 4**: UI updated (NEEDS VERIFICATION)
   - Verify: Inspector shows inputs, not param controls
   - Verify: addBlock() passes default input values, not params
   - **Action**: Test UI manually - adding blocks should not use param panel

**If ANY phase is incomplete, PAUSE and complete migration before proceeding.**

---

## Implementation Plan

### Step 1: Pre-Flight Verification (MANDATORY)

**DO NOT SKIP - This prevents breaking the codebase**

1. **Audit Block Definitions**
   ```bash
   # Find any blocks still using paramSchema
   rg 'paramSchema:\s*\[' src/editor/blocks/

   # Expected: Only empty arrays [] or no matches
   # If non-empty arrays exist → PAUSE, complete Phase 2 first
   ```

2. **Audit Compiler Blocks**
   ```bash
   # Find any compiler blocks accessing params object
   rg 'params\.[a-zA-Z]' src/editor/compiler/blocks/

   # Expected: No matches (all should use inputs)
   # If matches exist → PAUSE, complete Phase 3 first
   ```

3. **Audit UI Components**
   ```bash
   # Find parameter editing UI
   rg 'paramSchema\.map|params\[param\.key\]' src/editor/

   # Expected: Only in Inspector (will be removed)
   # If in other components → PAUSE, verify migration
   ```

4. **Run Full Test Suite**
   ```bash
   just test

   # Expected: All tests pass
   # If failures exist → FIX before proceeding
   ```

**Decision Point**: If any audit fails, STOP and return to migration phases.

---

### Step 2: Remove Type Definitions (Core Types Layer)

**Order**: Bottom-up - start with deepest dependencies

#### 2.1 Remove ParamSchema Interface

**File**: `src/editor/blocks/types.ts`

**Remove**:
```typescript
// Lines 136-147
export type ParamType = 'number' | 'string' | 'boolean' | 'select' | 'color';

export interface ParamSchema {
  readonly key: string;
  readonly label: string;
  readonly type: ParamType;
  readonly min?: number;
  readonly max?: number;
  readonly step?: number;
  readonly options?: readonly { value: string; label: string }[];
  readonly defaultValue: unknown;
}
```

**Also Remove**: Import of ParamSchema from line 1

**Verify**: Run `just typecheck` - expect errors in files that import ParamSchema

---

#### 2.2 Remove BlockDefinition Properties

**File**: `src/editor/blocks/types.ts`

**Remove**:
```typescript
// Lines 58, 61
readonly defaultParams: BlockParams;
readonly paramSchema: ParamSchema[];
```

**Verify**: TypeScript errors in all block definitions that still reference these

---

#### 2.3 Remove BlockParams Type

**File**: `src/editor/types.ts`

**Remove**:
```typescript
// Line 420
export type BlockParams = Record<string, unknown>;
```

**Verify**: TypeScript errors in Block interface

---

#### 2.4 Remove Block.params Property

**File**: `src/editor/types.ts`

**Remove**:
```typescript
// Line 443 (in Block interface)
params: BlockParams;
```

**Verify**: Errors in all files accessing block.params

---

### Step 3: Update Block Factory

**File**: `src/editor/blocks/factory.ts`

**Current**:
```typescript
export function createBlock(
  definition: Partial<BlockDefinitionInput>,
): BlockDefinition {
  const { paramSchema = [] } = definition;
  const defaultParams = Object.fromEntries(
    paramSchema.map((p) => [p.key, p.defaultValue]),
  );
  return {
    // ...
    paramSchema,
    defaultParams,
  } as BlockDefinition;
}
```

**Replace With**:
```typescript
export function createBlock(
  definition: Partial<BlockDefinition>,
): BlockDefinition {
  // Remove paramSchema/defaultParams logic entirely
  return {
    category: 'Misc',
    description: '',
    inputs: [],
    outputs: [],
    color: '#CCCCCC',
    laneKind: 'any',
    ...definition,
  } as BlockDefinition;
}
```

**Also Update**:
- Remove `ParamSchema` import
- Remove `BlockDefinitionInput` type (if it only exists for paramSchema)

---

### Step 4: Update Compiler Infrastructure

#### 4.1 Update BlockCompiler Interface

**File**: `src/editor/compiler/types.ts`

**Current** (line 411):
```typescript
compile(args: {
  id: BlockId;
  params: Record<string, unknown>;
  inputs: Record<string, Artifact>;
  ctx: CompileCtx;
}): CompiledOutputs;
```

**Replace With**:
```typescript
compile(args: {
  id: BlockId;
  inputs: Record<string, Artifact>;
  ctx: CompileCtx;
}): CompiledOutputs;
```

**Impact**: All BlockCompiler implementations must update signatures

---

#### 4.2 Update Compiler Invocation Sites

**Files**:
- `src/editor/compiler/compile.ts` (line 293)
- `src/editor/compiler/compileBusAware.ts` (line 434)

**Current**:
```typescript
const outs = compiler.compile({ id: blockId, params: block.params, inputs, ctx });
```

**Replace With**:
```typescript
const outs = compiler.compile({ id: blockId, inputs, ctx });
```

---

#### 4.3 Update All Block Compilers

**Pattern**: For every file in `src/editor/compiler/blocks/**/*.ts`

**Current**:
```typescript
compile({ id, params, inputs, ctx }) {
  const period = Number(params.period ?? 2000);
  // ...
}
```

**Replace With** (if params were truly migrated):
```typescript
compile({ id, inputs, ctx }) {
  // Default values now come from Default Source on input
  // No params access at all
}
```

**CRITICAL**: This only works if Phase 3 was completed. If ANY compiler still reads `params.xyz`, Phase 3 is incomplete.

---

### Step 5: Update PatchStore

**File**: `src/editor/stores/PatchStore.ts`

#### 5.1 Update addBlock Method

**Current Signature**:
```typescript
addBlock(
  type: BlockType,
  laneId?: LaneId,
  params?: Record<string, unknown>,
  position?: { x: number; y: number }
): BlockId
```

**Replace With**:
```typescript
addBlock(
  type: BlockType,
  laneId?: LaneId,
  position?: { x: number; y: number }
): BlockId
```

**Remove**:
- `params` parameter
- Any logic that merges params with defaultParams
- Call to `migrateBlockParams()` (if only used for params)

**Keep**:
- Block creation with inputs (already present from Phase 2)

---

#### 5.2 Remove updateBlockParams Method

**Remove Entire Method**:
```typescript
updateBlockParams(blockId: BlockId, params: Record<string, unknown>): void {
  // ...entire implementation...
}
```

**Rationale**: Block "parameters" are now input default values, updated via different mechanism

---

#### 5.3 Remove migrateBlockParams Helper

**Remove** (lines 36-45):
```typescript
function migrateBlockParams(type: string, params: Record<string, unknown>): Record<string, unknown> {
  // SVGPathSource migration
  // ...
}
```

**Rationale**: Migration helper for old param format - no longer needed if params don't exist

**Alternative**: If still needed for backward compatibility, convert to migrate input default values instead

---

### Step 6: Update UI Components

#### 6.1 Update Inspector.tsx

**Remove Parameter Editing Section** (lines ~536-560):
```typescript
{definition.paramSchema.length > 0 && (
  <div className="inspector-section">
    <div className="section-label">PARAMETERS</div>
    <div className="param-grid">
      {definition.paramSchema.map(param => (
        // ...parameter controls...
      ))}
    </div>
  </div>
)}
```

**Replace With**: Nothing - inputs are shown in different section

**Update addBlock Call** (line 197):
```typescript
// Current
const newBlockId = store.patchStore.addBlock(def.type, targetLane.id, def.defaultParams);

// Replace with
const newBlockId = store.patchStore.addBlock(def.type, targetLane.id);
```

---

#### 6.2 Update BlockLibrary.tsx

**Update** (line 183):
```typescript
// Current
store.patchStore.addBlock(definition.type, targetLane.id, definition.defaultParams);

// Replace with
store.patchStore.addBlock(definition.type, targetLane.id);
```

---

### Step 7: Update Utility Functions

#### 7.1 replaceUtils.ts

**File**: `src/editor/replaceUtils.ts`

**Remove** `copyCompatibleParams()` function (2 usages)

**Rationale**: If blocks don't have params, can't copy them

**Alternative**: If replacement still needs to copy input default values, create new function for that

---

#### 7.2 blocks/utils.ts

**File**: `src/editor/blocks/utils.ts`

**Audit**: Check if any param-related utilities exist

**Action**: Remove or update to work with inputs

---

### Step 8: Update Store Imports

**File**: `src/editor/stores/RootStore.ts`

**Remove**: Import of `BlockParams` type (if no longer used)

---

### Step 9: Clean Up Remaining References

**Files to Check**:
- `src/editor/composite-bridge.ts` - May reference defaultParams
- `src/editor/controlSurface/store.ts` - Uses updateBlockParams
- `src/editor/components/LensSelector.tsx` - Check for param references

**Action**: For each file, remove or replace param-related code with input-based equivalents

---

### Step 10: Verification & Testing

#### 10.1 TypeScript Compilation

```bash
just typecheck
```

**Expected**: No errors related to:
- `BlockParams`
- `ParamSchema`
- `block.params`
- `def.defaultParams`
- `def.paramSchema`

**If Errors**: Fix each one - they indicate incomplete cleanup

---

#### 10.2 Test Suite

```bash
just test
```

**Expected Issues**:
- Tests creating blocks with params - update to use inputs
- Tests checking block.params - update to check input defaults
- Tests using paramSchema - update or remove

**Action**: Fix all test failures

---

#### 10.3 Runtime Verification

```bash
just dev
```

**Manual Tests**:
1. Add blocks from library → Should work without param controls
2. Inspect block → Should show inputs, not params
3. Edit input default values → Should work
4. Replace block → Should preserve input connections
5. Load saved patch → Should deserialize correctly

**If Any Fail**: Debug and fix before committing

---

## Dependency Graph

```
Phase 1-4 Migration Complete (PREREQUISITE)
          ↓
    Audit Scripts Pass
          ↓
    Remove ParamSchema Interface (blocks/types.ts)
          ↓
    Remove defaultParams/paramSchema from BlockDefinition
          ↓
    Remove BlockParams Type (types.ts)
          ↓
    Remove params from Block Interface
          ↓
    ┌─────────────┬──────────────┬────────────┐
    ↓             ↓              ↓            ↓
Update Factory  Update     Update Store  Update UI
                Compiler
    ↓             ↓              ↓            ↓
    └─────────────┴──────────────┴────────────┘
                  ↓
         Clean Up Utilities
                  ↓
         TypeScript Check
                  ↓
            Fix Tests
                  ↓
        Runtime Verification
                  ↓
              DONE
```

---

## Removal Order (To Avoid Circular Issues)

**Safest Order** (prevents TypeScript errors cascading):

1. **ParamSchema** - Most specific, least dependencies
2. **defaultParams/paramSchema properties** - BlockDefinition layer
3. **BlockParams type** - Core type layer
4. **Block.params property** - Instance layer
5. **Factory functions** - Uses types from above
6. **Compiler signatures** - Uses types from above
7. **Store methods** - Uses everything
8. **UI components** - Top layer, depends on store
9. **Utilities** - May depend on any of above

**Key Rule**: Remove type definitions before removing their usages - this way TypeScript tells you what still needs updating

---

## Risk Assessment

### High Risk Items

1. **Incomplete Migration** (P0)
   - **Risk**: Removing types while blocks still use params breaks compilation
   - **Mitigation**: Mandatory pre-flight audit (Step 1)
   - **Fallback**: Git revert + complete migration phases

2. **Compiler Signature Change** (P1)
   - **Risk**: All 50+ block compilers must update simultaneously
   - **Mitigation**: TypeScript will catch all missing updates
   - **Fallback**: Revert and batch-update compilers first

3. **Test Suite Breakage** (P1)
   - **Risk**: Tests may use params extensively
   - **Mitigation**: Fix test suite before merging
   - **Estimated Effort**: 2-4 hours

### Medium Risk Items

4. **Backward Compatibility** (P2)
   - **Risk**: Old saved patches may have params in JSON
   - **Mitigation**: Add migration logic in deserialization
   - **Fallback**: Document migration path

5. **UI Regression** (P2)
   - **Risk**: Users lose ability to edit block configuration
   - **Mitigation**: Ensure input editing UI is complete
   - **Verification**: Manual testing

### Low Risk Items

6. **Dead Code** (P3)
   - **Risk**: May miss some param references in unused code
   - **Mitigation**: Grep for patterns after cleanup
   - **Impact**: Won't break anything, just cruft

---

## Definition of Done

### Code Completeness

- [ ] `BlockParams` type removed from codebase
- [ ] `ParamSchema` interface removed from codebase
- [ ] `Block.params` property removed
- [ ] `BlockDefinition.defaultParams` property removed
- [ ] `BlockDefinition.paramSchema` property removed
- [ ] `BlockCompiler.compile()` no longer receives `params` argument
- [ ] `PatchStore.updateBlockParams()` removed
- [ ] `PatchStore.addBlock()` no longer accepts `params` argument
- [ ] Inspector parameter editing UI removed
- [ ] All utility functions updated or removed

### Verification

- [ ] `just typecheck` passes with zero errors
- [ ] `just lint` passes with zero warnings
- [ ] `just test` passes - all tests green
- [ ] Manual test: Add block from library
- [ ] Manual test: Edit input default values
- [ ] Manual test: Replace block preserves inputs
- [ ] Manual test: Load/save patch works
- [ ] No grep matches for `BlockParams` in src/
- [ ] No grep matches for `ParamSchema` in src/
- [ ] No grep matches for `block\.params` in src/ (except comments)

### Documentation

- [ ] Update CLAUDE.md if it references parameters
- [ ] Update any design docs that mention params
- [ ] Add migration note if needed for old patches

### Git Hygiene

- [ ] All changes in single atomic commit
- [ ] Commit message: "refactor: Remove deprecated BlockParams and ParamSchema types"
- [ ] No merge conflicts with main

---

## Estimated Effort

**By Step**:
- Step 1 (Audit): 30 min
- Step 2 (Type Removal): 15 min
- Step 3 (Factory): 15 min
- Step 4 (Compiler): 2-3 hours (50+ files)
- Step 5 (Store): 45 min
- Step 6 (UI): 45 min
- Step 7 (Utils): 30 min
- Step 8-9 (Cleanup): 30 min
- Step 10 (Testing): 2-4 hours

**Total**: 7-10 hours for experienced developer

**Complexity**: MEDIUM
- Mechanical changes (not architectural)
- Large surface area (many files)
- Requires careful verification

---

## Rollback Plan

If cleanup breaks something critical:

1. **Immediate**: `git revert <commit-hash>`
2. **Investigate**: Run audit scripts to find what was missed
3. **Fix**: Complete the missing migration phase
4. **Retry**: Re-attempt cleanup with full migration

**Key Point**: This is a DELETE-only refactor. Reverting is safe because we're not changing behavior, just removing unused code.

---

## Questions & Ambiguities

### Q1: What if some blocks legitimately need compile-time constants?

**Answer**: Use Config inputs (per 14-RemoveParams.md line 39)
- Config inputs are compile-time, not runtime
- They trigger hot-swap on change (not per-frame evaluation)
- Example: `renderMode: Config<'circles' | 'squares'>`

### Q2: What about backward compatibility for old saved patches?

**Options**:
- A) Add migration on load: detect `block.params`, convert to input defaults
- B) Ignore old format, require manual re-creation
- C) Version the patch format, support both

**Recommendation**: Option A if patches are user-facing, Option B if internal-only

### Q3: Should migrateBlockParams be kept for SVGPathSource?

**Answer**: Convert to input-level migration:
- If loading old patch with `target: 'logo'` param
- Convert to `target` input with default value `'builtin:logo'`
- Keep migration logic, change what it operates on

---

## Success Criteria Summary

**This cleanup is successful when**:

1. Zero TypeScript references to `BlockParams` or `ParamSchema`
2. All tests pass
3. UI works identically (inputs instead of params)
4. Compiler contract is simpler (one less argument)
5. Codebase is more honest (everything affecting output is in the graph)

**This cleanup has failed if**:

1. TypeScript errors remain
2. Tests fail
3. UI loses functionality
4. Blocks can't be configured
5. Compilation breaks

---

## Next Steps After Completion

Once params are removed:

1. **Document Input System** - Update CLAUDE.md with input/Default Source pattern
2. **Optimize Default Sources** - Ensure they're efficient (not creating hidden nodes)
3. **Enhance Input UI** - Make input editing as nice as param controls were
4. **Clean Up Design Docs** - Remove param references from all documentation
5. **Celebrate** - Parameters are gone! Everything is honest graph structure.

---

## File Manifest

**Planning Files**:
- This file: `.agent_planning/remove-params-phase5-cleanup/PLAN-2025-12-21-133029.md`

**Key Implementation Files** (in modification order):
1. `src/editor/blocks/types.ts` - Remove ParamSchema, defaultParams, paramSchema
2. `src/editor/types.ts` - Remove BlockParams, Block.params
3. `src/editor/blocks/factory.ts` - Remove param generation logic
4. `src/editor/compiler/types.ts` - Remove params from BlockCompiler
5. `src/editor/compiler/compile.ts` - Remove params passing
6. `src/editor/compiler/compileBusAware.ts` - Remove params passing
7. `src/editor/compiler/blocks/**/*.ts` - Update all compiler signatures
8. `src/editor/stores/PatchStore.ts` - Remove updateBlockParams, update addBlock
9. `src/editor/Inspector.tsx` - Remove param editing UI
10. `src/editor/BlockLibrary.tsx` - Update addBlock calls
11. `src/editor/replaceUtils.ts` - Remove copyCompatibleParams
12. Other utility files as discovered

**Verification Files**:
- All test files that reference params
- CLAUDE.md
- Design docs in design-docs/10-Refactor-for-UI-prep/

---

**END OF PLAN**
