# Sprint Plan: Default Source Reactivity Fix

**Created**: 2025-12-28
**Topic**: default-source-reactivity
**Status**: Ready for implementation

## Problem Statement

When the user changes default source values in the inspector, the animation does not update. The change is saved but the animation only updates when another trigger occurs (like changing a connection).

## Root Cause

The `setupAutoCompile` function in `src/editor/compiler/integration.ts:1092-1107` uses a MobX `reaction()` to track observables and trigger recompilation. It tracks:

- ✅ Blocks (count, types, params)
- ✅ Connections
- ✅ Buses, publishers, listeners
- ✅ Seed
- ❌ **Default source values** ← MISSING

When default source values change:
1. ✅ `DefaultSourceStore.setDefaultValue()` mutates `ds.value`
2. ❌ The mutation happens inside a Map entry object - not tracked by the reaction
3. ❌ No recompilation triggered
4. ❌ Animation uses stale compiled values

## Solution

Add default source tracking to the MobX reaction in `integration.ts`.

**Location**: `src/editor/compiler/integration.ts:1094-1107`

**Before** (lines 1094-1107):
```typescript
() => ({
  blockCount: store.patchStore.blocks.length,
  blocks: store.patchStore.blocks.map((b: Block) => ({ id: b.id, type: b.type, params: JSON.stringify(b.params) })),
  connectionCount: store.patchStore.connections.length,
  connections: store.patchStore.connections.map((c: Connection) => `${c.from.blockId}:${c.from.slotId}->${c.to.blockId}:${c.to.slotId}`),
  seed: store.uiStore.settings.seed,
  // Bus system - track publishers and listeners
  busCount: store.busStore.buses.length,
  buses: store.busStore.buses.map(b => `${b.id}:${b.name}`),
  publisherCount: store.busStore.publishers.length,
  publishers: store.busStore.publishers.map(p => `${p.id}:${p.from.blockId}.${p.from.slotId}->${p.busId}:${p.enabled}`),
  listenerCount: store.busStore.listeners.length,
  listeners: store.busStore.listeners.map(l => `${l.id}:${l.busId}->${l.to.blockId}.${l.to.slotId}:${l.enabled}`),
}),
```

**After**:
```typescript
() => ({
  blockCount: store.patchStore.blocks.length,
  blocks: store.patchStore.blocks.map((b: Block) => ({ id: b.id, type: b.type, params: JSON.stringify(b.params) })),
  connectionCount: store.patchStore.connections.length,
  connections: store.patchStore.connections.map((c: Connection) => `${c.from.blockId}:${c.from.slotId}->${c.to.blockId}:${c.to.slotId}`),
  seed: store.uiStore.settings.seed,
  // Default sources - track value changes
  defaultSourceValues: Array.from(store.defaultSourceStore.sources.values()).map(ds =>
    `${ds.id}:${JSON.stringify(ds.value)}`
  ),
  // Bus system - track publishers and listeners
  busCount: store.busStore.buses.length,
  buses: store.busStore.buses.map(b => `${b.id}:${b.name}`),
  publisherCount: store.busStore.publishers.length,
  publishers: store.busStore.publishers.map(p => `${p.id}:${p.from.blockId}.${p.from.slotId}->${p.busId}:${p.enabled}`),
  listenerCount: store.busStore.listeners.length,
  listeners: store.busStore.listeners.map(l => `${l.id}:${l.busId}->${l.to.blockId}.${l.to.slotId}:${l.enabled}`),
}),
```

## Implementation Steps

### Step 1: Add default source tracking to reaction
**File**: `src/editor/compiler/integration.ts`
**Lines**: 1099-1100 (insert after seed line)

Add:
```typescript
  // Default sources - track value changes
  defaultSourceValues: Array.from(store.defaultSourceStore.sources.values()).map(ds =>
    `${ds.id}:${JSON.stringify(ds.value)}`
  ),
```

### Step 2: Verify with Chrome DevTools MCP

1. Navigate to http://localhost:5174
2. Open inspector panel
3. Change a default source value (e.g., radius slider)
4. Verify animation updates immediately

## Complexity

**Complexity**: Low (2 lines of code)
**Risk**: Low (follows existing pattern)
**Test Impact**: None (behavioral fix, no API changes)

## Success Criteria

- [ ] Changing default source value in inspector triggers recompilation
- [ ] Animation updates within debounce window (~100ms)
- [ ] No performance regression (reaction efficiency maintained)
- [ ] TypeScript compiles without errors
