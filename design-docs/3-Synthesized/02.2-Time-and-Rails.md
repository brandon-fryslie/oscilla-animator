# Time Console & Modulation Rack — Authoritative UI and Runtime Specification

## 1. Overview

Time authoring is split into two orthogonal layers:

- **TimeRoot** (topology): Finite or Infinite
- **Modulation Rack** (Global Rails): derived modulation lanes (Phase A/B, Pulse A/B, Energy, Palette)

The Modulation Rack provides **normalled** (default) patch‑level modulation so a new patch moves immediately without wiring. These rails are conceptually distinct from user-created buses:

- **Rails** are a small, fixed set of named modulation channels curated by the app.
- **Buses** are arbitrary user routing fabric (many, configurable, combinable).

Cycles are not topology. They are derived operators that transform the root time signal.

## 2. TimeRoot

...

## 3. Time and Modulation Layers

...

### 3.4 Default Modulation Provisioning

When a new patch is created, the Modulation Rack is provisioned so the preview animates immediately:

- **Cycle A** is enabled with period = 2.0s, mode = loop, feeding **phaseA** and **pulseA** rails.
- **Cycle B** is disabled by default (but present) with period = 3.125s, mode = loop, feeding **phaseB** and **pulseB** rails when enabled.
- **Energy** and **Palette** lanes are enabled with default generators.

Rails always exist; lane enablement controls whether the rack actively drives them.

## 4. Modulation Rack (Global Rails)

The Modulation Rack is a **patch-level derived modulation system** that generates phase/pulse/energy/palette signals without cluttering the graph.

It is authored in the Time Console and compiled as hidden operators. These operators feed **Global Rails** by default (normalled), and may optionally publish into the user bus fabric when explicitly enabled.

### 4.1 Canonical Cycles

| Cycle   | Description              | Outputs                                      |
|---------|--------------------------|----------------------------------------------|
| Cycle A | Primary cycle lane       | `phaseA` (rail), `pulseA` (rail), `cycleIndexA` (internal) |
| Cycle B | Secondary cycle lane     | `phaseB` (rail), `pulseB` (rail), `cycleIndexB` (internal) |
| Energy  | Energy envelope lane     | `energy` (rail)                              |
| Palette | Palette modulation lane  | `palette` (rail)                             |

### 4.2 Cycle Lane Controls

...

### 4.3 Rail Drive Policy (Normalled vs Patched)

Each rail has an explicit drive policy, set in the Time Console:

- **Normalled**: the Modulation Rack drives the rail (default).
- **Patched**: the Modulation Rack is disconnected for that rail; only user publishers drive it.
- **Mixed**: both rack and user publishers drive the rail; the rail’s combine rule applies.

No hidden precedence is allowed. If a user publishes to a rail while it is Normalled, the UI MUST surface this and require an explicit policy choice.

---

## 5. User Buses and Routing Fabric

...

## 6. Compilation

The compiler MUST:

1. Compile TimeRoot → root time signal
2. Compile Modulation Rack → derived SignalExpr operators
3. Feed Global Rails before any user blocks execute
4. If enabled, publish selected rail signals into the user bus fabric

Rack publishers behave like normal publishers but are marked:

```
origin = 'timeOverlay'
```

## 7. Runtime Behavior

...

## 8. UI Integration

### 8.1 Cycle UI Placement

Rail rows (phaseA, phaseB, pulseA, pulseB, energy, palette) MUST include a shortcut to open the Time Console to the corresponding Modulation Rack lane. These rails MAY be rendered in the Bus Board as a pinned “Global Rails” group, but they are not treated as ordinary user buses.

...

---

## Global Rails, Drive Policy, and Optional Bus Publication

Oscilla distinguishes:

- **Reserved bus**: `time` (Signal<time>) — infrastructure, always present.
- **Global Rails**: a fixed set of named modulation channels authored in the Time Console.
- **User buses**: arbitrary routing fabric created by the user.

### Reserved Bus: `time`

- `time` is a system-reserved bus and is always present in any bus-enabled patch.
- `time` cannot be deleted or renamed.
- `time` is published **only** by the TimeRoot.

### Global Rails

The following rails always exist in a patch:

- `phaseA` (Signal<phase>)
- `phaseB` (Signal<phase>)
- `pulseA` (Event or Signal<Unit> with edge semantics)
- `pulseB` (Event or Signal<Unit> with edge semantics)
- `energy` (Signal<number>)
- `palette` (Signal<color> or palette-domain signal)

Rails:
- cannot be deleted
- have locked TypeDesc
- are driven by the Modulation Rack by default (normalled)

### Rail Drive Policy

Each rail has an explicit drive policy, set in the Time Console:

- **Normalled**: the Modulation Rack drives the rail (default).
- **Patched**: the Modulation Rack is disconnected for that rail; only user publishers drive it.
- **Mixed**: both rack and user publishers drive the rail; the rail’s combine rule applies.

No hidden precedence is allowed. Publishing into a Normalled rail MUST surface a policy decision in UI.

### Optional Bus Mirroring

A rail MAY be mirrored into the user bus fabric only when explicitly enabled. Mirrored rail buses:

- have locked names matching the rail (`phaseA`, `phaseB`, `pulseA`, `pulseB`, `energy`, `palette`)
- cannot be deleted or renamed
- exist solely as an interoperability bridge for the bus system

### Combine Rules

Combine rules apply only when a rail is in **Mixed** policy or when mirrored values are combined with user publishers. Defaults:

- `phaseA`, `phaseB`: last
- `pulseA`, `pulseB`: or
- `energy`: sum
- `palette`: mix

These defaults are editable only in the Time Console (not in generic bus UI).

### Compilation Order

1. TimeRoot emits `time`
2. Modulation Rack derives rails from unbounded time
3. Rails are driven according to policy (Normalled/Patched/Mixed)
4. If enabled, rail values are mirrored into the bus fabric
5. User publishers are applied
6. Bus combine is evaluated

---

### TimeRoot Ports and Bus Publishing

...

### Notes

- TimeRoot publishes only the reserved `time` bus.
- Phase/pulse/energy/palette are produced by the Modulation Rack (or explicit operators) and routed via rails and optional mirroring.

---

### Derived Cycle and Phase Operators

Multiple cycle operators can coexist, enabling nested or parallel loops.

Additional cycles beyond the curated rails (A/B) are created as explicit operators in the patch and routed via user buses or direct connections. The rail set stays small to keep the UI legible; expressiveness comes from composition, not from expanding the privileged global surface.

---

### PhaseFromTime (Secondary Clock / Derived Phase)

PhaseFromTime is a derived operator that converts unbounded time into normalized phase signals.

The Modulation Rack compiles to a small set of PhaseFromTime/Energy/Palette operators wired to the Global Rails.

...
