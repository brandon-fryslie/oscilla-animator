## Refactor Checklist

- **Address compiler/test mismatches**
  - Update every `addBlock` call (tests + UI) to the new signature defined in `src/editor/stores/PatchStore.ts:224-320`, ensuring the new `viewStore.moveBlockToLane` usage (see `src/editor/Inspector.tsx:200-216`) keeps lanes in sync.
  - Replace legacy lane references such as `patchStore.lanes`/`viewStore.lanes` in event suites (`src/editor/stores/__tests__/PatchStore.events.test.ts`, `RootStore.events.test.ts`, etc.) with lane-agnostic helpers, or explicitly inspect `viewStore.lanes` only while asserting placement.
  - Provide required metadata (`buses`, `publishers`, `listeners`, `defaultSources`) when manually constructing `PatchDocument`/`CompilerPatch` in the semantic fixtures (e.g., `src/editor/semantic/__tests__/validator.test.ts` and `graph.test.ts`) to satisfy the interface at `src/editor/semantic/types.ts:149-161`.
  - Fix event payloads emitted in `src/editor/stores/PatchStore.ts:171-214`/`RootStore.emitGraphCommitted` to supply `Record<string, unknown>` metadata and adjust diagnostics consumers like `src/editor/stores/DiagnosticStore.ts:150-170` and `src/editor/components/DiagnosticsConsole.tsx:65-88` to the new `PortTargetRef` format.

- **Align runtime APIs**
  - Update `src/editor/stores/BusStore.ts:214-470` to stop mutating `readonly` adapter/lens fields by replacing publishers/listeners entirely when updating adapter/lens state.
  - Modify diagnostics helpers (`src/editor/diagnostics/ActionExecutor.ts:80-140`, tests in `src/editor/diagnostics/__tests__/ActionExecutor.test.ts`) to rely on the new `PortTargetRef` shape defined in `src/editor/types.ts:248-262`.
  - Provide `{ viewport: { w, h, dpr } }` wherever a `RuntimeCtx` is required (e.g., `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts:60-260`) so the runtime signal tests no longer pass a `CompileCtx` lacking `viewport`.
  - Remove unused imports/types flagged by `verbatimModuleSyntax` (see kernel files `src/editor/kernel/*.ts` and `src/editor/blocks/types.ts:1-20` for `BlockCategory`).

- **Update tests**
  - Update each test suite still assuming lane IDs or legacy listener metadata (e.g., `BusStore.events`, `DiagnosticStore`, `CompositeStore`) to use the new block+bus APIs or to assert via lens helper `src/editor/lenses/lensInstances.ts:1-34`.
  - Replace outdated `CompileSucceeded` expectations (compiler event defined in `src/editor/events/types.ts`) with the new `CompileFinished` payload and verify diagnostics from the `diagnosticHub` injections as done in `src/editor/compiler/__tests__/bus-diagnostics.test.ts`.
  - Rework `GraphCommitted` tests to match the new event signature generated by `emitGraphCommitted` around `src/editor/stores/PatchStore.ts:137-180`.
  - Provide canonical bus data (see `src/editor/stores/BusStore.ts:50-110` for default buses) in semantic validator fixtures.

- **Build & verify**
  - After each major change, run `just test` so TypeScript errors like the current ones from `src/editor/compiler/blocks/domain/__tests__/TimeRoot.test.ts` are caught early.
  - Once the suite passes, run `just dev`, inspect the browser via Chrome DevTools MCP, confirm no console errors, double-click the first macro in the library, ensure the animation renders smoothly, and interact to validate any behavior changes introduced.
